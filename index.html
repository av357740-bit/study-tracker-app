<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Pravej Ahmad's Digital Study Tracker</title>

    <!-- PWA (Progressive Web App) Meta Tags - Essential for "Install App" feature -->
    <meta name="theme-color" content="#0ea5e9">
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple-specific meta tags for a better experience on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Study Tracker">
    
    <!-- Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for analytics and reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons for a clean, modern icon set -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF and html2canvas for PDF reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Google Fonts for a professional look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --background-light: #f0f9ff;
            --background-dark: #0c1425;
            --card-light: #ffffff;
            --card-dark: #1e293b;
            --text-light: #020617;
            --text-dark: #f1f5f9;
            --text-muted-light: #475569;
            --text-muted-dark: #94a3b8;
            --primary: #0ea5e9;
            --primary-hover: #0284c7;
            --accent: #8b5cf6;
            --danger: #ef4444;
            --warning: #f59e0b;
            --main-bg-start-light: #cffafe;
            --main-bg-end-light: #e0e7ff;
            --main-bg-start-dark: #164e63;
            --main-bg-end-dark: #312e81;
            --border-light: #e5e7eb;
            --border-dark: #374151;
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark body {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        
        html.dark.pitch-black {
            --background-dark: #000000;
            --card-dark: #111111;
            --text-dark: #e5e5e5;
            --text-muted-dark: #888888;
            --border-dark: #333333;
            --main-bg-start-dark: #000000;
            --main-bg-end-dark: #000000;
        }
        html.dark.pitch-black #sidebar { box-shadow: 4px 0 20px -3px rgba(255, 255, 255, 0.05); }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            display: none;
        }

        .app-header-title {
            font-family: 'Poppins', sans-serif;
            color: var(--text-light);
        }
        .dark .app-header-title {
            color: var(--text-dark);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-list-item {
            animation: slideInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dynamic-content-item {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .dynamic-content-item.active {
            display: block;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .task-list-item.completed {
            transition: opacity 0.5s ease, max-height 0.5s ease, margin 0.5s ease, padding 0.5s ease;
            opacity: 0;
            max-height: 0;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            overflow: hidden;
        }
        .task-list-item {
            transition: opacity 0.5s ease, max-height 0.5s ease, margin 0.5s ease, padding 0.5s ease;
            max-height: 100px;
        }

        .task-note-missed {
            background-color: #ffedd5 !important;
            border-left: 4px solid #f97316;
        }
        .dark .task-note-missed {
            background-color: #3f2715 !important;
            border-left-color: #fb923c;
        }
        .source-badge {
            font-size: 0.7rem; font-weight: 700; padding: 2px 6px;
            border-radius: 99px; margin-left: 8px; background-color: var(--primary);
            color: white; opacity: 0.8;
        }
        .source-badge-book { background-color: #8b5cf6; }
        .source-badge-notes { background-color: #0891b2; }
        
        #undo-toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 100;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0; pointer-events: none;
        }
        #undo-toast.show {
            opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto;
        }
        
        main {
            background: linear-gradient(135deg, var(--main-bg-start-light) 0%, var(--main-bg-end-light) 100%);
        }
        .dark main {
            background: linear-gradient(135deg, var(--main-bg-start-dark) 0%, var(--main-bg-end-dark) 100%);
        }
        
        body.particles-active main {
            background: transparent;
        }
        
        #sidebar { 
            border-right: 1px solid var(--border-light); 
            transition: all 0.3s ease-in-out; 
            box-shadow: 4px 0 15px -3px rgba(0, 0, 0, 0.07);
        }
        .dark #sidebar { 
            border-color: var(--border-dark); 
            box-shadow: 4px 0 20px -3px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-collapsed .nav-btn span, .sidebar-collapsed .app-header-title, .sidebar-collapsed #creator-credit span { display: none; }
        .sidebar-collapsed .nav-btn, .sidebar-collapsed #sidebar-toggle-btn { justify-content: center; }

        button, .nav-btn, .chapter-item, .task-action-btn, .dashboard-card, .dpt-list-item {
            transition: transform 0.1s ease-in-out, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        button:active, .nav-btn:active, .chapter-item:active, .task-action-btn:active, .dpt-list-item:active { transform: scale(0.97); }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .animated-progress-bar { transition: width 0.8s ease-out; }

        /* AI Insights Glow Effect */
        #ai-insights-container {
            position: relative;
            overflow: hidden;
        }
        #ai-insights-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(transparent, rgba(139, 92, 246, 0.2), transparent 15%);
            animation: rotate-glow 8s linear infinite;
            transform-origin: center center;
        }
        .dark #ai-insights-container::before {
            background: conic-gradient(transparent, rgba(167, 139, 250, 0.25), transparent 15%);
        }
        @keyframes rotate-glow {
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }


        .btn-neon {
            background-color: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), inset 0 0 5px var(--primary);
            animation: neon-pulse 2s infinite;
            transition: color 0.2s, background-color 0.2s, box-shadow 0.2s;
        }
        .btn-neon:hover {
            color: white;
            background-color: var(--primary);
            box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary), 0 0 30px var(--primary);
        }
        .dark .btn-neon {
             color: var(--accent); border-color: var(--accent);
             box-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent), inset 0 0 5px var(--accent);
        }
        .dark .btn-neon:hover {
            color: var(--card-dark); background-color: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent);
        }

        @keyframes neon-pulse { 50% { box-shadow: 0 0 8px var(--primary), 0 0 15px var(--primary), inset 0 0 8px var(--primary), 0 0 20px var(--accent); } }
        .dark @keyframes neon-pulse { 50% { box-shadow: 0 0 8px var(--accent), 0 0 15px var(--accent), inset 0 0 8px var(--accent), 0 0 20px var(--primary); } }

        #mobile-bottom-nav { display: none; }
        @media (max-width: 767px) {
            #sidebar, #mobile-menu-btn { display: none; }
            main { padding-bottom: 80px !important; }
            #mobile-bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-light); border-top: 1px solid var(--border-light); z-index: 50; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); }
            .dark #mobile-bottom-nav { background-color: var(--card-dark); border-top-color: var(--border-dark); box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2); }
            #mobile-nav-scroller { display: flex; overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; padding: 4px 8px; }
            .mobile-nav-btn { flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 60px; padding: 8px 12px; color: var(--text-muted-light); transition: color 0.2s ease-in-out; }
            .dark .mobile-nav-btn { color: var(--text-muted-dark); }
            .mobile-nav-btn.active, .dark .mobile-nav-btn.active { color: var(--primary); }
            .mobile-nav-btn i { width: 24px; height: 24px; }
        }
        
        .status-btn-group button.active { background-color: var(--primary); color: white; font-weight: 600; }
        .dark .status-btn-group button.active { background-color: var(--primary-hover); }
        .filter-btn.active { background-color: var(--primary); color: white; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        
        header, .border-b, .border-t, .border, .border-l-4, .border-2 { border-color: var(--border-light); }
        .dark header, .dark .border-b, .dark .border-t, .dark .border, .dark .border-l-4, .dark .border-2 { border-color: var(--border-dark); }
        input, select, textarea { border-color: var(--border-light); }
        .dark input, .dark select, .dark textarea { border-color: var(--border-dark); }
        .border-primary\/20 { border-color: rgba(14, 165, 233, 0.2); }
        .border-accent\/20 { border-color: rgba(139, 92, 246, 0.2); }
        
        /* Update popup styling */
        #update-popup-modal .update-modal-content {
            background: linear-gradient(145deg, #1e3a8a, #312e81);
            color: #e0e7ff;
            border: 1px solid #4f46e5;
            box-shadow: 0 0 15px #4f46e5, 0 0 30px #4f46e5, inset 0 0 10px #7c3aed;
            position: relative;
            overflow: hidden;
        }
        .dark #update-popup-modal .update-modal-content {
             background: linear-gradient(145deg, #0f172a, #111827);
             color: #dbeafe;
             border: 1px solid #5b21b6;
             box-shadow: 0 0 15px #5b21b6, 0 0 30px #5b21b6, inset 0 0 10px #7c3aed;
        }
        #update-popup-modal .update-modal-content::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(transparent, rgba(167, 139, 250, 0.3), transparent 30%);
            animation: rotate 6s linear infinite;
        }
        #update-popup-modal .update-note-item {
            opacity: 0;
            transform: translateY(15px);
            animation: fadeInItem 0.6s ease-out forwards;
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes fadeInItem { to { opacity: 1; transform: translateY(0); } }

        /* Print-specific styles */
        @media print {
            body.is-printing > *:not(.printable),
            body.is-printing #sidebar,
            body.is-printing #mobile-bottom-nav,
            body.is-printing header,
            body.is-printing button,
            body.is-printing .no-print {
                display: none !important;
            }
            body, html {
                background: #fff !important; color: #000 !important;
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
            body.is-printing main, body.is-printing .page.printable {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
                padding: 0 !important; margin: 0 !important;
                background: none !important;
                width: 100% !important;
            }
            .page { display: none !important; }
            .page.printable { display: block !important; animation: none !important; }
            .dashboard-card, .bg-card-light {
                box-shadow: none !important; border: 1px solid #ccc !important;
                page-break-inside: avoid;
            }
            .grid { display: block !important; }
            .grid > * { width: 100% !important; }
            canvas { max-width: 100% !important; height: auto !important; }
            .dark, .dark body {
                 --background-dark: #ffffff; --card-dark: #ffffff;
                 --text-dark: #000000; --text-muted-dark: #333333;
                 --border-dark: #cccccc;
            }
        }

    </style>
</head>

<body class="text-text-light dark:text-text-dark">
    
    <canvas id="particle-canvas"></canvas>

    <div class="flex h-screen bg-transparent">
        <aside id="sidebar" class="flex flex-col w-64 bg-card-light dark:bg-card-dark relative">
            <div class="flex items-center justify-between p-4 border-b h-16">
                <h1 class="text-xl font-extrabold app-header-title" data-translate="study_tracker">Study Tracker</h1>
            </div>
            <nav class="flex-grow p-4 space-y-2 no-scrollbar overflow-y-auto">
                <button data-page="home" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="home" class="w-5 h-5"></i> <span data-translate="home">Home</span></button>
                <button data-page="subjects" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="book-open" class="w-5 h-5"></i> <span data-translate="subjects">Subjects</span></button>
                <button data-page="dpt" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="clipboard-check" class="w-5 h-5"></i> <span data-translate="dpt">DPT</span></button>
                <button data-page="exams" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="briefcase" class="w-5 h-5"></i> <span data-translate="exams">Exams</span></button>
                <button data-page="url" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="globe" class="w-5 h-5"></i> <span>URL</span></button>
                <button data-page="import-export" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="arrow-right-left" class="w-5 h-5"></i> <span data-translate="import_export">Import/Export</span></button>
                <button data-page="calendar" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="calendar" class="w-5 h-5"></i> <span data-translate="calendar">Calendar</span></button>
                <button data-page="analytics" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="bar-chart-3" class="w-5 h-5"></i> <span data-translate="analytics">Analytics</span></button>
                <button data-page="report" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="clipboard-list" class="w-5 h-5"></i> <span data-translate="report">Report</span></button>
                <button data-page="settings" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="settings" class="w-5 h-5"></i> <span data-translate="settings">Settings</span></button>
            </nav>
            <div class="p-4 border-t space-y-2">
                <button id="theme-toggle-btn" class="w-full flex items-center justify-center gap-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="sun" id="theme-icon-sun"></i>
                    <i data-lucide="moon" id="theme-icon-moon"></i>
                </button>
                <button id="sidebar-toggle-btn" class="w-full hidden md:flex items-center justify-center gap-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="chevrons-left" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="creator-credit" class="p-4 text-center text-xs text-text-muted-light dark:text-text-muted-dark">
                <span>Created by Pravej Ahmad</span>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-screen max-h-screen">
            <header class="flex items-center justify-between p-4 border-b sticky top-0 bg-card-light/80 dark:bg-card-dark/80 backdrop-blur-sm z-10">
                <button id="mobile-menu-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 md:hidden">
                    <i data-lucide="menu"></i>
                </button>
                <div class="text-center flex-grow">
                    <h1 class="text-lg font-extrabold app-header-title">Study Tracker</h1>
                    <p class="text-xs text-text-muted-light dark:text-text-muted-dark -mt-1">By Pravej Ahmad</p>
                </div>
            </header>

            <main class="flex-grow overflow-y-auto p-4 md:p-6 pb-4 no-scrollbar">
                <div id="page-home" class="page active">
                    <div class="mb-6">
                        <h2 id="welcome-heading" class="text-3xl font-bold">Welcome, Pravej Ahmad!</h2>
                        <p class="text-text-muted-light dark:text-text-muted-dark" data-translate="welcome_subtitle">Here's your plan for today. Let's get it done!</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- AI Insights & Exam Countdown -->
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                                <div id="ai-insights-container" class="md:col-span-3 dashboard-card bg-violet-50 dark:bg-violet-900/30 border-2 p-4 rounded-xl shadow-sm min-h-[120px]"></div>
                                <div id="dashboard-exams-container" class="md:col-span-2 dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"></div>
                            </div>
                            
                            <!-- Today's Plan & DPT -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div id="todays-plan-container" class="dashboard-card bg-sky-50 dark:bg-sky-900/30 border-2 p-4 rounded-xl shadow-sm min-h-[180px]"></div>
                                <div id="todays-dpt-container" class="dashboard-card bg-gradient-to-br from-amber-100 to-orange-200 dark:from-amber-800 dark:to-orange-900 p-4 rounded-xl shadow-sm min-h-[100px]"></div>
                            </div>
                            
                            <!-- Other Sections -->
                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold mb-3" data-translate="tomorrows_topics">Tomorrow's Topics</h2>
                                <div id="tomorrows-plan-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div>
                            </div>
                             <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold mb-3" data-translate="yesterdays_completed">Yesterday's Completed Chapters</h2>
                                <div id="yesterdays-completed-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="lg:col-span-1 space-y-6">
                             <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold text-center" data-translate="overall_progress">Overall Progress</h2>
                                <div class="flex flex-col items-center gap-4 mt-2">
                                    <div class="relative w-40 h-40"><canvas id="overall-progress-chart"></canvas><div id="overall-progress-text" class="absolute inset-0 flex items-center justify-center text-4xl font-bold"></div></div>
                                    <div class="text-center">
                                        <p class="text-base text-text-muted-light dark:text-text-muted-dark"><span data-translate="chapters_completed">Chapters Completed</span>: <span id="chapters-completed-count" class="font-semibold">0 / 0</span></p>
                                    </div>
                                </div>
                             </div>

                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3 flex items-center gap-2"><i data-lucide="award" class="text-amber-500"></i><span data-translate="achievements">Achievements</span></h2><div id="badges-container" class="space-y-3"></div></div>
                            
                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3 flex items-center gap-2"><i data-lucide="repeat" class="text-teal-500"></i><span data-translate="upcoming_revisions">Upcoming Revisions</span></h2><div id="revisions-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark min-h-[60px]"></div></div>
                           
                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-red-600 dark:text-red-400"><i data-lucide="alert-triangle"></i><span data-translate="missed_chapters">Missed Chapters</span></h2><div id="missed-chapters-list" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark min-h-[60px]"></div></div>
                            
                            <div id="missed-other-tasks-card" class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm hidden"><h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-gray-600 dark:text-gray-400"><i data-lucide="clipboard-x"></i><span>Missed Other Tasks</span></h2><div id="missed-other-tasks-list" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark min-h-[60px]"></div></div>

                            <div class="dashboard-card bg-orange-50 dark:bg-orange-900/50 p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-orange-600 dark:text-orange-400"><i data-lucide="history"></i><span>Missed Revisions</span></h2><div id="missed-revisions-list" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark min-h-[60px]"></div></div>

                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <div class="flex justify-center items-center gap-2 mb-3 relative">
                                    <h2 id="subject-progress-title" class="text-lg font-bold text-center"></h2>
                                    <div class="relative">
                                        <button id="toggle-progress-view-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-down" class="w-5 h-5"></i></button>
                                        <div id="progress-view-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-card-light dark:bg-card-dark rounded-md shadow-lg z-20 border">
                                            <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" data-view="notes" data-translate="notes_progress">Notes Progress</a>
                                            <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" data-view="book" data-translate="book_progress">Book Progress</a>
                                        </div>
                                    </div>
                                </div>
                                <div id="subject-progress-dashboard-container" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-subjects" class="page">
                    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-4">
                         <div class="flex items-center gap-4 flex-wrap">
                            <h2 class="text-2xl font-bold flex-shrink-0" data-translate="subjects_chapters">Subjects & Chapters</h2>
                            <div id="subject-source-filter" class="flex items-center p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                <button data-source="notes" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">Notes</button>
                                <button data-source="book" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">Book</button>
                                <button data-source="all" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">All</button>
                            </div>
                            <div id="subject-view-filter" class="flex items-center p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                <button data-view="all" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">All Chapters</button>
                                <button data-view="completed" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">Completed</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="add-new-subject-btn" class="flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg btn-neon">
                                <i data-lucide="plus" class="w-4 h-4"></i> <span data-translate="add_new_subject">Add New Subject</span>
                            </button>
                            <input id="search-input" type="text" data-translate-placeholder="search_chapters" placeholder="Search chapters..." class="w-full md:w-auto px-3 py-1.5 text-sm bg-card-light dark:bg-card-dark border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                        </div>
                    </div>
                    <div id="subjects-list-container" class="space-y-3"></div>
                </div>
                
                <div id="page-dpt" class="page">
                     <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold" data-translate="dpt_page_title">Daily Practice Tests (DPT)</h2>
                        <div class="flex items-center gap-3">
                             <div id="dpt-view-filter" class="flex items-center p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                <button data-view="pending" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">Pending</button>
                                <button data-view="completed" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">Completed</button>
                            </div>
                            <select id="dpt-subject-filter" class="p-2 bg-card-light dark:bg-card-dark border rounded-lg"></select>
                        </div>
                    </div>
                    
                    <div id="dpt-summary-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    </div>
                    
                    <div id="dpt-global-actions-container" class="mb-4"></div>

                    <div id="dpt-list-container" class="space-y-4">
                    </div>
                </div>

                <div id="page-exams" class="page">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold" data-translate="exams_and_forms">Exams & Applied Forms</h2>
                        <div class="flex items-center gap-2 flex-wrap" id="exam-filter-buttons">
                            <button data-filter="all" class="exam-filter-btn active bg-primary text-white px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="all">All</button>
                            <button data-filter="upcoming" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="upcoming_exams">Upcoming Exams</button>
                            <button data-filter="applied" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="applied_forms">Applied Forms</button>
                            <button data-filter="history" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="history_exams">History</button>
                        </div>
                        <button id="add-exam-btn" class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg btn-neon">
                            <i data-lucide="plus" class="w-4 h-4"></i> <span data-translate="add_new_exam">Add New Exam</span>
                        </button>
                    </div>
                    <div id="exams-list-container" class="space-y-4">
                    </div>
                </div>

                <div id="page-url" class="page">
                    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-4">
                        <h2 class="text-2xl font-bold flex-shrink-0" data-translate="url_title">Saved URLs</h2>
                        <button id="add-new-root-folder-btn" class="flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg btn-neon">
                            <i data-lucide="folder-plus" class="w-4 h-4"></i> <span data-translate="add_new_folder">Add New Folder</span>
                        </button>
                    </div>
                    <div id="url-container" class="space-y-3"></div>
                </div>

                <div id="page-import-export" class="page">
                    <h2 class="text-2xl font-bold mb-4" data-translate="import_export_data">Import & Export Data</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-3 text-lg" data-translate="routine_management">Routine Management</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4" data-translate="routine_management_desc">Export your 14-day study cycle or import a new one from a JSON file.</p>
                            <div class="flex flex-col gap-2">
                                <button id="import-routine-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-violet-100 dark:bg-violet-900/50 text-violet-700 dark:text-violet-300 hover:bg-violet-200 dark:hover:bg-violet-900">
                                    <i data-lucide="upload" class="w-4 h-4"></i> <span data-translate="import_routine">Import Routine (JSON)</span>
                                </button>
                                <div class="flex gap-2">
                                    <button id="export-routine-json-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900">
                                        <i data-lucide="file-json" class="w-4 h-4"></i> <span data-translate="export_json">Export as JSON</span>
                                    </button>
                                    <button id="export-routine-pdf-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900">
                                        <i data-lucide="file-type" class="w-4 h-4"></i> <span data-translate="export_pdf">Export as PDF</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-3 text-lg" data-translate="exams_data_management">Exams Data Management</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4" data-translate="exams_data_management_desc">Import or export your list of exams. This is useful for backing up or transferring your exam schedule.</p>
                            <div class="flex gap-2">
                                <button id="import-exams-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-cyan-100 dark:bg-cyan-900/50 text-cyan-700 dark:text-cyan-300 hover:bg-cyan-200 dark:hover:bg-cyan-900">
                                    <i data-lucide="upload" class="w-4 h-4"></i> <span>Import Exams (JSON)</span>
                                </button>
                                <button id="export-exams-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-teal-100 dark:bg-teal-900/50 text-teal-700 dark:text-teal-300 hover:bg-teal-200 dark:hover:bg-teal-900">
                                    <i data-lucide="download" class="w-4 h-4"></i> <span>Export Exams (JSON)</span>
                                </button>
                            </div>
                        </div>

                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-3 text-lg">URL Data Management</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4">Import or export your saved URLs and folder structure. Keep your valuable links safe.</p>
                            <div class="flex gap-2">
                                <button id="import-urls-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-900">
                                    <i data-lucide="upload" class="w-4 h-4"></i> <span>Import URLs (JSON)</span>
                                </button>
                                <button id="export-urls-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-900">
                                    <i data-lucide="download" class="w-4 h-4"></i> <span>Export URLs (JSON)</span>
                                </button>
                            </div>
                        </div>

                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-3 text-lg" data-translate="full_app_backup">Full Application Backup</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4" data-translate="full_app_backup_desc">Export all your data into a single JSON file. Keep this file in a safe place as a backup.</p>
                             <div class="flex flex-col sm:flex-row gap-2">
                                <button id="import-full-backup-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-900">
                                    <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                                    <span>Import from Backup (JSON)</span>
                                </button>
                                <button id="export-full-data-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-900">
                                    <i data-lucide="download-cloud" class="w-4 h-4"></i>
                                    <span data-translate="export_data">Export All Data (Backup)</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="md:col-span-2 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-3 text-lg" data-translate="chapters_data_management">Chapters Data Management</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4" data-translate="import_export_chapters_desc">Import or export chapter lists for specific sources (Notes or Book) in JSON format. This is useful for quickly adding a large number of chapters.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="p-4 rounded-lg bg-cyan-50 dark:bg-cyan-900/30 border border-cyan-200 dark:border-cyan-800">
                                    <div class="flex items-center gap-3 mb-2">
                                        <i data-lucide="notebook-tabs" class="w-6 h-6 text-cyan-700 dark:text-cyan-300"></i>
                                        <h4 class="font-bold text-cyan-800 dark:text-cyan-200" data-translate="notes_chapters">Notes Chapters</h4>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="import-all-notes-btn" class="flex-1 flex items-center justify-center gap-2 p-2 text-sm font-semibold text-cyan-700 dark:text-cyan-300 bg-cyan-100 dark:bg-cyan-900/50 rounded-lg hover:bg-cyan-200 dark:hover:bg-cyan-900"><i data-lucide="upload" class="w-4 h-4"></i><span data-translate="import">Import</span></button>
                                        <button id="delete-all-notes-btn" class="flex-1 flex items-center justify-center gap-2 p-2 text-sm font-semibold text-red-600 dark:text-red-300 bg-red-100 dark:bg-red-900/50 rounded-lg hover:bg-red-200 dark:hover:bg-red-900"><i data-lucide="trash-2" class="w-4 h-4"></i><span data-translate="delete_all">Delete All</span></button>
                                    </div>
                                </div>
                                <div class="p-4 rounded-lg bg-violet-50 dark:bg-violet-900/30 border border-violet-200 dark:border-violet-800">
                                    <div class="flex items-center gap-3 mb-2">
                                        <i data-lucide="book" class="w-6 h-6 text-violet-700 dark:text-violet-300"></i>
                                        <h4 class="font-bold text-violet-800 dark:text-violet-200" data-translate="book_chapters">Book Chapters</h4>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="import-all-books-btn" class="flex-1 flex items-center justify-center gap-2 p-2 text-sm font-semibold text-violet-600 dark:text-violet-300 bg-violet-100 dark:bg-violet-900/50 rounded-lg hover:bg-violet-200 dark:hover:bg-violet-900"><i data-lucide="upload" class="w-4 h-4"></i><span data-translate="import">Import</span></button>
                                        <button id="delete-all-books-btn" class="flex-1 flex items-center justify-center gap-2 p-2 text-sm font-semibold text-red-600 dark:text-red-300 bg-red-100 dark:bg-red-900/50 rounded-lg hover:bg-red-200 dark:hover:bg-red-900"><i data-lucide="trash-2" class="w-4 h-4"></i><span data-translate="delete_all">Delete All</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-calendar" class="page">
                    <h2 class="text-2xl font-bold mb-4" data-translate="study_calendar">Study Calendar</h2>
                    <div id="calendar-view" class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm"></div>
                </div>
                
                <div id="page-analytics" class="page">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold" data-translate="analytics_reports">Analytics & Reports</h2>
                        <button id="print-analysis-btn" class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg btn-neon">
                            <i data-lucide="printer" class="w-4 h-4"></i> <span>Print Analysis</span>
                        </button>
                    </div>
                    <div id="analytics-content-container">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                            <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="total_chapters_done">Total Chapters Done</h3><p id="metric-total-completed" class="text-3xl font-bold text-primary">0</p></div>
                            <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="average_per_day">Average per Day</h3><p id="metric-avg-per-day" class="text-3xl font-bold text-accent">0.0</p></div>
                            <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="best_day">Best Day</h3><p id="metric-best-day" class="text-3xl font-bold text-warning">-</p></div>
                            <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="total_dpt_completed">Total DPTs Done</h3><p id="metric-total-dpt" class="text-3xl font-bold text-orange-500">0</p></div>
                            <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="overall_accuracy">Overall Accuracy</h3><p id="metric-dpt-accuracy" class="text-3xl font-bold text-teal-500">0%</p></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="chapter_status_distribution">Chapter Status Distribution</h3><div class="relative h-80"><canvas id="chapter-status-chart"></canvas></div></div>
                            <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="weekly_productivity">Weekly Productivity (Chapters Done)</h3><div class="relative h-80"><canvas id="weekly-productivity-chart"></canvas></div></div>
                            <div class="lg:col-span-2 bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="subject_wise_progress">Subject-wise Progress (%)</h3><div class="relative h-96"><canvas id="subject-progress-chart"></canvas></div></div>
                            <div class="lg:col-span-2 bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2">DPT Performance by Subject (Accuracy %)</h3><div class="relative h-80"><canvas id="dpt-performance-chart"></canvas></div></div>
                            <div class="lg:col-span-2 bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2">DPT Practice Count by Chapter</h3><div class="relative h-96"><canvas id="dpt-chapter-chart"></canvas></div></div>
                        </div>
                    </div>
                </div>

                <div id="page-report" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold" data-translate="study_report">Study Report</h2>
                        <button id="print-report-btn" class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg btn-neon">
                            <i data-lucide="printer" class="w-4 h-4"></i> <span>Print Report</span>
                        </button>
                    </div>
                    <div id="report-content-container">
                    </div>
                </div>

                <div id="page-settings" class="page">
                    <h2 class="text-2xl font-bold mb-4" data-translate="settings">Settings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <label for="student-name-input" class="font-semibold" data-translate="student_name">Student Name</label>
                            <input type="text" id="student-name-input" data-translate-placeholder="student_name_placeholder" placeholder="Enter your name..." class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border rounded-lg">
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <label for="language-select" class="font-semibold" data-translate="app_language">Application Language</label>
                            <select id="language-select" class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border rounded-lg">
                                <option value="en">English</option>
                                <option value="hi">हिंदी (Hindi)</option>
                            </select>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <label for="background-style-select" class="font-semibold">Background Style</label>
                            <select id="background-style-select" class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border rounded-lg">
                                <option value="default">Default Gradient</option>
                                <option value="particles">Particle Network</option>
                            </select>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                             <h3 class="font-semibold">Gradient Theme</h3>
                             <div class="grid grid-cols-2 gap-4 items-center mt-2">
                                 <div>
                                     <label for="bg-color-start" class="text-sm font-medium">Start</label>
                                     <input type="color" id="bg-color-start" class="mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                                 </div>
                                 <div>
                                     <label for="bg-color-end" class="text-sm font-medium">End</label>
                                     <input type="color" id="bg-color-end" class="mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                                 </div>
                             </div>
                             <button id="reset-theme-btn" class="mt-3 w-full text-sm p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Reset to Default</button>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2">
                            <h3 class="font-semibold mb-3">Advanced Color Customization</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                                <div>
                                    <label for="color-text-light" class="text-sm font-medium">Light Mode Text</label>
                                    <input type="color" id="color-text-light" data-color-type="textLight" class="adv-color-picker mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                                </div>
                                <div>
                                    <label for="color-border-light" class="text-sm font-medium">Light Mode Border</label>
                                    <input type="color" id="color-border-light" data-color-type="borderLight" class="adv-color-picker mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                                </div>
                                <div>
                                    <label for="color-text-dark" class="text-sm font-medium">Dark Mode Text</label>
                                    <input type="color" id="color-text-dark" data-color-type="textDark" class="adv-color-picker mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                                </div>
                                <div>
                                    <label for="color-border-dark" class="text-sm font-medium">Dark Mode Border</label>
                                    <input type="color" id="color-border-dark" data-color-type="borderDark" class="adv-color-picker mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                                </div>
                            </div>
                            <button id="reset-advanced-colors-btn" class="mt-3 w-full text-sm p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Reset Advanced Colors</button>
                        </div>

                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2">
                            <h3 class="font-semibold mb-3" data-translate="daily_plan_mode">Daily Study Plan Mode</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-3" data-translate="daily_plan_subtitle">Choose how you want to generate your daily study plan.</p>
                            <div class="flex flex-wrap gap-4 mb-4">
                                <label class="flex items-center gap-2"><input type="radio" name="plan-mode" value="auto" class="form-radio text-primary"> <span data-translate="auto_rotation">Automatic Rotation</span></label>
                                <label class="flex items-center gap-2"><input type="radio" name="plan-mode" value="custom_cycle" class="form-radio text-primary"> <span data-translate="custom_cycle">Custom Cycle</span></label>
                            </div>
                        </div>
                        
                        <div id="custom-cycle-plan-container" class="hidden md:col-span-2 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-4" data-translate="custom_study_plan">Custom Study Plan (2 Week Cycle)</h3>
                            <div id="custom-cycle-subject-selector" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                            <button id="save-custom-cycle-plan" class="mt-4 px-4 py-2 btn-neon font-semibold rounded-lg" data-translate="save_custom_plan">Save Custom Plan</button>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2">
                            <h3 class="font-semibold mb-3" data-translate="dpt_plan_mode">Daily DPT Plan Mode</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-3" data-translate="dpt_plan_subtitle">Choose how you want to generate your daily DPT schedule.</p>
                            <div class="flex flex-wrap gap-4 mb-4">
                                <label class="flex items-center gap-2"><input type="radio" name="dpt-plan-mode" value="auto" class="form-radio text-primary"> <span data-translate="dpt_auto_mode">Automatic (Follows Study Plan)</span></label>
                                <label class="flex items-center gap-2"><input type="radio" name="dpt-plan-mode" value="custom_cycle" class="form-radio text-primary"> <span data-translate="custom_cycle">Custom Cycle</span></label>
                            </div>
                        </div>
                        
                        <div id="custom-dpt-plan-container" class="hidden md:col-span-2 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-4" data-translate="custom_dpt_plan">Custom DPT Plan (2 Week Cycle)</h3>
                            <div id="dpt-custom-cycle-subject-selector" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                            <button id="save-dpt-custom-cycle-plan" class="mt-4 px-4 py-2 btn-neon font-semibold rounded-lg" data-translate="save_custom_plan">Save Custom DPT Plan</button>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2"><h3 class="font-semibold mb-3" data-translate="reset_app">Reset Application</h3><button id="reset-app-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900"><i data-lucide="trash-2" class="w-4 h-4"></i> <span data-translate="reset_all_data">Reset All Data</span></button></div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <nav id="mobile-bottom-nav">
        <div id="mobile-nav-scroller" class="no-scrollbar">
            <button data-page="home" class="mobile-nav-btn"><i data-lucide="home"></i></button>
            <button data-page="subjects" class="mobile-nav-btn"><i data-lucide="book-open"></i></button>
            <button data-page="dpt" class="mobile-nav-btn"><i data-lucide="clipboard-check"></i></button>
            <button data-page="exams" class="mobile-nav-btn"><i data-lucide="briefcase"></i></button>
            <button data-page="url" class="mobile-nav-btn"><i data-lucide="globe"></i></button>
            <button data-page="import-export" class="mobile-nav-btn"><i data-lucide="arrow-right-left"></i></button>
            <button data-page="calendar" class="mobile-nav-btn"><i data-lucide="calendar"></i></button>
            <button data-page="analytics" class="mobile-nav-btn"><i data-lucide="bar-chart-3"></i></button>
            <button data-page="report" class="mobile-nav-btn"><i data-lucide="clipboard-list"></i></button>
            <button data-page="settings" class="mobile-nav-btn"><i data-lucide="settings"></i></button>
            <button id="theme-toggle-btn-mobile" class="mobile-nav-btn">
                <i data-lucide="sun" id="theme-icon-sun-mobile"></i>
                <i data-lucide="moon" id="theme-icon-moon-mobile"></i>
            </button>
        </div>
    </nav>

    <input type="file" id="import-file-input" class="hidden" accept=".json">
    
    <div id="update-popup-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="w-full max-w-lg rounded-2xl shadow-xl p-6 relative max-h-[90vh] overflow-y-auto update-modal-content">
            <button id="close-update-popup-modal" class="absolute top-4 right-4 text-indigo-200 hover:text-white z-10"><i data-lucide="x"></i></button>
            <div id="update-popup-header" class="text-center border-b border-indigo-400/50 pb-3 mb-4 relative">
            </div>
            <div id="update-popup-content" class="space-y-3 text-sm relative">
            </div>
        </div>
    </div>

    <div id="add-subject-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <button id="close-add-subject-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 class="text-xl font-bold mb-4" data-translate="add_new_subject">Add New Subject</h2>
            <form id="add-subject-form" class="space-y-4">
                <div>
                    <label for="new-subject-name" class="block text-sm font-medium mb-1">Subject Name</label>
                    <input type="text" id="new-subject-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="e.g. Current Affairs">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Subject Source</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="subject-source" value="notes" class="form-radio text-primary" checked>
                            <span data-translate="source_notes">Notes</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="subject-source" value="book" class="form-radio text-primary">
                            <span data-translate="source_book">Book</span>
                        </label>
                    </div>
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Save Subject</button>
            </form>
        </div>
    </div>

    <div id="add-chapter-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden"><div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative"><button id="close-add-chapter-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button><h2 class="text-xl font-bold mb-4" data-translate="add_new_chapter">Add New Chapter</h2><form id="add-chapter-form" class="space-y-4"><input type="hidden" id="add-chapter-subject-id"><input type="hidden" id="add-chapter-source-type"><div><label for="new-chapter-name" class="block text-sm font-medium mb-1" data-translate="chapter_name">Chapter Name</label><input type="text" id="new-chapter-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required></div><button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="add_chapter">Add Chapter</button></form></div></div>
    
    <div id="confirmation-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden"><div class="bg-card-light dark:bg-card-dark w-full max-w-sm rounded-2xl shadow-xl p-6 text-center"><h2 id="confirmation-title" class="text-xl font-bold mb-2" data-translate="are_you_sure">Are you sure?</h2><p id="confirmation-message" class="text-text-muted-light dark:text-text-muted-dark mb-6" data-translate="action_cannot_be_undone">This action cannot be undone.</p><div class="flex justify-center gap-4"><button id="confirm-cancel" class="flex-1 p-3 font-semibold rounded-lg bg-gray-200 dark:bg-gray-700" data-translate="cancel">Cancel</button><button id="confirm-action" class="flex-1 p-3 font-semibold rounded-lg text-white bg-danger" data-translate="confirm">Confirm</button></div></div></div>
    
    <div id="chapter-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button id="close-chapter-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="chapter-modal-title" class="text-xl font-bold mb-4" data-translate="chapter_details">Chapter Details</h2>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium mb-2" data-translate="status">Status</label>
                    <div id="chapter-status-buttons" class="status-btn-group grid grid-cols-2 gap-2 p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <button data-status="Not Started" class="p-2 text-sm rounded-md transition-colors duration-200"><span data-translate="not_started">Not Started</span></button>
                        <button data-status="Completed" class="p-2 text-sm rounded-md transition-colors duration-200"><span data-translate="completed">Completed</span></button>
                    </div>
                </div>
                <div>
                    <label for="chapter-notes-textarea" class="block text-sm font-medium mb-1" data-translate="study_notes">Study Notes</label>
                    <textarea id="chapter-notes-textarea" rows="4" data-translate-placeholder="study_notes_placeholder" placeholder="e.g., This chapter is important for exams..." class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg text-sm"></textarea>
                </div>
                <div>
                    <label class="flex items-center gap-3 p-3 bg-yellow-50 dark:bg-yellow-900/40 rounded-lg cursor-pointer">
                        <input type="checkbox" id="chapter-priority-revision-checkbox" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                        <span class="font-semibold text-yellow-800 dark:text-yellow-200" data-translate="priority_revision">Mark for Priority Revision</span>
                    </label>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="font-semibold mb-2">Scheduled Revisions</h3>
                    <div id="scheduled-revisions-list" class="space-y-2 mb-3">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="date" id="manual-revision-date" class="flex-grow p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg text-sm">
                        <button id="add-manual-revision-btn" class="p-2 font-semibold rounded-lg bg-accent text-white hover:bg-violet-600">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                </div>

                <div class="flex gap-3 mt-4">
                    <button id="delete-chapter-details-btn" class="w-auto p-3 text-sm font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <button id="save-chapter-details-btn" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save_changes">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="badge-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden"><div class="bg-card-light dark:bg-card-dark w-full max-w-sm rounded-2xl shadow-xl p-8 text-center relative overflow-hidden"><button id="close-badge-modal-x" class="absolute top-4 right-4 text-text-muted-light dark:hover:text-text-light dark:text-text-dark z-10"><i data-lucide="x" class="w-6 h-6"></i></button><div class="absolute top-0 left-0 w-full h-full opacity-10 dark:opacity-20" style="background-image: radial-gradient(circle, var(--primary) 0%, transparent 70%);"></div><i id="badge-icon" data-lucide="award" class="w-16 h-16 text-amber-400 mx-auto mb-4 drop-shadow-lg animate-pulse"></i><h2 class="text-2xl font-bold mb-2" data-translate="achievement_unlocked">Achievement Unlocked!</h2><p id="badge-name" class="text-lg font-semibold text-primary dark:text-blue-300 mb-4"></p><p id="badge-description" class="text-text-muted-light dark:text-text-muted-dark mb-6"></p><button id="close-badge-modal" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="awesome">Awesome!</button></div></div>
    
    <div id="undo-toast" class="p-3 rounded-lg shadow-lg bg-gray-800 text-white dark:bg-gray-200 dark:text-black flex items-center gap-4">
        <span id="undo-message"></span>
        <button id="undo-btn" class="font-bold" data-translate="undo">Undo</button>
    </div>

    <div id="add-exam-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative overflow-y-auto max-h-[90vh]">
            <button id="close-add-exam-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="exam-modal-title" class="text-xl font-bold mb-4" data-translate="add_new_exam">Add New Exam</h2>
            <form id="add-exam-form" class="space-y-4">
                <input type="hidden" id="exam-id">
                <div>
                    <label for="exam-name" class="block text-sm font-medium mb-1" data-translate="exam_name">Exam Name</label>
                    <input type="text" id="exam-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="application-date" class="block text-sm font-medium mb-1" data-translate="application_date">Application Date</label>
                        <input type="date" id="application-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                    </div>
                    <div>
                        <label for="exam-date" class="block text-sm font-medium mb-1" data-translate="exam_date">Exam Date</label>
                        <input type="date" id="exam-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                    </div>
                </div>
                 <div>
                    <label for="exam-status" class="block text-sm font-medium mb-1" data-translate="status">Status</label>
                    <select id="exam-status" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                        <option value="Applied" data-translate="status_applied">Applied</option>
                        <option value="Admit Card Out" data-translate="status_admit_card">Admit Card Out</option>
                        <option value="Exam Done" data-translate="status_exam_done">Exam Done</option>
                        <option value="Result Out" data-translate="status_result_out">Result Out</option>
                    </select>
                </div>
                 <div>
                    <label for="exam-notes" class="block text-sm font-medium mb-1" data-translate="notes">Notes</label>
                    <textarea id="exam-notes" rows="3" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" data-translate-placeholder="notes_placeholder" placeholder="e.g., Registration no., website link..."></textarea>
                </div>
                <div>
                    <label for="exam-receipt" class="block text-sm font-medium mb-1" data-translate="application_receipt">Application Receipt</label>
                    <input type="file" id="exam-receipt" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer" accept="image/*,.pdf">
                    <div id="exam-receipt-viewer" class="mt-2 text-sm"></div>
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save_exam">Save Exam</button>
            </form>
        </div>
    </div>

    <div id="date-completion-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
            <button id="close-date-completion-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="date-completion-modal-title" class="text-xl font-bold mb-4">Mark Chapter as Completed</h2>
            <div class="space-y-4">
                <div>
                    <label for="date-completion-subject-select" class="block text-sm font-medium mb-1">Select Subject</label>
                    <select id="date-completion-subject-select" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                        <option value="">-- Choose a Subject --</option>
                    </select>
                </div>
                <div id="date-completion-chapter-list" class="max-h-60 overflow-y-auto space-y-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                    <p class="text-center text-sm text-text-muted-light dark:text-text-muted-dark">Please select a subject first.</p>
                </div>
                 <button id="save-date-completion-btn" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Mark as Completed</button>
            </div>
        </div>
    </div>
    
    <div id="dpt-details-popup-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
            <button id="close-dpt-details-popup-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h3 id="dpt-modal-title" class="font-bold text-lg mb-4" data-translate="enter_dpt_details">Enter DPT Details</h3>
            <div id="dpt-entry-view">
                <form id="dpt-details-form" class="space-y-3">
                    <input type="hidden" id="dpt-details-subject-id">
                    <input type="hidden" id="dpt-details-chapter-id">
                    <input type="hidden" id="dpt-details-test-id">
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm">
                        <div><label for="dpt-total-q" class="font-medium" data-translate="dpt_total_q">Total Qs</label><input type="number" id="dpt-total-q" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                        <div><label for="dpt-total-time" class="font-medium" data-translate="dpt_total_time">Total Time</label><input type="number" id="dpt-total-time" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                        <div><label for="dpt-attempted" class="font-medium" data-translate="dpt_attempted">Attempted</label><input type="number" id="dpt-attempted" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                        <div><label for="dpt-correct" class="font-medium" data-translate="dpt_correct">Correct</label><input type="number" id="dpt-correct" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                        <div><label for="dpt-wrong" class="font-medium" data-translate="dpt_wrong">Wrong</label><input type="number" id="dpt-wrong" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                        <div><label for="dpt-time-taken" class="font-medium" data-translate="dpt_time_taken">Time Taken</label><input type="number" id="dpt-time-taken" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" id="delete-dpt-btn" class="p-3 font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300"><i data-lucide="trash-2"></i></button>
                        <button type="submit" class="flex-1 p-3 font-semibold rounded-lg bg-primary text-white" data-translate="submit">Submit</button>
                    </div>
                </form>
            </div>
            <div id="dpt-display-view" class="hidden">
                 <div class="space-y-2 text-sm">
                    <div class="flex justify-between p-2 bg-gray-100 dark:bg-gray-800 rounded-md"><span>Completed On:</span><strong id="dpt-display-date"></strong></div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-md"><span>Total Questions:</span><strong class="block text-lg" id="dpt-display-total-q"></strong></div>
                        <div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-md"><span>Attempted:</span><strong class="block text-lg" id="dpt-display-attempted"></strong></div>
                        <div class="p-2 bg-green-100 dark:bg-green-900/50 rounded-md"><span>Correct:</span><strong class="block text-lg text-green-600" id="dpt-display-correct"></strong></div>
                        <div class="p-2 bg-red-100 dark:bg-red-900/50 rounded-md"><span>Wrong:</span><strong class="block text-lg text-red-600" id="dpt-display-wrong"></strong></div>
                        <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-md"><span>Accuracy:</span><strong class="block text-lg text-blue-600" id="dpt-display-accuracy"></strong></div>
                        <div class="p-2 bg-yellow-100 dark:bg-yellow-900/50 rounded-md"><span>Time Taken:</span><strong class="block text-lg text-yellow-600" id="dpt-display-time-taken"></strong></div>
                    </div>
                 </div>
                 <div class="flex gap-3 pt-4">
                    <button type="button" id="delete-dpt-display-btn" class="p-3 font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300"><i data-lucide="trash-2"></i></button>
                    <button type="button" id="close-dpt-display-btn" class="flex-1 p-3 font-semibold rounded-lg bg-gray-200 dark:bg-gray-700">Close</button>
                 </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL FOR CHOOSING TASK TYPE -->
    <div id="add-task-choice-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-sm rounded-2xl shadow-xl p-6 relative">
            <button id="close-add-task-choice-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 class="text-xl font-bold mb-6 text-center">Add a New Task</h2>
            <div class="space-y-3">
                <button id="choice-manual-chapter-btn" class="w-full flex items-center justify-center gap-3 p-4 font-semibold rounded-lg bg-sky-100 hover:bg-sky-200 dark:bg-sky-900/50 dark:hover:bg-sky-900 text-sky-800 dark:text-sky-200">
                    <i data-lucide="book-open"></i>
                    <span>Add Chapter Task</span>
                </button>
                <button id="choice-other-task-btn" class="w-full flex items-center justify-center gap-3 p-4 font-semibold rounded-lg bg-violet-100 hover:bg-violet-200 dark:bg-violet-900/50 dark:hover:bg-violet-900 text-violet-800 dark:text-violet-200">
                    <i data-lucide="clipboard-list"></i>
                    <span>Add Other Task</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL FOR ADDING 'OTHER' TASK -->
    <div id="add-other-task-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <button id="close-add-other-task-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 class="text-xl font-bold mb-4">Add Other Task</h2>
            <form id="add-other-task-form" class="space-y-4">
                <div>
                    <label for="other-task-description" class="block text-sm font-medium mb-1">Task Description</label>
                    <input type="text" id="other-task-description" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="e.g., Buy new notebook">
                </div>
                <div>
                    <label for="other-task-date" class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="other-task-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required>
                </div>
                <div>
                    <label for="other-task-notes" class="block text-sm font-medium mb-1">Notes (Optional)</label>
                    <textarea id="other-task-notes" rows="3" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" placeholder="Add any extra details..."></textarea>
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Save Task</button>
            </form>
        </div>
    </div>
    
    <div id="manual-add-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
            <button id="close-manual-add-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="manual-add-modal-title" class="text-xl font-bold mb-4">Add Task</h2>
            <div class="space-y-4">
                <div>
                    <label for="manual-add-subject-select" class="block text-sm font-medium mb-1">Select Subject</label>
                    <select id="manual-add-subject-select" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                        <option value="">-- Choose a Subject --</option>
                    </select>
                </div>
                
                <div id="manual-add-chapter-content">
                    <div>
                        <label for="manual-add-date" class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" id="manual-add-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                    </div>
                    <div>
                        <label for="manual-add-chapter-name" class="block text-sm font-medium mb-1">New Chapter Name</label>
                        <input type="text" id="manual-add-chapter-name" placeholder="Enter chapter name to add..." class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                    </div>
                    <div>
                         <label class="block text-sm font-medium mb-2">Source</label>
                         <div class="flex gap-4">
                            <label class="flex items-center gap-2"><input type="radio" name="manual-add-source" value="notes" class="form-radio text-primary" checked> <span>Notes</span></label>
                            <label class="flex items-center gap-2"><input type="radio" name="manual-add-source" value="book" class="form-radio text-primary"> <span>Book</span></label>
                        </div>
                    </div>
                </div>

                <div id="manual-add-dpt-content" class="hidden">
                     <div id="manual-add-item-list" class="max-h-60 overflow-y-auto space-y-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                        <p class="text-center text-sm text-text-muted-light dark:text-text-muted-dark">Please select a subject first.</p>
                    </div>
                </div>
                <button id="save-manual-add-btn" class="w-full p-3 mt-2 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Add Task</button>
            </div>
        </div>
    </div>
    
    <div id="add-folder-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <button id="close-add-folder-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <div class="flex items-center gap-3 mb-4">
                <i data-lucide="folder-plus" class="w-6 h-6 text-primary"></i>
                <h2 id="folder-modal-title" class="text-xl font-bold" data-translate="add_new_folder">Add New Folder</h2>
            </div>
            <form id="add-folder-form" class="space-y-4">
                <input type="hidden" id="edit-folder-id">
                <input type="hidden" id="parent-folder-id">
                <div>
                    <label for="new-folder-name" class="block text-sm font-medium mb-1" data-translate="folder_name">Folder Name</label>
                    <input type="text" id="new-folder-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="e.g. History Videos">
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save">Save</button>
            </form>
        </div>
    </div>

    <div id="add-link-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <button id="close-add-link-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <div class="flex items-center gap-3 mb-4">
                <i data-lucide="link" class="w-6 h-6 text-primary"></i>
                <h2 id="link-modal-title" class="text-xl font-bold" data-translate="add_new_link">Add New Link</h2>
            </div>
            <form id="add-link-form" class="space-y-4">
                <input type="hidden" id="link-folder-id">
                <input type="hidden" id="edit-link-id">
                <div>
                    <label for="new-link-name" class="block text-sm font-medium mb-1" data-translate="link_name">Link Name</label>
                    <input type="text" id="new-link-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="e.g. Ancient Rome Documentary">
                </div>
                <div>
                    <label for="new-link-url" class="block text-sm font-medium mb-1" data-translate="link_url">URL</label>
                    <input type="url" id="new-link-url" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="https://example.com">
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save">Save</button>
            </form>
        </div>
    </div>

    <!-- NEW MODAL FOR ADDING DPT TO A CHAPTER -->
    <div id="add-chapter-dpt-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <button id="close-add-chapter-dpt-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 class="text-xl font-bold mb-4">Add DPTs to Chapter</h2>
            <form id="add-chapter-dpt-form" class="space-y-4">
                <input type="hidden" id="dpt-add-subject-id">
                <div>
                    <label for="dpt-add-chapter-select" class="block text-sm font-medium mb-1">Chapter</label>
                    <select id="dpt-add-chapter-select" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required></select>
                </div>
                <div>
                    <label for="dpt-add-quantity" class="block text-sm font-medium mb-1">Number of Tests to Add</label>
                    <input type="number" id="dpt-add-quantity" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required min="1" value="1">
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Add DPTs</button>
            </form>
        </div>
    </div>
    
    <!-- NEW MODAL FOR ADDING DPT TO ALL CHAPTERS -->
    <div id="add-all-chapters-dpt-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <button id="close-add-all-chapters-dpt-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="add-all-dpt-modal-title" class="text-xl font-bold mb-4">Add DPTs to All Chapters</h2>
            <form id="add-all-chapters-dpt-form" class="space-y-4">
                <input type="hidden" id="dpt-add-all-subject-id">
                <div>
                    <label for="dpt-add-all-quantity" class="block text-sm font-medium mb-1">Number of Tests per Chapter</label>
                    <input type="number" id="dpt-add-all-quantity" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required min="1" value="1">
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Add DPTs to All</button>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        
        const CURRENT_APP_VERSION = "4.3"; // Version updated for DPT sync and stability
        const DPT_EXCLUDED_SUBJECTS = ['static-gk', 'maths-formulas', 'fill-form', 'संविधान-articles'];
        const updateNotes = {
            "4.3": [
                { "title": "स्मार्ट DPT सिंक्रोनाइज़ेशन ✨", "note": "अब 'Today’s DPT' सीधे 'Today’s Task' से जुड़ा है। जिस चैप्टर को आप पढ़ रहे हैं, उसी का DPT प्रैक्टिस के लिए अपने आप आ जाएगा, चाहे वह नया चैप्टर हो या रिवीजन।" },
                { "title": "बेहतर टास्क लॉजिक 🧠", "note": "जब आप किसी चैप्टर को पूरा करते हैं, तो उसका DPT डैशबोर्ड पर बना रहेगा ताकि आप पढ़ाई के तुरंत बाद प्रैक्टिस कर सकें। अब कोई भी DPT मिस नहीं होगा!" },
                { "title": "5 गुना ज़्यादा मज़बूत और स्थिर 🛡️", "note": "ऐप के कोर सिस्टम में बड़े सुधार किए गए हैं। यह अब पहले से कहीं ज़्यादा तेज़, स्मूथ और भरोसेमंद है, जिससे आपका डेटा हमेशा सुरक्षित रहता है और ऐप क्रैश नहीं होता।" },
                { "title": "त्रुटि-मुक्त अनुभव 🐛", "note": "छोटे-मोटे बग्स को ठीक कर दिया गया है और परफॉरमेंस को ऑप्टिमाइज़ किया गया है ताकि आपको एक सहज और बेहतरीन स्टडी अनुभव मिले।" }
            ],
            "4.2": [
                { "title": "बेहतर DPT डैशबोर्ड ✨", "note": "DPT अब डैशबोर्ड पर सही ढंग से दिखाई दे रहे हैं। अब आपकी दैनिक योजना के अनुसार निर्धारित विषयों के लिए लंबित DPT स्वचालित रूप से आपके डैशबोर्ड पर आ जाएंगे।" },
                { "title": "DPT पेज पर 'सभी विषय' व्यू 📊", "note": "DPT पेज पर 'All Subjects' चुनने पर अब सभी विषयों के DPT एक ही स्थान पर दिखाई देंगे। इससे पूरी प्रगति को ट्रैक करना आसान हो गया है।" },
                { "title": "एक साथ सभी DPT हटाएं 🚀", "note": "DPT पेज पर 'All Subjects' व्यू में अब एक 'Delete All DPTs' बटन जोड़ा गया है, जिससे आप एक ही बार में सभी DPTs को हटा सकते हैं। साथ ही, हर विषय के लिए भी सभी DPT को एक साथ हटाने का विकल्प दिया गया है।" },
                { "title": "पूर्ण हुए कार्यों की रिपोर्ट 📝", "note": "रिपोर्ट पेज पर अब एक नया सेक्शन जोड़ा गया है जो पिछले 30 दिनों में पूरे किए गए 'Other Tasks' को दिखाता है। अब आप अपने सभी छोटे-बड़े कार्यों को ट्रैक कर सकते हैं।" },
                { "title": "5 गुना ज़्यादा स्थिर और तेज़ 🛡️", "note": "एप्लिकेशन के कोर में महत्वपूर्ण सुधार किए गए हैं ताकि यह सुनिश्चित हो सके कि नए बदलावों से कोई पुराना फीचर प्रभावित न हो। ऐप अब पहले से कहीं ज़्यादा स्थिर, तेज़ और विश्वसनीय है।" }
            ],
            "4.1": [
                { "title": "अध्याय-आधारित DPT सिस्टम ✨", "note": "DPT सिस्टम को पूरी तरह से नया रूप दिया गया है! अब आप हर विषय के विशिष्ट अध्यायों के लिए DPT जोड़ सकते हैं, जैसे 'Physics DPT - तरंग (Waves) - 1'। इससे आप हर अध्याय की प्रैक्टिस को ट्रैक कर सकते हैं।" },
                { "title": "बेहतर DPT ट्रैकिंग और विश्लेषण 📊", "note": "अब आप देख सकते हैं कि आपने किस अध्याय का कितनी बार DPT दिया है। एनालिटिक्स पेज पर एक नया चार्ट जोड़ा गया है जो दिखाता है कि हर अध्याय का कितनी बार प्रैक्टिस किया गया है, जिससे आपको अपनी कमजोरियों और ताकतों का पता चलता है।" },
                { "title": "एक साथ कई DPT जोड़ें 🚀", "note": "अब आप एक ही बार में किसी भी अध्याय के लिए कई DPT जोड़ सकते हैं। DPT पेज पर जाएं, विषय चुनें, और किसी भी अध्याय के आगे 'Add DPTs' बटन पर क्लिक करें। विषय के नाम के आगे 'Add to All Chapters' बटन से आप सभी चैप्टर्स में एक साथ DPT जोड़ सकते हैं।" },
                { "title": "एंड्रॉयड पर बेहतर प्रिंटिंग 📱", "note": "रिपोर्ट और एनालिसिस पेज को एंड्रॉयड डिवाइस पर प्रिंट करने में आ रही समस्या को ठीक कर दिया गया है। अब आप मोबाइल पर भी आसानी से अपनी प्रगति का प्रिंट ले सकते हैं।" },
                { "title": "पहले से 5 गुना ज़्यादा स्थिर 🛡️", "note": "एप्लिकेशन के कोर में महत्वपूर्ण सुधार किए गए हैं ताकि यह सुनिश्चित हो सके कि नए बदलावों से कोई पुराना फीचर प्रभावित न हो। ऐप अब पहले से कहीं ज़्यादा स्थिर, तेज़ और विश्वसनीय है।" }
            ],
            "4.0": [
                { "title": "अत्यंत उन्नत AI स्टडी कोच ✨", "note": "AI कोच अब वास्तविक समय में आपकी प्रगति का विश्लेषण करता है और कभी भी पीछे नहीं रहता। यह आपको आज के कार्यों, DPTs, आगामी परीक्षाओं, छूटे हुए अध्यायों, उपलब्धियों और यहां तक कि आपके सबसे अच्छे प्रदर्शन वाले दिन के बारे में भी जानकारी देता है।" },
                { "title": "प्रेरणादायक संदेश और 12+ नई जानकारियां 🚀", "note": "AI कोच अब आपको प्रेरित रखने के लिए 50+ छोटे, प्रेरक संदेश दिखाएगा और 12 से ज़्यादा तरह की नई जानकारियां देगा। हर बार जब आप होम पेज पर आएंगे तो आपको एक नया संदेश मिलेगा!" },
                { "title": "विशेष 'अन्य कार्य' जोड़ने की सुविधा 📝", "note": "अब आप डैशबोर्ड से ऐसे कार्य भी जोड़ सकते हैं जिनका विषयों से कोई संबंध नहीं है, जैसे 'फॉर्म भरना'। इन कार्यों का रंग अलग है और इन्हें पूरा करने, टालने और हटाने की सुविधा भी है।" },
                { "title": "बेहतर डैशबोर्ड और UI 🎨", "note": "'Today's Plan' में अब ब्रैकेट में वर्तमान दिन (जैसे सोमवार) दिखाई देता है। AI कोच पर एक सूक्ष्म, सुंदर लाइटिंग एनीमेशन जोड़ा गया है जो आपके अनुभव को बेहतर बनाता है।" },
                { "title": "स्थिरता और मजबूती 🛡️", "note": "एप्लिकेशन के कोड को और अधिक मजबूत बनाया गया है ताकि यह सुनिश्चित हो सके कि नए फीचर्स जोड़ने से कोई पुराना फीचर प्रभावित न हो। ऐप अब पहले से 5 गुना ज्यादा स्थिर और स्मूथ है, जिससे डेटा हानि का कोई खतरा नहीं है।" }
            ],
            "3.5": [
                { "title": "बेहतर डैशबोर्ड UI ✨", "note": "डैशबोर्ड पर 'विषय प्रगति' अब सही ढंग से एक हरी प्रगति पट्टी (green progress bar) के रूप में दिखाई देती है, जिससे आपको अपनी प्रगति का स्पष्ट विज़ुअल फीडबैक मिलता है।" },
                { "title": "नया और बेहतर लिंक सेक्शन", "note": "'लिंक्स' सेक्शन में फ़ोल्डर जोड़ने वाली सुविधा जो काम नहीं कर रही थी, उसे पूरी तरह से एक नए और विश्वसनीय पॉप-अप से बदल दिया गया है। अब आप आसानी से फ़ोल्डर और लिंक जोड़ सकते हैं।" },
                { "title": "एप्लिकेशन की स्थिरता", "note": "एप्लिकेशन को और अधिक स्थिर और मजबूत बनाने के लिए कोड में सुधार किए गए हैं। इससे बग्स की संभावना कम हो गई है और सभी सुविधाएँ पहले से बेहतर काम करेंगी।" },
                { "title": "डेटा सुरक्षा", "note": "आपके डेटा को आकस्मिक रीसेट या हानि से बचाने के लिए अतिरिक्त सुरक्षा उपाय लागू किए गए हैं। अब आपका डेटा पहले से कहीं ज्यादा सुरक्षित है।" }
            ]
        };

        const DB_KEY = 'pravejStudyTracker';
        let lastAction = null;
        let undoTimeout = null;
        let dashboardProgressView = 'notes';
        let currentSubjectSourceView = 'notes';
        let subjectPageViewMode = 'all'; // 'all' or 'completed'
        let dptPageViewMode = 'pending'; // 'pending' or 'completed'
        
        let dynamicDisplayIntervals = {}; // To manage all rotating displays
        
        const getLocalDateString = (date = new Date()) => {
            date.setHours(0, 0, 0, 0);
            return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        };

        let lastIntervalDateString = getLocalDateString();
        
        const translations = {
            en: {
                "physics": "Physics", "polity": "Polity", "chemistry": "Chemistry", "hindi": "Hindi",
                "geography": "Geography", "biology": "Biology", "economics": "Economics",
                "history": "History", "math": "Math", "static-gk": "Static GK",
                "reasoning": "Reasoning", "संविधान-articles": "Constitution (Articles)", "maths-formulas": "Maths Formulas & Tables", "fill-form": "Form Filling / Misc",
                "study_tracker": "Study Tracker", "home": "Home", "subjects": "Subjects", "activity": "Activity",
                "calendar": "Calendar", "analytics": "Analytics", "report": "Report", "settings": "Settings", "reminders": "Reminders",
                "import_export": "Import/Export", "import_export_data": "Import & Export Data",
                "light_mode": "Light Mode", "dark_mode": "Dark Mode", "collapse": "Collapse", "expand": "Expand",
                "welcome_pravej": "Welcome", "welcome_subtitle": "Here's your plan for today. Let's get it done!",
                "todays_plan": "Today's Plan", "tomorrows_topics": "Tomorrow's Topics", "upcoming_revisions": "Upcoming Revisions",
                "achievements": "Achievements", "days_remaining": "Days Remaining",
                "overall_progress": "Overall Progress", "chapters_completed": "Chapters Completed",
                "set_date": "Set Date", "deadline_passed": "Deadline passed!", "all_chapters_completed": "All chapters completed!",
                "add_chapters_prompt": "Add chapters to track your progress.",
                "no_upcoming_revisions": "No upcoming revisions.", "keep_studying_prompt": "Keep studying to earn badges!",
                "today": "Today", "tomorrow": "Tomorrow", "congratulations": "Congratulations!", 
                "all_tasks_completed": "All tasks for today are completed.", "revision_task": "{chapterName} (Revision)", 
                "postpone_tomorrow": "Postpone", "skip_chapter": "Skip",
                "postponed_chapters": "Postponed Chapters", "no_postponed_chapters": "No chapters have been postponed.",
                "subject_wise_progress_dashboard": "Subject-wise Progress", "subjects_chapters": "Subjects & Chapters", 
                "search_chapters": "Search chapters...", "chapters_done_of": "{completed} / {total} chapters done",
                "no_chapters_added": "No chapters added yet.", "add_chapter": "Add Chapter", "your_activity": "Your Activity", 
                "no_activity_yet": "No Activity Yet", "start_studying_prompt": "Start studying and your progress will appear here.",
                "study_calendar": "Study Calendar", "analytics_reports": "Analytics & Reports", 
                "total_chapters_done": "Total Chapters Done", "average_per_day": "Average per Day", "best_day": "Best Day", 
                "top_subject": "Top Subject", "chapter_status_distribution": "Chapter Status Distribution", 
                "weekly_productivity": "Weekly Productivity (Chapters Done)", "subject_wise_progress": "Subject-wise Progress (%)",
                "completed_chapters_chart": "Completed Chapters", "app_language": "Application Language", "student_name": "Student Name",
                "data_management": "Data Management", "import_data": "Import Data", 
                "export_data": "Export All Data (Backup)", "daily_plan_mode": "Daily Study Plan Mode", 
                "daily_plan_subtitle": "Choose how you want to generate your daily study plan.",
                "auto_rotation": "Automatic Rotation", "weekly_cycle": "Weekly Cycle", "manual_today": "Manual (Today Only)",
                "manual_select_subjects": "Select subjects for Today's Plan:", "weekly_study_plan": "Weekly Study Plan", 
                "save_weekly_plan": "Save Weekly Plan", "reset_app": "Reset Application", "reset_all_data": "Reset All Data",
                "add_new_chapter": "Add New Chapter", "chapter_name": "Chapter Name", "are_you_sure": "Are you sure?",
                "action_cannot_be_undone": "This action cannot be undone.", "cancel": "Cancel", "confirm": "Confirm",
                "chapter_details": "Chapter Details", "status": "Status", "save_changes": "Save Changes",
                "delete_chapter": "Delete Chapter", "achievement_unlocked": "Achievement Unlocked!", "awesome": "Awesome!",
                "not_started": "Not Started", "in_progress": "In Progress", "completed": "Completed",
                "missed_chapters": "Missed Chapters", "no_missed_chapters": "No chapters have been missed.",
                "yesterdays_completed": "Yesterday's Completed Chapters", "no_chapters_yesterday": "No chapters were completed yesterday.",
                "notes_chapters": "Notes Chapters", "book_chapters": "Book Chapters",
                "chapter_completed_msg": "Chapter marked complete.", "undo": "Undo",
                "import": "Import", "export": "Export", "chapters_data_management": "Chapters Data Management",
                "import_export_chapters_desc": "Import or export chapter lists for specific sources (Notes or Book) in JSON format. This is useful for quickly adding a large number of chapters.",
                "full_app_backup": "Full Application Backup",
                "full_app_backup_desc": "Export all your data, including subjects, chapters, progress, settings, and activity log, into a single JSON file. Keep this file in a safe place as a backup.",
                "study_report": "Study Report", "download_pdf": "Download PDF", "overall_summary": "Overall Summary", 
                "total_subjects": "Total Subjects", "total_chapters": "Total Chapters", "progress": "Progress",
                "subject_breakdown": "Subject Breakdown", "completed_on": "Completed On", "no_activity_log_report": "No activity logged yet.",
                "recent_activity": "Recent Activity", "student_name_placeholder": "Enter your name...",
                "source_notes": "Notes", "source_book": "Book", "feature_coming_soon": "Feature Coming Soon!",
                "add_new_reminder": "Add New Reminder", "reminder_text": "Reminder Text", "reminder_date": "Date", "reminder_time": "Time", "save_reminder": "Save Reminder",
                "no_reminders_set": "No reminders set. Add one to get started!", "mark_done": "Done",
                "study_notes": "Study Notes", "study_notes_placeholder": "e.g., This chapter is important for exams...", "priority_revision": "Mark for Priority Revision",
                "reminder_repeat": "Repeat", "repeat_none": "Does not repeat", "repeat_daily": "Daily", "repeat_weekly": "Weekly", "reminder_completed_today": "Reminder completed for today",
                "notes_progress": "Notes Progress", "book_progress": "Book Progress",
                "subject_wise_progress_notes": "Subject Progress (Notes)", "subject_wise_progress_book": "Subject Progress (Book)",
                "exams": "Exams", "exams_and_forms": "Exams & Applied Forms", "add_new_exam": "Add New Exam", "application_date": "Application Date", "exam_date": "Exam Date", "notes": "Notes",
                "save_exam": "Save Exam", "status_applied": "Applied", "status_admit_card": "Admit Card Out", "status_exam_done": "Exam Done", "status_result_out": "Result Out", "applied_on": "Applied on",
                "no_exams_added": "No exams added yet. Track your applications here!", "all": "All", "upcoming_exams": "Upcoming Exams", "applied_forms": "Applied Forms", "ai_insights": "AI Study Coach ✨",
                "ai_insight_produ_day": "Your most productive day seems to be {day}. Keep up the great work!", "ai_insight_stale_subject": "You haven't studied {subject} in a while. Consider reviewing it.",
                "ai_insight_missed_chapters": "You have {count} missed chapters. Try to clear them soon.", "ai_insight_start": "Welcome! Let's start by adding some chapters to study.",
                "notes_placeholder": "e.g., Registration no., website link...", "delete_exam": "Delete Exam", "no_upcoming_exams": "No upcoming exams.", "edit_exam": "Edit Exam",
                "application_receipt": "Application Receipt", "view_receipt": "View Current Receipt", "receipt_attached": "Receipt Attached",
                "history_exams": "History", "no_history_exams": "No past exams found in your history.", "no_upcoming_exams_filter": "There are no upcoming exams scheduled.", "no_applied_forms_filter": "No forms currently in 'Applied' status.",
                "dpt": "DPT", "dpt_page_title": "Daily Practice Tests (DPT)", "all_subjects": "All Subjects",
                "add_dpt": "Add DPTs", "add_dpt_all": "Add to All Chapters", "no_dpt_for_subject": "No DPTs added for this subject yet.", "dpt_progress": "Test {completed} of {total} completed",
                "todays_dpt": "Today's DPT", "mark_as_complete": "Mark as Complete", "no_dpt_scheduled": "No DPT scheduled for today.",
                "all_dpt_completed": "All DPTs for today completed! Great job!",
                "enter_dpt_details": "Enter DPT Details", "dpt_total_q": "Total Qs", "dpt_total_time": "Total Time", "dpt_attempted": "Attempted",
                "dpt_correct": "Correct", "dpt_wrong": "Wrong", "dpt_time_taken": "Time Taken", "submit": "Submit",
                "dpt_summary": "DPT Summary", "total_dpt_completed": "Total DPTs Completed", "overall_accuracy": "Overall Accuracy",
                "avg_time_per_q": "Avg. Time / Q (s)", "add_new_subject": "Add New Subject",
                "enter_subject_name": "Enter the new subject name:", "subject_exists": "A subject with this name already exists.",
                "delete_all": "Delete All", "delete_all_chapters_confirm": "Are you sure you want to delete ALL chapters for this source? This cannot be undone.",
                "custom_cycle": "Custom Cycle", "custom_study_plan": "Custom Study Plan (2 Week Cycle)", "save_custom_plan": "Save Custom Plan",
                "dpt_plan_mode": "Daily DPT Plan Mode", "dpt_plan_subtitle": "Choose how you want to generate your daily DPT schedule.", "dpt_auto_mode": "Automatic (Follows Study Plan)", "custom_dpt_plan": "Custom DPT Plan (2 Week Cycle)",
                "dpt_report_title": "DPT Summary", "dpt_subject_breakdown": "DPT Subject Breakdown", "no_dpt_data_report": "No DPT data logged yet.",
                "sunday": "Sunday", "monday": "Monday", "tuesday": "Tuesday", "wednesday": "Wednesday", "thursday": "Thursday", "friday": "Friday", "saturday": "Saturday", "week": "Week",
                "delete_subject": "Delete Subject", "delete_subject_confirm": "This will delete the subject '{subjectName}' and all its chapters and DPTs. This action cannot be undone.",
                "delete_dpt": "Delete DPT", "delete_dpt_confirm": "Are you sure you want to delete {dptName}? This will remove its data permanently.",
                "routine_management": "Routine Management", "routine_management_desc": "Export your 14-day study cycle or import a new one from a JSON file.", "import_routine": "Import Routine (JSON)", "export_json": "Export as JSON", "export_pdf": "Export as PDF",
                "exams_data_management": "Exams Data Management", "exams_data_management_desc": "Import or export your list of exams. This is useful for backing up or transferring your exam schedule.",
                "complete_yesterdays_task": "Complete Yesterday's Task", "complete_yesterdays_dpt": "Complete Yesterday's DPT",
                "delete_all_dpts": "Delete All DPTs", "delete_all_dpts_confirm": "Are you sure you want to delete ALL DPTs for {subjectName}? This cannot be undone.",
                "restudy_subject": "Re-study Subject", "restudy_subject_confirm": "This will reset all chapter progress for '{subjectName}' and mark it as completed once. Are you sure? This is great for revision!",
                "completion_cycle": "Cycle {count}",
                "url_title": "Saved URLs", "add_new_folder": "Add New Folder", "folder_name": "Folder Name", "add_new_link": "Add New Link", "link_name": "Link Name", "link_url": "URL", "save": "Save", "edit": "Edit", "delete": "Delete", "no_links_in_folder": "No links saved in this folder yet.", "no_folders_created": "No folders created yet. Add one to get started!", "delete_folder_confirm": "Are you sure you want to delete the folder '{folderName}' and everything inside it?", "delete_link_confirm": "Are you sure you want to delete the link '{linkName}'?", "add_sub_folder": "Add Sub-folder",
                "completed_other_tasks": "Completed Other Tasks (Last 30 Days)", "no_completed_other_tasks": "No other tasks have been completed in the last 30 days."
            },
            hi: {
                "physics": "भौतिकी", "polity": "राजनीति", "chemistry": "रसायन विज्ञान", "hindi": "हिंदी",
                "geography": "भूगोल", "biology": "जीव विज्ञान", "economics": "अर्थशास्त्र",
                "history": "इतिहास", "math": "गणित", "static-gk": "स्टेटिक जीके",
                "reasoning": "रीजनिंग", "संविधान-articles": "संविधान (अनुच्छेद)", "maths-formulas": "गणित सूत्र और तालिका", "fill-form": "फॉर्म भरना / विविध",
                "study_tracker": "स्टडी ट्रैकर", "home": "होम", "subjects": "विषय", "activity": "गतिविधि",
                "calendar": "कैलेंडर", "analytics": "एनालिटिक्स", "report": "रिपोर्ट", "settings": "सेटिंग्स", "reminders": "रिमाइंडर",
                "import_export": "इंपोर्ट/एक्सपोर्ट", "import_export_data": "डेटा इंपोर्ट और एक्सपोर्ट करें",
                "light_mode": "लाइट मोड", "dark_mode": "डार्क मोड", "collapse": "संक्षिप्त करें", "expand": "विस्तार करें",
                "welcome_pravej": "आपका स्वागत है", "welcome_subtitle": "आज की आपकी योजना यहाँ है। चलिए इसे पूरा करते हैं!",
                "todays_plan": "आज की योजना", "tomorrows_topics": "कल के विषय", "upcoming_revisions": "आगामी रिवीजन",
                "achievements": "उपलब्धियां", "days_remaining": "शेष दिन",
                "overall_progress": "कुल प्रगति", "chapters_completed": "अध्याय पूरे हुए",
                "set_date": "तिथि सेट करें", "deadline_passed": "समय सीमा समाप्त हो गई!", "all_chapters_completed": "सभी अध्याय पूरे हो गए!",
                "add_chapters_prompt": "अपनी प्रगति को ट्रैक करने के लिए अध्याय जोड़ें।",
                "no_upcoming_revisions": "कोई आगामी रिवीजन नहीं है।", "keep_studying_prompt": "बैज अर्जित करने के लिए अध्ययन करते रहें!",
                "today": "आज", "tomorrow": "कल", "congratulations": "बधाई हो!", 
                "all_tasks_completed": "आज के सभी कार्य पूरे हो गए हैं।", "revision_task": "{chapterName} (रिवीजन)", 
                "postpone_tomorrow": "स्थगित", "skip_chapter": "स्किप",
                "postponed_chapters": "स्थगित अध्याय", "no_postponed_chapters": "कोई अध्याय स्थगित नहीं किया गया है।",
                "subject_wise_progress_dashboard": "विषय-वार प्रगति", "subjects_chapters": "विषय और अध्याय", 
                "search_chapters": "अध्याय खोजें...", "chapters_done_of": "{total} में से {completed} अध्याय पूरे हुए",
                "no_chapters_added": "अभी तक कोई अध्याय नहीं जोड़ा गया है।", "add_chapter": "अध्याय जोड़ें", 
                "your_activity": "आपकी गतिविधि", "no_activity_yet": "अभी तक कोई गतिविधि नहीं", 
                "start_studying_prompt": "अध्ययन शुरू करें और आपकी प्रगति यहां दिखाई देगी।",
                "study_calendar": "अध्ययन कैलेंडर", "analytics_reports": "एनालिटिक्स और रिपोर्ट", 
                "total_chapters_done": "कुल अध्याय पूरे हुए", "average_per_day": "प्रति दिन औसत", "best_day": "सबसे अच्छा दिन", 
                "top_subject": "शीर्ष विषय", "chapter_status_distribution": "अध्याय स्थिति वितरण", 
                "weekly_productivity": "साप्ताहिक उत्पादकता (अध्याय पूरे हुए)", "subject_wise_progress": "विषय-वार प्रगति (%)",
                "completed_chapters_chart": "पूर्ण अध्याय", "app_language": "एप्लिकेशन भाषा", "student_name": "छात्र का नाम",
                "data_management": "डेटा प्रबंधन", "import_data": "डेटा आयात करें", 
                "export_data": "सारा डेटा निर्यात करें (बैकअप)", "daily_plan_mode": "दैनिक अध्ययन योजना मोड", 
                "daily_plan_subtitle": "चुनें कि आप अपनी दैनिक अध्ययन योजना कैसे बनाना चाहते हैं।",
                "auto_rotation": "स्वचालित रोटेशन", "weekly_cycle": "साप्ताहिक चक्र", "manual_today": "मैनुअल (केवल आज)",
                "manual_select_subjects": "आज की योजना के लिए विषय चुनें:", "weekly_study_plan": "साप्ताहिक अध्ययन योजना", 
                "save_weekly_plan": "साप्ताहिक योजना सहेजें", "reset_app": "एप्लिकेशन रीसेट करें", "reset_all_data": "सारा डेटा रीसेट करें",
                "add_new_chapter": "नया अध्याय जोड़ें", "chapter_name": "अध्याय का नाम", "are_you_sure": "क्या आप निश्चित हैं?",
                "action_cannot_be_undone": "यह कार्रवाई पूर्ववत नहीं की जा सकती।", "cancel": "रद्द करें", "confirm": "पुष्टि करें",
                "chapter_details": "अध्याय विवरण", "status": "स्थिति", "save_changes": "बदलाव सहेजें",
                "delete_chapter": "अध्याय हटाएं", "achievement_unlocked": "उपलब्धि अनलॉक हुई!", "awesome": "बहुत बढ़िया!",
                "not_started": "शुरू नहीं हुआ", "in_progress": "प्रगति में है", "completed": "पूरा हो गया",
                "missed_chapters": "छूटे हुए अध्याय", "no_missed_chapters": "कोई भी अध्याय छूटा नहीं है।",
                "yesterdays_completed": "कल पूरे हुए अध्याय", "no_chapters_yesterday": "कल कोई अध्याय पूरा नहीं हुआ।",
                "notes_chapters": "नोट्स चैप्टर्स", "book_chapters": "बुक चैप्टर्स",
                "chapter_completed_msg": "अध्याय पूरा हुआ।", "undo": "पूर्ववत् करें",
                "import": "आयात", "export": "निर्यात", "chapters_data_management": "चैप्टर्स डेटा प्रबंधन",
                "import_export_chapters_desc": "JSON प्रारूप में विशिष्ट स्रोतों (नोट्स या बुक) के लिए अध्याय सूचियों को आयात या निर्यात करें। यह बड़ी संख्या में अध्यायों को जल्दी से जोड़ने के लिए उपयोगी है।",
                "full_app_backup": "पूर्ण एप्लिकेशन बैकअप",
                "full_app_backup_desc": "विषय, अध्याय, प्रगति, सेटिंग्स और गतिविधि लॉग सहित अपने सभी डेटा को एक ही JSON फ़ाइल में निर्यात करें। इस फ़ाइल को बैकअप के रूप में सुरक्षित स्थान पर रखें।",
                "study_report": "स्टडी रिपोर्ट", "download_pdf": "पीडीएफ डाउनलोड करें", "overall_summary": "कुल सारांश",
                "total_subjects": "कुल विषय", "total_chapters": "कुल अध्याय", "progress": "प्रगति",
                "subject_breakdown": "विषयवार विश्लेषण", "completed_on": "को पूरा हुआ", "no_activity_log_report": "अभी तक कोई गतिविधि लॉग नहीं की गई है।",
                "recent_activity": "हाल की गतिविधि", "student_name_placeholder": "अपना नाम दर्ज करें...",
                "source_notes": "नोट्स", "source_book": "बुक", "feature_coming_soon": "यह सुविधा जल्द ही आ रही है!",
                "add_new_reminder": "नया रिमाइंडर जोड़ें", "reminder_text": "रिमाइंडर टेक्स्ट", "reminder_date": "तारीख", "reminder_time": "समय", "save_reminder": "रिमाइंडर सहेजें",
                "no_reminders_set": "कोई रिमाइंडर सेट नहीं है। आरंभ करने के लिए एक जोड़ें!", "mark_done": "पूर्ण",
                "study_notes": "स्टडी नोट्स", "study_notes_placeholder": "जैसे, यह अध्याय परीक्षा के लिए महत्वपूर्ण है...", "priority_revision": "प्राथमिकता रिवीजन के लिए चिह्नित करें",
                "reminder_repeat": "दोहराएँ", "repeat_none": "नहीं दोहराता", "repeat_daily": "रोज़", "repeat_weekly": "साप्ताहिक", "reminder_completed_today": "रिमाइंडर आज के लिए पूरा हुआ",
                "notes_progress": "नोट्स प्रगति", "book_progress": "पुस्तक प्रगति",
                "subject_wise_progress_notes": "विषय प्रगति (नोट्स)", "subject_wise_progress_book": "विषय प्रगति (पुस्तक)",
                "exams": "परीक्षाएं", "exams_and_forms": "परीक्षाएं और भरे हुए फॉर्म", "add_new_exam": "नई परीक्षा जोड़ें", "application_date": "आवेदन तिथि", "exam_date": "परीक्षा तिथि", "notes": "नोट्स",
                "save_exam": "परीक्षा सहेजें", "status_applied": "आवेदन किया गया", "status_admit_card": "एडमिट कार्ड आ गया", "status_exam_done": "परीक्षा हो गई", "status_result_out": "परिणाम आ गया", "applied_on": "आवेदन किया",
                "no_exams_added": "अभी तक कोई परीक्षा नहीं जोड़ी गई है। यहां अपने आवेदन ट्रैक करें!", "all": "सभी", "upcoming_exams": "आगामी परीक्षाएं", "applied_forms": "भरे हुए फॉर्म", "ai_insights": "AI स्टडी कोच ✨",
                "ai_insight_produ_day": "आपका सबसे प्रोडक्टिव दिन {day} लगता है। बढ़िया काम करते रहें!", "ai_insight_stale_subject": "आपने काफी समय से {subject} नहीं पढ़ा है। इसे दोहराने पर विचार करें।",
                "ai_insight_missed_chapters": "आपके {count} अध्याय छूट गए हैं। उन्हें जल्द ही पूरा करने का प्रयास करें।", "ai_insight_start": "स्वागत है! चलिए अध्ययन करने के लिए कुछ अध्याय जोड़कर शुरुआत करते हैं।",
                "notes_placeholder": "उदा., पंजीकरण संख्या, वेबसाइट लिंक...", "delete_exam": "परीक्षा हटाएं", "no_upcoming_exams": "कोई आगामी परीक्षा नहीं है।", "edit_exam": "परीक्षा संपादित करें",
                "application_receipt": "आवेदन रसीद", "view_receipt": "वर्तमान रसीद देखें", "receipt_attached": "रसीद संलग्न है",
                "history_exams": "इतिहास", "no_history_exams": "आपके इतिहास में कोई पिछली परीक्षा नहीं मिली।", "no_upcoming_exams_filter": "कोई आगामी परीक्षा निर्धारित नहीं है।", "no_applied_forms_filter": "'आवेदन किया गया' स्थिति में वर्तमान में कोई फॉर्म नहीं है।",
                "dpt": "DPT", "dpt_page_title": "डेली प्रैक्टिस टेस्ट (DPT)", "all_subjects": "सभी विषय",
                "add_dpt": "DPT जोड़ें", "add_dpt_all": "सभी चैप्टर्स में जोड़ें", "no_dpt_for_subject": "इस विषय के लिए अभी तक कोई DPT नहीं जोड़ा गया है।", "dpt_progress": "{total} में से {completed} टेस्ट पूरे हुए",
                "todays_dpt": "आज का DPT", "mark_as_complete": "पूर्ण के रूप में चिह्नित करें", "no_dpt_scheduled": "आज के लिए कोई DPT निर्धारित नहीं है।",
                "all_dpt_completed": "आज के सभी DPT पूरे हो गए! बहुत बढ़िया!",
                "enter_dpt_details": "DPT विवरण दर्ज करें", "dpt_total_q": "कुल प्रश्न", "dpt_total_time": "कुल समय", "dpt_attempted": "प्रयास किए",
                "dpt_correct": "सही", "dpt_wrong": "गलत", "dpt_time_taken": "लिया गया समय", "submit": "सबमिट करें",
                "dpt_summary": "DPT सारांश", "total_dpt_completed": "कुल DPT पूरे हुए", "overall_accuracy": "कुल सटीकता",
                "avg_time_per_q": "औसत समय/प्रश्न (से)", "add_new_subject": "नया विषय जोड़ें",
                "enter_subject_name": "नए विषय का नाम दर्ज करें:", "subject_exists": "इस नाम का विषय पहले से मौजूद है।",
                "delete_all": "सभी हटाएं", "delete_all_chapters_confirm": "क्या आप वाकई इस स्रोत के सभी चैप्टर्स को हटाना चाहते हैं? यह क्रिया पूर्ववत् नहीं की जा सकती।",
                "custom_cycle": "कस्टम साइकिल", "custom_study_plan": "कस्टम अध्ययन योजना (2 सप्ताह चक्र)", "save_custom_plan": "कस्टम योजना सहेजें",
                "dpt_plan_mode": "दैनिक DPT योजना मोड", "dpt_plan_subtitle": "चुनें कि आप अपनी दैनिक DPT योजना कैसे बनाना चाहते हैं।", "dpt_auto_mode": "स्वचालित (अध्ययन योजना के अनुसार)", "custom_dpt_plan": "कस्टम DPT योजना (2 सप्ताह चक्र)",
                "dpt_report_title": "DPT सारांश", "dpt_subject_breakdown": "DPT विषयवार विश्लेषण", "no_dpt_data_report": "अभी तक कोई DPT डेटा लॉग नहीं किया गया है।",
                "sunday": "रविवार", "monday": "सोमवार", "tuesday": "मंगलवार", "wednesday": "बुधवार", "thursday": "गुरुवार", "friday": "शुक्रवार", "saturday": "शनिवार", "week": "सप्ताह",
                "delete_subject": "विषय हटाएं", "delete_subject_confirm": "यह विषय '{subjectName}' और इसके सभी चैप्टर्स और DPTs को हटा देगा। यह कार्रवाई पूर्ववत् नहीं की जा सकती।",
                "delete_dpt": "DPT हटाएं", "delete_dpt_confirm": "क्या आप वाकई {dptName} को हटाना चाहते हैं? इसका डेटा स्थायी रूप से हट जाएगा।",
                "routine_management": "रूटीन प्रबंधन", "routine_management_desc": "अपनी 14-दिवसीय अध्ययन योजना को एक्सपोर्ट करें या JSON फ़ाइल से एक नई योजना इंपोर्ट करें।", "import_routine": "रूटीन इंपोर्ट करें (JSON)", "export_json": "JSON एक्सपोर्ट करें", "export_pdf": "PDF एक्सपोर्ट करें",
                "exams_data_management": "परीक्षा डेटा प्रबंधन", "exams_data_management_desc": "अपनी परीक्षाओं की सूची इंपोर्ट या एक्सपोर्ट करें। यह आपके परीक्षा कार्यक्रम का बैकअप लेने या स्थानांतरित करने के लिए उपयोगी है।",
                "complete_yesterdays_task": "कल का टास्क पूरा करें", "complete_yesterdays_dpt": "कल का DPT पूरा करें",
                "delete_all_dpts": "सभी DPT हटाएं", "delete_all_dpts_confirm": "{subjectName} के सभी DPT को हटाने के लिए क्या आप निश्चित हैं? इसे पूर्ववत नहीं किया जा सकता।",
                "restudy_subject": "विषय को दोबारा पढ़ें", "restudy_subject_confirm": "यह '{subjectName}' के सभी चैप्टर की प्रगति को रीसेट कर देगा और इसे एक बार पूरा हुआ चिह्नित करेगा। क्या आप निश्चित हैं? यह रिवीजन के लिए बहुत अच्छा है!",
                "completion_cycle": "चक्र {count}",
                "url_title": "सहेजे गए यूआरएल", "add_new_folder": "नया फ़ोल्डर जोड़ें", "folder_name": "फ़ोल्डर का नाम", "add_new_link": "नया लिंक जोड़ें", "link_name": "लिंक का नाम", "link_url": "यूआरएल", "save": "सहेजें", "edit": "संपादित करें", "delete": "हटाएं", "no_links_in_folder": "इस फ़ोल्डर में अभी तक कोई लिंक नहीं सहेजा गया है।", "no_folders_created": "अभी तक कोई फ़ोल्डर नहीं बनाया गया है। आरंभ करने के लिए एक जोड़ें!", "delete_folder_confirm": "क्या आप वाकई फ़ोल्डर '{folderName}' और उसके अंदर की सभी चीज़ें हटाना चाहते हैं?", "delete_link_confirm": "क्या आप वाकई लिंक '{linkName}' हटाना चाहते हैं?", "add_sub_folder": "सब-फ़ोल्डर जोड़ें",
                "completed_other_tasks": "पूर्ण हुए अन्य कार्य (पिछले 30 दिन)", "no_completed_other_tasks": "पिछले 30 दिनों में कोई अन्य कार्य पूरा नहीं हुआ है।"
            }
        };

        const initialState = {
            subjects: [
                { id: "physics", name: "Physics", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "chemistry", name: "Chemistry", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "biology", name: "Biology", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "geography", name: "Geography", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "polity", name: "Polity", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "economics", name: "Economics", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "history", name: "History", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "reasoning", name: "Reasoning", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "math", name: "Math", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "hindi", name: "Hindi", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "static-gk", name: "Static GK", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "संविधान-articles", name: "Constitution (Articles)", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "maths-formulas", name: "Maths Formulas & Tables", chapters: { notes: [], book: [] }, completionCount: 0 },
                { id: "fill-form", name: "Form Filling / Misc", chapters: { notes: [], book: [] }, completionCount: 0 }
            ],
            settings: {
                theme: 'light',
                planMode: 'auto',
                customCyclePlan: Array(14).fill([]),
                dptPlanMode: 'auto',
                dptCyclePlan: Array(14).fill([]),
                language: 'en', 
                studentName: 'Pravej Ahmad',
                customThemeColors: { 
                    start: null, end: null,
                    textLight: null, borderLight: null, textDark: null, borderDark: null 
                },
                backgroundStyle: 'particles', 
                appVersion: "1.0"
            },
            gamification: { badges: [], completedHistory: [] },
            activityLog: [], appStartDate: getLocalDateString(),
            postponedChapters: [],
            missedChapters: [],
            missedRevisions: [],
            dailyPlan: {},
            lastCheckedDate: null,
            exams: [],
            dpts: {},
            dailyDptPlan: {},
            urls: [],
            otherTasks: [],
            missedOtherTasks: [],
            postponedOtherTasks: []
        };

        let data;
        
        try {
            const savedData = localStorage.getItem(DB_KEY);
            data = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(initialState));
        } catch (error) {
            console.error("Error parsing saved data, resetting to initial state.", error);
            alert("Could not read saved data. It might be corrupted. The application will start fresh.");
            data = JSON.parse(JSON.stringify(initialState));
        }
        
        data.settings = {...initialState.settings, ...data.settings};
        data.settings.customThemeColors = {...initialState.settings.customThemeColors, ...data.settings.customThemeColors};
        
        data.postponedChapters = data.postponedChapters || [];
        data.missedChapters = data.missedChapters || [];
        data.missedRevisions = data.missedRevisions || [];
        data.dailyPlan = data.dailyPlan || {};
        data.lastCheckedDate = data.lastCheckedDate || getLocalDateString();
        data.exams = data.exams || [];
        data.dpts = data.dpts || {};
        data.dailyDptPlan = data.dailyDptPlan || {};
        data.urls = data.urls || [];
        data.otherTasks = data.otherTasks || [];
        data.missedOtherTasks = data.missedOtherTasks || [];
        data.postponedOtherTasks = data.postponedOtherTasks || [];
        if (data.links) { delete data.links; } // Migration from old structure
        
        data.settings.backgroundStyle = data.settings.backgroundStyle || 'particles'; 
        
        if(data.settings.weeklyPlan) {
            data.settings.customCyclePlan = [...Object.values(data.settings.weeklyPlan), ...Array(7).fill([])];
            delete data.settings.weeklyPlan;
        }
        if(!data.settings.customCyclePlan || data.settings.customCyclePlan.length !== 14) {
            const oldPlan = data.settings.customCyclePlan || [];
            data.settings.customCyclePlan = Array(14).fill([]).map((_, i) => oldPlan[i] || []);
        }
        if(!data.settings.dptCyclePlan || data.settings.dptCyclePlan.length !== 14) {
             const oldDptPlan = data.settings.dptCyclePlan || [];
            data.settings.dptCyclePlan = Array(14).fill([]).map((_, i) => oldDptPlan[i] || []);
        }
        delete data.settings.cycleLength; 
        delete data.settings.dptCycleLength; 

        (data.exams || []).forEach(exam => { if(typeof exam.receipt === 'undefined') exam.receipt = null; });
        
        if (data.targets) delete data.targets;
        if (data.settings && data.settings.deadline) delete data.settings.deadline;
        
        (data.subjects || []).forEach(s => {
            if (Array.isArray(s.chapters)) s.chapters = { notes: s.chapters, book: [] };
            s.chapters = s.chapters || { notes: [], book: [] };
            s.chapters.notes = s.chapters.notes || [];
            s.chapters.book = s.chapters.book || [];
            if(typeof s.completionCount === 'undefined') s.completionCount = 0; // Migration for re-study feature
            
            const migrateChapter = c => {
                if (typeof c.notes === 'undefined') c.notes = '';
                if (typeof c.priorityRevision === 'undefined') c.priorityRevision = false;
                if (c.status === 'In Progress') c.status = 'Not Started';
                if (!Array.isArray(c.revisions)) c.revisions = [];
            };
            s.chapters.notes.forEach(migrateChapter);
            s.chapters.book.forEach(migrateChapter);
        });

        // DPT Data Structure Migration from flat tests to chapter-based
        let dptDataMigrated = false;
        Object.keys(data.dpts || {}).forEach(subjectId => {
            if (data.dpts[subjectId].tests) { // Old structure detected
                dptDataMigrated = true;
                delete data.dpts[subjectId]; // Remove old, non-migratable data
            }
        });
        if (dptDataMigrated) {
            console.log('Old DPT data structure detected and cleared for new system.');
            // This will be announced in the update popup.
        }


        const saveData = () => {
            try {
                // Defensive check to prevent saving corrupted DPT data
                Object.keys(data.dpts || {}).forEach(subjectId => {
                    if (data.dpts[subjectId] && data.dpts[subjectId].tests) {
                        console.error(`Attempted to save old DPT format for subject: ${subjectId}. Preventing save.`);
                        return; // Stop the save
                    }
                });
                localStorage.setItem(DB_KEY, JSON.stringify(data));
            } catch (error) {
                console.error("Failed to save data to localStorage:", error);
                alert("Could not save your progress. Your browser's storage might be full or in private mode.");
            }
        };
        
        const _ = (key, replacements = {}) => {
            const lang = data.settings.language || 'en';
            let text = translations[lang]?.[key] || translations['en'][key];
            if (text === undefined) {
                const subject = (data.subjects || []).find(s => s.id === key);
                text = subject ? subject.name : key;
            }
            if(text === undefined) return key;

            Object.keys(replacements).forEach(placeholder => {
                text = text.replace(`{${placeholder}}`, replacements[placeholder]);
            });
            return text;
        };

        const applyTranslations = () => {
            document.querySelectorAll('[data-translate]').forEach(el => el.innerText = _(el.dataset.translate));
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => el.placeholder = _(el.dataset.translatePlaceholder));
            updateAllUI();
        };
        
        const dailyPattern = [
            ["physics:notes", "history:notes", "math:notes", "static-gk:notes"],
            ["chemistry:notes", "history:notes", "math:notes", "संविधान-articles:notes"],
            ["biology:notes", "history:notes", "math:notes", "maths-formulas:notes"],
            ["physics:notes", "history:notes", "math:notes", "static-gk:notes"],
            ["chemistry:notes", "history:notes", "math:notes", "संविधान-articles:notes"],
            ["biology:notes", "history:notes", "math:notes", "maths-formulas:notes"],
            ["math:notes", "reasoning:notes", "fill-form:notes"],
            ["polity:notes", "history:notes", "math:notes", "static-gk:notes"],
            ["hindi:notes", "history:notes", "math:notes", "संविधान-articles:notes"],
            ["geography:notes", "history:notes", "math:notes", "maths-formulas:notes"],
            ["economics:notes", "history:notes", "math:notes", "static-gk:notes"],
            ["polity:notes", "history:notes", "math:notes", "संविधान-articles:notes"],
            ["geography:notes", "history:notes", "math:notes", "maths-formulas:notes"],
            ["economics:notes", "math:notes", "reasoning:notes", "fill-form:notes"]
        ];

        let allCharts = {};
        let currentExamFilter = 'all';

        const pages = document.querySelectorAll('.page');
        const navBtns = document.querySelectorAll('.nav-btn');
        const themeToggleBtns = [document.getElementById('theme-toggle-btn'), document.getElementById('theme-toggle-btn-mobile')];
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const undoToast = document.getElementById('undo-toast');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');

        let animationFrameId;
        const particleCanvas = document.getElementById('particle-canvas');
        const ctx = particleCanvas.getContext('2d');
        let backgroundElements = [];

        const init = () => {
            handleNewDayLogic();
            applyTheme(data.settings.theme);
            applyBackgroundStyle();
            applyCustomTheme();
            applyManualColors();
            lucide.createIcons();
            addEventListeners();
            applyTranslations();
            if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            setInterval(checkDateChange, 60000); 
            checkAppUpdate();
            navigateTo('home');
        };

        const checkDateChange = () => {
            const currentDateString = getLocalDateString();
            if (currentDateString !== lastIntervalDateString) {
                lastIntervalDateString = currentDateString;
                handleNewDayLogic();
                if (document.getElementById('page-home').classList.contains('active')) {
                    renderHomePage();
                }
            }
        };
        
        const checkAppUpdate = () => {
            const savedVersion = data.settings.appVersion || "1.0";
            if (savedVersion !== CURRENT_APP_VERSION) {
                const notesKey = Object.keys(updateNotes).find(key => key === CURRENT_APP_VERSION);
                if(notesKey){
                    showAnimatedUpdatePopup(notesKey, savedVersion);
                }
                data.settings.appVersion = CURRENT_APP_VERSION;
                saveData();
            }
        };
        
        const showAnimatedUpdatePopup = (version, oldVersion) => {
            const notesForVersion = updateNotes[version];
            if (!notesForVersion) return;

            const headerEl = document.getElementById('update-popup-header');
            const contentEl = document.getElementById('update-popup-content');
            
            headerEl.innerHTML = `<h2 class="text-xl font-bold mb-1 text-white flex items-center justify-center gap-2"><i data-lucide="sparkles" class="text-amber-300"></i> नया अपडेट!</h2>
                <p class="text-xs text-indigo-300">Updated by Pravej Ahmad | संस्करण: ${version} | ${new Date().toLocaleDateString('hi-IN')}</p>`;
            
            contentEl.innerHTML = '';
            showModal('update-popup-modal');
            lucide.createIcons();
            
            notesForVersion.forEach((item, index) => {
                const noteContainer = document.createElement('div');
                noteContainer.className = 'p-3 bg-white/10 rounded-lg update-note-item';
                noteContainer.style.animationDelay = `${index * 150}ms`;
                const titleEl = document.createElement('h4');
                titleEl.className = 'font-bold text-amber-300 flex items-center gap-2 mb-1';
                titleEl.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i> ${item.title}`;
                const noteEl = document.createElement('p');
                noteEl.className = 'ml-6 text-indigo-200 text-xs';
                noteEl.innerHTML = item.note;
                noteContainer.appendChild(titleEl);
                noteContainer.appendChild(noteEl);
                contentEl.appendChild(noteContainer);
            });
            lucide.createIcons();
        };
        
        const showUndoToast = (message, onUndo) => {
            clearTimeout(undoTimeout);
            document.getElementById('undo-message').textContent = message;
            const undoBtn = document.getElementById('undo-btn');
            const newUndoBtn = undoBtn.cloneNode(true);
            newUndoBtn.textContent = _('undo');
            undoBtn.parentNode.replaceChild(newUndoBtn, undoBtn);
            const undoHandler = () => { onUndo(); hideUndoToast(); };
            newUndoBtn.addEventListener('click', undoHandler, { once: true });
            undoToast.classList.add('show');
            undoTimeout = setTimeout(hideUndoToast, 6000);
        };

        const hideUndoToast = () => {
            clearTimeout(undoTimeout);
            undoToast.classList.remove('show');
        };

        const handleNewDayLogic = () => {
            const todayStr = getLocalDateString();
            if (data.lastCheckedDate === todayStr) return;

            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterdayStr = data.lastCheckedDate || getLocalDateString(yesterdayDate);
            
            // Handle Missed Chapters
            const yesterdayPlanData = data.dailyPlan[yesterdayStr];
            if (yesterdayPlanData?.tasks) {
                yesterdayPlanData.completedSubjects = yesterdayPlanData.completedSubjects || [];
                Object.entries(yesterdayPlanData.tasks).forEach(([key, task]) => {
                    if (task?.subjectId && task.chapterId && !yesterdayPlanData.completedSubjects.includes(key)) {
                        const chapter = getChapterByIds(task.subjectId, task.chapterId, task.sourceType);
                        if (chapter && chapter.status !== 'Completed' && !data.missedChapters.some(c => c.chapterId === task.chapterId)) {
                            data.missedChapters.push({ subjectId: task.subjectId, chapterId: task.chapterId, sourceType: task.sourceType, date: yesterdayStr });
                        }
                    }
                });
            }

             // Handle Missed "Other Tasks"
            const missedOtherTasks = (data.otherTasks || []).filter(task => task.date === yesterdayStr && task.status === 'Pending');
            missedOtherTasks.forEach(task => {
                if (!data.missedOtherTasks.some(missed => missed.id === task.id)) {
                    data.missedOtherTasks.push(task);
                }
            });


            // Handle Missed Revisions from yesterday
            data.missedRevisions = data.missedRevisions || [];
            (data.subjects || []).forEach(s => {
                const findMissedRevisions = (chapters, sourceType) => (chapters || []).forEach(c => (c.revisions || []).forEach(r => { 
                    if(r.status === 'Pending' && r.date === yesterdayStr) {
                         if (!data.missedRevisions.some(mr => mr.chapterId === c.id && mr.revisionDate === r.date)) {
                            data.missedRevisions.push({ subjectId: s.id, chapterId: c.id, sourceType: sourceType, revisionDate: r.date });
                         }
                    }
                }));
                findMissedRevisions(s.chapters.notes, 'notes'); 
                findMissedRevisions(s.chapters.book, 'book');
            });


            // Handle Missed DPTs
            const yesterdayDptPlan = data.dailyDptPlan[yesterdayStr];
            if (yesterdayDptPlan) {
                yesterdayDptPlan.forEach(({ subjectId, chapterId, testId }) => {
                    const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId);
                    if (test && test.status !== 'Completed') {
                        // We don't need a separate missed DPT list, the logic on dashboard will handle it
                    }
                });
            }

            data.lastCheckedDate = todayStr;
            Object.keys(data.dailyPlan).forEach(date => { if (new Date(todayStr) - new Date(date) > 7 * 24 * 60 * 60 * 1000) { delete data.dailyPlan[date]; } });
            Object.keys(data.dailyDptPlan).forEach(date => { if (new Date(todayStr) - new Date(date) > 7 * 24 * 60 * 60 * 1000) { delete data.dailyDptPlan[date]; } });

            saveData();
        };

        const updateAllUI = () => {
            const activePageId = document.querySelector('.page.active')?.id.replace('page-', '');
            const pageRenderFunctions = {
                home: renderHomePage, subjects: renderSubjectsPage, dpt: renderDptPage,
                analytics: renderAnalyticsPage, settings: renderSettingsPage, calendar: renderCalendarPage,
                report: renderReportPage, 'import-export': renderImportExportPage,
                exams: renderExamsPage, url: renderUrlPage
            };
            if(activePageId && pageRenderFunctions[activePageId]) {
                 pageRenderFunctions[activePageId]();
            } else {
                renderHomePage();
            }
        };
        
        const applyTheme = (theme) => {
            document.documentElement.className = theme;
            const isDark = theme === 'dark';
            ['theme-icon-sun', 'theme-icon-sun-mobile'].forEach(id => document.getElementById(id).style.display = isDark ? 'none' : 'block');
            ['theme-icon-moon', 'theme-icon-moon-mobile'].forEach(id => document.getElementById(id).style.display = isDark ? 'block' : 'none');
            applyCustomTheme();
            applyBackgroundStyle();
            if (document.getElementById('page-analytics').classList.contains('active')) renderAnalyticsPage();
        };
        
        const applyManualColors = () => {
            const root = document.documentElement;
            const colors = data.settings.customThemeColors;
            const mapping = {
                textLight: '--text-light', borderLight: '--border-light',
                textDark: '--text-dark', borderDark: '--border-dark'
            };
            for (const [key, variable] of Object.entries(mapping)) {
                if (colors[key]) {
                    root.style.setProperty(variable, colors[key]);
                } else {
                    root.style.removeProperty(variable);
                }
            }
        };
        
        const applyCustomTheme = () => {
            const { start, end } = data.settings.customThemeColors;
            const root = document.documentElement;
            const isDark = data.settings.theme === 'dark';
            const startProp = isDark ? '--main-bg-start-dark' : '--main-bg-start-light';
            const endProp = isDark ? '--main-bg-end-dark' : '--main-bg-end-light';
            if (start && end) {
                root.style.setProperty(startProp, start);
                root.style.setProperty(endProp, end);
            } else {
                root.style.removeProperty(startProp);
                root.style.removeProperty(endProp);
            }
        };

        const toggleTheme = () => {
            data.settings.theme = (data.settings.theme === 'light') ? 'dark' : 'light';
            saveData();
            applyTheme(data.settings.theme);
        };
        
        const toggleSidebar = () => {
            sidebar.classList.toggle('w-64');
            sidebar.classList.toggle('w-20');
            sidebar.classList.toggle('sidebar-collapsed');
            sidebarToggleBtn.querySelector('i').setAttribute('data-lucide', sidebar.classList.contains('sidebar-collapsed') ? 'chevrons-right' : 'chevrons-left');
            lucide.createIcons();
        };

        const updateNavHighlight = (pageId) => {
            navBtns.forEach(b => { b.classList.toggle('text-primary', b.dataset.page === pageId); b.classList.toggle('bg-sky-100', b.dataset.page === pageId); b.classList.toggle('dark:bg-sky-900/50', b.dataset.page === pageId); });
            document.querySelectorAll('.mobile-nav-btn').forEach(b => { b.classList.toggle('active', b.dataset.page === pageId); });
        };
        
        const navigateTo = (pageId) => {
            Object.values(dynamicDisplayIntervals).forEach(clearInterval); // Clear all intervals on page change
            dynamicDisplayIntervals = {};

            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`)?.classList.add('active');
            updateNavHighlight(pageId);
            const renderFunctions = {
                home: renderHomePage, subjects: renderSubjectsPage, dpt: renderDptPage, calendar: renderCalendarPage,
                settings: renderSettingsPage, report: renderReportPage,
                'import-export': renderImportExportPage,
                exams: renderExamsPage,
                url: renderUrlPage,
                analytics: () => requestAnimationFrame(renderAnalyticsPage)
            };
            renderFunctions[pageId]?.();
        };
        
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        const getCycleDayIndex = (date) => {
            const dayOfWeek = date.getDay(); 
            const weekNumber = getWeekNumber(date);
            const isSecondWeekOfCycle = weekNumber % 2 === 0;
            return dayOfWeek + (isSecondWeekOfCycle ? 7 : 0);
        };

        const getSubjectById = (id) => (data.subjects || []).find(s => s.id === id);
        const getChapterByIds = (subjectId, chapterId, sourceType) => {
            const subject = getSubjectById(subjectId);
            if (!subject || !chapterId) return null;
            // If sourceType is provided, search only there. Otherwise, search both.
            if (sourceType) {
                return subject.chapters[sourceType]?.find(c => c.id === chapterId) || null;
            }
            const allChapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])];
            return allChapters.find(c => c.id === chapterId) || null;
        };

        const logActivity = (icon, description) => {
            data.activityLog.unshift({ timestamp: new Date().toISOString(), icon, description });
            if (data.activityLog.length > 100) data.activityLog.pop();
            saveData();
            if (document.getElementById('page-report')?.classList.contains('active')) renderReportPage();
        };

        const renderHomePage = () => {
            handleNewDayLogic();
            document.getElementById('welcome-heading').innerHTML = `${_('welcome_pravej')}, <span class="text-primary">${data.settings.studentName || 'Student'}!</span>`;
            
            // Clear old intervals before re-rendering
            Object.values(dynamicDisplayIntervals).forEach(clearInterval);
            dynamicDisplayIntervals = {};
            
            // Generate plans first, as they are dependent on each other
            getOrGenerateDailyPlan(getLocalDateString());
            getOrGenerateDailyDptPlan(getLocalDateString());

            renderAIInsights();
            renderTodaysPlan();
            renderTodaysDpt(); 
            renderTomorrowsPlan();
            renderYesterdaysActivity();
            renderMissedChapters();
            renderMissedOtherTasks();
            renderMissedRevisions();
            renderUpcomingExamsOnDashboard();
            renderOverallProgress();
            renderUpcomingRevisions();
            renderBadges();
            renderSubjectWiseProgressDashboard();
            lucide.createIcons(); // Final call to ensure all icons are rendered
        };
        
        // New generic function for rotating content
        const initRotatingDisplay = (containerId, items, renderFunction, emptyMessage) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (dynamicDisplayIntervals[containerId]) {
                clearInterval(dynamicDisplayIntervals[containerId]);
            }

            if (items.length === 0) {
                container.innerHTML = `<p class="text-sm text-center text-text-muted-light dark:text-text-muted-dark p-4">${emptyMessage}</p>`;
                return;
            }

            let currentIndex = 0;
            const displayNextItem = () => {
                const item = items[currentIndex];
                container.innerHTML = `<div class="dynamic-content-item">${renderFunction(item)}</div>`;
                
                // Trigger fade-in animation
                setTimeout(() => {
                    const dynamicItem = container.querySelector('.dynamic-content-item');
                    if(dynamicItem) dynamicItem.classList.add('active');
                }, 50);

                currentIndex = (currentIndex + 1) % items.length;
                lucide.createIcons();
            };

            displayNextItem();
            if (items.length > 1) {
                dynamicDisplayIntervals[containerId] = setInterval(displayNextItem, 5000);
            }
        };

        const motivationalQuotes = [
            "सफलता अंतिम नहीं है, असफलता घातक नहीं है: यह जारी रखने का साहस है जो मायने रखता है। 💪",
            "आपका भविष्य आपके आज के कार्यों से बनता है, कल के नहीं। 🌅",
            "सफलता की राह में कड़ी मेहनत का कोई विकल्प नहीं है। 🛠️",
            "हर सुबह एक नई शुरुआत है, इसे बेहतरीन बनाएं। ☀️",
            "सपने वो नहीं जो आप सोते समय देखते हैं, सपने वो हैं जो आपको सोने नहीं देते। 🦉",
            "जीतने वाले अलग चीजें नहीं करते, वे चीजों को अलग तरह से करते हैं। 🏆",
            "खुद पर विश्वास करो और तुम अजेय हो जाओगे। 🦁",
            "कड़ी मेहनत प्रतिभा को हरा देती है जब प्रतिभा कड़ी मेहनत नहीं करती। 🏃‍♂️",
            "एकमात्र सीमा आपकी कल्पना है। ✨",
            "आज का दर्द कल की ताकत है। 🏋️",
            "सफलता छोटे-छोटे प्रयासों का योग है, जो दिन-प्रतिदिन दोहराए जाते हैं। 📈",
            "एक लक्ष्य निर्धारित करें जो आपको सुबह बिस्तर से बाहर कूदने पर मजबूर कर दे। ☀️",
            "आप जितना सोचते हैं, उससे कहीं ज्यादा बहादुर हैं। 🦸",
            "ज्ञान में निवेश सर्वोत्तम ब्याज देता है। 📚",
            "अपने जुनून को अपने उद्देश्य में बदलो। ❤️‍🔥",
            "आगे बढ़ने का रहस्य शुरुआत करना है। 🚀",
            "यह हमेशा असंभव लगता है जब तक कि यह पूरा न हो जाए। ✅",
            "यदि आप महान चीजें नहीं कर सकते, तो छोटी चीजों को महान तरीके से करें। 🐜",
            "आपकी शिक्षा आपके भविष्य का पासपोर्ट है। ✈️",
            "कभी भी सीखना बंद न करें, क्योंकि जीवन कभी भी सिखाना बंद नहीं करता। 🎓",
            "एक किताब एक सपना है जिसे आप अपने हाथ में पकड़ते हैं। 📖",
            "चुनौतियां ही जीवन को रोचक बनाती हैं। 🧗",
            "अनुशासन लक्ष्यों और उपलब्धि के बीच का पुल है। 🌉",
            "अपने आराम क्षेत्र से बाहर निकलें। आप केवल वहीं बढ़ सकते हैं। 🌱",
            "यह आपके जीवन के वर्ष नहीं हैं जो मायने रखते हैं। यह आपके वर्षों का जीवन है। 🌟",
            "एक सकारात्मक मानसिकता सकारात्मक परिणाम लाती है। 😊",
            "अपने लक्ष्यों को ऊँचा रखें और जब तक आप वहाँ न पहुँच जाएँ तब तक रुकें नहीं। 🎯",
            "हर विशेषज्ञ कभी एक शुरुआत करने वाला था। 👶",
            "अध्ययन दर्दनाक नहीं है। दर्दनाक क्या है अज्ञानता का दर्द। 🧠",
            "सफलता खुशी की कुंजी नहीं है। खुशी सफलता की कुंजी है। 🔑",
            "जो आप जानते हैं उसे तब तक न कहें जब तक आप यह न जान लें कि आप क्या जानते हैं। 🤔",
            "एकमात्र ज्ञान यह जानना है कि आप कुछ नहीं जानते। 🤯",
            "सीखने के लिए एक जुनून पैदा करें। यदि आप ऐसा करते हैं, तो आप कभी भी बढ़ना बंद नहीं करेंगे। 🌳",
            "आपकी गति से कोई फर्क नहीं पड़ता जब तक आप रुकते नहीं हैं। 🐢",
            "आज एक पाठक, कल एक नेता। 👑",
            "शिक्षा सबसे शक्तिशाली हथियार है जिसका उपयोग आप दुनिया को बदलने के लिए कर सकते हैं। 🌍",
            "सीखना एक खजाना है जो अपने मालिक का हर जगह अनुसरण करेगा। 💼",
            "एक निवेश के रूप में अपनी शिक्षा के बारे में सोचें। 💰",
            "सीखना कोई दर्शक खेल नहीं है। 🤸",
            "अपने आप को चुनौती दें; यह विकास का एकमात्र मार्ग है। 🦋",
            "ध्यान केंद्रित रहें और अतिरिक्त मेहनत करें। यह इसके लायक होगा। 💯",
            "संदेह को मार डालो। सफलता को शोर करने दो। 💥",
            "आप जो कुछ भी चाहते हैं वह डर के दूसरी तरफ है। 🚪",
            "प्रक्रिया पर भरोसा करें। आपके प्रयास फल देंगे। 🍎",
            "छोटी प्रगति अभी भी प्रगति है। 🎉",
            "संगति ही कुंजी है। इसे बनाए रखें। 🗝️",
            "आप प्रगति कर रहे हैं, भले ही यह धीमा लगे। 🚶",
            "एक समय में एक अध्याय। आप यह कर सकते हैं। 📑",
            "हर प्रयास मायने रखता है। 💪",
            "आज अध्ययन करें, कल गर्व करें। 🏅",
            "विजेता कभी हार नहीं मानते और हार मानने वाले कभी जीतते नहीं। 🥇"
        ];


        function gatherAllInsights() {
            let insights = [];
            const today = new Date();
            const todayStr = getLocalDateString(today);
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterdayStr = getLocalDateString(yesterdayDate);

            const allChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]);

            // 1. Upcoming Exam
            const upcomingExam = (data.exams || []).filter(exam => exam.examDate && new Date(exam.examDate) >= new Date(todayStr)).sort((a, b) => new Date(a.examDate) - new Date(b.examDate))[0];
            if (upcomingExam) { const daysLeft = Math.ceil((new Date(upcomingExam.examDate) - new Date(todayStr)) / (1000 * 60 * 60 * 24)); insights.push(`🗓️ आपकी अगली परीक्षा "<strong>${upcomingExam.name}</strong>" में केवल <strong>${daysLeft} दिन</strong> बचे हैं। तैयारी करते रहें!`); }

            // 2. Today's Plan
            const todaysPlan = getOrGenerateDailyPlan(todayStr);
            const tasksToStudy = Object.values(todaysPlan.tasks || {}).map(task => getChapterByIds(task.subjectId, task.chapterId, task.sourceType)?.name).filter(Boolean);
            if (tasksToStudy.length > 0) insights.push(`📚 आज की योजना: <strong>${tasksToStudy.join(', ')}</strong> पढ़ें।`);

            // 3. Today's DPT
            const todaysDpts = (data.dailyDptPlan[todayStr] || []).map(({subjectId, chapterId, testId}) => {
                const chapter = getChapterByIds(subjectId, chapterId);
                return `${_(subjectId)} - ${chapter ? chapter.name : ''} DPT #${testId}`;
            });
            if (todaysDpts.length > 0) insights.push(`🎯 आज के DPTs: <strong>${todaysDpts.join(', ')}</strong>। इन्हें पूरा करना न भूलें!`);
            
            // 4. Missed Items
            if ((data.missedChapters || []).length > 0) insights.push(`😥 आपके <strong>${data.missedChapters.length} अध्याय</strong> छूट गए हैं। उन्हें जल्द ही पूरा करने का प्रयास करें।`);
            if ((data.missedOtherTasks || []).length > 0) insights.push(`📋 आपके <strong>${data.missedOtherTasks.length} अन्य कार्य</strong> छूट गए हैं।`);
            if ((data.missedRevisions || []).length > 0) insights.push(`⏰ आपके <strong>${data.missedRevisions.length} रिवीजन</strong> छूट गए हैं। उन्हें आज पूरा करने का प्रयास करें।`);

            // 5. Yesterday's Completed
            const completedYesterday = allChapters.filter(c => c.dateCompleted === yesterdayStr);
            if(completedYesterday.length > 0) insights.push(`👍 कल आपने <strong>${completedYesterday.length} अध्याय</strong> पूरे किए थे। बहुत बढ़िया!`);

            // 6. Performance Analysis
            const completionByDate = allChapters.filter(c => c.dateCompleted).reduce((acc, c) => { acc[c.dateCompleted] = (acc[c.dateCompleted] || 0) + 1; return acc; }, {});
            const bestDayEntry = Object.entries(completionByDate).sort((a,b) => b[1] - a[1])[0];
            if(bestDayEntry) {
                const bestDay = new Date(bestDayEntry[0]).toLocaleDateString('hi-IN', { weekday: 'long' });
                insights.push(`🚀 आपका सबसे अच्छा प्रदर्शन <strong>${bestDay}</strong> को था, जब आपने <strong>${bestDayEntry[1]} अध्याय</strong> पूरे किए थे!`);
            }

            // 7. Streak
            const completedDates = new Set((data.gamification.completedHistory || []));
            let streak = 0;
            if (completedDates.size > 0) {
                let currentDate = new Date();
                while(completedDates.has(getLocalDateString(currentDate))) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                }
            }
            if(streak > 1) insights.push(`🔥 बहुत बढ़िया! आपने लगातार <strong>${streak} दिनों</strong> तक पढ़ाई की है। इसे जारी रखें!`);

            // 8. Overall Progress Milestone
            const totalCompleted = allChapters.filter(c => c.status === 'Completed').length;
            const totalChapters = allChapters.length;
            if (totalChapters > 0) {
                const percentage = Math.round((totalCompleted / totalChapters) * 100);
                if (percentage > 25 && percentage < 30) insights.push(`📈 शानदार! आपने 25% से ज़्यादा सिलेबस पूरा कर लिया है।`);
                if (percentage > 50 && percentage < 55) insights.push(`🎉 बधाई! आप आधा सफ़र तय कर चुके हैं, 50% सिलेबस पूरा हो गया है।`);
                if (percentage > 75 && percentage < 80) insights.push(`🏁 आप मंज़िल के बहुत करीब हैं! 75% सिलेबस पूरा हो चुका है।`);
            }
            
            // 9. DPT Stats
            const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed' && t.details);
            if(allCompletedDpts.length > 5) {
                let totalCorrect = 0, totalAttempted = 0;
                allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; });
                const accuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
                insights.push(`🎯 आपने अब तक <strong>${allCompletedDpts.length} DPTs</strong> पूरे कर लिए हैं, जिसमें आपकी औसत सटीकता <strong>${accuracy}%</strong> है।`);
            }

            // 10. Achievement Unlocked
            const latestActivity = (data.activityLog || [])[0];
            if(latestActivity && latestActivity.icon === 'award') {
                insights.push(`🏆 उपलब्धि अनलॉक! ${latestActivity.description}`);
            }

            // Shuffle insights to provide variety, but keep some important ones at the front
            const priorityInsights = insights.filter(i => i.includes("परीक्षा") || i.includes("छूट गए"));
            const otherInsights = insights.filter(i => !priorityInsights.includes(i));
            const shuffledOthers = otherInsights.sort(() => 0.5 - Math.random());
            
            let finalInsights = [...priorityInsights, ...shuffledOthers];
            
            // Always add creator credit and a random quote
            finalInsights.push(motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]);
            finalInsights.unshift(`यह स्टडी ट्रैकर प्रवेज अहमद द्वारा बनाया गया है। (संस्करण: ${CURRENT_APP_VERSION}) 🧑‍💻`);

            return finalInsights.length > 0 ? finalInsights : [_('ai_insight_start')];
        }


        const renderAIInsights = () => {
            const container = document.getElementById('ai-insights-container');
            container.innerHTML = `<div class="flex items-center gap-3 pb-3 border-b border-accent/20 mb-3"><i data-lucide="sparkles" class="w-6 h-6 text-accent"></i><h2 class="text-lg font-bold text-accent">${_('ai_insights')}</h2></div><div id="ai-insight-content" class="relative min-h-[40px] text-sm"></div>`;
            const insightContent = document.getElementById('ai-insight-content');
            initRotatingDisplay('ai-insight-content', gatherAllInsights(), (item) => `<p>${item}</p>`, _('ai_insight_start'));
        };

        const getSubjectsForDay = (date = new Date()) => {
            const dayIndex = getCycleDayIndex(date);
            if (data.settings.planMode === 'custom_cycle') { return (data.settings.customCyclePlan || [])[dayIndex] || []; }
            return dailyPattern[dayIndex] || [];
        };
        
        const markSubjectAsDoneForToday = (subjectSourcePair) => {
            const todayStr = getLocalDateString();
            const plan = data.dailyPlan[todayStr] = data.dailyPlan[todayStr] || { tasks: {}, completedSubjects: [] };
            if (!plan.completedSubjects.includes(subjectSourcePair)) { plan.completedSubjects.push(subjectSourcePair); }
            saveData();
            renderHomePage(); 
        };

        const postponeChapter = (subjectId, chapterId, sourceType) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            document.querySelector(`li [data-chapter-id="${chapterId}"]`)?.closest('.task-list-item')?.classList.add('completed');
            setTimeout(() => {
                const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = getLocalDateString(tomorrow);
                data.postponedChapters = data.postponedChapters.filter(p => p.chapterId !== chapterId);
                data.postponedChapters.push({ subjectId, chapterId, sourceType, date: tomorrowStr });
                logActivity('skip-forward', `Chapter postponed to tomorrow: "${chapter.name}"`);
                markSubjectAsDoneForToday(`${subjectId}:${sourceType}`);
            }, 500);
        };
        
        const skipChapter = (subjectId, chapterId, sourceType) => {
            const subject = getSubjectById(subjectId); if (!subject) return;
            const availableChapters = (subject.chapters[sourceType] || []).filter(c => c.status !== 'Completed');
            if (availableChapters.length > 1) {
                const currentIndex = availableChapters.findIndex(c => c.id === chapterId);
                const newChapter = availableChapters[(currentIndex + 1) % availableChapters.length];
                const todayStr = getLocalDateString();
                const planKey = `${subjectId}:${sourceType}`;
                if (data.dailyPlan[todayStr]?.tasks?.[planKey]) {
                    data.dailyPlan[todayStr].tasks[planKey].chapterId = newChapter.id;
                    logActivity('chevrons-right', `Skipped to new chapter: "${newChapter.name}"`);
                    saveData(); renderHomePage();
                }
            } else { logActivity('chevrons-right', `Skipped chapter "${getChapterByIds(subjectId, chapterId, sourceType)?.name}", but no other chapters are available.`); }
        };
        
        const getOrGenerateDailyPlan = (dateStr) => {
            if (!data.dailyPlan[dateStr] || !data.dailyPlan[dateStr].planGeneratedForDay) {
                const plan = { tasks: {}, completedSubjects: [], manualTasks: (data.dailyPlan[dateStr]?.manualTasks || []) };
                const chaptersAlreadyUsed = new Set();
                
                (data.postponedChapters || []).filter(p => p.date === dateStr).forEach(p => {
                    const chapter = getChapterByIds(p.subjectId, p.chapterId, p.sourceType);
                    if (chapter?.status !== 'Completed') {
                        const planKey = `${p.subjectId}:${p.sourceType}`;
                        if (!plan.tasks[planKey]) { 
                            plan.tasks[planKey] = { subjectId: p.subjectId, chapterId: p.chapterId, sourceType: p.sourceType }; 
                            chaptersAlreadyUsed.add(p.chapterId); 
                        }
                    }
                });
                data.postponedChapters = (data.postponedChapters || []).filter(p => p.date !== dateStr);
                
                getSubjectsForDay(new Date(dateStr)).forEach(pair => {
                    if (plan.tasks[pair]) return;
                    const [subjectId, sourceType] = pair.split(':');
                    const subject = getSubjectById(subjectId); if (!subject) return;
                    
                    const availableChapters = (subject.chapters[sourceType] || []).filter(c => c.status !== 'Completed' && !chaptersAlreadyUsed.has(c.id));
                    if (availableChapters.length > 0) {
                        // Prioritize chapters with fewer completion cycles if any, otherwise random
                        availableChapters.sort((a, b) => (a.completionCount || 0) - (b.completionCount || 0));
                        const chapter = availableChapters[0]; 
                        plan.tasks[pair] = { subjectId, chapterId: chapter.id, sourceType }; 
                        chaptersAlreadyUsed.add(chapter.id); 
                    }
                });
                data.dailyPlan[dateStr] = plan;
                data.dailyPlan[dateStr].planGeneratedForDay = true;
                saveData();
            }
            return data.dailyPlan[dateStr];
        };

        const renderTodaysPlan = () => {
            const container = document.getElementById('todays-plan-container');
            const todayStr = getLocalDateString();
            const dailyPlanData = getOrGenerateDailyPlan(todayStr);
            const tasks = dailyPlanData.tasks || {};
            const manualTasks = dailyPlanData.manualTasks || [];
            const completedSubjects = dailyPlanData.completedSubjects || [];
            const dayName = new Date().toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-US', { weekday: 'long' });
            
            const otherTasksForToday = (data.otherTasks || [])
                .concat(data.postponedOtherTasks || [])
                .filter(task => task.date === todayStr && task.status === 'Pending');

            const chaptersToStudy = Object.entries(tasks).filter(([key]) => !completedSubjects.includes(key)).map(([, task]) => {
                if (!task) return null;
                const subject = getSubjectById(task.subjectId); const chapter = getChapterByIds(task.subjectId, task.chapterId, task.sourceType);
                return (subject && chapter && chapter.status !== 'Completed') ? { type: 'chapter', subject, chapter, sourceType: task.sourceType } : null;
            }).filter(Boolean);

            const revisionsForToday = [];
            (data.subjects || []).forEach(s => {
                const findRevisions = (chapters, sourceType) => (chapters || []).forEach(c => (c.revisions || []).forEach(r => { if(r.status === 'Pending' && r.date === todayStr) revisionsForToday.push({ type: 'revision', subject: s, chapter: c, revision: r, sourceType }); }));
                findRevisions(s.chapters.notes, 'notes'); findRevisions(s.chapters.book, 'book');
            });
            
            const manualChapterTasks = manualTasks.filter(task => {
                const chapter = getChapterByIds(task.subjectId, task.chapterId, task.sourceType);
                return chapter && chapter.status !== 'Completed';
            }).map(task => ({ ...task, type: 'manual_chapter' }));

            let planHtml = `<div class="flex items-center justify-between pb-3 border-b border-primary/20 mb-4">
                <div class="flex items-center gap-3"><i data-lucide="clipboard-list" class="w-6 h-6 text-primary"></i><h2 class="text-lg font-bold text-primary">${_('todays_plan')} (${dayName})</h2></div>
                <button id="add-task-choice-btn" class="p-1.5 rounded-full hover:bg-sky-200 dark:hover:bg-sky-800"><i data-lucide="plus-circle" class="w-5 h-5 text-primary"></i></button>
            </div>`;
            
            const allTasksForToday = [
                ...chaptersToStudy, 
                ...revisionsForToday,
                ...manualChapterTasks,
                ...otherTasksForToday.map(t => ({...t, type: 'other'}))
            ];

            if (allTasksForToday.length > 0) {
                planHtml += `<ul class="space-y-3">`;
                allTasksForToday.forEach(item => {
                    planHtml += renderTaskItemHTML(item);
                });
                planHtml += `</ul>`;
            } else {
                planHtml += `<div class="text-center py-8 flex flex-col items-center justify-center text-text-muted-light dark:text-text-muted-dark"><i data-lucide="party-popper" class="w-12 h-12 text-accent mx-auto mb-4"></i><h3 class="text-lg font-bold">${_('congratulations')}</h3><p>${_('all_tasks_completed')}</p></div>`;
            }
            container.innerHTML = planHtml;
            lucide.createIcons();
        };
        
        const renderTaskItemHTML = (item) => {
            let html = '';
            const { type } = item;
            
            if (type === 'chapter' || type === 'revision' || type === 'manual_chapter') {
                const isRevision = type === 'revision';
                const isManual = type === 'manual_chapter';
                const subject = isManual ? getSubjectById(item.subjectId) : item.subject;
                const chapter = isManual ? getChapterByIds(item.subjectId, item.chapterId, item.sourceType) : item.chapter;
                const sourceType = item.sourceType;
                const revision = item.revision;
                
                if (!subject || !chapter) return '';

                const uniqueId = isManual ? `manual-${item.id}` : (isRevision ? `revision-${subject.id}-${chapter.id}-${revision.date}` : `task-${subject.id}-${chapter.id}`);
                const sourceBadge = `<span class="source-badge ${sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${_(sourceType === 'book' ? 'source_book' : 'source_notes')}</span>`;
                const bgColor = isManual ? 'bg-indigo-50 dark:bg-indigo-900/40' : (isRevision ? 'bg-amber-50 dark:bg-amber-900/40' : 'bg-card-light dark:bg-card-dark shadow-sm');
                const checkboxClass = isRevision ? 'revision-checkbox text-amber-500' : 'task-checkbox text-primary';
                const labelText = isRevision ? _('revision_task', {chapterName: chapter.name}) : chapter.name;

                let subText = `<p class="text-sm ${isRevision ? 'text-amber-600 dark:text-amber-300' : 'text-sky-600 dark:text-sky-300'} flex items-center gap-1.5">${isRevision ? '<i data-lucide="repeat" class="w-3 h-3"></i> ' : ''}${_(subject.id)} ${sourceBadge}</p>`;
                if(isManual) subText = `<p class="text-sm text-indigo-600 dark:text-indigo-300 flex items-center gap-1.5"><i data-lucide="hand" class="w-3 h-3"></i> ${_(subject.id)} ${sourceBadge}</p>`;
                
                const actionButtons = `
                    <div class="flex gap-1">
                        <button class="task-action-btn postpone-btn p-1.5 rounded hover:bg-yellow-100 dark:hover:bg-yellow-900/50" title="${_('postpone_tomorrow')}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" data-source-type="${sourceType}" ${isRevision ? `data-revision-date="${revision.date}"` : ''} data-task-type="${type}"><i data-lucide="skip-forward" class="w-4 h-4 text-yellow-600"></i></button>
                        ${isManual ? 
                            `<button class="task-action-btn delete-manual-task-btn p-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900/50" title="Delete" data-manual-id="${item.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button>` :
                            `<button class="task-action-btn skip-btn p-1.5 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50" title="${_('skip_chapter')}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" data-source-type="${sourceType}" ${isRevision ? `data-revision-date="${revision.date}"` : ''} data-task-type="${type}"><i data-lucide="chevrons-right" class="w-4 h-4 text-blue-600"></i></button>`
                        }
                    </div>`;

                html = `<li class="task-list-item p-3 rounded-lg flex items-center gap-3 ${bgColor} animate-list-item" data-manual-id="${isManual ? item.id : ''}">
                    <input type="checkbox" id="${uniqueId}" class="${checkboxClass} h-5 w-5 rounded border flex-shrink-0" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" data-source-type="${sourceType}" ${isRevision ? `data-revision-date="${revision.date}"` : ''} ${isManual ? `data-is-manual="true"` : `data-subject-source-pair="${subject.id}:${sourceType}"`} data-task-type="${type}">
                    <label for="${uniqueId}" class="flex-grow cursor-pointer"><p class="font-semibold">${labelText}</p>${subText}</label>
                    ${actionButtons}</li>`;

            } else if (type === 'other') {
                const uniqueId = `other-task-${item.id}`;
                const bgColor = 'bg-gray-100 dark:bg-slate-800';
                const actionButtons = `
                    <div class="flex gap-1">
                        <button class="task-action-btn postpone-btn p-1.5 rounded hover:bg-yellow-100 dark:hover:bg-yellow-900/50" title="${_('postpone_tomorrow')}" data-task-id="${item.id}" data-task-type="${type}"><i data-lucide="skip-forward" class="w-4 h-4 text-yellow-600"></i></button>
                        <button class="task-action-btn delete-other-task-btn p-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900/50" title="Delete" data-task-id="${item.id}" data-task-type="${type}"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button>
                    </div>`;

                html = `<li class="task-list-item p-3 rounded-lg flex items-center gap-3 ${bgColor} animate-list-item">
                    <input type="checkbox" id="${uniqueId}" class="task-checkbox text-gray-500 h-5 w-5 rounded border flex-shrink-0" data-task-id="${item.id}" data-task-type="${type}">
                    <label for="${uniqueId}" class="flex-grow cursor-pointer"><p class="font-semibold">${item.description}</p><p class="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-1.5"><i data-lucide="user-check" class="w-3 h-3"></i> Other Task</p></label>
                    ${actionButtons}</li>`;
            }
            return html;
        };

        const renderTomorrowsPlan = () => {
            const container = document.getElementById('tomorrows-plan-container');
            const tomorrowDate = new Date();
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            const tomorrowStr = getLocalDateString(tomorrowDate);
            
            const chaptersForTomorrow = Object.values(getOrGenerateDailyPlan(tomorrowStr).tasks || {}).map(task => {
                const subject = getSubjectById(task.subjectId); const chapter = getChapterByIds(task.subjectId, task.chapterId, task.sourceType);
                return (subject && chapter) ? { subject, chapter, sourceType: task.sourceType } : null;
            }).filter(Boolean);
            if (chaptersForTomorrow.length === 0) { container.innerHTML = `<p class="text-center text-sm">No topics scheduled for tomorrow.</p>`; return; }
            container.innerHTML = chaptersForTomorrow.map(({ subject, chapter, sourceType }) => {
                const sourceBadge = `<span class="source-badge ${sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${_(sourceType === 'book' ? 'source_book' : 'source_notes')}</span>`;
                return `<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg animate-list-item"><div><p class="font-semibold">${chapter.name}</p><p class="text-xs">${_(subject.id)} ${sourceBadge}</p></div><i data-lucide="arrow-right-circle" class="w-5 h-5 text-primary"></i></div>`
            }).join('');
            lucide.createIcons();
        };

        const renderYesterdaysActivity = () => {
            const container = document.getElementById('yesterdays-completed-container');
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterdayStr = getLocalDateString(yesterdayDate);
            
            const completedYesterdayChapters = [];
            (data.subjects || []).forEach(subject => {
                const findCompleted = (chapters, sourceType) => (chapters || []).forEach(chapter => { if (chapter.dateCompleted === yesterdayStr) completedYesterdayChapters.push({ subject, chapter, sourceType }); });
                findCompleted(subject.chapters.notes, 'notes'); findCompleted(subject.chapters.book, 'book');
            });
            
            const completedYesterdayOther = (data.otherTasks || []).filter(task => task.completedDate === yesterdayStr);

            const allCompleted = [...completedYesterdayChapters, ...completedYesterdayOther];

            if (allCompleted.length === 0) { container.innerHTML = `<p class="text-center text-sm">${_('no_chapters_yesterday')}</p>`; return; }
            container.innerHTML = allCompleted.map((item) => {
                if(item.chapter) { // It's a chapter
                     const sourceBadge = `<span class="source-badge ${item.sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${item.sourceType === 'book' ? 'B' : 'N'}</span>`;
                     return `<div class="flex items-center gap-3 p-3 bg-green-50 dark:bg-green-900/50 rounded-lg animate-list-item"><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i><div><p class="font-semibold">${item.chapter.name} ${sourceBadge}</p><p class="text-xs">${_(item.subject.id)}</p></div></div>`;
                } else { // It's an "other" task
                     return `<div class="flex items-center gap-3 p-3 bg-gray-100 dark:bg-slate-800/50 rounded-lg animate-list-item"><i data-lucide="check-square" class="w-5 h-5 text-gray-500"></i><div><p class="font-semibold">${item.description}</p><p class="text-xs">Other Task</p></div></div>`;
                }
            }).join('');
            lucide.createIcons();
        };

        const renderMissedChapters = () => {
            const container = document.getElementById('missed-chapters-list');
            const twoDaysAgo = new Date(); twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            const twoDaysAgoStr = getLocalDateString(twoDaysAgo);
            const yesterdayDate = new Date(); yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterdayStr = getLocalDateString(yesterdayDate);

            const allMissed = (data.missedChapters || [])
                .filter(item => item.date >= twoDaysAgoStr)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const renderItem = (item) => {
                const subject = getSubjectById(item.subjectId);
                const chapter = getChapterByIds(item.subjectId, item.chapterId, item.sourceType);
                if (!subject || !chapter) return '';
                const sourceBadge = `<span class="source-badge ${item.sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${item.sourceType === 'book' ? 'B' : 'N'}</span>`;
                const missedDateFormatted = new Date(item.date).toLocaleDateString((data.settings.language === 'hi' ? 'hi-IN' : 'en-GB'), { weekday: 'short', day: 'numeric' });
                const isYesterday = item.date === yesterdayStr;
                const completeButton = isYesterday ? `<button class="complete-missed-chapter-btn flex items-center gap-1.5 text-xs font-semibold px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 rounded-md" data-subject-id="${item.subjectId}" data-chapter-id="${item.chapterId}" data-source-type="${item.sourceType}"><i data-lucide="plus" class="w-3 h-3"></i><span>${_('complete_yesterdays_task')}</span></button>` : '';

                return `<div class="p-3 bg-red-50 dark:bg-red-900/50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">${chapter.name} ${sourceBadge}</p>
                            <p class="text-xs">${_(subject.id)} - <span class="font-medium text-red-700 dark:text-red-300">${missedDateFormatted}</span></p>
                        </div>
                        <i data-lucide="alert-circle" class="w-5 h-5 text-danger flex-shrink-0"></i>
                    </div>
                    ${completeButton ? `<div class="mt-2 text-right">${completeButton}</div>` : ''}
                </div>`;
            };
            
            initRotatingDisplay('missed-chapters-list', allMissed, renderItem, _('no_missed_chapters'));
        };

        const renderMissedOtherTasks = () => {
            const card = document.getElementById('missed-other-tasks-card');
            const container = document.getElementById('missed-other-tasks-list');
            const missed = data.missedOtherTasks || [];
            
            if(missed.length === 0) {
                card.classList.add('hidden');
                return;
            }
            card.classList.remove('hidden');

            const renderItem = (item) => {
                const missedDateFormatted = new Date(item.date).toLocaleDateString((data.settings.language === 'hi' ? 'hi-IN' : 'en-GB'), { weekday: 'short', day: 'numeric' });
                return `<div class="p-3 bg-gray-100 dark:bg-slate-800 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">${item.description}</p>
                            <p class="text-xs">Missed on: <span class="font-medium text-gray-700 dark:text-gray-300">${missedDateFormatted}</span></p>
                        </div>
                         <button class="add-missed-other-task-btn flex items-center gap-1.5 text-xs font-semibold px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 rounded-md" data-task-id="${item.id}"><i data-lucide="plus" class="w-3 h-3"></i><span>Add to Today</span></button>
                    </div>
                </div>`;
            };
            
            initRotatingDisplay('missed-other-tasks-list', missed, renderItem, 'No missed tasks.');
        };

        const renderMissedRevisions = () => {
            const container = document.getElementById('missed-revisions-list');
            const missed = data.missedRevisions || [];

            const renderItem = (item) => {
                const subject = getSubjectById(item.subjectId);
                const chapter = getChapterByIds(item.subjectId, item.chapterId, item.sourceType);
                if (!subject || !chapter) return '';
                const sourceBadge = `<span class="source-badge ${item.sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${item.sourceType === 'book' ? 'B' : 'N'}</span>`;
                return `<div class="p-3 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold">${chapter.name} ${sourceBadge}</p>
                            <p class="text-xs">${_(subject.id)} - <span class="font-medium">Revision Missed</span></p>
                        </div>
                    </div>
                    <div class="mt-2 text-right">
                        <button class="complete-missed-revision-btn flex items-center gap-1.5 text-xs font-semibold px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 rounded-md" data-subject-id="${item.subjectId}" data-chapter-id="${item.chapterId}" data-source-type="${item.sourceType}" data-revision-date="${item.revisionDate}"><i data-lucide="plus" class="w-3 h-3"></i><span>Complete Now</span></button>
                    </div>
                </div>`;
            };
            
            initRotatingDisplay('missed-revisions-list', missed, renderItem, 'No missed revisions. Great job!');
        };


        const renderUpcomingRevisions = () => {
            const today = new Date(); today.setHours(0,0,0,0);
            const upcoming = [];
            (data.subjects || []).forEach(s => {
                const findRevisions = (chapters, sourceType) => (chapters || []).forEach(c => (c.revisions || []).forEach(r => { if(r.status === 'Pending' && new Date(r.date) >= today) upcoming.push({ ...r, chapter: c, subject: s, sourceType }); }));
                findRevisions(s.chapters.notes, 'notes'); findRevisions(s.chapters.book, 'book');
            });
            upcoming.sort((a,b) => new Date(a.date) - new Date(b.date));

            const renderItem = (item) => {
                 const diffDays = Math.ceil((new Date(item.date) - today) / 86400000);
                 let dateText = diffDays === 0 ? `<span class="font-bold text-danger">${_('today')}</span>` : (diffDays === 1 ? `<span class="font-semibold text-warning">${_('tomorrow')}</span>` : `${new Date(item.date).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB', { month: 'short', day: 'numeric' })}`);
                 const sourceBadge = `<span class="source-badge ${item.sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${item.sourceType === 'book' ? 'B' : 'N'}</span>`;
                 return `<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><div><p class="font-semibold">${item.chapter.name} ${sourceBadge}</p><p class="text-xs">${_(item.subject.id)}</p></div><div class="text-right text-sm">${dateText}</div></div>`
            };
            
            initRotatingDisplay('revisions-container', upcoming, renderItem, _('no_upcoming_revisions'));
        };
        
        const renderOverallProgress = () => {
            const allChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]);
            const completed = allChapters.filter(c => c.status === 'Completed').length;
            const total = allChapters.length; const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('chapters-completed-count').textContent = `${completed} / ${total}`;
            document.getElementById('overall-progress-text').textContent = `${percentage}%`;
            const chartId = 'overall-progress-chart';
            if (allCharts[chartId]) allCharts[chartId].destroy();
            allCharts[chartId] = new Chart(document.getElementById(chartId), { type: 'doughnut', data: { datasets: [{ data: [percentage, 100 - percentage], backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--primary'), data.settings.theme === 'dark' ? '#374151' : '#e5e7eb'], borderWidth: 0, borderRadius: 5 }] }, options: { responsive: true, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
        };

        const renderSubjectWiseProgressDashboard = () => {
            const container = document.getElementById('subject-progress-dashboard-container');
            const titleEl = document.getElementById('subject-progress-title');
            if (!container || !titleEl) return;
            titleEl.textContent = dashboardProgressView === 'notes' ? _('subject_wise_progress_notes') : _('subject_wise_progress_book');
            let content = '';
            (data.subjects || []).forEach(subject => {
                const chapters = subject.chapters[dashboardProgressView];
                if (chapters && chapters.length > 0) {
                    const completed = chapters.filter(c => c.status === 'Completed').length; const percentage = Math.round((completed / chapters.length) * 100);
                    content += `<div class="animate-list-item">
                                    <div class="flex justify-between items-center mb-1 text-sm">
                                        <span class="font-semibold">${_(subject.id)}</span>
                                        <span class="text-text-muted-light dark:text-text-muted-dark">${percentage}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                        <div class="bg-green-500 h-2.5 rounded-full animated-progress-bar" style="width: ${percentage}%;"></div>
                                    </div>
                               </div>`;
                }
            });
            container.innerHTML = content || `<p class="text-center text-xs py-2">${_('add_chapters_prompt')}</p>`;
        };

        const renderBadges = () => {
            const container = document.getElementById('badges-container');
            const unlockedBadges = new Set(data.gamification.badges || []);
            const allBadgeEntries = Object.entries(BADGES);
            
            const nextBadgeEntry = allBadgeEntries.find(([id]) => !unlockedBadges.has(id));
            
            let progressHtml = '';
            if (nextBadgeEntry) {
                const [nextBadgeId, badgeInfo] = nextBadgeEntry;
                const {current, goal} = getBadgeProgress(nextBadgeId);
                const progress = Math.min(100, (current / goal) * 100);
                
                progressHtml = `<div class="mb-3">
                    <p class="text-sm font-semibold text-center mb-2">Next: ${badgeInfo.name}</p>
                    <div class="flex items-center gap-3">
                        <i data-lucide="${badgeInfo.icon}" class="text-gray-400 dark:text-gray-500 w-6 h-6"></i>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full animated-progress-bar" style="width: ${progress}%; background: linear-gradient(to right, #8b5cf6, #ec4899, #f59e0b);"></div>
                        </div>
                        <span class="text-xs font-bold">${current}/${goal}</span>
                    </div>
                </div>`;
            }

            const allBadgesHtml = allBadgeEntries.map(([badgeId, badge]) => {
                const isUnlocked = unlockedBadges.has(badgeId);
                const iconClass = isUnlocked ? badge.color : 'text-gray-400 dark:text-gray-600 opacity-50';
                return `<div class="flex flex-col items-center text-center p-1" title="${badge.description}"><i data-lucide="${badge.icon}" class="w-8 h-8 ${iconClass} mb-1"></i><span class="text-xs font-medium ${isUnlocked ? '' : 'text-gray-400 dark:text-gray-600'}">${badge.name}</span></div>`;
            }).join('');
            
            if (!progressHtml && unlockedBadges.size === 0) { container.innerHTML = `<p class="text-center text-sm py-4">${_('keep_studying_prompt')}</p>`; return; }
            container.innerHTML = progressHtml + `<div class="grid grid-cols-4 gap-2 mt-2">${allBadgesHtml}</div>`;
            lucide.createIcons();
        };
        
        const renderSubjectsPage = () => {
            const container = document.getElementById('subjects-list-container');
            const filter = document.getElementById('search-input').value.toLowerCase();
            
            document.querySelectorAll('#subject-source-filter .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.source === currentSubjectSourceView));
            document.querySelectorAll('#subject-view-filter .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === subjectPageViewMode));
            
            container.innerHTML = (data.subjects || []).map(subject => {
                 let chapters = [];
                 if (currentSubjectSourceView === 'all') {
                     chapters = [...(subject.chapters.notes || []).map(c => ({...c, effectiveSource: 'notes'})), ...(subject.chapters.book || []).map(c => ({...c, effectiveSource: 'book'}))];
                 } else {
                     chapters = (subject.chapters[currentSubjectSourceView] || []).map(c => ({...c, effectiveSource: currentSubjectSourceView}));
                 }
                 
                 if (subjectPageViewMode === 'completed') {
                     chapters = chapters.filter(c => c.status === 'Completed');
                 }

                 const filteredChapters = chapters.filter(c => c.name.toLowerCase().includes(filter));
                 if (filter && filteredChapters.length === 0 && !_(subject.id).toLowerCase().includes(filter)) return '';
                 
                 const totalChaptersInView = chapters.length;
                 const completedInView = chapters.filter(c => c.status === 'Completed').length;
                 const percentage = totalChaptersInView > 0 ? Math.round((completedInView / totalChaptersInView) * 100) : 0;
                 
                 const renderChapterList = (chaptersToRender) => {
                     if (chaptersToRender.length === 0) {
                         const message = subjectPageViewMode === 'completed' ? 'No completed chapters in this view.' : _('no_chapters_added');
                         return `<p class="text-center text-sm py-2">${message}</p>`;
                     }
                     return `<ul class="space-y-2 mt-4 mb-3">${chaptersToRender.map(c => `<li data-subject-id="${subject.id}" data-chapter-id="${c.id}" data-source-type="${c.effectiveSource}" class="chapter-item flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 hover:shadow-md"><span class="font-medium">${c.name}</span><div class="flex items-center gap-2"><span class="source-badge ${c.effectiveSource === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${c.effectiveSource === 'book' ? 'B' : 'N'}</span><span class="text-xs px-2 py-1 rounded-full ${getStatusClass(c.status)}">${_(c.status.toLowerCase().replace(' ','_'))}</span></div></li>`).join('')}</ul>`;
                 };
                 
                 const restudyButton = (percentage === 100 && subjectPageViewMode === 'all') ? `<button class="restudy-subject-btn p-1.5 rounded-full hover:bg-green-100 dark:hover:bg-green-800/50" data-subject-id="${subject.id}" title="${_('restudy_subject')}"><i data-lucide="refresh-cw" class="w-4 h-4 text-green-500"></i></button>` : '';
                 const completionCycle = subject.completionCount > 0 ? `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${_('completion_cycle', {count: subject.completionCount})}</span>` : '';

                 return `<details class="group bg-card-light dark:bg-card-dark rounded-xl shadow-sm overflow-hidden" open>
                    <summary class="flex items-center justify-between p-4 cursor-pointer">
                        <div>
                            <div class="flex items-center gap-2">
                               <h3 class="font-bold text-lg">${_(subject.id)}</h3>
                               ${completionCycle}
                            </div>
                            <p class="text-sm text-text-muted-light">${_('chapters_done_of', {completed: completedInView, total: totalChaptersInView})}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full animated-progress-bar bg-green-500" style="width: ${percentage}%"></div>
                            </div>
                            ${restudyButton}
                            <button class="delete-subject-btn p-1.5 rounded-full hover:bg-red-100 dark:hover:bg-red-800/50" data-subject-id="${subject.id}" title="${_('delete_subject')}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                            <i data-lucide="chevron-right" class="w-5 h-5 transition-transform group-open:rotate-90"></i>
                        </div>
                    </summary>
                    <div class="p-4 border-t">
                        <div>${renderChapterList(filteredChapters)}
                        ${subjectPageViewMode === 'all' ? `<div class="flex gap-2 mt-2"><button class="add-chapter-btn w-full flex items-center justify-center p-2 text-sm font-semibold text-cyan-600 dark:text-cyan-300 bg-cyan-100 dark:bg-cyan-900/50 rounded-lg hover:bg-cyan-200 dark:hover:bg-cyan-900" data-subject-id="${subject.id}" data-source-type="notes"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add to Notes</button><button class="add-chapter-btn w-full flex items-center justify-center p-2 text-sm font-semibold text-violet-600 dark:text-violet-300 bg-violet-100 dark:bg-violet-900/50 rounded-lg hover:bg-violet-200 dark:hover:bg-violet-900" data-subject-id="${subject.id}" data-source-type="book"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add to Book</button></div>` : ''}
                        </div>
                    </div>
                 </details>`;
            }).join('');
            lucide.createIcons();
        };

        const renderImportExportPage = () => { lucide.createIcons(); };

        const renderCalendarPage = (monthOffset = 0) => {
             const container = document.getElementById('calendar-view');
             const today = new Date();
             const date = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
             const month = date.getMonth(), year = date.getFullYear();
             const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             const locale = data.settings.language === 'hi' ? 'hi-IN' : 'en-US';
             const events = {};
             (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]).forEach(c => { if (c.dateCompleted) { events[c.dateCompleted] = events[c.dateCompleted] || []; events[c.dateCompleted].push({type: 'completed'}); } });
             let html = `<div class="flex items-center justify-between mb-4"><button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button><h3 class="font-bold text-lg">${date.toLocaleString(locale, { month: 'long' })} ${year}</h3><button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold mb-2">${[...Array(7).keys()].map(i => `<div>${new Date(2024,0,i+1).toLocaleString(locale, {weekday: 'short'})}</div>`).join('')}</div><div class="grid grid-cols-7 gap-1">`;
             for(let i=0; i < firstDay; i++) html += `<div></div>`;
             for(let day=1; day <= daysInMonth; day++) {
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = getLocalDateString(today) === fullDate;
                const dotHtml = events[fullDate] ? `<div class="w-1.5 h-1.5 bg-green-500 rounded-full"></div>` : '';
                html += `<div class="h-12 flex flex-col items-center justify-center rounded-lg ${isToday ? 'bg-primary text-white font-bold' : 'bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer'} relative text-sm" data-date="${fullDate}"><span>${day}</span><div class="absolute bottom-1.5 flex gap-1">${dotHtml}</div></div>`;
             }
             html += `</div>`;
             container.innerHTML = html;
             lucide.createIcons();
             container.querySelector('#prev-month')?.addEventListener('click', () => renderCalendarPage(monthOffset - 1));
             container.querySelector('#next-month')?.addEventListener('click', () => renderCalendarPage(monthOffset + 1));
             container.querySelectorAll('[data-date]').forEach(el => { if (el.dataset.date < getLocalDateString(new Date())) { el.addEventListener('click', () => openDateCompletionModal(el.dataset.date)); } });
        };
        
        const renderReportPage = () => {
            const container = document.getElementById('report-content-container');
            const allChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]);
            const total = allChapters.length; const completed = allChapters.filter(c => c.status === 'Completed').length; const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            const generateDptReportHtml = () => {
                const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed' && t.details);
                if (allCompletedDpts.length === 0) { return `<h2 class="text-xl font-bold mb-4 mt-8">${_('dpt_report_title')}</h2><p class="text-center text-sm p-4">${_('no_dpt_data_report')}</p>`; }
                let totalCorrect = 0, totalAttempted = 0, totalTimeTaken = 0, totalQuestions = 0;
                allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; totalTimeTaken += (dpt.details.timeTaken || 0) * 60; totalQuestions += dpt.details.totalQ || 0; });
                const accuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
                const avgTimePerQ = totalAttempted > 0 ? (totalTimeTaken / totalAttempted).toFixed(1) : '0.0';
                
                let subjectBreakdownDptHtml = (data.subjects || []).map(subject => {
                    if (DPT_EXCLUDED_SUBJECTS.includes(subject.id)) return '';
                    const subjectDpts = Object.values(data.dpts[subject.id]?.chapters || {}).flat().filter(t => t.status === 'Completed');
                    if(subjectDpts.length === 0) return '';
                    
                    let chapterDptHtml = Object.keys(data.dpts[subject.id].chapters).map(chapterId => {
                        const chapterDpts = data.dpts[subject.id].chapters[chapterId].filter(t => t.status === 'Completed');
                        if(chapterDpts.length === 0) return '';
                        const chapter = getChapterByIds(subject.id, chapterId);
                        return `<li class="ml-4 text-sm">- ${chapter ? chapter.name : 'Unknown Chapter'}: <strong>${chapterDpts.length} times</strong></li>`;
                    }).join('');

                    return `<div class="mb-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><p class="font-semibold">${_(subject.id)}</p><ul class="list-disc pl-5">${chapterDptHtml}</ul></div>`;
                }).join('');

                return `<h2 class="text-xl font-bold mb-4 mt-8">${_('dpt_report_title')}</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_dpt_completed')}</p><p class="text-2xl font-bold">${allCompletedDpts.length}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('overall_accuracy')}</p><p class="text-2xl font-bold text-accent">${accuracy}%</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('avg_time_per_q')}</p><p class="text-2xl font-bold text-warning">${avgTimePerQ}s</p></div></div><h3 class="text-lg font-bold mb-3 mt-6">${_('dpt_subject_breakdown')}</h3>${subjectBreakdownDptHtml}`;
            };
            
            const generateCompletedOtherTasksHtml = () => {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const thirtyDaysAgoStr = getLocalDateString(thirtyDaysAgo);

                const completedTasks = (data.otherTasks || [])
                    .filter(task => task.status === 'Completed' && task.completedDate && task.completedDate >= thirtyDaysAgoStr)
                    .sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));

                if (completedTasks.length === 0) {
                    return `<h2 class="text-xl font-bold mb-4 mt-8">${_('completed_other_tasks')}</h2><p class="text-center text-sm p-4">${_('no_completed_other_tasks')}</p>`;
                }
                
                let tasksHtml = completedTasks.map(task => {
                    const completedDate = new Date(task.completedDate).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB');
                    return `<div class="flex items-start gap-3 py-2 border-b">
                        <i data-lucide="check-square" class="w-4 h-4 mt-1 text-gray-500"></i>
                        <div>
                            <p class="text-sm">${task.description}</p>
                            <p class="text-xs text-text-muted-light">Completed on: ${completedDate}</p>
                        </div>
                    </div>`;
                }).join('');

                return `<h2 class="text-xl font-bold mb-4 mt-8">${_('completed_other_tasks')}</h2>${tasksHtml}`;
            };

            let subjectBreakdownHtml = (data.subjects || []).map(subject => {
                const allSubChapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])]; if (allSubChapters.length === 0) return '';
                const subCompleted = allSubChapters.filter(c => c.status === 'Completed').length; const subPercentage = allSubChapters.length > 0 ? Math.round((subCompleted / allSubChapters.length) * 100) : 0;
                const completionCycle = subject.completionCount > 0 ? `<span class="text-xs font-semibold ml-2">${_('completion_cycle', {count: subject.completionCount})}</span>` : '';
                return `<div class="mb-4"><div class="flex justify-between items-center mb-1"><span class="font-semibold">${_(subject.id)}${completionCycle}</span><span>${subCompleted}/${allSubChapters.length} (${subPercentage}%)</span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div class="h-2.5 rounded-full animated-progress-bar bg-green-500" style="width: ${subPercentage}%"></div></div></div>`;
            }).join('');
            let activityHtml = (data.activityLog || []).slice(0, 20).map(log => `<div class="flex items-start gap-3 py-2 border-b"><i data-lucide="${log.icon}" class="w-4 h-4 mt-1 text-primary"></i><div><p class="text-sm">${log.description}</p><p class="text-xs text-text-muted-light">${new Date(log.timestamp).toLocaleString()}</p></div></div>`).join('');
            if((data.activityLog || []).length === 0) activityHtml = `<p class="text-center text-sm p-4">${_('no_activity_log_report')}</p>`;
            container.innerHTML = `<div id="report-content" class="p-6 bg-card-light dark:bg-card-dark rounded-xl shadow-sm"><div class="text-center mb-6 border-b pb-4"><h1 class="text-2xl font-bold">${_('study_report')}</h1><p>${data.settings.studentName || 'Student'} - ${new Date().toLocaleDateString()}</p></div><h2 class="text-xl font-bold mb-3">${_('overall_summary')}</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_subjects')}</p><p class="text-2xl font-bold">${(data.subjects || []).length}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_chapters')}</p><p class="text-2xl font-bold">${total}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('chapters_completed')}</p><p class="text-2xl font-bold">${completed}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('progress')}</p><p class="text-2xl font-bold text-primary">${percentage}%</p></div></div><h2 class="text-xl font-bold mb-4 mt-8">${_('subject_breakdown')}</h2>${subjectBreakdownHtml}${generateDptReportHtml()}${generateCompletedOtherTasksHtml()}<h2 class="text-xl font-bold mb-4 mt-8">${_('recent_activity')}</h2>${activityHtml}</div>`;
            lucide.createIcons();
        };

        const renderAnalyticsPage = () => {
            const allChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]);
            const completedChapters = allChapters.filter(c => c.status === 'Completed');
            document.getElementById('metric-total-completed').textContent = completedChapters.length;
            const daysStudying = Math.max(1, (new Date() - new Date(data.appStartDate)) / 86400000);
            document.getElementById('metric-avg-per-day').textContent = (completedChapters.length / daysStudying).toFixed(1);
            const completionByDate = completedChapters.reduce((acc, chap) => { acc[chap.dateCompleted] = (acc[chap.dateCompleted] || 0) + 1; return acc; }, {});
            const bestDayEntry = Object.entries(completionByDate).sort((a,b) => b[1] - a[1])[0];
            document.getElementById('metric-best-day').textContent = bestDayEntry ? `${bestDayEntry[1]}` : '-';
            
            const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed' && t.details);
            let totalCorrect = 0, totalAttempted = 0;
            allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; });
            const dptAccuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
            document.getElementById('metric-total-dpt').textContent = allCompletedDpts.length;
            document.getElementById('metric-dpt-accuracy').textContent = `${dptAccuracy}%`;

            const isDark = data.settings.theme === 'dark';
            const textColor = getComputedStyle(document.body).getPropertyValue('color'); 
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            const chart1Ctx = document.getElementById('chapter-status-chart').getContext('2d');
            const notStarted = allChapters.length - completedChapters.length;
            if(allCharts.status) allCharts.status.destroy();
            allCharts.status = new Chart(chart1Ctx, { type: 'doughnut', data: { labels: [_('completed'), _('not_started')], datasets: [{ data: [completedChapters.length, notStarted], backgroundColor: ['#0ea5e9', '#f59e0b'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } } } } });
            
            const chart2Ctx = document.getElementById('weekly-productivity-chart').getContext('2d');
            const last7Days = [...Array(7)].map((_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return getLocalDateString(d); }).reverse();
            const weeklyData = last7Days.map(day => completionByDate[day] || 0);
            if(allCharts.weekly) allCharts.weekly.destroy();
            allCharts.weekly = new Chart(chart2Ctx, { type: 'bar', data: { labels: last7Days.map(d => new Date(d).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-US', { weekday: 'short' })), datasets: [{ label: _('completed_chapters_chart'), data: weeklyData, backgroundColor: '#8b5cf6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } } } });
            
            const chart3Ctx = document.getElementById('subject-progress-chart').getContext('2d');
            const subjectProgressData = (data.subjects || []).map(s => { const chapters = [...(s.chapters.notes || []), ...(s.chapters.book || [])]; return chapters.length > 0 ? (chapters.filter(c => c.status === 'Completed').length / chapters.length) * 100 : 0; });
            if(allCharts.subject) allCharts.subject.destroy();
            allCharts.subject = new Chart(chart3Ctx, { type: 'bar', data: { labels: data.subjects.map(s => _(s.id)), datasets: [{ label: _('progress')+' (%)', data: subjectProgressData, backgroundColor: '#0ea5e9', borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, ticks: { color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { display: false } } } } });

            const dptChartCtx = document.getElementById('dpt-performance-chart').getContext('2d');
            const dptPerfLabels = []; const dptPerfData = [];
            (data.subjects || []).forEach(subject => {
                if(DPT_EXCLUDED_SUBJECTS.includes(subject.id)) return;
                const subjectDpts = Object.values(data.dpts[subject.id]?.chapters || {}).flat().filter(t => t.status === 'Completed' && t.details);
                if (subjectDpts.length > 0) {
                    let subCorrect = 0, subAttempted = 0;
                    subjectDpts.forEach(d => { subCorrect += d.details.correct || 0; subAttempted += d.details.attempted || 0; });
                    const subAccuracy = subAttempted > 0 ? ((subCorrect / subAttempted) * 100) : 0;
                    dptPerfLabels.push(_(subject.id));
                    dptPerfData.push(subAccuracy.toFixed(1));
                }
            });
            if(allCharts.dptPerf) allCharts.dptPerf.destroy();
            allCharts.dptPerf = new Chart(dptChartCtx, { type: 'bar', data: { labels: dptPerfLabels, datasets: [{ label: 'Accuracy (%)', data: dptPerfData, backgroundColor: '#10b981', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: textColor }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } } } });
            
            // New DPT Chapter Count Chart
            const dptChapterCtx = document.getElementById('dpt-chapter-chart').getContext('2d');
            const chapterDptData = {};
            (data.subjects || []).forEach(subject => {
                if(DPT_EXCLUDED_SUBJECTS.includes(subject.id)) return;
                const completedChapterDpts = Object.entries(data.dpts[subject.id]?.chapters || {}).map(([chapterId, tests]) => ({ chapterId, count: tests.filter(t => t.status === 'Completed').length })).filter(item => item.count > 0);
                if(completedChapterDpts.length > 0) {
                    chapterDptData[subject.id] = completedChapterDpts;
                }
            });

            const chartLabels = [];
            const chartDatasets = (data.subjects || []).filter(s => chapterDptData[s.id]).map((subject, index) => {
                const hue = (index * 60) % 360;
                const color = `hsl(${hue}, 70%, 50%)`;
                const subjectChapterData = chapterDptData[subject.id];
                const data = [];
                subjectChapterData.forEach(item => {
                    const chapter = getChapterByIds(subject.id, item.chapterId);
                    const label = `${_(subject.id)} - ${chapter ? chapter.name : 'Unknown'}`;
                    if(!chartLabels.includes(label)) chartLabels.push(label);
                    data[chartLabels.indexOf(label)] = item.count;
                });
                return { label: _(subject.id), data, backgroundColor: color, borderRadius: 4 };
            });

            if(allCharts.dptChapter) allCharts.dptChapter.destroy();
            allCharts.dptChapter = new Chart(dptChapterCtx, {
                type: 'bar',
                data: { labels: chartLabels, datasets: chartDatasets },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { color: textColor } } },
                    scales: {
                        x: { beginAtZero: true, stacked: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } },
                        y: { stacked: true, ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });
        };

        const renderSettingsPage = () => {
            document.getElementById('student-name-input').value = data.settings.studentName || '';
            document.getElementById('language-select').value = data.settings.language || 'en';
            document.getElementById('background-style-select').value = data.settings.backgroundStyle || 'particles';
            document.getElementById('bg-color-start').value = data.settings.customThemeColors.start || '#cffafe';
            document.getElementById('bg-color-end').value = data.settings.customThemeColors.end || '#e0e7ff';
            
            const colors = data.settings.customThemeColors;
            document.getElementById('color-text-light').value = colors.textLight || '#020617';
            document.getElementById('color-border-light').value = colors.borderLight || '#e5e7eb';
            document.getElementById('color-text-dark').value = colors.textDark || '#f1f5f9';
            document.getElementById('color-border-dark').value = colors.borderDark || '#374151';

            const planMode = data.settings.planMode || 'auto';
            document.querySelector(`input[name="plan-mode"][value="${planMode}"]`).checked = true;
            const customCycleContainer = document.getElementById('custom-cycle-plan-container');
            if (planMode === 'custom_cycle') {
                customCycleContainer.classList.remove('hidden');
                const cycleSelector = document.getElementById('custom-cycle-subject-selector');
                const dayNames = [ _('sunday'), _('monday'), _('tuesday'), _('wednesday'), _('thursday'), _('friday'), _('saturday'), `${_('sunday')} (${_('week')} 2)`, `${_('monday')} (${_('week')} 2)`, `${_('tuesday')} (${_('week')} 2)`, `${_('wednesday')} (${_('week')} 2)`, `${_('thursday')} (${_('week')} 2)`, `${_('friday')} (${_('week')} 2)`, `${_('saturday')} (${_('week')} 2)` ];
                cycleSelector.innerHTML = [...Array(14).keys()].map(i => `<div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><h4 class="font-bold text-center mb-3">${dayNames[i]}</h4><div class="space-y-2">${(data.subjects || []).map(s => `<details class="group bg-card-light dark:bg-card-dark rounded-md border"><summary class="flex items-center justify-between p-2 cursor-pointer list-none"><span class="font-semibold text-sm">${_(s.id)}</span><i data-lucide="chevron-right" class="w-4 h-4 transition-transform group-open:rotate-90"></i></summary><div class="p-2 border-t space-y-2"><label class="flex items-center gap-2 text-sm cursor-pointer p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50"><input type="checkbox" class="custom-cycle-subject-checkbox form-checkbox h-4 w-4 text-primary" data-day="${i}" value="${s.id}:notes" ${((data.settings.customCyclePlan?.[i] || []).includes(`${s.id}:notes`)) ? 'checked' : ''}><span data-translate="source_notes">${_('source_notes')}</span></label><label class="flex items-center gap-2 text-sm cursor-pointer p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50"><input type="checkbox" class="custom-cycle-subject-checkbox form-checkbox h-4 w-4 text-accent" data-day="${i}" value="${s.id}:book" ${((data.settings.customCyclePlan?.[i] || []).includes(`${s.id}:book`)) ? 'checked' : ''}><span data-translate="source_book">${_('source_book')}</span></label></div></details>`).join('')}</div></div>`).join('');
                lucide.createIcons();
            } else { customCycleContainer.classList.add('hidden'); }
            const dptPlanMode = data.settings.dptPlanMode || 'auto';
            document.querySelector(`input[name="dpt-plan-mode"][value="${dptPlanMode}"]`).checked = true;
            const customDptContainer = document.getElementById('custom-dpt-plan-container');
            if (dptPlanMode === 'custom_cycle') {
                customDptContainer.classList.remove('hidden');
                const dptCycleSelector = document.getElementById('dpt-custom-cycle-subject-selector');
                const dayNames = [ _('sunday'), _('monday'), _('tuesday'), _('wednesday'), _('thursday'), _('friday'), _('saturday'), `${_('sunday')} (${_('week')} 2)`, `${_('monday')} (${_('week')} 2)`, `${_('tuesday')} (${_('week')} 2)`, `${_('wednesday')} (${_('week')} 2)`, `${_('thursday')} (${_('week')} 2)`, `${_('friday')} (${_('week')} 2)`, `${_('saturday')} (${_('week')} 2)` ];
                dptCycleSelector.innerHTML = [...Array(14).keys()].map(i => `<div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><h4 class="font-bold text-center mb-3">${dayNames[i]}</h4><div class="space-y-2 max-h-60 overflow-y-auto">${(data.subjects || []).filter(s => !DPT_EXCLUDED_SUBJECTS.includes(s.id)).map(s => `<label class="flex items-center gap-2 text-sm cursor-pointer p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50"><input type="checkbox" class="custom-dpt-subject-checkbox form-checkbox h-4 w-4 text-primary" data-day="${i}" value="${s.id}" ${((data.settings.dptCyclePlan?.[i] || []).includes(s.id)) ? 'checked' : ''}><span>${_(s.id)}</span></label>`).join('')}</div></div>`).join('');
            } else { customDptContainer.classList.add('hidden'); }
        };

        const getStatusClass = (status) => ({ 'Completed': 'bg-green-500/20 text-green-700 dark:text-green-300'}[status] || 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300');
        const showModal = (id) => document.getElementById(id).classList.replace('hidden', 'flex');
        const hideModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');

        const renderExamsPage = () => {
            const container = document.getElementById('exams-list-container');
            const today = getLocalDateString();
            let examsToRender = [...(data.exams || [])];
            let emptyMessage = _('no_exams_added');
            if (currentExamFilter === 'upcoming') { examsToRender = examsToRender.filter(exam => exam.examDate && exam.examDate >= today); emptyMessage = _('no_upcoming_exams_filter'); } 
            else if (currentExamFilter === 'applied') { examsToRender = examsToRender.filter(exam => exam.status === 'Applied'); emptyMessage = _('no_applied_forms_filter'); } 
            else if (currentExamFilter === 'history') { examsToRender = examsToRender.filter(exam => exam.examDate && exam.examDate < today); emptyMessage = _('no_history_exams'); }
            if (examsToRender.length === 0) { container.innerHTML = `<div class="text-center p-8 bg-card-light dark:bg-card-dark rounded-xl"><i data-lucide="file-text" class="w-12 h-12 mx-auto text-text-muted-light mb-4"></i><h3 class="font-bold">${emptyMessage}</h3></div>`; lucide.createIcons(); return; }
            container.innerHTML = examsToRender.sort((a,b) => new Date(b.applicationDate || 0) - new Date(a.applicationDate || 0)).map(exam => {
                const locale = data.settings.language === 'hi' ? 'hi-IN' : 'en-GB';
                const appDate = exam.applicationDate ? new Date(exam.applicationDate).toLocaleDateString(locale) : 'N/A';
                const exDate = exam.examDate ? new Date(exam.examDate).toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                const daysRemaining = exam.examDate ? Math.ceil((new Date(exam.examDate) - new Date()) / 86400000) : null;
                const statusColors = { "Applied": "bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300", "Admit Card Out": "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300", "Exam Done": "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300", "Result Out": "bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300" };
                const receiptLink = exam.receipt ? `<a href="${exam.receipt}" target="_blank" download="receipt" class="flex items-center gap-1 text-xs font-semibold text-primary hover:underline"><i data-lucide="paperclip" class="w-3 h-3"></i> ${_('receipt_attached')}</a>` : '';
                const borderColorClass = exam.examDate && exam.examDate < today ? 'border-gray-400/50' : 'border-primary/50';
                return `<div class="p-4 rounded-lg bg-card-light dark:bg-card-dark shadow-sm border-l-4 ${borderColorClass} animate-list-item"><div class="flex flex-col md:flex-row justify-between items-start gap-3"><div class="flex-grow"><h3 class="font-bold text-lg">${exam.name}</h3><div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs mt-1"><span>${_('applied_on')}: <strong>${appDate}</strong></span><span>${_('exam_date')}: <strong>${exDate}</strong></span>${receiptLink ? `<span>${receiptLink}</span>` : ''}</div><p class="text-sm mt-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-md whitespace-pre-wrap">${exam.notes || 'No notes.'}</p></div><div class="flex flex-col items-start md:items-end gap-2 w-full md:w-auto self-stretch"><div class="flex items-center gap-2"><span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColors[exam.status]}">${_(('status_'+exam.status).toLowerCase().replace(/\s/g, '_'))}</span><div class="flex gap-1"><button class="edit-exam-btn p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200" data-exam-id="${exam.id}"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button class="delete-exam-btn p-2 rounded-lg bg-red-100 dark:bg-red-900/50 hover:bg-red-200" data-exam-id="${exam.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button></div></div>${daysRemaining !== null && daysRemaining >= 0 ? `<div class="text-right mt-auto"><div class="text-2xl font-bold text-primary">${daysRemaining}</div><p class="text-xs -mt-1">${_('days_remaining')}</p></div>` : ''}</div></div></div>`;
            }).join('');
            lucide.createIcons();
        };

        const showAddExamModal = (examId = null) => {
            const form = document.getElementById('add-exam-form'); form.reset();
            document.getElementById('exam-receipt').value = null;
            const receiptViewer = document.getElementById('exam-receipt-viewer'); receiptViewer.innerHTML = '';
            const modalTitle = document.getElementById('exam-modal-title');
            const examIdInput = document.getElementById('exam-id');
            if (examId) {
                const exam = data.exams.find(e => e.id === examId); if (!exam) return;
                modalTitle.textContent = _('edit_exam'); examIdInput.value = exam.id;
                document.getElementById('exam-name').value = exam.name; document.getElementById('application-date').value = exam.applicationDate;
                document.getElementById('exam-date').value = exam.examDate; document.getElementById('exam-status').value = exam.status;
                document.getElementById('exam-notes').value = exam.notes;
                if (exam.receipt) { receiptViewer.innerHTML = `<a href="${exam.receipt}" target="_blank" download="receipt" class="text-primary hover:underline font-semibold">${_('view_receipt')}</a>`; }
            } else { modalTitle.textContent = _('add_new_exam'); examIdInput.value = ''; }
            showModal('add-exam-modal');
        };

        const saveExam = () => {
            const id = document.getElementById('exam-id').value;
            const file = document.getElementById('exam-receipt').files[0];
            const examData = { name: document.getElementById('exam-name').value.trim(), applicationDate: document.getElementById('application-date').value, examDate: document.getElementById('exam-date').value, status: document.getElementById('exam-status').value, notes: document.getElementById('exam-notes').value.trim() };
            if (!examData.name) return;
            const processSave = (receiptDataUrl = null) => {
                if (receiptDataUrl) { examData.receipt = receiptData; }
                if (id) {
                    const index = data.exams.findIndex(e => e.id === id);
                    if (index !== -1) { if (!receiptDataUrl) { examData.receipt = data.exams[index].receipt; } data.exams[index] = { ...data.exams[index], ...examData }; logActivity('edit-3', `Exam updated: "${examData.name}"`); }
                } else { examData.id = `exam-${Date.now()}`; data.exams.push(examData); logActivity('briefcase', `Exam added: "${examData.name}"`); }
                saveData(); renderExamsPage(); renderHomePage(); hideModal('add-exam-modal');
            };
            if (file) { const reader = new FileReader(); reader.onload = (e) => processSave(e.target.result); reader.onerror = (e) => { console.error("File reading error", e); alert("Error reading file."); processSave(null); }; reader.readAsDataURL(file); } 
            else { processSave(null); }
        };

        const deleteExam = (examId) => {
            const exam = data.exams.find(e => e.id === examId);
            if (exam) { showConfirmationModal(_('delete_exam') + '?', `Are you sure you want to delete "${exam.name}"?`, () => { logActivity('trash-2', `Exam deleted: "${exam.name}"`); data.exams = data.exams.filter(e => e.id !== examId); saveData(); renderExamsPage(); renderHomePage(); }); }
        };

        const renderUpcomingExamsOnDashboard = () => {
            const container = document.getElementById('dashboard-exams-container');
            const today = getLocalDateString();
            const upcomingExam = (data.exams || []).filter(exam => exam.examDate && exam.examDate >= today).sort((a,b) => new Date(a.examDate) - new Date(b.date))[0];
            container.innerHTML = `<h2 class="text-lg font-bold text-center mb-2" data-translate="upcoming_exams">${_('upcoming_exams')}</h2>`;

            if (!upcomingExam) { container.innerHTML += `<p class="text-center text-sm py-4">${_('no_upcoming_exams')}</p>`; return; }
            
            const daysRemaining = Math.ceil((new Date(upcomingExam.examDate) - new Date()) / 86400000);
            const examDateFormatted = new Date(upcomingExam.examDate).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
            container.innerHTML += `<div class="text-center p-3 bg-amber-50 dark:bg-amber-900/50 rounded-lg animate-list-item"><p class="text-sm font-semibold">${upcomingExam.name}</p><div class="text-5xl font-bold text-warning">${daysRemaining >= 0 ? daysRemaining : '0'}</div><p class="text-xs -mt-1">${_('days_remaining')}</p><p class="text-xs font-semibold text-amber-600 dark:text-amber-300 mt-1">${examDateFormatted}</p></div>`;
        };

        const showChapterModal = (subjectId, chapterId, sourceType) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            document.getElementById('chapter-modal-title').textContent = chapter.name;
            document.querySelectorAll('#chapter-status-buttons button').forEach(btn => { btn.classList.toggle('active', btn.dataset.status === chapter.status); });
            document.getElementById('chapter-notes-textarea').value = chapter.notes || '';
            document.getElementById('chapter-priority-revision-checkbox').checked = chapter.priorityRevision || false;
            renderScheduledRevisions(chapter);
            const addRevBtn = document.getElementById('add-manual-revision-btn'); addRevBtn.dataset.chapterId = chapterId; addRevBtn.dataset.subjectId = subjectId; addRevBtn.dataset.sourceType = sourceType;
            const saveBtn = document.getElementById('save-chapter-details-btn'); saveBtn.dataset.subjectId = subjectId; saveBtn.dataset.chapterId = chapterId; saveBtn.dataset.sourceType = sourceType;
            const deleteBtn = document.getElementById('delete-chapter-details-btn'); deleteBtn.dataset.subjectId = subjectId; deleteBtn.dataset.chapterId = chapterId; deleteBtn.dataset.sourceType = sourceType;
            showModal('chapter-modal');
        };

        const showAddChapterModal = (subjectId, sourceType) => {
            document.getElementById('add-chapter-form').reset();
            document.getElementById('add-chapter-subject-id').value = subjectId;
            document.getElementById('add-chapter-source-type').value = sourceType;
            showModal('add-chapter-modal');
        };
        
        const showConfirmationModal = (title, message, onConfirm) => {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-action');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => { onConfirm(); hideModal('confirmation-modal'); }, { once: true });
            document.getElementById('confirm-cancel').addEventListener('click', () => hideModal('confirmation-modal'), { once: true });
            showModal('confirmation-modal');
        };

        const addNewChapter = (subjectId, chapterName, sourceType) => {
            chapterName = chapterName.trim(); if (!subjectId || !chapterName || !sourceType) return;
            const subject = getSubjectById(subjectId);
            if (subject) {
                const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterName, status: 'Not Started', dateAdded: getLocalDateString(), notes: '', priorityRevision: false, revisions: [] };
                subject.chapters[sourceType].push(newChapter);
                logActivity('plus-circle', `New chapter added to ${_(subject.id)}: "${chapterName}"`);
                saveData(); renderSubjectsPage(); hideModal('add-chapter-modal');
            }
        };
        
        const updateChapterStatus = (subjectId, chapterId, sourceType, newStatus, isUndo = false, completionDate = null) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            const oldStatus = chapter.status; if (oldStatus === newStatus) return;
            chapter.status = newStatus;
            
            if (newStatus === 'Completed') {
                chapter.dateCompleted = completionDate || getLocalDateString();
                scheduleRevisions(chapter);
                if (!isUndo) {
                    if (!data.gamification.completedHistory.includes(chapter.dateCompleted)) {
                        data.gamification.completedHistory.push(chapter.dateCompleted);
                    }
                    logActivity('check-circle', `Chapter completed: "${chapter.name}"`);
                    checkAllGamification();
                    lastAction = { type: 'complete', data: { subjectId, chapterId, sourceType, oldStatus }, undo: () => updateChapterStatus(subjectId, chapterId, sourceType, oldStatus, true) };
                    showUndoToast(_('chapter_completed_msg'), lastAction.undo);
                    
                    const todayStr = getLocalDateString();
                    const dailyPlanData = data.dailyPlan[todayStr];
                    if (dailyPlanData) {
                        const subjectSourcePair = `${subjectId}:${sourceType}`;
                        if (Object.values(dailyPlanData.tasks).some(task => task.subjectId === subjectId && task.sourceType === sourceType)) {
                            markSubjectAsDoneForToday(subjectSourcePair);
                        }
                    }
                }
            } else { 
                delete chapter.dateCompleted; 
                chapter.revisions = []; 
                if (!isUndo) { logActivity('rotate-ccw', `Chapter status changed: "${chapter.name}" to ${newStatus}`); } 
            }
            saveData(); 
            updateAllUI();
        };

        const updateRevisionStatus = (subjectId, chapterId, sourceType, revisionDate, isComplete) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter || !chapter.revisions) return;
            const revision = chapter.revisions.find(r => r.date === revisionDate);
            if (revision) { revision.status = isComplete ? 'Completed' : 'Pending'; logActivity('repeat', `Revision for "${chapter.name}" marked as ${revision.status}.`); saveData(); renderHomePage(); }
        };

        const saveChapterDetails = (subjectId, chapterId, sourceType) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            const newStatus = document.querySelector('#chapter-status-buttons button.active').dataset.status;
            updateChapterStatus(subjectId, chapterId, sourceType, newStatus);
            chapter.notes = document.getElementById('chapter-notes-textarea').value;
            chapter.priorityRevision = document.getElementById('chapter-priority-revision-checkbox').checked;
            saveData(); renderSubjectsPage(); hideModal('chapter-modal');
        };

        const confirmDeleteChapter = (subjectId, chapterId, sourceType) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            hideModal('chapter-modal');
            showConfirmationModal(_('delete_chapter')+'?', `Are you sure you want to delete "${chapter.name}"? This action cannot be undone.`, () => {
                const subject = getSubjectById(subjectId);
                subject.chapters[sourceType] = subject.chapters[sourceType].filter(c => c.id !== chapterId);
                logActivity('trash-2', `Chapter deleted: "${chapter.name}"`);
                saveData(); renderSubjectsPage();
            });
        };
        
        const scheduleRevisions = (chapter) => {
            const revisionDays = [8, 16, 30];
            chapter.revisions = chapter.revisions.filter(r => r.type === 'manual');
            revisionDays.forEach(days => {
                const revisionDate = new Date(chapter.dateCompleted); revisionDate.setDate(revisionDate.getDate() + days);
                chapter.revisions.push({ date: getLocalDateString(revisionDate), status: 'Pending', type: 'auto' });
            });
        };
        
        const resetApp = () => showConfirmationModal(_('reset_app')+'?', _('reset_all_data'), () => { localStorage.removeItem(DB_KEY); window.location.reload(); });
        
        const exportData = (dataType) => {
            let dataToExport, fileName;
            switch(dataType) {
                case 'full':
                    dataToExport = data;
                    fileName = `study_tracker_backup_${getLocalDateString()}.json`;
                    break;
                case 'exams':
                    dataToExport = data.exams || [];
                    fileName = `study_tracker_exams_${getLocalDateString()}.json`;
                    break;
                case 'urls':
                    dataToExport = data.urls || [];
                    fileName = `study_tracker_urls_${getLocalDateString()}.json`;
                    break;
            }
            if(!dataToExport) return;
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = fileName;
            a.click(); URL.revokeObjectURL(url);
        };
        
        const handleFileUpload = (event, importType) => {
             const file = event.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (e) => {
                 try {
                     const importedData = JSON.parse(e.target.result);
                     switch(importType) {
                        case 'full_backup':
                            importFullBackup(importedData);
                            break;
                        case 'chapters':
                            importAllChapters(importedData, event.target.dataset.sourceType);
                            break;
                        case 'routine':
                            importRoutine(importedData);
                            break;
                        case 'exams':
                            importExams(importedData);
                            break;
                        case 'urls':
                            importUrls(importedData);
                            break;
                     }
                 } catch (error) {
                     alert("Error reading or parsing the JSON file.");
                     console.error("Import Error:", error);
                 } finally {
                     event.target.value = null; // Reset file input
                 }
             };
             reader.readAsText(file);
        };

        const importFullBackup = (importedData) => {
            showConfirmationModal('Import Backup?', 'This will overwrite all current data in the application. This action cannot be undone. Are you sure you want to continue?', () => {
                try {
                    if (importedData.subjects && importedData.settings) {
                        localStorage.setItem(DB_KEY, JSON.stringify(importedData));
                        alert('Backup imported successfully! The application will now reload.');
                        setTimeout(() => window.location.reload(), 500);
                    } else {
                        alert('The selected file does not appear to be a valid backup file.');
                    }
                } catch (error) {
                     alert('An error occurred while importing the backup.');
                     console.error("Full Backup Import Error:", error);
                }
            });
        };

        const importAllChapters = (importedData, sourceType) => {
            if (!sourceType) return;
            let chaptersAdded = 0, subjectsAdded = 0;
            Object.keys(importedData).forEach(subjectName => {
                const subjectId = subjectName.toLowerCase().replace(/\s+/g, '-').replace(/[()]/g, '');
                let subject = data.subjects.find(s => s.id === subjectId);
                if (!subject) { subject = { id: subjectId, name: subjectName, chapters: { notes: [], book: [] } }; data.subjects.push(subject); if (!translations.en[subjectId]) { translations.en[subjectId] = subjectName; translations.hi[subjectId] = subjectName; } subjectsAdded++; }
                const chaptersToImport = importedData[subjectName];
                if (Array.isArray(chaptersToImport)) { chaptersToImport.forEach(chapterData => { if (chapterData.name && !subject.chapters[sourceType].some(c => c.name === chapterData.name)) { const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterData.name.trim(), status: 'Not Started', dateAdded: getLocalDateString(), notes: '', priorityRevision: false, revisions: [] }; subject.chapters[sourceType].push(newChapter); chaptersAdded++; } }); }
            });
            logActivity('upload', `Imported ${chaptersAdded} chapters and ${subjectsAdded} new subjects.`);
            saveData(); alert(`Import successful!\n\nNew Subjects Added: ${subjectsAdded}\nNew Chapters Added: ${chaptersAdded}`);
            applyTranslations(); renderSubjectsPage(); 
        };

        const importRoutine = (importedData) => {
            if (!Array.isArray(importedData) || importedData.length !== 14) {
                alert('Invalid routine file. It must be an array with 14 days of data.');
                return;
            }
            data.settings.customCyclePlan = importedData;
            data.settings.planMode = 'custom_cycle';
            data.dailyPlan = {}; // Reset daily plan to use the new routine
            saveData();
            logActivity('upload', `Imported a new 14-day study routine.`);
            alert('Study routine imported successfully! The plan mode has been set to "Custom Cycle".');
            renderSettingsPage();
            renderHomePage();
        };

        const importExams = (importedData) => {
            if (!Array.isArray(importedData)) {
                alert('Invalid exams file. It must be an array of exam objects.');
                return;
            }
            const isValid = importedData.every(exam => exam.name && exam.id);
            if (!isValid) {
                 alert('Exam data is malformed. Each exam must have at least a "name" and "id".');
                 return;
            }
            data.exams = importedData;
            saveData();
            logActivity('upload', `Imported ${importedData.length} exams.`);
            alert(`${importedData.length} exams imported successfully!`);
            renderExamsPage();
            renderHomePage();
        };

        const importUrls = (importedData) => {
            if (!Array.isArray(importedData)) {
                alert('Invalid URLs file. It must be an array of folder/link objects.');
                return;
            }
            data.urls = importedData;
            saveData();
            logActivity('upload', `Imported ${importedData.length} root folders/links.`);
            alert(`URL data imported successfully!`);
            renderUrlPage();
        };
        
        const BADGES = {
            'first_step': { name: 'पहला कदम', description: 'अपना पहला अध्याय पूरा करें।', icon: 'footprints', color: 'text-green-500', goal: 1, type: 'total_completed' },
            'scholar': { name: 'विद्वान', description: 'कुल 25 अध्याय पूरे करें।', icon: 'book-marked', color: 'text-sky-500', goal: 25, type: 'total_completed' },
            'fifty_milestone': { name: 'अर्धशतक', description: 'कुल 50 अध्याय पूरे करें।', icon: 'gem', color: 'text-rose-500', goal: 50, type: 'total_completed' },
            'prodigy': { name: 'प्रतिभाशाली', description: 'कुल 75 अध्याय पूरे करें।', icon: 'brain-circuit', color: 'text-indigo-500', goal: 75, type: 'total_completed' },
            'centurion': { name: 'शतकवीर', description: 'कुल 100 अध्याय पूरे करें।', icon: 'shield-check', color: 'text-lime-500', goal: 100, type: 'total_completed' },
            'mastermind': { name: 'मास्टरमाइंड', description: 'कुल 150 अध्याय पूरे करें।', icon: 'atom', color: 'text-cyan-500', goal: 150, type: 'total_completed' },
            'marathon_learner': { name: 'मैराथन धावक', description: 'एक ही दिन में 5 अध्याय पूरे करें।', icon: 'zap', color: 'text-yellow-500', goal: 5, type: 'day_record' },
            'consistent_5': { name: 'लगातार 5 दिन', description: 'लगातार 5 दिनों तक अध्ययन करें।', icon: 'calendar-check', color: 'text-blue-500', goal: 5, type: 'streak' },
            'dedicated_scholar': { name: 'समर्पित विद्वान', description: 'लगातार 30 दिनों तक अध्ययन करें।', icon: 'crown', color: 'text-amber-400', goal: 30, type: 'streak' },
            'dpt_starter': { name: 'DPT स्टार्टर', description: 'अपना पहला DPT पूरा करें।', icon: 'file-check-2', color: 'text-teal-500', goal: 1, type: 'total_dpt' },
            'dpt_champion': { name: 'DPT चैंपियन', description: 'कुल 10 DPT पूरे करें।', icon: 'swords', color: 'text-orange-500', goal: 10, type: 'total_dpt' },
            'subject_master': { name: 'विषय मास्टर', description: 'किसी एक विषय के सभी अध्याय पूरे करें।', icon: 'graduation-cap', color: 'text-purple-500', goal: 1, type: 'subject_mastered' },
            'subject_pro': { name: 'विषय प्रो', description: '3 अलग-अलग विषयों के सभी अध्याय पूरे करें।', icon: 'library', color: 'text-fuchsia-500', goal: 3, type: 'subject_mastered' }
        };

        const getBadgeProgress = (badgeId) => {
            const badge = BADGES[badgeId];
            if (!badge) return { current: 0, goal: 1 };
        
            switch(badge.type) {
                case 'total_completed':
                    const allChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]);
                    return { current: allChapters.filter(c => c.status === 'Completed').length, goal: badge.goal };
                case 'streak':
                    const completedDates = new Set((data.gamification.completedHistory || []));
                    let streak = 0;
                    if (completedDates.size > 0) {
                        let currentDate = new Date();
                        while(completedDates.has(getLocalDateString(currentDate))) {
                            streak++;
                            currentDate.setDate(currentDate.getDate() - 1);
                        }
                    }
                    return { current: streak, goal: badge.goal };
                case 'unique_subjects':
                    const completedSubjects = new Set();
                    (data.subjects || []).forEach(s => {
                        if (s.chapters.notes.some(c => c.status === 'Completed') || s.chapters.book.some(c => c.status === 'Completed')) {
                            completedSubjects.add(s.id);
                        }
                    });
                    return { current: completedSubjects.size, goal: badge.goal };
                case 'day_record':
                    const completionByDate = (data.gamification.completedHistory || []).reduce((acc, date) => { acc[date] = (acc[date] || 0) + 1; return acc; }, {});
                    const maxInADay = Object.values(completionByDate).reduce((max, count) => Math.max(max, count), 0);
                    return { current: maxInADay, goal: badge.goal };
                case 'total_dpt':
                    const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed');
                    return { current: allCompletedDpts.length, goal: badge.goal };
                case 'subject_mastered':
                     const masteredSubjects = (data.subjects || []).filter(s => {
                         const allChapters = [...(s.chapters.notes || []), ...(s.chapters.book || [])];
                         return allChapters.length > 0 && allChapters.every(c => c.status === 'Completed');
                     }).length;
                     return { current: masteredSubjects, goal: badge.goal };
                default:
                    return { current: 0, goal: 1 };
            }
        };

        const checkAllGamification = () => {
            Object.keys(BADGES).forEach(badgeId => {
                if (data.gamification.badges.includes(badgeId)) return;
                const { current, goal } = getBadgeProgress(badgeId);
                if (current >= goal) {
                    unlockBadge(badgeId);
                }
            });
        };

        const unlockBadge = (badgeId) => {
            if (!data.gamification.badges.includes(badgeId)) {
                const badgeInfo = BADGES[badgeId];
                if (badgeInfo) {
                    data.gamification.badges.push(badgeId);
                    logActivity('award', `Achievement Unlocked: "${badgeInfo.name}"`);
                    document.getElementById('badge-name').textContent = badgeInfo.name;
                    document.getElementById('badge-description').textContent = badgeInfo.description;
                    document.getElementById('badge-icon').setAttribute('data-lucide', badgeInfo.icon);
                    lucide.createIcons();
                    showModal('badge-modal');
                    renderBadges();
                }
            }
        };

        const getDptSubjectsForDay = (date = new Date()) => {
            const dayIndex = getCycleDayIndex(date);
            if (data.settings.dptPlanMode === 'custom_cycle') { return (data.settings.dptCyclePlan || [])[dayIndex] || []; }
            // For 'auto' mode, derive from study plan subjects
            const studySubjects = getSubjectsForDay(date).map(s => s.split(':')[0]);
            const revisionSubjects = [];
            (data.subjects || []).forEach(s => {
                const findRevisions = (chapters) => (chapters || []).forEach(c => (c.revisions || []).forEach(r => { if(r.status === 'Pending' && r.date === getLocalDateString(date)) revisionSubjects.push(s.id); }));
                findRevisions(s.chapters.notes); findRevisions(s.chapters.book);
            });
            return [...new Set([...studySubjects, ...revisionSubjects])].filter(id => !DPT_EXCLUDED_SUBJECTS.includes(id));
        };

        const getOrGenerateDailyDptPlan = (dateStr) => {
            if (!data.dailyDptPlan[dateStr] || !data.dailyDptPlan[dateStr].planGeneratedForDay) {
                const plan = (data.dailyDptPlan[dateStr] || []).filter(dpt => dpt.isManual); // Keep manual DPTs
                const dptsAlreadyInPlan = new Set(plan.map(p => `${p.subjectId}-${p.chapterId}-${p.testId}`));

                const dailyPlan = getOrGenerateDailyPlan(dateStr);
                const allTodayTasks = [
                    ...Object.values(dailyPlan.tasks),
                    ...(dailyPlan.manualTasks || [])
                ];

                // Add DPTs for today's study tasks and revisions
                allTodayTasks.forEach(task => {
                    if (task && !DPT_EXCLUDED_SUBJECTS.includes(task.subjectId)) {
                        const nextDpt = findNextPendingDptForChapter(task.subjectId, task.chapterId);
                        if (nextDpt && !dptsAlreadyInPlan.has(`${nextDpt.subjectId}-${nextDpt.chapterId}-${nextDpt.testId}`)) {
                            plan.push(nextDpt);
                            dptsAlreadyInPlan.add(`${nextDpt.subjectId}-${nextDpt.chapterId}-${nextDpt.testId}`);
                        }
                    }
                });

                // Add DPTs for revision tasks
                (data.subjects || []).forEach(s => {
                    const findRevisions = (chapters, sourceType) => (chapters || []).forEach(c => (c.revisions || []).forEach(r => {
                        if (r.status === 'Pending' && r.date === dateStr && !DPT_EXCLUDED_SUBJECTS.includes(s.id)) {
                            const nextDpt = findNextPendingDptForChapter(s.id, c.id);
                            if (nextDpt && !dptsAlreadyInPlan.has(`${nextDpt.subjectId}-${nextDpt.chapterId}-${nextDpt.testId}`)) {
                                plan.push(nextDpt);
                                dptsAlreadyInPlan.add(`${nextDpt.subjectId}-${nextDpt.chapterId}-${nextDpt.testId}`);
                            }
                        }
                    }));
                    findRevisions(s.chapters.notes, 'notes');
                    findRevisions(s.chapters.book, 'book');
                });
                
                // Fallback for custom DPT cycle if no tasks are found
                if (plan.length === 0 && data.settings.dptPlanMode === 'custom_cycle') {
                     getDptSubjectsForDay(new Date(dateStr)).forEach(subjectId => {
                        const nextDpt = findNextPendingDptForSubject(subjectId);
                        if (nextDpt && !dptsAlreadyInPlan.has(`${nextDpt.subjectId}-${nextDpt.chapterId}-${nextDpt.testId}`)) {
                            plan.push(nextDpt);
                            dptsAlreadyInPlan.add(`${nextDpt.subjectId}-${nextDpt.chapterId}-${nextDpt.testId}`);
                        }
                    });
                }

                data.dailyDptPlan[dateStr] = plan;
                data.dailyDptPlan[dateStr].planGeneratedForDay = true;
                saveData();
            }
            return data.dailyDptPlan[dateStr];
        };


        const renderTodaysDpt = () => {
            const container = document.getElementById('todays-dpt-container');
            const todayStr = getLocalDateString();
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterdayStr = getLocalDateString(yesterdayDate);
            
            const scheduledTests = getOrGenerateDailyDptPlan(todayStr);

            const yesterdayDptPlan = data.dailyDptPlan[yesterdayStr] || [];
            const missedYesterdayDPTs = yesterdayDptPlan.filter(({ subjectId, chapterId, testId }) => {
                const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId);
                return test && test.status !== 'Completed';
            });
            
            const hasPending = scheduledTests.some(({ subjectId, chapterId, testId }) => { const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId); return test && test.status !== 'Completed'; });
            container.className = `dashboard-card p-4 rounded-xl shadow-sm min-h-[100px] bg-gradient-to-br ${ hasPending ? 'from-amber-100 to-orange-200 dark:from-amber-800 dark:to-orange-900' : 'from-teal-100 to-green-200 dark:from-teal-800 dark:to-green-900' }`;
            
            let html = `<div class="flex items-center justify-between pb-3 border-b mb-3">
                <div class="flex items-center gap-3"><i data-lucide="file-check" class="w-6 h-6"></i><h2 class="text-lg font-bold">${_('todays_dpt')}</h2></div>
                <button id="manual-add-dpt-btn" class="p-1.5 rounded-full hover:bg-orange-200 dark:hover:bg-orange-800"><i data-lucide="plus-circle" class="w-5 h-5 text-orange-700 dark:text-orange-300"></i></button>
            </div>`;

            if (scheduledTests.length === 0 && missedYesterdayDPTs.length === 0) { html += `<div class="text-center py-4"><p>${_('no_dpt_scheduled')}</p></div>`; } 
            else {
                html += '<ul class="space-y-3">';
                scheduledTests.forEach(({ subjectId, chapterId, testId, isManual, id }) => {
                    const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId); if (!test) return;
                    const chapter = getChapterByIds(subjectId, chapterId);
                    const dptTitle = `${_(subjectId)} - ${chapter ? chapter.name : ''} #${test.id}`; // Use test.id for accuracy
                    const deleteButton = isManual ? `<button class="manual-dpt-delete-btn p-1.5" data-manual-id="${id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>` : '';

                    if (test.status === 'Completed') {
                        html += `<li class="flex items-center justify-between gap-2 p-2 rounded-lg bg-green-500/20"><p class="font-bold text-green-800 dark:text-green-200">${dptTitle}</p><button class="view-dpt-details-btn flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg bg-green-500 text-white" data-subject-id="${subjectId}" data-chapter-id="${chapterId}" data-test-id="${test.id}"><i data-lucide="eye" class="w-4 h-4"></i><span>View</span></button></li>`;
                    } else {
                        html += `<li class="flex items-center justify-between gap-2 p-2 rounded-lg bg-white/30 dark:bg-black/20">
                            <p class="font-bold flex items-center gap-2">${isManual ? `<i data-lucide="hand" class="w-4 h-4 text-indigo-500"></i>`: ''}${dptTitle}</p>
                            <div class="flex items-center gap-1">
                                <button class="mark-dpt-complete-btn w-full sm:w-auto flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold text-white bg-amber-500 rounded-lg hover:bg-amber-600 shadow" data-subject-id="${subjectId}" data-chapter-id="${chapterId}" data-test-id="${test.id}"><i data-lucide="check-circle" class="w-4 h-4"></i><span>${_('mark_as_complete')}</span></button>
                                ${deleteButton}
                            </div>
                        </li>`;
                    }
                });
                missedYesterdayDPTs.forEach(({ subjectId, chapterId, testId }) => {
                    const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId); if (!test) return;
                    const chapter = getChapterByIds(subjectId, chapterId);
                     html += `<li class="p-2 rounded-lg bg-red-100 dark:bg-red-900/50 flex flex-col items-start gap-2">
                        <p class="font-semibold text-sm text-red-800 dark:text-red-200">Missed Yesterday: ${_(subjectId)} - ${chapter ? chapter.name : ''} #${test.id}</p>
                        <button class="complete-missed-dpt-btn w-full text-xs font-semibold p-1.5 bg-red-500 text-white rounded-md" data-subject-id="${subjectId}" data-chapter-id="${chapterId}" data-test-id="${testId}">${_('complete_yesterdays_dpt')}</button>
                    </li>`;
                });

                html += '</ul>';
                if(!hasPending && missedYesterdayDPTs.length === 0) { html += `<div class="text-center pt-4 text-green-800 dark:text-green-200 font-semibold"><p>${_('all_dpt_completed')}</p></div>`; }
            }
            container.innerHTML = html;
            lucide.createIcons();
        };

        const renderDptPage = () => {
            document.querySelectorAll('#dpt-view-filter .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === dptPageViewMode));

            const filterDropdown = document.getElementById('dpt-subject-filter');
            const container = document.getElementById('dpt-list-container');
            const globalActionsContainer = document.getElementById('dpt-global-actions-container');
            
            const subjectOptions = `<option value="all_subjects">${_('all_subjects')}</option>` + 
                (data.subjects || []).filter(s => !DPT_EXCLUDED_SUBJECTS.includes(s.id)).map(s => `<option value="${s.id}">${_(s.id)}</option>`).join('');
            
            const currentSelection = filterDropdown.value || 'all_subjects';
            filterDropdown.innerHTML = subjectOptions;
            if (Array.from(filterDropdown.options).some(opt => opt.value === currentSelection)) { filterDropdown.value = currentSelection; } 
            else { filterDropdown.value = 'all_subjects'; }
            const selectedSubjectId = filterDropdown.value;

            let html = '';
            globalActionsContainer.innerHTML = ''; // Clear global actions first

            const subjectsToRender = selectedSubjectId === 'all_subjects'
                ? (data.subjects || []).filter(s => !DPT_EXCLUDED_SUBJECTS.includes(s.id))
                : [(data.subjects || []).find(s => s.id === selectedSubjectId)].filter(Boolean);

            if (subjectsToRender.length === 0) {
                 container.innerHTML = '<p class="text-center p-4">Please select a subject to view and add DPTs.</p>';
                 renderDptSummary();
                 return;
            }
            
            if (selectedSubjectId === 'all_subjects') {
                globalActionsContainer.innerHTML = `<div class="p-4 bg-red-50 dark:bg-red-900/40 rounded-xl shadow-sm mb-4">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                        <h3 class="font-bold text-red-800 dark:text-red-200">Global Actions</h3>
                        <button id="delete-all-dpts-global-btn" class="flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg bg-danger text-white">
                            <i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete All DPTs from All Subjects</span>
                        </button>
                    </div>
                </div>`;
            }

            subjectsToRender.forEach(subject => {
                const chapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])];
                
                const subjectHeader = `
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm mb-4">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                            <h3 class="font-bold text-xl">${_(subject.id)}</h3>
                            <div class="flex items-center gap-2">
                                <button class="add-dpt-to-all-chapters-btn flex items-center justify-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg btn-neon" data-subject-id="${subject.id}">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i><span data-translate="add_dpt_all">${_('add_dpt_all')}</span>
                                </button>
                                <button class="delete-all-dpts-subject-btn flex items-center justify-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg bg-red-100 text-danger dark:bg-red-900/50" data-subject-id="${subject.id}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete All</span>
                                </button>
                            </div>
                        </div>
                    </div>`;

                html += subjectHeader;

                const chaptersHtml = chapters.map(chapter => {
                    const dptDataForChapter = data.dpts[subject.id]?.chapters?.[chapter.id] || [];
                    const completedCount = dptDataForChapter.filter(t => t.status === 'Completed').length;
                    const totalCount = dptDataForChapter.length;
                    const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

                    let testsToDisplay;
                    if (dptPageViewMode === 'all' || (totalCount > 0 && dptDataForChapter.every(test => (dptPageViewMode === 'completed' ? test.status === 'Completed' : test.status !== 'Completed')))) {
                        testsToDisplay = dptDataForChapter.map(test => {
                            const statusClass = test.status === 'Completed' ? 'bg-green-100 dark:bg-green-900/50 border-green-400' : 'bg-gray-100 dark:bg-gray-800/50 border-gray-300 dark:border-gray-600';
                            const dptName = `${chapter.name} - #${test.id}`;
                            return `<button class="dpt-list-item w-full text-left p-3 rounded-lg border-l-4 ${statusClass}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" data-test-id="${test.id}">${dptName}</button>`;
                        }).join('');
                    } else {
                        testsToDisplay = dptDataForChapter.filter(test => {
                            return dptPageViewMode === 'completed' ? test.status === 'Completed' : test.status !== 'Completed';
                        }).map(test => {
                            const statusClass = test.status === 'Completed' ? 'bg-green-100 dark:bg-green-900/50 border-green-400' : 'bg-gray-100 dark:bg-gray-800/50 border-gray-300 dark:border-gray-600';
                            const dptName = `${chapter.name} - #${test.id}`;
                            return `<button class="dpt-list-item w-full text-left p-3 rounded-lg border-l-4 ${statusClass}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" data-test-id="${test.id}">${dptName}</button>`;
                        }).join('');
                    }
                    if(!testsToDisplay) return '';

                    return `<details class="group bg-card-light dark:bg-card-dark rounded-xl shadow-sm overflow-hidden mb-3" open>
                        <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                            <div>
                                <h4 class="font-bold">${chapter.name}</h4>
                                <p class="text-sm text-text-muted-light">${completedCount} / ${totalCount} DPTs completed</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button class="add-dpt-to-chapter-btn flex items-center justify-center gap-1.5 px-2.5 py-1 text-xs font-semibold rounded-lg bg-sky-100 dark:bg-sky-900 text-sky-700 dark:text-sky-200" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}"><i data-lucide="plus" class="w-3 h-3"></i> Add</button>
                                <i data-lucide="chevron-right" class="w-5 h-5 transition-transform group-open:rotate-90"></i>
                            </div>
                        </summary>
                        <div class="px-4 pb-4 border-t">
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 my-3">
                                <div class="h-2 rounded-full animated-progress-bar bg-primary" style="width: ${percentage}%"></div>
                            </div>
                            <div class="space-y-2">${testsToDisplay || `<p class='text-center text-sm p-2'>No ${dptPageViewMode} DPTs for this chapter.</p>`}</div>
                        </div>
                    </details>`;
                }).join('');

                if(chaptersHtml) {
                    html += chaptersHtml;
                } else if(selectedSubjectId !== 'all_subjects'){
                     html += `<p class="text-center p-4">No chapters found for this subject. Add chapters in the Subjects tab first.</p>`;
                }
            });
            

            container.innerHTML = html || '<p class="text-center p-4">No subjects with DPTs found.</p>';
            renderDptSummary();
            lucide.createIcons();
        };

        const findNextPendingDptForChapter = (subjectId, chapterId) => {
            const tests = data.dpts[subjectId]?.chapters?.[chapterId];
            if (tests) {
                const pendingTest = tests.find(t => t.status !== 'Completed');
                if (pendingTest) {
                    return { subjectId, chapterId, testId: pendingTest.id };
                }
            }
            return null;
        };

        const findNextPendingDptForSubject = (subjectId) => {
            const subject = getSubjectById(subjectId);
            if (!subject || !data.dpts[subjectId]) return null;
            
            const allChapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])];
            for (const chapter of allChapters) {
                const nextDpt = findNextPendingDptForChapter(subjectId, chapter.id);
                if (nextDpt) return nextDpt;
            }
            return null;
        };

        const renderDptSummary = () => {
            const container = document.getElementById('dpt-summary-container');
            const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed' && t.details);
            const totalCompleted = allCompletedDpts.length;
            let totalCorrect = 0, totalAttempted = 0, totalTimeTaken = 0, totalQuestions = 0;
            allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; totalTimeTaken += (dpt.details.timeTaken || 0) * 60; totalQuestions += dpt.details.totalQ || 0; });
            const accuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
            const avgTimePerQ = totalAttempted > 0 ? (totalTimeTaken / totalAttempted).toFixed(1) : '0.0';
            container.innerHTML = `<div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="total_dpt_completed">Total DPTs Completed</h3><p class="text-3xl font-bold text-primary">${totalCompleted}</p></div><div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="overall_accuracy">Overall Accuracy</h3><p class="text-3xl font-bold text-accent">${accuracy}%</p></div><div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="avg_time_per_q">Avg. Time / Q (s)</h3><p class="text-3xl font-bold text-warning">${avgTimePerQ}</p></div>`;
        };

        const showDptDetailsModal = (subjectId, chapterId, testId) => {
            const dptChapterData = data.dpts[subjectId]?.chapters?.[chapterId]; if (!dptChapterData) return;
            const test = dptChapterData.find(t => t.id == testId); if (!test) return;
            const chapter = getChapterByIds(subjectId, chapterId);

            const modal = document.getElementById('dpt-details-popup-modal');
            const titleEl = document.getElementById('dpt-modal-title');
            const entryView = document.getElementById('dpt-entry-view');
            const displayView = document.getElementById('dpt-display-view');
            titleEl.textContent = `${_(subjectId)} - ${chapter ? chapter.name : '...'} #${test.id}`;

            if (test.status === 'Completed' && test.details) {
                entryView.classList.add('hidden');
                displayView.classList.remove('hidden');
                const details = test.details;
                document.getElementById('dpt-display-date').textContent = new Date(details.completedDate).toLocaleDateString('hi-IN');
                document.getElementById('dpt-display-total-q').textContent = details.totalQ || 'N/A';
                document.getElementById('dpt-display-attempted').textContent = details.attempted || 'N/A';
                document.getElementById('dpt-display-correct').textContent = details.correct || 'N/A';
                document.getElementById('dpt-display-wrong').textContent = details.wrong || 'N/A';
                const accuracy = details.attempted > 0 ? `${((details.correct / details.attempted) * 100).toFixed(1)}%` : 'N/A';
                document.getElementById('dpt-display-accuracy').textContent = accuracy;
                document.getElementById('dpt-display-time-taken').textContent = details.timeTaken ? `${details.timeTaken} min` : 'N/A';
                const deleteBtn = document.getElementById('delete-dpt-display-btn');
                deleteBtn.dataset.subjectId = subjectId;
                deleteBtn.dataset.chapterId = chapterId;
                deleteBtn.dataset.testId = test.id;
            } else {
                displayView.classList.add('hidden');
                entryView.classList.remove('hidden');
                const form = document.getElementById('dpt-details-form'); form.reset();
                form.querySelector('#dpt-details-subject-id').value = subjectId;
                form.querySelector('#dpt-details-chapter-id').value = chapterId;
                form.querySelector('#dpt-details-test-id').value = test.id;
                const deleteBtn = document.getElementById('delete-dpt-btn');
                deleteBtn.dataset.subjectId = subjectId;
                deleteBtn.dataset.chapterId = chapterId;
                deleteBtn.dataset.testId = test.id;
            }
            showModal('dpt-details-popup-modal');
        };

        const hideDptDetailsModal = () => { hideModal('dpt-details-popup-modal'); };

        const submitDptDetails = (e) => {
            e.preventDefault();
            const form = e.target;
            const subjectId = form.querySelector('#dpt-details-subject-id').value;
            const chapterId = form.querySelector('#dpt-details-chapter-id').value;
            const testId = parseInt(form.querySelector('#dpt-details-test-id').value);
            
            const dptChapterData = data.dpts[subjectId]?.chapters?.[chapterId];
            if (!dptChapterData) return;
            
            const testIndex = dptChapterData.findIndex(t => t.id === testId);
            if(testIndex === -1) return;

            const details = { 
                totalQ: parseInt(form.querySelector('#dpt-total-q').value) || null, 
                totalTime: parseInt(form.querySelector('#dpt-total-time').value) || null, 
                attempted: parseInt(form.querySelector('#dpt-attempted').value) || null, 
                correct: parseInt(form.querySelector('#dpt-correct').value) || null, 
                wrong: parseInt(form.querySelector('#dpt-wrong').value) || null, 
                timeTaken: parseInt(form.querySelector('#dpt-time-taken').value) || null,
                completedDate: new Date().toISOString()
            };
            dptChapterData[testIndex].status = 'Completed';
            dptChapterData[testIndex].details = details;

            const chapter = getChapterByIds(subjectId, chapterId);
            logActivity('check-square', `Completed DPT #${testId} for ${_(subjectId)} - ${chapter ? chapter.name : ''}.`);
            saveData(); 
            checkAllGamification(); // Check for DPT badges
            hideDptDetailsModal(); 
            renderHomePage();
            if(document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
        };

        const applyBackgroundStyle = () => {
            stopAllBackgroundAnimations();
            const style = data.settings.backgroundStyle || 'particles';
            
            if (data.settings.theme === 'dark' && style !== 'default') {
                document.documentElement.classList.add('pitch-black');
            } else {
                document.documentElement.classList.remove('pitch-black');
            }

            if (style === 'default') { document.body.classList.remove('particles-active'); particleCanvas.style.display = 'none'; return; }
            document.body.classList.add('particles-active'); particleCanvas.style.display = 'block';
            const animationInitializers = { particles: initParticleNetwork };
            if (animationInitializers[style]) { animationInitializers[style](); }
        };
        
        const hexToRgba = (hex, alpha = 1) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const stopAllBackgroundAnimations = () => { if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } };
        function initCanvas() { particleCanvas.width = window.innerWidth; particleCanvas.height = window.innerHeight; backgroundElements = []; }
        function initParticleNetwork() { initCanvas(); let numberOfParticles = (particleCanvas.height * particleCanvas.width) / 12000; if (numberOfParticles > 120) numberOfParticles = 120; for (let i = 0; i < numberOfParticles; i++) backgroundElements.push(new Particle()); animateParticleNetwork(); }
        class Particle { 
            constructor() { 
                this.x = Math.random() * particleCanvas.width; this.y = Math.random() * particleCanvas.height; 
                this.size = Math.random() * 2 + 1; this.speedX = Math.random() * 1.5 - 0.75; 
                this.speedY = Math.random() * 1.5 - 0.75; 
                const colorVar = data.settings.theme === 'dark' ? '--accent' : '--primary';
                const color = getComputedStyle(document.documentElement).getPropertyValue(colorVar).trim();
                this.color = hexToRgba(color, data.settings.theme === 'dark' ? 0.7 : 0.5);
            } 
            update() { if (this.x > particleCanvas.width || this.x < 0) this.speedX = -this.speedX; if (this.y > particleCanvas.height || this.y < 0) this.speedY = -this.speedY; this.x += this.speedX; this.y += this.speedY; } 
            draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } 
        }
        function animateParticleNetwork() { ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height); for (let i = 0; i < backgroundElements.length; i++) { backgroundElements[i].update(); backgroundElements[i].draw(); } connectParticles(); animationFrameId = requestAnimationFrame(animateParticleNetwork); }
        function connectParticles() { 
            let opacityValue = 1; const connectDistance = 120; 
            const colorVar = data.settings.theme === 'dark' ? '--accent' : '--primary';
            const colorHex = getComputedStyle(document.documentElement).getPropertyValue(colorVar).trim();
            const lineColor = hexToRgba(colorHex, data.settings.theme === 'dark' ? 0.2 : 0.1);
            
            for (let a = 0; a < backgroundElements.length; a++) { for (let b = a; b < backgroundElements.length; b++) { let distance = Math.hypot(backgroundElements[a].x - backgroundElements[b].x, backgroundElements[a].y - backgroundElements[b].y); if (distance < connectDistance) { opacityValue = 1 - (distance / connectDistance); ctx.strokeStyle = lineColor.replace(/,\s*\d?\.?\d+\)$/, `, ${opacityValue})`);
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(backgroundElements[a].x, backgroundElements[a].y);
                        ctx.lineTo(backgroundElements[b].x, backgroundElements[b].y);
                        ctx.stroke();
                    }
                }
            }
        }
        
        const postponeRevision = (subjectId, chapterId, sourceType, revisionDate) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType);
            const revision = chapter?.revisions.find(r => r.date === revisionDate); if (!revision) return;
            document.querySelector(`li [data-revision-date="${revisionDate}"]`)?.closest('.task-list-item')?.classList.add('completed');
            setTimeout(() => { const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); revision.date = getLocalDateString(tomorrow); logActivity('skip-forward', `Revision for "${chapter.name}" postponed to tomorrow.`); saveData(); renderHomePage(); }, 500);
        };
        
        function openManualAddModal(type) {
            const modal = document.getElementById('manual-add-modal');
            const chapterContent = document.getElementById('manual-add-chapter-content');
            const dptContent = document.getElementById('manual-add-dpt-content');
            const subjectSelect = document.getElementById('manual-add-subject-select');

            modal.dataset.type = type;
            subjectSelect.innerHTML = `<option value="">-- Choose a Subject --</option>` + (data.subjects || []).map(s => `<option value="${s.id}">${_(s.id)}</option>`).join('');
            
           if (type === 'chapter') {
                modal.querySelector('h2').textContent = 'Add Manual Task';
                chapterContent.style.display = 'block';
                dptContent.style.display = 'none';
                document.getElementById('manual-add-date').value = getLocalDateString();
                document.getElementById('manual-add-chapter-name').value = '';
            } else { // type === 'dpt'
                modal.querySelector('h2').textContent = 'Add Manual DPT';
                chapterContent.style.display = 'none';
                dptContent.style.display = 'block';
                populateManualItemList(null, 'dpt');
            }
            showModal('manual-add-modal');
        }

        function populateManualItemList(subjectId, type) {
            if (type === 'dpt') {
                const itemList = document.getElementById('manual-add-item-list');
                if (!subjectId) { itemList.innerHTML = `<p class="text-center text-sm">Please select a subject first.</p>`; return; }
                const nextDpt = findNextPendingDptForSubject(subjectId);
                if (!nextDpt) { itemList.innerHTML = `<p class="text-center text-sm">No upcoming DPTs for this subject.</p>`; return; }
                const chapter = getChapterByIds(subjectId, nextDpt.chapterId);
                itemList.innerHTML = `<label class="flex items-center gap-2 p-2 rounded-md"><input type="radio" name="manual-add-item" value="${nextDpt.chapterId}:${nextDpt.testId}" checked class="form-radio text-primary"><span>${chapter.name} - DPT #${nextDpt.testId} (Next Available)</span></label>`;
            }
        }


        function saveManualTask() {
            const type = document.getElementById('manual-add-modal').dataset.type;
            const subjectId = document.getElementById('manual-add-subject-select').value;
             if (!subjectId) { alert('Please select a subject.'); return; }

            if (type === 'chapter') {
                const chapterName = document.getElementById('manual-add-chapter-name').value.trim();
                const selectedDate = document.getElementById('manual-add-date').value;
                const sourceType = document.querySelector('input[name="manual-add-source"]:checked').value;
                if (!chapterName || !selectedDate || !sourceType) { alert('Please fill all fields: Chapter Name, Date, and Source.'); return; }
                
                const subject = getSubjectById(subjectId);
                if(!subject) return;

                const chapterExists = subject.chapters[sourceType].some(c => c.name.toLowerCase() === chapterName.toLowerCase());
                if(chapterExists) { alert(`A chapter named "${chapterName}" already exists in ${subject.name} (${sourceType}).`); return; }

                const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterName, status: 'Not Started', dateAdded: getLocalDateString(), notes: '', priorityRevision: false, revisions: [] };
                subject.chapters[sourceType].push(newChapter);
                logActivity('plus-circle', `Manually added new chapter to ${_(subject.id)}: "${chapterName}"`);

                const dateStr = selectedDate;
                data.dailyPlan[dateStr] = data.dailyPlan[dateStr] || { tasks: {}, completedSubjects: [], manualTasks: [] };
                data.dailyPlan[dateStr].manualTasks.push({ subjectId, chapterId: newChapter.id, sourceType, id: `manual-${Date.now()}` });
                logActivity('hand', `Manually scheduled task for "${chapterName}" on ${dateStr}.`);

                saveData();
                hideModal('manual-add-modal');
                if (dateStr === getLocalDateString()) { renderHomePage(); }
                if (document.getElementById('page-subjects').classList.contains('active')) { renderSubjectsPage(); }

            } else { // type === 'dpt'
                const selectedRadio = document.querySelector('input[name="manual-add-item"]');
                if (!selectedRadio) { alert('No available DPT to add for this subject.'); return; }
                const [chapterId, testIdStr] = selectedRadio.value.split(':');
                const testId = parseInt(testIdStr);

                const todayStr = getLocalDateString();
                data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr] || [];
                if (!data.dailyDptPlan[todayStr].some(d => d.subjectId === subjectId && d.chapterId === chapterId && d.testId === testId)) {
                    data.dailyDptPlan[todayStr].push({ subjectId, chapterId, testId, isManual: true, id: `manual-dpt-${Date.now()}` });
                    const chapter = getChapterByIds(subjectId, chapterId);
                    logActivity('hand', `Manually added DPT for today: ${_(subjectId)} - ${chapter ? chapter.name : ''} #${testId}`);
                }
                saveData();
                hideModal('manual-add-modal');
                renderHomePage();
            }
        }
        
        function confirmDeleteSubject(subjectId) {
            const subject = getSubjectById(subjectId);
            if (!subject) return;
            showConfirmationModal(_('delete_subject'), _('delete_subject_confirm', { subjectName: _(subject.id) }), () => {
                data.subjects = data.subjects.filter(s => s.id !== subjectId);
                delete data.dpts[subjectId];
                data.missedChapters = (data.missedChapters || []).filter(c => c.subjectId !== subjectId);
                data.postponedChapters = (data.postponedChapters || []).filter(c => c.subjectId !== subjectId);
                Object.keys(data.dailyPlan).forEach(date => {
                    const plan = data.dailyPlan[date];
                    plan.manualTasks = (plan.manualTasks || []).filter(t => t.subjectId !== subjectId);
                    Object.keys(plan.tasks).forEach(key => { if(key.startsWith(subjectId + ':')) delete plan.tasks[key]; });
                });
                Object.keys(data.dailyDptPlan).forEach(date => { data.dailyDptPlan[date] = (data.dailyDptPlan[date] || []).filter(d => d.subjectId !== subjectId); });
                logActivity('trash-2', `Deleted subject: ${_(subject.id)}`);
                saveData(); renderSubjectsPage();
            });
        }
        
        function deleteDpt(subjectId, chapterId, testId) {
            const dptChapterData = data.dpts[subjectId]?.chapters?.[chapterId];
            if (!dptChapterData) return;
            const chapter = getChapterByIds(subjectId, chapterId);
            const dptName = `${_(subjectId)} - ${chapter ? chapter.name : '...'} #${testId}`;

            showConfirmationModal(_('delete_dpt'), _('delete_dpt_confirm', {dptName}), () => {
                const testIndex = dptChapterData.findIndex(t => t.id === testId);
                if (testIndex === -1) return;
                
                dptChapterData.splice(testIndex, 1);
                
                // Re-number subsequent tests for this chapter
                for(let i = testIndex; i < dptChapterData.length; i++) {
                    dptChapterData[i].id--;
                }

                Object.keys(data.dailyDptPlan).forEach(date => {
                    data.dailyDptPlan[date] = data.dailyDptPlan[date].filter(planItem => !(planItem.subjectId === subjectId && planItem.chapterId === chapterId && planItem.testId === testId));
                });
                logActivity('trash-2', `Deleted DPT: ${dptName}`);
                saveData();
                hideDptDetailsModal();
                if (document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
                if (document.getElementById('page-analytics').classList.contains('active')) renderAnalyticsPage();
                renderHomePage();
            });
        }

        // --- NEW URLS FEATURE FUNCTIONS ---

        function renderUrlPage() {
            const container = document.getElementById('url-container');
            if (!data.urls || data.urls.length === 0) {
                container.innerHTML = `<div class="text-center p-8 bg-card-light dark:bg-card-dark rounded-xl"><i data-lucide="folder-x" class="w-12 h-12 mx-auto text-text-muted-light mb-4"></i><h3 class="font-bold">${_('no_folders_created')}</h3></div>`;
                lucide.createIcons();
                return;
            }
            container.innerHTML = renderFolderTree(data.urls);
            lucide.createIcons();
        }

        function renderFolderTree(folders, level = 0) {
            return folders.map(item => {
                const isFolder = item.type === 'folder';
                const marginLeft = `margin-left: ${level * 20}px;`;
                if (isFolder) {
                    const childrenHtml = item.children && item.children.length > 0 ? renderFolderTree(item.children, level + 1) : `<p style="${marginLeft} margin-left: ${ (level + 1) * 20}px;" class="text-sm text-gray-500 py-2">${_('no_links_in_folder')}</p>`;
                    return `
                        <details class="group bg-card-light dark:bg-card-dark rounded-lg shadow-sm overflow-hidden" style="${marginLeft}" open>
                            <summary class="flex items-center justify-between p-3 cursor-pointer list-none">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="folder" class="w-5 h-5 text-amber-500"></i>
                                    <h3 class="font-bold">${item.name}</h3>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button class="add-sub-folder-btn p-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-folder-id="${item.id}" title="${_('add_sub_folder')}"><i data-lucide="folder-plus" class="w-4 h-4 text-blue-500"></i></button>
                                    <button class="add-link-to-folder-btn p-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-folder-id="${item.id}" title="${_('add_new_link')}"><i data-lucide="plus" class="w-4 h-4 text-green-500"></i></button>
                                    <button class="edit-folder-btn p-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-folder-id="${item.id}" title="${_('edit')}"><i data-lucide="folder-edit" class="w-4 h-4"></i></button>
                                    <button class="delete-folder-btn p-1.5 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50" data-folder-id="${item.id}" title="${_('delete')}"><i data-lucide="folder-x" class="w-4 h-4 text-red-500"></i></button>
                                    <i data-lucide="chevron-right" class="w-5 h-5 transition-transform group-open:rotate-90"></i>
                                </div>
                            </summary>
                            <div class="px-3 pb-3 border-t">
                                ${childrenHtml}
                            </div>
                        </details>
                    `;
                } else { // It's a link
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg" style="${marginLeft}">
                            <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="font-medium hover:text-primary flex items-center gap-2">
                                <i data-lucide="link-2" class="w-4 h-4"></i>
                                <span>${item.name}</span>
                            </a>
                            <div class="flex items-center gap-1">
                                <button class="edit-link-btn p-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" data-link-id="${item.id}" title="${_('edit')}"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button class="delete-link-btn p-1.5 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50" data-link-id="${item.id}" title="${_('delete')}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                            </div>
                        </div>
                    `;
                }
            }).join('<div class="my-2"></div>');
        }

        function findItem(items, id) {
            for (const item of items) {
                if (item.id === id) return { item, parent: items };
                if (item.type === 'folder' && item.children) {
                    const found = findItem(item.children, id);
                    if (found) return found.item ? found : { item: found, parent: item.children };
                }
            }
            return null;
        }

        function showAddFolderModal(editFolderId = null, parentId = null) {
            const form = document.getElementById('add-folder-form');
            form.reset();
            const modalTitle = document.getElementById('folder-modal-title');
            document.getElementById('edit-folder-id').value = editFolderId || '';
            document.getElementById('parent-folder-id').value = parentId || '';

            if (editFolderId) {
                const result = findItem(data.urls, editFolderId);
                if (result && result.item) {
                    modalTitle.textContent = `${_('edit')} ${_('folder_name')}`;
                    document.getElementById('new-folder-name').value = result.item.name;
                }
            } else {
                modalTitle.textContent = _('add_new_folder');
            }
            showModal('add-folder-modal');
        }

        function saveFolder(e) {
            e.preventDefault();
            const editId = document.getElementById('edit-folder-id').value;
            const parentId = document.getElementById('parent-folder-id').value;
            const name = document.getElementById('new-folder-name').value.trim();
            if (!name) return;

            if (editId) {
                const result = findItem(data.urls, editId);
                if (result && result.item) {
                    result.item.name = name;
                    logActivity('folder-edit', `Folder renamed to "${name}"`);
                }
            } else {
                const newFolder = { id: `folder-${Date.now()}`, type: 'folder', name, children: [] };
                if (parentId) {
                    const parentResult = findItem(data.urls, parentId);
                    if (parentResult && parentResult.item && parentResult.item.type === 'folder') {
                        parentResult.item.children.push(newFolder);
                    }
                } else {
                    data.urls.push(newFolder);
                }
                logActivity('folder-plus', `New folder created: "${name}"`);
            }
            saveData();
            renderUrlPage();
            hideModal('add-folder-modal');
        }
        
        function deleteItem(itemId) {
            const result = findItem(data.urls, itemId);
            if (!result || !result.item) return;

            const isFolder = result.item.type === 'folder';
            const confirmTitle = isFolder ? `${_('delete')} ${_('folder_name')}?` : `${_('delete')} ${_('link_name')}?`;
            const confirmMessage = isFolder ? _('delete_folder_confirm', {folderName: result.item.name}) : _('delete_link_confirm', {linkName: result.item.name});

            showConfirmationModal(confirmTitle, confirmMessage, () => {
                const index = result.parent.findIndex(i => i.id === itemId);
                if (index > -1) {
                    result.parent.splice(index, 1);
                    logActivity('trash-2', `${isFolder ? 'Folder' : 'Link'} deleted: "${result.item.name}"`);
                    saveData();
                    renderUrlPage();
                }
            });
        }
        
        function showAddLinkModal(folderId, editLinkId = null) {
            const form = document.getElementById('add-link-form');
            form.reset();
            const modalTitle = document.getElementById('link-modal-title');
            document.getElementById('link-folder-id').value = folderId;
            document.getElementById('edit-link-id').value = editLinkId || '';

            if (editLinkId) {
                 const result = findItem(data.urls, editLinkId);
                 if (result && result.item) {
                    modalTitle.textContent = `${_('edit')} ${_('link_name')}`;
                    document.getElementById('new-link-name').value = result.item.name;
                    document.getElementById('new-link-url').value = result.item.url;
                }
            } else {
                modalTitle.textContent = _('add_new_link');
            }
            showModal('add-link-modal');
        }

        function saveLink(e) {
            e.preventDefault();
            const folderId = document.getElementById('link-folder-id').value;
            const editId = document.getElementById('edit-link-id').value;
            const name = document.getElementById('new-link-name').value.trim();
            let url = document.getElementById('new-link-url').value.trim();
            if (!name || !url) return;
            
            if (!/^https?:\/\//i.test(url)) {
                url = 'https://' + url;
            }
            
            if (editId) {
                 const result = findItem(data.urls, editId);
                 if (result && result.item) {
                     result.item.name = name;
                     result.item.url = url;
                     logActivity('edit-3', `Link updated: "${name}"`);
                 }
            } else {
                const parentResult = findItem(data.urls, folderId);
                if (parentResult && parentResult.item && parentResult.item.type === 'folder') {
                    const newLink = { id: `link-${Date.now()}`, type: 'link', name, url };
                    parentResult.item.children.push(newLink);
                    logActivity('link', `New link added to "${parentResult.item.name}": "${name}"`);
                }
            }
            saveData();
            renderUrlPage();
            hideModal('add-link-modal');
        }
        
        // --- END OF NEW URLS FEATURE FUNCTIONS ---

        function addEventListeners() {
            navBtns.forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.page)));
            document.getElementById('mobile-bottom-nav').addEventListener('click', e => {
                const navBtn = e.target.closest('.mobile-nav-btn');
                if (navBtn && navBtn.dataset.page) { navigateTo(navBtn.dataset.page); }
            });
            
            themeToggleBtns.forEach(btn => btn.addEventListener('click', toggleTheme));
            sidebarToggleBtn.addEventListener('click', toggleSidebar);
            document.getElementById('search-input').addEventListener('input', renderSubjectsPage);
            document.getElementById('language-select').addEventListener('change', (e) => { data.settings.language = e.target.value; saveData(); applyTranslations(); });
            document.getElementById('student-name-input')?.addEventListener('input', (e) => { data.settings.studentName = e.target.value; saveData(); renderHomePage(); });
            
            document.getElementById('subjects-list-container').addEventListener('click', e => { 
                const addBtn = e.target.closest('.add-chapter-btn');
                const chapterItem = e.target.closest('.chapter-item');
                const deleteSubjectBtn = e.target.closest('.delete-subject-btn');
                const restudyBtn = e.target.closest('.restudy-subject-btn');
                
                if (addBtn) { showAddChapterModal(addBtn.dataset.subjectId, addBtn.dataset.sourceType); } 
                else if (chapterItem) { showChapterModal(chapterItem.dataset.subjectId, chapterItem.dataset.chapterId, chapterItem.dataset.sourceType); }
                else if (deleteSubjectBtn) { e.preventDefault(); confirmDeleteSubject(deleteSubjectBtn.dataset.subjectId); }
                else if (restudyBtn) { e.preventDefault(); confirmRestudySubject(restudyBtn.dataset.subjectId); }
            });

            document.getElementById('subject-source-filter').addEventListener('click', (e) => {
                const sourceBtn = e.target.closest('.filter-btn');
                if(sourceBtn && sourceBtn.dataset.source) { currentSubjectSourceView = sourceBtn.dataset.source; renderSubjectsPage(); }
            });
            document.getElementById('subject-view-filter').addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.filter-btn');
                if(viewBtn && viewBtn.dataset.view) { subjectPageViewMode = viewBtn.dataset.view; renderSubjectsPage(); }
            });

            document.getElementById('dpt-view-filter').addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.filter-btn');
                if(viewBtn && viewBtn.dataset.view) { dptPageViewMode = viewBtn.dataset.view; renderDptPage(); }
            });

            document.getElementById('todays-plan-container').addEventListener('click', e => {
                const postponeBtn = e.target.closest('.postpone-btn');
                const skipBtn = e.target.closest('.skip-btn');
                const deleteManualBtn = e.target.closest('.delete-manual-task-btn');
                const deleteOtherTaskBtn = e.target.closest('.delete-other-task-btn');

                if (deleteManualBtn) {
                    const todayStr = getLocalDateString();
                    const taskId = deleteManualBtn.dataset.manualId;
                    data.dailyPlan[todayStr].manualTasks = data.dailyPlan[todayStr].manualTasks.filter(t => t.id !== taskId);
                    saveData(); renderHomePage(); return;
                }
                 if (deleteOtherTaskBtn) {
                    const taskId = deleteOtherTaskBtn.dataset.taskId;
                    showConfirmationModal('Delete Task?', 'Are you sure you want to permanently delete this task?', () => {
                        data.otherTasks = data.otherTasks.filter(t => t.id !== taskId);
                        data.postponedOtherTasks = data.postponedOtherTasks.filter(t => t.id !== taskId);
                        saveData(); renderHomePage();
                    });
                    return;
                }
                
                const { taskId, taskType, subjectId, chapterId, sourceType, revisionDate } = postponeBtn?.dataset || skipBtn?.dataset || {};
                
                if (!taskType) return;
                e.preventDefault();

                if (taskType === 'other') {
                    if (postponeBtn) postponeOtherTask(taskId);
                } else if (taskType === 'revision') { 
                    postponeRevision(subjectId, chapterId, sourceType, revisionDate); 
                } else { 
                    if (postponeBtn) { postponeChapter(subjectId, chapterId, sourceType); }
                    if (skipBtn) { skipChapter(subjectId, chapterId, sourceType); }
                }
            });

            document.getElementById('todays-plan-container').addEventListener('change', (e) => { 
                const checkbox = e.target;
                const listItem = checkbox.closest('.task-list-item');
                const taskType = checkbox.dataset.taskType;

                if (checkbox.classList.contains('task-checkbox') || checkbox.classList.contains('revision-checkbox')) {
                    if (checkbox.checked) {
                        listItem?.classList.add('completed');
                        setTimeout(() => {
                           if (taskType === 'revision') {
                                 updateRevisionStatus(checkbox.dataset.subjectId, checkbox.dataset.chapterId, checkbox.dataset.sourceType, checkbox.dataset.revisionDate, true);
                            } else if (taskType === 'other') {
                                updateOtherTaskStatus(checkbox.dataset.taskId, 'Completed');
                            } else { // chapter or manual_chapter
                                updateChapterStatus(checkbox.dataset.subjectId, checkbox.dataset.chapterId, checkbox.dataset.sourceType, 'Completed'); 
                                if (taskType === 'chapter') { markSubjectAsDoneForToday(checkbox.dataset.subjectSourcePair); }
                                else if (taskType === 'manual_chapter') {
                                     const todayStr = getLocalDateString();
                                     const taskId = listItem.dataset.manualId;
                                     data.dailyPlan[todayStr].manualTasks = data.dailyPlan[todayStr].manualTasks.filter(t => t.id !== taskId);
                                     saveData(); renderHomePage();
                                }
                            }
                        }, 500);
                    }
                }
            });

            document.getElementById('missed-chapters-list').addEventListener('click', e => {
                const completeBtn = e.target.closest('.complete-missed-chapter-btn');
                if (completeBtn) {
                    const { subjectId, chapterId, sourceType } = completeBtn.dataset;
                    const todayStr = getLocalDateString();
                    data.dailyPlan[todayStr] = data.dailyPlan[todayStr] || { tasks: {}, completedSubjects: [], manualTasks: [] };
                    data.dailyPlan[todayStr].manualTasks.push({ subjectId, chapterId, sourceType, id: `manual-${Date.now()}` });
                    data.missedChapters = data.missedChapters.filter(c => c.chapterId !== chapterId);
                    logActivity('plus', `Added yesterday's missed chapter to today's plan: ${getChapterByIds(subjectId, chapterId, sourceType)?.name}`);
                    saveData(); renderHomePage();
                }
            });
            
             document.getElementById('missed-other-tasks-list').addEventListener('click', e => {
                const addBtn = e.target.closest('.add-missed-other-task-btn');
                if (addBtn) {
                    const taskId = addBtn.dataset.taskId;
                    const task = data.missedOtherTasks.find(t => t.id === taskId);
                    if (task) {
                        task.date = getLocalDateString(); // Reschedule for today
                        data.postponedOtherTasks.push(task);
                        data.missedOtherTasks = data.missedOtherTasks.filter(t => t.id !== taskId);
                        logActivity('plus', `Added missed task to today's plan: "${task.description}"`);
                        saveData();
                        renderHomePage();
                    }
                }
            });


             document.getElementById('missed-revisions-list').addEventListener('click', e => {
                const completeBtn = e.target.closest('.complete-missed-revision-btn');
                if (completeBtn) {
                    const { subjectId, chapterId, sourceType, revisionDate } = completeBtn.dataset;
                    
                    updateRevisionStatus(subjectId, chapterId, sourceType, revisionDate, true);
                    data.missedRevisions = data.missedRevisions.filter(r => !(r.chapterId === chapterId && r.revisionDate === revisionDate));
                    
                    logActivity('check-circle', `Completed a missed revision.`);
                    saveData();
                    renderHomePage();
                }
            });
            
            document.getElementById('export-routine-json-btn').addEventListener('click', () => exportRoutine('json'));
            document.getElementById('export-routine-pdf-btn').addEventListener('click', () => exportRoutine('pdf'));
            document.getElementById('print-report-btn').addEventListener('click', () => printElement('report-content-container'));
            document.getElementById('print-analysis-btn').addEventListener('click', () => printElement('analytics-content-container'));

            document.getElementById('add-chapter-form').addEventListener('submit', e => { e.preventDefault(); addNewChapter(document.getElementById('add-chapter-subject-id').value, document.getElementById('new-chapter-name').value, document.getElementById('add-chapter-source-type').value); });
            document.getElementById('add-subject-form').addEventListener('submit', createSubject);
            document.getElementById('add-new-subject-btn').addEventListener('click', showAddSubjectModal);
            ['close-add-subject-modal', 'close-add-chapter-modal', 'confirm-cancel', 'close-badge-modal', 'close-badge-modal-x', 'close-date-completion-modal', 'close-manual-add-modal', 'close-update-popup-modal', 'close-add-folder-modal', 'close-add-link-modal', 'close-add-task-choice-modal', 'close-add-other-task-modal', 'close-add-chapter-dpt-modal', 'close-add-all-chapters-dpt-modal'].forEach(id => document.getElementById(id)?.addEventListener('click', () => hideModal(id.replace('close-', '').replace('-x',''))));
            document.getElementById('export-full-data-btn').addEventListener('click', () => exportData('full'));
            document.getElementById('export-exams-btn').addEventListener('click', () => exportData('exams'));
            document.getElementById('export-urls-btn').addEventListener('click', () => exportData('urls'));
            document.getElementById('reset-app-btn').addEventListener('click', resetApp);
            document.getElementById('close-chapter-modal').addEventListener('click', () => hideModal('chapter-modal'));
            document.getElementById('save-chapter-details-btn').addEventListener('click', (e) => { const { subjectId, chapterId, sourceType } = e.currentTarget.dataset; if (subjectId && chapterId) saveChapterDetails(subjectId, chapterId, sourceType); });
            document.getElementById('delete-chapter-details-btn').addEventListener('click', (e) => { const { subjectId, chapterId, sourceType } = e.currentTarget.dataset; if (subjectId && chapterId) confirmDeleteChapter(subjectId, chapterId, sourceType); });
            document.getElementById('chapter-status-buttons').addEventListener('click', (e) => { const clickedBtn = e.target.closest('button'); if (clickedBtn) { document.querySelectorAll('#chapter-status-buttons button').forEach(btn => btn.classList.remove('active')); clickedBtn.classList.add('active'); } });
            
            const importFileInput = document.getElementById('import-file-input');
            document.getElementById('import-full-backup-btn').addEventListener('click', () => { importFileInput.dataset.importType = 'full_backup'; importFileInput.click(); });
            document.getElementById('import-all-notes-btn').addEventListener('click', () => { importFileInput.dataset.importType = 'chapters'; importFileInput.dataset.sourceType = 'notes'; importFileInput.click(); });
            document.getElementById('import-all-books-btn').addEventListener('click', () => { importFileInput.dataset.importType = 'chapters'; importFileInput.dataset.sourceType = 'book'; importFileInput.click(); });
            document.getElementById('import-routine-btn').addEventListener('click', () => { importFileInput.dataset.importType = 'routine'; importFileInput.click(); });
            document.getElementById('import-exams-btn').addEventListener('click', () => { importFileInput.dataset.importType = 'exams'; importFileInput.click(); });
            document.getElementById('import-urls-btn').addEventListener('click', () => { importFileInput.dataset.importType = 'urls'; importFileInput.click(); });
            importFileInput.addEventListener('change', (e) => handleFileUpload(e, e.target.dataset.importType));

            document.getElementById('delete-all-notes-btn').addEventListener('click', () => deleteAllChaptersForSource('notes'));
            document.getElementById('delete-all-books-btn').addEventListener('click', () => deleteAllChaptersForSource('book'));
            
            document.getElementById('bg-color-start').addEventListener('input', (e) => { data.settings.customThemeColors.start = e.target.value; saveData(); applyCustomTheme(); });
            document.getElementById('bg-color-end').addEventListener('input', (e) => { data.settings.customThemeColors.end = e.target.value; saveData(); applyCustomTheme(); });
            document.getElementById('reset-theme-btn').addEventListener('click', () => { data.settings.customThemeColors.start = null; data.settings.customThemeColors.end = null; saveData(); applyCustomTheme(); renderSettingsPage(); });
            
            document.querySelectorAll('.adv-color-picker').forEach(picker => {
                picker.addEventListener('input', (e) => {
                    const colorType = e.target.dataset.colorType;
                    data.settings.customThemeColors[colorType] = e.target.value;
                    saveData();
                    applyManualColors();
                });
            });
            document.getElementById('reset-advanced-colors-btn').addEventListener('click', () => {
                data.settings.customThemeColors.textLight = null;
                data.settings.customThemeColors.borderLight = null;
                data.settings.customThemeColors.textDark = null;
                data.settings.customThemeColors.borderDark = null;
                saveData();
                applyManualColors();
                renderSettingsPage();
            });

            document.getElementById('background-style-select').addEventListener('change', (e) => { data.settings.backgroundStyle = e.target.value; saveData(); applyBackgroundStyle(); });
            document.getElementById('page-settings').addEventListener('change', e => {
                if (e.target.name === 'plan-mode') { data.settings.planMode = e.target.value; delete data.dailyPlan[getLocalDateString()]; saveData(); renderSettingsPage(); renderHomePage(); }
                if (e.target.name === 'dpt-plan-mode') { data.settings.dptPlanMode = e.target.value; data.dailyDptPlan = {}; saveData(); renderSettingsPage(); renderHomePage(); }
            });
            document.getElementById('save-custom-cycle-plan')?.addEventListener('click', () => {
                data.settings.customCyclePlan = [...Array(14)].map(() => []);
                document.querySelectorAll('.custom-cycle-subject-checkbox:checked').forEach(cb => { data.settings.customCyclePlan[cb.dataset.day].push(cb.value); });
                data.dailyPlan = {}; saveData(); alert('Custom study plan saved!'); renderHomePage();
            });
            document.getElementById('save-dpt-custom-cycle-plan')?.addEventListener('click', () => {
                data.settings.dptCyclePlan = [...Array(14)].map(() => []);
                document.querySelectorAll('.custom-dpt-subject-checkbox:checked').forEach(cb => { data.settings.dptCyclePlan[cb.dataset.day].push(cb.value); });
                data.dailyDptPlan = {}; saveData(); alert('Custom DPT plan saved!'); renderHomePage();
            });
            document.getElementById('add-exam-btn').addEventListener('click', () => showAddExamModal());
            document.getElementById('close-add-exam-modal').addEventListener('click', () => hideModal('add-exam-modal'));
            document.getElementById('add-exam-form').addEventListener('submit', e => { e.preventDefault(); saveExam(); });
            document.getElementById('exams-list-container').addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-exam-btn'); const deleteBtn = e.target.closest('.delete-exam-btn');
                if (editBtn) showAddExamModal(editBtn.dataset.examId); if (deleteBtn) deleteExam(deleteBtn.dataset.examId);
            });
            document.getElementById('exam-filter-buttons').addEventListener('click', e => {
                const filterBtn = e.target.closest('.exam-filter-btn');
                if (filterBtn) {
                    currentExamFilter = filterBtn.dataset.filter;
                    document.querySelectorAll('.exam-filter-btn').forEach(btn => { btn.classList.remove('active', 'bg-primary', 'text-white'); btn.classList.add('bg-gray-200', 'dark:bg-gray-700'); });
                    filterBtn.classList.add('active', 'bg-primary', 'text-white'); filterBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    renderExamsPage();
                }
            });
            document.getElementById('date-completion-subject-select').addEventListener('change', (e) => {
                const subjectId = e.target.value; const chapterList = document.getElementById('date-completion-chapter-list');
               if (!subjectId) { chapterList.innerHTML = `<p class="text-center text-sm">Please select a subject first.</p>`; return; }
                const subject = getSubjectById(subjectId);
                const uncompletedChapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])].filter(c => c.status === 'Not Started');
                if(uncompletedChapters.length === 0) { chapterList.innerHTML = `<p class="text-center text-sm">No uncompleted chapters.</p>`; return; }
                chapterList.innerHTML = uncompletedChapters.map(c => { const sourceType = (subject.chapters.notes || []).includes(c) ? 'notes' : 'book'; return `<label class="flex items-center gap-2 p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md cursor-pointer"><input type="radio" name="date-completion-chapter" value="${c.id}" data-source-type="${sourceType}" data-subject-id="${subjectId}" class="form-radio text-primary"><span>${c.name} (${sourceType === 'notes' ? 'N' : 'B'})</span></label>` }).join('');
            });
            document.getElementById('save-date-completion-btn').addEventListener('click', () => {
                const selectedRadio = document.querySelector('input[name="date-completion-chapter"]:checked');
                if (!selectedRadio) { alert('Please select a chapter to mark as complete.'); return; }
                const { subjectId, sourceType } = selectedRadio.dataset; const chapterId = selectedRadio.value;
                const completionDate = document.getElementById('date-completion-modal').dataset.date;
                updateChapterStatus(subjectId, chapterId, sourceType, 'Completed', false, completionDate);
                hideModal('date-completion-modal');
            });
            const progressDropdown = document.getElementById('progress-view-dropdown');
            document.getElementById('toggle-progress-view-btn').addEventListener('click', () => progressDropdown.classList.toggle('hidden'));
            progressDropdown.addEventListener('click', (e) => { e.preventDefault(); const link = e.target.closest('a'); if (link?.dataset.view) { dashboardProgressView = link.dataset.view; renderSubjectWiseProgressDashboard(); progressDropdown.classList.add('hidden'); } });
            document.addEventListener('click', (e) => { if (!e.target.closest('#toggle-progress-view-btn') && !e.target.closest('#progress-view-dropdown')) progressDropdown.classList.add('hidden'); });
            
            // DPT Page Listeners
            document.getElementById('dpt-subject-filter').addEventListener('change', renderDptPage);
            document.getElementById('page-dpt').addEventListener('click', (e) => {
                const dptItem = e.target.closest('.dpt-list-item'); 
                const addBtn = e.target.closest('.add-dpt-to-chapter-btn');
                const addAllBtn = e.target.closest('.add-dpt-to-all-chapters-btn');
                const deleteAllSubjectBtn = e.target.closest('.delete-all-dpts-subject-btn');
                const deleteAllGlobalBtn = e.target.closest('#delete-all-dpts-global-btn');

                if (dptItem) { showDptDetailsModal(dptItem.dataset.subjectId, dptItem.dataset.chapterId, dptItem.dataset.testId); }
                if (addBtn) { showAddChapterDptModal(addBtn.dataset.subjectId, addBtn.dataset.chapterId); }
                if (addAllBtn) { showAddAllChaptersDptModal(addAllBtn.dataset.subjectId); }
                if (deleteAllSubjectBtn) { confirmDeleteAllDptsForSubject(deleteAllSubjectBtn.dataset.subjectId); }
                if (deleteAllGlobalBtn) { confirmDeleteAllDptsGlobally(); }
            });

            document.getElementById('todays-dpt-container').addEventListener('click', (e) => {
                const completeBtn = e.target.closest('.mark-dpt-complete-btn');
                const viewBtn = e.target.closest('.view-dpt-details-btn');
                const completeMissedBtn = e.target.closest('.complete-missed-dpt-btn');
                if (completeBtn) { showDptDetailsModal(completeBtn.dataset.subjectId, completeBtn.dataset.chapterId, completeBtn.dataset.testId); }
                if (viewBtn) { showDptDetailsModal(viewBtn.dataset.subjectId, viewBtn.dataset.chapterId, viewBtn.dataset.testId); }
                if (completeMissedBtn) {
                    const { subjectId, chapterId, testId } = completeMissedBtn.dataset;
                    const todayStr = getLocalDateString();
                    data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr] || [];
                    if (!data.dailyDptPlan[todayStr].some(d => d.subjectId === subjectId && d.chapterId === chapterId && d.testId === parseInt(testId))) {
                        data.dailyDptPlan[todayStr].push({ subjectId, chapterId, testId: parseInt(testId), isManual: true, id: `manual-dpt-${Date.now()}` });
                        logActivity('plus', `Added yesterday's missed DPT to today's plan.`);
                        saveData();
                        renderHomePage();
                    }
                }
                const deleteManualBtn = e.target.closest('.manual-dpt-delete-btn');
                if (deleteManualBtn) {
                    const todayStr = getLocalDateString();
                    const taskId = deleteManualBtn.dataset.manualId;
                    data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr].filter(t => t.id !== taskId);
                    saveData(); renderHomePage();
                }
            });

            document.getElementById('dpt-details-form').addEventListener('submit', submitDptDetails);
            document.getElementById('delete-dpt-btn').addEventListener('click', (e) => { deleteDpt(e.currentTarget.dataset.subjectId, e.currentTarget.dataset.chapterId, parseInt(e.currentTarget.dataset.testId)); });
            document.getElementById('delete-dpt-display-btn').addEventListener('click', (e) => { deleteDpt(e.currentTarget.dataset.subjectId, e.currentTarget.dataset.chapterId, parseInt(e.currentTarget.dataset.testId)); });
            document.getElementById('close-dpt-display-btn').addEventListener('click', hideDptDetailsModal);
            document.getElementById('close-dpt-details-popup-modal').addEventListener('click', hideDptDetailsModal);
            document.getElementById('add-chapter-dpt-form').addEventListener('submit', handleAddDptToChapter);
            document.getElementById('add-all-chapters-dpt-form').addEventListener('submit', handleAddDptToAllChapters);


            document.getElementById('add-manual-revision-btn').addEventListener('click', e => { const { subjectId, chapterId, sourceType } = e.currentTarget.dataset; const date = document.getElementById('manual-revision-date').value; addManualRevision(subjectId, chapterId, sourceType, date); });
            document.getElementById('chapter-modal').addEventListener('click', e => { const deleteBtn = e.target.closest('.delete-revision-btn'); if (deleteBtn) { const { subjectId, chapterId, sourceType, revisionDate } = deleteBtn.dataset; deleteRevision(subjectId, chapterId, sourceType, revisionDate); } });
            
            document.getElementById('todays-plan-container').addEventListener('click', e => { if (e.target.closest('#add-task-choice-btn')) showModal('add-task-choice-modal'); });
            document.getElementById('choice-manual-chapter-btn').addEventListener('click', () => { hideModal('add-task-choice-modal'); openManualAddModal('chapter'); });
            document.getElementById('choice-other-task-btn').addEventListener('click', () => { hideModal('add-task-choice-modal'); showAddOtherTaskModal(); });
            document.getElementById('add-other-task-form').addEventListener('submit', saveOtherTask);

            document.getElementById('todays-dpt-container').addEventListener('click', e => { if (e.target.closest('#manual-add-dpt-btn')) openManualAddModal('dpt'); });
            document.getElementById('manual-add-subject-select').addEventListener('change', (e) => {
                const modal = document.getElementById('manual-add-modal');
                if(modal.dataset.type === 'dpt') { populateManualItemList(e.target.value, 'dpt'); }
            });
            document.getElementById('save-manual-add-btn').addEventListener('click', saveManualTask);
            
            // --- URLS FEATURE EVENT LISTENERS ---
            document.getElementById('add-new-root-folder-btn').addEventListener('click', () => showAddFolderModal(null, null));
            document.getElementById('add-folder-form').addEventListener('submit', saveFolder);
            document.getElementById('add-link-form').addEventListener('submit', saveLink);
            
            document.getElementById('url-container').addEventListener('click', e => {
                const addSubFolderBtn = e.target.closest('.add-sub-folder-btn');
                const addLinkBtn = e.target.closest('.add-link-to-folder-btn');
                const editFolderBtn = e.target.closest('.edit-folder-btn');
                const deleteFolderBtn = e.target.closest('.delete-folder-btn');
                const editLinkBtn = e.target.closest('.edit-link-btn');
                const deleteLinkBtn = e.target.closest('.delete-link-btn');

                if (addSubFolderBtn) showAddFolderModal(null, addSubFolderBtn.dataset.folderId);
                else if (addLinkBtn) showAddLinkModal(addLinkBtn.dataset.folderId);
                else if (editFolderBtn) showAddFolderModal(editFolderBtn.dataset.folderId, null);
                else if (deleteFolderBtn) deleteItem(deleteFolderBtn.dataset.folderId);
                else if (editLinkBtn) showAddLinkModal(e.target.closest('[data-folder-id]')?.dataset.folderId, editLinkBtn.dataset.linkId);
                else if (deleteLinkBtn) deleteItem(deleteLinkBtn.dataset.linkId);
            });


            window.addEventListener('resize', () => { if (data.settings.backgroundStyle !== 'default') { stopAllBackgroundAnimations(); applyBackgroundStyle(); } });
        }
        
        function openDateCompletionModal(dateStr) {
            const modal = document.getElementById('date-completion-modal'); modal.dataset.date = dateStr;
            document.getElementById('date-completion-modal-title').textContent = `Mark Completion for ${new Date(dateStr).toLocaleDateString()}`;
            const subjectSelect = document.getElementById('date-completion-subject-select');
            subjectSelect.innerHTML = `<option value="">-- Choose a Subject --</option>` + (data.subjects || []).map(s => `<option value="${s.id}">${_(s.id)}</option>`).join('');
            document.getElementById('date-completion-chapter-list').innerHTML = `<p class="text-center text-sm">Please select a subject first.</p>`;
            showModal('date-completion-modal');
        }
        
        function showAddSubjectModal() { document.getElementById('add-subject-form').reset(); showModal('add-subject-modal'); }
        
        function createSubject(e) {
            e.preventDefault();
            const subjectName = document.getElementById('new-subject-name').value.trim();
            const selectedSource = document.querySelector('input[name="subject-source"]:checked').value;
            if (subjectName) {
                const subjectId = subjectName.toLowerCase().replace(/\s+/g, '-');
                if ((data.subjects || []).some(s => s.id === subjectId)) { alert(_('subject_exists')); return; }
                const newSubject = { id: subjectId, name: subjectName, chapters: { notes: [], book: [] }, completionCount: 0 };
                data.subjects.push(newSubject);
                if (!translations.en[subjectId]) { translations.en[subjectId] = subjectName; translations.hi[subjectId] = subjectName; }
                logActivity('plus-circle', `New subject added: "${subjectName}"`);
                saveData(); renderSubjectsPage();
                if(document.getElementById('page-settings').classList.contains('active')) renderSettingsPage();
                if(document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
                hideModal('add-subject-modal');
                showAddChapterModal(subjectId, selectedSource);
            }
        }

        function deleteAllChaptersForSource(sourceType) {
            showConfirmationModal( _('delete_all') + '?', _('delete_all_chapters_confirm'), () => {
                    (data.subjects || []).forEach(subject => { if (subject.chapters[sourceType]) { subject.chapters[sourceType] = []; } });
                    logActivity('trash-2', `Deleted all chapters from source: ${sourceType}`);
                    saveData(); alert(`All ${sourceType} chapters have been deleted.`);
                   if (document.getElementById('page-subjects').classList.contains('active')) { renderSubjectsPage(); }
                }
            );
        }

        function renderScheduledRevisions(chapter) {
            const container = document.getElementById('scheduled-revisions-list');
            if (!chapter.revisions || chapter.revisions.length === 0) { container.innerHTML = '<p class="text-xs text-center text-gray-400">No revisions scheduled.</p>'; return; }
            container.innerHTML = chapter.revisions.sort((a,b) => new Date(a.date) - new Date(b.date)).map(rev => {
                const isManual = rev.type === 'manual'; const isPast = new Date(rev.date) < new Date(getLocalDateString());
                return `<div class="flex items-center justify-between p-2 text-sm rounded-md ${rev.status === 'Completed' ? 'bg-green-100 dark:bg-green-900/40' : 'bg-gray-100 dark:bg-gray-800'}">
                    <span class="font-semibold ${isPast && rev.status !== 'Completed' ? 'text-red-500' : ''}">${new Date(rev.date).toLocaleDateString()}</span>
                    <div><span class="text-xs font-bold px-1.5 py-0.5 rounded ${isManual ? 'bg-violet-200 text-violet-800' : 'bg-blue-200 text-blue-800'}">${isManual ? 'Manual' : 'Auto'}</span>
                    ${isManual ? `<button class="delete-revision-btn p-1 ml-1 text-red-500 hover:bg-red-100 rounded-full" data-revision-date="${rev.date}" data-subject-id="${document.getElementById('add-manual-revision-btn').dataset.subjectId}" data-chapter-id="${chapter.id}" data-source-type="${document.getElementById('add-manual-revision-btn').dataset.sourceType}"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}</div></div>`;
            }).join('');
            lucide.createIcons();
        }

        function addManualRevision(subjectId, chapterId, sourceType, date) {
            if (!date) { alert('Please select a date for the revision.'); return; }
            const chapter = getChapterByIds(subjectId, chapterId, sourceType);
            if (chapter) {
                chapter.revisions.push({ date, status: 'Pending', type: 'manual' });
                logActivity('calendar-plus', `Manual revision scheduled for "${chapter.name}" on ${date}`);
                saveData(); renderScheduledRevisions(chapter);
                document.getElementById('manual-revision-date').value = '';
            }
        }

        function deleteRevision(subjectId, chapterId, sourceType, revisionDate) {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType);
            if (chapter) {
                const initialLength = chapter.revisions.length;
                chapter.revisions = chapter.revisions.filter(r => r.date !== revisionDate);
                if (chapter.revisions.length < initialLength) {
                    logActivity('calendar-minus', `Revision for "${chapter.name}" on ${revisionDate} deleted.`);
                    saveData(); renderScheduledRevisions(chapter);
                }
            }
        }

        function exportRoutine(format) {
            const plan = data.settings.planMode === 'custom_cycle' ? data.settings.customCyclePlan : dailyPattern;
            const dayNames = [ _('sunday'), _('monday'), _('tuesday'), _('wednesday'), _('thursday'), _('friday'), _('saturday')];
            const routineData = {};
            plan.forEach((subjects, index) => {
                const week = index < 7 ? 1 : 2;
                const dayName = `${dayNames[index % 7]} (${_('week')} ${week})`;
                routineData[dayName] = subjects.map(s => {
                    const [id, type] = s.split(':');
                    return `${_(id)} (${_(type === 'book' ? 'source_book' : 'source_notes')})`;
                });
            });

            if (format === 'json') {
                const dataStr = JSON.stringify(plan, null, 2); // Exporting the raw plan for import
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `study_routine_${getLocalDateString()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                pdf.setFont('helvetica', 'bold');
                pdf.text("14-Day Study Routine", 105, 15, null, null, 'center');
                pdf.setFont('helvetica', 'normal');
                let y = 30;
                Object.entries(routineData).forEach(([day, subjects]) => {
                    if (y > 280) {
                        pdf.addPage();
                        y = 15;
                    }
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(day, 14, y);
                    y += 7;
                    pdf.setFont('helvetica', 'normal');
                    if(subjects.length > 0) {
                        subjects.forEach(subject => {
                            pdf.text(`- ${subject}`, 20, y);
                            y += 6;
                        });
                    } else {
                        pdf.text("- Rest Day -", 20, y);
                        y+=6;
                    }
                    y += 4;
                });
                pdf.save(`study_routine_${getLocalDateString()}.pdf`);
            }
        }

        function confirmDeleteAllDptsForSubject(subjectId) {
            const subject = getSubjectById(subjectId);
            if (!subject) return;
            showConfirmationModal(
                _('delete_all_dpts'),
                _('delete_all_dpts_confirm', { subjectName: _(subject.id) }),
                () => {
                    if (data.dpts[subjectId]) {
                        delete data.dpts[subjectId];
                        logActivity('trash-2', `Deleted all DPTs for ${_(subject.id)}`);
                        saveData();
                        renderDptPage();
                        renderHomePage();
                    }
                }
            );
        }
        
        function confirmDeleteAllDptsGlobally() {
            showConfirmationModal(
                'Delete All DPTs?',
                'Are you sure you want to delete ALL DPTs for ALL subjects? This action is permanent and cannot be undone.',
                () => {
                    data.dpts = {};
                    data.dailyDptPlan = {};
                    logActivity('trash-2', 'Deleted all DPTs for all subjects.');
                    saveData();
                    renderDptPage();
                    renderHomePage();
                }
            );
        }

        function confirmRestudySubject(subjectId) {
            const subject = getSubjectById(subjectId);
            if (!subject) return;
            showConfirmationModal(
                _('restudy_subject'),
                _('restudy_subject_confirm', { subjectName: _(subject.id) }),
                () => {
                    subject.completionCount = (subject.completionCount || 0) + 1;
                    const resetChapters = (chapters) => {
                        (chapters || []).forEach(c => {
                            c.status = 'Not Started';
                            delete c.dateCompleted;
                            c.revisions = [];
                        });
                    };
                    resetChapters(subject.chapters.notes);
                    resetChapters(subject.chapters.book);
                    logActivity('refresh-cw', `Started re-study cycle #${subject.completionCount + 1} for ${_(subject.id)}`);
                    saveData();
                    renderSubjectsPage();
                    renderHomePage();
                }
            );
        }

        function printElement(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            const page = element.closest('.page');
            
            document.body.classList.add('is-printing');
            if(page) page.classList.add('printable');

            setTimeout(() => {
                window.print();
                document.body.classList.remove('is-printing');
                if(page) page.classList.remove('printable');
            }, 100);
        }

        // --- NEW "OTHER TASK" FUNCTIONS ---

        function showAddOtherTaskModal() {
            const form = document.getElementById('add-other-task-form');
            form.reset();
            document.getElementById('other-task-date').value = getLocalDateString();
            showModal('add-other-task-modal');
        }

        function saveOtherTask(e) {
            e.preventDefault();
            const description = document.getElementById('other-task-description').value.trim();
            const date = document.getElementById('other-task-date').value;
            const notes = document.getElementById('other-task-notes').value.trim();

            if (!description || !date) {
                alert('Please provide a task description and a date.');
                return;
            }

            const newTask = {
                id: `other-${Date.now()}`,
                description,
                date,
                notes,
                status: 'Pending',
                completedDate: null
            };

            data.otherTasks.push(newTask);
            logActivity('clipboard-list', `New other task added: "${description}"`);
            saveData();
            hideModal('add-other-task-modal');
            renderHomePage();
        }

        function updateOtherTaskStatus(taskId, newStatus) {
            const task = (data.otherTasks || []).find(t => t.id === taskId) || (data.postponedOtherTasks || []).find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                if (newStatus === 'Completed') {
                    task.completedDate = getLocalDateString();
                    logActivity('check-square', `Other task completed: "${task.description}"`);
                } else {
                    task.completedDate = null;
                }
                saveData();
                renderHomePage();
            }
        }

        function postponeOtherTask(taskId) {
            const task = (data.otherTasks || []).find(t => t.id === taskId) || (data.postponedOtherTasks || []).find(t => t.id === taskId);
            if (task) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                task.date = getLocalDateString(tomorrow);
                
                // Move from main list to postponed list if not already there
                if(!data.postponedOtherTasks.some(t => t.id === taskId)) {
                    data.postponedOtherTasks.push(task);
                    data.otherTasks = data.otherTasks.filter(t => t.id !== taskId);
                }

                logActivity('skip-forward', `Other task postponed: "${task.description}"`);
                saveData();
                renderHomePage();
            }
        }

        function showAddChapterDptModal(subjectId, chapterId) {
            const modal = document.getElementById('add-chapter-dpt-modal');
            const form = document.getElementById('add-chapter-dpt-form');
            form.reset();
            document.getElementById('dpt-add-subject-id').value = subjectId;
            
            const chapterSelect = document.getElementById('dpt-add-chapter-select');
            const subject = getSubjectById(subjectId);
            const chapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])];
            chapterSelect.innerHTML = chapters.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if (chapterId) {
                chapterSelect.value = chapterId; // Pre-select the chapter
            }
            
            showModal('add-chapter-dpt-modal');
        }
        
        function showAddAllChaptersDptModal(subjectId) {
            const modal = document.getElementById('add-all-chapters-dpt-modal');
            const form = document.getElementById('add-all-chapters-dpt-form');
            form.reset();
            document.getElementById('dpt-add-all-subject-id').value = subjectId;
            document.getElementById('add-all-dpt-modal-title').textContent = `Add DPTs to all chapters in ${_(subjectId)}`;
            showModal('add-all-chapters-dpt-modal');
        }

        function handleAddDptToChapter(e) {
            e.preventDefault();
            const subjectId = document.getElementById('dpt-add-subject-id').value;
            const chapterId = document.getElementById('dpt-add-chapter-select').value;
            const quantity = parseInt(document.getElementById('dpt-add-quantity').value);

            if (!subjectId || !chapterId || isNaN(quantity) || quantity < 1) {
                alert('Please ensure all fields are correct.');
                return;
            }

            data.dpts[subjectId] = data.dpts[subjectId] || { chapters: {} };
            data.dpts[subjectId].chapters[chapterId] = data.dpts[subjectId].chapters[chapterId] || [];
            
            const startId = data.dpts[subjectId].chapters[chapterId].length + 1;
            for (let i = 0; i < quantity; i++) {
                data.dpts[subjectId].chapters[chapterId].push({ id: startId + i, status: 'Pending', details: null });
            }
            
            const chapter = getChapterByIds(subjectId, chapterId);
            logActivity('plus-square', `Added ${quantity} DPTs for ${_(subjectId)} - ${chapter ? chapter.name : ''}`);
            saveData();
            hideModal('add-chapter-dpt-modal');
            renderDptPage();
        }
        
        function handleAddDptToAllChapters(e) {
            e.preventDefault();
            const subjectId = document.getElementById('dpt-add-all-subject-id').value;
            const quantity = parseInt(document.getElementById('dpt-add-all-quantity').value);
            
            if (!subjectId || isNaN(quantity) || quantity < 1) {
                alert('Please ensure all fields are correct.');
                return;
            }
            
            const subject = getSubjectById(subjectId);
            const chapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])];
            let totalAdded = 0;

            chapters.forEach(chapter => {
                data.dpts[subjectId] = data.dpts[subjectId] || { chapters: {} };
                data.dpts[subjectId].chapters[chapter.id] = data.dpts[subjectId].chapters[chapter.id] || [];
                
                const startId = data.dpts[subjectId].chapters[chapter.id].length + 1;
                for (let i = 0; i < quantity; i++) {
                    data.dpts[subjectId].chapters[chapter.id].push({ id: startId + i, status: 'Pending', details: null });
                }
                totalAdded += quantity;
            });

            logActivity('plus-square', `Added ${quantity} DPT(s) to ${chapters.length} chapters in ${_(subjectId)}.`);
            saveData();
            hideModal('add-all-chapters-dpt-modal');
            renderDptPage();
        }

        init();
    });
    </script>
</body>
</html>
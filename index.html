<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0ea5e9">
    <link rel="manifest" href="manifest.json">

    <!-- MODIFICATION: Title updated -->
    <title>Pravej Ahmad's Digital Study Tracker</title>
    
    <!-- Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for analytics and reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons for a clean, modern icon set -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF and html2canvas for PDF reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Google Fonts for a professional look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&display=swap" rel="stylesheet">

    <style>
        /* MODIFICATION: New Color Theme Variables */
        :root {
            --background-light: #f0f9ff; /* sky-50 */
            --background-dark: #0c1425;
            --card-light: #ffffff;
            --card-dark: #1e293b;
            --text-light: #020617;
            --text-dark: #f1f5f9;
            --text-muted-light: #475569;
            --text-muted-dark: #94a3b8;
            --primary: #0ea5e9; /* sky-500 */
            --primary-hover: #0284c7; /* sky-600 */
            --accent: #8b5cf6; /* violet-500 */
            --danger: #ef4444;
            --warning: #f59e0b;
            /* MODIFICATION: Custom theme variables with fallbacks */
            --main-bg-start-light: #cffafe;
            --main-bg-end-light: #e0e7ff;
            --main-bg-start-dark: #164e63;
            --main-bg-end-dark: #312e81;
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* NEW: Canvas background styling */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Place it behind all other content */
            display: none; /* Initially hidden */
        }

        .app-header-title {
            font-family: 'Poppins', sans-serif;
            color: #1e293b; /* slate-800 */
        }
        .dark .app-header-title {
            color: #e2e8f0; /* slate-200 */
        }

        /* Hide scrollbar for a cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Page transition animation */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* NEW: Animation for list items */
        .animate-list-item {
            animation: slideInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .task-list-item.completed {
            transition: opacity 0.5s ease, max-height 0.5s ease, margin 0.5s ease, padding 0.5s ease;
            opacity: 0;
            max-height: 0;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            overflow: hidden;
        }
        .task-list-item {
            transition: opacity 0.5s ease, max-height 0.5s ease, margin 0.5s ease, padding 0.5s ease;
            max-height: 100px; /* Adjust as needed */
        }

        .task-note-missed {
            background-color: #ffedd5 !important; /* orange-100 */
            border-left: 4px solid #f97316; /* orange-500 */
        }
        .dark .task-note-missed {
            background-color: #3f2715 !important;
            border-left-color: #fb923c;
        }
        .source-badge {
            font-size: 0.7rem; font-weight: 700; padding: 2px 6px;
            border-radius: 99px; margin-left: 8px; background-color: var(--primary);
            color: white; opacity: 0.8;
        }
        .source-badge-book { background-color: #8b5cf6; } /* Purple for Book */
        .source-badge-notes { background-color: #0891b2; } /* Cyan for Notes */
        
        #undo-toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 100;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0; pointer-events: none;
        }
        #undo-toast.show {
            opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto;
        }
        
        main {
            background: linear-gradient(135deg, var(--main-bg-start-light) 0%, var(--main-bg-end-light) 100%);
        }
        .dark main {
            background: linear-gradient(135deg, var(--main-bg-start-dark) 0%, var(--main-bg-end-dark) 100%);
        }
        
        /* Make main background transparent when particles are active */
        body.particles-active main {
            background: transparent;
        }
        
        #sidebar { 
            border-right: 1px solid #e5e7eb; 
            transition: all 0.3s ease-in-out; 
            box-shadow: 4px 0 15px -3px rgba(0, 0, 0, 0.07);
        }
        .dark #sidebar { 
            border-color: #374151; 
            box-shadow: 4px 0 20px -3px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-collapsed .nav-btn span, .sidebar-collapsed .app-header-title, .sidebar-collapsed #creator-credit span {
            display: none;
        }
        .sidebar-collapsed .nav-btn, .sidebar-collapsed #sidebar-toggle-btn {
            justify-content: center;
        }

        button, .nav-btn, .chapter-item, .task-action-btn, .dashboard-card, .dpt-list-item {
            transition: transform 0.1s ease-in-out, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        button:active, .nav-btn:active, .chapter-item:active, .task-action-btn:active, .dpt-list-item:active {
            transform: scale(0.97);
        }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .animated-progress-bar {
            transition: width 0.8s ease-out;
        }

        .btn-neon {
            background-color: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), inset 0 0 5px var(--primary);
            animation: neon-pulse 2s infinite;
            transition: color 0.2s, background-color 0.2s, box-shadow 0.2s;
        }
        .btn-neon:hover {
            color: white;
            background-color: var(--primary);
            box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary), 0 0 30px var(--primary);
        }

        .dark .btn-neon {
             color: var(--accent);
             border-color: var(--accent);
             box-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent), inset 0 0 5px var(--accent);
        }
        .dark .btn-neon:hover {
            color: var(--card-dark);
            background-color: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent);
        }

        @keyframes neon-pulse {
            50% {
                box-shadow: 0 0 8px var(--primary), 0 0 15px var(--primary), inset 0 0 8px var(--primary), 0 0 20px var(--accent);
            }
        }
        .dark @keyframes neon-pulse {
             50% {
                box-shadow: 0 0 8px var(--accent), 0 0 15px var(--accent), inset 0 0 8px var(--accent), 0 0 20px var(--primary);
            }
        }

        /* --- START: MOBILE BOTTOM NAV STYLES --- */
        #mobile-bottom-nav {
            display: none; /* Hidden by default */
        }

        @media (max-width: 767px) {
            /* Hide desktop sidebar and mobile menu button */
            #sidebar, #mobile-menu-btn {
                display: none;
            }
            
            /* Adjust main content padding to not be hidden by the nav bar */
            main {
                padding-bottom: 80px !important;
            }

            #mobile-bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: var(--card-light);
                border-top: 1px solid #e5e7eb;
                z-index: 50;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            }
            .dark #mobile-bottom-nav {
                background-color: var(--card-dark);
                border-top-color: #374151;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            }

            #mobile-nav-scroller {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                padding: 4px 8px;
            }

            .mobile-nav-btn {
                flex: 0 0 auto; /* Prevent shrinking */
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-width: 60px;
                padding: 8px 12px;
                color: var(--text-muted-light);
                transition: color 0.2s ease-in-out;
            }
            .dark .mobile-nav-btn {
                color: var(--text-muted-dark);
            }
            .mobile-nav-btn.active {
                color: var(--primary);
            }
            .dark .mobile-nav-btn.active {
                color: var(--primary);
            }

            .mobile-nav-btn i {
                width: 24px;
                height: 24px;
            }
        }
        /* --- END: MOBILE BOTTOM NAV STYLES --- */
        
        .status-btn-group button.active {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }
        .dark .status-btn-group button.active {
             background-color: var(--primary-hover);
        }
        
        .subject-source-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">
    
    <!-- NEW: Particle Canvas Background -->
    <canvas id="particle-canvas"></canvas>

    <div class="flex h-screen bg-transparent"> <!-- MODIFICATION: bg-gray-50 removed for canvas -->
        <aside id="sidebar" class="flex flex-col w-64 bg-card-light dark:bg-card-dark relative">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 h-16">
                <h1 class="text-xl font-extrabold app-header-title" data-translate="study_tracker">Study Tracker</h1>
            </div>
            <nav class="flex-grow p-4 space-y-2 no-scrollbar overflow-y-auto">
                <button data-page="home" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="home" class="w-5 h-5"></i> <span data-translate="home">Home</span></button>
                <button data-page="subjects" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="book-open" class="w-5 h-5"></i> <span data-translate="subjects">Subjects</span></button>
                <button data-page="dpt" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="clipboard-check" class="w-5 h-5"></i> <span data-translate="dpt">DPT</span></button>
                <button data-page="exams" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="briefcase" class="w-5 h-5"></i> <span data-translate="exams">Exams</span></button>
                <button data-page="import-export" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="arrow-right-left" class="w-5 h-5"></i> <span data-translate="import_export">Import/Export</span></button>
                <button data-page="calendar" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="calendar" class="w-5 h-5"></i> <span data-translate="calendar">Calendar</span></button>
                <button data-page="analytics" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="bar-chart-3" class="w-5 h-5"></i> <span data-translate="analytics">Analytics</span></button>
                <button data-page="report" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="clipboard-list" class="w-5 h-5"></i> <span data-translate="report">Report</span></button>
                <button data-page="settings" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="settings" class="w-5 h-5"></i> <span data-translate="settings">Settings</span></button>
            </nav>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
                <button id="theme-toggle-btn" class="w-full flex items-center justify-center gap-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="sun" id="theme-icon-sun"></i>
                    <i data-lucide="moon" id="theme-icon-moon"></i>
                </button>
                <button id="sidebar-toggle-btn" class="w-full hidden md:flex items-center justify-center gap-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="chevrons-left" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="creator-credit" class="p-4 text-center text-xs text-text-muted-light dark:text-text-muted-dark">
                <span>Created by Pravej Ahmad</span>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-screen max-h-screen">
            <!-- MODIFICATION: Header updated to better center the title -->
            <header class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-card-light/80 dark:bg-card-dark/80 backdrop-blur-sm z-10">
                <button id="mobile-menu-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 md:hidden">
                    <i data-lucide="menu"></i>
                </button>
                <div class="text-center flex-grow">
                    <h1 class="text-lg font-extrabold app-header-title">Study Tracker</h1>
                    <p class="text-xs text-text-muted-light dark:text-muted-dark -mt-1">By Pravej Ahmad</p>
                </div>
                <!-- MODIFICATION: Theme toggle button removed from here for mobile view -->
            </header>

            <main class="flex-grow overflow-y-auto p-4 md:p-8 pb-4 no-scrollbar">
                <div id="page-home" class="page active">
                     <h2 id="welcome-heading" class="text-3xl font-bold text-text-light dark:text-text-dark mb-2">Welcome, Pravej Ahmad!</h2>
                     <p class="text-text-muted-light dark:text-text-muted-dark mb-6" data-translate="welcome_subtitle">Here's your plan for today. Let's get it done!</p>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div id="ai-insights-container" class="dashboard-card bg-violet-50 dark:bg-violet-900/30 border-2 border-accent/20 p-4 rounded-xl shadow-sm">
                            </div>
                            <div id="todays-dpt-container" class="dashboard-card bg-gradient-to-br from-amber-100 to-orange-200 dark:from-amber-800 dark:to-orange-900 p-4 rounded-xl shadow-sm min-h-[100px]">
                            </div>
                            <div id="todays-plan-container" class="dashboard-card bg-sky-50 dark:bg-sky-900/30 border-2 border-primary/20 p-4 rounded-xl shadow-sm min-h-[180px]">
                            </div>
                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold mb-3" data-translate="tomorrows_topics">Tomorrow's Topics</h2>
                                <div id="tomorrows-plan-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div>
                            </div>
                             <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold mb-3" data-translate="yesterdays_completed">Yesterday's Completed Chapters</h2>
                                <div id="yesterdays-completed-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div>
                            </div>
                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold mb-3 text-red-600 dark:text-red-400" data-translate="missed_chapters">Missed Chapters</h2>
                                <div id="missed-chapters-list" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div>
                            </div>
                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold mb-3" data-translate="postponed_chapters">Postponed Chapters</h2>
                                <div id="postponed-chapters-list" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3" data-translate="upcoming_revisions">Upcoming Revisions</h2><div id="revisions-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div></div>
                                <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3" data-translate="achievements">Achievements</h2><div id="badges-container" class="space-y-3"></div></div>
                            </div>
                        </div>
                        <div class="lg:col-span-1 space-y-4">
                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold text-center mb-2" data-translate="upcoming_exams">Upcoming Exams</h2>
                                <div id="dashboard-exams-container" class="space-y-3">
                                </div>
                            </div>
                             <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <h2 class="text-lg font-bold text-center" data-translate="overall_progress">Overall Progress</h2>
                                <div class="flex flex-col items-center gap-4 mt-2">
                                    <div class="relative w-40 h-40"><canvas id="overall-progress-chart"></canvas><div id="overall-progress-text" class="absolute inset-0 flex items-center justify-center text-4xl font-bold"></div></div>
                                    <div class="text-center">
                                        <p class="text-base text-text-muted-light dark:text-text-muted-dark"><span data-translate="chapters_completed">Chapters Completed</span>: <span id="chapters-completed-count" class="font-semibold text-text-light dark:text-text-dark">0 / 0</span></p>
                                    </div>
                                </div>
                             </div>
                            <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                                <div class="flex justify-center items-center gap-2 mb-3 relative">
                                    <h2 id="subject-progress-title" class="text-lg font-bold text-center"></h2>
                                    <div class="relative">
                                        <button id="toggle-progress-view-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-down" class="w-5 h-5"></i></button>
                                        <div id="progress-view-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-card-light dark:bg-card-dark rounded-md shadow-lg z-20 border border-gray-200 dark:border-gray-700">
                                            <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" data-view="notes" data-translate="notes_progress">Notes Progress</a>
                                            <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" data-view="book" data-translate="book_progress">Book Progress</a>
                                        </div>
                                    </div>
                                </div>
                                <div id="subject-progress-dashboard-container" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-subjects" class="page">
                    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-4">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-bold flex-shrink-0" data-translate="subjects_chapters">Subjects & Chapters</h2>
                            <div id="subject-source-filter" class="flex items-center p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                <button data-source="notes" class="subject-source-btn px-3 py-1 text-sm font-semibold rounded-md" data-translate="notes_chapters">Notes Chapters</button>
                                <button data-source="book" class="subject-source-btn px-3 py-1 text-sm font-semibold rounded-md" data-translate="book_chapters">Book Chapters</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="add-new-subject-btn" class="flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg btn-neon">
                                <i data-lucide="plus" class="w-4 h-4"></i> <span data-translate="add_new_subject">Add New Subject</span>
                            </button>
                            <input id="search-input" type="text" data-translate-placeholder="search_chapters" placeholder="Search chapters..." class="w-full md:w-auto px-3 py-1.5 text-sm bg-card-light dark:bg-card-dark border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                        </div>
                    </div>
                    <div id="subjects-list-container" class="space-y-3"></div>
                </div>
                
                <div id="page-dpt" class="page">
                    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold" data-translate="dpt_page_title">Daily Practice Tests (DPT)</h2>
                        <select id="dpt-subject-filter" class="p-2 bg-card-light dark:bg-card-dark border border-gray-300 dark:border-gray-600 rounded-lg">
                        </select>
                    </div>
                    
                    <div id="dpt-summary-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    </div>

                    <div id="dpt-list-container" class="space-y-4">
                    </div>
                </div>

                <div id="page-exams" class="page">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold" data-translate="exams_and_forms">Exams & Applied Forms</h2>
                        <div class="flex items-center gap-2 flex-wrap" id="exam-filter-buttons">
                            <button data-filter="all" class="exam-filter-btn active bg-primary text-white px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="all">All</button>
                            <button data-filter="upcoming" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="upcoming_exams">Upcoming Exams</button>
                            <button data-filter="applied" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="applied_forms">Applied Forms</button>
                            <button data-filter="history" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="history_exams">History</button>
                        </div>
                        <button id="add-exam-btn" class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg btn-neon">
                            <i data-lucide="plus" class="w-4 h-4"></i> <span data-translate="add_new_exam">Add New Exam</span>
                        </button>
                    </div>
                    <div id="exams-list-container" class="space-y-4">
                    </div>
                </div>


                <div id="page-import-export" class="page">
                    <h2 class="text-2xl font-bold mb-4" data-translate="import_export_data">Import & Export Data</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-3 text-lg" data-translate="chapters_data_management">Chapters Data Management</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4" data-translate="import_export_chapters_desc">Import or export chapter lists for specific sources (Notes or Book) in JSON format. This is useful for quickly adding a large number of chapters.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="p-4 rounded-lg bg-cyan-50 dark:bg-cyan-900/30 border border-cyan-200 dark:border-cyan-800">
                                    <div class="flex items-center gap-3 mb-2">
                                        <i data-lucide="notebook-tabs" class="w-6 h-6 text-cyan-700 dark:text-cyan-300"></i>
                                        <h4 class="font-bold text-cyan-800 dark:text-cyan-200" data-translate="notes_chapters">Notes Chapters</h4>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="import-all-notes-btn" class="flex-1 flex items-center justify-center gap-2 p-2 text-sm font-semibold text-cyan-700 dark:text-cyan-300 bg-cyan-100 dark:bg-cyan-900/50 rounded-lg hover:bg-cyan-200 dark:hover:bg-cyan-900"><i data-lucide="upload" class="w-4 h-4"></i><span data-translate="import">Import</span></button>
                                        <button id="delete-all-notes-btn" class="flex-1 flex items-center justify-center gap-2 p-2 text-sm font-semibold text-red-600 dark:text-red-300 bg-red-100 dark:bg-red-900/50 rounded-lg hover:bg-red-200 dark:hover:bg-red-900"><i data-lucide="trash-2" class="w-4 h-4"></i><span data-translate="delete_all">Delete All</span></button>
                                    </div>
                                </div>
                                <div class="p-4 rounded-lg bg-violet-50 dark:bg-violet-900/30 border border-violet-200 dark:border-violet-800">
                                    <div class="flex items-center gap-3 mb-2">
                                        <i data-lucide="book" class="w-6 h-6 text-violet-700 dark:text-violet-300"></i>
                                        <h4 class="font-bold text-violet-800 dark:text-violet-200" data-translate="book_chapters">Book Chapters</h4>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="import-all-books-btn" class="flex-1 flex items-center justify-center gap-2 p-2 text-sm font-semibold text-violet-600 dark:text-violet-300 bg-violet-100 dark:bg-violet-900/50 rounded-lg hover:bg-violet-200 dark:hover:bg-violet-900"><i data-lucide="upload" class="w-4 h-4"></i><span data-translate="import">Import</span></button>
                                        <button id="delete-all-books-btn" class="flex-1 flex items-center justify-center gap-2 p-2 text-sm font-semibold text-red-600 dark:text-red-300 bg-red-100 dark:bg-red-900/50 rounded-lg hover:bg-red-200 dark:hover:bg-red-900"><i data-lucide="trash-2" class="w-4 h-4"></i><span data-translate="delete_all">Delete All</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <h3 class="font-semibold mb-3 text-lg" data-translate="full_app_backup">Full Application Backup</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4" data-translate="full_app_backup_desc">Export all your data, including subjects, chapters, progress, settings, and activity log, into a single JSON file. Keep this file in a safe place as a backup.</p>
                            <button id="export-full-data-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-900">
                                <i data-lucide="download-cloud" class="w-4 h-4"></i>
                                <span data-translate="export_data">Export All Data (Backup)</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="page-calendar" class="page">
                    <h2 class="text-2xl font-bold mb-4" data-translate="study_calendar">Study Calendar</h2>
                    <div id="calendar-view" class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm"></div>
                </div>
                
                <div id="page-analytics" class="page">
                    <h2 class="text-2xl font-bold mb-4" data-translate="analytics_reports">Analytics & Reports</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="total_chapters_done">Total Chapters Done</h3><p id="metric-total-completed" class="text-3xl font-bold text-primary">0</p></div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="average_per_day">Average per Day</h3><p id="metric-avg-per-day" class="text-3xl font-bold text-accent">0.0</p></div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="best_day">Best Day</h3><p id="metric-best-day" class="text-3xl font-bold text-warning">-</p></div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="total_dpt_completed">Total DPTs Done</h3><p id="metric-total-dpt" class="text-3xl font-bold text-orange-500">0</p></div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="overall_accuracy">Overall Accuracy</h3><p id="metric-dpt-accuracy" class="text-3xl font-bold text-teal-500">0%</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="chapter_status_distribution">Chapter Status Distribution</h3><div class="relative h-80"><canvas id="chapter-status-chart"></canvas></div></div>
                        <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="weekly_productivity">Weekly Productivity (Chapters Done)</h3><div class="relative h-80"><canvas id="weekly-productivity-chart"></canvas></div></div>
                        <div class="lg:col-span-2 bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="subject_wise_progress">Subject-wise Progress (%)</h3><div class="relative h-80"><canvas id="subject-progress-chart"></canvas></div></div>
                        <div class="lg:col-span-2 bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2">DPT Performance by Subject (Accuracy %)</h3><div class="relative h-80"><canvas id="dpt-performance-chart"></canvas></div></div>
                    </div>
                </div>

                <div id="page-report" class="page">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold" data-translate="study_report">Study Report</h2>
                        <button id="download-report-btn" class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-primary rounded-lg hover:bg-primary-hover shadow transition-all duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-wait">
                            <i data-lucide="download" class="w-4 h-4"></i> <span data-translate="download_pdf">Download PDF</span>
                        </button>
                    </div>
                    <div id="report-content-container">
                    </div>
                </div>

                <div id="page-settings" class="page">
                    <h2 class="text-2xl font-bold mb-4" data-translate="settings">Settings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <label for="student-name-input" class="font-semibold" data-translate="student_name">Student Name</label>
                            <input type="text" id="student-name-input" data-translate-placeholder="student_name_placeholder" placeholder="Enter your name..." class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-600 rounded-lg">
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <label for="language-select" class="font-semibold" data-translate="app_language">Application Language</label>
                            <select id="language-select" class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-600 rounded-lg">
                                <option value="en">English</option>
                                <option value="hi">हिंदी (Hindi)</option>
                            </select>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <label for="background-style-select" class="font-semibold">Background Style</label>
                            <select id="background-style-select" class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-600 rounded-lg">
                                <option value="default">Default Gradient</option>
                                <option value="particles">Particle Network</option>
                                <option value="starfield">Starfield</option>
                                <option value="hexagon">Hexagon Grid</option>
                            </select>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2">
                             <h3 class="font-semibold mb-3">Theme Customization</h3>
                             <div class="grid grid-cols-2 gap-4 items-center">
                                 <div>
                                     <label for="bg-color-start" class="text-sm font-medium">Gradient Start</label>
                                     <input type="color" id="bg-color-start" class="mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                                 </div>
                                 <div>
                                     <label for="bg-color-end" class="text-sm font-medium">Gradient End</label>
                                     <input type="color" id="bg-color-end" class="mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                                 </div>
                             </div>
                             <button id="reset-theme-btn" class="mt-3 w-full text-sm p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Reset to Default</button>
                        </div>

                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2">
                            <h3 class="font-semibold mb-3" data-translate="daily_plan_mode">Daily Study Plan Mode</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-3" data-translate="daily_plan_subtitle">Choose how you want to generate your daily study plan.</p>
                            <div class="flex flex-wrap gap-4 mb-4">
                                <label class="flex items-center gap-2"><input type="radio" name="plan-mode" value="auto" class="form-radio text-primary"> <span data-translate="auto_rotation">Automatic Rotation</span></label>
                                <label class="flex items-center gap-2"><input type="radio" name="plan-mode" value="custom_cycle" class="form-radio text-primary"> <span data-translate="custom_cycle">Custom Cycle</span></label>
                            </div>
                        </div>
                        
                        <div id="custom-cycle-plan-container" class="hidden md:col-span-2 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                                <h3 class="font-semibold" data-translate="custom_study_plan">Custom Study Plan (2 Week Cycle)</h3>
                            </div>
                            <div id="custom-cycle-subject-selector" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                            <button id="save-custom-cycle-plan" class="mt-4 px-4 py-2 btn-neon font-semibold rounded-lg" data-translate="save_custom_plan">Save Custom Plan</button>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2">
                            <h3 class="font-semibold mb-3" data-translate="dpt_plan_mode">Daily DPT Plan Mode</h3>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-3" data-translate="dpt_plan_subtitle">Choose how you want to generate your daily DPT schedule.</p>
                            <div class="flex flex-wrap gap-4 mb-4">
                                <label class="flex items-center gap-2"><input type="radio" name="dpt-plan-mode" value="auto" class="form-radio text-primary"> <span data-translate="dpt_auto_mode">Automatic (Follows Study Plan)</span></label>
                                <label class="flex items-center gap-2"><input type="radio" name="dpt-plan-mode" value="custom_cycle" class="form-radio text-primary"> <span data-translate="custom_cycle">Custom Cycle</span></label>
                            </div>
                        </div>
                        
                        <div id="custom-dpt-plan-container" class="hidden md:col-span-2 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                                <h3 class="font-semibold" data-translate="custom_dpt_plan">Custom DPT Plan (2 Week Cycle)</h3>
                            </div>
                            <div id="dpt-custom-cycle-subject-selector" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                            <button id="save-dpt-custom-cycle-plan" class="mt-4 px-4 py-2 btn-neon font-semibold rounded-lg" data-translate="save_custom_plan">Save Custom DPT Plan</button>
                        </div>
                        
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2"><h3 class="font-semibold mb-3" data-translate="reset_app">Reset Application</h3><button id="reset-app-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900"><i data-lucide="trash-2" class="w-4 h-4"></i> <span data-translate="reset_all_data">Reset All Data</span></button></div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <!-- MODIFICATION: NEW MOBILE BOTTOM NAVIGATION BAR -->
    <nav id="mobile-bottom-nav">
        <div id="mobile-nav-scroller" class="no-scrollbar">
            <button data-page="home" class="mobile-nav-btn"><i data-lucide="home"></i></button>
            <button data-page="subjects" class="mobile-nav-btn"><i data-lucide="book-open"></i></button>
            <button data-page="dpt" class="mobile-nav-btn"><i data-lucide="clipboard-check"></i></button>
            <button data-page="exams" class="mobile-nav-btn"><i data-lucide="briefcase"></i></button>
            <button data-page="import-export" class="mobile-nav-btn"><i data-lucide="arrow-right-left"></i></button>
            <button data-page="calendar" class="mobile-nav-btn"><i data-lucide="calendar"></i></button>
            <button data-page="analytics" class="mobile-nav-btn"><i data-lucide="bar-chart-3"></i></button>
            <button data-page="report" class="mobile-nav-btn"><i data-lucide="clipboard-list"></i></button>
            <button data-page="settings" class="mobile-nav-btn"><i data-lucide="settings"></i></button>
            <!-- MODIFICATION: Theme toggle button moved here -->
            <button id="theme-toggle-btn-mobile" class="mobile-nav-btn">
                <i data-lucide="sun" id="theme-icon-sun-mobile"></i>
                <i data-lucide="moon" id="theme-icon-moon-mobile"></i>
            </button>
        </div>
    </nav>

    <input type="file" id="import-all-chapters-input" class="hidden" accept=".json">

    <!-- *** START: NEW MODAL FOR ADDING SUBJECT *** -->
    <div id="add-subject-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
            <button id="close-add-subject-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 class="text-xl font-bold mb-4" data-translate="add_new_subject">Add New Subject</h2>
            <form id="add-subject-form" class="space-y-4">
                <div>
                    <label for="new-subject-name" class="block text-sm font-medium mb-1">Subject Name</label>
                    <input type="text" id="new-subject-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg" required placeholder="e.g. Current Affairs">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Subject Source</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2">
                            <input type="radio" name="subject-source" value="notes" class="form-radio text-primary" checked>
                            <span data-translate="source_notes">Notes</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="radio" name="subject-source" value="book" class="form-radio text-primary">
                            <span data-translate="source_book">Book</span>
                        </label>
                    </div>
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Save Subject</button>
            </form>
        </div>
    </div>
    <!-- *** END: NEW MODAL FOR ADDING SUBJECT *** -->

    <!-- Add Chapter Modal -->
    <div id="add-chapter-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden"><div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative"><button id="close-add-chapter-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button><h2 class="text-xl font-bold mb-4" data-translate="add_new_chapter">Add New Chapter</h2><form id="add-chapter-form" class="space-y-4"><input type="hidden" id="add-chapter-subject-id"><input type="hidden" id="add-chapter-source-type"><div><label for="new-chapter-name" class="block text-sm font-medium mb-1" data-translate="chapter_name">Chapter Name</label><input type="text" id="new-chapter-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg" required></div><button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="add_chapter">Add Chapter</button></form></div></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden"><div class="bg-card-light dark:bg-card-dark w-full max-w-sm rounded-2xl shadow-xl p-6 text-center"><h2 id="confirmation-title" class="text-xl font-bold mb-2" data-translate="are_you_sure">Are you sure?</h2><p id="confirmation-message" class="text-text-muted-light dark:text-text-muted-dark mb-6" data-translate="action_cannot_be_undone">This action cannot be undone.</p><div class="flex justify-center gap-4"><button id="confirm-cancel" class="flex-1 p-3 font-semibold rounded-lg bg-gray-200 dark:bg-gray-700" data-translate="cancel">Cancel</button><button id="confirm-action" class="flex-1 p-3 font-semibold rounded-lg text-white bg-danger" data-translate="confirm">Confirm</button></div></div></div>
    
    <!-- Chapter Details Modal -->
    <div id="chapter-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button id="close-chapter-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="chapter-modal-title" class="text-xl font-bold mb-4" data-translate="chapter_details">Chapter Details</h2>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium mb-2" data-translate="status">Status</label>
                    <div id="chapter-status-buttons" class="status-btn-group grid grid-cols-2 gap-2 p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <button data-status="Not Started" class="p-2 text-sm rounded-md transition-colors duration-200"><span data-translate="not_started">Not Started</span></button>
                        <button data-status="Completed" class="p-2 text-sm rounded-md transition-colors duration-200"><span data-translate="completed">Completed</span></button>
                    </div>
                </div>
                <div>
                    <label for="chapter-notes-textarea" class="block text-sm font-medium mb-1" data-translate="study_notes">Study Notes</label>
                    <textarea id="chapter-notes-textarea" rows="4" data-translate-placeholder="study_notes_placeholder" placeholder="e.g., This chapter is important for exams..." class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-sm"></textarea>
                </div>
                <div>
                    <label class="flex items-center gap-3 p-3 bg-yellow-50 dark:bg-yellow-900/40 rounded-lg cursor-pointer">
                        <input type="checkbox" id="chapter-priority-revision-checkbox" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                        <span class="font-semibold text-yellow-800 dark:text-yellow-200" data-translate="priority_revision">Mark for Priority Revision</span>
                    </label>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="font-semibold mb-2">Scheduled Revisions</h3>
                    <div id="scheduled-revisions-list" class="space-y-2 mb-3">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="date" id="manual-revision-date" class="flex-grow p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-sm">
                        <button id="add-manual-revision-btn" class="p-2 font-semibold rounded-lg bg-accent text-white hover:bg-violet-600">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                </div>

                <div class="flex gap-3 mt-4">
                    <button id="delete-chapter-details-btn" class="w-auto p-3 text-sm font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <button id="save-chapter-details-btn" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save_changes">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Achievement Badge Modal -->
    <div id="badge-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden"><div class="bg-card-light dark:bg-card-dark w-full max-w-sm rounded-2xl shadow-xl p-8 text-center relative overflow-hidden"><button id="close-badge-modal-x" class="absolute top-4 right-4 text-text-muted-light dark:hover:text-text-light dark:text-text-dark z-10"><i data-lucide="x" class="w-6 h-6"></i></button><div class="absolute top-0 left-0 w-full h-full opacity-10 dark:opacity-20" style="background-image: radial-gradient(circle, var(--primary) 0%, transparent 70%);"></div><i data-lucide="award" class="w-16 h-16 text-amber-400 mx-auto mb-4 drop-shadow-lg"></i><h2 class="text-2xl font-bold mb-2" data-translate="achievement_unlocked">Achievement Unlocked!</h2><p id="badge-name" class="text-lg font-semibold text-primary dark:text-blue-300 mb-4"></p><p id="badge-description" class="text-text-muted-light dark:text-text-muted-dark mb-6"></p><button id="close-badge-modal" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="awesome">Awesome!</button></div></div>
    
    <!-- Undo Toast -->
    <div id="undo-toast" class="p-3 rounded-lg shadow-lg bg-gray-800 text-white dark:bg-gray-200 dark:text-black flex items-center gap-4">
        <span id="undo-message"></span>
        <button id="undo-btn" class="font-bold" data-translate="undo">Undo</button>
    </div>

    <!-- Add/Edit Exam Modal -->
    <div id="add-exam-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative overflow-y-auto max-h-[90vh]">
            <button id="close-add-exam-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="exam-modal-title" class="text-xl font-bold mb-4" data-translate="add_new_exam">Add New Exam</h2>
            <form id="add-exam-form" class="space-y-4">
                <input type="hidden" id="exam-id">
                <div>
                    <label for="exam-name" class="block text-sm font-medium mb-1" data-translate="exam_name">Exam Name</label>
                    <input type="text" id="exam-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="application-date" class="block text-sm font-medium mb-1" data-translate="application_date">Application Date</label>
                        <input type="date" id="application-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label for="exam-date" class="block text-sm font-medium mb-1" data-translate="exam_date">Exam Date</label>
                        <input type="date" id="exam-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                </div>
                 <div>
                    <label for="exam-status" class="block text-sm font-medium mb-1" data-translate="status">Status</label>
                    <select id="exam-status" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <option value="Applied" data-translate="status_applied">Applied</option>
                        <option value="Admit Card Out" data-translate="status_admit_card">Admit Card Out</option>
                        <option value="Exam Done" data-translate="status_exam_done">Exam Done</option>
                        <option value="Result Out" data-translate="status_result_out">Result Out</option>
                    </select>
                </div>
                 <div>
                    <label for="exam-notes" class="block text-sm font-medium mb-1" data-translate="notes">Notes</label>
                    <textarea id="exam-notes" rows="3" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg" data-translate-placeholder="notes_placeholder" placeholder="e.g., Registration no., website link..."></textarea>
                </div>
                <div>
                    <label for="exam-receipt" class="block text-sm font-medium mb-1" data-translate="application_receipt">Application Receipt</label>
                    <input type="file" id="exam-receipt" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer" accept="image/*,.pdf">
                    <div id="exam-receipt-viewer" class="mt-2 text-sm"></div>
                </div>
                <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save_exam">Save Exam</button>
            </form>
        </div>
    </div>

    <!-- Date Completion Modal -->
    <div id="date-completion-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
            <button id="close-date-completion-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="date-completion-modal-title" class="text-xl font-bold mb-4">Mark Chapter as Completed</h2>
            <div class="space-y-4">
                <div>
                    <label for="date-completion-subject-select" class="block text-sm font-medium mb-1">Select Subject</label>
                    <select id="date-completion-subject-select" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <option value="">-- Choose a Subject --</option>
                    </select>
                </div>
                <div id="date-completion-chapter-list" class="max-h-60 overflow-y-auto space-y-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                    <p class="text-center text-sm text-text-muted-light dark:text-text-muted-dark">Please select a subject first.</p>
                </div>
                 <button id="save-date-completion-btn" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Mark as Completed</button>
            </div>
        </div>
    </div>
    
    <!-- DPT Details Submission Modal (UPDATED with Delete Button) -->
    <div id="dpt-details-popup-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
            <button id="close-dpt-details-popup-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h3 class="font-bold text-lg mb-4" data-translate="enter_dpt_details">Enter DPT Details</h3>
            <form id="dpt-details-form" class="space-y-3">
                <input type="hidden" id="dpt-details-subject-id">
                <input type="hidden" id="dpt-details-test-id">
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm">
                    <div><label for="dpt-total-q" class="font-medium" data-translate="dpt_total_q">Total Qs</label><input type="number" id="dpt-total-q" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="dpt-total-time" class="font-medium" data-translate="dpt_total_time">Total Time</label><input type="number" id="dpt-total-time" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="dpt-attempted" class="font-medium" data-translate="dpt_attempted">Attempted</label><input type="number" id="dpt-attempted" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="dpt-correct" class="font-medium" data-translate="dpt_correct">Correct</label><input type="number" id="dpt-correct" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="dpt-wrong" class="font-medium" data-translate="dpt_wrong">Wrong</label><input type="number" id="dpt-wrong" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                    <div><label for="dpt-time-taken" class="font-medium" data-translate="dpt_time_taken">Time Taken</label><input type="number" id="dpt-time-taken" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="delete-dpt-btn" class="p-3 font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300"><i data-lucide="trash-2"></i></button>
                    <button type="button" id="cancel-dpt-details-popup-modal" class="flex-1 p-3 font-semibold rounded-lg bg-gray-200 dark:bg-gray-700" data-translate="cancel">Cancel</button>
                    <button type="submit" class="flex-1 p-3 font-semibold rounded-lg bg-primary text-white" data-translate="submit">Submit</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODIFICATION: Manual Add Task Modal (UPDATED for dual purpose) -->
    <div id="manual-add-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
            <button id="close-manual-add-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
            <h2 id="manual-add-modal-title" class="text-xl font-bold mb-4">Add Task</h2>
            <div class="space-y-4">
                <div>
                    <label for="manual-add-subject-select" class="block text-sm font-medium mb-1">Select Subject</label>
                    <select id="manual-add-subject-select" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <option value="">-- Choose a Subject --</option>
                    </select>
                </div>
                
                <div id="manual-add-chapter-content">
                    <div>
                        <label for="manual-add-date" class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" id="manual-add-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                    <div>
                        <label for="manual-add-chapter-name" class="block text-sm font-medium mb-1">New Chapter Name</label>
                        <input type="text" id="manual-add-chapter-name" placeholder="Enter chapter name to add..." class="w-full p-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg">
                    </div>
                    <div>
                         <label class="block text-sm font-medium mb-2">Source</label>
                         <div class="flex gap-4">
                            <label class="flex items-center gap-2"><input type="radio" name="manual-add-source" value="notes" class="form-radio text-primary" checked> <span>Notes</span></label>
                            <label class="flex items-center gap-2"><input type="radio" name="manual-add-source" value="book" class="form-radio text-primary"> <span>Book</span></label>
                        </div>
                    </div>
                </div>

                <div id="manual-add-dpt-content" class="hidden">
                     <div id="manual-add-item-list" class="max-h-60 overflow-y-auto space-y-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                        <p class="text-center text-sm text-text-muted-light dark:text-text-muted-dark">Please select a subject first.</p>
                    </div>
                </div>
                <button id="save-manual-add-btn" class="w-full p-3 mt-2 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Add Task</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        const DB_KEY = 'pravejStudyTracker';
        let lastAction = null;
        let undoTimeout = null;
        let dashboardProgressView = 'notes';
        let currentSubjectSourceView = 'notes';
        // MODIFICATION: State for dashboard "See More" toggles
        let dashboardViewState = {
            missed: false,
            revisions: false,
            postponed: false
        };
        
        const translations = {
            en: {
                "physics": "Physics", "polity": "Polity", "chemistry": "Chemistry", "hindi": "Hindi",
                "geography": "Geography", "biology": "Biology", "economics": "Economics",
                "history": "History", "math": "Math", "static-gk": "Static GK",
                "reasoning": "Reasoning", "संविधान-articles": "Constitution (Articles)", "maths-formulas": "Maths Formulas & Tables", "fill-form": "Form Filling / Misc",
                "study_tracker": "Study Tracker", "home": "Home", "subjects": "Subjects", "activity": "Activity",
                "calendar": "Calendar", "analytics": "Analytics", "report": "Report", "settings": "Settings", "reminders": "Reminders",
                "import_export": "Import/Export", "import_export_data": "Import & Export Data",
                "light_mode": "Light Mode", "dark_mode": "Dark Mode", "collapse": "Collapse", "expand": "Expand",
                "welcome_pravej": "Welcome", "welcome_subtitle": "Here's your plan for today. Let's get it done!",
                "todays_plan": "Today's Plan", "tomorrows_topics": "Tomorrow's Topics", "upcoming_revisions": "Upcoming Revisions",
                "achievements": "Achievements", "days_remaining": "Days Remaining",
                "overall_progress": "Overall Progress", "chapters_completed": "Chapters Completed",
                "set_date": "Set Date", "deadline_passed": "Deadline passed!", "all_chapters_completed": "All chapters completed!",
                "add_chapters_prompt": "Add chapters to track your progress.",
                "no_upcoming_revisions": "No upcoming revisions.", "keep_studying_prompt": "Keep studying to earn badges!",
                "today": "Today", "tomorrow": "Tomorrow", "congratulations": "Congratulations!", 
                "all_tasks_completed": "All tasks for today are completed.", "revision_task": "{chapterName} (Revision)", 
                "postpone_tomorrow": "Postpone", "skip_chapter": "Skip",
                "postponed_chapters": "Postponed Chapters", "no_postponed_chapters": "No chapters have been postponed.",
                "subject_wise_progress_dashboard": "Subject-wise Progress", "subjects_chapters": "Subjects & Chapters", 
                "search_chapters": "Search chapters...", "chapters_done_of": "{completed} / {total} chapters done",
                "no_chapters_added": "No chapters added yet.", "add_chapter": "Add Chapter", "your_activity": "Your Activity", 
                "no_activity_yet": "No Activity Yet", "start_studying_prompt": "Start studying and your progress will appear here.",
                "study_calendar": "Study Calendar", "analytics_reports": "Analytics & Reports", 
                "total_chapters_done": "Total Chapters Done", "average_per_day": "Average per Day", "best_day": "Best Day", 
                "top_subject": "Top Subject", "chapter_status_distribution": "Chapter Status Distribution", 
                "weekly_productivity": "Weekly Productivity (Chapters Done)", "subject_wise_progress": "Subject-wise Progress (%)",
                "completed_chapters_chart": "Completed Chapters", "app_language": "Application Language", "student_name": "Student Name",
                "data_management": "Data Management", "import_data": "Import Data", 
                "export_data": "Export All Data (Backup)", "daily_plan_mode": "Daily Study Plan Mode", 
                "daily_plan_subtitle": "Choose how you want to generate your daily study plan.",
                "auto_rotation": "Automatic Rotation", "weekly_cycle": "Weekly Cycle", "manual_today": "Manual (Today Only)",
                "manual_select_subjects": "Select subjects for Today's Plan:", "weekly_study_plan": "Weekly Study Plan", 
                "save_weekly_plan": "Save Weekly Plan", "reset_app": "Reset Application", "reset_all_data": "Reset All Data",
                "add_new_chapter": "Add New Chapter", "chapter_name": "Chapter Name", "are_you_sure": "Are you sure?",
                "action_cannot_be_undone": "This action cannot be undone.", "cancel": "Cancel", "confirm": "Confirm",
                "chapter_details": "Chapter Details", "status": "Status", "save_changes": "Save Changes",
                "delete_chapter": "Delete Chapter", "achievement_unlocked": "Achievement Unlocked!", "awesome": "Awesome!",
                "not_started": "Not Started", "in_progress": "In Progress", "completed": "Completed",
                "missed_chapters": "Missed Chapters", "no_missed_chapters": "No chapters have been missed.",
                "yesterdays_completed": "Yesterday's Completed Chapters", "no_chapters_yesterday": "No chapters were completed yesterday.",
                "notes_chapters": "Notes Chapters", "book_chapters": "Book Chapters",
                "chapter_completed_msg": "Chapter marked complete.", "undo": "Undo",
                "import": "Import", "export": "Export", "chapters_data_management": "Chapters Data Management",
                "import_export_chapters_desc": "Import or export chapter lists for specific sources (Notes or Book) in JSON format. This is useful for quickly adding a large number of chapters.",
                "full_app_backup": "Full Application Backup",
                "full_app_backup_desc": "Export all your data, including subjects, chapters, progress, settings, and activity log, into a single JSON file. Keep this file in a safe place as a backup.",
                "study_report": "Study Report", "download_pdf": "Download PDF", "overall_summary": "Overall Summary", 
                "total_subjects": "Total Subjects", "total_chapters": "Total Chapters", "progress": "Progress",
                "subject_breakdown": "Subject Breakdown", "completed_on": "Completed On", "no_activity_log_report": "No activity logged yet.",
                "recent_activity": "Recent Activity", "student_name_placeholder": "Enter your name...",
                "source_notes": "Notes", "source_book": "Book", "feature_coming_soon": "Feature Coming Soon!",
                "add_new_reminder": "Add New Reminder", "reminder_text": "Reminder Text", "reminder_date": "Date", "reminder_time": "Time", "save_reminder": "Save Reminder",
                "no_reminders_set": "No reminders set. Add one to get started!", "mark_done": "Done",
                "study_notes": "Study Notes", "study_notes_placeholder": "e.g., This chapter is important for exams...", "priority_revision": "Mark for Priority Revision",
                "reminder_repeat": "Repeat", "repeat_none": "Does not repeat", "repeat_daily": "Daily", "repeat_weekly": "Weekly", "reminder_completed_today": "Reminder completed for today",
                "notes_progress": "Notes Progress", "book_progress": "Book Progress",
                "subject_wise_progress_notes": "Subject Progress (Notes)", "subject_wise_progress_book": "Subject Progress (Book)",
                "exams": "Exams", "exams_and_forms": "Exams & Applied Forms", "add_new_exam": "Add New Exam", "application_date": "Application Date", "exam_date": "Exam Date", "notes": "Notes",
                "save_exam": "Save Exam", "status_applied": "Applied", "status_admit_card": "Admit Card Out", "status_exam_done": "Exam Done", "status_result_out": "Result Out", "applied_on": "Applied on",
                "no_exams_added": "No exams added yet. Track your applications here!", "all": "All", "upcoming_exams": "Upcoming Exams", "applied_forms": "Applied Forms", "ai_insights": "AI Insights ✨",
                "ai_insight_produ_day": "Your most productive day seems to be {day}. Keep up the great work!", "ai_insight_stale_subject": "You haven't studied {subject} in a while. Consider reviewing it.",
                "ai_insight_missed_chapters": "You have {count} missed chapters. Try to clear them soon.", "ai_insight_start": "Welcome! Let's start by adding some chapters to study.",
                "notes_placeholder": "e.g., Registration no., website link...", "delete_exam": "Delete Exam", "no_upcoming_exams": "No upcoming exams.", "edit_exam": "Edit Exam",
                "application_receipt": "Application Receipt", "view_receipt": "View Current Receipt", "receipt_attached": "Receipt Attached",
                "history_exams": "History", "no_history_exams": "No past exams found in your history.", "no_upcoming_exams_filter": "There are no upcoming exams scheduled.", "no_applied_forms_filter": "No forms currently in 'Applied' status.",
                // DPT TRANSLATIONS
                "dpt": "DPT", "dpt_page_title": "Daily Practice Tests (DPT)", "all_subjects": "All Subjects",
                "add_dpt": "Add DPTs", "add_dpt_all": "Add DPTs to All", "no_dpt_for_subject": "No DPTs added for this subject yet.", "dpt_progress": "Test {completed} of {total} completed",
                "todays_dpt": "Today's DPT", "mark_as_complete": "Mark as Complete", "no_dpt_scheduled": "No DPT scheduled for today.",
                "all_dpt_completed": "All DPTs for today completed! Great job!",
                "enter_dpt_details": "Enter DPT Details", "dpt_total_q": "Total Qs", "dpt_total_time": "Total Time", "dpt_attempted": "Attempted",
                "dpt_correct": "Correct", "dpt_wrong": "Wrong", "dpt_time_taken": "Time Taken", "submit": "Submit",
                "dpt_summary": "DPT Summary", "total_dpt_completed": "Total DPTs Completed", "overall_accuracy": "Overall Accuracy",
                "avg_time_per_q": "Avg. Time / Q (s)", "add_new_subject": "Add New Subject",
                "enter_subject_name": "Enter the new subject name:", "subject_exists": "A subject with this name already exists.",
                "delete_all": "Delete All", "delete_all_chapters_confirm": "Are you sure you want to delete ALL chapters for this source? This cannot be undone.",
                "custom_cycle": "Custom Cycle", "custom_study_plan": "Custom Study Plan", "cycle_length": "Cycle Length (days):",
                "save_custom_plan": "Save Custom Plan", "day_d": "Day {day}",
                "dpt_plan_mode": "Daily DPT Plan Mode", "dpt_plan_subtitle": "Choose how you want to generate your daily DPT schedule.", "dpt_auto_mode": "Automatic (Follows Study Plan)", "custom_dpt_plan": "Custom DPT Plan",
                "dpt_report_title": "DPT Summary", "dpt_subject_breakdown": "DPT Subject Breakdown", "no_dpt_data_report": "No DPT data logged yet.",
                "sunday": "Sunday", "monday": "Monday", "tuesday": "Tuesday", "wednesday": "Wednesday", "thursday": "Thursday", "friday": "Friday", "saturday": "Saturday", "week_2_suffix": "(Week 2)",
                "delete_subject": "Delete Subject", "delete_subject_confirm": "This will delete the subject '{subjectName}' and all its chapters and DPTs. This action cannot be undone.",
                "delete_dpt": "Delete DPT", "delete_dpt_confirm": "Are you sure you want to delete {dptName}? This will remove its data permanently."
            },
            hi: {
                "physics": "भौतिकी", "polity": "राजनीति", "chemistry": "रसायन विज्ञान", "hindi": "हिंदी",
                "geography": "भूगोल", "biology": "जीव विज्ञान", "economics": "अर्थशास्त्र",
                "history": "इतिहास", "math": "गणित", "static-gk": "स्टेटिक जीके",
                "reasoning": "रीजनिंग", "संविधान-articles": "संविधान (अनुच्छेद)", "maths-formulas": "गणित सूत्र और तालिका", "fill-form": "फॉर्म भरना / विविध",
                "study_tracker": "स्टडी ट्रैकर", "home": "होम", "subjects": "विषय", "activity": "गतिविधि",
                "calendar": "कैलेंडर", "analytics": "एनालिटिक्स", "report": "रिपोर्ट", "settings": "सेटिंग्स", "reminders": "रिमाइंडर",
                "import_export": "इंपोर्ट/एक्सपोर्ट", "import_export_data": "डेटा इंपोर्ट और एक्सपोर्ट करें",
                "light_mode": "लाइट मोड", "dark_mode": "डार्क मोड", "collapse": "संक्षिप्त करें", "expand": "विस्तार करें",
                "welcome_pravej": "आपका स्वागत है", "welcome_subtitle": "आज की आपकी योजना यहाँ है। चलिए इसे पूरा करते हैं!",
                "todays_plan": "आज की योजना", "tomorrows_topics": "कल के विषय", "upcoming_revisions": "आगामी रिवीजन",
                "achievements": "उपलब्धियां", "days_remaining": "शेष दिन",
                "overall_progress": "कुल प्रगति", "chapters_completed": "अध्याय पूरे हुए",
                "set_date": "तिथि सेट करें", "deadline_passed": "समय सीमा समाप्त हो गई!", "all_chapters_completed": "सभी अध्याय पूरे हो गए!",
                "add_chapters_prompt": "अपनी प्रगति को ट्रैक करने के लिए अध्याय जोड़ें।",
                "no_upcoming_revisions": "कोई आगामी रिवीजन नहीं है।", "keep_studying_prompt": "बैज अर्जित करने के लिए अध्ययन करते रहें!",
                "today": "आज", "tomorrow": "कल", "congratulations": "बधाई हो!", 
                "all_tasks_completed": "आज के सभी कार्य पूरे हो गए हैं।", "revision_task": "{chapterName} (रिवीजन)", 
                "postpone_tomorrow": "स्थगित", "skip_chapter": "स्किप",
                "postponed_chapters": "स्थगित अध्याय", "no_postponed_chapters": "कोई अध्याय स्थगित नहीं किया गया है।",
                "subject_wise_progress_dashboard": "विषय-वार प्रगति", "subjects_chapters": "विषय और अध्याय", 
                "search_chapters": "अध्याय खोजें...", "chapters_done_of": "{total} में से {completed} अध्याय पूरे हुए",
                "no_chapters_added": "अभी तक कोई अध्याय नहीं जोड़ा गया है।", "add_chapter": "अध्याय जोड़ें", 
                "your_activity": "आपकी गतिविधि", "no_activity_yet": "अभी तक कोई गतिविधि नहीं", 
                "start_studying_prompt": "अध्ययन शुरू करें और आपकी प्रगति यहां दिखाई देगी।",
                "study_calendar": "अध्ययन कैलेंडर", "analytics_reports": "एनालिटिक्स और रिपोर्ट", 
                "total_chapters_done": "कुल अध्याय पूरे हुए", "average_per_day": "प्रति दिन औसत", "best_day": "सबसे अच्छा दिन", 
                "top_subject": "शीर्ष विषय", "chapter_status_distribution": "अध्याय स्थिति वितरण", 
                "weekly_productivity": "साप्ताहिक उत्पादकता (अध्याय पूरे हुए)", "subject_wise_progress": "विषय-वार प्रगति (%)",
                "completed_chapters_chart": "पूर्ण अध्याय", "app_language": "एप्लिकेशन भाषा", "student_name": "छात्र का नाम",
                "data_management": "डेटा प्रबंधन", "import_data": "डेटा आयात करें", 
                "export_data": "सारा डेटा निर्यात करें (बैकअप)", "daily_plan_mode": "दैनिक अध्ययन योजना मोड", 
                "daily_plan_subtitle": "चुनें कि आप अपनी दैनिक अध्ययन योजना कैसे बनाना चाहते हैं।",
                "auto_rotation": "स्वचालित रोटेशन", "weekly_cycle": "साप्ताहिक चक्र", "manual_today": "मैनुअल (केवल आज)",
                "manual_select_subjects": "आज की योजना के लिए विषय चुनें:", "weekly_study_plan": "साप्ताहिक अध्ययन योजना", 
                "save_weekly_plan": "साप्ताहिक योजना सहेजें", "reset_app": "एप्लिकेशन रीसेट करें", "reset_all_data": "सारा डेटा रीसेट करें",
                "add_new_chapter": "नया अध्याय जोड़ें", "chapter_name": "अध्याय का नाम", "are_you_sure": "क्या आप निश्चित हैं?",
                "action_cannot_be_undone": "यह कार्रवाई पूर्ववत नहीं की जा सकती।", "cancel": "रद्द करें", "confirm": "पुष्टि करें",
                "chapter_details": "अध्याय विवरण", "status": "स्थिति", "save_changes": "बदलाव सहेजें",
                "delete_chapter": "अध्याय हटाएं", "achievement_unlocked": "उपलब्धि अनलॉक हुई!", "awesome": "बहुत बढ़िया!",
                "not_started": "शुरू नहीं हुआ", "in_progress": "प्रगति में है", "completed": "पूरा हो गया",
                "missed_chapters": "छूटे हुए अध्याय", "no_missed_chapters": "कोई भी अध्याय छूटा नहीं है।",
                "yesterdays_completed": "कल पूरे हुए अध्याय", "no_chapters_yesterday": "कल कोई अध्याय पूरा नहीं हुआ।",
                "notes_chapters": "नोट्स चैप्टर्स", "book_chapters": "बुक चैप्टर्स",
                "chapter_completed_msg": "अध्याय पूरा हुआ।", "undo": "पूर्ववत् करें",
                "import": "आयात", "export": "निर्यात", "chapters_data_management": "चैप्टर्स डेटा प्रबंधन",
                "import_export_chapters_desc": "JSON प्रारूप में विशिष्ट स्रोतों (नोट्स या बुक) के लिए अध्याय सूचियों को आयात या निर्यात करें। यह बड़ी संख्या में अध्यायों को जल्दी से जोड़ने के लिए उपयोगी है।",
                "full_app_backup": "पूर्ण एप्लिकेशन बैकअप",
                "full_app_backup_desc": "विषय, अध्याय, प्रगति, सेटिंग्स और गतिविधि लॉग सहित अपने सभी डेटा को एक ही JSON फ़ाइल में निर्यात करें। इस फ़ाइल को बैकअप के रूप में सुरक्षित स्थान पर रखें।",
                "study_report": "स्टडी रिपोर्ट", "download_pdf": "पीडीएफ डाउनलोड करें", "overall_summary": "कुल सारांश",
                "total_subjects": "कुल विषय", "total_chapters": "कुल अध्याय", "progress": "प्रगति",
                "subject_breakdown": "विषयवार विश्लेषण", "completed_on": "को पूरा हुआ", "no_activity_log_report": "अभी तक कोई गतिविधि लॉग नहीं की गई है।",
                "recent_activity": "हाल की गतिविधि", "student_name_placeholder": "अपना नाम दर्ज करें...",
                "source_notes": "नोट्स", "source_book": "बुक", "feature_coming_soon": "यह सुविधा जल्द ही आ रही है!",
                "add_new_reminder": "नया रिमाइंडर जोड़ें", "reminder_text": "रिमाइंडर टेक्स्ट", "reminder_date": "तारीख", "reminder_time": "समय", "save_reminder": "रिमाइंडर सहेजें",
                "no_reminders_set": "कोई रिमाइंडर सेट नहीं है। आरंभ करने के लिए एक जोड़ें!", "mark_done": "पूर्ण",
                "study_notes": "स्टडी नोट्स", "study_notes_placeholder": "जैसे, यह अध्याय परीक्षा के लिए महत्वपूर्ण है...", "priority_revision": "प्राथमिकता रिवीजन के लिए चिह्नित करें",
                "reminder_repeat": "दोहराएँ", "repeat_none": "नहीं दोहराता", "repeat_daily": "रोज़", "repeat_weekly": "साप्ताहिक", "reminder_completed_today": "रिमाइंडर आज के लिए पूरा हुआ",
                "notes_progress": "नोट्स प्रगति", "book_progress": "पुस्तक प्रगति",
                "subject_wise_progress_notes": "विषय प्रगति (नोट्स)", "subject_wise_progress_book": "विषय प्रगति (पुस्तक)",
                "exams": "परीक्षाएं", "exams_and_forms": "परीक्षाएं और भरे हुए फॉर्म", "add_new_exam": "नई परीक्षा जोड़ें", "application_date": "आवेदन तिथि", "exam_date": "परीक्षा तिथि", "notes": "नोट्स",
                "save_exam": "परीक्षा सहेजें", "status_applied": "आवेदन किया गया", "status_admit_card": "एडमिट कार्ड आ गया", "status_exam_done": "परीक्षा हो गई", "status_result_out": "परिणाम आ गया", "applied_on": "आवेदन किया",
                "no_exams_added": "अभी तक कोई परीक्षा नहीं जोड़ी गई है। यहां अपने आवेदन ट्रैक करें!", "all": "सभी", "upcoming_exams": "आगामी परीक्षाएं", "applied_forms": "भरे हुए फॉर्म", "ai_insights": "AI स्टडी कोच ✨",
                "ai_insight_produ_day": "आपका सबसे प्रोडक्टिव दिन {day} लगता है। बढ़िया काम करते रहें!", "ai_insight_stale_subject": "आपने काफी समय से {subject} नहीं पढ़ा है। इसे दोहराने पर विचार करें।",
                "ai_insight_missed_chapters": "आपके {count} अध्याय छूट गए हैं। उन्हें जल्द ही पूरा करने का प्रयास करें।", "ai_insight_start": "स्वागत है! चलिए अध्ययन करने के लिए कुछ अध्याय जोड़कर शुरुआत करते हैं।",
                "notes_placeholder": "उदा., पंजीकरण संख्या, वेबसाइट लिंक...", "delete_exam": "परीक्षा हटाएं", "no_upcoming_exams": "कोई आगामी परीक्षा नहीं है।", "edit_exam": "परीक्षा संपादित करें",
                "application_receipt": "आवेदन रसीद", "view_receipt": "वर्तमान रसीद देखें", "receipt_attached": "रसीद संलग्न है",
                "history_exams": "इतिहास", "no_history_exams": "आपके इतिहास में कोई पिछली परीक्षा नहीं मिली।", "no_upcoming_exams_filter": "कोई आगामी परीक्षा निर्धारित नहीं है।", "no_applied_forms_filter": "'आवेदन किया गया' स्थिति में वर्तमान में कोई फॉर्म नहीं है।",
                // DPT TRANSLATIONS
                "dpt": "DPT", "dpt_page_title": "डेली प्रैक्टिस टेस्ट (DPT)", "all_subjects": "सभी विषय",
                "add_dpt": "DPT जोड़ें", "add_dpt_all": "सभी में DPT जोड़ें", "no_dpt_for_subject": "इस विषय के लिए अभी तक कोई DPT नहीं जोड़ा गया है।", "dpt_progress": "{total} में से {completed} टेस्ट पूरे हुए",
                "todays_dpt": "आज का DPT", "mark_as_complete": "पूर्ण के रूप में चिह्नित करें", "no_dpt_scheduled": "आज के लिए कोई DPT निर्धारित नहीं है।",
                "all_dpt_completed": "आज के सभी DPT पूरे हो गए! बहुत बढ़िया!",
                "enter_dpt_details": "DPT विवरण दर्ज करें", "dpt_total_q": "कुल प्रश्न", "dpt_total_time": "कुल समय", "dpt_attempted": "प्रयास किए",
                "dpt_correct": "सही", "dpt_wrong": "गलत", "dpt_time_taken": "लिया गया समय", "submit": "सबमिट करें",
                "dpt_summary": "DPT सारांश", "total_dpt_completed": "कुल DPT पूरे हुए", "overall_accuracy": "कुल सटीकता",
                "avg_time_per_q": "औसत समय/प्रश्न (से)", "add_new_subject": "नया विषय जोड़ें",
                "enter_subject_name": "नए विषय का नाम दर्ज करें:", "subject_exists": "इस नाम का विषय पहले से मौजूद है।",
                "delete_all": "सभी हटाएं", "delete_all_chapters_confirm": "क्या आप वाकई इस स्रोत के सभी चैप्टर्स को हटाना चाहते हैं? यह क्रिया पूर्ववत् नहीं की जा सकती।",
                "custom_cycle": "कस्टम साइकिल", "custom_study_plan": "कस्टम अध्ययन योजना", "cycle_length": "साइकिल की अवधि (दिन):",
                "save_custom_plan": "कस्टम योजना सहेजें", "day_d": "दिन {day}",
                "dpt_plan_mode": "दैनिक DPT योजना मोड", "dpt_plan_subtitle": "चुनें कि आप अपनी दैनिक DPT योजना कैसे बनाना चाहते हैं।", "dpt_auto_mode": "स्वचालित (अध्ययन योजना के अनुसार)", "custom_dpt_plan": "कस्टम DPT योजना",
                "dpt_report_title": "DPT सारांश", "dpt_subject_breakdown": "DPT विषयवार विश्लेषण", "no_dpt_data_report": "अभी तक कोई DPT डेटा लॉग नहीं किया गया है।",
                "sunday": "रविवार", "monday": "सोमवार", "tuesday": "मंगलवार", "wednesday": "बुधवार", "thursday": "गुरुवार", "friday": "शुक्रवार", "saturday": "शनिवार", "week_2_suffix": "(सप्ताह 2)",
                "delete_subject": "विषय हटाएं", "delete_subject_confirm": "यह विषय '{subjectName}' और इसके सभी चैप्टर्स और DPTs को हटा देगा। यह कार्रवाई पूर्ववत नहीं की जा सकती।",
                "delete_dpt": "DPT हटाएं", "delete_dpt_confirm": "क्या आप वाकई {dptName} को हटाना चाहते हैं? इसका डेटा स्थायी रूप से हट जाएगा।"
            }
        };

        const initialState = {
            subjects: [
                { id: "physics", name: "Physics", chapters: { notes: [], book: [] } },
                { id: "chemistry", name: "Chemistry", chapters: { notes: [], book: [] } },
                { id: "biology", name: "Biology", chapters: { notes: [], book: [] } },
                { id: "geography", name: "Geography", chapters: { notes: [], book: [] } },
                { id: "polity", name: "Polity", chapters: { notes: [], book: [] } },
                { id: "economics", name: "Economics", chapters: { notes: [], book: [] } },
                { id: "history", name: "History", chapters: { notes: [], book: [] } },
                { id: "reasoning", name: "Reasoning", chapters: { notes: [], book: [] } },
                { id: "math", name: "Math", chapters: { notes: [], book: [] } },
                { id: "hindi", name: "Hindi", chapters: { notes: [], book: [] } },
                { id: "static-gk", name: "Static GK", chapters: { notes: [], book: [] } },
                { id: "संविधान-articles", name: "Constitution (Articles)", chapters: { notes: [], book: [] } },
                { id: "maths-formulas", name: "Maths Formulas & Tables", chapters: { notes: [], book: [] } },
                { id: "fill-form", name: "Form Filling / Misc", chapters: { notes: [], book: [] } }
            ],
            settings: {
                theme: 'light',
                planMode: 'auto',
                customCyclePlan: Array(14).fill([]),
                dptPlanMode: 'auto',
                dptCyclePlan: Array(14).fill([]),
                language: 'en', 
                studentName: 'Pravej Ahmad',
                customThemeColors: { start: null, end: null },
                backgroundStyle: 'hexagon', 
                sidebarStyle: 'subtle-shadow'
            },
            gamification: { badges: [], completedHistory: [] },
            activityLog: [], appStartDate: new Date().toISOString().split('T')[0],
            postponedChapters: [],
            missedChapters: [],
            dailyPlan: {},
            lastCheckedDate: null,
            exams: [],
            dpts: {},
            dailyDptPlan: {},
        };

        let data;
        
        try {
            const savedData = localStorage.getItem(DB_KEY);
            data = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(initialState));
        } catch (error) {
            console.error("Error parsing saved data, resetting to initial state.", error);
            data = JSON.parse(JSON.stringify(initialState));
        }
        
        // --- DATA INTEGRITY AND MIGRATION ---
        data.settings = {...initialState.settings, ...data.settings};
        
        data.postponedChapters = data.postponedChapters || [];
        data.missedChapters = data.missedChapters || [];
        data.dailyPlan = data.dailyPlan || {};
        data.lastCheckedDate = data.lastCheckedDate || new Date().toISOString().split('T')[0];
        data.exams = data.exams || [];
        data.dpts = data.dpts || {};
        data.dailyDptPlan = data.dailyDptPlan || {};
        
        data.settings.backgroundStyle = data.settings.backgroundStyle || 'hexagon'; 
        
        if(data.settings.weeklyPlan) {
            data.settings.customCyclePlan = [...Object.values(data.settings.weeklyPlan), ...Array(7).fill([])];
            delete data.settings.weeklyPlan;
        }
        if(!data.settings.customCyclePlan || data.settings.customCyclePlan.length !== 14) {
            const oldPlan = data.settings.customCyclePlan || [];
            data.settings.customCyclePlan = Array(14).fill([]).map((_, i) => oldPlan[i] || []);
        }
        if(!data.settings.dptCyclePlan || data.settings.dptCyclePlan.length !== 14) {
             const oldDptPlan = data.settings.dptCyclePlan || [];
            data.settings.dptCyclePlan = Array(14).fill([]).map((_, i) => oldDptPlan[i] || []);
        }
        delete data.settings.cycleLength; 
        delete data.settings.dptCycleLength; 


        (data.exams || []).forEach(exam => { if(typeof exam.receipt === 'undefined') exam.receipt = null; });
        
        // Remove any old target data if it exists
        if (data.targets) delete data.targets;
        if (data.settings && data.settings.deadline) delete data.settings.deadline;
        
        (data.subjects || []).forEach(s => {
            if (Array.isArray(s.chapters)) s.chapters = { notes: s.chapters, book: [] };
            s.chapters = s.chapters || { notes: [], book: [] };
            s.chapters.notes = s.chapters.notes || [];
            s.chapters.book = s.chapters.book || [];
            
            const migrateChapter = c => {
                if (typeof c.notes === 'undefined') c.notes = '';
                if (typeof c.priorityRevision === 'undefined') c.priorityRevision = false;
                if (c.status === 'In Progress') c.status = 'Not Started';
                if (!Array.isArray(c.revisions)) c.revisions = [];
            };
            s.chapters.notes.forEach(migrateChapter);
            s.chapters.book.forEach(migrateChapter);
        });

        const saveData = () => {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(data));
            } catch (error) {
                console.error("Failed to save data to localStorage:", error);
                alert("Could not save your progress. Your browser's storage might be full or in private mode.");
            }
        };
        
        const _ = (key, replacements = {}) => {
            const lang = data.settings.language || 'en';
            let text = translations[lang]?.[key] || translations['en'][key];
            if (text === undefined) {
                const subject = (data.subjects || []).find(s => s.id === key);
                text = subject ? subject.name : key;
            }
            if(text === undefined) return key;

            Object.keys(replacements).forEach(placeholder => {
                text = text.replace(`{${placeholder}}`, replacements[placeholder]);
            });
            return text;
        };

        const applyTranslations = () => {
            document.querySelectorAll('[data-translate]').forEach(el => el.innerText = _(el.dataset.translate));
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => el.placeholder = _(el.dataset.translatePlaceholder));
            updateAllUI();
        };
        
        const dailyPattern = [
            // Week 1
            ["physics:notes", "history:notes", "math:notes", "static-gk:notes"], // Sunday
            ["chemistry:notes", "history:notes", "math:notes", "संविधान-articles:notes"], // Monday
            ["biology:notes", "history:notes", "math:notes", "maths-formulas:notes"], // Tuesday
            ["physics:notes", "history:notes", "math:notes", "static-gk:notes"], // Wednesday
            ["chemistry:notes", "history:notes", "math:notes", "संविधान-articles:notes"], // Thursday
            ["biology:notes", "history:notes", "math:notes", "maths-formulas:notes"], // Friday
            ["math:notes", "reasoning:notes", "fill-form:notes"], // Saturday
            // Week 2
            ["polity:notes", "history:notes", "math:notes", "static-gk:notes"],  // Sunday (Week 2)
            ["hindi:notes", "history:notes", "math:notes", "संविधान-articles:notes"], // Monday (Week 2)
            ["geography:notes", "history:notes", "math:notes", "maths-formulas:notes"], // Tuesday (Week 2)
            ["economics:notes", "history:notes", "math:notes", "static-gk:notes"], // Wednesday (Week 2)
            ["polity:notes", "history:notes", "math:notes", "संविधान-articles:notes"], // Thursday (Week 2)
            ["geography:notes", "history:notes", "math:notes", "maths-formulas:notes"], // Friday (Week 2)
            ["economics:notes", "math:notes", "reasoning:notes", "fill-form:notes"]  // Saturday (Week 2)
        ];

        let allCharts = {};
        let currentExamFilter = 'all';

        const pages = document.querySelectorAll('.page');
        const navBtns = document.querySelectorAll('.nav-btn');
        const themeToggleBtns = [document.getElementById('theme-toggle-btn'), document.getElementById('theme-toggle-btn-mobile')];
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const undoToast = document.getElementById('undo-toast');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');

        let animationFrameId;
        const particleCanvas = document.getElementById('particle-canvas');
        const ctx = particleCanvas.getContext('2d');
        let backgroundElements = [];

        const init = () => {
            handleNewDayLogic();
            applyTheme(data.settings.theme);
            applyBackgroundStyle();
            applyCustomTheme();
            lucide.createIcons();
            addEventListeners();
            applyTranslations();
            if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            navigateTo('home');
        };
        
        const showUndoToast = (message, onUndo) => {
            clearTimeout(undoTimeout);
            document.getElementById('undo-message').textContent = message;
            const undoBtn = document.getElementById('undo-btn');
            const newUndoBtn = undoBtn.cloneNode(true);
            newUndoBtn.textContent = _('undo');
            undoBtn.parentNode.replaceChild(newUndoBtn, undoBtn);
            const undoHandler = () => { onUndo(); hideUndoToast(); };
            newUndoBtn.addEventListener('click', undoHandler, { once: true });
            undoToast.classList.add('show');
            undoTimeout = setTimeout(hideUndoToast, 6000);
        };

        const hideUndoToast = () => {
            clearTimeout(undoTimeout);
            undoToast.classList.remove('show');
        };

        const handleNewDayLogic = () => {
            const todayStr = new Date().toISOString().split('T')[0];
            if (data.lastCheckedDate === todayStr) return;

            const yesterdayStr = data.lastCheckedDate || new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().split('T')[0];
            const yesterdayPlanData = data.dailyPlan[yesterdayStr];
            if (yesterdayPlanData?.tasks) {
                yesterdayPlanData.completedSubjects = yesterdayPlanData.completedSubjects || [];
                Object.entries(yesterdayPlanData.tasks).forEach(([key, task]) => {
                    if (task?.subjectId && task.chapterId && !yesterdayPlanData.completedSubjects.includes(key)) {
                        const chapter = getChapterByIds(task.subjectId, task.chapterId, task.sourceType);
                        if (chapter && chapter.status !== 'Completed' && !data.missedChapters.some(c => c.chapterId === task.chapterId)) {
                            data.missedChapters.push({ subjectId: task.subjectId, chapterId: task.chapterId, sourceType: task.sourceType, date: yesterdayStr });
                        }
                    }
                });
            }

            data.lastCheckedDate = todayStr;
            Object.keys(data.dailyPlan).forEach(date => { if (new Date(todayStr) - new Date(date) > 7 * 24 * 60 * 60 * 1000) { delete data.dailyPlan[date]; } });
            Object.keys(data.dailyDptPlan).forEach(date => { if (new Date(todayStr) - new Date(date) > 7 * 24 * 60 * 60 * 1000) { delete data.dailyDptPlan[date]; } });

            saveData();
        };

        const updateAllUI = () => {
            const activePageId = document.querySelector('.page.active')?.id.replace('page-', '');
            const pageRenderFunctions = {
                home: renderHomePage, subjects: renderSubjectsPage, dpt: renderDptPage,
                analytics: renderAnalyticsPage, settings: renderSettingsPage, calendar: renderCalendarPage,
                report: renderReportPage, 'import-export': renderImportExportPage,
                exams: renderExamsPage
            };
            if(activePageId && pageRenderFunctions[activePageId]) {
                 pageRenderFunctions[activePageId]();
            } else {
                renderHomePage();
            }
        };
        
        const applyTheme = (theme) => {
            document.documentElement.className = theme;
            const isDark = theme === 'dark';
            ['theme-icon-sun', 'theme-icon-sun-mobile'].forEach(id => document.getElementById(id).style.display = isDark ? 'none' : 'block');
            ['theme-icon-moon', 'theme-icon-moon-mobile'].forEach(id => document.getElementById(id).style.display = isDark ? 'block' : 'none');
            applyCustomTheme();
            if (document.getElementById('page-analytics').classList.contains('active')) renderAnalyticsPage();
            if (data.settings.backgroundStyle !== 'default') {
                stopAllBackgroundAnimations();
                applyBackgroundStyle();
            }
        };
        
        const applyCustomTheme = () => {
            const { start, end } = data.settings.customThemeColors;
            const root = document.documentElement;
            const isDark = data.settings.theme === 'dark';
            const startProp = isDark ? '--main-bg-start-dark' : '--main-bg-start-light';
            const endProp = isDark ? '--main-bg-end-dark' : '--main-bg-end-light';
            if (start && end) {
                root.style.setProperty(startProp, start);
                root.style.setProperty(endProp, end);
            } else {
                root.style.removeProperty(startProp);
                root.style.removeProperty(endProp);
            }
        };

        const toggleTheme = () => {
            data.settings.theme = (data.settings.theme === 'light') ? 'dark' : 'light';
            saveData();
            applyTheme(data.settings.theme);
        };
        
        const toggleSidebar = () => {
            sidebar.classList.toggle('w-64');
            sidebar.classList.toggle('w-20');
            sidebar.classList.toggle('sidebar-collapsed');
            sidebarToggleBtn.querySelector('i').setAttribute('data-lucide', sidebar.classList.contains('sidebar-collapsed') ? 'chevrons-right' : 'chevrons-left');
            lucide.createIcons();
        };

        const updateNavHighlight = (pageId) => {
            navBtns.forEach(b => { b.classList.toggle('text-primary', b.dataset.page === pageId); b.classList.toggle('bg-sky-100', b.dataset.page === pageId); b.classList.toggle('dark:bg-sky-900/50', b.dataset.page === pageId); });
            document.querySelectorAll('.mobile-nav-btn').forEach(b => { b.classList.toggle('active', b.dataset.page === pageId); });
        };
        
        const navigateTo = (pageId) => {
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`)?.classList.add('active');
            updateNavHighlight(pageId);
            const renderFunctions = {
                home: renderHomePage, subjects: renderSubjectsPage, dpt: renderDptPage, calendar: renderCalendarPage,
                settings: renderSettingsPage, report: renderReportPage,
                'import-export': renderImportExportPage,
                exams: renderExamsPage,
                analytics: () => requestAnimationFrame(renderAnalyticsPage)
            };
            renderFunctions[pageId]?.();
        };
        
        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        const getCycleDayIndex = (date) => {
            const dayOfWeek = date.getDay(); 
            const weekNumber = getWeekNumber(date);
            const isSecondWeekOfCycle = weekNumber % 2 === 0;
            return dayOfWeek + (isSecondWeekOfCycle ? 7 : 0);
        };

        const getSubjectById = (id) => (data.subjects || []).find(s => s.id === id);
        const getChapterByIds = (subjectId, chapterId, sourceType) => {
            const subject = getSubjectById(subjectId);
            return subject?.chapters?.[sourceType]?.find(c => c.id === chapterId) || null;
        };

        const logActivity = (icon, description) => {
            data.activityLog.unshift({ timestamp: new Date().toISOString(), icon, description });
            if (data.activityLog.length > 100) data.activityLog.pop();
            saveData();
            if (document.getElementById('page-report')?.classList.contains('active')) renderReportPage();
        };

        const renderHomePage = () => {
            document.getElementById('welcome-heading').innerHTML = `${_('welcome_pravej')}, <span class="text-primary">${data.settings.studentName || 'Student'}!</span>`;
            renderAIInsights();
            renderTodaysDpt(); 
            renderTodaysPlan();
            renderTomorrowsPlan();
            renderYesterdaysActivity();
            renderMissedChapters();
            renderPostponedChapters();
            renderUpcomingExamsOnDashboard();
            renderOverallProgress();
            renderUpcomingRevisions();
            renderBadges();
            renderSubjectWiseProgressDashboard();
        };

        const renderAIInsights = () => {
            const container = document.getElementById('ai-insights-container');
            const insights = [];
            const completedChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]).filter(c => c.status === 'Completed');
            if ((data.missedChapters || []).length > 0) { insights.push(_('ai_insight_missed_chapters', {count: data.missedChapters.length})); }
            if ((data.gamification.completedHistory || []).length > 5) {
                const dayCounts = [0,0,0,0,0,0,0];
                data.gamification.completedHistory.forEach(dateStr => { const date = new Date(dateStr); if(!isNaN(date.getTime())) dayCounts[date.getDay()]++; });
                const maxDayIndex = dayCounts.indexOf(Math.max(...dayCounts));
                const dayName = new Date(2024, 0, maxDayIndex).toLocaleString((data.settings.language === 'hi' ? 'hi-IN' : 'en-US'), { weekday: 'long' });
                insights.push(_('ai_insight_produ_day', { day: dayName }));
            }
            const lastStudied = {};
            (data.subjects || []).forEach(subject => {
                const allChapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])];
                const completedInSubject = allChapters.filter(c => c.dateCompleted);
                if(completedInSubject.length > 0) {
                    const lastDate = completedInSubject.reduce((latest, current) => new Date(current.dateCompleted) > new Date(latest) ? current.dateCompleted : latest, completedInSubject[0].dateCompleted);
                    lastStudied[subject.id] = lastDate;
                }
            });
            const staleSubjects = Object.keys(lastStudied).map(id => ({id, date: new Date(lastStudied[id])})).sort((a,b) => a.date - b.date);
            if (staleSubjects.length > 2 && (new Date() - staleSubjects[0].date > 7 * 24 * 60 * 60 * 1000)) { insights.push(_('ai_insight_stale_subject', {subject: _(staleSubjects[0].id)})); }
            const upcomingExam = (data.exams || []).filter(e => e.examDate && new Date(e.examDate) >= new Date()).sort((a,b) => new Date(a.examDate) - new Date(b.date))[0];
            if (upcomingExam) {
                const daysRemaining = Math.ceil((new Date(upcomingExam.examDate) - new Date()) / 86400000);
                if (daysRemaining <= 14) { insights.push(`Your ${upcomingExam.name} exam is in ${daysRemaining} days. Time to intensify your revisions!`); }
            }
            let finalInsight = (insights.length > 0) ? insights[Math.floor(Math.random() * insights.length)] : _('ai_insight_start');
            container.innerHTML = `<div class="flex items-center gap-3 pb-3 border-b border-accent/20 mb-3"><i data-lucide="sparkles" class="w-6 h-6 text-accent"></i><h2 class="text-lg font-bold text-accent">${_('ai_insights')}</h2></div><p class="text-sm text-text-muted-light dark:text-text-muted-dark">${finalInsight}</p>`;
            lucide.createIcons();
        };
        
        const getSubjectsForDay = (date = new Date()) => {
            const dayIndex = getCycleDayIndex(date);
            if (data.settings.planMode === 'custom_cycle') { return (data.settings.customCyclePlan || [])[dayIndex] || []; }
            return dailyPattern[dayIndex] || [];
        };
        
        const markSubjectAsDoneForToday = (subjectSourcePair) => {
            const todayStr = new Date().toISOString().split('T')[0];
            const plan = data.dailyPlan[todayStr] = data.dailyPlan[todayStr] || { tasks: {}, completedSubjects: [] };
            if (!plan.completedSubjects.includes(subjectSourcePair)) { plan.completedSubjects.push(subjectSourcePair); }
            saveData();
            renderHomePage(); 
        };

        const postponeChapter = (subjectId, chapterId, sourceType) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            document.querySelector(`li [data-chapter-id="${chapterId}"]`)?.closest('.task-list-item')?.classList.add('completed');
            setTimeout(() => {
                const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                data.postponedChapters = data.postponedChapters.filter(p => p.chapterId !== chapterId);
                data.postponedChapters.push({ subjectId, chapterId, sourceType, date: tomorrowStr });
                logActivity('skip-forward', `Chapter postponed to tomorrow: "${chapter.name}"`);
                markSubjectAsDoneForToday(`${subjectId}:${sourceType}`);
                // BUG FIX: The following line was deleting the plan for tomorrow every time a chapter was postponed,
                // causing only the last postponed chapter to be saved. It has been removed.
                // delete data.dailyPlan[tomorrowStr];
            }, 500);
        };
        
        const skipChapter = (subjectId, chapterId, sourceType) => {
            const subject = getSubjectById(subjectId); if (!subject) return;
            const availableChapters = (subject.chapters[sourceType] || []).filter(c => c.status !== 'Completed');
            if (availableChapters.length > 1) {
                const currentIndex = availableChapters.findIndex(c => c.id === chapterId);
                const newChapter = availableChapters[(currentIndex + 1) % availableChapters.length];
                const todayStr = new Date().toISOString().split('T')[0];
                const planKey = `${subjectId}:${sourceType}`;
                if (data.dailyPlan[todayStr]?.tasks?.[planKey]) {
                    data.dailyPlan[todayStr].tasks[planKey].chapterId = newChapter.id;
                    logActivity('chevrons-right', `Skipped to new chapter: "${newChapter.name}"`);
                    saveData(); renderHomePage();
                }
            } else { logActivity('chevrons-right', `Skipped chapter "${getChapterByIds(subjectId, chapterId, sourceType)?.name}", but no other chapters are available.`); }
        };
        
        const getOrGenerateDailyPlan = (dateStr) => {
            if (!data.dailyPlan[dateStr]) { data.dailyPlan[dateStr] = { tasks: {}, completedSubjects: [], manualTasks: [] }; }
            if (Object.keys(data.dailyPlan[dateStr].tasks).length === 0 && !data.dailyPlan[dateStr].planGeneratedForDay) {
                const plan = { tasks: {}, completedSubjects: [], manualTasks: data.dailyPlan[dateStr].manualTasks || [] };
                const chaptersAlreadyUsed = new Set();
                (data.postponedChapters || []).filter(p => p.date === dateStr).forEach(p => {
                    const chapter = getChapterByIds(p.subjectId, p.chapterId, p.sourceType);
                    if (chapter?.status !== 'Completed') {
                        const planKey = `${p.subjectId}:${p.sourceType}`;
                        if (!plan.tasks[planKey]) { plan.tasks[planKey] = { subjectId: p.subjectId, chapterId: p.chapterId, sourceType: p.sourceType }; chaptersAlreadyUsed.add(p.chapterId); }
                    }
                });
                data.postponedChapters = (data.postponedChapters || []).filter(p => p.date !== dateStr);
                getSubjectsForDay(new Date(dateStr)).forEach(pair => {
                    if (plan.tasks[pair]) return;
                    const [subjectId, sourceType] = pair.split(':');
                    const subject = getSubjectById(subjectId); if (!subject) return;
                    const availableChapters = (subject.chapters[sourceType] || []).filter(c => c.status !== 'Completed' && !chaptersAlreadyUsed.has(c.id));
                    
                    // --- MODIFICATION START: Select a random chapter instead of the first one ---
                    if (availableChapters.length > 0) {
                        const randomIndex = Math.floor(Math.random() * availableChapters.length);
                        const chapter = availableChapters[randomIndex]; 
                        plan.tasks[pair] = { subjectId, chapterId: chapter.id, sourceType }; 
                        chaptersAlreadyUsed.add(chapter.id); 
                    }
                    // --- MODIFICATION END ---
                });
                data.dailyPlan[dateStr] = plan;
                data.dailyPlan[dateStr].planGeneratedForDay = true;
                saveData();
            }
            return data.dailyPlan[dateStr];
        };

        const renderTodaysPlan = () => {
            const container = document.getElementById('todays-plan-container');
            const todayStr = new Date().toISOString().split('T')[0];
            const dailyPlanData = getOrGenerateDailyPlan(todayStr);
            const tasks = dailyPlanData.tasks || {};
            const manualTasks = dailyPlanData.manualTasks || [];
            const completedSubjects = dailyPlanData.completedSubjects || [];
            
            const chaptersToStudy = Object.entries(tasks).filter(([key]) => !completedSubjects.includes(key)).map(([, task]) => {
                if (!task) return null;
                const subject = getSubjectById(task.subjectId); const chapter = getChapterByIds(task.subjectId, task.chapterId, task.sourceType);
                return (subject && chapter && chapter.status !== 'Completed') ? { subject, chapter, sourceType: task.sourceType } : null;
            }).filter(Boolean);

            const revisionsForToday = [];
            (data.subjects || []).forEach(s => {
                const findRevisions = (chapters, sourceType) => (chapters || []).forEach(c => (c.revisions || []).forEach(r => { if(r.status === 'Pending' && r.date === todayStr) revisionsForToday.push({ subject: s, chapter: c, revision: r, sourceType }); }));
                findRevisions(s.chapters.notes, 'notes'); findRevisions(s.chapters.book, 'book');
            });

            let planHtml = `<div class="flex items-center justify-between pb-3 border-b border-primary/20 mb-4">
                <div class="flex items-center gap-3"><i data-lucide="clipboard-list" class="w-6 h-6 text-primary"></i><h2 class="text-lg font-bold text-primary">${_('todays_plan')} (${new Date().toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-US', { weekday: 'long' })})</h2></div>
                <button id="manual-add-task-btn" class="p-1.5 rounded-full hover:bg-sky-200 dark:hover:bg-sky-800"><i data-lucide="plus-circle" class="w-5 h-5 text-primary"></i></button>
            </div>`;
            
            const allTasksForToday = [
                ...chaptersToStudy, 
                ...revisionsForToday,
                ...(manualTasks.filter(task => {
                    const chapter = getChapterByIds(task.subjectId, task.chapterId, task.sourceType);
                    return chapter && chapter.status !== 'Completed';
                }))
            ];

            if (allTasksForToday.length > 0) {
                planHtml += `<ul class="space-y-3">`;
                const renderTask = (item, isRevision = false, isManual = false) => {
                    const { subject, chapter, sourceType, revision } = item;
                    const chapterObj = isManual ? getChapterByIds(item.subjectId, item.chapterId, item.sourceType) : chapter;
                    const subjectObj = isManual ? getSubjectById(item.subjectId) : subject;
                    if (!chapterObj || !subjectObj) return '';

                    const uniqueId = isManual ? `manual-${item.id}` : (isRevision ? `revision-${subject.id}-${chapter.id}-${revision.date}` : `task-${subject.id}-${chapter.id}`);
                    const sourceBadge = `<span class="source-badge ${item.sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${_(item.sourceType === 'book' ? 'source_book' : 'source_notes')}</span>`;
                    const bgColor = isManual ? 'bg-indigo-50 dark:bg-indigo-900/40' : (isRevision ? 'bg-amber-50 dark:bg-amber-900/40' : 'bg-card-light dark:bg-card-dark shadow-sm');
                    const checkboxClass = isRevision ? 'revision-checkbox text-amber-500' : 'task-checkbox text-primary';
                    const labelText = isRevision ? _('revision_task', {chapterName: chapter.name}) : chapterObj.name;
                    
                    let subText = `<p class="text-sm ${isRevision ? 'text-amber-600 dark:text-amber-300' : 'text-sky-600 dark:text-sky-300'} flex items-center gap-1.5">${isRevision ? '<i data-lucide="repeat" class="w-3 h-3"></i> ' : ''}${_(subjectObj.id)} ${sourceBadge}</p>`;
                    if(isManual) subText = `<p class="text-sm text-indigo-600 dark:text-indigo-300 flex items-center gap-1.5"><i data-lucide="hand" class="w-3 h-3"></i> ${_(subjectObj.id)} ${sourceBadge}</p>`;

                    const actionButtons = isManual ? `
                        <button class="manual-task-delete-btn p-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900/50" title="Delete Manual Task" data-manual-id="${item.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button>
                        ` : `
                        <div class="flex gap-1">
                            <button class="task-action-btn postpone-btn p-1.5 rounded hover:bg-yellow-100 dark:hover:bg-yellow-900/50" title="${_('postpone_tomorrow')}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" data-source-type="${sourceType}" ${isRevision ? `data-revision-date="${revision.date}"` : ''}><i data-lucide="skip-forward" class="w-4 h-4 text-yellow-600"></i></button>
                            <button class="task-action-btn skip-btn p-1.5 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50" title="${_('skip_chapter')}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" data-source-type="${sourceType}" ${isRevision ? `data-revision-date="${revision.date}"` : ''}><i data-lucide="chevrons-right" class="w-4 h-4 text-blue-600"></i></button>
                        </div>`;
                    
                    return `<li class="task-list-item p-3 rounded-lg flex items-center gap-3 ${bgColor} animate-list-item" data-manual-id="${isManual ? item.id : ''}">
                        <input type="checkbox" id="${uniqueId}" class="${checkboxClass} h-5 w-5 rounded border-gray-300 flex-shrink-0" data-subject-id="${subjectObj.id}" data-chapter-id="${chapterObj.id}" data-source-type="${item.sourceType}" ${isRevision ? `data-revision-date="${revision.date}"` : ''} ${isManual ? `data-is-manual="true"` : `data-subject-source-pair="${subject.id}:${sourceType}"`}>
                        <label for="${uniqueId}" class="flex-grow cursor-pointer"><p class="font-semibold">${labelText}</p>${subText}</label>
                        ${actionButtons}</li>`;
                };

                chaptersToStudy.forEach(task => planHtml += renderTask(task));
                revisionsForToday.forEach(task => planHtml += renderTask(task, true));
                manualTasks.forEach(task => planHtml += renderTask(task, false, true));

                planHtml += `</ul>`;
            } else {
                planHtml += `<div class="text-center py-8 flex flex-col items-center justify-center text-text-muted-light dark:text-text-muted-dark"><i data-lucide="party-popper" class="w-12 h-12 text-accent mx-auto mb-4"></i><h3 class="text-lg font-bold">${_('congratulations')}</h3><p>${_('all_tasks_completed')}</p></div>`;
            }
            container.innerHTML = planHtml;
            lucide.createIcons();
        };

        const renderTomorrowsPlan = () => {
            const container = document.getElementById('tomorrows-plan-container');
            const tomorrowStr = new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().split('T')[0];
            const chaptersForTomorrow = Object.values(getOrGenerateDailyPlan(tomorrowStr).tasks || {}).map(task => {
                const subject = getSubjectById(task.subjectId); const chapter = getChapterByIds(task.subjectId, task.chapterId, task.sourceType);
                return (subject && chapter) ? { subject, chapter, sourceType: task.sourceType } : null;
            }).filter(Boolean);
            if (chaptersForTomorrow.length === 0) { container.innerHTML = `<p class="text-center text-sm">No topics scheduled for tomorrow.</p>`; return; }
            container.innerHTML = chaptersForTomorrow.map(({ subject, chapter, sourceType }) => {
                const sourceBadge = `<span class="source-badge ${sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${_(sourceType === 'book' ? 'source_book' : 'source_notes')}</span>`;
                return `<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg animate-list-item"><div><p class="font-semibold">${chapter.name}</p><p class="text-xs">${_(subject.id)} ${sourceBadge}</p></div><i data-lucide="arrow-right-circle" class="w-5 h-5 text-primary"></i></div>`
            }).join('');
            lucide.createIcons();
        };

        const renderYesterdaysActivity = () => {
            const container = document.getElementById('yesterdays-completed-container');
            const yesterdayStr = new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().split('T')[0];
            const completedYesterday = [];
            (data.subjects || []).forEach(subject => {
                const findCompleted = (chapters, sourceType) => (chapters || []).forEach(chapter => { if (chapter.dateCompleted === yesterdayStr) completedYesterday.push({ subject, chapter, sourceType }); });
                findCompleted(subject.chapters.notes, 'notes'); findCompleted(subject.chapters.book, 'book');
            });
            if (completedYesterday.length === 0) { container.innerHTML = `<p class="text-center text-sm">${_('no_chapters_yesterday')}</p>`; return; }
            container.innerHTML = completedYesterday.map(({ subject, chapter, sourceType }) => {
                 const sourceBadge = `<span class="source-badge ${sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${sourceType === 'book' ? 'B' : 'N'}</span>`;
                 return `<div class="flex items-center gap-3 p-3 bg-green-50 dark:bg-green-900/50 rounded-lg animate-list-item"><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i><div><p class="font-semibold">${chapter.name} ${sourceBadge}</p><p class="text-xs">${_(subject.id)}</p></div></div>`;
            }).join('');
            lucide.createIcons();
        };

        // --- MODIFICATION START: Update render functions to use "See More" ---
        const renderMissedChapters = () => {
            const container = document.getElementById('missed-chapters-list');
            const allMissed = (data.missedChapters || []).sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allMissed.length === 0) {
                container.innerHTML = `<p class="text-center text-sm">${_('no_missed_chapters')}</p>`;
                return;
            }

            const isExpanded = dashboardViewState.missed;
            const itemsToShow = isExpanded ? allMissed : allMissed.slice(0, 4);

            let html = itemsToShow.map(item => {
                const subject = getSubjectById(item.subjectId);
                const chapter = getChapterByIds(item.subjectId, item.chapterId, item.sourceType);
                if (!subject || !chapter) return '';
                const sourceBadge = `<span class="source-badge ${item.sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${item.sourceType === 'book' ? 'B' : 'N'}</span>`;
                const missedDateFormatted = new Date(item.date).toLocaleDateString((data.settings.language === 'hi' ? 'hi-IN' : 'en-GB'), { weekday: 'short', day: 'numeric' });
                return `<div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/50 rounded-lg animate-list-item"><div><p class="font-semibold">${chapter.name} ${sourceBadge}</p><p class="text-xs">${_(subject.id)} - <span class="font-medium text-red-700 dark:text-red-300">${missedDateFormatted}</span></p></div><i data-lucide="alert-circle" class="w-5 h-5 text-danger"></i></div>`;
            }).join('');
            
            if (allMissed.length > 4) {
                html += `<div class="mt-2 text-center"><button class="toggle-view-btn text-sm font-semibold text-primary hover:underline" data-section="missed">${isExpanded ? 'See Less' : `See More (${allMissed.length - 4} more)`}</button></div>`;
            }

            container.innerHTML = html;
            lucide.createIcons();
        };

        const renderPostponedChapters = () => {
            const container = document.getElementById('postponed-chapters-list');
            const allPostponed = (data.postponedChapters || []).filter(p => p.date >= new Date().toISOString().split('T')[0]).sort((a, b) => new Date(a.date) - new Date(b.date));
            if (allPostponed.length === 0) { container.innerHTML = `<p class="text-center text-sm">${_('no_postponed_chapters')}</p>`; return; }

            const isExpanded = dashboardViewState.postponed;
            const itemsToShow = isExpanded ? allPostponed : allPostponed.slice(0, 4);
            
            let html = itemsToShow.map(item => {
                const subject = getSubjectById(item.subjectId); const chapter = getChapterByIds(item.subjectId, item.chapterId, item.sourceType);
                if (!subject || !chapter) return '';
                const sourceBadge = `<span class="source-badge ${item.sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${item.sourceType === 'book' ? 'B' : 'N'}</span>`;
                const dateText = new Date(item.date).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB', { weekday: 'long', month: 'short', day: 'numeric' });
                return `<div class="flex items-center justify-between p-3 bg-yellow-50 dark:bg-yellow-900/50 rounded-lg animate-list-item"><div><p class="font-semibold">${chapter.name} ${sourceBadge}</p><p class="text-xs">${_(subject.id)}</p></div><div class="text-right text-sm font-semibold text-yellow-600">${dateText}</div></div>`;
            }).join('');
            
            if (allPostponed.length > 4) {
                 html += `<div class="mt-2 text-center"><button class="toggle-view-btn text-sm font-semibold text-primary hover:underline" data-section="postponed">${isExpanded ? 'See Less' : `See More (${allPostponed.length - 4} more)`}</button></div>`;
            }
            container.innerHTML = html;
        };

        const renderUpcomingRevisions = () => {
            const container = document.getElementById('revisions-container');
            const today = new Date(); today.setHours(0,0,0,0);
            const upcoming = [];
            (data.subjects || []).forEach(s => {
                const findRevisions = (chapters, sourceType) => (chapters || []).forEach(c => (c.revisions || []).forEach(r => { if(r.status === 'Pending' && new Date(r.date) >= today) upcoming.push({ ...r, chapter: c, subject: s, sourceType }); }));
                findRevisions(s.chapters.notes, 'notes'); findRevisions(s.chapters.book, 'book');
            });
            upcoming.sort((a,b) => new Date(a.date) - new Date(b.date));
            if(upcoming.length === 0) { container.innerHTML = `<p class="text-center text-sm py-4">${_('no_upcoming_revisions')}</p>`; return; }

            const isExpanded = dashboardViewState.revisions;
            const itemsToShow = isExpanded ? upcoming : upcoming.slice(0, 4);

            let html = itemsToShow.map(item => {
                const diffDays = Math.ceil((new Date(item.date) - today) / 86400000);
                let dateText = diffDays === 0 ? `<span class="font-bold text-danger">${_('today')}</span>` : (diffDays === 1 ? `<span class="font-semibold text-warning">${_('tomorrow')}</span>` : `${new Date(item.date).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB', { month: 'short', day: 'numeric' })}`);
                const sourceBadge = `<span class="source-badge ${item.sourceType === 'book' ? 'source-badge-book' : 'source-badge-notes'}">${item.sourceType === 'book' ? 'B' : 'N'}</span>`;
                return `<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg animate-list-item"><div><p class="font-semibold">${item.chapter.name} ${sourceBadge}</p><p class="text-xs">${_(item.subject.id)}</p></div><div class="text-right text-sm">${dateText}</div></div>`
            }).join('');

            if (upcoming.length > 4) {
                 html += `<div class="mt-2 text-center"><button class="toggle-view-btn text-sm font-semibold text-primary hover:underline" data-section="revisions">${isExpanded ? 'See Less' : `See More (${upcoming.length - 4} more)`}</button></div>`;
            }

            container.innerHTML = html;
            lucide.createIcons();
        };
        // --- MODIFICATION END ---
        
        const renderOverallProgress = () => {
            const allChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]);
            const completed = allChapters.filter(c => c.status === 'Completed').length;
            const total = allChapters.length; const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('chapters-completed-count').textContent = `${completed} / ${total}`;
            document.getElementById('overall-progress-text').textContent = `${percentage}%`;
            const chartId = 'overall-progress-chart';
            if (allCharts[chartId]) allCharts[chartId].destroy();
            allCharts[chartId] = new Chart(document.getElementById(chartId), { type: 'doughnut', data: { datasets: [{ data: [percentage, 100 - percentage], backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--primary'), data.settings.theme === 'dark' ? '#374151' : '#e5e7eb'], borderWidth: 0, borderRadius: 5 }] }, options: { responsive: true, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
        };

        const renderSubjectWiseProgressDashboard = () => {
            const container = document.getElementById('subject-progress-dashboard-container');
            const titleEl = document.getElementById('subject-progress-title');
            if (!container || !titleEl) return;
            titleEl.textContent = dashboardProgressView === 'notes' ? _('subject_wise_progress_notes') : _('subject_wise_progress_book');
            let content = '';
            (data.subjects || []).forEach(subject => {
                const chapters = subject.chapters[dashboardProgressView];
                if (chapters && chapters.length > 0) {
                    const completed = chapters.filter(c => c.status === 'Completed').length; const percentage = Math.round((completed / chapters.length) * 100);
                    content += `<div class="animate-list-item"><div class="flex justify-between items-center mb-1 text-sm"><span class="font-semibold">${_(subject.id)}</span><span class="text-text-muted-light">${percentage}%</span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2"><div class="bg-primary h-2 rounded-full animated-progress-bar" style="width: ${percentage}%"></div></div></div>`;
                }
            });
            container.innerHTML = content || `<p class="text-center text-xs py-2">${_('add_chapters_prompt')}</p>`;
        };

        const renderBadges = () => {
            const container = document.getElementById('badges-container');
            let html = '';
            const completedCount = (data.gamification.completedHistory || []).length;
            let progressHtml = '';
            if (!(data.gamification.badges || []).includes('ten_completed')) {
                const progress = Math.min(100, (completedCount / 10) * 100);
                const badgeInfo = BADGES['ten_completed'];
                progressHtml = `<div class="mb-3"><p class="text-sm font-semibold text-center mb-2">Next: ${_('scholar')}</p><div class="flex items-center gap-3"><i data-lucide="${badgeInfo.icon}" class="${badgeInfo.color} w-6 h-6"></i><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div class="bg-amber-500 h-2.5 rounded-full animated-progress-bar" style="width: ${progress}%"></div></div><span class="text-xs font-bold">${completedCount}/10</span></div></div>`;
            }
            const allBadgesHtml = Object.entries(BADGES).map(([badgeId, badge]) => {
                const isUnlocked = (data.gamification.badges || []).includes(badgeId);
                const iconClass = isUnlocked ? badge.color : 'text-gray-400 dark:text-gray-600 opacity-50';
                return `<div class="flex flex-col items-center text-center p-1" title="${_(badge.description)}"><i data-lucide="${badge.icon}" class="w-8 h-8 ${iconClass} mb-1"></i><span class="text-xs font-medium ${isUnlocked ? '' : 'text-gray-400 dark:text-gray-600'}">${_(badge.name)}</span></div>`;
            }).join('');
            if (!progressHtml && (data.gamification.badges || []).length === 0) { container.innerHTML = `<p class="text-center text-sm py-4">${_('keep_studying_prompt')}</p>`; return; }
            container.innerHTML = progressHtml + `<div class="grid grid-cols-3 gap-2 mt-2">${allBadgesHtml}</div>`;
            lucide.createIcons();
        };
        
        const renderSubjectsPage = () => {
            const container = document.getElementById('subjects-list-container');
            const filter = document.getElementById('search-input').value.toLowerCase();
            const sourceFilterBtns = document.querySelectorAll('.subject-source-btn');
            sourceFilterBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.source === currentSubjectSourceView));
            
            container.innerHTML = (data.subjects || []).map(subject => {
                 const chapters = subject.chapters[currentSubjectSourceView] || [];
                 const filteredChapters = chapters.filter(c => c.name.toLowerCase().includes(filter));
                 if (filter && filteredChapters.length === 0 && !_(subject.id).toLowerCase().includes(filter)) return '';
                 const completed = chapters.filter(c => c.status === 'Completed').length;
                 const percentage = chapters.length > 0 ? Math.round((completed / chapters.length) * 100) : 0;
                 
                 const renderChapterList = (chapters, sourceType) => {
                     const chaptersToShow = filter ? filteredChapters : chapters;
                     if (chaptersToShow.length === 0) return `<p class="text-center text-sm py-2">${_('no_chapters_added')}</p>`;
                     return `<ul class="space-y-2 mt-4 mb-3">${chaptersToShow.map(c => `<li data-subject-id="${subject.id}" data-chapter-id="${c.id}" data-source-type="${sourceType}" class="chapter-item flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 hover:shadow-md"><span class="font-medium">${c.name}</span><span class="text-xs px-2 py-1 rounded-full ${getStatusClass(c.status)}">${_(c.status.toLowerCase().replace(' ','_'))}</span></li>`).join('')}</ul>`;
                 };
                 const sourceTypeColor = currentSubjectSourceView === 'notes' ? 'cyan' : 'violet';
                 const buttonClasses = `add-chapter-btn w-full flex items-center justify-center p-2 text-sm font-semibold text-${sourceTypeColor}-600 dark:text-${sourceTypeColor}-300 bg-${sourceTypeColor}-100 dark:bg-${sourceTypeColor}-900/50 rounded-lg hover:bg-${sourceTypeColor}-200 dark:hover:bg-${sourceTypeColor}-900`;
                 const sourceLabel = currentSubjectSourceView === 'notes' ? _('source_notes') : _('source_book');
                 
                 return `<details class="group bg-card-light dark:bg-card-dark rounded-xl shadow-sm overflow-hidden" open>
                    <summary class="flex items-center justify-between p-4 cursor-pointer">
                        <div>
                            <h3 class="font-bold text-lg">${_(subject.id)} <span class="text-base font-medium text-primary">(${sourceLabel})</span></h3>
                            <p class="text-sm text-text-muted-light">${_('chapters_done_of', {completed, total: chapters.length})}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div class="bg-primary h-2.5 rounded-full animated-progress-bar" style="width: ${percentage}%"></div>
                            </div>
                            <button class="delete-subject-btn p-1.5 rounded-full hover:bg-red-100 dark:hover:bg-red-800/50" data-subject-id="${subject.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                            <i data-lucide="chevron-right" class="w-5 h-5 transition-transform group-open:rotate-90"></i>
                        </div>
                    </summary>
                    <div class="p-4 border-t border-gray-100 dark:border-gray-800">
                        <div>${renderChapterList(chapters, currentSubjectSourceView)}<button class="${buttonClasses}" data-subject-id="${subject.id}" data-source-type="${currentSubjectSourceView}"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>${_('add_chapter')}</button></div>
                    </div>
                 </details>`;
            }).join('');
            lucide.createIcons();
        };

        const renderImportExportPage = () => { lucide.createIcons(); };

        const renderCalendarPage = (monthOffset = 0) => {
             const container = document.getElementById('calendar-view');
             const today = new Date();
             const date = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
             const month = date.getMonth(), year = date.getFullYear();
             const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             const locale = data.settings.language === 'hi' ? 'hi-IN' : 'en-US';
             const events = {};
             (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]).forEach(c => { if (c.dateCompleted) { events[c.dateCompleted] = events[c.dateCompleted] || []; events[c.dateCompleted].push({type: 'completed'}); } });
             let html = `<div class="flex items-center justify-between mb-4"><button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button><h3 class="font-bold text-lg">${date.toLocaleString(locale, { month: 'long' })} ${year}</h3><button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold mb-2">${[...Array(7).keys()].map(i => `<div>${new Date(2024,0,i+1).toLocaleString(locale, {weekday: 'short'})}</div>`).join('')}</div><div class="grid grid-cols-7 gap-1">`;
             for(let i=0; i < firstDay; i++) html += `<div></div>`;
             for(let day=1; day <= daysInMonth; day++) {
                const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.toISOString().split('T')[0] === fullDate;
                const dotHtml = events[fullDate] ? `<div class="w-1.5 h-1.5 bg-green-500 rounded-full"></div>` : '';
                html += `<div class="h-12 flex flex-col items-center justify-center rounded-lg ${isToday ? 'bg-primary text-white font-bold' : 'bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer'} relative text-sm" data-date="${fullDate}"><span>${day}</span><div class="absolute bottom-1.5 flex gap-1">${dotHtml}</div></div>`;
             }
             html += `</div>`;
             container.innerHTML = html;
             lucide.createIcons();
             container.querySelector('#prev-month')?.addEventListener('click', () => renderCalendarPage(monthOffset - 1));
             container.querySelector('#next-month')?.addEventListener('click', () => renderCalendarPage(monthOffset + 1));
             container.querySelectorAll('[data-date]').forEach(el => { if (el.dataset.date < new Date().toISOString().split('T')[0]) { el.addEventListener('click', () => openDateCompletionModal(el.dataset.date)); } });
        };
        
        // MODIFICATION: Added DPT Summary to the main report
        const renderReportPage = () => {
            const container = document.getElementById('report-content-container');
            const allChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]);
            const total = allChapters.length; const completed = allChapters.filter(c => c.status === 'Completed').length; const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            const generateDptReportHtml = () => {
                const allCompletedDpts = Object.values(data.dpts || {}).flatMap(d => d.tests).filter(t => t.status === 'Completed' && t.details);
                if (allCompletedDpts.length === 0) { return `<h2 class="text-xl font-bold mb-4 mt-8">${_('dpt_report_title')}</h2><p class="text-center text-sm p-4">${_('no_dpt_data_report')}</p>`; }
                let totalCorrect = 0, totalAttempted = 0, totalTimeTaken = 0, totalQuestions = 0;
                allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; totalTimeTaken += (dpt.details.timeTaken || 0) * 60; totalQuestions += dpt.details.attempted || 0; });
                const accuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
                const avgTimePerQ = totalQuestions > 0 ? (totalTimeTaken / totalQuestions).toFixed(1) : '0.0';
                let subjectBreakdownDptHtml = Object.keys(data.dpts).map(subjectId => {
                    const subjectDpts = data.dpts[subjectId].tests.filter(t => t.status === 'Completed' && t.details); if (subjectDpts.length === 0) return '';
                    let subCorrect = 0, subAttempted = 0;
                    subjectDpts.forEach(d => { subCorrect += d.details.correct || 0; subAttempted += d.details.attempted || 0; });
                    const subAccuracy = subAttempted > 0 ? ((subCorrect / subAttempted) * 100).toFixed(1) : '0.0';
                    return `<div class="mb-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><div class="flex justify-between items-center text-sm"><span class="font-semibold">${_(subjectId)}</span><div><span>${_('overall_accuracy')}: <strong class="text-accent">${subAccuracy}%</strong></span><span class="ml-4">${_('total_dpt_completed')}: <strong>${subjectDpts.length}</strong></span></div></div></div>`;
                }).join('');
                return `<h2 class="text-xl font-bold mb-4 mt-8">${_('dpt_report_title')}</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_dpt_completed')}</p><p class="text-2xl font-bold">${allCompletedDpts.length}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('overall_accuracy')}</p><p class="text-2xl font-bold text-accent">${accuracy}%</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('avg_time_per_q')}</p><p class="text-2xl font-bold text-warning">${avgTimePerQ}s</p></div></div><h3 class="text-lg font-bold mb-3 mt-6">${_('dpt_subject_breakdown')}</h3>${subjectBreakdownDptHtml}`;
            };
            let subjectBreakdownHtml = (data.subjects || []).map(subject => {
                const allSubChapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])]; if (allSubChapters.length === 0) return '';
                const subCompleted = allSubChapters.filter(c => c.status === 'Completed').length; const subPercentage = allSubChapters.length > 0 ? Math.round((subCompleted / allSubChapters.length) * 100) : 0;
                return `<div class="mb-4"><div class="flex justify-between items-center mb-1"><span class="font-semibold">${_(subject.id)}</span><span>${subCompleted}/${allSubChapters.length} (${subPercentage}%)</span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div class="bg-primary h-2.5 rounded-full" style="width: ${subPercentage}%"></div></div></div>`;
            }).join('');
            let activityHtml = (data.activityLog || []).slice(0, 20).map(log => `<div class="flex items-start gap-3 py-2 border-b border-gray-200 dark:border-gray-700"><i data-lucide="${log.icon}" class="w-4 h-4 mt-1 text-primary"></i><div><p class="text-sm">${log.description}</p><p class="text-xs text-text-muted-light">${new Date(log.timestamp).toLocaleString()}</p></div></div>`).join('');
            if((data.activityLog || []).length === 0) activityHtml = `<p class="text-center text-sm p-4">${_('no_activity_log_report')}</p>`;
            container.innerHTML = `<div id="report-content" class="p-6 bg-card-light dark:bg-card-dark rounded-xl shadow-sm"><div class="text-center mb-6 border-b pb-4"><h1 class="text-2xl font-bold">${_('study_report')}</h1><p>${data.settings.studentName || 'Student'} - ${new Date().toLocaleDateString()}</p></div><h2 class="text-xl font-bold mb-3">${_('overall_summary')}</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_subjects')}</p><p class="text-2xl font-bold">${(data.subjects || []).length}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_chapters')}</p><p class="text-2xl font-bold">${total}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('chapters_completed')}</p><p class="text-2xl font-bold">${completed}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('progress')}</p><p class="text-2xl font-bold text-primary">${percentage}%</p></div></div><h2 class="text-xl font-bold mb-4 mt-8">${_('subject_breakdown')}</h2>${subjectBreakdownHtml}${generateDptReportHtml()}<h2 class="text-xl font-bold mb-4 mt-8">${_('recent_activity')}</h2>${activityHtml}</div>`;
            lucide.createIcons();
        };

        const renderAnalyticsPage = () => {
            const allChapters = (data.subjects || []).flatMap(s => [...(s.chapters.notes || []), ...(s.chapters.book || [])]);
            const completedChapters = allChapters.filter(c => c.status === 'Completed');
            document.getElementById('metric-total-completed').textContent = completedChapters.length;
            const daysStudying = Math.max(1, (new Date() - new Date(data.appStartDate)) / 86400000);
            document.getElementById('metric-avg-per-day').textContent = (completedChapters.length / daysStudying).toFixed(1);
            const completionByDate = completedChapters.reduce((acc, chap) => { acc[chap.dateCompleted] = (acc[chap.dateCompleted] || 0) + 1; return acc; }, {});
            const bestDayEntry = Object.entries(completionByDate).sort((a,b) => b[1] - a[1])[0];
            document.getElementById('metric-best-day').textContent = bestDayEntry ? `${bestDayEntry[1]}` : '-';
            
            // DPT Analytics
            const allCompletedDpts = Object.values(data.dpts).flatMap(d => d.tests).filter(t => t.status === 'Completed' && t.details);
            let totalCorrect = 0, totalAttempted = 0;
            allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; });
            const dptAccuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
            document.getElementById('metric-total-dpt').textContent = allCompletedDpts.length;
            document.getElementById('metric-dpt-accuracy').textContent = `${dptAccuracy}%`;

            const isDark = data.settings.theme === 'dark';
            const textColor = isDark ? '#f1f5f9' : '#020617'; const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            // Chart 1: Chapter Status
            const chart1Ctx = document.getElementById('chapter-status-chart').getContext('2d');
            const notStarted = allChapters.length - completedChapters.length;
            if(allCharts.status) allCharts.status.destroy();
            allCharts.status = new Chart(chart1Ctx, { type: 'doughnut', data: { labels: [_('completed'), _('not_started')], datasets: [{ data: [completedChapters.length, notStarted], backgroundColor: ['#0ea5e9', '#f59e0b'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } } } } });
            
            // Chart 2: Weekly Productivity
            const chart2Ctx = document.getElementById('weekly-productivity-chart').getContext('2d');
            const last7Days = [...Array(7)].map((_, i) => new Date(Date.now() - i * 86400000).toISOString().split('T')[0]).reverse();
            const weeklyData = last7Days.map(day => completionByDate[day] || 0);
            if(allCharts.weekly) allCharts.weekly.destroy();
            allCharts.weekly = new Chart(chart2Ctx, { type: 'bar', data: { labels: last7Days.map(d => new Date(d).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-US', { weekday: 'short' })), datasets: [{ label: _('completed_chapters_chart'), data: weeklyData, backgroundColor: '#8b5cf6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } } } });
            
            // Chart 3: Subject-wise Chapter Progress
            const chart3Ctx = document.getElementById('subject-progress-chart').getContext('2d');
            const subjectProgressData = (data.subjects || []).map(s => { const chapters = [...(s.chapters.notes || []), ...(s.chapters.book || [])]; return chapters.length > 0 ? (chapters.filter(c => c.status === 'Completed').length / chapters.length) * 100 : 0; });
            if(allCharts.subject) allCharts.subject.destroy();
            allCharts.subject = new Chart(chart3Ctx, { type: 'bar', data: { labels: data.subjects.map(s => _(s.id)), datasets: [{ label: _('progress')+' (%)', data: subjectProgressData, backgroundColor: '#0ea5e9' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, ticks: { color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { display: false } } } } });

            // Chart 4: DPT Performance
            const dptChartCtx = document.getElementById('dpt-performance-chart').getContext('2d');
            const dptPerfLabels = [];
            const dptPerfData = [];
            Object.keys(data.dpts).forEach(subjectId => {
                const subjectDpts = data.dpts[subjectId].tests.filter(t => t.status === 'Completed' && t.details);
                if (subjectDpts.length > 0) {
                    let subCorrect = 0, subAttempted = 0;
                    subjectDpts.forEach(d => { subCorrect += d.details.correct || 0; subAttempted += d.details.attempted || 0; });
                    const subAccuracy = subAttempted > 0 ? ((subCorrect / subAttempted) * 100) : 0;
                    dptPerfLabels.push(_(subjectId));
                    dptPerfData.push(subAccuracy.toFixed(1));
                }
            });
            if(allCharts.dptPerf) allCharts.dptPerf.destroy();
            allCharts.dptPerf = new Chart(dptChartCtx, { type: 'bar', data: { labels: dptPerfLabels, datasets: [{ label: 'Accuracy (%)', data: dptPerfData, backgroundColor: '#10b981' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: textColor }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } } } });
        };

        const renderSettingsPage = () => {
            document.getElementById('student-name-input').value = data.settings.studentName || '';
            document.getElementById('language-select').value = data.settings.language || 'en';
            document.getElementById('background-style-select').value = data.settings.backgroundStyle || 'hexagon';
            document.getElementById('bg-color-start').value = data.settings.customThemeColors.start || '#cffafe';
            document.getElementById('bg-color-end').value = data.settings.customThemeColors.end || '#e0e7ff';
            const planMode = data.settings.planMode || 'auto';
            document.querySelector(`input[name="plan-mode"][value="${planMode}"]`).checked = true;
            const customCycleContainer = document.getElementById('custom-cycle-plan-container');
            if (planMode === 'custom_cycle') {
                customCycleContainer.classList.remove('hidden');
                const cycleSelector = document.getElementById('custom-cycle-subject-selector');
                const dayNames = [ _('sunday'), _('monday'), _('tuesday'), _('wednesday'), _('thursday'), _('friday'), _('saturday'), _('sunday') + ` ${_('week_2_suffix')}`, _('monday') + ` ${_('week_2_suffix')}`, _('tuesday') + ` ${_('week_2_suffix')}`, _('wednesday') + ` ${_('week_2_suffix')}`, _('thursday') + ` ${_('week_2_suffix')}`, _('friday') + ` ${_('week_2_suffix')}`, _('saturday') + ` ${_('week_2_suffix')}` ];
                cycleSelector.innerHTML = [...Array(14).keys()].map(i => `<div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><h4 class="font-bold text-center mb-3">${dayNames[i]}</h4><div class="space-y-2">${(data.subjects || []).map(s => `<details class="group bg-card-light dark:bg-card-dark rounded-md border border-gray-200 dark:border-gray-700"><summary class="flex items-center justify-between p-2 cursor-pointer list-none"><span class="font-semibold text-sm">${_(s.id)}</span><i data-lucide="chevron-right" class="w-4 h-4 transition-transform group-open:rotate-90"></i></summary><div class="p-2 border-t space-y-2"><label class="flex items-center gap-2 text-sm cursor-pointer p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50"><input type="checkbox" class="custom-cycle-subject-checkbox form-checkbox h-4 w-4 text-primary" data-day="${i}" value="${s.id}:notes" ${((data.settings.customCyclePlan?.[i] || []).includes(`${s.id}:notes`)) ? 'checked' : ''}><span data-translate="source_notes">${_('source_notes')}</span></label><label class="flex items-center gap-2 text-sm cursor-pointer p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50"><input type="checkbox" class="custom-cycle-subject-checkbox form-checkbox h-4 w-4 text-accent" data-day="${i}" value="${s.id}:book" ${((data.settings.customCyclePlan?.[i] || []).includes(`${s.id}:book`)) ? 'checked' : ''}><span data-translate="source_book">${_('source_book')}</span></label></div></details>`).join('')}</div></div>`).join('');
                lucide.createIcons();
            } else { customCycleContainer.classList.add('hidden'); }
            const dptPlanMode = data.settings.dptPlanMode || 'auto';
            document.querySelector(`input[name="dpt-plan-mode"][value="${dptPlanMode}"]`).checked = true;
            const customDptContainer = document.getElementById('custom-dpt-plan-container');
            if (dptPlanMode === 'custom_cycle') {
                customDptContainer.classList.remove('hidden');
                const dptCycleSelector = document.getElementById('dpt-custom-cycle-subject-selector');
                const dayNames = [ _('sunday'), _('monday'), _('tuesday'), _('wednesday'), _('thursday'), _('friday'), _('saturday'), _('sunday') + ` ${_('week_2_suffix')}`, _('monday') + ` ${_('week_2_suffix')}`, _('tuesday') + ` ${_('week_2_suffix')}`, _('wednesday') + ` ${_('week_2_suffix')}`, _('thursday') + ` ${_('week_2_suffix')}`, _('friday') + ` ${_('week_2_suffix')}`, _('saturday') + ` ${_('week_2_suffix')}` ];
                dptCycleSelector.innerHTML = [...Array(14).keys()].map(i => `<div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><h4 class="font-bold text-center mb-3">${dayNames[i]}</h4><div class="space-y-2 max-h-60 overflow-y-auto">${(data.subjects || []).map(s => `<label class="flex items-center gap-2 text-sm cursor-pointer p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50"><input type="checkbox" class="custom-dpt-subject-checkbox form-checkbox h-4 w-4 text-primary" data-day="${i}" value="${s.id}" ${((data.settings.dptCyclePlan?.[i] || []).includes(s.id)) ? 'checked' : ''}><span>${_(s.id)}</span></label>`).join('')}</div></div>`).join('');
            } else { customDptContainer.classList.add('hidden'); }
        };

        const getStatusClass = (status) => ({ 'Completed': 'bg-green-500/20 text-green-700 dark:text-green-300'}[status] || 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300');
        const showModal = (id) => document.getElementById(id).classList.replace('hidden', 'flex');
        const hideModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');

        const renderExamsPage = () => {
            const container = document.getElementById('exams-list-container');
            const today = new Date().toISOString().split('T')[0];
            let examsToRender = [...(data.exams || [])];
            let emptyMessage = _('no_exams_added');
            if (currentExamFilter === 'upcoming') { examsToRender = examsToRender.filter(exam => exam.examDate && exam.examDate >= today); emptyMessage = _('no_upcoming_exams_filter'); } 
            else if (currentExamFilter === 'applied') { examsToRender = examsToRender.filter(exam => exam.status === 'Applied'); emptyMessage = _('no_applied_forms_filter'); } 
            else if (currentExamFilter === 'history') { examsToRender = examsToRender.filter(exam => exam.examDate && exam.examDate < today); emptyMessage = _('no_history_exams'); }
            if (examsToRender.length === 0) { container.innerHTML = `<div class="text-center p-8 bg-card-light dark:bg-card-dark rounded-xl"><i data-lucide="file-text" class="w-12 h-12 mx-auto text-text-muted-light mb-4"></i><h3 class="font-bold">${emptyMessage}</h3></div>`; lucide.createIcons(); return; }
            container.innerHTML = examsToRender.sort((a,b) => new Date(b.applicationDate || 0) - new Date(a.applicationDate || 0)).map(exam => {
                const locale = data.settings.language === 'hi' ? 'hi-IN' : 'en-GB';
                const appDate = exam.applicationDate ? new Date(exam.applicationDate).toLocaleDateString(locale) : 'N/A';
                const exDate = exam.examDate ? new Date(exam.examDate).toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                const daysRemaining = exam.examDate ? Math.ceil((new Date(exam.examDate) - new Date()) / 86400000) : null;
                const statusColors = { "Applied": "bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300", "Admit Card Out": "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300", "Exam Done": "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300", "Result Out": "bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300" };
                const receiptLink = exam.receipt ? `<a href="${exam.receipt}" target="_blank" download="receipt" class="flex items-center gap-1 text-xs font-semibold text-primary hover:underline"><i data-lucide="paperclip" class="w-3 h-3"></i> ${_('receipt_attached')}</a>` : '';
                const borderColorClass = exam.examDate && exam.examDate < today ? 'border-gray-400/50' : 'border-primary/50';
                return `<div class="p-4 rounded-lg bg-card-light dark:bg-card-dark shadow-sm border-l-4 ${borderColorClass} animate-list-item"><div class="flex flex-col md:flex-row justify-between items-start gap-3"><div class="flex-grow"><h3 class="font-bold text-lg">${exam.name}</h3><div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs mt-1"><span>${_('applied_on')}: <strong>${appDate}</strong></span><span>${_('exam_date')}: <strong>${exDate}</strong></span>${receiptLink ? `<span>${receiptLink}</span>` : ''}</div><p class="text-sm mt-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-md whitespace-pre-wrap">${exam.notes || 'No notes.'}</p></div><div class="flex flex-col items-start md:items-end gap-2 w-full md:w-auto self-stretch"><div class="flex items-center gap-2"><span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColors[exam.status]}">${_(('status_'+exam.status).toLowerCase().replace(/\s/g, '_'))}</span><div class="flex gap-1"><button class="edit-exam-btn p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200" data-exam-id="${exam.id}"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button class="delete-exam-btn p-2 rounded-lg bg-red-100 dark:bg-red-900/50 hover:bg-red-200" data-exam-id="${exam.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button></div></div>${daysRemaining !== null && daysRemaining >= 0 ? `<div class="text-right mt-auto"><div class="text-2xl font-bold text-primary">${daysRemaining}</div><p class="text-xs -mt-1">${_('days_remaining')}</p></div>` : ''}</div></div></div>`;
            }).join('');
            lucide.createIcons();
        };

        const showAddExamModal = (examId = null) => {
            const form = document.getElementById('add-exam-form'); form.reset();
            document.getElementById('exam-receipt').value = null;
            const receiptViewer = document.getElementById('exam-receipt-viewer'); receiptViewer.innerHTML = '';
            const modalTitle = document.getElementById('exam-modal-title');
            const examIdInput = document.getElementById('exam-id');
            if (examId) {
                const exam = data.exams.find(e => e.id === examId); if (!exam) return;
                modalTitle.textContent = _('edit_exam'); examIdInput.value = exam.id;
                document.getElementById('exam-name').value = exam.name; document.getElementById('application-date').value = exam.applicationDate;
                document.getElementById('exam-date').value = exam.examDate; document.getElementById('exam-status').value = exam.status;
                document.getElementById('exam-notes').value = exam.notes;
                if (exam.receipt) { receiptViewer.innerHTML = `<a href="${exam.receipt}" target="_blank" download="receipt" class="text-primary hover:underline font-semibold">${_('view_receipt')}</a>`; }
            } else { modalTitle.textContent = _('add_new_exam'); examIdInput.value = ''; }
            showModal('add-exam-modal');
        };

        const saveExam = () => {
            const id = document.getElementById('exam-id').value;
            const file = document.getElementById('exam-receipt').files[0];
            const examData = { name: document.getElementById('exam-name').value.trim(), applicationDate: document.getElementById('application-date').value, examDate: document.getElementById('exam-date').value, status: document.getElementById('exam-status').value, notes: document.getElementById('exam-notes').value.trim() };
            if (!examData.name) return;
            const processSave = (receiptDataUrl = null) => {
                if (receiptDataUrl) { examData.receipt = receiptDataUrl; }
                if (id) {
                    const index = data.exams.findIndex(e => e.id === id);
                    if (index !== -1) { if (!receiptDataUrl) { examData.receipt = data.exams[index].receipt; } data.exams[index] = { ...data.exams[index], ...examData }; logActivity('edit-3', `Exam updated: "${examData.name}"`); }
                } else { examData.id = `exam-${Date.now()}`; data.exams.push(examData); logActivity('briefcase', `Exam added: "${examData.name}"`); }
                saveData(); renderExamsPage(); renderHomePage(); hideModal('add-exam-modal');
            };
            if (file) { const reader = new FileReader(); reader.onload = (e) => processSave(e.target.result); reader.onerror = (e) => { console.error("File reading error", e); alert("Error reading file."); processSave(null); }; reader.readAsDataURL(file); } 
            else { processSave(null); }
        };

        const deleteExam = (examId) => {
            const exam = data.exams.find(e => e.id === examId);
            if (exam) { showConfirmationModal(_('delete_exam') + '?', `Are you sure you want to delete "${exam.name}"?`, () => { logActivity('trash-2', `Exam deleted: "${exam.name}"`); data.exams = data.exams.filter(e => e.id !== examId); saveData(); renderExamsPage(); renderHomePage(); }); }
        };

        const renderUpcomingExamsOnDashboard = () => {
            const container = document.getElementById('dashboard-exams-container');
            const today = new Date().toISOString().split('T')[0];
            const upcomingExams = (data.exams || []).filter(exam => exam.examDate && exam.examDate >= today).sort((a,b) => new Date(a.examDate) - new Date(b.date)).slice(0, 3);
            if (upcomingExams.length === 0) { container.innerHTML = `<p class="text-center text-sm py-4">${_('no_upcoming_exams')}</p>`; return; }
            container.innerHTML = upcomingExams.map(exam => {
                const daysRemaining = Math.ceil((new Date(exam.examDate) - new Date()) / 86400000);
                const examDateFormatted = new Date(exam.examDate).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
                return `<div class="text-center p-3 bg-amber-50 dark:bg-amber-900/50 rounded-lg animate-list-item"><p class="text-sm font-semibold">${exam.name}</p><div class="text-5xl font-bold text-warning">${daysRemaining >= 0 ? daysRemaining : '0'}</div><p class="text-xs -mt-1">${_('days_remaining')}</p><p class="text-xs font-semibold text-amber-600 dark:text-amber-300 mt-1">${examDateFormatted}</p></div>`;
            }).join('');
        };

        const showChapterModal = (subjectId, chapterId, sourceType) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            document.getElementById('chapter-modal-title').textContent = chapter.name;
            document.querySelectorAll('#chapter-status-buttons button').forEach(btn => { btn.classList.toggle('active', btn.dataset.status === chapter.status); });
            document.getElementById('chapter-notes-textarea').value = chapter.notes || '';
            document.getElementById('chapter-priority-revision-checkbox').checked = chapter.priorityRevision || false;
            renderScheduledRevisions(chapter);
            const addRevBtn = document.getElementById('add-manual-revision-btn'); addRevBtn.dataset.chapterId = chapterId; addRevBtn.dataset.subjectId = subjectId; addRevBtn.dataset.sourceType = sourceType;
            const saveBtn = document.getElementById('save-chapter-details-btn'); saveBtn.dataset.subjectId = subjectId; saveBtn.dataset.chapterId = chapterId; saveBtn.dataset.sourceType = sourceType;
            const deleteBtn = document.getElementById('delete-chapter-details-btn'); deleteBtn.dataset.subjectId = subjectId; deleteBtn.dataset.chapterId = chapterId; deleteBtn.dataset.sourceType = sourceType;
            showModal('chapter-modal');
        };

        const showAddChapterModal = (subjectId, sourceType) => {
            document.getElementById('add-chapter-form').reset();
            document.getElementById('add-chapter-subject-id').value = subjectId;
            document.getElementById('add-chapter-source-type').value = sourceType;
            showModal('add-chapter-modal');
        };
        
        const showConfirmationModal = (title, message, onConfirm) => {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-action');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => { onConfirm(); hideModal('confirmation-modal'); }, { once: true });
            document.getElementById('confirm-cancel').addEventListener('click', () => hideModal('confirmation-modal'), { once: true });
            showModal('confirmation-modal');
        };

        const addNewChapter = (subjectId, chapterName, sourceType) => {
            chapterName = chapterName.trim(); if (!subjectId || !chapterName || !sourceType) return;
            const subject = getSubjectById(subjectId);
            if (subject) {
                const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterName, status: 'Not Started', dateAdded: new Date().toISOString().split('T')[0], notes: '', priorityRevision: false, revisions: [] };
                subject.chapters[sourceType].push(newChapter);
                logActivity('plus-circle', `New chapter added to ${_(subject.id)}: "${chapterName}"`);
                saveData(); renderSubjectsPage(); hideModal('add-chapter-modal');
            }
        };
        
        const updateChapterStatus = (subjectId, chapterId, sourceType, newStatus, isUndo = false, completionDate = null) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            const oldStatus = chapter.status; if (oldStatus === newStatus) return;
            chapter.status = newStatus;
            if (newStatus === 'Completed') {
                chapter.dateCompleted = completionDate || new Date().toISOString().split('T')[0];
                scheduleRevisions(chapter);
                if (!isUndo) {
                    data.gamification.completedHistory.push(chapter.dateCompleted);
                    logActivity('check-circle', `Chapter completed: "${chapter.name}"`); checkGamification('completion', { subjectId, sourceType });
                    lastAction = { type: 'complete', data: { subjectId, chapterId, sourceType, oldStatus }, undo: () => updateChapterStatus(subjectId, chapterId, sourceType, oldStatus, true) };
                    showUndoToast(_('chapter_completed_msg'), lastAction.undo);
                }
            } else { delete chapter.dateCompleted; chapter.revisions = []; if (!isUndo) { logActivity('rotate-ccw', `Chapter status changed: "${chapter.name}" to ${newStatus}`); } }
            saveData(); updateAllUI();
        };

        const updateRevisionStatus = (subjectId, chapterId, sourceType, revisionDate, isComplete) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter || !chapter.revisions) return;
            const revision = chapter.revisions.find(r => r.date === revisionDate);
            if (revision) { revision.status = isComplete ? 'Completed' : 'Pending'; logActivity('repeat', `Revision for "${chapter.name}" marked as ${revision.status}.`); saveData(); renderHomePage(); }
        };

        const saveChapterDetails = (subjectId, chapterId, sourceType) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            const newStatus = document.querySelector('#chapter-status-buttons button.active').dataset.status;
            updateChapterStatus(subjectId, chapterId, sourceType, newStatus);
            chapter.notes = document.getElementById('chapter-notes-textarea').value;
            chapter.priorityRevision = document.getElementById('chapter-priority-revision-checkbox').checked;
            saveData(); renderSubjectsPage(); hideModal('chapter-modal');
        };

        const confirmDeleteChapter = (subjectId, chapterId, sourceType) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType); if (!chapter) return;
            hideModal('chapter-modal');
            showConfirmationModal(_('delete_chapter')+'?', `Are you sure you want to delete "${chapter.name}"? This action cannot be undone.`, () => {
                const subject = getSubjectById(subjectId);
                subject.chapters[sourceType] = subject.chapters[sourceType].filter(c => c.id !== chapterId);
                logActivity('trash-2', `Chapter deleted: "${chapter.name}"`);
                saveData(); renderSubjectsPage();
            });
        };
        
        const scheduleRevisions = (chapter) => {
            const revisionDays = [8, 16, 30];
            chapter.revisions = chapter.revisions.filter(r => r.type === 'manual');
            revisionDays.forEach(days => {
                const revisionDate = new Date(chapter.dateCompleted); revisionDate.setDate(revisionDate.getDate() + days);
                chapter.revisions.push({ date: revisionDate.toISOString().split('T')[0], status: 'Pending', type: 'auto' });
            });
        };
        
        const resetApp = () => showConfirmationModal(_('reset_app')+'?', _('reset_all_data'), () => { localStorage.removeItem(DB_KEY); window.location.reload(); });
        
        const exportData = () => {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `study_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click(); URL.revokeObjectURL(url);
        };
        
        const importAllChapters = (event) => {
            const file = event.target.files[0]; const sourceType = event.target.dataset.sourceType;
            if (!file || !sourceType) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result); let chaptersAdded = 0; let subjectsAdded = 0;
                    Object.keys(importedData).forEach(subjectName => {
                        const subjectId = subjectName.toLowerCase().replace(/\s+/g, '-').replace(/[()]/g, '');
                        let subject = data.subjects.find(s => s.id === subjectId);
                        if (!subject) { subject = { id: subjectId, name: subjectName, chapters: { notes: [], book: [] } }; data.subjects.push(subject); if (!translations.en[subjectId]) { translations.en[subjectId] = subjectName; translations.hi[subjectId] = subjectName; } subjectsAdded++; }
                        const chaptersToImport = importedData[subjectName];
                        if (Array.isArray(chaptersToImport)) { chaptersToImport.forEach(chapterData => { if (chapterData.name && !subject.chapters[sourceType].some(c => c.name === chapterData.name)) { const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterData.name.trim(), status: 'Not Started', dateAdded: new Date().toISOString().split('T')[0], notes: '', priorityRevision: false, revisions: [] }; subject.chapters[sourceType].push(newChapter); chaptersAdded++; } }); }
                    });
                    logActivity('upload', `Imported ${chaptersAdded} chapters and ${subjectsAdded} new subjects.`);
                    saveData(); alert(`Import successful!\n\nNew Subjects Added: ${subjectsAdded}\nNew Chapters Added: ${chaptersAdded}`);
                    applyTranslations(); renderSubjectsPage(); 
                } catch (error) { alert("Error reading or parsing the JSON file."); console.error("Import Error:", error); } 
                finally { event.target.value = null; }
            };
            reader.readAsText(file);
        };
        
        const BADGES = { 'first_step': { name: 'first_step', description: 'first_step_desc', icon: 'flag', color: 'text-green-500'}, 'first_completion': { name: 'winner', description: 'first_completion_desc', icon: 'check-circle-2', color: 'text-blue-500' }, 'ten_completed': { name: 'scholar', description: 'ten_completed_desc', icon: 'award', color: 'text-amber-500' }, 'subject_master': { name: 'subject_master', description: 'subject_master_desc', icon: 'graduation-cap', color: 'text-purple-500' }, };
        const unlockBadge = (badgeId) => {
            if (!(data.gamification.badges || []).includes(badgeId)) {
                data.gamification.badges.push(badgeId);
                const badgeInfo = BADGES[badgeId];
                if (badgeInfo) { document.getElementById('badge-name').textContent = _(badgeInfo.name); document.getElementById('badge-description').textContent = _(badgeInfo.description); showModal('badge-modal'); renderBadges(); }
            }
        };

        const checkGamification = (trigger, context = {}) => {
            const completedCount = (data.gamification.completedHistory || []).length;
            if (completedCount >= 1) unlockBadge('first_completion');
            if (completedCount >= 10) unlockBadge('ten_completed');
            if (trigger === 'completion' && context.subjectId) {
                const subject = getSubjectById(context.subjectId);
                const chaptersInSubject = subject.chapters[context.sourceType];
                if (chaptersInSubject.every(c => c.status === 'Completed')) { unlockBadge('subject_master'); }
            }
        };

        const getDptSubjectsForDay = (date = new Date()) => {
            const dayIndex = getCycleDayIndex(date);
            if (data.settings.dptPlanMode === 'custom_cycle') { return (data.settings.dptCyclePlan || [])[dayIndex] || []; }
            return [...new Set(getSubjectsForDay(date).map(s => s.split(':')[0]))];
        };

        const renderTodaysDpt = () => {
            const container = document.getElementById('todays-dpt-container');
            const todayStr = new Date().toISOString().split('T')[0];
            
            data.dailyDptPlan = data.dailyDptPlan || {}; data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr] || [];
            const subjectsForDptToday = getDptSubjectsForDay(new Date());
            let planUpdated = false;

            subjectsForDptToday.forEach(subjectId => {
                const alreadyScheduled = data.dailyDptPlan[todayStr].some(dpt => dpt.subjectId === subjectId && !dpt.isManual);
                if (!alreadyScheduled) {
                    const dptData = data.dpts[subjectId];
                    if (dptData && dptData.tests.length > dptData.nextTestIndex) {
                        const nextTest = dptData.tests[dptData.nextTestIndex];
                        data.dailyDptPlan[todayStr].push({ subjectId: subjectId, testId: nextTest.id });
                        planUpdated = true;
                    }
                }
            });
            if (planUpdated) { saveData(); }

            const scheduledTests = data.dailyDptPlan[todayStr] || [];
            const hasPending = scheduledTests.some(({ subjectId, testId }) => { const test = data.dpts[subjectId]?.tests.find(t => t.id === testId); return test && test.status !== 'Completed'; });
            container.className = `dashboard-card p-4 rounded-xl shadow-sm min-h-[100px] bg-gradient-to-br ${ hasPending ? 'from-amber-100 to-orange-200 dark:from-amber-800 dark:to-orange-900' : 'from-teal-100 to-green-200 dark:from-teal-800 dark:to-green-900' }`;
            
            let html = `<div class="flex items-center justify-between pb-3 border-b border-black/10 dark:border-white/10 mb-3">
                <div class="flex items-center gap-3"><i data-lucide="file-check" class="w-6 h-6"></i><h2 class="text-lg font-bold">${_('todays_dpt')}</h2></div>
                <button id="manual-add-dpt-btn" class="p-1.5 rounded-full hover:bg-orange-200 dark:hover:bg-orange-800"><i data-lucide="plus-circle" class="w-5 h-5 text-orange-700 dark:text-orange-300"></i></button>
            </div>`;

            if (scheduledTests.length === 0) { html += `<div class="text-center py-4"><p>${_('no_dpt_scheduled')}</p></div>`; } 
            else {
                html += '<ul class="space-y-3">';
                scheduledTests.forEach(({ subjectId, testId, isManual, id }) => {
                    const test = data.dpts[subjectId]?.tests.find(t => t.id === testId); if (!test) return;
                    const subjectName = _(subjectId);
                    const dptTitle = `${subjectName} ${_('dpt')} #${test.id}`;
                    const deleteButton = isManual ? `<button class="manual-dpt-delete-btn p-1.5" data-manual-id="${id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>` : '';

                    if (test.status === 'Completed') {
                        html += `<li class="flex items-center justify-between gap-2 p-2 rounded-lg bg-green-500/20"><p class="font-bold text-green-800 dark:text-green-200">${dptTitle}</p><button class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold cursor-not-allowed" disabled><i data-lucide="check-circle-2" class="w-4 h-4"></i><span>${_('completed')}</span></button></li>`;
                    } else {
                        html += `<li class="flex items-center justify-between gap-2 p-2 rounded-lg bg-white/30 dark:bg-black/20">
                            <p class="font-bold flex items-center gap-2">${isManual ? `<i data-lucide="hand" class="w-4 h-4 text-indigo-500"></i>`: ''}${dptTitle}</p>
                            <div class="flex items-center gap-1">
                                <button class="mark-dpt-complete-btn w-full sm:w-auto flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold text-white bg-amber-500 rounded-lg hover:bg-amber-600 shadow" data-subject-id="${subjectId}" data-test-id="${test.id}"><i data-lucide="check-circle" class="w-4 h-4"></i><span>${_('mark_as_complete')}</span></button>
                                ${deleteButton}
                            </div>
                        </li>`;
                    }
                });
                html += '</ul>';
                if(!hasPending) { html += `<div class="text-center pt-4 text-green-800 dark:text-green-200 font-semibold"><p>${_('all_dpt_completed')}</p></div>`; }
            }
            container.innerHTML = html;
            lucide.createIcons();
        };

        const renderDptPage = () => {
            const filterDropdown = document.getElementById('dpt-subject-filter');
            const container = document.getElementById('dpt-list-container');
            const subjectOptions = `<option value="all_subjects">${_('all_subjects')}</option>` + (data.subjects || []).map(s => `<option value="${s.id}">${_(s.id)}</option>`).join('');
            const currentSelection = filterDropdown.value || 'all_subjects';
            filterDropdown.innerHTML = subjectOptions;
            if (Array.from(filterDropdown.options).some(opt => opt.value === currentSelection)) { filterDropdown.value = currentSelection; } 
            else { filterDropdown.value = 'all_subjects'; }

            const selectedSubjectId = filterDropdown.value;
            let html = '';

            if (selectedSubjectId === 'all_subjects') {
                html += `<div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm mb-4"><div class="flex flex-col sm:flex-row justify-between items-center gap-3"><h3 class="font-bold text-xl">${_('all_subjects')}</h3><button id="add-dpt-all-btn" class="flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg btn-neon"><i data-lucide="plus-circle" class="w-4 h-4"></i><span data-translate="add_dpt_all">${_('add_dpt_all')}</span></button></div></div>`;
                const allDpts = [];
                Object.keys(data.dpts).forEach(subjectId => { data.dpts[subjectId].tests.forEach(test => { allDpts.push({ subjectId, test }); }); });
                if (allDpts.length === 0) { html += `<p class="text-center mt-6">${_('no_dpt_for_subject')}</p>`; } 
                else {
                    html += '<div class="space-y-2 mt-4">';
                    allDpts.sort((a, b) => a.test.id - b.test.id).forEach(({ subjectId, test }) => {
                        const statusClass = test.status === 'Completed' ? 'bg-green-100 dark:bg-green-900/50 border-green-400' : 'bg-gray-100 dark:bg-gray-800/50 border-gray-300 dark:border-gray-600';
                        const hue = (test.id * 30 + subjectId.charCodeAt(0)) % 360; const colorStyle = `border-left-color: hsl(${hue}, 60%, 50%);`;
                        const dptName = `${_(subjectId)} DPT - #${test.id}`;
                        html += `<button class="dpt-list-item w-full text-left p-3 rounded-lg border-l-4 ${statusClass}" style="${colorStyle}" data-subject-id="${subjectId}" data-test-id="${test.id}">${dptName}</button>`;
                    });
                    html += '</div>';
                }
            } else {
                const dptData = data.dpts[selectedSubjectId] || { tests: [], nextTestIndex: 0 };
                const completedCount = dptData.tests.filter(t => t.status === 'Completed').length;
                const totalCount = dptData.tests.length;
                html += `<div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm"><div class="flex flex-col sm:flex-row justify-between items-center gap-3 mb-4"><h3 class="font-bold text-xl">${_(selectedSubjectId)}</h3><div class="flex items-center gap-2"><span class="text-sm font-semibold">${_('dpt_progress', {completed: completedCount, total: totalCount})}</span><button class="add-dpt-btn flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg btn-neon" data-subject-id="${selectedSubjectId}"><i data-lucide="plus" class="w-4 h-4"></i> ${_('add_dpt')}</button></div></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div class="bg-primary h-2.5 rounded-full" style="width: ${totalCount > 0 ? (completedCount / totalCount) * 100 : 0}%"></div></div></div>`;
                if (dptData.tests.length === 0) { html += `<p class="text-center mt-6">${_('no_dpt_for_subject')}</p>`; } 
                else {
                    html += '<div class="space-y-2 mt-4">';
                    dptData.tests.forEach(test => {
                        const statusClass = test.status === 'Completed' ? 'bg-green-100 dark:bg-green-900/50 border-green-400' : 'bg-gray-100 dark:bg-gray-800/50 border-gray-300 dark:border-gray-600';
                        const hue = (test.id * 30) % 360; const colorStyle = `border-left-color: hsl(${hue}, 60%, 50%);`;
                        const dptName = `${_(selectedSubjectId)} DPT - #${test.id}`;
                        html += `<button class="dpt-list-item w-full text-left p-3 rounded-lg border-l-4 ${statusClass}" style="${colorStyle}" data-subject-id="${selectedSubjectId}" data-test-id="${test.id}">${dptName}</button>`;
                    });
                    html += '</div>';
                }
            }
            container.innerHTML = html;
            renderDptSummary();
            lucide.createIcons();
        };
        
        const renderDptSummary = () => {
            const container = document.getElementById('dpt-summary-container');
            const allCompletedDpts = Object.values(data.dpts).flatMap(d => d.tests).filter(t => t.status === 'Completed' && t.details);
            const totalCompleted = allCompletedDpts.length;
            let totalCorrect = 0, totalAttempted = 0, totalTimeTaken = 0, totalQuestions = 0;
            allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; totalTimeTaken += (dpt.details.timeTaken || 0) * 60; totalQuestions += dpt.details.totalQ || 0; });
            const accuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
            const avgTimePerQ = totalAttempted > 0 ? (totalTimeTaken / totalAttempted).toFixed(1) : '0.0';
            container.innerHTML = `<div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="total_dpt_completed">Total DPTs Completed</h3><p class="text-3xl font-bold text-primary">${totalCompleted}</p></div><div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="overall_accuracy">Overall Accuracy</h3><p class="text-3xl font-bold text-accent">${accuracy}%</p></div><div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="avg_time_per_q">Avg. Time / Q (s)</h3><p class="text-3xl font-bold text-warning">${avgTimePerQ}</p></div>`;
        };

        const showDptDetailsModal = (subjectId, testId) => {
            const form = document.getElementById('dpt-details-form'); form.reset();
            form.querySelector('#dpt-details-subject-id').value = subjectId;
            form.querySelector('#dpt-details-test-id').value = testId;
            const dptData = data.dpts[subjectId];
            if (dptData) {
                const test = dptData.tests.find(t => t.id == testId);
                if (test && test.details) {
                    form.querySelector('#dpt-total-q').value = test.details.totalQ || ''; form.querySelector('#dpt-total-time').value = test.details.totalTime || '';
                    form.querySelector('#dpt-attempted').value = test.details.attempted || ''; form.querySelector('#dpt-correct').value = test.details.correct || '';
                    form.querySelector('#dpt-wrong').value = test.details.wrong || ''; form.querySelector('#dpt-time-taken').value = test.details.timeTaken || '';
                }
            }
            showModal('dpt-details-popup-modal');
        };

        const hideDptDetailsModal = () => { hideModal('dpt-details-popup-modal'); };

        const submitDptDetails = (e) => {
            e.preventDefault();
            const form = e.target;
            const subjectId = form.querySelector('#dpt-details-subject-id').value;
            const testId = parseInt(form.querySelector('#dpt-details-test-id').value);
            const dptData = data.dpts[subjectId]; if (!dptData) return;
            const testIndex = dptData.tests.findIndex(t => t.id === testId); if(testIndex === -1) return;
            const details = { totalQ: parseInt(form.querySelector('#dpt-total-q').value) || null, totalTime: parseInt(form.querySelector('#dpt-total-time').value) || null, attempted: parseInt(form.querySelector('#dpt-attempted').value) || null, correct: parseInt(form.querySelector('#dpt-correct').value) || null, wrong: parseInt(form.querySelector('#dpt-wrong').value) || null, timeTaken: parseInt(form.querySelector('#dpt-time-taken').value) || null, };
            dptData.tests[testIndex].status = 'Completed';
            dptData.tests[testIndex].details = details;
            if (dptData.nextTestIndex === testIndex) { dptData.nextTestIndex++; }
            logActivity('check-square', `Completed DPT #${testId} for ${_(subjectId)}.`);
            saveData(); hideDptDetailsModal(); renderHomePage();
            if(document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
        };

        const applyBackgroundStyle = () => {
            stopAllBackgroundAnimations();
            const style = data.settings.backgroundStyle || 'hexagon';
            if (style === 'default') { document.body.classList.remove('particles-active'); particleCanvas.style.display = 'none'; return; }
            document.body.classList.add('particles-active'); particleCanvas.style.display = 'block';
            const animationInitializers = { particles: initParticleNetwork, starfield: initStarfield, hexagon: initHexagons };
            if (animationInitializers[style]) { animationInitializers[style](); }
        };
        
        // MODIFICATION: Helper function to convert hex to rgba
        const hexToRgba = (hex, alpha = 1) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const stopAllBackgroundAnimations = () => { if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } };
        function initCanvas() { particleCanvas.width = window.innerWidth; particleCanvas.height = window.innerHeight; backgroundElements = []; }
        function initParticleNetwork() { initCanvas(); let numberOfParticles = (particleCanvas.height * particleCanvas.width) / 12000; if (numberOfParticles > 120) numberOfParticles = 120; for (let i = 0; i < numberOfParticles; i++) backgroundElements.push(new Particle()); animateParticleNetwork(); }
        class Particle { 
            constructor() { 
                this.x = Math.random() * particleCanvas.width; this.y = Math.random() * particleCanvas.height; 
                this.size = Math.random() * 2 + 1; this.speedX = Math.random() * 1.5 - 0.75; 
                this.speedY = Math.random() * 1.5 - 0.75; 
                // MODIFICATION: Use CSS variables for theme-aware colors
                const colorVar = data.settings.theme === 'dark' ? '--accent' : '--primary';
                const color = getComputedStyle(document.documentElement).getPropertyValue(colorVar).trim();
                this.color = hexToRgba(color, data.settings.theme === 'dark' ? 0.7 : 0.5);
            } 
            update() { if (this.x > particleCanvas.width || this.x < 0) this.speedX = -this.speedX; if (this.y > particleCanvas.height || this.y < 0) this.speedY = -this.speedY; this.x += this.speedX; this.y += this.speedY; } 
            draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } 
        }
        function animateParticleNetwork() { ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height); for (let i = 0; i < backgroundElements.length; i++) { backgroundElements[i].update(); backgroundElements[i].draw(); } connectParticles(); animationFrameId = requestAnimationFrame(animateParticleNetwork); }
        function connectParticles() { 
            let opacityValue = 1; const connectDistance = 120; 
            // MODIFICATION: Use CSS variables for theme-aware line colors
            const colorVar = data.settings.theme === 'dark' ? '--accent' : '--primary';
            const colorHex = getComputedStyle(document.documentElement).getPropertyValue(colorVar).trim();
            const lineColor = hexToRgba(colorHex, data.settings.theme === 'dark' ? 0.2 : 0.1);
            
            for (let a = 0; a < backgroundElements.length; a++) { for (let b = a; b < backgroundElements.length; b++) { let distance = Math.hypot(backgroundElements[a].x - backgroundElements[b].x, backgroundElements[a].y - backgroundElements[b].y); if (distance < connectDistance) { opacityValue = 1 - (distance / connectDistance); ctx.strokeStyle = lineColor.replace(/,\s*\d?\.?\d+\)$/, `, ${opacityValue})`); ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(backgroundElements[a].x, backgroundElements[a].y); ctx.lineTo(backgroundElements[b].x, backgroundElements[b].y); ctx.stroke(); } } } 
        }
        function initStarfield() { initCanvas(); for (let i = 0; i < 400; i++) backgroundElements.push(new Star()); animateStarfield(); }
        class Star { constructor() { this.x = Math.random() * particleCanvas.width; this.y = Math.random() * particleCanvas.height; this.z = Math.random() * particleCanvas.width; this.color = data.settings.theme === 'dark' ? '#FFF' : '#020617';} update() { this.z -= 1.5; if (this.z < 1) { this.z = particleCanvas.width; this.x = Math.random() * particleCanvas.width; this.y = Math.random() * particleCanvas.height; } } draw() { let x = (this.x - particleCanvas.width / 2) * (particleCanvas.width / this.z) + particleCanvas.width / 2; let y = (this.y - particleCanvas.height / 2) * (particleCanvas.width / this.z) + particleCanvas.height / 2; let r = (particleCanvas.width / this.z); ctx.beginPath(); ctx.fillStyle = this.color; ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill(); } }
        function animateStarfield() { ctx.fillStyle = data.settings.theme === 'dark' ? 'rgba(12, 20, 37, 0.5)' : 'rgba(240, 249, 255, 0.5)'; ctx.fillRect(0, 0, particleCanvas.width, particleCanvas.height); backgroundElements.forEach(s => { s.update(); s.draw(); }); animationFrameId = requestAnimationFrame(animateStarfield); }
        let hexSize = 30, hexes = [];
        function initHexagons() { initCanvas(); let hexWidth = hexSize * Math.sqrt(3); let hexHeight = hexSize * 2; for (let y = -hexHeight / 2; y < particleCanvas.height + hexHeight; y += hexHeight * 3 / 4) { for (let x = -hexWidth / 2; x < particleCanvas.width + hexWidth; x += hexWidth) { hexes.push([x + (y / (hexHeight * 3 / 4) % 2) * (hexWidth / 2), y]); } } animateHexagons(); }
        function drawHex(x, y, size, opacity) { ctx.strokeStyle = data.settings.theme === 'dark' ? `rgba(139, 92, 246, ${opacity})` : `rgba(2, 132, 199, ${opacity})`; ctx.lineWidth = 1; ctx.beginPath(); for (let i = 0; i < 6; i++) { ctx.lineTo(x + size * Math.cos(i * Math.PI / 3), y + size * Math.sin(i * Math.PI / 3)); } ctx.closePath(); ctx.stroke(); }
        function animateHexagons() { ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height); let time = Date.now() * 0.0005; hexes.forEach(hex => { let dist = Math.hypot(hex[0] - (particleCanvas.width/2 + Math.cos(time) * 200), hex[1] - (particleCanvas.height/2 + Math.sin(time) * 200)); let opacity = Math.max(0, 1 - dist / 300); drawHex(hex[0], hex[1], hexSize, opacity * 0.5 + 0.1); }); animationFrameId = requestAnimationFrame(animateHexagons); }
        const postponeRevision = (subjectId, chapterId, sourceType, revisionDate) => {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType);
            const revision = chapter?.revisions.find(r => r.date === revisionDate); if (!revision) return;
            document.querySelector(`li [data-revision-date="${revisionDate}"]`)?.closest('.task-list-item')?.classList.add('completed');
            setTimeout(() => { const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); revision.date = tomorrow.toISOString().split('T')[0]; logActivity('skip-forward', `Revision for "${chapter.name}" postponed to tomorrow.`); saveData(); renderHomePage(); }, 500);
        };
        
        // --- MODIFICATION: NEW/UPDATED FUNCTIONS for Manual Add, DPT/Subject Deletion ---

        function openManualAddModal(type) {
            const modal = document.getElementById('manual-add-modal');
            const chapterContent = document.getElementById('manual-add-chapter-content');
            const dptContent = document.getElementById('manual-add-dpt-content');
            const subjectSelect = document.getElementById('manual-add-subject-select');

            modal.dataset.type = type;
            subjectSelect.innerHTML = `<option value="">-- Choose a Subject --</option>` + (data.subjects || []).map(s => `<option value="${s.id}">${_(s.id)}</option>`).join('');
            
            if (type === 'chapter') {
                modal.querySelector('h2').textContent = 'Add Manual Task';
                chapterContent.style.display = 'block';
                dptContent.style.display = 'none';
                document.getElementById('manual-add-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('manual-add-chapter-name').value = '';
            } else { // type === 'dpt'
                modal.querySelector('h2').textContent = 'Add Manual DPT';
                chapterContent.style.display = 'none';
                dptContent.style.display = 'block';
                populateManualItemList(null, 'dpt');
            }
            showModal('manual-add-modal');
        }

        function populateManualItemList(subjectId, type) {
            if (type === 'dpt') {
                 const itemList = document.getElementById('manual-add-item-list');
                if (!subjectId) { itemList.innerHTML = `<p class="text-center text-sm">Please select a subject first.</p>`; return; }
                const dptData = data.dpts[subjectId];
                const nextTestIndex = dptData ? dptData.nextTestIndex : 0;
                const nextTest = dptData ? dptData.tests[nextTestIndex] : null;
                if (!nextTest || nextTest.status === 'Completed') { itemList.innerHTML = `<p class="text-center text-sm">No upcoming DPTs for this subject.</p>`; return; }
                itemList.innerHTML = `<label class="flex items-center gap-2 p-2 rounded-md"><input type="radio" name="manual-add-item" value="${nextTest.id}" checked class="form-radio text-primary"><span>DPT #${nextTest.id} (Next Available)</span></label>`;
            }
        }

        function saveManualTask() {
            const type = document.getElementById('manual-add-modal').dataset.type;
            const subjectId = document.getElementById('manual-add-subject-select').value;
             if (!subjectId) { alert('Please select a subject.'); return; }

            if (type === 'chapter') {
                const chapterName = document.getElementById('manual-add-chapter-name').value.trim();
                const selectedDate = document.getElementById('manual-add-date').value;
                const sourceType = document.querySelector('input[name="manual-add-source"]:checked').value;
                if (!chapterName || !selectedDate || !sourceType) { alert('Please fill all fields: Chapter Name, Date, and Source.'); return; }
                
                const subject = getSubjectById(subjectId);
                if(!subject) return;

                const chapterExists = subject.chapters[sourceType].some(c => c.name.toLowerCase() === chapterName.toLowerCase());
                if(chapterExists) { alert(`A chapter named "${chapterName}" already exists in ${subject.name} (${sourceType}).`); return; }

                const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterName, status: 'Not Started', dateAdded: new Date().toISOString().split('T')[0], notes: '', priorityRevision: false, revisions: [] };
                subject.chapters[sourceType].push(newChapter);
                logActivity('plus-circle', `Manually added new chapter to ${_(subject.id)}: "${chapterName}"`);

                const dateStr = selectedDate;
                data.dailyPlan[dateStr] = data.dailyPlan[dateStr] || { tasks: {}, completedSubjects: [], manualTasks: [] };
                data.dailyPlan[dateStr].manualTasks.push({ subjectId, chapterId: newChapter.id, sourceType, id: `manual-${Date.now()}` });
                logActivity('hand', `Manually scheduled task for "${chapterName}" on ${dateStr}.`);

                saveData();
                hideModal('manual-add-modal');
                if (dateStr === new Date().toISOString().split('T')[0]) { renderHomePage(); }
                if (document.getElementById('page-subjects').classList.contains('active')) { renderSubjectsPage(); }

            } else { // type === 'dpt'
                const selectedRadio = document.querySelector('input[name="manual-add-item"]'); // No check needed, it's auto-selected or message shown
                if (!selectedRadio) { alert('No available DPT to add for this subject.'); return; }
                const testId = parseInt(selectedRadio.value);
                const todayStr = new Date().toISOString().split('T')[0];
                data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr] || [];
                if (!data.dailyDptPlan[todayStr].some(d => d.subjectId === subjectId && d.testId === testId)) {
                    data.dailyDptPlan[todayStr].push({ subjectId, testId, isManual: true, id: `manual-dpt-${Date.now()}` });
                    logActivity('hand', `Manually added DPT for today: ${_(subjectId)} DPT #${testId}`);
                }
                saveData();
                hideModal('manual-add-modal');
                renderHomePage();
            }
        }
        
        function confirmDeleteSubject(subjectId) {
            const subject = getSubjectById(subjectId);
            if (!subject) return;
            showConfirmationModal(_('delete_subject'), _('delete_subject_confirm', { subjectName: _(subject.id) }), () => {
                data.subjects = data.subjects.filter(s => s.id !== subjectId);
                delete data.dpts[subjectId];
                data.missedChapters = (data.missedChapters || []).filter(c => c.subjectId !== subjectId);
                data.postponedChapters = (data.postponedChapters || []).filter(c => c.subjectId !== subjectId);
                Object.keys(data.dailyPlan).forEach(date => {
                    const plan = data.dailyPlan[date];
                    plan.manualTasks = (plan.manualTasks || []).filter(t => t.subjectId !== subjectId);
                    Object.keys(plan.tasks).forEach(key => { if(key.startsWith(subjectId + ':')) delete plan.tasks[key]; });
                });
                Object.keys(data.dailyDptPlan).forEach(date => { data.dailyDptPlan[date] = (data.dailyDptPlan[date] || []).filter(d => d.subjectId !== subjectId); });
                logActivity('trash-2', `Deleted subject: ${_(subject.id)}`);
                saveData(); renderSubjectsPage();
            });
        }
        
        function deleteDpt(subjectId, testId) {
            const dptData = data.dpts[subjectId];
            if (!dptData) return;
            
            const dptName = `${_(subjectId)} DPT #${testId}`;
            showConfirmationModal(_('delete_dpt'), _('delete_dpt_confirm', {dptName}), () => {
                const testIndex = dptData.tests.findIndex(t => t.id === testId);
                if (testIndex === -1) return;
                dptData.tests.splice(testIndex, 1);
                dptData.tests.forEach((test, index) => { test.id = index + 1; });
                if (testIndex < dptData.nextTestIndex) {
                    dptData.nextTestIndex--;
                }
                Object.keys(data.dailyDptPlan).forEach(date => {
                    data.dailyDptPlan[date] = data.dailyDptPlan[date].filter(planItem => !(planItem.subjectId === subjectId && planItem.testId === testId));
                });
                logActivity('trash-2', `Deleted DPT: ${dptName}`);
                saveData();
                hideDptDetailsModal();
                if (document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
                if (document.getElementById('page-analytics').classList.contains('active')) renderAnalyticsPage();
                renderHomePage();
            });
        }


        function addEventListeners() {
            // Desktop and Mobile Nav
            navBtns.forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.page)));
            document.getElementById('mobile-bottom-nav').addEventListener('click', e => {
                const navBtn = e.target.closest('.mobile-nav-btn');
                if (navBtn && navBtn.dataset.page) { navigateTo(navBtn.dataset.page); }
            });
            // MODIFICATION: Add event listener for dashboard toggles
            document.getElementById('page-home').addEventListener('click', e => {
                const toggleBtn = e.target.closest('.toggle-view-btn');
                if (toggleBtn) {
                    const section = toggleBtn.dataset.section;
                    if (dashboardViewState.hasOwnProperty(section)) {
                        dashboardViewState[section] = !dashboardViewState[section];
                        renderHomePage(); // Re-render the home page to reflect the change
                    }
                }
            });

            themeToggleBtns.forEach(btn => btn.addEventListener('click', toggleTheme));
            sidebarToggleBtn.addEventListener('click', toggleSidebar);
            document.getElementById('search-input').addEventListener('input', renderSubjectsPage);
            document.getElementById('language-select').addEventListener('change', (e) => { data.settings.language = e.target.value; saveData(); applyTranslations(); });
            document.getElementById('student-name-input')?.addEventListener('input', (e) => { data.settings.studentName = e.target.value; saveData(); renderHomePage(); });
            
            document.getElementById('subjects-list-container').addEventListener('click', e => { 
                const addBtn = e.target.closest('.add-chapter-btn');
                const chapterItem = e.target.closest('.chapter-item');
                const deleteSubjectBtn = e.target.closest('.delete-subject-btn');
                if (addBtn) { showAddChapterModal(addBtn.dataset.subjectId, addBtn.dataset.sourceType); } 
                else if (chapterItem) { showChapterModal(chapterItem.dataset.subjectId, chapterItem.dataset.chapterId, chapterItem.dataset.sourceType); }
                else if (deleteSubjectBtn) { e.preventDefault(); confirmDeleteSubject(deleteSubjectBtn.dataset.subjectId); }
            });

            document.getElementById('subject-source-filter').addEventListener('click', (e) => {
                const sourceBtn = e.target.closest('.subject-source-btn');
                if(sourceBtn && sourceBtn.dataset.source) { currentSubjectSourceView = sourceBtn.dataset.source; renderSubjectsPage(); }
            });
            document.getElementById('todays-plan-container').addEventListener('click', e => {
                const postponeBtn = e.target.closest('.postpone-btn');
                const skipBtn = e.target.closest('.skip-btn');
                const deleteManualBtn = e.target.closest('.manual-task-delete-btn');
                if (deleteManualBtn) {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const taskId = deleteManualBtn.dataset.manualId;
                    data.dailyPlan[todayStr].manualTasks = data.dailyPlan[todayStr].manualTasks.filter(t => t.id !== taskId);
                    saveData(); renderHomePage(); return;
                }
                const { subjectId, chapterId, sourceType, revisionDate } = postponeBtn?.dataset || skipBtn?.dataset || {};
                if (!subjectId) return;
                e.preventDefault();
                if (revisionDate) { postponeRevision(subjectId, chapterId, sourceType, revisionDate); } 
                else { 
                    if (postponeBtn) { postponeChapter(subjectId, chapterId, sourceType); }
                    if (skipBtn) { skipChapter(subjectId, chapterId, sourceType); }
                }
            });

            document.getElementById('todays-plan-container').addEventListener('change', (e) => { 
                const listItem = e.target.closest('.task-list-item');
                const isManual = e.target.dataset.isManual === 'true';
                if ((e.target.classList.contains('task-checkbox') || e.target.classList.contains('revision-checkbox')) && e.target.checked) {
                    listItem?.classList.add('completed');
                    setTimeout(() => {
                        if (e.target.classList.contains('revision-checkbox')) {
                             updateRevisionStatus(e.target.dataset.subjectId, e.target.dataset.chapterId, e.target.dataset.sourceType, e.target.dataset.revisionDate, true);
                        } else {
                            updateChapterStatus(e.target.dataset.subjectId, e.target.dataset.chapterId, e.target.dataset.sourceType, 'Completed'); 
                            if (!isManual) { markSubjectAsDoneForToday(e.target.dataset.subjectSourcePair); }
                            else {
                                 const todayStr = new Date().toISOString().split('T')[0];
                                 const taskId = listItem.dataset.manualId;
                                 data.dailyPlan[todayStr].manualTasks = data.dailyPlan[todayStr].manualTasks.filter(t => t.id !== taskId);
                                 saveData(); renderHomePage();
                            }
                        }
                    }, 500);
                }
            });

            document.getElementById('download-report-btn').addEventListener('click', () => {
                const btn = document.getElementById('download-report-btn');
                btn.disabled = true; btn.querySelector('span').textContent = 'Generating...';
                html2canvas(document.getElementById('report-content'), { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`Study_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                    btn.disabled = false; btn.querySelector('span').textContent = _('download_pdf');
                });
            });
            document.getElementById('add-chapter-form').addEventListener('submit', e => { e.preventDefault(); addNewChapter(document.getElementById('add-chapter-subject-id').value, document.getElementById('new-chapter-name').value, document.getElementById('add-chapter-source-type').value); });
            document.getElementById('add-subject-form').addEventListener('submit', createSubject);
            document.getElementById('add-new-subject-btn').addEventListener('click', showAddSubjectModal);
            ['close-add-subject-modal', 'close-add-chapter-modal', 'confirm-cancel', 'close-badge-modal', 'close-badge-modal-x', 'close-date-completion-modal', 'close-manual-add-modal'].forEach(id => document.getElementById(id)?.addEventListener('click', () => hideModal(id.replace('close-', '').replace('-x',''))));
            document.getElementById('export-full-data-btn').addEventListener('click', exportData);
            document.getElementById('reset-app-btn').addEventListener('click', resetApp);
            document.getElementById('close-chapter-modal').addEventListener('click', () => hideModal('chapter-modal'));
            document.getElementById('save-chapter-details-btn').addEventListener('click', (e) => { const { subjectId, chapterId, sourceType } = e.currentTarget.dataset; if (subjectId && chapterId) saveChapterDetails(subjectId, chapterId, sourceType); });
            document.getElementById('delete-chapter-details-btn').addEventListener('click', (e) => { const { subjectId, chapterId, sourceType } = e.currentTarget.dataset; if (subjectId && chapterId) confirmDeleteChapter(subjectId, chapterId, sourceType); });
            document.getElementById('chapter-status-buttons').addEventListener('click', (e) => { const clickedBtn = e.target.closest('button'); if (clickedBtn) { document.querySelectorAll('#chapter-status-buttons button').forEach(btn => btn.classList.remove('active')); clickedBtn.classList.add('active'); } });
            const importFileInput = document.getElementById('import-all-chapters-input');
            document.getElementById('import-all-notes-btn').addEventListener('click', () => { importFileInput.dataset.sourceType = 'notes'; importFileInput.click(); });
            document.getElementById('import-all-books-btn').addEventListener('click', () => { importFileInput.dataset.sourceType = 'book'; importFileInput.click(); });
            document.getElementById('delete-all-notes-btn').addEventListener('click', () => deleteAllChaptersForSource('notes'));
            document.getElementById('delete-all-books-btn').addEventListener('click', () => deleteAllChaptersForSource('book'));
            importFileInput.addEventListener('change', importAllChapters);
            document.getElementById('bg-color-start').addEventListener('input', (e) => { data.settings.customThemeColors.start = e.target.value; saveData(); applyCustomTheme(); });
            document.getElementById('bg-color-end').addEventListener('input', (e) => { data.settings.customThemeColors.end = e.target.value; saveData(); applyCustomTheme(); });
            document.getElementById('reset-theme-btn').addEventListener('click', () => { data.settings.customThemeColors = { start: null, end: null }; saveData(); applyCustomTheme(); renderSettingsPage(); });
            document.getElementById('background-style-select').addEventListener('change', (e) => { data.settings.backgroundStyle = e.target.value; saveData(); applyBackgroundStyle(); });
            document.getElementById('page-settings').addEventListener('change', e => {
                if (e.target.name === 'plan-mode') { data.settings.planMode = e.target.value; delete data.dailyPlan[new Date().toISOString().split('T')[0]]; saveData(); renderSettingsPage(); renderHomePage(); }
                if (e.target.name === 'dpt-plan-mode') { data.settings.dptPlanMode = e.target.value; saveData(); renderSettingsPage(); renderHomePage(); }
            });
            document.getElementById('save-custom-cycle-plan')?.addEventListener('click', () => {
                data.settings.customCyclePlan = [...Array(14)].map(() => []);
                document.querySelectorAll('.custom-cycle-subject-checkbox:checked').forEach(cb => { data.settings.customCyclePlan[cb.dataset.day].push(cb.value); });
                data.dailyPlan = {}; saveData(); alert('Custom study plan saved!'); renderHomePage();
            });
            document.getElementById('save-dpt-custom-cycle-plan')?.addEventListener('click', () => {
                data.settings.dptCyclePlan = [...Array(14)].map(() => []);
                document.querySelectorAll('.custom-dpt-subject-checkbox:checked').forEach(cb => { data.settings.dptCyclePlan[cb.dataset.day].push(cb.value); });
                saveData(); alert('Custom DPT plan saved!'); renderHomePage();
            });
            document.getElementById('add-exam-btn').addEventListener('click', () => showAddExamModal());
            document.getElementById('close-add-exam-modal').addEventListener('click', () => hideModal('add-exam-modal'));
            document.getElementById('add-exam-form').addEventListener('submit', e => { e.preventDefault(); saveExam(); });
            document.getElementById('exams-list-container').addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-exam-btn'); const deleteBtn = e.target.closest('.delete-exam-btn');
                if (editBtn) showAddExamModal(editBtn.dataset.examId); if (deleteBtn) deleteExam(deleteBtn.dataset.examId);
            });
            document.getElementById('exam-filter-buttons').addEventListener('click', e => {
                const filterBtn = e.target.closest('.exam-filter-btn');
                if (filterBtn) {
                    currentExamFilter = filterBtn.dataset.filter;
                    document.querySelectorAll('.exam-filter-btn').forEach(btn => { btn.classList.remove('active', 'bg-primary', 'text-white'); btn.classList.add('bg-gray-200', 'dark:bg-gray-700'); });
                    filterBtn.classList.add('active', 'bg-primary', 'text-white'); filterBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    renderExamsPage();
                }
            });
            document.getElementById('date-completion-subject-select').addEventListener('change', (e) => {
                const subjectId = e.target.value; const chapterList = document.getElementById('date-completion-chapter-list');
               if (!subjectId) { chapterList.innerHTML = `<p class="text-center text-sm">Please select a subject first.</p>`; return; }
                const subject = getSubjectById(subjectId);
                const uncompletedChapters = [...(subject.chapters.notes || []), ...(subject.chapters.book || [])].filter(c => c.status === 'Not Started');
                if(uncompletedChapters.length === 0) { chapterList.innerHTML = `<p class="text-center text-sm">No uncompleted chapters.</p>`; return; }
                chapterList.innerHTML = uncompletedChapters.map(c => { const sourceType = (subject.chapters.notes || []).includes(c) ? 'notes' : 'book'; return `<label class="flex items-center gap-2 p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-md cursor-pointer"><input type="radio" name="date-completion-chapter" value="${c.id}" data-source-type="${sourceType}" data-subject-id="${subjectId}" class="form-radio text-primary"><span>${c.name} (${sourceType === 'notes' ? 'N' : 'B'})</span></label>` }).join('');
            });
            document.getElementById('save-date-completion-btn').addEventListener('click', () => {
                const selectedRadio = document.querySelector('input[name="date-completion-chapter"]:checked');
                if (!selectedRadio) { alert('Please select a chapter to mark as complete.'); return; }
                const { subjectId, sourceType } = selectedRadio.dataset; const chapterId = selectedRadio.value;
                const completionDate = document.getElementById('date-completion-modal').dataset.date;
                updateChapterStatus(subjectId, chapterId, sourceType, 'Completed', false, completionDate);
                hideModal('date-completion-modal');
            });
            const progressDropdown = document.getElementById('progress-view-dropdown');
            document.getElementById('toggle-progress-view-btn').addEventListener('click', () => progressDropdown.classList.toggle('hidden'));
            progressDropdown.addEventListener('click', (e) => { e.preventDefault(); const link = e.target.closest('a'); if (link?.dataset.view) { dashboardProgressView = link.dataset.view; renderSubjectWiseProgressDashboard(); progressDropdown.classList.add('hidden'); } });
            document.addEventListener('click', (e) => { if (!e.target.closest('#toggle-progress-view-btn') && !e.target.closest('#progress-view-dropdown')) progressDropdown.classList.add('hidden'); });
            document.getElementById('dpt-subject-filter').addEventListener('change', renderDptPage);
            document.getElementById('page-dpt').addEventListener('click', (e) => {
                const addBtn = e.target.closest('.add-dpt-btn'); const dptItem = e.target.closest('.dpt-list-item'); const addAllBtn = e.target.closest('#add-dpt-all-btn');
                if (addBtn) {
                    const subjectId = addBtn.dataset.subjectId; const num = parseInt(prompt(`How many DPTs to add for ${_(subjectId)}?`));
                    if (!isNaN(num) && num > 0) {
                        data.dpts[subjectId] = data.dpts[subjectId] || { tests: [], nextTestIndex: 0 }; const startId = data.dpts[subjectId].tests.length + 1;
                        for (let i = 0; i < num; i++) { data.dpts[subjectId].tests.push({ id: startId + i, status: 'Pending' }); }
                        logActivity('plus-square', `Added ${num} DPTs for ${_(subjectId)}.`); saveData(); renderDptPage();
                    }
                } else if (dptItem) { showDptDetailsModal(dptItem.dataset.subjectId, dptItem.dataset.testId);
                } else if (addAllBtn) {
                    const num = parseInt(prompt(`How many DPTs to add to ALL subjects?`));
                    if (!isNaN(num) && num > 0) {
                        let subjectsUpdated = 0;
                        (data.subjects || []).forEach(subject => { data.dpts[subject.id] = data.dpts[subject.id] || { tests: [], nextTestIndex: 0 }; const startId = data.dpts[subject.id].tests.length + 1; for (let i = 0; i < num; i++) { data.dpts[subject.id].tests.push({ id: startId + i, status: 'Pending' }); } subjectsUpdated++; });
                        logActivity('plus-square', `Added ${num} DPTs to ${subjectsUpdated} subjects.`); saveData(); renderDptPage();
                    }
                }
            });
            document.getElementById('todays-dpt-container').addEventListener('click', (e) => {
                const completeBtn = e.target.closest('.mark-dpt-complete-btn');
                if (completeBtn) { showDptDetailsModal(completeBtn.dataset.subjectId, completeBtn.dataset.testId); }
                const deleteManualBtn = e.target.closest('.manual-dpt-delete-btn');
                if (deleteManualBtn) {
                    const todayStr = new Date().toISOString().split('T')[0];
                    const taskId = deleteManualBtn.dataset.manualId;
                    data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr].filter(t => t.id !== taskId);
                    saveData(); renderHomePage();
                }
            });

            document.getElementById('dpt-details-form').addEventListener('submit', submitDptDetails);
            document.getElementById('cancel-dpt-details-popup-modal').addEventListener('click', hideDptDetailsModal);
            document.getElementById('delete-dpt-btn').addEventListener('click', () => {
                const subjectId = document.getElementById('dpt-details-subject-id').value;
                const testId = parseInt(document.getElementById('dpt-details-test-id').value);
                deleteDpt(subjectId, testId);
            });
            document.getElementById('close-dpt-details-popup-modal').addEventListener('click', hideDptDetailsModal);
            document.getElementById('add-manual-revision-btn').addEventListener('click', e => { const { subjectId, chapterId, sourceType } = e.currentTarget.dataset; const date = document.getElementById('manual-revision-date').value; addManualRevision(subjectId, chapterId, sourceType, date); });
            document.getElementById('chapter-modal').addEventListener('click', e => { const deleteBtn = e.target.closest('.delete-revision-btn'); if (deleteBtn) { const { subjectId, chapterId, sourceType, revisionDate } = deleteBtn.dataset; deleteRevision(subjectId, chapterId, sourceType, revisionDate); } });
            
            // --- MODIFICATION: Event listeners for new/updated Manual Add feature ---
            document.getElementById('todays-plan-container').addEventListener('click', e => { if (e.target.closest('#manual-add-task-btn')) openManualAddModal('chapter'); });
            document.getElementById('todays-dpt-container').addEventListener('click', e => { if (e.target.closest('#manual-add-dpt-btn')) openManualAddModal('dpt'); });
            document.getElementById('manual-add-subject-select').addEventListener('change', (e) => {
                const modal = document.getElementById('manual-add-modal');
                if(modal.dataset.type === 'dpt') { populateManualItemList(e.target.value, 'dpt'); }
            });
            document.getElementById('save-manual-add-btn').addEventListener('click', saveManualTask);
            
            window.addEventListener('resize', () => { if (data.settings.backgroundStyle !== 'default') { stopAllBackgroundAnimations(); applyBackgroundStyle(); } });
        }
        
        function openDateCompletionModal(dateStr) {
            const modal = document.getElementById('date-completion-modal'); modal.dataset.date = dateStr;
            document.getElementById('date-completion-modal-title').textContent = `Mark Completion for ${new Date(dateStr).toLocaleDateString()}`;
            const subjectSelect = document.getElementById('date-completion-subject-select');
            subjectSelect.innerHTML = `<option value="">-- Choose a Subject --</option>` + (data.subjects || []).map(s => `<option value="${s.id}">${_(s.id)}</option>`).join('');
            document.getElementById('date-completion-chapter-list').innerHTML = `<p class="text-center text-sm">Please select a subject first.</p>`;
            showModal('date-completion-modal');
        }
        
        function showAddSubjectModal() { document.getElementById('add-subject-form').reset(); showModal('add-subject-modal'); }
        
        function createSubject(e) {
            e.preventDefault();
            const subjectName = document.getElementById('new-subject-name').value.trim();
            const selectedSource = document.querySelector('input[name="subject-source"]:checked').value;
            if (subjectName) {
                const subjectId = subjectName.toLowerCase().replace(/\s+/g, '-');
                if ((data.subjects || []).some(s => s.id === subjectId)) { alert(_('subject_exists')); return; }
                const newSubject = { id: subjectId, name: subjectName, chapters: { notes: [], book: [] } };
                data.subjects.push(newSubject);
                if (!translations.en[subjectId]) { translations.en[subjectId] = subjectName; translations.hi[subjectId] = subjectName; }
                logActivity('plus-circle', `New subject added: "${subjectName}"`);
                saveData(); renderSubjectsPage();
                if(document.getElementById('page-settings').classList.contains('active')) renderSettingsPage();
                if(document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
                hideModal('add-subject-modal');
                showAddChapterModal(subjectId, selectedSource);
            }
        }

        function deleteAllChaptersForSource(sourceType) {
            showConfirmationModal( _('delete_all') + '?', _('delete_all_chapters_confirm'), () => {
                    (data.subjects || []).forEach(subject => { if (subject.chapters[sourceType]) { subject.chapters[sourceType] = []; } });
                    logActivity('trash-2', `Deleted all chapters from source: ${sourceType}`);
                    saveData(); alert(`All ${sourceType} chapters have been deleted.`);
                   if (document.getElementById('page-subjects').classList.contains('active')) { renderSubjectsPage(); }
                }
            );
        }

        function renderScheduledRevisions(chapter) {
            const container = document.getElementById('scheduled-revisions-list');
            if (!chapter.revisions || chapter.revisions.length === 0) { container.innerHTML = '<p class="text-xs text-center text-gray-400">No revisions scheduled.</p>'; return; }
            container.innerHTML = chapter.revisions.sort((a,b) => new Date(a.date) - new Date(b.date)).map(rev => {
                const isManual = rev.type === 'manual'; const isPast = new Date(rev.date) < new Date();
                return `<div class="flex items-center justify-between p-2 text-sm rounded-md ${rev.status === 'Completed' ? 'bg-green-100 dark:bg-green-900/40' : 'bg-gray-100 dark:bg-gray-800'}">
                    <span class="font-semibold ${isPast && rev.status !== 'Completed' ? 'text-red-500' : ''}">${new Date(rev.date).toLocaleDateString()}</span>
                    <div><span class="text-xs font-bold px-1.5 py-0.5 rounded ${isManual ? 'bg-violet-200 text-violet-800' : 'bg-blue-200 text-blue-800'}">${isManual ? 'Manual' : 'Auto'}</span>
                    ${isManual ? `<button class="delete-revision-btn p-1 ml-1 text-red-500 hover:bg-red-100 rounded-full" data-revision-date="${rev.date}" data-subject-id="${document.getElementById('add-manual-revision-btn').dataset.subjectId}" data-chapter-id="${chapter.id}" data-source-type="${document.getElementById('add-manual-revision-btn').dataset.sourceType}"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}</div></div>`;
            }).join('');
            lucide.createIcons();
        }

        function addManualRevision(subjectId, chapterId, sourceType, date) {
            if (!date) { alert('Please select a date for the revision.'); return; }
            const chapter = getChapterByIds(subjectId, chapterId, sourceType);
            if (chapter) {
                chapter.revisions.push({ date, status: 'Pending', type: 'manual' });
                logActivity('calendar-plus', `Manual revision scheduled for "${chapter.name}" on ${date}`);
                saveData(); renderScheduledRevisions(chapter);
                document.getElementById('manual-revision-date').value = '';
            }
        }

        function deleteRevision(subjectId, chapterId, sourceType, revisionDate) {
            const chapter = getChapterByIds(subjectId, chapterId, sourceType);
            if (chapter) {
                const initialLength = chapter.revisions.length;
                chapter.revisions = chapter.revisions.filter(r => r.date !== revisionDate);
                if (chapter.revisions.length < initialLength) {
                    logActivity('calendar-minus', `Revision for "${chapter.name}" on ${revisionDate} deleted.`);
                    saveData(); renderScheduledRevisions(chapter);
                }
            }
        }

        init();
    });
    </script>
</body>
</html>
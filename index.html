<!DOCTYPE html>
<html lang="en" class="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Rayen's Digital Study Tracker</title>

<!-- PWA (Progressive Web App) Meta Tags -->
<meta name="theme-color" content="#0ea5e9">
<link rel="manifest" href="manifest.json">

<!-- Apple-specific meta tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Study Tracker">

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- SortableJS (For Drag & Drop) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<!-- jsPDF and html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&display=swap" rel="stylesheet">

<style>
    :root {
        /* Glassmorphism Variables - More Transparent */
        --background-light: #f0f9ff;
        --background-dark: #0c1425;
        --card-light: rgba(255, 255, 255, 0.65); /* Transparent White */
        --card-dark: rgba(15, 23, 42, 0.65);     /* Transparent Dark Blue */
        --text-light: #020617;
        --text-dark: #f1f5f9;
        --text-muted-light: #475569;
        --text-muted-dark: #94a3b8;
        --primary: #0ea5e9;
        --primary-hover: #0284c7;
        --accent: #8b5cf6;
        --danger: #ef4444;
        --warning: #f59e0b;
        --main-bg-start-light: #cffafe;
        --main-bg-end-light: #e0e7ff;
        --main-bg-start-dark: #164e63;
        --main-bg-end-dark: #312e81;
        --border-light: rgba(229, 231, 235, 0.5);
        --border-dark: rgba(55, 65, 81, 0.5);
    }

    /* Base styles */
    html {
        scroll-behavior: smooth;
    }
    
    /* Optimized Lightweight Styles */
    .dashboard-card, .page, #sidebar {
        /* Removed heavy blur for performance */
        background-color: var(--card-light);
    }
    .dark .dashboard-card, .dark .page, .dark #sidebar {
        background-color: var(--card-dark);
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc; /* Very light cool gray */
        color: var(--text-light);
        transition: none; /* Removed transition for speed */
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
        min-height: 100vh;
    }
    
    .dark body {
        background-color: #0f172a; /* Solid dark color, no gradient */
        color: var(--text-dark);
    }

    /* Simple, Fast Backdrop */
    .modal-backdrop > div {
        background: #ffffff !important;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
    }
    .dark .modal-backdrop > div {
        background: #1e293b !important;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5) !important;
        border: 1px solid #334155;
    }

    /* Hide Canvas Completely */
    #particle-canvas { display: none !important; }

    .app-header-title {
        font-family: 'Poppins', sans-serif;
        position: relative;
        overflow: hidden;
        color: var(--text-light); /* Default text color */
        /* Light Mode: Subtle dark shine */
        background: linear-gradient(to right, var(--text-light) 40%, #94a3b8 50%, var(--text-light) 60%);
        background-size: 200% auto;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine-slow 8s linear infinite; /* Very Slow */
        font-weight: 900 !important;
        letter-spacing: 0.5px;
    }
    
    .dark .app-header-title {
        color: var(--text-dark);
        /* Dark Mode: Needle thin white shine */
        background: linear-gradient(to right, #94a3b8 45%, #ffffff 50%, #94a3b8 55%);
        background-size: 200% auto;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        animation: shine-slow 10s linear infinite; /* Extremely Slow */
    }

    @keyframes shine-slow {
        0% { background-position: -200% center; }
        100% { background-position: 200% center; }
    }
    
    /* --- ULTRA PREMIUM GLASSMORPHISM (OPTIMIZED FOR COOLING) --- */
    .dashboard-card {
        /* Reduced blur significantly to prevent GPU heating */
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease; /* Removed complex bezier */
        content-visibility: auto; 
        will-change: transform; /* Hint to browser for optimization */
    }
    
    /* Disable heavy animations on low-power mode preference if available */
    @media (prefers-reduced-motion: reduce) {
        *, ::before, ::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
        }
    }

    /* Custom Background Image Styles Removed for Performance */
    .dark .dashboard-card {
        background: rgba(17, 25, 40, 0.7) !important;
        border: 1px solid rgba(56, 189, 248, 0.2); /* Neon Blue Border */
        box-shadow: 0 0 15px rgba(56, 189, 248, 0.05), inset 0 0 20px rgba(56, 189, 248, 0.05);
    }
    .dark .dashboard-card:hover {
        border-color: rgba(56, 189, 248, 0.6);
        box-shadow: 0 0 25px rgba(56, 189, 248, 0.2), inset 0 0 10px rgba(56, 189, 248, 0.1);
        transform: translateY(-2px);
    }
    .dark .app-header-title {
        color: var(--text-dark);
        background: linear-gradient(110deg, var(--text-dark) 45%, #a78bfa 50%, var(--text-dark) 55%);
        background-size: 250% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine-premium 10s ease-in-out infinite;
    }
    @keyframes shine-premium {
        0% { background-position: 100% 0; }
        15% { background-position: -100% 0; }
        100% { background-position: -100% 0; }
    }
    .dark .app-header-title {
        color: var(--text-dark);
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-list-item {
        animation: slideInUp 0.5s ease-out forwards;
        opacity: 0;
    }
    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .dynamic-content-item {
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }
    .dynamic-content-item.active {
        display: block;
    }

    /* --- PREMIUM GLASSMORPHISM POPUP STYLES (Cyberistic Water Look) --- */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.35); /* हल्का डिम बैकग्राउंड */
        backdrop-filter: blur(8px); /* पीछे का कंटेंट ब्लर (Water Effect) */
        transition: all 0.3s ease-in-out;
        z-index: 9999; /* सबसे ऊपर */
    }

    /* मुख्य पॉपअप कंटेनर - ग्लास इफेक्ट */
    .modal-backdrop > div {
        /* ग्लास बैकग्राउंड: पारदर्शी और ब्लर */
        background: rgba(255, 255, 255, 0.85) !important; 
        backdrop-filter: blur(25px) !important;
        -webkit-backdrop-filter: blur(25px) !important; /* Safari के लिए */
        
        /* प्रीमियम बॉर्डर और चमक */
        border: 1px solid rgba(255, 255, 255, 0.6) !important;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15), inset 0 0 0 1px rgba(255, 255, 255, 0.5) !important;
        border-radius: 24px !important;
        
        /* टेक्स्ट कलर */
        color: #1e293b !important;
        
        /* AI एंट्री एनिमेशन (छोटा से बड़ा होकर आना) */
        animation: aiPopupEntry 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        transform-origin: center center;
        overflow: hidden; /* चमक को अंदर रखने के लिए */
        position: relative;
    }

    /* डार्क मोड के लिए ग्लास इफेक्ट (Fixed Visibility) */
    .dark .modal-backdrop > div {
        background: #1e293b !important; /* गहरा सॉलिड रंग */
        border: 1px solid rgba(148, 163, 184, 0.2) !important; /* बॉर्डर थोड़ा साफ़ */
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), inset 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
        color: #f8fafc !important; /* टेक्स्ट बिल्कुल सफ़ेद */
    }
    /* डार्क मोड में हेडिंग का रंग */
    .dark .modal-backdrop h2, .dark .modal-backdrop h3 {
        color: #60a5fa !important; /* हल्का नीला रंग हेडिंग के लिए */
    }

    /* 'Shining' (चमकने) वाला इफेक्ट */
    .modal-backdrop > div::after {
        content: '';
        position: absolute;
        top: 0;
        left: -150%;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
        transform: skewX(-25deg);
        animation: shine-effect 5s infinite;
        pointer-events: none;
    }
    .dark .modal-backdrop > div::after {
        background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.08), transparent);
    }

    /* पॉपअप आने का AI एनिमेशन */
    @keyframes aiPopupEntry {
        0% { opacity: 0; transform: scale(0.8) translateY(20px); filter: blur(10px); }
        100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0px); }
    }

    /* चमकने का एनिमेशन */
    @keyframes shine-effect {
        0% { left: -150%; }
        20% { left: 150%; } /* तेजी से गुजरेगा */
        100% { left: 150%; } /* रुका रहेगा */
    }

    /* ग्लास मॉडल के अंदर इनपुट बॉक्स */
    .modal-backdrop input, 
    .modal-backdrop select, 
    .modal-backdrop textarea {
        background: rgba(0, 0, 0, 0.05) !important;
        border: 1px solid rgba(0, 0, 0, 0.1) !important;
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
    }
    .dark .modal-backdrop input, 
    .dark .modal-backdrop select, 
    .dark .modal-backdrop textarea {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        color: white !important;
    }
    .modal-backdrop input:focus, .modal-backdrop select:focus, .modal-backdrop textarea:focus {
        background: rgba(255, 255, 255, 0.6) !important;
        box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
        transform: translateY(-2px);
    }
    .dark .modal-backdrop input:focus, .dark .modal-backdrop select:focus, .dark .modal-backdrop textarea:focus {
        background: rgba(255, 255, 255, 0.15) !important;
    }

    /* Close (X) बटन का डिज़ाइन - हमेशा दिखेगा */
    .modal-backdrop > div button[id^="close-"] {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: absolute;
        top: 16px;
        right: 16px;
        z-index: 50;
    }
    .dark .modal-backdrop > div button[id^="close-"] {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255,255,255,0.7);
    }
    .modal-backdrop > div button[id^="close-"]:hover {
        background: #ef4444 !important; /* लाल रंग होवर पर */
        color: white !important;
        transform: rotate(90deg) scale(1.1);
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
    }
    
    .task-list-item.completed {
        transition: opacity 0.5s ease, max-height 0.5s ease, margin 0.5s ease, padding 0.5s ease;
        opacity: 0;
        max-height: 0;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        overflow: hidden;
    }
    .task-list-item {
        transition: opacity 0.5s ease, max-height 0.5s ease, margin 0.5s ease, padding 0.5s ease;
        max-height: 150px;
    }

    .task-note-missed {
        background-color: #ffedd5 !important;
        border-left: 4px solid #f97316;
    }
    .dark .task-note-missed {
        background-color: #3f2715 !important;
        border-left-color: #fb923c;
    }
    
    /* Removed Book/Notes specific colors, keeping generic badge style just in case */
    .source-badge {
        font-size: 0.7rem; font-weight: 700; padding: 2px 6px;
        border-radius: 99px; margin-left: 8px; background-color: var(--primary);
        color: white; opacity: 0.8;
        display: none; /* Hidden by default as we removed source distinction */
    }
    
    #undo-toast {
        position: fixed; bottom: 90px; left: 50%; /* मोबाइल मेनू के ऊपर कर दिया */
        transform: translateX(-50%); z-index: 99999;
        transition: opacity 0.2s ease, transform 0.2s ease;
        opacity: 0; pointer-events: none;
        will-change: opacity, transform; /* परफॉरमेंस बूस्ट */
    }
    #undo-toast.show {
        opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto;
    }
    
    main {
        background: linear-gradient(135deg, var(--main-bg-start-light) 0%, var(--main-bg-end-light) 100%);
    }
    .dark main {
        background: linear-gradient(135deg, var(--main-bg-start-dark) 0%, var(--main-bg-end-dark) 100%);
    }
    
    body.constellation-active main {
        background: transparent;
    }
    
    #sidebar { 
        border-right: 1px solid var(--border-light); 
        transition: all 0.3s ease-in-out; 
        box-shadow: 4px 0 15px -3px rgba(0, 0, 0, 0.07);
    }
    .dark #sidebar { 
        border-color: var(--border-dark); 
        box-shadow: 4px 0 20px -3px rgba(0, 0, 0, 0.2);
    }
    
    .sidebar-collapsed .nav-btn span, .sidebar-collapsed .app-header-title, .sidebar-collapsed #creator-credit span { display: none; }
    .sidebar-collapsed .nav-btn, .sidebar-collapsed #sidebar-toggle-btn { justify-content: center; }

    button, .nav-btn, .chapter-item, .task-action-btn, .dashboard-card, .dpt-list-item {
        transition: transform 0.1s ease-in-out, box-shadow 0.2s ease, background-color 0.2s ease;
    }
    button:active, .nav-btn:active, .chapter-item:active, .task-action-btn:active, .dpt-list-item:active { transform: scale(0.97); }
    .dashboard-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .animated-progress-bar { transition: width 0.8s ease-out; }

    /* Study Day Counter */
    #study-day-counter {
        background: linear-gradient(45deg, #fde68a, #fca5a5, #a78bfa, #7dd3fc);
        color: #1e293b;
        animation: pulse-bg 4s infinite;
        transform-origin: center;
    }
    @keyframes pulse-bg {
        0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(167, 139, 250, 0.5); }
        50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(253, 230, 138, 0.7); }
    }


    /* AI Insights Glow Effect */
    #ai-insights-container {
        position: relative;
        overflow: hidden;
    }
    #ai-insights-container::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(transparent, rgba(139, 92, 246, 0.2), transparent 15%);
        animation: rotate-glow 8s linear infinite;
        transform-origin: center center;
    }
    .dark #ai-insights-container::before {
        background: conic-gradient(transparent, rgba(167, 139, 250, 0.25), transparent 15%);
    }
    @keyframes rotate-glow {
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }


    .btn-neon {
        background-color: transparent;
        color: var(--primary);
        border: 2px solid var(--primary);
        box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), inset 0 0 5px var(--primary);
        animation: neon-pulse 2s infinite;
        transition: color 0.2s, background-color 0.2s, box-shadow 0.2s;
    }
    .btn-neon:hover {
        color: white;
        background-color: var(--primary);
        box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary), 0 0 30px var(--primary);
    }
    .dark .btn-neon {
         color: var(--accent); border-color: var(--accent);
         box-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent), inset 0 0 5px var(--accent);
    }
    .dark .btn-neon:hover {
        color: var(--card-dark); background-color: var(--accent);
        box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent);
    }

    @keyframes neon-pulse { 50% { box-shadow: 0 0 8px var(--primary), 0 0 15px var(--primary), inset 0 0 8px var(--primary), 0 0 20px var(--accent); } }
    .dark @keyframes neon-pulse { 50% { box-shadow: 0 0 8px var(--accent), 0 0 15px var(--accent), inset 0 0 8px var(--accent), 0 0 20px var(--primary); } }

    /* Mobile Navigation Fixes - Ultra Smooth Scroll */
    #mobile-bottom-nav { display: none; }
    
    @media (max-width: 768px) {
        #sidebar, #mobile-menu-btn { display: none !important; }
        
        main { 
            padding-bottom: 80px !important; 
            padding-top: 10px;
            overflow-x: hidden;
        }

        #mobile-bottom-nav { 
            display: flex !important;
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            width: 100%;
            height: 60px; /* Fixed: Reduced height for sleek look */
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(14, 165, 233, 0.2); 
            z-index: 99999; 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
        }
        
        .dark #mobile-bottom-nav { 
            background: rgba(15, 23, 42, 0.95);
            border-top-color: rgba(56, 189, 248, 0.2); 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.5);
        }

        #mobile-bottom-nav::before {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0; height: 100%;
            background: linear-gradient(to top, rgba(14, 165, 233, 0.05), transparent);
            pointer-events: none;
        }

        #mobile-nav-scroller { 
            display: flex; 
            flex-direction: row;
            width: 100%; 
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0 5px;
            align-items: center;
            justify-content: flex-start; 
            gap: 4px;
            -webkit-overflow-scrolling: touch;
        }
        
        #mobile-nav-scroller::-webkit-scrollbar { display: none; }
        #mobile-nav-scroller { -ms-overflow-style: none; scrollbar-width: none; }

        .mobile-nav-btn { 
            flex: 0 0 auto; 
            min-width: 60px; /* Fixed: Reduced width */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 90%;
            color: #64748b; 
            background: transparent;
            border: none;
            padding: 2px;
            border-radius: 12px;
            transition: transform 0.1s;
        }
        
        .mobile-nav-btn.active { 
            color: #0ea5e9; 
            background: rgba(14, 165, 233, 0.1);
            font-weight: bold;
        }
        .dark .mobile-nav-btn { color: #94a3b8; }
        .dark .mobile-nav-btn.active { 
            color: #38bdf8; 
            background: rgba(56, 189, 248, 0.15);
        }

        .mobile-nav-btn i { width: 18px; height: 18px; margin-bottom: 2px; } /* Fixed: Smaller icons */
        .mobile-nav-btn span { font-size: 9px; font-weight: 600; } /* Fixed: Smaller text */
    }
    
    .status-btn-group button.active { background-color: var(--primary); color: white; font-weight: 600; }
    .dark .status-btn-group button.active { background-color: var(--primary-hover); }
    .filter-btn.active { background-color: var(--primary); color: white; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
    
    header, .border-b, .border-t, .border, .border-l-4, .border-2 { border-color: var(--border-light); }
    .dark header, .dark .border-b, .dark .border-t, .dark .border, .dark .border-l-4, .dark .border-2 { border-color: var(--border-dark); }
    input, select, textarea { border-color: var(--border-light); }
    .dark input, .dark select, .dark textarea { border-color: var(--border-dark); }
    .border-primary\/20 { border-color: rgba(14, 165, 233, 0.2); }
    .border-accent\/20 { border-color: rgba(139, 92, 246, 0.2); }
    
    /* Update popup styling */
    #update-popup-modal .update-modal-content {
        background: linear-gradient(145deg, #1e3a8a, #312e81);
        color: #e0e7ff;
        border: 1px solid #4f46e5;
        box-shadow: 0 0 15px #4f46e5, 0 0 30px #4f46e5, inset 0 0 10px #7c3aed;
        position: relative;
        overflow: hidden;
    }
    .dark #update-popup-modal .update-modal-content {
         background: linear-gradient(145deg, #0f172a, #111827);
         color: #dbeafe;
         border: 1px solid #5b21b6;
         box-shadow: 0 0 15px #5b21b6, 0 0 30px #5b21b6, inset 0 0 10px #7c3aed;
    }
    #update-popup-modal .update-modal-content::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(transparent, rgba(167, 139, 250, 0.3), transparent 30%);
        animation: rotate 6s linear infinite;
    }
    #update-popup-modal .update-note-item {
        opacity: 0;
        transform: translateY(15px);
        animation: fadeInItem 0.6s ease-out forwards;
    }
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    @keyframes fadeInItem { to { opacity: 1; transform: translateY(0); } }

    /* Day Selector Styles (Premium) */
    .day-selector-btn {
        transition: all 0.2s ease;
        border: 1px solid var(--border-light);
    }
    .dark .day-selector-btn {
        border-color: var(--border-dark);
    }
    .day-selector-btn.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 0 10px var(--primary);
    }

    /* --- FEATURE TOUR (SPEECH BUBBLE) STYLES --- */
    .feature-tour-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7); z-index: 99998; 
        display: none; opacity: 0; transition: opacity 0.3s ease;
        backdrop-filter: blur(2px);
    }
    .feature-tour-overlay.active { display: block; opacity: 1; }
    
    .tour-bubble {
        position: absolute;
        background: #ffffff;
        color: #1e293b;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.3), 0 20px 60px rgba(0, 0, 0, 0.5);
        max-width: 280px;
        font-size: 14px;
        line-height: 1.5;
        z-index: 100000;
        animation: bubblePop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: auto;
        border: 2px solid #0ea5e9;
    }
    .dark .tour-bubble {
        background: #0f172a;
        color: #f1f5f9;
        border-color: #38bdf8;
        box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.2), 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    /* Fixed Arrow Styling using Pseudo Elements */
    .tour-bubble::before {
        content: '';
        position: absolute;
        width: 0; 
        height: 0; 
        border: 10px solid transparent;
        z-index: 100001;
    }
    .tour-bubble::after {
        content: '';
        position: absolute;
        width: 0; 
        height: 0; 
        border: 13px solid transparent;
        z-index: 100000;
    }

    /* Arrow: Top (Pointing Up) */
    .tour-bubble.arrow-top::before {
        bottom: 100%; left: 50%; margin-left: -10px;
        border-bottom-color: #ffffff;
    }
    .tour-bubble.arrow-top::after {
        bottom: 100%; left: 50%; margin-left: -13px;
        border-bottom-color: #0ea5e9;
    }
    .dark .tour-bubble.arrow-top::before { border-bottom-color: #0f172a; }
    .dark .tour-bubble.arrow-top::after { border-bottom-color: #38bdf8; }

    /* Arrow: Bottom (Pointing Down) */
    .tour-bubble.arrow-bottom::before {
        top: 100%; left: 50%; margin-left: -10px;
        border-top-color: #ffffff;
    }
    .tour-bubble.arrow-bottom::after {
        top: 100%; left: 50%; margin-left: -13px;
        border-top-color: #0ea5e9;
    }
    .dark .tour-bubble.arrow-bottom::before { border-top-color: #0f172a; }
    .dark .tour-bubble.arrow-bottom::after { border-top-color: #38bdf8; }

    /* Arrow: Left (Pointing Left) */
    .tour-bubble.arrow-left::before {
        right: 100%; top: 50%; margin-top: -10px;
        border-right-color: #ffffff;
    }
    .tour-bubble.arrow-left::after {
        right: 100%; top: 50%; margin-top: -13px;
        border-right-color: #0ea5e9;
    }
    .dark .tour-bubble.arrow-left::before { border-right-color: #0f172a; }
    .dark .tour-bubble.arrow-left::after { border-right-color: #38bdf8; }

    /* Arrow: Right (Pointing Right) */
    .tour-bubble.arrow-right::before {
        left: 100%; top: 50%; margin-top: -10px;
        border-left-color: #ffffff;
    }
    .tour-bubble.arrow-right::after {
        left: 100%; top: 50%; margin-top: -13px;
        border-left-color: #0ea5e9;
    }
    .dark .tour-bubble.arrow-right::before { border-left-color: #0f172a; }
    .dark .tour-bubble.arrow-right::after { border-left-color: #38bdf8; }

    .tour-bubble h4 { margin-bottom: 6px; font-weight: 800; color: #0ea5e9; font-family: 'Poppins', sans-serif; font-size: 16px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 6px; }
    .dark .tour-bubble h4 { color: #38bdf8; border-color: rgba(255,255,255,0.1); }
    
    .tour-progress { font-size: 10px; color: #94a3b8; margin-top: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: space-between;}

    .tour-buttons { display: flex; justify-content: flex-end; align-items: center; margin-top: 15px; gap: 8px; }
    .tour-btn-next { background: linear-gradient(135deg, #0ea5e9, #2563eb); color: white; border: none; padding: 8px 18px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.4); font-size: 12px;}
    .tour-btn-next:active { transform: scale(0.95); }
    .tour-btn-skip { background: transparent; color: #64748b; border: none; padding: 6px 12px; font-weight: 600; cursor: pointer; font-size: 12px; }
    .dark .tour-btn-skip { color: #94a3b8; }
    .tour-btn-skip:hover { text-decoration: underline; color: #ef4444; }

    @keyframes bubblePop {
        0% { transform: scale(0.9) translateY(10px); opacity: 0; }
        100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    /* Premium Creator Modal Styles */
    .creator-premium-bg {
        background: linear-gradient(135deg, #FFDEE9 0%, #B5FFFC 25%, #FFFFFF 50%, #E0C3FC 75%, #8EC5FC 100%);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        border: 4px solid transparent;
        border-radius: 30px;
        background-clip: padding-box;
        position: relative;
    }
    .dark .creator-premium-bg {
        background: linear-gradient(135deg, #2d1b4e 0%, #1c1c1c 25%, #0f172a 50%, #1e1b4b 75%, #312e81 100%);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
    }
    /* Rainbow Border Effect */
    .creator-premium-bg::before {
        content: '';
        position: absolute;
        top: -4px; right: -4px; bottom: -4px; left: -4px;
        z-index: -1;
        border-radius: 34px;
        background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
        background-size: 400%;
        animation: rainbowBorder 20s linear infinite;
    }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes rainbowBorder { 0% { background-position: 0 0; } 50% { background-position: 300% 0; } 100% { background-position: 0 0; } }
    
    /* Print-specific styles */
    @media print {
        body.is-printing > *:not(.printable),
        body.is-printing #sidebar,
        body.is-printing #mobile-bottom-nav,
        body.is-printing header,
        body.is-printing button,
        body.is-printing .no-print {
            display: none !important;
        }
        body, html {
            background: #fff !important; color: #000 !important;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        body.is-printing main, body.is-printing .page.printable {
            display: block !important;
            height: auto !important;
            overflow: visible !important;
            padding: 0 !important; margin: 0 !important;
            background: none !important;
            width: 100% !important;
        }
        .page { display: none !important; }
        .page.printable { display: block !important; animation: none !important; }
        .dashboard-card, .bg-card-light {
            box-shadow: none !important; border: 1px solid #ccc !important;
            page-break-inside: avoid;
        }
        .grid { display: block !important; }
        .grid > * { width: 100% !important; }
        canvas { max-width: 100% !important; height: auto !important; }
        .dark, .dark body {
             --background-dark: #ffffff; --card-dark: #ffffff;
             --text-dark: #000000; --text-muted-dark: #333333;
             --border-dark: #cccccc;
        }
    }

    /* --- SPLASH SCREEN STYLES (INTRO) --- */
    #app-splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #0f172a; /* Dark Blue base */
        z-index: 1000000; /* Highest priority */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
    }
    
    .light #app-splash-screen {
        background-color: #f0f9ff; /* Light Blue base for light mode */
    }

    .splash-content {
        text-align: center;
        animation: splashEntry 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .splash-logo-icon {
        width: 80px;
        height: 80px;
        color: #0ea5e9;
        margin-bottom: 20px;
        filter: drop-shadow(0 0 15px rgba(14, 165, 233, 0.5));
        animation: pulse-splash 2s infinite;
    }

    .splash-title {
        font-family: 'Poppins', sans-serif;
        font-size: 2.5rem;
        font-weight: 900;
        background: linear-gradient(to right, #0ea5e9, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 5px;
        letter-spacing: -1px;
    }

    .splash-subtitle {
        font-family: 'Inter', sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        color: #94a3b8;
        letter-spacing: 2px;
        text-transform: uppercase;
        opacity: 0;
        animation: fadeInSubtitle 1s ease-out 0.5s forwards;
    }

    @keyframes splashEntry {
        0% { transform: scale(0.8) translateY(20px); opacity: 0; }
        100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    @keyframes fadeInSubtitle {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse-splash {
        0%, 100% { transform: scale(1); filter: drop-shadow(0 0 15px rgba(14, 165, 233, 0.5)); }
        50% { transform: scale(1.1); filter: drop-shadow(0 0 25px rgba(139, 92, 246, 0.6)); }
    }

    /* Hide scrollbar during splash */
    body.splash-active {
        overflow: hidden !important;
    }

</style>
</head>
<body class="text-text-light dark:text-text-dark splash-active">
    
<!-- SPLASH SCREEN INTRO -->
<div id="app-splash-screen">
    <div class="splash-content">
        <!-- SVG Icon manually for instant load -->
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="splash-logo-icon mx-auto"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        <h1 class="splash-title">Study Tracker</h1>
        <p class="splash-subtitle">Designed by Rayen</p>
    </div>
</div>

<canvas id="particle-canvas" style="display: none !important; pointer-events: none;"></canvas>

<div class="flex h-screen bg-transparent">
    <aside id="sidebar" class="flex flex-col w-64 bg-card-light dark:bg-card-dark relative">
        <div class="flex items-center justify-between p-4 border-b h-16">
            <h1 class="text-xl font-extrabold app-header-title" data-translate="study_tracker">Study Tracker</h1>
        </div>
        <nav class="flex-grow p-4 space-y-2 no-scrollbar overflow-y-auto">
            <button data-page="home" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="home" class="w-5 h-5"></i> <span data-translate="home">Home</span></button>
            <button data-page="subjects" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="book-open" class="w-5 h-5"></i> <span data-translate="subjects">Subjects</span></button>
            <button data-page="dpt" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="clipboard-check" class="w-5 h-5"></i> <span data-translate="dpt">DPT</span></button>
            <button data-page="exams" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="briefcase" class="w-5 h-5"></i> <span data-translate="exams">Exams</span></button>
            <button data-page="url" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="globe" class="w-5 h-5"></i> <span>URL</span></button>
            <button data-page="import-export" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="arrow-right-left" class="w-5 h-5"></i> <span data-translate="import_export">Import/Export</span></button>
            <button data-page="calendar" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="calendar" class="w-5 h-5"></i> <span data-translate="calendar">Calendar</span></button>
            <button data-page="analytics" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="bar-chart-3" class="w-5 h-5"></i> <span data-translate="analytics">Analytics</span></button>
            <button data-page="report" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="clipboard-list" class="w-5 h-5"></i> <span data-translate="report">Report</span></button>
            <button data-page="notices" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="sticky-note" class="w-5 h-5"></i> <span>Notes & History</span></button>
            <button data-page="settings" class="nav-btn w-full flex items-center gap-3 px-4 py-2.5 rounded-lg font-semibold text-base"><i data-lucide="settings" class="w-5 h-5"></i> <span data-translate="settings">Settings</span></button>
        </nav>
        <div class="p-4 border-t space-y-2">
             <button id="view-updates-btn-sidebar" class="w-full flex items-center justify-center gap-3 p-3 rounded-lg bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white font-bold shadow-lg hover:opacity-90 transition-all">
                <i data-lucide="sparkles" class="w-5 h-5 animate-pulse"></i>
                <span class="md:inline text-xs uppercase tracking-wider">What's New</span>
            </button>
            <button id="theme-toggle-btn" class="w-full flex items-center justify-center gap-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700" title="Switch Theme (Light/Dark/System)">
                <i data-lucide="sun" id="theme-icon-sun"></i>
                <i data-lucide="moon" id="theme-icon-moon" class="hidden"></i>
                <i data-lucide="laptop" id="theme-icon-system" class="hidden"></i>
                <span id="theme-text-sidebar" class="text-xs font-bold uppercase hidden md:inline"></span>
            </button>
            <button id="sidebar-toggle-btn" class="w-full hidden md:flex items-center justify-center gap-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700">
                <i data-lucide="chevrons-left" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="creator-credit" class="p-4 text-center text-xs text-text-muted-light dark:text-text-muted-dark">
            <span class="font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-purple-600">Aidesignedapp@Rayen</span>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-screen max-h-screen">
        <header class="flex items-center justify-between p-4 border-b sticky top-0 bg-card-light/80 dark:bg-card-dark/80 backdrop-blur-sm z-10">
            <button id="mobile-menu-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 md:hidden">
                <i data-lucide="menu"></i>
            </button>
            <div class="text-center flex-grow">
                <h1 class="text-lg font-extrabold app-header-title">Study Tracker</h1>
                <p class="text-xs text-text-muted-light dark:text-text-muted-dark -mt-1">Designed by Rayen</p>
            </div>
             <div class="absolute top-1/2 -translate-y-1/2 right-4 flex items-center gap-2">
                <!-- Study Day Counter -->
                <div id="study-day-counter" class="text-xs font-bold p-2 rounded-full shadow-lg flex items-center gap-1.5 bg-white/80 dark:bg-black/50 backdrop-blur-sm border border-gray-200 dark:border-gray-700">
                    <i data-lucide="calendar-check-2" class="w-4 h-4 text-amber-500"></i>
                    <span id="study-day-text">Day 1</span>
                </div>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto p-4 md:p-6 pb-4 no-scrollbar relative">
<div id="page-home" class="page active">
                <div class="mb-6">
                    <h2 id="welcome-heading" class="text-3xl font-bold">Welcome, Rayen!</h2>
                    <p class="text-text-muted-light dark:text-text-muted-dark" data-translate="welcome_subtitle">Here's your plan for today. Let's get it done!</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- AI Insights & Exam Countdown -->
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                            <div id="ai-insights-container" class="md:col-span-3 dashboard-card bg-violet-50 dark:bg-violet-900/30 border-2 p-4 rounded-xl shadow-sm min-h-[120px]"></div>
                            <div id="dashboard-exams-container" class="md:col-span-2 dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"></div>
                        </div>
                        
                        <!-- Today's Plan & DPT -->
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold" data-translate="todays_plan">Today's Plan</h2>
                        </div>
                        <div id="recent-updates-container" class="hidden"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="todays-plan-container-wrapper">
                                <div id="todays-plan-container" class="dashboard-card bg-sky-50 dark:bg-sky-900/30 border-2 p-4 rounded-xl shadow-sm min-h-[180px]"></div>
                                <div id="completed-tasks-toggle-container" class="mt-2 text-center" style="display: none;">
                                    <button id="toggle-completed-tasks-btn" class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center justify-center w-full p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                                        <span id="completed-tasks-count"></span> Completed Task(s)
                                        <i data-lucide="chevron-down" class="w-4 h-4 ml-1 transition-transform"></i>
                                    </button>
                                </div>
                                <div id="completed-tasks-list" class="hidden mt-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg space-y-1">
                                    <!-- Completed tasks will be injected here -->
                                </div>
                            </div>
                            <div id="todays-dpt-container-wrapper">
                                <div id="todays-dpt-container" class="dashboard-card bg-gradient-to-br from-amber-100 to-orange-200 dark:from-amber-800 dark:to-orange-900 p-4 rounded-xl shadow-sm min-h-[100px]"></div>
                                <!-- NEW: Completed DPT Dropdown -->
                                <div id="completed-dpt-toggle-container" class="mt-2 text-center" style="display: none;">
                                    <button id="toggle-completed-dpt-btn" class="text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center justify-center w-full p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                                        <span id="completed-dpt-count"></span> Completed DPT(s)
                                        <i data-lucide="chevron-down" class="w-4 h-4 ml-1 transition-transform"></i>
                                    </button>
                                </div>
                                <div id="completed-dpt-list" class="hidden mt-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg space-y-1">
                                    <!-- Completed DPTs will be injected here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Other Sections -->
                        <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                            <h2 class="text-lg font-bold mb-3" data-translate="tomorrows_topics">Tomorrow's Topics</h2>
                            <div id="tomorrows-plan-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div>
                        </div>
                         <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                            <h2 class="text-lg font-bold mb-3" data-translate="yesterdays_completed">Yesterday's Completed Chapters</h2>
                            <div id="yesterdays-completed-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark"></div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="lg:col-span-1 space-y-6">
                         <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                            <h2 class="text-lg font-bold text-center" data-translate="overall_progress">Overall Progress</h2>
                            <div class="flex flex-col items-center gap-4 mt-2">
                                <div class="relative w-40 h-40"><canvas id="overall-progress-chart"></canvas><div id="overall-progress-text" class="absolute inset-0 flex items-center justify-center text-4xl font-bold"></div></div>
                                <div class="text-center">
                                    <p class="text-base text-text-muted-light dark:text-text-muted-dark"><span data-translate="chapters_completed">Chapters Completed</span>: <span id="chapters-completed-count" class="font-semibold">0 / 0</span></p>
                                </div>
                            </div>
                         </div>

                        <div class="dashboard-card bg-card-light dark:bg-[#0c1425] p-0 rounded-xl shadow-lg border border-cyan-500/30 relative overflow-hidden group hover:shadow-cyan-500/20 transition-all duration-300">
                            <div class="p-4 border-b border-cyan-500/20 bg-gradient-to-r from-cyan-500/5 to-purple-500/5 backdrop-blur-sm">
                                <h2 class="text-lg font-bold flex items-center gap-2 relative z-10">
                                    <i data-lucide="file-signature" class="text-cyan-400 animate-pulse"></i>
                                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-purple-400 drop-shadow-sm">Applied Exams Form</span>
                                </h2>
                            </div>
                            <div id="dashboard-upcoming-exams-list" class="relative z-10 h-64 overflow-y-auto no-scrollbar p-2 bg-gradient-to-b from-transparent via-cyan-900/5 to-transparent"></div>
                            
                            <div class="absolute top-0 right-0 w-20 h-20 bg-cyan-500/10 blur-[50px] rounded-full pointer-events-none"></div>
                            <div class="absolute bottom-0 left-0 w-20 h-20 bg-purple-500/10 blur-[50px] rounded-full pointer-events-none"></div>
                        </div>
                        <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3 flex items-center gap-2"><i data-lucide="award" class="text-amber-500"></i><span data-translate="achievements">Achievements</span></h2><div id="badges-container" class="space-y-3"></div></div>
                        
                        <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3 flex items-center gap-2"><i data-lucide="repeat" class="text-teal-500"></i><span data-translate="upcoming_revisions">Upcoming Revisions</span></h2><div id="revisions-container" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark min-h-[60px]"></div></div>
                       
                        <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-red-600 dark:text-red-400"><i data-lucide="alert-triangle"></i><span data-translate="missed_chapters">Missed Chapters</span></h2><div id="missed-chapters-list" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark min-h-[60px]"></div></div>
                        
                        <div id="missed-other-tasks-card" class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm hidden"><h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-gray-600 dark:text-gray-400"><i data-lucide="clipboard-x"></i><span>Missed Other Tasks</span></h2><div id="missed-other-tasks-list" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark min-h-[60px]"></div></div>

                        <div class="dashboard-card bg-orange-50 dark:bg-orange-900/50 p-4 rounded-xl shadow-sm"><h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-orange-600 dark:text-orange-400"><i data-lucide="history"></i><span>Missed Revisions</span></h2><div id="missed-revisions-list" class="space-y-2 text-sm text-text-muted-light dark:text-text-muted-dark min-h-[60px]"></div></div>

                        <div class="dashboard-card bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm">
                            <div class="flex justify-center items-center gap-2 mb-3 relative">
                                <h2 id="subject-progress-title" class="text-lg font-bold text-center">Subject Progress</h2>
                                <!-- Removed Toggle Button for Notes/Book View -->
                            </div>
                            <div id="subject-progress-dashboard-container" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>
<div id="page-subjects" class="page">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-4">
                     <div class="flex items-center gap-4 flex-wrap">
                        <h2 class="text-2xl font-bold flex-shrink-0" data-translate="subjects_chapters">Subjects & Chapters</h2>
                        <!-- Removed Source Filter (Notes/Book) -->
                        <div id="subject-view-filter" class="flex items-center p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                            <button data-view="all" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md active">All Chapters</button>
                            <button data-view="completed" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">Completed</button>
                            <button data-view="postponed" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md text-amber-600 dark:text-amber-400">Postponed</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="add-new-subject-btn" class="flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg btn-neon">
                            <i data-lucide="plus" class="w-4 h-4"></i> <span data-translate="add_new_subject">Add New Subject</span>
                        </button>
                        <input id="search-input" type="text" data-translate-placeholder="search_chapters" placeholder="Search chapters..." class="w-full md:w-auto px-3 py-1.5 text-sm bg-card-light dark:bg-card-dark border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                    </div>
                </div>
                <div id="subjects-list-container" class="space-y-3"></div>
            </div>
            
            <div id="page-dpt" class="page">
                 <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold" data-translate="dpt_page_title">Daily Practice Tests (DPT)</h2>
                    <div class="flex items-center gap-3 flex-wrap">
                         <div id="dpt-view-filter" class="flex items-center p-1 bg-gray-100 dark:bg-gray-800 rounded-lg">
                            <button data-view="pending" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md active">Pending</button>
                            <button data-view="completed" class="filter-btn px-3 py-1 text-sm font-semibold rounded-md">Completed</button>
                        </div>
                        <select id="dpt-subject-filter" class="p-2 bg-card-light dark:bg-card-dark border rounded-lg"></select>
                        <input id="dpt-search-input" type="search" placeholder="Search chapters..." class="w-full md:w-auto px-3 py-1.5 text-sm bg-card-light dark:bg-card-dark border rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
                    </div>
                </div>
                
                <div id="dpt-summary-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                </div>
                
                <div id="dpt-global-actions-container" class="mb-4"></div>

                <div id="dpt-list-container" class="space-y-4">
                </div>
            </div>

            <div id="page-exams" class="page">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold" data-translate="exams_and_forms">Exams & Applied Forms</h2>
                    <div class="flex items-center gap-2 flex-wrap" id="exam-filter-buttons">
                        <button data-filter="all" class="exam-filter-btn active bg-primary text-white px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="all">All</button>
                        <button data-filter="upcoming" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="upcoming_exams">Upcoming Exams</button>
                        <button data-filter="applied" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="applied_forms">Applied Forms</button>
                        <button data-filter="history" class="exam-filter-btn bg-gray-200 dark:bg-gray-700 px-3 py-1.5 text-sm font-semibold rounded-lg" data-translate="history_exams">History</button>
                    </div>
                    <button id="add-exam-btn" class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg btn-neon">
                        <i data-lucide="plus" class="w-4 h-4"></i> <span data-translate="add_new_exam">Add New Exam</span>
                    </button>
                </div>
                <div id="exams-list-container" class="space-y-4">
                </div>
            </div>
<div id="page-url" class="page">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-4">
                    <h2 class="text-2xl font-bold flex-shrink-0" data-translate="url_title">Saved URLs</h2>
                    <button id="add-new-root-folder-btn" class="flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-lg btn-neon">
                        <i data-lucide="folder-plus" class="w-4 h-4"></i> <span data-translate="add_new_folder">Add New Folder</span>
                    </button>
                </div>
                <div id="url-container" class="space-y-3"></div>
            </div>

            <div id="page-import-export" class="page">
                <h2 class="text-2xl font-bold mb-4" data-translate="import_export_data">Import & Export Data</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="md:col-span-2 p-5 bg-card-light dark:bg-card-dark rounded-xl shadow-sm border border-gray-100 dark:border-gray-800">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-violet-100 dark:bg-violet-900/50 rounded-lg text-violet-600">
                                <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg" data-translate="routine_management">Routine Management</h3>
                                <p class="text-xs text-text-muted-light dark:text-text-muted-dark">Choose between the default study cycle or your own custom plan.</p>
                            </div>
                        </div>

                        <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg mb-4">
                            <button id="routine-mode-default-btn" class="flex-1 py-2 text-sm font-bold rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all">Default Routine</button>
                            <button id="routine-mode-custom-btn" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-all">Custom Upload</button>
                        </div>

                        <div id="routine-default-content" class="p-4 bg-violet-50 dark:bg-violet-900/20 rounded-lg border border-violet-100 dark:border-violet-900/50 animate-fadeIn">
                            <div class="flex items-center gap-2 text-violet-700 dark:text-violet-300 mb-2">
                                <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                                <span class="font-bold">Default Mode Active</span>
                            </div>
                            <p class="text-sm opacity-80 mb-3">You are using the recommended 14-day study cycle. This is best for beginners.</p>
                            <div class="flex gap-2">
                                <button id="restore-default-routine-btn" class="px-4 py-2 bg-violet-600 text-white text-sm font-bold rounded-lg hover:bg-violet-700">Re-Apply Default Routine</button>
                                <button id="export-routine-pdf-btn" class="flex-1 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-sm font-bold rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Export PDF</button>
                            </div>
                        </div>

                        <div id="routine-custom-content" class="hidden p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 animate-fadeIn">
                             <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300 mb-2">
                                <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                                <span class="font-bold">Custom Mode</span>
                            </div>
                            <p class="text-sm opacity-80 mb-3">Upload your own JSON file to replace the study schedule.</p>
                            <div class="flex gap-2">
                                <button id="import-routine-btn" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-sm font-bold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Import Custom JSON</button>
                                <button id="export-routine-json-btn" class="flex-1 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-sm font-bold rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Export JSON</button>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 p-5 bg-card-light dark:bg-card-dark rounded-xl shadow-sm border border-gray-100 dark:border-gray-800">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-cyan-100 dark:bg-cyan-900/50 rounded-lg text-cyan-600">
                                <i data-lucide="library" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg" data-translate="chapters_data_management">Chapters Management</h3>
                                <p class="text-xs text-text-muted-light dark:text-text-muted-dark">Manage your subject chapters database.</p>
                            </div>
                        </div>

                        <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg mb-4">
                            <button id="chapter-mode-default-btn" class="flex-1 py-2 text-sm font-bold rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all">Default Chapters</button>
                            <button id="chapter-mode-custom-btn" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-all">Custom Upload</button>
                        </div>

                        <div id="chapter-default-content" class="hidden"></div>

                        <div id="chapter-custom-content" class="hidden p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 animate-fadeIn">
                             <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300 mb-2">
                                <i data-lucide="folder-up" class="w-5 h-5"></i>
                                <span class="font-bold">Custom Database</span>
                            </div>
                            <p class="text-sm opacity-80 mb-3">Add your own chapters from a file or clean everything.</p>
                            <div class="flex gap-2">
                                <button id="import-all-chapters-btn" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-sm font-bold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Import Chapters</button>
                                <button id="delete-all-chapters-btn" class="flex-1 px-4 py-2 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-300 text-sm font-bold rounded-lg hover:bg-red-200 dark:hover:bg-red-900">Delete All</button>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                        <h3 class="font-semibold mb-3 text-lg" data-translate="exams_data_management">Exams Data</h3>
                        <div class="flex gap-2">
                            <button id="import-exams-btn" class="flex-1 p-2 text-xs font-bold rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">Import</button>
                            <button id="export-exams-btn" class="flex-1 p-2 text-xs font-bold rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">Export</button>
                        </div>
                    </div>

                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                        <h3 class="font-semibold mb-3 text-lg">URL Data</h3>
                        <div class="flex gap-2">
                            <button id="import-urls-btn" class="flex-1 p-2 text-xs font-bold rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">Import</button>
                            <button id="export-urls-btn" class="flex-1 p-2 text-xs font-bold rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200">Export</button>
                        </div>
                    </div>

                    <div class="md:col-span-2 p-4 bg-gradient-to-r from-gray-800 to-gray-900 text-white rounded-xl shadow-lg">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                            <div>
                                <h3 class="font-bold text-lg" data-translate="full_app_backup">Full Backup (All Data)</h3>
                                <p class="text-xs text-gray-300">Save everything including progress, settings, and logs.</p>
                            </div>
                             <div class="flex gap-3">
                                <button id="import-full-backup-btn" class="px-4 py-2 text-sm font-bold rounded-lg bg-white/10 hover:bg-white/20 border border-white/20">Import Backup</button>
                                <button id="export-full-data-btn" class="px-4 py-2 text-sm font-bold rounded-lg bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/30">Download Backup</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="page-calendar" class="page">
                <h2 class="text-2xl font-bold mb-4" data-translate="study_calendar">Study Calendar</h2>
                <div id="calendar-view" class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm"></div>
            </div>
            
            <div id="page-analytics" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold" data-translate="analytics_reports">Analytics & Reports</h2>
                    </div>
                <div id="analytics-content-container">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="total_chapters_done">Total Chapters Done</h3><p id="metric-total-completed" class="text-3xl font-bold text-primary">0</p></div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="average_per_day">Average per Day</h3><p id="metric-avg-per-day" class="text-3xl font-bold text-accent">0.0</p></div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="best_day">Best Day</h3><p id="metric-best-day" class="text-3xl font-bold text-warning">-</p></div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="total_dpt_completed">Total DPTs Done</h3><p id="metric-total-dpt" class="text-3xl font-bold text-orange-500">0</p></div>
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm font-medium text-text-muted-light dark:text-text-muted-dark" data-translate="overall_accuracy">Overall Accuracy</h3><p id="metric-dpt-accuracy" class="text-3xl font-bold text-teal-500">0%</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="chapter_status_distribution">Chapter Status Distribution</h3><div class="relative h-80"><canvas id="chapter-status-chart"></canvas></div></div>
                        <div class="bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="weekly_productivity">Weekly Productivity (Chapters Done)</h3><div class="relative h-80"><canvas id="weekly-productivity-chart"></canvas></div></div>
                        <div class="lg:col-span-2 bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2" data-translate="subject_wise_progress">Subject-wise Progress (%)</h3><div class="relative h-96"><canvas id="subject-progress-chart"></canvas></div></div>
                        <div class="lg:col-span-2 bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2">DPT Performance by Subject (Accuracy %)</h3><div class="relative h-80"><canvas id="dpt-performance-chart"></canvas></div></div>
                        <div class="lg:col-span-2 bg-card-light dark:bg-card-dark p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-2">DPT Practice Count by Chapter</h3><div class="relative h-96"><canvas id="dpt-chapter-chart"></canvas></div></div>
                    </div>
                </div>
            </div>

            <div id="page-report" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" data-translate="study_report">Study Report</h2>
                </div>
                <div id="report-content-container">
                </div>
            </div>

            <div id="page-notices" class="page">
                <h2 class="text-2xl font-bold mb-4">Notes & History</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Left Column: Personal Notes & Future Queue -->
                    <div class="space-y-6">
                        <!-- Personal Notes Box -->
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm border border-indigo-100 dark:border-indigo-900/30">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="pen-tool" class="text-indigo-500"></i> Personal Notes</h3>
                                <button id="add-personal-note-btn" class="px-3 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg shadow hover:bg-indigo-700">Add Note</button>
                            </div>
                            <div id="personal-notes-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                                <!-- Notes will be injected here -->
                            </div>
                        </div>

                        <!-- NEW: Future Task Queue Box (Red Box Area) -->
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm border border-purple-100 dark:border-purple-900/30">
                            <h3 class="font-bold text-lg mb-3 flex items-center gap-2 text-purple-600 dark:text-purple-400">
                                <i data-lucide="calendar-clock" class="w-5 h-5"></i> Future Task Queue
                            </h3>
                            <p class="text-xs text-text-muted-light dark:text-text-muted-dark mb-3">Upcoming tasks scheduled for later dates.</p>
                            <div id="future-tasks-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-1 custom-scrollbar">
                                <!-- Future Tasks will be injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Task History (Today + Overdue + Past) -->
                    <div class="space-y-4">
                        <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm border border-orange-100 dark:border-orange-900/30">
                            <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i data-lucide="history" class="text-orange-500"></i> Task History & Today</h3>
                            <p class="text-xs text-text-muted-light dark:text-text-muted-dark mb-3">Today's pending tasks and history (Last 30 Days).</p>
                            <div id="other-tasks-history-list" class="space-y-2 max-h-[750px] overflow-y-auto pr-1 custom-scrollbar">
                                <!-- History & Today will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-updates" class="page">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="p-3 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg shadow-purple-500/30">
                            <i data-lucide="sparkles" class="w-8 h-8 text-white animate-pulse"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">What's New</h2>
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Latest features & improvements.</p>
                        </div>
                    </div>
                    <div id="updates-content-list" class="space-y-6">
                        </div>
                </div>
            </div>

            <div id="page-settings" class="page">
                <h2 class="text-2xl font-bold mb-4" data-translate="settings">Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                        <label for="student-name-input" class="font-semibold" data-translate="student_name">Student Name</label>
                        <input type="text" id="student-name-input" data-translate-placeholder="student_name_placeholder" placeholder="Enter your name..." class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border rounded-lg">
                    </div>
                    
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                        <label for="language-select" class="font-semibold" data-translate="app_language">Application Language</label>
                        <select id="language-select" class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border rounded-lg">
                            <option value="en">English</option>
                            <option value="hi">हिंदी (Hindi)</option>
                        </select>
                    </div>
                    
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                        <label for="background-style-select" class="font-semibold">Background Style</label>
                        <select id="background-style-select" class="mt-2 w-full p-2 bg-gray-50 dark:bg-gray-800/50 border rounded-lg">
                            <option value="default">Default Gradient</option>
                            <option value="constellation">Cyber Constellation</option>
                        </select>
                        <p class="text-[10px] text-text-muted-light dark:text-text-muted-dark mt-2">Custom Image upload removed for better performance.</p>
                    </div>
                    
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                         <h3 class="font-semibold">Gradient Theme</h3>
                         <div class="grid grid-cols-2 gap-4 items-center mt-2">
                             <div>
                                 <label for="bg-color-start" class="text-sm font-medium">Start</label>
                                 <input type="color" id="bg-color-start" class="mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                             </div>
                             <div>
                                 <label for="bg-color-end" class="text-sm font-medium">End</label>
                                 <input type="color" id="bg-color-end" class="mt-1 w-full h-10 p-1 border-none rounded-md cursor-pointer">
                             </div>
                         </div>
                         <button id="reset-theme-btn" class="mt-3 w-full text-sm p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Reset to Default</button>
                    </div>
                    
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex-grow">
                             <h3 class="font-semibold text-sm">Theme Colors (Advanced)</h3>
                             <p class="text-xs text-text-muted-light dark:text-text-muted-dark">Customize text & borders.</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="flex flex-col items-center gap-1" title="Light Text">
                                <input type="color" id="color-text-light" data-color-type="textLight" class="adv-color-picker w-8 h-8 rounded-full border-2 border-gray-300 cursor-pointer p-0 overflow-hidden">
                                <span class="text-[10px] font-bold">L-Text</span>
                            </div>
                            <div class="flex flex-col items-center gap-1" title="Light Border">
                                <input type="color" id="color-border-light" data-color-type="borderLight" class="adv-color-picker w-8 h-8 rounded-full border-2 border-gray-300 cursor-pointer p-0 overflow-hidden">
                                <span class="text-[10px] font-bold">L-Bord</span>
                            </div>
                            <div class="w-px h-8 bg-gray-300 dark:bg-gray-700 mx-2"></div>
                            <div class="flex flex-col items-center gap-1" title="Dark Text">
                                <input type="color" id="color-text-dark" data-color-type="textDark" class="adv-color-picker w-8 h-8 rounded-full border-2 border-gray-600 cursor-pointer p-0 overflow-hidden">
                                <span class="text-[10px] font-bold">D-Text</span>
                            </div>
                            <div class="flex flex-col items-center gap-1" title="Dark Border">
                                <input type="color" id="color-border-dark" data-color-type="borderDark" class="adv-color-picker w-8 h-8 rounded-full border-2 border-gray-600 cursor-pointer p-0 overflow-hidden">
                                <span class="text-[10px] font-bold">D-Bord</span>
                            </div>
                        </div>
                        <button id="reset-advanced-colors-btn" class="px-3 py-1 text-xs font-bold rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Reset</button>
                    </div>

                    <!-- New Global DPT Toggle -->
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm border-l-4 border-indigo-500">
                        <h3 class="font-semibold mb-2">DPT Dashboard Display</h3>
                        <p class="text-xs text-text-muted-light dark:text-text-muted-dark mb-3">Show or Hide DPT section on Home Dashboard.</p>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="global-dpt-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300" id="dpt-toggle-text">Active</span>
                        </label>
                    </div>

                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2">
                        <h3 class="font-semibold mb-3" data-translate="daily_plan_mode">Daily Study Plan Mode</h3>
                        <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-3" data-translate="daily_plan_subtitle">Choose how you want to generate your daily study plan.</p>
                        <div class="flex flex-wrap gap-4 mb-4">
                            <label class="flex items-center gap-2"><input type="radio" name="plan-mode" value="auto" class="form-radio text-primary"> <span data-translate="auto_rotation">Automatic Rotation</span></label>
                            <label class="flex items-center gap-2"><input type="radio" name="plan-mode" value="custom_cycle" class="form-radio text-primary"> <span data-translate="custom_cycle">Custom Cycle</span></label>
                        </div>
                    </div>
                    
                    <div id="custom-cycle-plan-container" class="hidden md:col-span-2 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm transition-all duration-300">
                        <div class="collapsible-header flex justify-between items-center cursor-pointer">
                            <h3 class="font-semibold" data-translate="custom_study_plan">Custom Study Plan (2 Week Cycle)</h3>
                            <i data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-300"></i>
                        </div>
                        <div class="collapsible-content hidden mt-4">
                            <div id="custom-cycle-subject-selector" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                            <button id="save-custom-cycle-plan" class="mt-4 px-4 py-2 btn-neon font-semibold rounded-lg" data-translate="save_custom_plan">Save Custom Plan</button>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2">
                        <h3 class="font-semibold mb-3" data-translate="dpt_plan_mode">Daily DPT Plan Mode</h3>
                        <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-3" data-translate="dpt_plan_subtitle">Choose how you want to generate your daily DPT schedule.</p>
                        <div class="flex flex-wrap gap-4 mb-4">
                            <label class="flex items-center gap-2"><input type="radio" name="dpt-plan-mode" value="auto" class="form-radio text-primary"> <span data-translate="dpt_auto_mode">Automatic (Follows Study Plan)</span></label>
                            <label class="flex items-center gap-2"><input type="radio" name="dpt-plan-mode" value="custom_cycle" class="form-radio text-primary"> <span data-translate="custom_cycle">Custom Cycle</span></label>
                        </div>
                    </div>
                    
                    <div id="custom-dpt-plan-container" class="hidden md:col-span-2 p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm transition-all duration-300">
                        <div class="collapsible-header flex justify-between items-center cursor-pointer">
                            <h3 class="font-semibold" data-translate="custom_dpt_plan">Custom DPT Plan (2 Week Cycle)</h3>
                             <i data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-300"></i>
                        </div>
                        <div class="collapsible-content hidden mt-4">
                            <div id="dpt-custom-cycle-subject-selector" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                            <button id="save-dpt-custom-cycle-plan" class="mt-4 px-4 py-2 btn-neon font-semibold rounded-lg" data-translate="save_custom_plan">Save Custom DPT Plan</button>
                        </div>
                    </div>

                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm md:col-span-2 border border-indigo-100 dark:border-indigo-900/30 transition-all duration-300">
                        <div class="collapsible-header w-full flex justify-between items-center cursor-pointer select-none">
                            <div class="flex items-center gap-2 pointer-events-none">
                                <i data-lucide="calendar-clock" class="text-indigo-500 w-6 h-6"></i>
                                <h3 class="font-semibold text-lg">Advanced Subject Routine (Extra)</h3>
                            </div>
                            <i data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-300 pointer-events-none"></i>
                        </div>
                        <div class="collapsible-content hidden mt-4 border-t border-gray-100 dark:border-gray-700 pt-4">
                            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4">Add extra subjects to your daily schedule permanently on specific days.</p>

                            <div class="bg-indigo-50 dark:bg-indigo-950/30 p-4 rounded-xl mb-4">
                                <label class="block text-sm font-medium mb-2">Select Subject or Type Custom Name</label>
                                <div class="flex gap-2 mb-3">
                                    <select id="adv-routine-subject-select" class="flex-1 p-2 bg-white dark:bg-gray-800 border rounded-lg">
                                        <option value="">-- Select Subject --</option>
                                    </select>
                                    <input type="text" id="adv-routine-custom-name" placeholder="Or type custom (e.g. Gym)" class="flex-1 p-2 bg-white dark:bg-gray-800 border rounded-lg hidden">
                                    <button id="toggle-custom-name-btn" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-xs font-bold">Type Custom</button>
                                </div>

                                <label class="block text-sm font-medium mb-2">Select Days to Repeat</label>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    <button type="button" class="adv-day-btn w-10 h-10 rounded-lg text-xs font-bold bg-white dark:bg-gray-900 border hover:border-indigo-500 transition-all" data-day="1">Mon</button>
                                    <button type="button" class="adv-day-btn w-10 h-10 rounded-lg text-xs font-bold bg-white dark:bg-gray-900 border hover:border-indigo-500 transition-all" data-day="2">Tue</button>
                                    <button type="button" class="adv-day-btn w-10 h-10 rounded-lg text-xs font-bold bg-white dark:bg-gray-900 border hover:border-indigo-500 transition-all" data-day="3">Wed</button>
                                    <button type="button" class="adv-day-btn w-10 h-10 rounded-lg text-xs font-bold bg-white dark:bg-gray-900 border hover:border-indigo-500 transition-all" data-day="4">Thu</button>
                                    <button type="button" class="adv-day-btn w-10 h-10 rounded-lg text-xs font-bold bg-white dark:bg-gray-900 border hover:border-indigo-500 transition-all" data-day="5">Fri</button>
                                    <button type="button" class="adv-day-btn w-10 h-10 rounded-lg text-xs font-bold bg-white dark:bg-gray-900 border hover:border-indigo-500 transition-all" data-day="6">Sat</button>
                                    <button type="button" class="adv-day-btn w-10 h-10 rounded-lg text-xs font-bold bg-white dark:bg-gray-900 border hover:border-red-500 text-red-500" data-day="0">Sun</button>
                                </div>

                                <button id="save-adv-routine-btn" class="w-full p-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-500/20">Add to Routine</button>
                            </div>

                            <div id="adv-routine-list" class="space-y-2 max-h-60 overflow-y-auto">
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm">
                        <h3 class="font-semibold mb-3">Study Day Counter</h3>
                        <button id="reset-study-date-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-orange-100 dark:bg-orange-900/50 text-orange-600 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-900"><i data-lucide="calendar-x" class="w-4 h-4"></i> <span>Reset Study Start Date</span></button>
                    </div>
                    
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm"><h3 class="font-semibold mb-3" data-translate="reset_app">Reset Application</h3><button id="reset-app-btn" class="w-full flex items-center justify-center gap-2 p-3 text-sm font-medium rounded-lg bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900"><i data-lucide="trash-2" class="w-4 h-4"></i> <span data-translate="reset_all_data">Reset All Data</span></button></div>
                </div>
            </div>

        </main>
    </div>
</div>

<nav id="mobile-bottom-nav">
    <div id="mobile-nav-scroller">
        <button data-page="home" class="mobile-nav-btn active"><i data-lucide="home"></i><span>Home</span></button>
        <button data-page="subjects" class="mobile-nav-btn"><i data-lucide="book-open"></i><span>Subs</span></button>
        <button data-page="dpt" class="mobile-nav-btn"><i data-lucide="clipboard-check"></i><span>DPT</span></button>
        <button data-page="exams" class="mobile-nav-btn"><i data-lucide="briefcase"></i><span>Exam</span></button>
        <button data-page="url" class="mobile-nav-btn"><i data-lucide="globe"></i><span>URL</span></button>
        <button data-page="import-export" class="mobile-nav-btn"><i data-lucide="arrow-right-left"></i><span>Imp/Exp</span></button>
        <button data-page="analytics" class="mobile-nav-btn"><i data-lucide="bar-chart-3"></i><span>Stats</span></button>
        <button data-page="notices" class="mobile-nav-btn"><i data-lucide="sticky-note"></i><span>Notes</span></button>
        <button data-page="settings" class="mobile-nav-btn"><i data-lucide="settings"></i><span>Set</span></button>
        <button id="theme-toggle-btn-mobile" class="mobile-nav-btn" title="Switch Mode">
            <i data-lucide="sun" id="theme-icon-sun-mobile"></i>
            <i data-lucide="moon" id="theme-icon-moon-mobile" class="hidden"></i>
            <i data-lucide="laptop" id="theme-icon-system-mobile" class="hidden"></i>
            <span>Mode</span>
        </button>
        <button data-page="updates" class="mobile-nav-btn"><i data-lucide="sparkles" class="text-amber-500"></i><span class="text-amber-600 font-bold">New</span></button>
    </div>
</nav>

<input type="file" id="import-file-input" class="hidden" accept=".json">

<div id="update-popup-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="w-full max-w-lg rounded-2xl shadow-xl p-6 relative max-h-[90vh] overflow-y-auto update-modal-content">
        <button id="close-update-popup-modal" class="absolute top-4 right-4 text-indigo-200 hover:text-white z-10"><i data-lucide="x"></i></button>
        <div id="update-popup-header" class="text-center border-b border-indigo-400/50 pb-3 mb-4 relative">
        </div>
        <div id="update-popup-content" class="space-y-3 text-sm relative">
        </div>
    </div>
</div>

<div id="add-subject-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
        <button id="close-add-subject-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 class="text-xl font-bold mb-4" data-translate="add_new_subject">Add New Subject</h2>
        <form id="add-subject-form" class="space-y-4">
            <div>
                <label for="new-subject-name" class="block text-sm font-medium mb-1">Subject Name</label>
                <input type="text" id="new-subject-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="e.g. Current Affairs">
            </div>
            <!-- Removed Subject Source Radio Buttons -->
            <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Save Subject</button>
        </form>
    </div>
</div>

<div id="add-chapter-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden"><div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative"><button id="close-add-chapter-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button><h2 class="text-xl font-bold mb-4" data-translate="add_new_chapter">Add New Chapter</h2><form id="add-chapter-form" class="space-y-4"><input type="hidden" id="add-chapter-subject-id"><!-- Removed source type hidden input --><div><label for="new-chapter-name" class="block text-sm font-medium mb-1" data-translate="chapter_name">Chapter Name</label><input type="text" id="new-chapter-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required></div><button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="add_chapter">Add Chapter</button></form></div></div>

<div id="confirmation-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center border border-gray-200 dark:border-gray-700 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 to-pink-500"></div>
        
        <h2 id="confirmation-title" class="text-2xl font-bold mb-2 text-red-500 dark:text-red-400">Delete Task?</h2>
        <p id="confirmation-message" class="text-text-muted-light dark:text-text-muted-dark mb-6">Are you sure?</p>

        <div id="confirmation-checkbox-container" class="hidden mb-6 text-left bg-rose-50 dark:bg-rose-950/30 p-4 rounded-xl border border-rose-200 dark:border-rose-900/50">
            <label class="flex items-center gap-3 cursor-pointer select-none">
                <div class="relative flex items-center">
                    <input type="checkbox" id="confirmation-checkbox" class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border-2 border-rose-400 transition-all checked:border-rose-600 checked:bg-rose-600">
                    <i data-lucide="check" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                </div>
                <div>
                    <span id="confirmation-checkbox-label" class="text-sm font-bold text-rose-600 dark:text-rose-300">Permanent Delete Task</span>
                    <p class="text-xs text-rose-400 dark:text-rose-500/70 mt-0.5">Check to remove future repeats (Forever).</p>
                </div>
            </label>
        </div>

        <div class="flex justify-center gap-4">
            <button id="confirm-cancel" class="flex-1 p-3 font-bold rounded-xl bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">Cancel</button>
            <button id="confirm-action" class="flex-1 p-3 font-bold rounded-xl text-white bg-gradient-to-r from-red-500 to-rose-600 shadow-lg hover:shadow-red-500/30 active:scale-95 transition-all">Confirm</button>
        </div>
    </div>
</div>

<div id="chapter-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden" style="backdrop-filter: blur(12px);">
    <div class="relative w-full max-w-lg rounded-3xl p-[1px] overflow-hidden shadow-[0_0_50px_-10px_rgba(14,165,233,0.4)] transition-all transform animate-fadeIn">
        <div class="absolute inset-0 bg-gradient-to-br from-cyan-500 via-violet-500 to-fuchsia-500 opacity-60 animate-pulse"></div>
        
        <div class="relative bg-[#050b14]/90 backdrop-blur-3xl rounded-[1.4rem] p-6 border border-white/10 h-full max-h-[85vh] overflow-y-auto no-scrollbar">
            
            <button id="close-chapter-modal" class="absolute top-4 right-4 p-2 rounded-full bg-white/5 hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-all z-10 border border-transparent hover:border-red-500/30">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <h2 id="chapter-modal-title" class="text-2xl font-black mb-6 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 drop-shadow-[0_0_10px_rgba(34,211,238,0.3)] tracking-tight" data-translate="chapter_details">
                Chapter Details
            </h2>

            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-widest font-bold text-cyan-300/70 pl-1" data-translate="status">STATUS UPDATE</label>
                    <div id="chapter-status-buttons" class="status-btn-group grid grid-cols-3 gap-3 p-1.5 bg-black/40 border border-white/5 rounded-2xl shadow-inner">
                        <button data-status="Not Started" class="py-3 px-2 text-xs font-bold rounded-xl transition-all duration-300 text-gray-400 hover:text-white hover:bg-white/5 border border-transparent focus:scale-95">
                            <span data-translate="not_started">Not Started</span>
                        </button>
                        <button data-status="Completed" class="py-3 px-2 text-xs font-bold rounded-xl transition-all duration-300 text-gray-400 hover:text-white hover:bg-white/5 border border-transparent focus:scale-95">
                            <span data-translate="completed">Completed</span>
                        </button>
                        <button data-status="Postpone" class="py-3 px-2 text-xs font-bold rounded-xl transition-all duration-300 text-gray-400 hover:text-white hover:bg-white/5 border border-transparent focus:scale-95">
                            <span data-translate="postpone_task">Postpone</span>
                        </button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="chapter-notes-textarea" class="text-[10px] uppercase tracking-widest font-bold text-purple-300/70 pl-1" data-translate="study_notes">DATA LOGS / NOTES</label>
                    <div class="relative group">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl opacity-0 group-hover:opacity-30 transition duration-500 blur"></div>
                        <textarea id="chapter-notes-textarea" rows="4" data-translate-placeholder="study_notes_placeholder" placeholder="Enter critical study data here..." class="relative w-full p-4 bg-black/50 text-gray-200 border border-white/10 rounded-xl focus:border-cyan-500/50 focus:ring-0 focus:bg-black/80 transition-all placeholder-gray-600 text-sm resize-none shadow-inner"></textarea>
                    </div>
                </div>

                <div class="relative overflow-hidden rounded-xl bg-gradient-to-r from-amber-500/5 to-transparent border border-amber-500/20 p-0.5">
                    <label class="flex items-center gap-4 p-3 cursor-pointer group hover:bg-amber-500/5 rounded-lg transition-colors">
                        <div class="relative">
                            <input type="checkbox" id="chapter-priority-revision-checkbox" class="peer sr-only">
                            <div class="w-6 h-6 border-2 border-amber-500/40 rounded bg-black/40 peer-checked:bg-amber-500 peer-checked:border-amber-500 transition-all shadow-[0_0_15px_rgba(245,158,11,0.2)] peer-checked:shadow-[0_0_20px_rgba(245,158,11,0.6)]"></div>
                            <i data-lucide="zap" class="absolute inset-0 text-black w-3.5 h-3.5 m-auto opacity-0 peer-checked:opacity-100 transition-opacity scale-0 peer-checked:scale-100 duration-200"></i>
                        </div>
                        <span class="font-bold text-amber-200/90 text-sm tracking-wide group-hover:text-amber-100 transition-colors" data-translate="priority_revision">Mark High Priority</span>
                    </label>
                </div>
                
                <div class="pt-2 border-t border-white/5">
                    <h3 class="text-[10px] uppercase tracking-widest font-bold text-green-300/70 pl-1 mb-3">TIMELINE & REVISIONS</h3>
                    <div class="bg-black/30 rounded-xl border border-white/5 p-3">
                        <div id="scheduled-revisions-list" class="space-y-2 mb-3 max-h-32 overflow-y-auto pr-1 custom-scrollbar">
                            </div>
                        <div class="flex items-center gap-2 mt-2">
                            <div class="relative flex-grow group">
                                <input type="date" id="manual-revision-date" class="relative w-full p-2.5 bg-[#0a1120] text-gray-300 border border-white/10 rounded-lg focus:border-green-500/50 outline-none text-sm [color-scheme:dark] transition-colors focus:bg-black">
                            </div>
                            <button id="add-manual-revision-btn" class="p-2.5 rounded-lg bg-gradient-to-br from-emerald-500 to-green-600 text-white shadow-lg hover:shadow-green-500/30 hover:scale-105 active:scale-95 transition-all border border-green-400/20">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button id="delete-chapter-details-btn" class="group p-3.5 rounded-xl bg-red-500/5 border border-red-500/20 text-red-400 hover:bg-red-500 hover:text-white hover:shadow-[0_0_20px_rgba(239,68,68,0.5)] transition-all duration-300">
                        <i data-lucide="trash-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    </button>
                    <button id="save-chapter-details-btn" class="flex-grow relative overflow-hidden p-3.5 font-bold rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-[0_0_20px_rgba(8,145,178,0.4)] hover:shadow-[0_0_40px_rgba(8,145,178,0.6)] hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 border border-white/10 group" data-translate="save_changes">
                        <span class="relative z-10 flex items-center justify-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                        </span>
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* Neon Active States for Status Buttons */
        #chapter-status-buttons button.active[data-status="Not Started"] { background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 0 15px rgba(255,255,255,0.1); text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        
        #chapter-status-buttons button.active[data-status="Completed"] { background: linear-gradient(135deg, #06b6d4, #3b82f6); color: #fff; border: 1px solid rgba(6,182,212,0.5); box-shadow: 0 0 25px rgba(6,182,212,0.4); text-shadow: 0 0 5px rgba(255,255,255,0.8); }
        
        #chapter-status-buttons button.active[data-status="Postpone"] { background: linear-gradient(135deg, #f59e0b, #ea580c); color: #fff; border: 1px solid rgba(245,158,11,0.5); box-shadow: 0 0 25px rgba(245,158,11,0.4); text-shadow: 0 0 5px rgba(255,255,255,0.8); }

        /* Custom Scrollbar for inner content */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    </style>
</div>

<div id="postpone-chapter-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
        <button id="close-postpone-chapter-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 class="text-xl font-bold mb-4">Postpone Chapter</h2>
        <form id="postpone-chapter-form" class="space-y-4">
            <div>
                <label for="postpone-note-textarea" class="block text-sm font-medium mb-1">Add a note (where did you leave off?)</label>
                <textarea id="postpone-note-textarea" rows="3" placeholder="e.g., up to page 50..." class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg text-sm"></textarea>
            </div>
            <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-yellow-500 text-white hover:bg-yellow-600">Save & Postpone</button>
        </form>
    </div>
</div>

<div id="badge-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden"><div class="bg-card-light dark:bg-card-dark w-full max-w-sm rounded-2xl shadow-xl p-8 text-center relative overflow-hidden"><button id="close-badge-modal-x" class="absolute top-4 right-4 text-text-muted-light dark:hover:text-text-light dark:text-text-dark z-10"><i data-lucide="x" class="w-6 h-6"></i></button><div class="absolute top-0 left-0 w-full h-full opacity-10 dark:opacity-20" style="background-image: radial-gradient(circle, var(--primary) 0%, transparent 70%);"></div><i id="badge-icon" data-lucide="award" class="w-16 h-16 text-amber-400 mx-auto mb-4 drop-shadow-lg animate-pulse"></i><h2 class="text-2xl font-bold mb-2" data-translate="achievement_unlocked">Achievement Unlocked!</h2><p id="badge-name" class="text-lg font-semibold text-primary dark:text-blue-300 mb-4"></p><p id="badge-description" class="text-text-muted-light dark:text-text-muted-dark mb-6"></p><button id="close-badge-modal" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="awesome">Awesome!</button></div></div>

<div id="undo-toast" class="p-3 rounded-lg shadow-lg bg-gray-800 text-white dark:bg-gray-200 dark:text-black flex items-center gap-4">
    <span id="undo-message"></span>
    <button id="undo-btn" class="font-bold" data-translate="undo">Undo</button>
</div>

<div id="add-exam-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative overflow-y-auto max-h-[90vh]">
        <button id="close-add-exam-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 id="exam-modal-title" class="text-xl font-bold mb-4" data-translate="add_new_exam">Add New Exam</h2>
        <form id="add-exam-form" class="space-y-4">
            <input type="hidden" id="exam-id">
            <div>
                <label for="exam-name" class="block text-sm font-medium mb-1" data-translate="exam_name">Exam Name</label>
                <input type="text" id="exam-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="application-date" class="block text-sm font-medium mb-1" data-translate="application_date">Application Date</label>
                    <input type="date" id="application-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                </div>
                <div>
                    <label for="exam-date" class="block text-sm font-medium mb-1" data-translate="exam_date">Exam Date</label>
                    <input type="date" id="exam-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                </div>
            </div>
             <div>
                <label for="exam-status" class="block text-sm font-medium mb-1" data-translate="status">Status</label>
                <select id="exam-status" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                    <option value="Applied" data-translate="status_applied">Applied</option>
                    <option value="Admit Card Out" data-translate="status_admit_card">Admit Card Out</option>
                    <option value="Exam Done" data-translate="status_exam_done">Exam Done</option>
                    <option value="Result Out" data-translate="status_result_out">Result Out</option>
                </select>
            </div>
             <div>
                <label for="exam-notes" class="block text-sm font-medium mb-1" data-translate="notes">Notes</label>
                <textarea id="exam-notes" rows="3" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" data-translate-placeholder="notes_placeholder" placeholder="e.g., Registration no., website link..."></textarea>
            </div>
            <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save_exam">Save Exam</button>
        </form>
    </div>
</div>

<div id="date-completion-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
        <button id="close-date-completion-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 id="date-completion-modal-title" class="text-xl font-bold mb-4">Mark Chapter as Completed</h2>
        <div class="space-y-4">
            <div>
                <label for="date-completion-subject-select" class="block text-sm font-medium mb-1">Select Subject</label>
                <select id="date-completion-subject-select" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                    <option value="">-- Choose a Subject --</option>
                </select>
            </div>
            <div id="date-completion-chapter-list" class="max-h-60 overflow-y-auto space-y-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                <p class="text-center text-sm text-text-muted-light dark:text-text-muted-dark">Please select a subject first.</p>
            </div>
             <button id="save-date-completion-btn" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Mark as Completed</button>
        </div>
    </div>
</div>

<div id="dpt-details-popup-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
        <button id="close-dpt-details-popup-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h3 id="dpt-modal-title" class="font-bold text-lg mb-4" data-translate="enter_dpt_details">Enter DPT Details</h3>
        <div id="dpt-entry-view">
            <form id="dpt-details-form" class="space-y-3">
                <input type="hidden" id="dpt-details-subject-id">
                <input type="hidden" id="dpt-details-chapter-id">
                <input type="hidden" id="dpt-details-test-id">
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm">
                    <div><label for="dpt-total-q" class="font-medium" data-translate="dpt_total_q">Total Qs</label><input type="number" id="dpt-total-q" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                    <div><label for="dpt-total-time" class="font-medium" data-translate="dpt_total_time">Total Time</label><input type="number" id="dpt-total-time" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                    <div><label for="dpt-attempted" class="font-medium" data-translate="dpt_attempted">Attempted</label><input type="number" id="dpt-attempted" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                    <div><label for="dpt-correct" class="font-medium" data-translate="dpt_correct">Correct</label><input type="number" id="dpt-correct" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                    <div><label for="dpt-wrong" class="font-medium" data-translate="dpt_wrong">Wrong</label><input type="number" id="dpt-wrong" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                    <div><label for="dpt-time-taken" class="font-medium" data-translate="dpt_time_taken">Time Taken</label><input type="number" id="dpt-time-taken" class="w-full mt-1 p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="delete-dpt-btn" class="p-3 font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300"><i data-lucide="trash-2"></i></button>
                    <button type="submit" class="flex-1 p-3 font-semibold rounded-lg bg-primary text-white" data-translate="submit">Submit</button>
                </div>
            </form>
        </div>
        <div id="dpt-display-view" class="hidden">
             <div class="space-y-2 text-sm">
                <div class="flex justify-between p-2 bg-gray-100 dark:bg-gray-800 rounded-md"><span>Completed On:</span><strong id="dpt-display-date"></strong></div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-md"><span>Total Questions:</span><strong class="block text-lg" id="dpt-display-total-q"></strong></div>
                    <div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-md"><span>Attempted:</span><strong class="block text-lg" id="dpt-display-attempted"></strong></div>
                    <div class="p-2 bg-green-100 dark:bg-green-900/50 rounded-md"><span>Correct:</span><strong class="block text-lg text-green-600" id="dpt-display-correct"></strong></div>
                    <div class="p-2 bg-red-100 dark:bg-red-900/50 rounded-md"><span>Wrong:</span><strong class="block text-lg text-red-600" id="dpt-display-wrong"></strong></div>
                    <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-md"><span>Accuracy:</span><strong class="block text-lg text-blue-600" id="dpt-display-accuracy"></strong></div>
                    <div class="p-2 bg-yellow-100 dark:bg-yellow-900/50 rounded-md"><span>Time Taken:</span><strong class="block text-lg text-yellow-600" id="dpt-display-time-taken"></strong></div>
                </div>
             </div>
             <div class="flex gap-3 pt-4">
                <button type="button" id="delete-dpt-display-btn" class="p-3 font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-300"><i data-lucide="trash-2"></i></button>
                <button type="button" id="close-dpt-display-btn" class="flex-1 p-3 font-semibold rounded-lg bg-gray-200 dark:bg-gray-700">Close</button>
             </div>
        </div>
    </div>
</div>

<!-- MODAL FOR CHOOSING TASK TYPE -->
<div id="add-task-choice-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-sm rounded-2xl shadow-xl p-6 relative">
        <button id="close-add-task-choice-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 class="text-xl font-bold mb-6 text-center">Add a New Task</h2>
        <div class="space-y-3">
            <button id="choice-manual-chapter-btn" class="w-full flex items-center justify-center gap-3 p-4 font-semibold rounded-lg bg-sky-100 hover:bg-sky-200 dark:bg-sky-900/50 dark:hover:bg-sky-900 text-sky-800 dark:text-sky-200">
                <i data-lucide="book-open"></i>
                <span>Add Chapter Task</span>
            </button>
            <button id="choice-other-task-btn" class="w-full flex items-center justify-center gap-3 p-4 font-semibold rounded-lg bg-violet-100 hover:bg-violet-200 dark:bg-violet-900/50 dark:hover:bg-violet-900 text-violet-800 dark:text-violet-200">
                <i data-lucide="clipboard-list"></i>
                <span>Add Other Task</span>
            </button>
        </div>
    </div>
</div>

<!-- MODAL FOR ADDING 'OTHER' TASK (Fixed Suggestions & Visibility) -->
<div id="add-other-task-modal" class="fixed inset-0 z-[10000] items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative border border-gray-200 dark:border-gray-700 flex flex-col max-h-[90vh]">
        <button id="close-add-other-task-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark hover:text-primary transition-colors z-20"><i data-lucide="x"></i></button>
        <h2 id="add-other-task-title" class="text-xl font-bold mb-4 text-primary">Add Other Task</h2>
        
        <form id="add-other-task-form" class="space-y-4 flex-grow overflow-y-auto pr-1 custom-scrollbar">
            <input type="hidden" id="edit-other-task-id">
            
            <!-- Description with Google-like Suggestions -->
            <div class="relative">
                <label for="other-task-description" class="block text-sm font-semibold mb-1.5 text-sky-600 dark:text-sky-400">Task Description</label>
                <input type="text" id="other-task-description" autocomplete="off" class="w-full p-3 bg-gray-50 dark:bg-gray-800/80 border border-sky-200 dark:border-sky-900 rounded-xl focus:ring-2 focus:ring-sky-500 outline-none transition-all" required placeholder="e.g., SSC GD Practice Set...">
                <!-- Suggestions Container -->
                <div id="task-suggestions-container" class="hidden absolute top-full left-0 right-0 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-b-xl shadow-lg z-50 max-h-40 overflow-y-auto mt-1">
                    <!-- Suggestions injected by JS -->
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="other-task-date" class="block text-sm font-semibold mb-1.5 text-sky-600 dark:text-sky-400">Date</label>
                    <input type="date" id="other-task-date" class="w-full p-3 bg-gray-50 dark:bg-gray-800/80 border border-sky-200 dark:border-sky-900 rounded-xl focus:ring-2 focus:ring-sky-500 outline-none transition-all" required>
                </div>
                <div class="relative">
                    <label for="other-task-tag" class="block text-sm font-semibold mb-1.5 text-sky-600 dark:text-sky-400">Tag</label>
                    <div class="relative">
                        <input type="text" id="other-task-tag" list="tag-options-list" class="w-full p-3 bg-gray-50 dark:bg-gray-800/80 border border-sky-200 dark:border-sky-900 rounded-xl focus:ring-2 focus:ring-sky-500 outline-none transition-all pr-10" placeholder="Select or Type...">
                        <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                    </div>
                    <datalist id="tag-options-list">
                        <option value="Form-filling">
                        <option value="Upcoming Exam">
                        <option value="Other Task">
                        <option value="Urgent">
                        <option value="Job">
                    </datalist>
                </div>
            </div>
            
            <div>
                <label for="other-task-notes" class="block text-sm font-semibold mb-1.5 text-purple-600 dark:text-purple-400">Notes (Optional)</label>
                <textarea id="other-task-notes" rows="2" class="w-full p-3 bg-gray-50 dark:bg-gray-800/80 border border-purple-200 dark:border-purple-900 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none transition-all" placeholder="Add any extra details..."></textarea>
            </div>

            <!-- Priority Checkbox (Fixed Light Mode Visibility) -->
            <div class="bg-red-50 dark:bg-red-900/10 p-3 rounded-xl border border-red-100 dark:border-red-900/30">
                <label class="flex items-center gap-3 cursor-pointer select-none">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="other-task-priority" class="peer h-6 w-6 cursor-pointer appearance-none rounded border-2 border-red-400 transition-all checked:bg-red-600 checked:border-red-600">
                        <!-- Icon Color Forced White on Check -->
                        <i data-lucide="check" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 text-white opacity-0 peer-checked:opacity-100 z-10 font-bold"></i>
                    </div>
                    <div>
                        <span class="font-bold text-red-700 dark:text-red-300 text-sm">High Priority (Exam/Urgent)</span>
                        <p class="text-[10px] text-red-500 dark:text-red-400">Shows on dashboard 3 days in advance.</p>
                    </div>
                </label>
            </div>
            
            <!-- Repeat Checkbox -->
            <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800/50">
                <label class="flex items-center gap-3 cursor-pointer w-full select-none">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="other-task-repeat" class="peer h-6 w-6 cursor-pointer appearance-none rounded-lg border-2 border-indigo-400 transition-all checked:bg-indigo-600 checked:border-indigo-600 hover:border-indigo-500">
                        <i data-lucide="check" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 text-white opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                    </div>
                    <div>
                        <span class="font-bold text-gray-800 dark:text-gray-200">Repeat this task</span>
                        <p class="text-xs text-indigo-500/80 dark:text-indigo-400/80">Check to select days</p>
                    </div>
                </label>
                
                <div id="day-selection-container" style="display: none;" class="mt-4 pt-3 border-t border-indigo-200 dark:border-indigo-800/50">
                    <p class="text-xs font-bold text-indigo-600 dark:text-indigo-300 mb-3 uppercase tracking-wider text-center bg-white/50 dark:bg-black/20 py-1 rounded">Select Days to Repeat</p>
                    <div class="grid grid-cols-7 gap-1">
                        <button type="button" class="day-selector-btn h-10 rounded-lg text-xs font-bold flex flex-col items-center justify-center bg-white dark:bg-gray-800 border shadow-sm hover:border-indigo-500 transition-all" data-day="1">Mon</button>
                        <button type="button" class="day-selector-btn h-10 rounded-lg text-xs font-bold flex flex-col items-center justify-center bg-white dark:bg-gray-800 border shadow-sm hover:border-indigo-500 transition-all" data-day="2">Tue</button>
                        <button type="button" class="day-selector-btn h-10 rounded-lg text-xs font-bold flex flex-col items-center justify-center bg-white dark:bg-gray-800 border shadow-sm hover:border-indigo-500 transition-all" data-day="3">Wed</button>
                        <button type="button" class="day-selector-btn h-10 rounded-lg text-xs font-bold flex flex-col items-center justify-center bg-white dark:bg-gray-800 border shadow-sm hover:border-indigo-500 transition-all" data-day="4">Thu</button>
                        <button type="button" class="day-selector-btn h-10 rounded-lg text-xs font-bold flex flex-col items-center justify-center bg-white dark:bg-gray-800 border shadow-sm hover:border-indigo-500 transition-all" data-day="5">Fri</button>
                        <button type="button" class="day-selector-btn h-10 rounded-lg text-xs font-bold flex flex-col items-center justify-center bg-white dark:bg-gray-800 border shadow-sm hover:border-indigo-500 transition-all" data-day="6">Sat</button>
                        <button type="button" class="day-selector-btn h-10 rounded-lg text-xs font-bold flex flex-col items-center justify-center bg-white dark:bg-gray-800 border shadow-sm hover:border-red-500 text-red-500 transition-all" data-day="0">Sun</button>
                    </div>
                </div>
            </div>

            <button type="submit" class="w-full p-4 font-bold rounded-xl bg-gradient-to-r from-sky-500 to-blue-600 text-white shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 active:scale-95 transition-all text-lg mt-2">Save Task</button>
        </form>
    </div>
</div>

<div id="manual-add-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-2xl shadow-xl p-6 relative">
        <button id="close-manual-add-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 id="manual-add-modal-title" class="text-xl font-bold mb-4">Add Task</h2>
        <div class="space-y-4">
            <div>
                <label for="manual-add-subject-select" class="block text-sm font-medium mb-1">Select Subject</label>
                <select id="manual-add-subject-select" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                    <option value="">-- Choose a Subject --</option>
                </select>
            </div>
            
            <div id="manual-add-chapter-content">
                <div>
                    <label for="manual-add-date" class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="manual-add-date" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                </div>
                <div>
                    <label for="manual-add-chapter-name" class="block text-sm font-medium mb-1">New Chapter Name</label>
                    <input type="text" id="manual-add-chapter-name" placeholder="Enter chapter name to add..." class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg">
                </div>
                <!-- Removed Source Radio Buttons -->
            </div>

            <div id="manual-add-dpt-content" class="hidden">
                 <div id="manual-add-item-list" class="max-h-60 overflow-y-auto space-y-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                    <p class="text-center text-sm text-text-muted-light dark:text-text-muted-dark">Please select a subject first.</p>
                </div>
            </div>
            <button id="save-manual-add-btn" class="w-full p-3 mt-2 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Add Task</button>
        </div>
    </div>
</div>

<div id="add-folder-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
        <button id="close-add-folder-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <div class="flex items-center gap-3 mb-4">
            <i data-lucide="folder-plus" class="w-6 h-6 text-primary"></i>
            <h2 id="folder-modal-title" class="text-xl font-bold" data-translate="add_new_folder">Add New Folder</h2>
        </div>
        <form id="add-folder-form" class="space-y-4">
            <input type="hidden" id="edit-folder-id">
            <input type="hidden" id="parent-folder-id">
            <div>
                <label for="new-folder-name" class="block text-sm font-medium mb-1" data-translate="folder_name">Folder Name</label>
                <input type="text" id="new-folder-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="e.g. History Videos">
            </div>
            <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save">Save</button>
        </form>
    </div>
</div>

<div id="add-link-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
        <button id="close-add-link-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <div class="flex items-center gap-3 mb-4">
            <i data-lucide="link" class="w-6 h-6 text-primary"></i>
            <h2 id="link-modal-title" class="text-xl font-bold" data-translate="add_new_link">Add New Link</h2>
        </div>
        <form id="add-link-form" class="space-y-4">
            <input type="hidden" id="link-folder-id">
            <input type="hidden" id="edit-link-id">
            <div>
                <label for="new-link-name" class="block text-sm font-medium mb-1" data-translate="link_name">Link Name</label>
                <input type="text" id="new-link-name" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="e.g. Ancient Rome Documentary">
            </div>
            <div>
                <label for="new-link-url" class="block text-sm font-medium mb-1" data-translate="link_url">URL</label>
                <input type="url" id="new-link-url" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required placeholder="https://example.com">
            </div>
            <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover" data-translate="save">Save</button>
        </form>
    </div>
</div>

<!-- NEW MODAL FOR ADDING DPT TO A CHAPTER -->
<div id="add-chapter-dpt-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
        <button id="close-add-chapter-dpt-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 class="text-xl font-bold mb-4">Add DPTs to Chapter</h2>
        <form id="add-chapter-dpt-form" class="space-y-4">
            <input type="hidden" id="dpt-add-subject-id">
            <div>
                <label for="dpt-add-chapter-select" class="block text-sm font-medium mb-1">Chapter</label>
                <select id="dpt-add-chapter-select" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required></select>
            </div>
            <div>
                <label for="dpt-add-quantity" class="block text-sm font-medium mb-1">Number of Tests to Add</label>
                <input type="number" id="dpt-add-quantity" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required min="1" value="1">
            </div>
            <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Add DPTs</button>
        </form>
    </div>
</div>

<!-- NEW MODAL FOR ADDING DPT TO ALL CHAPTERS -->
<div id="add-all-chapters-dpt-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative">
        <button id="close-add-all-chapters-dpt-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 id="add-all-dpt-modal-title" class="text-xl font-bold mb-4">Add DPTs to All Chapters</h2>
        <form id="add-all-chapters-dpt-form" class="space-y-4">
            <input type="hidden" id="dpt-add-all-subject-id">
            <div>
                <label for="dpt-add-all-quantity" class="block text-sm font-medium mb-1">Number of Tests per Chapter</label>
                <input type="number" id="dpt-add-all-quantity" class="w-full p-2 bg-gray-100 dark:bg-gray-800 border rounded-lg" required min="1" value="1">
            </div>
            <button type="submit" class="w-full p-3 font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover">Add DPTs to All</button>
        </form>
    </div>
</div>

<div id="add-global-dpt-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-card-light dark:bg-card-dark w-full max-w-md rounded-2xl shadow-xl p-6 relative flex flex-col max-h-[90vh]">
        <button id="close-add-global-dpt-modal" class="absolute top-4 right-4 text-text-muted-light dark:text-text-muted-dark"><i data-lucide="x"></i></button>
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="layers" class="text-primary"></i> Global Add DPT</h2>
        <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar">
            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-3">Select subjects to add DPTs to ALL their chapters.</p>
            
            <div class="mb-4">
                <label class="flex items-center gap-2 font-bold cursor-pointer p-2 bg-gray-100 dark:bg-gray-800 rounded-lg mb-2">
                    <input type="checkbox" id="global-dpt-select-all" class="form-checkbox h-5 w-5 text-primary rounded">
                    <span>Select All Subjects</span>
                </label>
                <div id="global-dpt-subject-list" class="space-y-1 pl-1">
                    </div>
            </div>

            <div>
                <label for="global-dpt-quantity" class="block text-sm font-medium mb-1">Number of Tests per Chapter</label>
                <input type="number" id="global-dpt-quantity" class="w-full p-3 bg-gray-50 dark:bg-gray-800 border rounded-xl font-bold text-center text-lg" required min="1" value="1">
            </div>
        </div>
        <div class="pt-4 mt-2 border-t border-gray-100 dark:border-gray-700">
            <button id="save-global-dpt-btn" class="w-full p-3 font-semibold rounded-lg bg-gradient-to-r from-primary to-blue-600 text-white shadow-lg hover:shadow-primary/30">Add DPTs to Selected</button>
        </div>
    </div>
</div>

<div id="creator-bio-modal" class="fixed inset-0 z-50 items-center justify-center p-4 modal-backdrop hidden">
    <div class="bg-white dark:bg-[#0f172a] w-full max-w-2xl rounded-[2rem] shadow-2xl p-0 relative overflow-hidden border border-gray-200 dark:border-gray-700 flex flex-col max-h-[90vh]">
        <!-- Modern Header Image -->
        <div class="h-48 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600"></div>
            <div class="absolute inset-0 opacity-30" style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');"></div>
            <button id="close-creator-bio-modal" class="absolute top-4 right-4 bg-black/20 hover:bg-black/40 text-white rounded-full p-2 transition-all z-10 backdrop-blur-sm"><i data-lucide="x"></i></button>
            
            <div class="absolute -bottom-12 left-1/2 transform -translate-x-1/2 p-2 bg-white dark:bg-[#0f172a] rounded-full shadow-2xl z-20">
                <!-- 3D Avatar Image -->
                <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-indigo-500 bg-indigo-100 relative group">
                    <img src="https://img.freepik.com/free-psd/3d-illustration-person-with-sunglasses_23-2149436188.jpg" alt="Rayen" class="w-full h-full object-cover transform transition-transform group-hover:scale-110">
                </div>
            </div>
        </div>
        
        <div class="pt-16 pb-6 px-6 text-center">
            <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">Rayen</h2>
            <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-[0.2em] mt-2">Visionary & Developer</p>
        </div>

        <div class="flex-grow overflow-y-auto custom-scrollbar px-6 pb-6 space-y-6">
            <div id="creator-bio-content" class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed text-center max-w-lg mx-auto">
                <!-- Content will be injected via JS based on Language -->
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800 text-center">
                    <i data-lucide="code-2" class="w-6 h-6 text-indigo-600 mx-auto mb-2"></i>
                    <h4 class="font-bold text-gray-900 dark:text-white text-xs">AI Powered</h4>
                    <p class="text-[10px] text-gray-500">Built with Intelligence</p>
                </div>
                <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-100 dark:border-purple-800 text-center">
                    <i data-lucide="rocket" class="w-6 h-6 text-purple-600 mx-auto mb-2"></i>
                    <h4 class="font-bold text-gray-900 dark:text-white text-xs">Student Focused</h4>
                    <p class="text-[10px] text-gray-500">Optimized for Success</p>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50 text-center">
            <p class="text-xs font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-purple-600">AIGenerated@Rayen</p>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ULTRA PERFORMANCE FIX: INSTANT LOAD ---
    // वाइट स्क्रीन को हटाने के लिए तुरंत रेंडरिंग शुरू करें
    // भारी कार्यों (एनीमेशन) को थोड़ा रोककर चलाएं
    
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            setTimeout(() => navigator.serviceWorker.register('sw.js').catch(() => {}), 3000);
        });
    }
    
    // --- 1. DEFAULT DATA INJECTION (EMBEDDED) ---
    // Foundation Routine (Fixed: Sunday fills form)
    // Index 0 = Sunday (Week 1), Index 7 = Sunday (Week 2)
    const FOUNDATION_ROUTINE = [
        ["economics", "math", "reasoning", "fill-form"], // Sunday W1
        ["physics", "history", "math", "static-gk"], // Mon
        ["chemistry", "history", "math", "संविधान-articles"], // Tue
        ["biology", "history", "math", "maths-formulas"], // Wed
        ["physics", "history", "math", "static-gk"], // Thu
        ["chemistry", "history", "math", "संविधान-articles"], // Fri
        ["biology", "history", "math", "maths-formulas"], // Sat
        ["math", "hindi", "reasoning", "fill-form"], // Sunday W2
        ["polity", "history", "math", "static-gk"], // Mon
        ["history", "math", "hindi", "संविधान-articles"], // Tue
        ["polity", "history", "math", "maths-formulas"], // Wed
        ["economics", "history", "math", "static-gk"], // Thu
        ["polity", "history", "math", "संविधान-articles"], // Fri
        ["geography", "history", "math", "maths-formulas"] // Sat
    ];

    // Railway Routine (Fixed: Sunday fills form)
    const RAILWAY_ROUTINE = [
        ["math", "history", "reasoning", "fill-form"], // Sunday W1
        ["chemistry", "hindi", "संविधान-articles", "math"],
        ["biology", "economics", "maths-formulas", "reasoning"],
        ["physics", "geography", "static-gk", "math"],
        ["chemistry", "polity", "संविधान-articles", "reasoning"],
        ["biology", "history", "maths-formulas", "math"],
        ["physics", "hindi", "static-gk", "reasoning"],
        ["math", "economics", "संविधान-articles", "fill-form"], // Sunday W2
        ["biology", "geography", "maths-formulas", "math"],
        ["physics", "polity", "static-gk", "reasoning"],
        ["chemistry", "history", "संविधान-articles", "math"],
        ["biology", "hindi", "maths-formulas", "reasoning"],
        ["physics", "economics", "static-gk", "math"],
        ["chemistry", "geography", "संविधान-articles", "reasoning"]
    ];

    // Default Chapters Database (Full Content)
    const DEFAULT_CHAPTERS_DB = {
        "physics": ["1. तरंग (Waves)","2. उत्तोलक (Lever)","3. सरल आवर्त गति (Simple Harmonic Motion)","4. ऊष्मा (Heat)","5. प्रकाश (Light)","6. ध्वनि (Sound)","7. बल तथा बल आघूर्ण (Force and Torque)","8. गुरुत्वाकर्षण (Gravitation)","9. मात्रक तथा बीमा (Units and Measurement)","10. आवर्धन तथा वर्ण विक्षेपण (Magnification and Dispersion)","11. घर्षण (Friction)","12. प्रक्षेप्य गति (Projectile Motion)","13. प्रत्यास्थता (Elasticity)","14. कार्य शक्ति और ऊर्जा (Work, Power and Energy)","15. गति और वेग (Motion and Velocity)","16. दाब (Pressure)","17. चुंबक (Magnetism)","18. अपवर्तन (Refraction)","19. महत्वपूर्ण तथ्य (Important Facts)","20. मानव नेत्र (Human Eye)","21. प्रकाश का विद्युत प्रभाव (Photoelectric Effect)","22. लेंस (Lens)","23. विद्युत और विद्युत धारा (Electricity and Current)"],
        "chemistry": ["1. अयस्क और धातु कर्म (Ore and Metallurgy)","2. तत्व तथा मिश्रण (Elements and Mixtures)","3. परमाणु की संरचना (Structure of Atom)","4. अम्ल क्षार और लवण (Acids, Bases and Salts)","5. रासायनिक बंधन (Chemical Bonding)","6. हमारे आसपास के पदार्थ (Substances Around Us)","7. ऑक्सीडेशन और रिडक्शन (Oxidation and Reduction)","8. जल (Water)","9. ऑर्गेनिक केमिस्ट्री एंड इट्स कंपोनेंट (Organic Chemistry)","10. मोल संकल्पना (Mole Concept)","11. रेडियोएक्टिविटी (Radioactivity)","12. आवर्त सारणी (Periodic Table)","13. इंडस्ट्रियल केमेस्ट्री (Industrial Chemistry)"],
        "biology": ["1. ग्रंथियां (Glands)","2. कोशिका (Cell)","3. ऊतक (Tissues)","4. पेशीय तंत्र (Muscular System)","5. पाचन तंत्र (Digestive System)","6. स्वसन तंत्र (Respiratory System)","7. परिसंचरण तंत्र (Circulatory System)","8. रक्त (Blood)","9. उत्सर्जन तंत्र (Excretory System)","10. तंत्रिका तंत्र (Nervous System)","11. जनन तंत्र (Reproductive System)","12. शरीर के गुहा (Body Cavities)","13. कंकाल तंत्र (Skeletal System)","14. पोषण (Nutrition)","15. ज्ञानेंद्रिय (Sense Organs)","16. मानव रोग (Human Diseases)","17. जंतुओं का वर्गीकरण (Classification of Animals)","18. पादप (Plants)","19. पादप पोषण (Plant Nutrition)","20. पादप कूल पादप रोग और हार्मोन (Plant Disease/Hormones)","21. वाष्पोत्सर्जन प्रकाश संश्लेषण (Transpiration/Photosynthesis)","22. पादप उत्तक (Plant Tissues)","23. अनुवांशिकी (Genetics)","24. प्रदूषण (Pollution)","25. जैव विकास (Evolution)","26. खाद्य श्रृंखला (Food Chain)","27. पारिस्थितिकी (Ecology)"],
        "geography": ["1. खगोल विज्ञान (Astronomy)","2. स्थलाकृति विज्ञान (Geomorphology)","3. भूगर्भ विज्ञान (Geology)","4. चट्टान (Rocks)","5. वायुमंडल (Atmosphere)","6. पवन संचार (Wind Circulation)","7. चक्रवात (Cyclone)","8. जल मंडल (Hydrosphere)","9. पृथ्वी का भूगर्भिक इतिहास (Geological History)","10. कोपेन का जलवायु वर्गीकरण (Koppen Climate)","11. हिमालय (Himalayas)","12. उत्तर का विशाल मैदान (Northern Plains)","13. मृदा (Soil)","14. भारत का वन (Forests of India)","15. भारत की जलवायु (Climate of India)","16. कृषि (Agriculture)","17. खनिज (Minerals)","18. भारत का उद्योग (Industries of India)","19. भारत की परिवहन व्यवस्था (Transport System)","20. प्रायद्वीपीय पठार (Peninsular Plateau)","21. भारत की बहुउद्देशीय प्रोजेक्ट (Multipurpose Projects)","22. जनसंख्या (Population)","23. भारत के विभिन्न प्रजातियां (Species of India)"],
        "polity": ["1. भारतीय संविधान (Indian Constitution)","14. भाग 1 संघ और राज्य","15. भाग 2 नागरिकता","16. भाग 3 मूल अधिकार","17. भाग 4 राज्य के नीति निर्देशक तत्व","18. मूल कर्तव्य","19. भाग 5 संघ","20. संसद","21. सर्वोच्च न्यायालय","22. भाग 6 राज्य","23. विधान मंडल","24. उच्च न्यायालय","25. भाग 7 से 10","26. भाग 11 और 12","27. भाग 13 और 14","28. भाग 15","29. भाग 16","30. भाग 17 राजभाषा","31. भाग 18 आपातकालीन उपबंध","32. भाग 19 प्रमुख उपबंध","33. भाग 21 और 22","34. भारतीय संविधान एक परिचय","35. भाग और अनुसूची","36. भाग और अनुच्छेद","37. अंतरराष्ट्रीय संबंध"],
        "economics": ["1. अर्थशास्त्र (Economics)","2. अर्थव्यवस्था (Economy)","3. सकल घरेलू उत्पाद (GDP)","4. गरीबी (Poverty)","5. राष्ट्रीय आय (National Income)","6. बजट (Budget)","7. टैक्स (Tax)","8. व्यापार संतुलन (Balance of Trade)","9. बैंक (Bank)","10. बैंक से जुड़ी अन्य","11. मुद्रा (Currency)","12. वस्तु (Goods)","13. बाजार (Market)","14. उपयोगिता (Utility)","15. रिवेन्यू (Revenue)","16. शेयर बाजार (Stock Market)","17. कंपनी (Company)","18. प्रमुख संस्था (Institutions)","19. प्रमुख संगठन (Organizations)","20. भविष्य निधि (PF)"],
        "history": ["1. प्रागैतिहासिक काल","2. आद्य-एतिहासिक काल","3. ऐतिहासिक काल","4. वेद","5. वैदिक काल","6. जैन धर्म","7. बौद्ध धर्म","8. प्रमुख धर्म","9. महाजनपद","10. हर्यक वंश","11. शिशु नागवंश","12. नंद वंश","13. मौर्य वंश","14. सम्राट अशोक","15. मौर्य कालीन व्यवस्थाएं","16. ब्राह्मण साम्राज्य","17. शुंग वंश","18. कण्ण्व वंश","19. सातवाहन वंश","20. मौर्य उत्तर कल","21. हिंदी यूनानी इंडो ग्रीक","22. शक वंश","23. कुषाण वंश+रेशम मार्ग","24. गुप्त काल","25. समुद्रगुप्त","26. चंद्रगुप्त द्वितीय","27. पुष्यभूति वंश","28. दक्षिण भारत का इतिहास","29. संगम काल","30. पांडय्य वंश","31. चोल वंश","32. चालुक्य वंश","33. पल्लव वंश","34. राष्ट्रकूट वंश","35. गुर्जर प्रतिहार वंश","36. यादव वंश","37. वर्मन वंश","38. राजपूत काल","39. मुस्लिम आक्रमण","40. तुर्क आक्रमण","41. दिल्ली सल्तनत","42. गुलाम वंश","43. कुतुबुद्दीन ऐबक","44. रजिया सुल्तान","45. खिलजी वंश","46. तुगलक वंश","47. सैयद वंश","48. लोदी वंश","49. विजयनगर साम्राज्य","50. प्रशासनिक व्यवस्था","51. बहमनी साम्राज्य","52. भक्ति आंदोलन","53. मुगल काल","54. बाबर","55. हुमायूं","56. शेरशाह सूरी","57. अकबर","58. जहांगीर","59. शाहजहां","60. औरंगज़ेब","61. उत्तर मुगल काल","62. मुगल प्रशासनिक व्यवस्था","63. मराठा साम्राज्य","64. पेशवा काल","65. अवध/मैसूर/पंजाब","66. कोहिनूर हीरा","67. बंगाल","68. यूरोपीय कंपनियों का आगमन","69. 1857 की क्रांति","70. भारतीय राष्ट्रीय कांग्रेस","71. प्रमुख क्रांतिकारी आंदोलन","72. सामाजिक सुधार संगठन","73. गांधी युग","74. रॉलेट एक्ट","75. साइमन कमीशन","76. मुस्लिम लीग","77. अगस्त प्रस्ताव","78. कैबिनेट मिशन","79. गवर्नर जनरल एवं वायसराय","80. कांग्रेस का अधिवेशन","81. दिल्ली दरबार","82. नेहरू काल","83. पुनर्जागरण","84. इंग्लैंड की क्रांति","85. फ्रांस की क्रांति","86. प्रथम विश्व युद्ध"],
        "reasoning": ["1. सादृश्य परीक्षा","2. वर्गीकरण","3. वर्णमाला","4. कोडिंग और डिकोडिंग","5. दिशा और दूरी","6. रक्त संबंध","7. पदानुक्रम","8. व्यवस्थीकरण","9. पहेली","10. नवीन दृष्टि","11. श्रृंखला","12. गणितीय समीकरण","13. अंकीय तर्कशक्ति","14. अंक-अंक श्रृंखला","15. संख्याओं पर श्रृंखला","16. समीकरण","17. आरोही व्याख्या","18. तर्कसंगत क्रम","19. औंको का अनुपालन","20. इनपुट-आउटपुट","21. असमानता","22. कैलेंडर","23. समय और घड़ियाँ","24. जल प्रतिबिंब","25. दर्पण प्रतिबिंब","26. पासा","27. धन का मुद्रण","28. कथनों की सत्यता","29. निर्णय-निर्धारण","30. न्याय निगमन","31. कथन : कार्यवाही","32. कथन एवं पूर्वधारणाएँ","33. कथन और तर्क","34. कथन और निष्कर्ष","35. कारण और प्रभाव","36. कथन और कारण","37. परिच्छेद और निष्कर्ष"],
        "math": ["1. Digital Sum","2. Geometry","3. Mensuration 2D","4. Mensuration 3D","5. LCM & HCF","6. Number System","7. Simplification","8. Algebra","9. Trigonometry","10. Height & Distance","11. Co-ordinate Geometry","12. Percentage","13. Profit & Loss","14. Discount","15. Simple Interest","16. Compound Interest","17. Ratio & Proportion","18. Partnership","19. Mixture","20. Alligation","21. Average","22. Time & Work","23. Pipe & Cistern","24. Time & Distance","25. Train","26. Race","27. Boat & Stream","28. Permutation & Combination","29. Probability","30. Statistics","31. Logarithm","32. Calculation"],
        "hindi": ["1. वर्णमाला","2. पर्यायवाची शब्द","3. विलोम शब्द","4. भिन्नार्थक शब्द","5. अनेकार्थी शब्द","6. अनेक शब्दों के स्थान पर एक शब्द","7. विकारी शब्द(संज्ञा)","8. विकारी शब्द(सर्वनाम)","9. विकारी शब्द(विशेषण)","10. विकारी शब्द(क्रिया)","11. क्रिया(काल)","12. क्रिया(वाच्य)","13. अविकारी शब्द","14. लिंग वचन और कारक","15. संधि","16. समास","17. उपसर्ग-प्रत्यय","18. मुहावरे-लोकोक्ति","19. विराम चिन्ह"],
        "static-gk": ["1. भारत की जनगणना","2. प्रमुख पुरस्कार","3. महत्वपूर्ण उपनाम","4. संगठन","5. महत्वपूर्ण दिवस","6. भारत में प्रथम","7. लार्जेस्ट एंड बिगेस्ट","8. महत्वपूर्ण स्थल","9. नेशनल पार्क","10. शास्त्रीय नृत्य","11. वाद्य यंत्र","12. मेले और त्योहार","13. आर्ट और कल्चर","14. प्रमुख घराना","15. खेल","16. किताबें","17. पड़ोसी देश","18. राजधानी और मुद्राएं","19. मिसलेनियस"],
        "संविधान-articles": ["1. अनुसूचिया","2. अनुच्छेद 1-50","3. अनुच्छेद 50-100","4. अनुच्छेद 100-150","5. अनुच्छेद 150-200","6. अनुच्छेद 200-250","7. अनुच्छेद 250-300","8. अनुच्छेद 300-371","9. भाग 1-22","10. संशोधन 1-31","11. संशोधन 35-61","12. संशोधन 65-97","13. संशोधन 98-106"],
        "maths-formulas": ["1. क्षेत्रमिति फॉर्मूला (mensuration)","2. त्रिकोणमिती फॉर्मूला (trignometry)"],
        "fill-form": Array.from({length: 104}, (_, i) => ({name: `कार्य ${i+1} (Task ${i+1})`}))
    };

    const CURRENT_APP_VERSION = "13.0"; // Advanced URL Manager & Drag-Drop
    const DPT_EXCLUDED_SUBJECTS = ['static-gk', 'maths-formulas', 'fill-form', 'संविधान-articles'];
    const REVISION_EXCLUDED_SUBJECTS = ['static-gk', 'संविधान-articles', 'maths-formulas', 'fill-form'];
    
    // Updates Logic (Auto-limits to 10 in UI)
    const updateNotes = {
        "13.0": {
            date: new Date().toISOString().split('T')[0],
            features: [
                { "title": "Advanced URL Manager 📂", "note": "URL पेज को पूरी तरह नया बनाया गया है। अब 'Clean View' में फोल्डर खुलेंगे (Main फोल्डर छिप जाएगा)।" },
                { "title": "Drag & Drop Sorting ✋", "note": "किसी भी फोल्डर या लिंक को दबाकर रखें (Touch & Hold) और ऊपर-नीचे स्लाइड करके मूव करें।" },
                { "title": "Infinite Sub-Folders 🗂️", "note": "फोल्डर के अंदर फोल्डर, उसके अंदर और फोल्डर... अब कोई सीमा नहीं है।" },
                { "title": "Color Coding 🎨", "note": "Main फोल्डर और Sub-फोल्डर्स के लिए अलग-अलग और प्रीमियम रंग डिजाइन किए गए हैं।" }
            ]
        },
        "12.4": {
            date: "2025-02-01",
            features: [
                { "title": "Future Task Separation 📅", "note": "भविष्य (Future) के टास्क अब 'Notes' पेज पर बाईं तरफ (Left Side) एक अलग लिस्ट में दिखेंगे।" },
                { "title": "Job/Tag Tracker 🏷️", "note": "'Add Other Task' में अब 'Tag' का ऑप्शन है। 'Job' टैग वाले टास्क अलग लिस्ट में दिखेंगे।" }
            ]
        },
        "12.3": {
            date: "2025-01-16",
            features: [
                { "title": "Anti-Heating Engine ❄️", "note": "पीसी और मोबाइल को गर्म होने से बचाने के लिए ग्राफिक्स को हल्का किया गया है।" }
            ]
        },
        "12.2": {
            date: "2025-01-15",
            features: [
                { "title": "Fill Form Routine Fixed 📝", "note": "रेलवे और फाउंडेशन दोनों रूटीन में 'Fill Form' अब हर रविवार (Sunday) को डैशबोर्ड पर सही दिखेगा।" },
                { "title": "Advanced Routine Fixed 🛠️", "note": "सेटिंग्स में 'Select Subject' ड्रॉपडाउन अब 100% काम करेगा। खाली लिस्ट की समस्या को ठीक कर दिया गया है।" },
                { "title": "History & Future Log 📜", "note": "'Notes' पेज पर अब दो नए सेक्शन हैं: 1. 'Pending Task Queue' (भविष्य के टास्क), 2. 'Recent History' (डिलीट/पूरे किए गए टास्क)।" },
                { "title": "Delete Task Upgrade 🗑️", "note": "आप 'Notes' पेज से भी अब किसी भी पेंडिंग टास्क को डिलीट कर सकते हैं।" },
                { "title": "Super Cooling Mode ❄️", "note": "एप्लीकेशन अब लैपटॉप और मोबाइल पर बिल्कुल भी गर्म नहीं होगा। एनिमेशन और मेमोरी को 5x ऑप्टिमाइज़ किया गया है।" }
            ]
        },
        "12.1": {
            date: "2025-01-14",
            features: [
                { "title": "History Fixed (100%) 📜", "note": "नोट्स पेज पर 'Task History' अब पूरी तरह ठीक है। डिलीट या कम्प्लीट किए गए टास्क अब कभी गायब नहीं होंगे।" },
                { "title": "Performance Boost 🚀", "note": "डेटा सेविंग को ऑप्टिमाइज़ किया गया है ताकि ऐप भारी न हो और स्मूथ चले।" }
            ]
        },
        "12.0": {
            date: "2025-01-13",
            features: [
                { "title": "Collapsed Chapters & Folders 📂", "note": "सब्जेक्ट और URL पेज पर लिस्ट अब डिफ़ॉल्ट रूप से बंद (Collapsed) रहेगी।" },
                { "title": "Exam Grid & Links 🔗", "note": "एग्जाम 1x4 ग्रिड में दिखेंगे और लिंक क्लिक करने योग्य होंगे।" }
            ]
        },
        "11.3": {
            date: "2025-01-12",
            features: [
                { "title": "Big Exam Grid 🔢", "note": "डैशबोर्ड पर अब 4 एग्जाम Grid में दिखेंगे।" },
                { "title": "Exam Alert Colors 🚨", "note": "एग्जाम पास आने पर रंग अपने आप बदलेंगे।" }
            ]
        },
        "11.2": {
            date: "2025-01-11",
            features: [
                { "title": "New Revision Cycle 🧠", "note": "रिवीजन का तरीका बदल दिया गया है। अब रिवीजन ठीक **8वें दिन** और **23वें दिन** आएगा।" },
                { "title": "Backup Import Fixed 🛠️", "note": "Full Backup Import वाली समस्या को ठीक कर दिया गया है।" }
            ]
        },
        "11.1": {
            date: "2025-01-10",
            features: [
                { "title": "History Fix (100% Solved) 📜", "note": "अब 'Other Task' को Complete या Delete करने पर वह तुरंत 'Notes & History' पेज पर रिकॉर्ड हो जाएगा। यह अब कभी मिस नहीं होगा।" },
                { "title": "Mega Update Popup 🚀", "note": "अपडेट पॉप-अप अब पिछले 10 बदलावों को दिखाता है। आप पॉप-अप के अंदर ही स्क्रॉल करके सब कुछ पढ़ सकते हैं।" },
                { "title": "Notes UI Fix 📱", "note": "मोबाइल मेनू में नाम अब सही 'Notes' दिखाई देगा।" }
            ]
        },
        "11.0": {
            date: "2025-01-09",
            features: [
                { "title": "Splash Screen Intro ✨", "note": "ऐप खोलते ही अब एक प्रीमियम एनिमेटेड इंट्रो दिखेगा। Professional Look!" },
                { "title": "System Default Theme 🌗", "note": "नया 'System' मोड जोड़ा गया है जो आपके फोन/पीसी की सेटिंग के अनुसार अपने आप डार्क या लाइट हो जाएगा।" },
                { "title": "Mobile Name Fix 📱", "note": "मोबाइल मेनू में 'Notics' को बदलकर 'Notes' कर दिया गया है।" }
            ]
        },
        "10.5": {
            date: "2025-01-08",
            features: [
                { "title": "Strict Postpone Logic (FIXED) 📌", "note": "पोस्टपोन किए गए चैप्टर अब 100% गारंटी के साथ अगली बार सबसे पहले दिखेंगे। पेज नंबर वाला नोट भी सुरक्षित रहेगा।" },
                { "title": "True Random Chapters 🎲", "note": "Today's Task में अब चैप्टर हमेशा 'रैंडम' (Random) आएंगे, कभी भी पहला चैप्टर बार-बार नहीं आएगा।" },
                { "title": "History Visible 📜", "note": "'Notes & History' पेज पर अब पिछले 30 दिनों के पूरे किए गए टास्क साफ दिखाई देंगे।" },
                { "title": "Performance Boost 🚀", "note": "पीसी और मोबाइल को गर्म होने से बचाने के लिए और स्क्रॉलिंग को स्मूथ बनाने के लिए कोड को 5x ऑप्टिमाइज़ किया गया है।" }
            ]
        },
        "10.4": {
            date: "2025-01-08",
            features: [
                { "title": "Random & Smart Plan 🧠", "note": "Today's Plan अब पूरा हो चुके चैप्टर्स को कभी नहीं दिखाएगा। साथ ही, अब चैप्टर्स 'रैंडम' (Random) आएंगे, हमेशा पहला नहीं।" },
                { "title": "Strict Postpone Logic 📌", "note": "अगर आपने कोई चैप्टर पोस्टपोन किया और पेज नंबर लिखा, तो अगली बार वही चैप्टर और वही नया नोट सबसे पहले दिखेगा।" },
                { "title": "Priority Tasks 🔥", "note": "Other Task में 'Priority' का ऑप्शन है। एग्जाम जैसी तारीखों को 3 दिन पहले से डैशबोर्ड पर अलग रंगों में दिखाया जाएगा।" },
                { "title": "Notices & History 📝", "note": "नया 'Notice' पेज! जहाँ आप अपने पर्सनल नोट्स लिख सकते हैं और पुराने टास्क्स की हिस्ट्री देख सकते हैं।" }
            ]
        },
        "10.3": {
            date: "2025-01-06",
            features: [
                { "title": "Super Speed Mode 🚀", "note": "एप्लीकेशन अब 5 गुना तेज है। हीटिंग प्रॉब्लम को पूरी तरह ठीक कर दिया गया है।" },
                { "title": "System Theme 🌗", "note": "अब 3 थीम मोड हैं: Day, Dark, और System Default।" }
            ]
        }
    };

    const DB_KEY = 'pravejStudyTracker';
    let lastAction = null;
    let undoTimeout = null;
    // Removed dashboardProgressView variable as we don't need to switch views anymore
    let subjectPageViewMode = 'all'; // 'all' or 'completed'
    let dptPageViewMode = 'pending'; // 'pending' or 'completed'
    
    let dynamicDisplayIntervals = {}; 
    
    const getLocalDateString = (date = new Date()) => {
        date.setHours(0, 0, 0, 0);
        return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    };

    let lastIntervalDateString = getLocalDateString();
    
    const translations = {
        en: {
            "physics": "Physics", "polity": "Polity", "chemistry": "Chemistry", "hindi": "Hindi",
            "geography": "Geography", "biology": "Biology", "economics": "Economics",
            "history": "History", "math": "Math", "static-gk": "Static GK",
            "reasoning": "Reasoning", "संविधान-articles": "Constitution (Articles)", "maths-formulas": "Maths Formulas & Tables", "fill-form": "Form Filling / Misc",
            "study_tracker": "Study Tracker", "home": "Home", "subjects": "Subjects", "activity": "Activity",
            "calendar": "Calendar", "analytics": "Analytics", "report": "Report", "settings": "Settings", "reminders": "Reminders",
            "import_export": "Import/Export", "import_export_data": "Import & Export Data",
            "light_mode": "Light Mode", "dark_mode": "Dark Mode", "collapse": "Collapse", "expand": "Expand",
            "welcome_pravej": "Welcome", "welcome_subtitle": "Here's your plan for today. Let's get it done!",
            "todays_plan": "Today's Plan", "tomorrows_topics": "Tomorrow's Topics", "upcoming_revisions": "Upcoming Revisions",
            "achievements": "Achievements", "days_remaining": "Days Remaining",
            "overall_progress": "Overall Progress", "chapters_completed": "Chapters Completed",
            "set_date": "Set Date", "deadline_passed": "Deadline passed!", "all_chapters_completed": "All chapters completed!",
            "add_chapters_prompt": "Add chapters to track your progress.",
            "no_upcoming_revisions": "No upcoming revisions.", "keep_studying_prompt": "Keep studying to earn badges!",
            "today": "Today", "tomorrow": "Tomorrow", "congratulations": "Congratulations!", 
            "all_tasks_completed": "All tasks for today are completed.", "revision_task": "{chapterName} (Revision)", 
            "postpone_task": "Postpone", "skip_chapter": "Skip",
            "postponed_chapters": "Postponed Chapters", "no_postponed_chapters": "No chapters have been postponed.",
            "subject_wise_progress_dashboard": "Subject-wise Progress", "subjects_chapters": "Subjects & Chapters", 
            "search_chapters": "Search chapters...", "chapters_done_of": "{completed} / {total} chapters done",
            "no_chapters_added": "No chapters added yet.", "add_chapter": "Add Chapter", "your_activity": "Your Activity", 
            "no_activity_yet": "No Activity Yet", "start_studying_prompt": "Start studying and your progress will appear here.",
            "study_calendar": "Study Calendar", "analytics_reports": "Analytics & Reports", 
            "total_chapters_done": "Total Chapters Done", "average_per_day": "Average per Day", "best_day": "Best Day", 
            "top_subject": "Top Subject", "chapter_status_distribution": "Chapter Status Distribution", 
            "weekly_productivity": "Weekly Productivity (Chapters Done)", "subject_wise_progress": "Subject-wise Progress (%)",
            "completed_chapters_chart": "Completed Chapters", "app_language": "Application Language", "student_name": "Student Name",
            "data_management": "Data Management", "import_data": "Import Data", 
            "export_data": "Export All Data (Backup)", "daily_plan_mode": "Daily Study Plan Mode", 
            "daily_plan_subtitle": "Choose how you want to generate your daily study plan.",
            "auto_rotation": "Automatic Rotation", "weekly_cycle": "Weekly Cycle", "manual_today": "Manual (Today Only)",
            "manual_select_subjects": "Select subjects for Today's Plan:", "weekly_study_plan": "Weekly Study Plan", 
            "save_weekly_plan": "Save Weekly Plan", "reset_app": "Reset Application", "reset_all_data": "Reset All Data",
            "add_new_chapter": "Add New Chapter", "chapter_name": "Chapter Name", "are_you_sure": "Are you sure?",
            "action_cannot_be_undone": "This action cannot be undone.", "cancel": "Cancel", "confirm": "Confirm",
            "chapter_details": "Chapter Details", "status": "Status", "save_changes": "Save Changes",
            "delete_chapter": "Delete Chapter", "achievement_unlocked": "Achievement Unlocked!", "awesome": "Awesome!",
            "not_started": "Not Started", "in_progress": "In Progress", "completed": "Completed",
            "missed_chapters": "Missed Chapters", "no_missed_chapters": "No chapters have been missed.",
            "yesterdays_completed": "Yesterday's Completed Chapters", "no_chapters_yesterday": "No chapters were completed yesterday.",
            "chapter_completed_msg": "Chapter marked complete.", "undo": "Undo",
            "import": "Import", "export": "Export", "chapters_data_management": "Chapters Data Management",
            "full_app_backup": "Full Application Backup",
            "full_app_backup_desc": "Export all your data into a single JSON file.",
            "study_report": "Study Report", "download_pdf": "Download PDF", "overall_summary": "Overall Summary", 
            "total_subjects": "Total Subjects", "total_chapters": "Total Chapters", "progress": "Progress",
            "subject_breakdown": "Subject Breakdown", "completed_on": "Completed On", "no_activity_log_report": "No activity logged yet.",
            "recent_activity": "Recent Activity", "student_name_placeholder": "Enter your name...",
            "feature_coming_soon": "Feature Coming Soon!",
            "add_new_reminder": "Add New Reminder", "reminder_text": "Reminder Text", "reminder_date": "Date", "reminder_time": "Time", "save_reminder": "Save Reminder",
            "no_reminders_set": "No reminders set. Add one to get started!", "mark_done": "Done",
            "study_notes": "Study Notes", "study_notes_placeholder": "e.g., This chapter is important for exams...", "priority_revision": "Mark for Priority Revision",
            "reminder_repeat": "Repeat", "repeat_none": "Does not repeat", "repeat_daily": "Daily", "repeat_weekly": "Weekly", "reminder_completed_today": "Reminder completed for today",
            "exams": "Exams", "exams_and_forms": "Exams & Applied Forms", "add_new_exam": "Add New Exam", "application_date": "Application Date", "exam_date": "Exam Date", "notes": "Notes",
            "save_exam": "Save Exam", "status_applied": "Applied", "status_admit_card": "Admit Card Out", "status_exam_done": "Exam Done", "status_result_out": "Result Out", "applied_on": "Applied on",
            "no_exams_added": "No exams added yet. Track your applications here!", "all": "All", "upcoming_exams": "Upcoming Exams", "applied_forms": "Applied Forms", "ai_insights": "AI Study Coach ✨",
            "ai_insight_produ_day": "Your most productive day seems to be {day}. Keep up the great work!", "ai_insight_stale_subject": "You haven't studied {subject} in a while. Consider reviewing it.",
            "ai_insight_missed_chapters": "You have {count} missed chapters. Try to clear them soon.", "ai_insight_start": "Welcome! Let's start by adding some chapters to study.",
            "notes_placeholder": "e.g., Registration no., website link...", "delete_exam": "Delete Exam", "no_upcoming_exams": "No upcoming exams.", "edit_exam": "Edit Exam",
            "application_receipt": "Application Receipt", "view_receipt": "View Current Receipt", "receipt_attached": "Receipt Attached",
            "history_exams": "History", "no_history_exams": "No past exams found in your history.", "no_upcoming_exams_filter": "There are no upcoming exams scheduled.", "no_applied_forms_filter": "No forms currently in 'Applied' status.",
            "dpt": "DPT", "dpt_page_title": "Daily Practice Tests (DPT)", "all_subjects": "All Subjects",
            "add_dpt": "Add DPTs", "add_dpt_all": "Add to All Chapters", "no_dpt_for_subject": "No DPTs added for this subject yet.", "dpt_progress": "Test {completed} of {total} completed",
            "todays_dpt": "Today's DPT", "mark_as_complete": "Mark as Complete", "no_dpt_scheduled": "No DPT scheduled for today.",
            "all_dpt_completed": "All DPTs for today completed! Great job!",
            "enter_dpt_details": "Enter DPT Details", "dpt_total_q": "Total Qs", "dpt_total_time": "Total Time", "dpt_attempted": "Attempted",
            "dpt_correct": "Correct", "dpt_wrong": "Wrong", "dpt_time_taken": "Time Taken", "submit": "Submit",
            "dpt_summary": "DPT Summary", "total_dpt_completed": "Total DPTs Completed", "overall_accuracy": "Overall Accuracy",
            "avg_time_per_q": "Avg. Time / Q (s)", "add_new_subject": "Add New Subject",
            "enter_subject_name": "Enter the new subject name:", "subject_exists": "A subject with this name already exists.",
            "delete_all": "Delete All", "delete_all_chapters_confirm": "Are you sure you want to delete ALL chapters for this subject? This cannot be undone.",
            "custom_cycle": "Custom Cycle", "custom_study_plan": "Custom Study Plan (2 Week Cycle)", "save_custom_plan": "Save Custom Plan",
            "dpt_plan_mode": "Daily DPT Plan Mode", "dpt_plan_subtitle": "Choose how you want to generate your daily DPT schedule.", "dpt_auto_mode": "Automatic (Follows Study Plan)", "custom_dpt_plan": "Custom DPT Plan (2 Week Cycle)",
            "dpt_report_title": "DPT Summary", "dpt_subject_breakdown": "DPT विषयवार विश्लेषण", "no_dpt_data_report": "अभी तक कोई DPT डेटा लॉग नहीं किया गया है।",
            "sunday": "रविवार", "monday": "सोमवार", "tuesday": "मंगलवार", "wednesday": "बुधवार", "thursday": "गुरुवार", "friday": "शुक्रवार", "saturday": "शनिवार", "week": "सप्ताह",
            "delete_subject": "विषय हटाएं", "delete_subject_confirm": "यह विषय '{subjectName}' और इसके सभी चैप्टर्स और DPTs को हटा देगा। यह कार्रवाई पूर्ववत् नहीं की जा सकती।",
            "delete_dpt": "DPT हटाएं", "delete_dpt_confirm": "क्या आप वाकई {dptName} को हटाना चाहते हैं? इसका डेटा स्थायी रूप से हट जाएगा।",
            "routine_management": "रूटीन प्रबंधन", "routine_management_desc": "अपनी 14-दिवसीय अध्ययन योजना को एक्सपोर्ट करें या JSON फ़ाइल से एक नई योजना इंपोर्ट करें।", "import_routine": "रूटीन इंपोर्ट करें (JSON)", "export_json": "JSON एक्सपोर्ट करें", "export_pdf": "PDF एक्सपोर्ट करें",
            "exams_data_management": "परीक्षा डेटा प्रबंधन", "exams_data_management_desc": "अपनी परीक्षाओं की सूची इंपोर्ट या एक्सपोर्ट करें।",
            "complete_yesterdays_task": "कल का टास्क पूरा करें", "complete_yesterdays_dpt": "कल का DPT पूरा करें",
            "delete_all_dpts": "सभी DPT हटाएं", "delete_all_dpts_confirm": "{subjectName} के सभी DPT को हटाने के लिए क्या आप निश्चित हैं? इसे पूर्ववत नहीं किया जा सकता।",
            "restudy_subject": "विषय को दोबारा पढ़ें", "restudy_subject_confirm": "यह '{subjectName}' के सभी चैप्टर की प्रगति को रीसेट कर देगा और इसे एक बार पूरा हुआ चिह्नित करेगा। क्या आप निश्चित हैं? यह रिवीजन के लिए बहुत अच्छा है!",
            "completion_cycle": "चक्र {count}",
            "url_title": "सहेजे गए यूआरएल", "add_new_folder": "नया फ़ोल्डर जोड़ें", "folder_name": "फ़ोल्डर का नाम", "add_new_link": "नया लिंक जोड़ें", "link_name": "लिंक का नाम", "link_url": "यूआरएल", "save": "सहेजें", "edit": "संपादित करें", "delete": "हटाएं", "no_links_in_folder": "इस फ़ोल्डर में अभी तक कोई लिंक नहीं सहेजा गया है।", "no_folders_created": "अभी तक कोई फ़ोल्डर नहीं बनाया गया है। आरंभ करने के लिए एक जोड़ें!", "delete_folder_confirm": "क्या आप वाकई फ़ोल्डर '{folderName}' और उसके अंदर की सभी चीज़ें हटाना चाहते हैं?", "delete_link_confirm": "क्या आप वाकई लिंक '{linkName}' हटाना चाहते हैं?", "add_sub_folder": "सब-फ़ोल्डर जोड़ें",
            "completed_other_tasks": "पूर्ण हुए अन्य कार्य (पिछले 30 दिन)", "no_completed_other_tasks": "पिछले 30 दिनों में कोई अन्य कार्य पूरा नहीं हुआ है।"
        },
        hi: {
            "physics": "भौतिकी", "polity": "राजनीति", "chemistry": "रसायन विज्ञान", "hindi": "हिंदी",
            "geography": "भूगोल", "biology": "जीव विज्ञान", "economics": "अर्थशास्त्र",
            "history": "इतिहास", "math": "गणित", "static-gk": "स्टेटिक जीके",
            "reasoning": "रीजनिंग", "संविधान-articles": "संविधान (अनुच्छेद)", "maths-formulas": "गणित सूत्र और तालिका", "fill-form": "फॉर्म भरना / विविध",
            "study_tracker": "स्टडी ट्रैकर", "home": "होम", "subjects": "विषय", "activity": "गतिविधि",
            "calendar": "कैलेंडर", "analytics": "एनालिटिक्स", "report": "रिपोर्ट", "settings": "सेटिंग्स", "reminders": "रिमाइंडर",
            "import_export": "इंपोर्ट/एक्सपोर्ट", "import_export_data": "डेटा इंपोर्ट और एक्सपोर्ट करें",
            "light_mode": "लाइट मोड", "dark_mode": "डार्क मोड", "collapse": "संक्षिप्त करें", "expand": "विस्तार करें",
            "welcome_pravej": "आपका स्वागत है", "welcome_subtitle": "आज की आपकी योजना यहाँ है। चलिए इसे पूरा करते हैं!",
            "todays_plan": "आज की योजना", "tomorrows_topics": "कल के विषय", "upcoming_revisions": "आगामी रिवीजन",
            "achievements": "उपलब्धियां", "days_remaining": "शेष दिन",
            "overall_progress": "कुल प्रगति", "chapters_completed": "अध्याय पूरे हुए",
            "set_date": "तिथि सेट करें", "deadline_passed": "समय सीमा समाप्त हो गई!", "all_chapters_completed": "सभी अध्याय पूरे हो गए!",
            "add_chapters_prompt": "अपनी प्रगति को ट्रैक करने के लिए अध्याय जोड़ें।",
            "no_upcoming_revisions": "कोई आगामी रिवीजन नहीं है।", "keep_studying_prompt": "बैज अर्जित करने के लिए अध्ययन करते रहें!",
            "today": "आज", "tomorrow": "कल", "congratulations": "बधाई हो!", 
            "all_tasks_completed": "आज के सभी कार्य पूरे हो गए हैं।", "revision_task": "{chapterName} (रिवीजन)", 
            "postpone_task": "स्थगित करें", "skip_chapter": "स्किप",
            "postponed_chapters": "स्थगित अध्याय", "no_postponed_chapters": "कोई अध्याय स्थगित नहीं किया गया है।",
            "subject_wise_progress_dashboard": "विषय-वार प्रगति", "subjects_chapters": "विषय और अध्याय", 
            "search_chapters": "अध्याय खोजें...", "chapters_done_of": "{total} में से {completed} अध्याय पूरे हुए",
            "no_chapters_added": "अभी तक कोई अध्याय नहीं जोड़ा गया है।", "add_chapter": "अध्याय जोड़ें", 
            "your_activity": "आपकी गतिविधि", "no_activity_yet": "अभी तक कोई गतिविधि नहीं", 
            "start_studying_prompt": "अध्ययन शुरू करें और आपकी प्रगति यहां दिखाई देगी।",
            "study_calendar": "अध्ययन कैलेंडर", "analytics_reports": "एनालिटिक्स और रिपोर्ट", 
            "total_chapters_done": "कुल अध्याय पूरे हुए", "average_per_day": "प्रति दिन औसत", "best_day": "सबसे अच्छा दिन", 
            "top_subject": "शीर्ष विषय", "chapter_status_distribution": "अध्याय स्थिति वितरण", 
            "weekly_productivity": "साप्ताहिक उत्पादकता (अध्याय पूरे हुए)", "subject_wise_progress": "विषय-वार प्रगति (%)",
            "completed_chapters_chart": "पूर्ण अध्याय", "app_language": "एप्लिकेशन भाषा", "student_name": "छात्र का नाम",
            "data_management": "डेटा प्रबंधन", "import_data": "डेटा आयात करें", 
            "export_data": "सारा डेटा निर्यात करें (बैकअप)", "daily_plan_mode": "दैनिक अध्ययन योजना मोड", 
            "daily_plan_subtitle": "चुनें कि आप अपनी दैनिक अध्ययन योजना कैसे बनाना चाहते हैं।",
            "auto_rotation": "स्वचालित रोटेशन", "weekly_cycle": "साप्ताहिक चक्र", "manual_today": "मैनुअल (केवल आज)",
            "manual_select_subjects": "आज की योजना के लिए विषय चुनें:", "weekly_study_plan": "साप्ताहिक अध्ययन योजना", 
            "save_weekly_plan": "साप्ताहिक योजना सहेजें", "reset_app": "एप्लिकेशन रीसेट करें", "reset_all_data": "सारा डेटा रीसेट करें",
            "add_new_chapter": "नया अध्याय जोड़ें", "chapter_name": "अध्याय का नाम", "are_you_sure": "क्या आप निश्चित हैं?",
            "action_cannot_be_undone": "यह कार्रवाई पूर्ववत नहीं की जा सकती।", "cancel": "रद्द करें", "confirm": "पुष्टि करें",
            "chapter_details": "अध्याय विवरण", "status": "स्थिति", "save_changes": "बदलाव सहेजें",
            "delete_chapter": "अध्याय हटाएं", "achievement_unlocked": "उपलब्धि अनलॉक हुई!", "awesome": "बहुत बढ़िया!",
            "not_started": "शुरू नहीं हुआ", "in_progress": "प्रगति में है", "completed": "पूरा हो गया",
            "missed_chapters": "छूटे हुए अध्याय", "no_missed_chapters": "कोई भी अध्याय छूटा नहीं है।",
            "yesterdays_completed": "कल पूरे हुए अध्याय", "no_chapters_yesterday": "कल कोई अध्याय पूरा नहीं हुआ।",
            "chapter_completed_msg": "अध्याय पूरा हुआ।", "undo": "पूर्ववत् करें",
            "import": "आयात", "export": "निर्यात", "chapters_data_management": "चैप्टर्स डेटा प्रबंधन",
            "full_app_backup": "पूर्ण एप्लिकेशन बैकअप",
            "full_app_backup_desc": "विषय, अध्याय, प्रगति, सेटिंग्स और गतिविधि लॉग सहित अपने सभी डेटा को एक ही JSON फ़ाइल में निर्यात करें।",
            "study_report": "स्टडी रिपोर्ट", "download_pdf": "पीडीएफ डाउनलोड करें", "overall_summary": "कुल सारांश",
            "total_subjects": "कुल विषय", "total_chapters": "कुल अध्याय", "progress": "प्रगति",
            "subject_breakdown": "विषयवार विश्लेषण", "completed_on": "को पूरा हुआ", "no_activity_log_report": "अभी तक कोई गतिविधि लॉग नहीं की गई है।",
            "recent_activity": "हाल की गतिविधि", "student_name_placeholder": "अपना नाम दर्ज करें...",
            "feature_coming_soon": "यह सुविधा जल्द ही आ रही है!",
            "add_new_reminder": "नया रिमाइंडर जोड़ें", "reminder_text": "रिमाइंडर टेक्स्ट", "reminder_date": "तारीख", "reminder_time": "समय", "save_reminder": "रिमाइंडर सहेजें",
            "no_reminders_set": "कोई रिमाइंडर सेट नहीं है। आरंभ करने के लिए एक जोड़ें!", "mark_done": "पूर्ण",
            "study_notes": "स्टडी नोट्स", "study_notes_placeholder": "जैसे, यह अध्याय परीक्षा के लिए महत्वपूर्ण है...", "priority_revision": "प्राथमिकता रिवीजन के लिए चिह्नित करें",
            "reminder_repeat": "दोहराएँ", "repeat_none": "नहीं दोहराता", "repeat_daily": "रोज़", "repeat_weekly": "साप्ताहिक", "reminder_completed_today": "रिमाइंडर आज के लिए पूरा हुआ",
            "exams": "परीक्षाएं", "exams_and_forms": "परीक्षाएं और भरे हुए फॉर्म", "add_new_exam": "नई परीक्षा जोड़ें", "application_date": "आवेदन तिथि", "exam_date": "परीक्षा तिथि", "notes": "नोट्स",
            "save_exam": "परीक्षा सहेजें", "status_applied": "आवेदन किया गया", "status_admit_card": "एडमिट कार्ड आ गया", "status_exam_done": "परीक्षा हो गई", "status_result_out": "परिणाम आ गया", "applied_on": "आवेदन किया",
            "no_exams_added": "अभी तक कोई परीक्षा नहीं जोड़ी गई है। यहां अपने आवेदन ट्रैक करें!", "all": "सभी", "upcoming_exams": "आगामी परीक्षाएं", "applied_forms": "भरे हुए फॉर्म", "ai_insights": "AI स्टडी कोच ✨",
            "ai_insight_produ_day": "आपका सबसे प्रोडक्टिव दिन {day} लगता है। बढ़िया काम करते रहें!", "ai_insight_stale_subject": "आपने काफी समय से {subject} नहीं पढ़ा है। इसे दोहराने पर विचार करें।",
            "ai_insight_missed_chapters": "आपके {count} अध्याय छूट गए हैं। उन्हें जल्द ही पूरा करने का प्रयास करें।", "ai_insight_start": "स्वागत है! चलिए अध्ययन करने के लिए कुछ अध्याय जोड़कर शुरुआत करते हैं।",
            "notes_placeholder": "उदा., पंजीकरण संख्या, वेबसाइट लिंक...", "delete_exam": "परीक्षा हटाएं", "no_upcoming_exams": "कोई आगामी परीक्षा नहीं है।", "edit_exam": "परीक्षा संपादित करें",
            "application_receipt": "आवेदन रसीद", "view_receipt": "वर्तमान रसीद देखें", "receipt_attached": "रसीद संलग्न है",
            "history_exams": "इतिहास", "no_history_exams": "आपके इतिहास में कोई पिछली परीक्षा नहीं मिली।", "no_upcoming_exams_filter": "कोई आगामी परीक्षा निर्धारित नहीं है।", "no_applied_forms_filter": "'आवेदन किया गया' स्थिति में वर्तमान में कोई फॉर्म नहीं है।",
            "dpt": "DPT", "dpt_page_title": "डेली प्रैक्टिस टेस्ट (DPT)", "all_subjects": "सभी विषय",
            "add_dpt": "DPT जोड़ें", "add_dpt_all": "सभी चैप्टर्स में जोड़ें", "no_dpt_for_subject": "इस विषय के लिए अभी तक कोई DPT नहीं जोड़ा गया है।", "dpt_progress": "{total} में से {completed} टेस्ट पूरे हुए",
            "todays_dpt": "आज का DPT", "mark_as_complete": "पूर्ण के रूप में चिह्नित करें", "no_dpt_scheduled": "आज के लिए कोई DPT निर्धारित नहीं है।",
            "all_dpt_completed": "आज के सभी DPT पूरे हो गए! बहुत बढ़िया!",
            "enter_dpt_details": "DPT विवरण दर्ज करें", "dpt_total_q": "कुल प्रश्न", "dpt_total_time": "कुल समय", "dpt_attempted": "प्रयास किए",
            "dpt_correct": "सही", "dpt_wrong": "गलत", "dpt_time_taken": "लिया गया समय", "submit": "सबमिट करें",
            "dpt_summary": "DPT सारांश", "total_dpt_completed": "कुल DPT पूरे हुए", "overall_accuracy": "कुल सटीकता",
            "avg_time_per_q": "औसत समय/प्रश्न (से)", "add_new_subject": "नया विषय जोड़ें",
            "enter_subject_name": "नए विषय का नाम दर्ज करें:", "subject_exists": "इस नाम का विषय पहले से मौजूद है।",
            "delete_all": "सभी हटाएं", "delete_all_chapters_confirm": "क्या आप वाकई इस विषय के सभी चैप्टर्स को हटाना चाहते हैं? यह क्रिया पूर्ववत् नहीं की जा सकती।",
            "custom_cycle": "कस्टम साइकिल", "custom_study_plan": "कस्टम अध्ययन योजना (2 सप्ताह चक्र)", "save_custom_plan": "कस्टम योजना सहेजें",
            "dpt_plan_mode": "दैनिक DPT योजना मोड", "dpt_plan_subtitle": "चुनें कि आप अपनी दैनिक DPT योजना कैसे बनाना चाहते हैं।", "dpt_auto_mode": "स्वचालित (अध्ययन योजना के अनुसार)", "custom_dpt_plan": "कस्टम DPT योजना (2 सप्ताह चक्र)",
            "dpt_report_title": "DPT सारांश", "dpt_subject_breakdown": "DPT विषयवार विश्लेषण", "no_dpt_data_report": "अभी तक कोई DPT डेटा लॉग नहीं किया गया है।",
            "sunday": "रविवार", "monday": "सोमवार", "tuesday": "मंगलवार", "wednesday": "बुधवार", "thursday": "गुरुवार", "friday": "शुक्रवार", "saturday": "शनिवार", "week": "सप्ताह",
            "delete_subject": "विषय हटाएं", "delete_subject_confirm": "यह विषय '{subjectName}' और इसके सभी चैप्टर्स और DPTs को हटा देगा। यह कार्रवाई पूर्ववत् नहीं की जा सकती।",
            "delete_dpt": "DPT हटाएं", "delete_dpt_confirm": "क्या आप वाकई {dptName} को हटाना चाहते हैं? इसका डेटा स्थायी रूप से हट जाएगा।",
            "routine_management": "रूटीन प्रबंधन", "routine_management_desc": "अपनी 14-दिवसीय अध्ययन योजना को एक्सपोर्ट करें या JSON फ़ाइल से एक नई योजना इंपोर्ट करें।", "import_routine": "रूटीन इंपोर्ट करें (JSON)", "export_json": "JSON एक्सपोर्ट करें", "export_pdf": "PDF एक्सपोर्ट करें",
            "exams_data_management": "परीक्षा डेटा प्रबंधन", "exams_data_management_desc": "अपनी परीक्षाओं की सूची इंपोर्ट या एक्सपोर्ट करें।",
            "complete_yesterdays_task": "कल का टास्क पूरा करें", "complete_yesterdays_dpt": "कल का DPT पूरा करें",
            "delete_all_dpts": "सभी DPT हटाएं", "delete_all_dpts_confirm": "{subjectName} के सभी DPT को हटाने के लिए क्या आप निश्चित हैं? इसे पूर्ववत नहीं किया जा सकता।",
            "restudy_subject": "विषय को दोबारा पढ़ें", "restudy_subject_confirm": "यह '{subjectName}' के सभी चैप्टर की प्रगति को रीसेट कर देगा और इसे एक बार पूरा हुआ चिह्नित करेगा। क्या आप निश्चित हैं? यह रिवीजन के लिए बहुत अच्छा है!",
            "completion_cycle": "चक्र {count}",
            "url_title": "सहेजे गए यूआरएल", "add_new_folder": "नया फ़ोल्डर जोड़ें", "folder_name": "फ़ोल्डर का नाम", "add_new_link": "नया लिंक जोड़ें", "link_name": "लिंक का नाम", "link_url": "यूआरएल", "save": "सहेजें", "edit": "संपादित करें", "delete": "हटाएं", "no_links_in_folder": "इस फ़ोल्डर में अभी तक कोई लिंक नहीं सहेजा गया है।", "no_folders_created": "अभी तक कोई फ़ोल्डर नहीं बनाया गया है। आरंभ करने के लिए एक जोड़ें!", "delete_folder_confirm": "क्या आप वाकई फ़ोल्डर '{folderName}' और उसके अंदर की सभी चीज़ें हटाना चाहते हैं?", "delete_link_confirm": "क्या आप वाकई लिंक '{linkName}' हटाना चाहते हैं?", "add_sub_folder": "सब-फ़ोल्डर जोड़ें",
            "completed_other_tasks": "पूर्ण हुए अन्य कार्य (पिछले 30 दिन)", "no_completed_other_tasks": "पिछले 30 दिनों में कोई अन्य कार्य पूरा नहीं हुआ है."
        }
    };

    const initialState = {
        subjects: [
            { id: "physics", name: "Physics", chapters: [], completionCount: 0 },
            { id: "chemistry", name: "Chemistry", chapters: [], completionCount: 0 },
            { id: "biology", name: "Biology", chapters: [], completionCount: 0 },
            { id: "geography", name: "Geography", chapters: [], completionCount: 0 },
            { id: "polity", name: "Polity", chapters: [], completionCount: 0 },
            { id: "economics", name: "Economics", chapters: [], completionCount: 0 },
            { id: "history", name: "History", chapters: [], completionCount: 0 },
            { id: "reasoning", name: "Reasoning", chapters: [], completionCount: 0 },
            { id: "math", name: "Math", chapters: [], completionCount: 0 },
            { id: "hindi", name: "Hindi", chapters: [], completionCount: 0 },
            { id: "static-gk", name: "Static GK", chapters: [], completionCount: 0 },
            { id: "संविधान-articles", name: "Constitution (Articles)", chapters: [], completionCount: 0 },
            { id: "maths-formulas", name: "Maths Formulas & Tables", chapters: [], completionCount: 0 },
            { id: "fill-form", name: "Form Filling / Misc", chapters: [], completionCount: 0 }
        ],
        settings: {
            theme: 'system', // Default is now System
            dptDashboardActive: true, 
            planMode: 'auto',
            customCyclePlan: Array(14).fill([]),
            dptPlanMode: 'auto',
            dptCyclePlan: Array(14).fill([]),
            customSubjectRoutine: [], 
            language: 'hi', 
            studentName: 'Rayen',
            customThemeColors: { 
                start: null, end: null,
                textLight: null, borderLight: null, textDark: null, borderDark: null 
            },
            backgroundStyle: 'default',
            appVersion: "1.0"
        },
        gamification: { badges: [], completedHistory: [] },
        activityLog: [], appStartDate: getLocalDateString(),
        postponedChapters: [],
        missedChapters: [],
        missedRevisions: [],
        dailyPlan: {},
        lastCheckedDate: null,
        exams: [],
        dpts: {},
        dailyDptPlan: {},
        urls: [],
        otherTasks: [],
        missedOtherTasks: [],
        postponedOtherTasks: [],
        personalNotes: [], 
        otherTaskHistory: [] 
    };

    let data;
    
    try {
        const savedData = localStorage.getItem(DB_KEY);
        if (savedData) {
            try {
                data = JSON.parse(savedData);
                if (!data.subjects || !Array.isArray(data.subjects)) throw new Error("Corrupt Data");
            } catch (innerError) {
                console.warn("Data corruption detected. Resetting.");
                localStorage.setItem(DB_KEY + '_corrupt_backup', savedData);
                data = JSON.parse(JSON.stringify(initialState));
            }
        } else {
            data = JSON.parse(JSON.stringify(initialState));
        }
    } catch (error) {
        console.error("Critical Storage Error", error);
        data = JSON.parse(JSON.stringify(initialState));
    }

    // --- 2. AUTO-POPULATE DEFAULT DATA (IF EMPTY) ---
    // If subjects have no chapters, populate them from DEFAULT_CHAPTERS_DB
    const populateDefaults = () => {
        let addedCount = 0;
        (data.subjects || []).forEach(subject => {
            // Clean ID to match DB keys
            let key = subject.id;
            if(key === 'reasoning') key = 'reasoning'; 
            
            let defaultChapters = DEFAULT_CHAPTERS_DB[key];
            if(!defaultChapters && key === 'reasoning') defaultChapters = DEFAULT_CHAPTERS_DB['reasoning'];
            
            // 1. Chapters Logic
            if (defaultChapters && subject.chapters.length === 0) {
                const chapters = defaultChapters.map(name => {
                    const cleanName = typeof name === 'string' ? name : name.name;
                    return {
                        id: `ch-def-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        name: cleanName,
                        status: 'Not Started',
                        dateAdded: new Date().toISOString().split('T')[0],
                        notes: '', priorityRevision: false, revisions: []
                    };
                });
                subject.chapters = chapters;
                addedCount += chapters.length;
            }

            // 2. NEW: Default DPT Logic (Auto-Add 2 DPTs)
            // Exclude list (Static GK, etc.)
            const excluded = ['static-gk', 'maths-formulas', 'fill-form', 'संविधान-articles'];
            
            if (!excluded.includes(subject.id)) {
                // Ensure DPT structure exists
                if (!data.dpts) data.dpts = {};
                if (!data.dpts[subject.id]) data.dpts[subject.id] = { chapters: {} };

                (subject.chapters || []).forEach(chapter => {
                     // If entry doesn't exist, create it
                     if (!data.dpts[subject.id].chapters[chapter.id]) {
                         data.dpts[subject.id].chapters[chapter.id] = [];
                     }
                     // Check if empty, then add 2 defaults
                     if (data.dpts[subject.id].chapters[chapter.id].length === 0) {
                         // Add DPT #1
                         data.dpts[subject.id].chapters[chapter.id].push({
                             id: 1, status: 'Pending', details: null
                         });
                         // Add DPT #2
                         data.dpts[subject.id].chapters[chapter.id].push({
                             id: 2, status: 'Pending', details: null
                         });
                     }
                });
            }
        });
        
        // Set Default Foundation Routine if no custom plan exists
        if (!data.settings.customCyclePlan || data.settings.customCyclePlan.every(d => d.length === 0)) {
            data.settings.customCyclePlan = JSON.parse(JSON.stringify(FOUNDATION_ROUTINE));
            data.settings.planMode = 'foundation_cycle'; 
        }
    };
    
    // Run population logic
    populateDefaults();
    
    // --- Data Structure Migration (CRITICAL FOR CRASH PREVENTION) ---
    // This block converts old "Book/Notes" structure to new "Unified Chapters" structure
    if (data.subjects) {
        data.subjects.forEach(subject => {
            // Check if chapters is an object (Old format: { notes: [], book: [] })
            if (subject.chapters && !Array.isArray(subject.chapters)) {
                const notesChapters = subject.chapters.notes || [];
                const bookChapters = subject.chapters.book || [];
                // Merge them into a single array
                subject.chapters = [...notesChapters, ...bookChapters];
            }
            // Ensure it is initialized as array if undefined
            if (!subject.chapters) {
                subject.chapters = [];
            }
        });
    }

    const safeInitialize = (obj, key, defaultValue) => {
        if (typeof obj[key] === 'undefined' || obj[key] === null) {
            obj[key] = defaultValue;
        }
    };

    safeInitialize(data, 'subjects', initialState.subjects);
    data.settings = {...initialState.settings, ...data.settings};
    data.settings.customThemeColors = {...initialState.settings.customThemeColors, ...data.settings.customThemeColors};
    
    if (data.postponedChapters && data.postponedChapters.length > 0 && typeof data.postponedChapters[0] !== 'object') {
        data.postponedChapters = [];
    } else {
        safeInitialize(data, 'postponedChapters', []);
    }
    
    ['missedChapters', 'missedRevisions', 'dailyPlan', 'exams', 'dpts', 'dailyDptPlan', 'urls', 'otherTasks', 'missedOtherTasks', 'postponedOtherTasks'].forEach(key => {
        safeInitialize(data, key, initialState[key]);
    });
    safeInitialize(data, 'lastCheckedDate', getLocalDateString());
safeInitialize(data.settings, 'customSubjectRoutine', []); // Ensure routine array exists

    if (data.links) { delete data.links; }
    
    if(!data.settings.customCyclePlan || data.settings.customCyclePlan.length !== 14) {
        const oldPlan = data.settings.customCyclePlan || [];
        data.settings.customCyclePlan = Array(14).fill([]).map((_, i) => oldPlan[i] || []);
    }
    if(!data.settings.dptCyclePlan || data.settings.dptCyclePlan.length !== 14) {
         const oldDptPlan = data.settings.dptCyclePlan || [];
        data.settings.dptCyclePlan = Array(14).fill([]).map((_, i) => oldDptPlan[i] || []);
    }

    // Clean up daily plan to remove source types from keys if they exist
    Object.keys(data.dailyPlan).forEach(date => {
        const plan = data.dailyPlan[date];
        if (plan && plan.tasks) {
            const newTasks = {};
            Object.entries(plan.tasks).forEach(([key, task]) => {
                if (task) {
                    // Remove sourceType from task object if present, it's no longer needed
                    // But we keep the task structure valid
                    const cleanTask = { ...task };
                    // Key might be "physics:notes", change to "physics"
                    const newKey = key.split(':')[0]; 
                    newTasks[newKey] = cleanTask;
                }
            });
            plan.tasks = newTasks;
        }
    });

    let saveTimeout = null;
    const saveData = () => {
        if (saveTimeout) clearTimeout(saveTimeout);
        // PERFORMANCE FIX: Increased delay to 2000ms to reduce CPU load (Heating Fix)
        // Using requestIdleCallback if available for smoother background saving
        saveTimeout = setTimeout(() => {
            const saveTask = () => {
                try {
                    // 1. Data Cleaning before saving
                    if(data.dailyPlan) {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        const cutoff = thirtyDaysAgo.toISOString().split('T')[0];
                        Object.keys(data.dailyPlan).forEach(date => {
                            if(date < cutoff) delete data.dailyPlan[date];
                        });
                    }

                    const dataString = JSON.stringify(data);
                    
                    // 2. Storage Limit Guard (Optimized)
                    if (dataString.length > 4800000) { 
                        if (!window.storageWarningShown) {
                            alert("⚠️ Storage Warning: App memory is near full. Please 'Export Backup' soon.");
                            window.storageWarningShown = true;
                        }
                    }

                    localStorage.setItem(DB_KEY, dataString);
                    
                } catch (error) {
                    console.error("Save Failed:", error);
                    if (error.name === 'QuotaExceededError' || error.code === 22) {
                        alert("⛔ STORAGE FULL! Please Export Backup immediately.");
                    }
                }
            };

            if ('requestIdleCallback' in window) {
                requestIdleCallback(saveTask);
            } else {
                saveTask();
            }
        }, 2000); 
    };
    
    const _ = (key, replacements = {}) => {
        const lang = data.settings.language || 'hi';
        let text = translations[lang]?.[key] || translations['en'][key];
        if (text === undefined) {
            const subject = (data.subjects || []).find(s => s.id === key);
            text = subject ? subject.name : key;
        }
        if(text === undefined) return key;

        Object.keys(replacements).forEach(placeholder => {
            text = text.replace(`{${placeholder}}`, replacements[placeholder]);
        });
        return text;
    };

    const applyTranslations = () => {
        document.querySelectorAll('[data-translate]').forEach(el => el.innerText = _(el.dataset.translate));
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => el.placeholder = _(el.dataset.translatePlaceholder));
        updateAllUI();
    };
    
    // Updated Daily Pattern (Removed :notes suffix)
    const dailyPattern = [
        ["physics", "history", "math", "static-gk"],
        ["chemistry", "history", "math", "संविधान-articles"],
        ["biology", "history", "math", "maths-formulas"],
        ["physics", "history", "math", "static-gk"],
        ["chemistry", "history", "math", "संविधान-articles"],
        ["biology", "history", "math", "maths-formulas"],
        ["math", "reasoning", "fill-form"],
        ["polity", "history", "math", "static-gk"],
        ["hindi", "history", "math", "संविधान-articles"],
        ["geography", "history", "math", "maths-formulas"],
        ["economics", "history", "math", "static-gk"],
        ["polity", "history", "math", "संविधान-articles"],
        ["geography", "history", "math", "maths-formulas"],
        ["economics", "math", "reasoning", "fill-form"]
    ];
let allCharts = {};
    let currentExamFilter = 'all';
    let animationFrameId;

    const pages = document.querySelectorAll('.page');
    const navBtns = document.querySelectorAll('.nav-btn');
    const themeToggleBtns = [document.getElementById('theme-toggle-btn'), document.getElementById('theme-toggle-btn-mobile')];
    const sidebar = document.getElementById('sidebar');
    const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
    const undoToast = document.getElementById('undo-toast');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');

    const particleCanvas = document.getElementById('particle-canvas');
    const ctx = particleCanvas.getContext('2d');
    let backgroundElements = [];

    const init = () => {
        // Init Logic
        safeInitialize(data.settings, 'theme', 'system');
        safeInitialize(data.settings, 'dptDashboardActive', true);

        // SPLASH SCREEN LOGIC
        const splash = document.getElementById('app-splash-screen');
        if(splash) {
            setTimeout(() => {
                splash.style.opacity = '0';
                splash.style.visibility = 'hidden';
                document.body.classList.remove('splash-active');
            }, 3000); // Show for 3 seconds
        }

        handleNewDayLogic();
        applyTheme(data.settings.theme); // Handles System/Light/Dark
        applyManualColors();
        // applyCustomTheme is called inside applyTheme now with correct effective theme
        
        navigateTo('home');
        applyTranslations();
        
        document.body.style.backgroundImage = ''; 
        
        addEventListeners();
        checkAppUpdate();
        lucide.createIcons();

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (data.settings.theme === 'system') {
                applyTheme('system');
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAllBackgroundAnimations(); 
            } else {
                if (data.settings.backgroundStyle === 'constellation') {
                    initConstellationEffect(); 
                }
            }
        });

        if ('Notification' in window && Notification.permission !== 'denied') {
            setTimeout(() => Notification.requestPermission(), 5000); 
        }
        setInterval(checkDateChange, 60000); 
    };

    const checkDateChange = () => {
        const currentDateString = getLocalDateString();
        if (currentDateString !== lastIntervalDateString) {
            lastIntervalDateString = currentDateString;
            handleNewDayLogic();
            if (document.getElementById('page-home').classList.contains('active')) {
                renderHomePage();
            }
        }
    };
    
    const checkAppUpdate = () => {
        const savedVersion = data.settings.appVersion || "1.0";
        if (savedVersion !== CURRENT_APP_VERSION) {
            showAnimatedUpdatePopup(CURRENT_APP_VERSION);
            data.settings.appVersion = CURRENT_APP_VERSION;
            saveData();
        } else {
            // If no update, tour is ready to trigger on click immediately if not shown yet
            window.isUpdatePopupClosed = true;
        }
        renderUpdatesPage();
    };
    
    const showAnimatedUpdatePopup = (currentVersion) => {
        // Get top 10 latest versions
        const versions = Object.keys(updateNotes)
            .sort((a, b) => b.localeCompare(a, undefined, { numeric: true }))
            .slice(0, 10);

        if (versions.length === 0) return;

        const headerEl = document.getElementById('update-popup-header');
        const contentEl = document.getElementById('update-popup-content');
        
        // पॉप-अप हेडर
        headerEl.innerHTML = `<h2 class="text-xl font-bold mb-1 text-white flex items-center justify-center gap-2"><i data-lucide="sparkles" class="text-amber-300"></i> नया अपडेट!</h2>
            <p class="text-xs text-indigo-300">संस्करण: ${currentVersion} | Rayen's Tracker</p>`;
        
        contentEl.innerHTML = '';
        
        // लूप चलाकर 10 अपडेट्स दिखाएं
        let globalDelay = 0;
        
        versions.forEach((ver) => {
            const data = updateNotes[ver];
            const features = Array.isArray(data) ? data : (data?.features || []);
            
            // Version Divider
            const versionHeader = document.createElement('div');
            versionHeader.className = 'mt-4 mb-2 flex items-center gap-2 text-xs font-bold text-indigo-200 uppercase tracking-widest border-b border-indigo-500/30 pb-1';
            versionHeader.innerHTML = `<span>v${ver}</span> <span class="text-[9px] opacity-70">${data.date || ''}</span>`;
            contentEl.appendChild(versionHeader);

            features.forEach((item) => {
                const noteContainer = document.createElement('div');
                noteContainer.className = 'p-3 bg-white/10 rounded-lg update-note-item border border-white/10 mb-2';
                noteContainer.style.animationDelay = `${globalDelay * 50}ms`; // Staggered animation
                
                const titleEl = document.createElement('h4');
                titleEl.className = 'font-bold text-amber-300 flex items-center gap-2 mb-1';
                titleEl.innerHTML = `<i data-lucide="zap" class="w-4 h-4 flex-shrink-0"></i> ${item.title}`;
                
                const noteEl = document.createElement('p');
                noteEl.className = 'ml-6 text-indigo-100 text-xs leading-relaxed';
                noteEl.innerHTML = item.note;
                
                noteContainer.appendChild(titleEl);
                noteContainer.appendChild(noteEl);
                contentEl.appendChild(noteContainer);
                globalDelay++;
            });
        });
        
        showModal('update-popup-modal');
        lucide.createIcons();
    };

    const renderRecentUpdates = () => {
        // यह फंक्शन अब खाली है क्योंकि हम साइडबार बटन का उपयोग कर रहे हैं,
        // लेकिन कोड क्रैश न हो इसलिए इसे खाली रखा है।
    };
    
    const showUndoToast = (message, onUndo) => {
        clearTimeout(undoTimeout);
        document.getElementById('undo-message').textContent = message;
        const undoBtn = document.getElementById('undo-btn');
        const newUndoBtn = undoBtn.cloneNode(true);
        newUndoBtn.textContent = _('undo');
        undoBtn.parentNode.replaceChild(newUndoBtn, undoBtn);
        const undoHandler = () => { onUndo(); hideUndoToast(); };
        newUndoBtn.addEventListener('click', undoHandler, { once: true });
        undoToast.classList.add('show');
        // Updated to 8 seconds as requested
        undoTimeout = setTimeout(hideUndoToast, 8000);
    };

    const hideUndoToast = () => {
        clearTimeout(undoTimeout);
        undoToast.classList.remove('show');
    };

    const handleNewDayLogic = () => {
        const todayStr = getLocalDateString();
        if (data.lastCheckedDate === todayStr) return;

        // Handle repeating "other" tasks (Premium Logic with Days)
        const todayDateObj = new Date(todayStr);
        const currentDayIndex = todayDateObj.getDay(); // 0 = Sun, 1 = Mon...

        (data.otherTasks || []).forEach(task => {
            // Check if repeating AND repeats on today's specific day AND is not excluded for today
            const shouldRepeatToday = task.isRepeating && 
                                      (task.repeatDays && task.repeatDays.includes(currentDayIndex));
            
            // Check if specifically deleted for today
            const isDeletedForToday = task.deletedInstances && task.deletedInstances.includes(todayStr);

            if (shouldRepeatToday && !isDeletedForToday) {
                if (task.lastCompletedDate && task.lastCompletedDate < todayStr) {
                    // Reset if completed previously
                    task.status = 'Pending';
                    task.date = todayStr;
                } else if (task.date < todayStr && task.status === 'Pending') {
                    // Bring forward if missed
                    task.date = todayStr;
                } else if (task.status === 'Completed' && task.completedDate !== todayStr) {
                    // Safety reset
                    task.status = 'Pending';
                    task.date = todayStr;
                }
            }
        });

        const yesterdayDate = new Date();
        yesterdayDate.setDate(yesterdayDate.getDate() - 1);
        const yesterdayStr = data.lastCheckedDate || getLocalDateString(yesterdayDate);
        
        // Handle Missed Chapters (Updated for unified structure)
        const yesterdayPlanData = data.dailyPlan[yesterdayStr];
        if (yesterdayPlanData?.tasks) {
            yesterdayPlanData.completedSubjects = yesterdayPlanData.completedSubjects || [];
            Object.entries(yesterdayPlanData.tasks).forEach(([key, task]) => {
                // Key is just subjectId now
                if (task?.subjectId && task.chapterId && !yesterdayPlanData.completedSubjects.includes(key)) {
                    const chapter = getChapterByIds(task.subjectId, task.chapterId);
                    if (chapter && chapter.status !== 'Completed' && !data.missedChapters.some(c => c.chapterId === task.chapterId)) {
                        // Removed sourceType from missedChapters object
                        data.missedChapters.push({ subjectId: task.subjectId, chapterId: task.chapterId, date: yesterdayStr });
                    }
                }
            });
        }

         // Handle Missed "Other Tasks"
        const missedOtherTasks = (data.otherTasks || []).filter(task => !task.isRepeating && task.date === yesterdayStr && task.status === 'Pending');
        missedOtherTasks.forEach(task => {
            if (!data.missedOtherTasks.some(missed => missed.id === task.id)) {
                data.missedOtherTasks.push(task);
            }
        });

        // Handle Missed Revisions from yesterday (Updated for unified structure)
        data.missedRevisions = data.missedRevisions || [];
        (data.subjects || []).forEach(s => {
            (s.chapters || []).forEach(c => (c.revisions || []).forEach(r => { 
                if(r.status === 'Pending' && r.date === yesterdayStr) {
                     if (!data.missedRevisions.some(mr => mr.chapterId === c.id && mr.revisionDate === r.date)) {
                        // Removed sourceType
                        data.missedRevisions.push({ subjectId: s.id, chapterId: c.id, revisionDate: r.date });
                     }
                }
            }));
        });

        // Handle Missed DPTs
        const yesterdayDptPlan = data.dailyDptPlan[yesterdayStr];
        if (yesterdayDptPlan) {
            yesterdayDptPlan.forEach(({ subjectId, chapterId, testId }) => {
                const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId);
                if (test && test.status !== 'Completed') {
                    // Logic handled on dashboard
                }
            });
        }

        data.lastCheckedDate = todayStr;
        Object.keys(data.dailyPlan).forEach(date => { if (new Date(todayStr) - new Date(date) > 7 * 24 * 60 * 60 * 1000) { delete data.dailyPlan[date]; } });
        Object.keys(data.dailyDptPlan).forEach(date => { if (new Date(todayStr) - new Date(date) > 7 * 24 * 60 * 60 * 1000) { delete data.dailyDptPlan[date]; } });
        
        if (data.dailyPlan[yesterdayStr]) {
            delete data.dailyPlan[yesterdayStr].completedTasks;
        }

        saveData();
    };

    const updateAllUI = () => {
        const activePageId = document.querySelector('.page.active')?.id.replace('page-', '');
        const pageRenderFunctions = {
            home: renderHomePage, subjects: renderSubjectsPage, dpt: renderDptPage,
            analytics: renderAnalyticsPage, settings: renderSettingsPage, calendar: renderCalendarPage,
            report: renderReportPage, 'import-export': renderImportExportPage,
            exams: renderExamsPage, url: renderUrlPage, updates: renderUpdatesPage,
            notices: renderNoticesPage // New Page
        };
        if(activePageId && pageRenderFunctions[activePageId]) {
             pageRenderFunctions[activePageId]();
        } else {
            renderHomePage();
        }
    };

    // --- NOTICE / NOTES PAGE LOGIC (FIXED: Clean History & Delete) ---
    const renderNoticesPage = () => {
        // Force initialization
        data.personalNotes = data.personalNotes || [];
        data.otherTasks = data.otherTasks || [];
        data.otherTaskHistory = data.otherTaskHistory || [];

        // 1. Render Personal Notes (Left Column - Top)
        const notesContainer = document.getElementById('personal-notes-list');
        if (notesContainer) {
            if (data.personalNotes.length === 0) {
                notesContainer.innerHTML = `<p class="text-center text-sm text-gray-400 py-4">No personal notes added yet.</p>`;
            } else {
                notesContainer.innerHTML = data.personalNotes.sort((a,b) => new Date(b.date) - new Date(a.date)).map((note, index) => `
                    <div class="p-3 bg-white dark:bg-gray-800 rounded-lg border-l-4 border-indigo-500 shadow-sm relative group animate-fadeIn">
                        <p class="text-xs font-bold text-indigo-500 mb-1">${new Date(note.date).toLocaleString()}</p>
                        <p class="text-sm whitespace-pre-wrap text-gray-800 dark:text-gray-200">${note.text}</p>
                        <button class="delete-personal-note-btn absolute top-2 right-2 text-red-400 hover:text-red-600 p-1 bg-white dark:bg-gray-700 rounded-full" data-index="${index}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
            }
        }

        const todayStr = getLocalDateString();
        const allPendingTasks = (data.otherTasks || []).filter(t => t.status === 'Pending');

        // --- 2. Render Future Tasks (Left Column - Bottom) ---
        const futureContainer = document.getElementById('future-tasks-list');
        if (futureContainer) {
            // Show ALL pending tasks that are in future OR today but not completed
            // Actually, user wants Future Queue. 
            const futureTasks = allPendingTasks
                .filter(t => t.date > todayStr)
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            if (futureTasks.length === 0) {
                futureContainer.innerHTML = `<div class="text-center py-6 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg"><p class="text-xs text-gray-400">No upcoming tasks scheduled.</p></div>`;
            } else {
                futureContainer.innerHTML = futureTasks.map(t => {
                    const tagBadge = t.tag ? `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 ml-1 border border-purple-200 dark:border-purple-800">${t.tag}</span>` : '';
                    return `
                    <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm border-l-4 border-purple-500 group hover:translate-x-1 transition-all animate-fadeIn">
                        <div>
                            <p class="text-sm font-bold text-gray-800 dark:text-gray-200 flex items-center">${t.description} ${tagBadge}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] font-bold text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/30 px-2 py-0.5 rounded flex items-center gap-1">
                                    <i data-lucide="calendar" class="w-3 h-3"></i> ${new Date(t.date).toLocaleDateString()}
                                </span>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button class="edit-other-task-btn p-1.5 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/20 text-gray-400 hover:text-blue-500 transition-colors" data-task-id="${t.id}" title="Edit">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-other-task-btn p-1.5 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500 transition-colors" data-task-id="${t.id}" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // --- 3. Render ONLY History (Right Column) - REMOVED TODAY/OVERDUE ---
        const historyContainer = document.getElementById('other-tasks-history-list');
        if (historyContainer) {
            // Sort History: Newest First
            const sortedHistory = [...data.otherTaskHistory]
                .sort((a,b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0))
                .slice(0, 30); // Limit to 30

            let historyHtml = '';
            if (sortedHistory.length > 0) {
                historyHtml = sortedHistory.map(h => {
                    const isCompleted = h.status === 'Completed';
                    const statusColor = isCompleted ? 'text-green-500' : 'text-red-400';
                    const icon = isCompleted ? 'check-circle-2' : 'trash-2';
                    const timeString = h.timestamp ? new Date(h.timestamp).toLocaleDateString() : '';
                    return `
                    <div class="flex items-center gap-3 p-2 text-xs border-b border-gray-100 dark:border-gray-800 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors rounded animate-fadeIn">
                        <i data-lucide="${icon}" class="w-4 h-4 ${statusColor}"></i>
                        <span class="${isCompleted ? 'text-gray-600 dark:text-gray-400' : 'text-gray-400 line-through'} flex-grow">${h.description}</span>
                        <span class="text-[9px] text-gray-400 font-mono whitespace-nowrap ml-2">${timeString}</span>
                    </div>`;
                }).join('');
            } else {
                historyHtml = `<div class="flex flex-col items-center justify-center py-10 opacity-50"><i data-lucide="history" class="w-8 h-8 mb-2"></i><p class="text-xs">No completed or deleted tasks in last 30 days.</p></div>`;
            }

            historyContainer.innerHTML = historyHtml;
        }
        lucide.createIcons();
    };

    // Add Note Modal Logic
    const showAddNotePopup = () => {
        const modalHtml = `
            <div id="add-note-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-xl p-6 shadow-2xl border border-indigo-500/30 transform scale-100 transition-all">
                    <h3 class="text-lg font-bold mb-4">Add Personal Note</h3>
                    <textarea id="new-personal-note-text" rows="4" class="w-full p-3 bg-gray-100 dark:bg-gray-800 rounded-lg border focus:border-indigo-500 outline-none resize-none" placeholder="Write something..."></textarea>
                    <div class="flex gap-3 mt-4">
                        <button id="cancel-note-btn" class="flex-1 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 font-bold">Cancel</button>
                        <button id="save-note-btn" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700">Save</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        document.getElementById('cancel-note-btn').onclick = () => document.getElementById('add-note-modal').remove();
        document.getElementById('save-note-btn').onclick = () => {
            const text = document.getElementById('new-personal-note-text').value.trim();
            if(text) {
                if(!data.personalNotes) data.personalNotes = [];
                data.personalNotes.push({ text, date: new Date().toISOString() });
                saveData();
                renderNoticesPage();
                document.getElementById('add-note-modal').remove();
            }
        };
    };
    
    // Optimized Creator Modal (No Lag)
    window.openCreatorModal = () => {
        const bioModal = document.querySelector('#creator-bio-modal > div');
        
        // Reset & Apply Fast Styles (No Backdrop Filter)
        bioModal.className = "w-full max-w-2xl rounded-2xl shadow-2xl relative overflow-hidden flex flex-col max-h-[90vh] bg-white dark:bg-slate-900 border border-gray-200 dark:border-gray-700 transform translate-z-0";
        
        // Remove heavy inline styles
        bioModal.style = "";

        // 2. Custom Content Structure with Advanced Profile Design
        const htmlContent = `
            <!-- FIX: CLOSE BUTTON MOVED TO TOP LEVEL WITH HIGH Z-INDEX -->
            <button id="close-creator-bio-modal-btn" class="absolute top-4 right-4 w-10 h-10 rounded-full flex items-center justify-center bg-black/60 hover:bg-red-500 hover:text-white text-white transition-all duration-300 backdrop-blur-md border border-white/40 z-[60] shadow-xl cursor-pointer pointer-events-auto">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <!-- Shining Effect Overlay -->
            <div class="absolute inset-0 pointer-events-none z-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -skew-x-12 animate-[shine-slow_8s_infinite]"></div>

            <!-- 1. HEADER BACKGROUND PROFILE (FIX: Increased Height) -->
            <div class="relative w-full h-72 bg-cover bg-center overflow-hidden z-10" style="background-image: url('https://img.freepik.com/free-vector/technology-background-with-hud-elements_23-2148116524.jpg');">
                <div class="absolute inset-0 bg-gradient-to-b from-transparent to-white/90 dark:to-[#1e293b]"></div>
            </div>

            <!-- 2. FRONT PROFILE PICTURE (Shifted Down) -->
            <div class="relative -mt-20 flex flex-col items-center z-20 px-6">
                <!-- Profile Ring Container with Glow -->
                <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-cyan-400 to-blue-600 rounded-full blur opacity-40 group-hover:opacity-75 transition duration-500"></div>
                    <div class="w-28 h-28 rounded-full border-[4px] border-white dark:border-[#1e293b] shadow-2xl overflow-hidden bg-[#001f3f] relative z-10">
                        <img src="https://img.freepik.com/free-psd/3d-illustration-person-with-sunglasses_23-2149436188.jpg" alt="Rayen Profile" class="w-full h-full object-cover transform transition-transform duration-500 group-hover:scale-110">
                    </div>
                    <div class="absolute bottom-2 right-2 w-5 h-5 bg-green-500 border-4 border-white dark:border-[#1e293b] rounded-full z-20" title="Online"></div>
                </div>
                
                <div class="text-center mt-4">
                    <h2 class="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-cyan-600 to-blue-600 dark:from-cyan-400 dark:to-blue-400 tracking-tight drop-shadow-sm">Rayen</h2>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <span class="px-3 py-1 rounded-full bg-blue-50 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 text-[10px] font-bold border border-blue-200 dark:border-blue-800 uppercase tracking-widest shadow-sm">Visionary & Developer</span>
                    </div>
                </div>
            </div>

            <!-- 3. SCROLLABLE CONTENT (Added Padding Top) -->
            <div class="flex-grow overflow-y-auto custom-scrollbar px-6 pb-8 pt-6 z-20 relative">
                <div class="space-y-8">
                    
                    <!-- Creator Bio Section -->
                    <div class="relative p-5 bg-white/60 dark:bg-black/20 rounded-2xl border border-blue-100 dark:border-blue-900/30 shadow-sm backdrop-blur-sm group hover:border-blue-300 transition-colors">
                        <div class="absolute -left-1 top-5 bottom-5 w-1 bg-gradient-to-b from-blue-400 to-cyan-400 rounded-r"></div>
                        <p class="font-bold text-lg text-slate-800 dark:text-slate-200 mb-3 font-serif italic">"नमस्ते! मैं रायन (Rayen) हूँ।"</p>
                        <p class="text-sm font-medium leading-relaxed text-slate-600 dark:text-slate-400 text-justify">
                            मैं कोई प्रोफेशनल सॉफ्टवेयर या ऐप डेवलपर नहीं हूँ, बल्कि एक कॉम्पिटिटिव एग्ज़ाम की तैयारी करने वाला स्टूडेंट हूँ।
                            <br><br>
                            मैं अपने खाली समय में AI और टेक्नोलॉजी के साथ एक्सपेरिमेंट करना पसंद करता हूँ, ठीक उसी तरह जैसे लोग क्रिकेट, फुटबॉल या मूवीज़ को टाइमपास के लिए चुनते हैं।
                            <br><br>
                            यह एप्लिकेशन मैंने किसी बिज़नेस या कमर्शियल उद्देश्य से नहीं बनाया है। मैंने इसे पूरी तरह से <strong>AI की मदद से</strong> बनाया है, ताकि मैं अपनी स्टडी को ट्रैक कर सकूँ और अपनी पढ़ाई को बेहतर और ज़्यादा डिसिप्लिन में मैनेज कर सकूँ।
                        </p>
                    </div>

                    <!-- About Application Section -->
                    <div>
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-gradient-to-br from-amber-400 to-orange-500 rounded-lg shadow-lg shadow-orange-500/20">
                                <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white">Most Powerful Features</h3>
                        </div>
                        
                        <p class="text-sm text-slate-600 dark:text-slate-400 mb-6 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-200 dark:border-slate-700">
                            <strong>Study Tracker</strong> एक स्मार्ट स्टडी मैनेजमेंट एप्लिकेशन है, जो आपकी रोज़ की पढ़ाई को ऑटोमैटिक और स्ट्रक्चर्ड तरीके से प्लान करता है।
                        </p>

                        <!-- Features Grid -->
                        <div class="grid grid-cols-1 gap-3">
                            <div class="flex items-start gap-3 p-3 bg-blue-50/50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-800/30">
                                <div class="bg-blue-100 dark:bg-blue-800 p-2 rounded-lg shrink-0"><i data-lucide="check-circle-2" class="w-4 h-4 text-blue-600 dark:text-blue-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">1. Today's Task Complete</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">डैशबोर्ड पर आए किसी भी चैप्टर को बुक से पढ़कर वहीं टिक करें। वह सीधे कंप्लीट लिस्ट में चला जाएगा।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-amber-50/50 dark:bg-amber-900/10 rounded-xl border border-amber-100 dark:border-amber-800/30">
                                <div class="bg-amber-100 dark:bg-amber-800 p-2 rounded-lg shrink-0"><i data-lucide="clock" class="w-4 h-4 text-amber-600 dark:text-amber-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">2. Smart Postpone</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">अगर चैप्टर अधूरा पढ़ा है, तो 'Postpone' दबाएं और पेज नंबर नोट करें। अगली बार वह वहीं से दिखेगा।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-purple-50/50 dark:bg-purple-900/10 rounded-xl border border-purple-100 dark:border-purple-800/30">
                                <div class="bg-purple-100 dark:bg-purple-800 p-2 rounded-lg shrink-0"><i data-lucide="skip-forward" class="w-4 h-4 text-purple-600 dark:text-purple-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">3. Skip & Swap</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">कोई चैप्टर पढ़ने का मन नहीं? 'Skip' बटन दबाएं और उसकी जगह दूसरा चैप्टर चुनें।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-red-50/50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-800/30">
                                <div class="bg-red-100 dark:bg-red-800 p-2 rounded-lg shrink-0"><i data-lucide="timer" class="w-4 h-4 text-red-600 dark:text-red-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">4. Exam Countdown</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">बस फॉर्म भरने की डेट और एग्जाम डेट डालें। डैशबोर्ड पर दिनों की उल्टी गिनती (Countdown) शुरू हो जाएगी।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-indigo-50/50 dark:bg-indigo-900/10 rounded-xl border border-indigo-100 dark:border-indigo-800/30">
                                <div class="bg-indigo-100 dark:bg-indigo-800 p-2 rounded-lg shrink-0"><i data-lucide="trophy" class="w-4 h-4 text-indigo-600 dark:text-indigo-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">5. Gamification Mode</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">पढ़ाई को गेम बनाएं! चैप्टर पूरे करने पर लेवल बढ़ेंगे और नई अचीवमेंट्स अनलॉक होंगी।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-emerald-50/50 dark:bg-emerald-900/10 rounded-xl border border-emerald-100 dark:border-emerald-800/30">
                                <div class="bg-emerald-100 dark:bg-emerald-800 p-2 rounded-lg shrink-0"><i data-lucide="repeat" class="w-4 h-4 text-emerald-600 dark:text-emerald-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">6. Auto Revision Cycle</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">कोई चैप्टर आज पढ़ा? वह अपने आप 8वें और 16वें दिन रिविज़न के लिए डैशबोर्ड पर आ जाएगा।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-cyan-50/50 dark:bg-cyan-900/10 rounded-xl border border-cyan-100 dark:border-cyan-800/30">
                                <div class="bg-cyan-100 dark:bg-cyan-800 p-2 rounded-lg shrink-0"><i data-lucide="plus-square" class="w-4 h-4 text-cyan-600 dark:text-cyan-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">7. Manual Tasks</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">प्लस (+) आइकॉन से खुद के टास्क जोड़ें। जैसे: "21 तारीख को एग्जाम है" या "पेन खरीदना है"।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-pink-50/50 dark:bg-pink-900/10 rounded-xl border border-pink-100 dark:border-pink-800/30">
                                <div class="bg-pink-100 dark:bg-pink-800 p-2 rounded-lg shrink-0"><i data-lucide="pie-chart" class="w-4 h-4 text-pink-600 dark:text-pink-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">8. DPT Score & Graphs</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">टेस्ट स्कोर दर्ज करें। रंगीन ग्राफ और पाई चार्ट से जानें कौन सा विषय कमजोर है और कौन सा मजबूत।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-orange-50/50 dark:bg-orange-900/10 rounded-xl border border-orange-100 dark:border-orange-800/30">
                                <div class="bg-orange-100 dark:bg-orange-800 p-2 rounded-lg shrink-0"><i data-lucide="zap" class="w-4 h-4 text-orange-600 dark:text-orange-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">9. Auto DPT Unlock</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">चैप्टर पूरा होते ही उसका DPT (टेस्ट) अपने आप जुड़ जाएगा। AI आपकी प्रोग्रेस रिकॉर्ड करेगा।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-slate-100 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                                <div class="bg-white dark:bg-slate-900 p-2 rounded-lg shrink-0"><i data-lucide="link" class="w-4 h-4 text-slate-600 dark:text-slate-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">10. URL Manager</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">अपने जरूरी YouTube लिंक या नोट्स के लिंक को फोल्डर बनाकर व्यवस्थित रखें।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-violet-50/50 dark:bg-violet-900/10 rounded-xl border border-violet-100 dark:border-violet-800/30">
                                <div class="bg-violet-100 dark:bg-violet-800 p-2 rounded-lg shrink-0"><i data-lucide="train" class="w-4 h-4 text-violet-600 dark:text-violet-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">11. Dual Routines</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">'Railway' और 'Foundation' रूटीन में से कोई भी चुनें। एक क्लिक में पूरा शेड्यूल बदल जाएगा।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-teal-50/50 dark:bg-teal-900/10 rounded-xl border border-teal-100 dark:border-teal-800/30">
                                <div class="bg-teal-100 dark:bg-teal-800 p-2 rounded-lg shrink-0"><i data-lucide="save" class="w-4 h-4 text-teal-600 dark:text-teal-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">12. Full Backup & Restore</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">ऐप डिलीट करने से पहले बैकअप लें। दोबारा इंस्टॉल करने पर एक क्लिक में सारा डेटा वापस आ जाएगा।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-rose-50/50 dark:bg-rose-900/10 rounded-xl border border-rose-100 dark:border-rose-800/30">
                                <div class="bg-rose-100 dark:bg-rose-800 p-2 rounded-lg shrink-0"><i data-lucide="bar-chart-3" class="w-4 h-4 text-rose-600 dark:text-rose-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">13. Deep Analytics</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">रिपोर्ट सेक्शन में हर सब्जेक्ट, चैप्टर और टेस्ट की गहराई से जांच करें और प्रोग्रेस देखें।</p></div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-lime-50/50 dark:bg-lime-900/10 rounded-xl border border-lime-100 dark:border-lime-800/30">
                                <div class="bg-lime-100 dark:bg-lime-800 p-2 rounded-lg shrink-0"><i data-lucide="plus-circle" class="w-4 h-4 text-lime-600 dark:text-lime-300"></i></div>
                                <div><h4 class="font-bold text-sm text-slate-800 dark:text-slate-200">14. Advanced Routine (Extra)</h4><p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">सेटिंग्स में जाकर अपनी मर्जी से कोई भी एक्स्ट्रा सब्जेक्ट या टास्क अपने डेली रूटीन में जोड़ें।</p></div>
                            </div>
                        </div>

                        <p class="text-xs font-bold italic text-center text-slate-500 dark:text-slate-400 mt-8 mb-2 px-4 border-t border-slate-200 dark:border-slate-700 pt-6">
                            "कुल मिलाकर, Study Tracker आपकी पढ़ाई को याददाश्त या मूड पर नहीं, बल्कि एक सिस्टम और डेटा-ड्रिवन अप्रोच पर चलाने में मदद करता है।"
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="p-3 bg-slate-50 dark:bg-[#0c1425] border-t border-slate-200 dark:border-slate-800 text-center z-20">
                <p class="text-xs font-black bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500 animate-pulse">Designed with ❤️ by Rayen</p>
            </div>
        `;
        
        // Inject content
        bioModal.innerHTML = htmlContent;
        
        // Re-attach close listener manually
        document.getElementById('close-creator-bio-modal-btn').addEventListener('click', () => {
            hideModal('creator-bio-modal');
        });
        
        showModal('creator-bio-modal');
        lucide.createIcons();
    };

    const renderUpdatesPage = () => {
        const container = document.getElementById('updates-content-list');
        
        let html = `
        <div class="mb-10 flex justify-center animate-fadeIn">
            <button id="open-creator-profile-btn" class="group relative inline-flex items-center justify-center px-8 py-3 font-bold text-white transition-all duration-200 bg-gray-900 font-lg rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900">
                <div class="absolute inset-0 w-full h-full -mt-1 rounded-full opacity-30 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 blur-lg group-hover:opacity-100 transition-opacity duration-200 animate-pulse"></div>
                <span class="relative flex items-center gap-2">
                    <i data-lucide="crown" class="w-5 h-5 text-amber-400"></i>
                    Meet the Creator
                </span>
            </button>
        </div>
        `;

        // Logic: Sort descending and take top 10 (Latest)
        const versions = Object.keys(updateNotes)
            .sort((a, b) => b.localeCompare(a, undefined, { numeric: true }))
            .slice(0, 10); // LIMIT TO 10
        
        if (versions.length === 0) {
            html += `<div class="text-center text-gray-500 mt-10"><p>No recent updates in the last 30 days.</p></div>`;
        } else {
            html += versions.map((version, index) => {
                const data = updateNotes[version];
                const features = Array.isArray(data) ? data : (data?.features || []);
                const date = data.date ? new Date(data.date).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Recently';
                
                const featuresHtml = features.map(feat => `
                    <li class="mb-6 ml-6 relative group">
                        <span class="absolute flex items-center justify-center w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full -left-10 ring-4 ring-white dark:ring-[#0c1425] shadow-lg shadow-purple-500/30">
                            <i data-lucide="zap" class="w-4 h-4 text-white"></i>
                        </span>
                        <div class="p-4 bg-white/50 dark:bg-gray-800/50 rounded-xl border border-gray-100 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-700 transition-all hover:shadow-md">
                            <h3 class="flex items-center text-lg font-bold text-gray-900 dark:text-white mb-1">
                                ${feat.title}
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">${feat.note}</p>
                        </div>
                    </li>
                `).join('');

                return `
                    <div class="relative pl-4 md:pl-0 mb-12 animate-fadeIn" style="animation-delay: ${index * 100}ms">
                        <div class="flex items-center mb-6 md:-ml-3">
                             <div class="hidden md:flex items-center justify-center w-6 h-6 rounded-full bg-indigo-900/20 ring-4 ring-indigo-50 dark:ring-indigo-900/20 mr-4">
                                <div class="w-2 h-2 rounded-full bg-indigo-500"></div>
                             </div>
                             <div>
                                <span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2.5 py-0.5 rounded border border-indigo-200 dark:bg-indigo-900 dark:text-indigo-300 dark:border-indigo-700">v${version}</span>
                                <span class="text-sm text-gray-400 dark:text-gray-500 ml-2 font-medium">• ${date} • Rayen</span>
                             </div>
                        </div>
                        <ol class="relative border-l-2 border-indigo-100 dark:border-indigo-900/50 md:ml-3 space-y-2">                  
                            ${featuresHtml}
                        </ol>
                    </div>
                `;
            }).join('');
        }
        
        container.innerHTML = html;
        lucide.createIcons();
        
        // Bind listener for the "Meet Creator" button using the new global function
        document.getElementById('open-creator-profile-btn')?.addEventListener('click', window.openCreatorModal);
    };
    
    const applyTheme = (theme) => {
        // System Theme Logic
        let effectiveTheme = theme;
        if (theme === 'system') {
            effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        document.documentElement.className = effectiveTheme;
        
        // Icons Update Logic (3-way) - Fixed for Mobile
        const sunIcons = ['theme-icon-sun', 'theme-icon-sun-mobile'];
        const moonIcons = ['theme-icon-moon', 'theme-icon-moon-mobile'];
        const sysIcons = ['theme-icon-system', 'theme-icon-system-mobile']; 

        // Reset all (Hide everything first)
        [...sunIcons, ...moonIcons, ...sysIcons].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('hidden');
                el.style.display = ''; // Clear inline styles if any
            }
        });

        // Show relevant icon set based on CURRENT setting (not effective theme)
        if (theme === 'light') {
            sunIcons.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
        } else if (theme === 'dark') {
            moonIcons.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
        } else {
            // For System Default
            sysIcons.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
        }

        // Text label update (Sidebar)
        const label = document.getElementById('theme-text-sidebar');
        if(label) label.textContent = theme === 'system' ? 'Auto' : theme;

        applyCustomTheme(effectiveTheme);
        applyBackgroundStyle();
        if (document.getElementById('page-analytics').classList.contains('active')) renderAnalyticsPage();
    };
    
    const applyManualColors = () => {
        const root = document.documentElement;
        const colors = data.settings.customThemeColors;
        const mapping = {
            textLight: '--text-light', borderLight: '--border-light',
            textDark: '--text-dark', borderDark: '--border-dark'
        };
        for (const [key, variable] of Object.entries(mapping)) {
            if (colors[key]) {
                root.style.setProperty(variable, colors[key]);
            } else {
                root.style.removeProperty(variable);
            }
        }
    };
    
    const applyCustomTheme = (currentEffectiveTheme) => {
        const { start, end } = data.settings.customThemeColors;
        const root = document.documentElement;
        // Determine isDark based on what is currently applied to DOM
        const isDark = currentEffectiveTheme === 'dark'; 
        
        const startProp = isDark ? '--main-bg-start-dark' : '--main-bg-start-light';
        const endProp = isDark ? '--main-bg-end-dark' : '--main-bg-end-light';
        if (start && end) {
            root.style.setProperty(startProp, start);
            root.style.setProperty(endProp, end);
        } else {
            root.style.removeProperty(startProp);
            root.style.removeProperty(endProp);
        }
    };

    const toggleTheme = () => {
        const current = data.settings.theme;
        let next = 'light';
        if (current === 'light') next = 'dark';
        else if (current === 'dark') next = 'system';
        else next = 'light';
        
        data.settings.theme = next;
        saveData();
        applyTheme(next);
    };
    
    const toggleSidebar = () => {
        sidebar.classList.toggle('w-64');
        sidebar.classList.toggle('w-20');
        sidebar.classList.toggle('sidebar-collapsed');
        sidebarToggleBtn.querySelector('i').setAttribute('data-lucide', sidebar.classList.contains('sidebar-collapsed') ? 'chevrons-right' : 'chevrons-left');
        lucide.createIcons();
    };

    const updateNavHighlight = (pageId) => {
        navBtns.forEach(b => { b.classList.toggle('text-primary', b.dataset.page === pageId); b.classList.toggle('bg-sky-100', b.dataset.page === pageId); b.classList.toggle('dark:bg-sky-900/50', b.dataset.page === pageId); });
        document.querySelectorAll('.mobile-nav-btn').forEach(b => { b.classList.toggle('active', b.dataset.page === pageId); });
    };
    
    const navigateTo = (pageId) => {
        Object.values(dynamicDisplayIntervals).forEach(clearInterval);
        dynamicDisplayIntervals = {};

        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageId}`)?.classList.add('active');
        updateNavHighlight(pageId);
        const renderFunctions = {
            home: renderHomePage, subjects: renderSubjectsPage, dpt: renderDptPage, calendar: renderCalendarPage,
            settings: renderSettingsPage, report: renderReportPage,
            'import-export': renderImportExportPage,
            exams: renderExamsPage,
            url: renderUrlPage,
            notices: renderNoticesPage, // ✅ Fixed: Added Notices Page Render Logic
            analytics: () => requestAnimationFrame(renderAnalyticsPage)
        };
        renderFunctions[pageId]?.();
    };
    
    const getWeekNumber = (d) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    const getCycleDayIndex = (date) => {
        const dayOfWeek = date.getDay(); 
        const weekNumber = getWeekNumber(date);
        const isSecondWeekOfCycle = weekNumber % 2 === 0;
        return dayOfWeek + (isSecondWeekOfCycle ? 7 : 0);
    };

    const getSubjectById = (id) => (data.subjects || []).find(s => s.id === id);
    
    // UPDATED: No longer uses sourceType, searches the unified chapters array
    const getChapterByIds = (subjectId, chapterId) => {
        const subject = getSubjectById(subjectId);
        if (!subject || !chapterId) return null;
        return (subject.chapters || []).find(c => c.id === chapterId) || null;
    };

    const logActivity = (icon, description) => {
        data.activityLog.unshift({ timestamp: new Date().toISOString(), icon, description });
        if (data.activityLog.length > 100) data.activityLog.pop();
        saveData();
        if (document.getElementById('page-report')?.classList.contains('active')) renderReportPage();
    };
    const renderHomePage = () => {
        try {
            handleNewDayLogic();
            const todayDateDisplay = new Date().toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
            
            document.getElementById('welcome-heading').innerHTML = `
                <div class="flex flex-col">
                    <span>${_('welcome_pravej')}, <span class="text-primary">${data.settings.studentName || 'Student'}!</span></span>
                    <span class="text-xs font-medium text-gray-500 dark:text-gray-400 mt-1 uppercase tracking-wide border-l-2 border-primary pl-2">${todayDateDisplay}</span>
                </div>`;
            
            const studyDay = Math.floor((new Date() - new Date(data.appStartDate)) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('study-day-text').textContent = `Day ${studyDay}`;

            Object.values(dynamicDisplayIntervals).forEach(clearInterval);
            dynamicDisplayIntervals = {};
            
            getOrGenerateDailyPlan(getLocalDateString());
            getOrGenerateDailyDptPlan(getLocalDateString());

            try { renderAIInsights(); } catch (e) { console.error("AI Insights Error:", e); }
            try { renderTodaysPlan(); } catch (e) { console.error("Todays Plan Error:", e); }
            try { renderTodaysDpt(); } catch (e) { console.error("Todays DPT Error:", e); }
            try { renderTomorrowsPlan(); } catch (e) { console.error("Tomorrows Plan Error:", e); }
            try { renderYesterdaysActivity(); } catch (e) { console.error("Yesterdays Activity Error:", e); }
            try { renderMissedChapters(); } catch (e) { console.error("Missed Chapters Error:", e); }
            try { renderMissedOtherTasks(); } catch (e) { console.error("Missed Other Tasks Error:", e); }
            try { renderMissedRevisions(); } catch (e) { console.error("Missed Revisions Error:", e); }
            try { renderUpcomingExamsOnDashboard(); } catch (e) { console.error("Upcoming Exams Error:", e); }
            try { renderOverallProgress(); } catch (e) { console.error("Overall Progress Error:", e); }
            try { renderUpcomingRevisions(); } catch (e) { console.error("Upcoming Revisions Error:", e); }
            try { renderBadges(); } catch (e) { console.error("Badges Error:", e); }
            try { renderSubjectWiseProgressDashboard(); } catch (e) { console.error("Subject Progress Error:", e); }
            try { renderDashboardExamList(); } catch (e) { console.error("Dashboard Exam List Error:", e); }
            try { renderRecentUpdates(); } catch (e) { console.error("Recent Updates Error:", e); }
            
            lucide.createIcons();
        } catch (error) {
            console.error("Critical error in renderHomePage:", error);
        }
    };
    
    const initRotatingDisplay = (containerId, items, renderFunction, emptyMessage) => {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (dynamicDisplayIntervals[containerId]) {
            clearInterval(dynamicDisplayIntervals[containerId]);
        }

        if (items.length === 0) {
            container.innerHTML = `<p class="text-sm text-center text-text-muted-light dark:text-text-muted-dark p-4">${emptyMessage}</p>`;
            return;
        }

        let currentIndex = 0;
        const displayNextItem = () => {
            const item = items[currentIndex];
            container.innerHTML = `<div class="dynamic-content-item">${renderFunction(item)}</div>`;
            
            setTimeout(() => {
                const dynamicItem = container.querySelector('.dynamic-content-item');
                if(dynamicItem) dynamicItem.classList.add('active');
            }, 50);

            currentIndex = (currentIndex + 1) % items.length;
            lucide.createIcons();
        };

        displayNextItem();
        if (items.length > 1) {
            dynamicDisplayIntervals[containerId] = setInterval(displayNextItem, 5000);
        }
    };

    const motivationalQuotes = [
        "सफलता अंतिम नहीं है, असफलता घातक नहीं है: यह जारी रखने का साहस है जो मायने रखता है। 💪",
        "आपका भविष्य आपके आज के कार्यों से बनता है, कल के नहीं। 🌅",
        "सफलता की राह में कड़ी मेहनत का कोई विकल्प नहीं है। 🛠️",
        "हर सुबह एक नई शुरुआत है, इसे बेहतरीन बनाएं। ☀️",
        "सपने वो नहीं जो आप सोते समय देखते हैं, सपने वो हैं जो आपको सोने नहीं देते। 🦉",
        "जीतने वाले अलग चीजें नहीं करते, वे चीजों को अलग तरह से करते हैं। 🏆",
        "खुद पर विश्वास करो और तुम अजेय हो जाओगे। 🦁",
        "कड़ी मेहनत प्रतिभा को हरा देती है जब प्रतिभा कड़ी मेहनत नहीं करती। 🏃‍♂️",
        "एकमात्र सीमा आपकी कल्पना है। ✨",
        "आज का दर्द कल की ताकत है। 🏋️",
        "सफलता छोटे-छोटे प्रयासों का योग है, जो दिन-प्रतिदिन दोहराए जाते हैं। 📈",
        "एक लक्ष्य निर्धारित करें जो आपको सुबह बिस्तर से बाहर कूदने पर मजबूर कर दे। ☀️",
        "आप जितना सोचते हैं, उससे कहीं ज्यादा बहादुर हैं। 🦸",
        "ज्ञान में निवेश सर्वोत्तम ब्याज देता है। 📚",
        "अपने जुनून को अपने उद्देश्य में बदलो। ❤️‍🔥",
        "आगे बढ़ने का रहस्य शुरुआत करना है। 🚀",
        "यह हमेशा असंभव लगता है जब तक कि यह पूरा न हो जाए। ✅",
        "यदि आप महान चीजें नहीं कर सकते, तो छोटी चीजों को महान तरीके से करें। 🐜",
        "आपकी शिक्षा आपके भविष्य का पासपोर्ट है। ✈️",
        "कभी भी सीखना बंद न करें, क्योंकि जीवन कभी भी सिखाना बंद नहीं करता। 🎓",
        "एक किताब एक सपना है जिसे आप अपने हाथ में पकड़ते हैं। 📖",
        "चुनौतियां ही जीवन को रोचक बनाती हैं। 🧗",
        "अनुशासन लक्ष्यों और उपलब्धि के बीच का पुल है। 🌉",
        "अपने आराम क्षेत्र से बाहर निकलें। आप केवल वहीं बढ़ सकते हैं। 🌱",
        "यह आपके जीवन के वर्ष नहीं हैं जो मायने रखते हैं। यह आपके वर्षों का जीवन है। 🌟",
        "एक सकारात्मक मानसिकता सकारात्मक परिणाम लाती है। 😊",
        "अपने लक्ष्यों को ऊँचा रखें और जब तक आप वहाँ न पहुँच जाएँ तब तक रुकें नहीं। 🎯",
        "हर विशेषज्ञ कभी एक शुरुआत करने वाला था। 👶",
        "अध्ययन दर्दनाक नहीं है। दर्दनाक क्या है अज्ञानता का दर्द। 🧠",
        "सफलता खुशी की कुंजी नहीं है। खुशी सफलता की कुंजी है। 🔑",
        "जो आप जानते हैं उसे तब तक न कहें जब तक आप यह न जान लें कि आप क्या जानते हैं। 🤔",
        "एकमात्र ज्ञान यह जानना है कि आप कुछ नहीं जानते। 🤯",
        "सीखने के लिए एक जुनून पैदा करें। यदि आप ऐसा करते हैं, तो आप कभी भी बढ़ना बंद नहीं करेंगे। 🌳",
        "आपकी गति से कोई फर्क नहीं पड़ता जब तक आप रुकते नहीं हैं। 🐢",
        "आज एक पाठक, कल एक नेता। 👑",
        "शिक्षा सबसे शक्तिशाली हथियार है जिसका उपयोग आप दुनिया को बदलने के लिए कर सकते हैं। 🌍",
        "सीखना एक खजाना है जो अपने मालिक का हर जगह अनुसरण करेगा। 💼",
        "एक निवेश के रूप में अपनी शिक्षा के बारे में सोचें। 💰",
        "सीखना कोई दर्शक खेल नहीं है। 🤸",
        "अपने आप को चुनौती दें; यह विकास का एकमात्र मार्ग है। 🦋",
        "ध्यान केंद्रित रहें और अतिरिक्त मेहनत करें। यह इसके लायक होगा। 💯",
        "संदेह को मार डालो। सफलता को शोर करने दो। 💥",
        "आप जो कुछ भी चाहते हैं वह डर के दूसरी तरफ है। 🚪",
        "प्रक्रिया पर भरोसा करें। आपके प्रयास फल देंगे। 🍎",
        "छोटी प्रगति अभी भी प्रगति है। 🎉",
        "संगति ही कुंजी है। इसे बनाए रखें। 🗝️",
        "आप प्रगति कर रहे हैं, भले ही यह धीमा लगे। 🚶",
        "एक समय में एक अध्याय। आप यह कर सकते हैं। 📑",
        "हर प्रयास मायने रखता है। 💪",
        "आज अध्ययन करें, कल गर्व करें। 🏅",
        "विजेता कभी हार नहीं मानते और हार मानने वाले कभी जीतते नहीं। 🥇"
    ];


    function gatherAllInsights() {
        let insights = [];
        const today = new Date();
        const hour = today.getHours();
        const todayStr = getLocalDateString(today);
        const studyDay = Math.floor((today - new Date(data.appStartDate)) / (1000 * 60 * 60 * 24)) + 1;
        const allChapters = (data.subjects || []).flatMap(s => s.chapters || []);

        // --- 1. REAL-TIME ACTIVITY REACTION (The "Advanced" Brain) ---
        // Checks activity from the last 2 minutes to react instantly
        const latestLog = (data.activityLog || [])[0];
        if (latestLog) {
            const logTime = new Date(latestLog.timestamp);
            const diffMinutes = (today - logTime) / 60000;
            
            if (diffMinutes < 2) { // Action happened recently
                let reaction = "";
                const desc = latestLog.description;
                
                // 15+ Granular Triggers based on Icon types or description text
                if (latestLog.icon === 'check-circle') reaction = `🔥 शानदार! अभी आपने <strong>"${desc.replace('Chapter completed: ', '').replace(/"/g, '')}"</strong> पूरा किया। रुकना मत!`;
                else if (latestLog.icon === 'plus-circle') reaction = `🌱 नई शुरुआत! आपने <strong>"${desc.split(': ')[1]?.replace(/"/g, '') || 'नया चैप्टर'}"</strong> जोड़ा है। इसे जल्द ही पूरा करें।`;
                else if (latestLog.icon === 'briefcase') reaction = `🎯 लक्ष्य निर्धारित! नई परीक्षा <strong>"${desc.split(': ')[1]?.replace(/"/g, '') || 'Exam'}"</strong> जोड़ी गई। तैयारी शुरू करें!`;
                else if (latestLog.icon === 'trash-2') reaction = `🗑️ सफाई हो गई! आपने <strong>"${desc.split(': ')[1]?.replace(/"/g, '') || 'Item'}"</strong> को हटा दिया।`;
                else if (latestLog.icon === 'skip-forward') reaction = `⏳ कोई बात नहीं! <strong>"${desc.split(': ')[1]?.replace(/"/g, '') || 'Task'}"</strong> को बाद में पूरा कर लेंगे।`;
                else if (latestLog.icon === 'check-square') reaction = `✅ टास्क पूरा हुआ! <strong>"${desc.replace('Other task completed: ', '').replace(/"/g, '')}"</strong> चेकलिस्ट से हट गया।`;
                else if (latestLog.icon === 'award') reaction = `🏆 वाह! नई उपलब्धि: <strong>"${desc.replace('Achievement Unlocked: ', '').replace(/"/g, '')}"</strong>`;
                else if (latestLog.icon === 'refresh-cw') reaction = `🔄 रिवीजन मोड ऑन! विषय को दोबारा पढ़ना एक होशियार कदम है।`;
                else if (latestLog.icon === 'upload') reaction = `📂 डेटा इंपोर्ट सफल! आपका स्टडी ट्रैकर अपडेट हो गया है।`;
                else if (latestLog.icon === 'calendar-x') reaction = `📅 कैलेंडर रीसेट! चलिए नई ऊर्जा के साथ फिर से शुरू करते हैं (Day 1)।`;
                else if (latestLog.icon === 'folder-plus') reaction = `📁 व्यवस्थित! नया फोल्डर <strong>"${desc.split(': ')[1]?.replace(/"/g, '')}"</strong> बनाया गया।`;
                else if (latestLog.icon === 'target') reaction = `🔓 DPT अनलॉक! <strong>${desc.replace('DPT Unlocked: ', '')}</strong> अब उपलब्ध है।`;
                else if (latestLog.icon === 'plus-square') reaction = `📝 अभ्यास जरूरी है! आपने नए DPTs जोड़े हैं।`;
                
                if (reaction) insights.unshift(reaction); // Put reaction at the very top
            }
        }

        // --- 2. Time-Aware Greetings ---
        if (hour < 6) insights.push(`🦉 इतनी रात गए पढ़ाई? पानी पीते रहें और अपनी आँखों का ध्यान रखें।`);
        else if (hour < 9) insights.push(`🌅 सुप्रभात! सुबह की पढ़ाई सबसे असरदार होती है। चलिए शुरू करते हैं।`);
        else if (hour > 22) insights.push(`🌙 दिन समाप्त होने वाला है। आज का लक्ष्य पूरा हुआ क्या?`);

        // --- 3. Exam Countdowns (Real-time) ---
        const exams = (data.exams || []).filter(e => e.examDate && new Date(e.examDate) >= new Date(todayStr)).sort((a,b) => new Date(a.examDate) - new Date(b.examDate));
        if (exams.length > 0) {
            const nearest = exams[0];
            const diffDays = Math.ceil((new Date(nearest.examDate) - new Date(todayStr)) / (1000 * 60 * 60 * 24));
            if (diffDays === 0) insights.push(`🚨 आज <strong>${nearest.name}</strong> परीक्षा है! शुभकामनाएँ! आप कर सकते हैं!`);
            else if (diffDays <= 7) insights.push(`⚠️ ध्यान दें! <strong>${nearest.name}</strong> में केवल <strong>${diffDays} दिन</strong> बचे हैं। रिविज़न तेज़ करें।`);
            else insights.push(`🗓️ आगामी परीक्षा: <strong>${nearest.name}</strong> (${diffDays} दिन शेष)`);
        }

        // --- 4. Deep Stats & Reminders ---
        // Study Day Milestone
        if (studyDay % 7 === 0) insights.push(`🎉 <strong>${Math.floor(studyDay / 7)} सप्ताह</strong> पूरे! आपकी निरंतरता ही आपकी ताकत है। (Day ${studyDay})`);
        
        // Missed Tasks (The Nudge)
        const missedCount = (data.missedChapters || []).length;
        if (missedCount > 0) insights.push(`📉 बैकलॉग बढ़ रहा है: <strong>${missedCount} चैप्टर</strong> पेंडिंग हैं। वीकेंड पर इसे क्लियर करें।`);
        
        // Revisions
        const pendingRevisions = (data.subjects || []).flatMap(s => s.chapters).flatMap(c => c.revisions).filter(r => r.status === 'Pending' && r.date <= todayStr).length;
        if (pendingRevisions > 0) insights.push(`🧠 याददाश्त ताज़ा करें: <strong>${pendingRevisions} चैप्टर</strong> रिविज़न के लिए तैयार हैं।`);

        // DPT Accuracy Check
        const completedDpts = Object.values(data.dpts || {}).flatMap(s => Object.values(s.chapters || {})).flat().filter(t => t.status === 'Completed' && t.details);
        if (completedDpts.length > 3) {
            let correct = 0, total = 0;
            completedDpts.slice(0, 5).forEach(d => { correct += d.details.correct || 0; total += d.details.attempted || 0; });
            const recentAccuracy = total > 0 ? (correct / total * 100) : 0;
            if (recentAccuracy > 85) insights.push(`🌟 अद्भुत! पिछले 5 टेस्ट में आपकी सटीकता <strong>${recentAccuracy.toFixed(1)}%</strong> है।`);
            else if (recentAccuracy < 50) insights.push(`💡 सुझाव: आपकी सटीकता (${recentAccuracy.toFixed(1)}%) कम है। टेस्ट देने से पहले नोट्स पढ़ें।`);
        }

        // Streak
        const history = new Set(data.gamification.completedHistory || []);
        let streak = 0; let d = new Date();
        while (history.has(getLocalDateString(d))) { streak++; d.setDate(d.getDate() - 1); }
        if (streak > 2) insights.push(`🔥 स्ट्रीक ऑन: लगातार <strong>${streak} दिन</strong>! इस चेन को टूटने न दें।`);

        // Motivational Filler
        const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
        // Combine: [Real-time Reaction] + [Exam Alert] + [Time Greeting] + [Stats/Quote]
        // Filter duplicates and empty strings
        const finalInsights = [...new Set(insights)].filter(Boolean);
        
        // Ensure at least the quote exists if nothing else matches
        if (finalInsights.length === 0) finalInsights.push(randomQuote);
        
        // If we have a real-time reaction (first item), we want to make sure it shows first, 
        // but we also want to mix in quotes if the list is short.
        if (finalInsights.length < 3) finalInsights.push(randomQuote);

        return finalInsights;
    }

    const renderAIInsights = () => {
        const container = document.getElementById('ai-insights-container');
        // ULTRA PREMIUM & SMOOTH DESIGN (5x Better Look)
        container.className = "md:col-span-3 relative overflow-hidden dashboard-card px-5 py-4 rounded-2xl min-h-[110px] transition-all duration-300 border border-white/20 shadow-xl bg-gradient-to-br from-white/80 via-white/50 to-white/30 dark:from-[#1e293b]/90 dark:via-[#0f172a]/90 dark:to-[#020617]/90 backdrop-blur-xl flex items-center group hover:shadow-2xl hover:shadow-purple-500/10 hover:-translate-y-1";
        
        container.innerHTML = `
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-500/20 rounded-full blur-[50px] animate-pulse"></div>
            <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-blue-500/20 rounded-full blur-[50px] animate-pulse" style="animation-delay: 1s;"></div>
            
            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-purple-500 via-pink-500 to-blue-500 rounded-l-2xl"></div>

            <div class="w-full relative z-10 flex flex-col justify-center pl-2">
                <div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-200/50 dark:border-gray-700/50">
                    <div class="flex items-center gap-2">
                         <div class="p-1.5 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 shadow-lg shadow-purple-500/30">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                         </div>
                         <h2 class="text-sm font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-gray-800 to-gray-600 dark:from-white dark:to-gray-300 uppercase">
                            AI Advanced Coach
                        </h2>
                        <span class="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-green-500/10 border border-green-500/20 shadow-[0_0_10px_rgba(34,197,94,0.1)]">
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            <span class="text-[9px] font-bold text-green-600 dark:text-green-400 uppercase tracking-widest leading-none">REALTIME</span>
                        </span>
                    </div>
                    <div class="flex flex-col items-end">
                        <p class="text-[10px] font-bold text-indigo-400/80 dark:text-indigo-300/60 tracking-wider bg-indigo-50 dark:bg-indigo-900/20 px-2 py-1 rounded-md border border-indigo-100 dark:border-indigo-500/20 mb-1">Appdesigned@Rayen</p>
                        <p class="text-[9px] text-gray-500 dark:text-gray-400 leading-none">How to use app - <span id="ai-coach-guide-link" class="font-bold text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 cursor-pointer hover:underline transition-colors">click here!</span></p>
                    </div>
                </div>
                <div id="ai-insight-content" class="text-sm font-medium text-gray-700 dark:text-gray-200 leading-relaxed drop-shadow-sm min-h-[2.5rem] flex items-center"></div>
            </div>
        `;
        // Pass student name for personalization logic
        const sName = data.settings.studentName || 'Student';
        const insights = gatherAllInsights().map(i => i.replace('Student', sName));
        
        initRotatingDisplay('ai-insight-content', insights, (item) => `<div class="animate-fadeIn transition-all duration-500 transform translate-y-0 opacity-100">${item}</div>`, _('ai_insight_start'));
    };

    const getSubjectsForDay = (date = new Date()) => {
        const dayIndex = getCycleDayIndex(date); // 0-13 cycle index
        const currentDayOfWeek = date.getDay(); // 0 (Sun) - 6 (Sat)

        let baseSubjects = [];
        // Strict Mode Check to ensure only ONE routine is active
        if (data.settings.planMode === 'railway_cycle') {
             // If plan is somehow corrupted, use strict constant, otherwise use stored plan
             if (data.settings.customCyclePlan && data.settings.customCyclePlan.length === 14) {
                 baseSubjects = [...(data.settings.customCyclePlan[dayIndex] || [])];
             } else {
                 baseSubjects = [...(RAILWAY_ROUTINE[dayIndex] || [])];
             }
        } else if (data.settings.planMode === 'foundation_cycle' || data.settings.planMode === 'auto') { // 'auto' falls back to foundation
             if (data.settings.customCyclePlan && data.settings.customCyclePlan.length === 14) {
                 baseSubjects = [...(data.settings.customCyclePlan[dayIndex] || [])];
             } else {
                 baseSubjects = [...(FOUNDATION_ROUTINE[dayIndex] || [])];
             }
        } else {
            // Custom Cycle
            baseSubjects = [...((data.settings.customCyclePlan || [])[dayIndex] || [])]; 
        }

        // --- MERGE ADVANCED ROUTINE SUBJECTS (Added by Rayen) ---
        // Now fully integrated to act like main schedule
        const customRoutines = data.settings.customSubjectRoutine || [];
        customRoutines.forEach(routine => {
            if (routine.active && routine.days.includes(currentDayOfWeek)) {
                // We add it to the list. 
                // getOrGenerateDailyPlan will verify if it's a real subject ID or a custom string.
                if (!baseSubjects.includes(routine.subjectId)) {
                    baseSubjects.push(routine.subjectId);
                }
            }
        });

        return baseSubjects;
    };
    
    const markSubjectAsDoneForToday = (subjectId) => {
        const todayStr = getLocalDateString();
        const plan = data.dailyPlan[todayStr] = data.dailyPlan[todayStr] || { tasks: {}, completedSubjects: [] };
        if (!plan.completedSubjects.includes(subjectId)) { plan.completedSubjects.push(subjectId); }
        saveData();
        renderHomePage(); 
    };
    
    const openPostponeModal = (subjectId, chapterId) => {
        const modal = document.getElementById('postpone-chapter-modal');
        const form = document.getElementById('postpone-chapter-form');
        form.reset();
        form.dataset.subjectId = subjectId;
        form.dataset.chapterId = chapterId;
        showModal('postpone-chapter-modal');
    };

    const savePostponement = (e) => {
        e.preventDefault();
        const form = e.target;
        const { subjectId, chapterId } = form.dataset;
        const note = document.getElementById('postpone-note-textarea').value.trim();
        const chapter = getChapterByIds(subjectId, chapterId);

        if (chapter) {
            // 1. Force update status and internal note on the chapter itself
            chapter.status = 'Postpone';
            chapter.notes = note; // This is crucial for persistence
            
            // 2. Robust Postpone List Update
            // Remove any old entry for this chapter
            data.postponedChapters = (data.postponedChapters || []).filter(p => !(p.subjectId === subjectId && p.chapterId === chapterId));
            
            // Push the new entry with the FRESH note
            data.postponedChapters.push({ 
                subjectId, 
                chapterId, 
                note: note, // Explicitly save note here
                dateAdded: getLocalDateString()
            });

            // 3. Mark subject as done for TODAY
            markSubjectAsDoneForToday(subjectId);

            logActivity('skip-forward', `Chapter postponed: "${chapter.name}"`);
            saveData();
            
            // Immediate UI Refresh
            hideModal('postpone-chapter-modal');
            hideModal('chapter-modal');
            updateAllUI();
        }
    };
    
    const skipChapter = (subjectId, chapterId) => {
        const subject = getSubjectById(subjectId); 
        if (!subject) return;
        const todayStr = getLocalDateString();
        const plan = data.dailyPlan[todayStr];

        if (plan && plan.tasks) {
            // 1. Store old task for Undo functionality
            const oldTask = { ...plan.tasks[subjectId] };
            
            lastAction = {
                type: 'skip_chapter',
                message: `Skipped: ${getChapterByIds(subjectId, chapterId)?.name}`,
                undo: () => {
                    // Undo logic: Restore the old task
                    data.dailyPlan[todayStr].tasks[subjectId] = oldTask;
                    saveData();
                    renderHomePage();
                }
            };
            showUndoToast(`Skipped: ${getChapterByIds(subjectId, chapterId)?.name}`, lastAction.undo);

            // 2. Find a replacement chapter (FAST REPLACEMENT)
            // Filter chapters: Not completed, Not the one we just skipped, Not postponed today
            const postponedIds = (data.postponedChapters || []).map(p => p.chapterId);
            const availableChapters = (subject.chapters || []).filter(c => 
                c.status !== 'Completed' && 
                c.id !== chapterId &&
                !postponedIds.includes(c.id)
            );

            if (availableChapters.length > 0) {
                // Pick a random new chapter
                const randomIndex = Math.floor(Math.random() * availableChapters.length);
                const newChapter = availableChapters[randomIndex];
                // Replace directly without regenerating whole day (Prevents "Completed" tasks from reappearing)
                plan.tasks[subjectId] = { subjectId, chapterId: newChapter.id, note: null };
            } else {
                // No other chapters available, just remove this slot
                delete plan.tasks[subjectId];
            }
            
            logActivity('chevrons-right', `Skipped chapter: "${getChapterByIds(subjectId, chapterId)?.name}"`);
            saveData(); 
            renderHomePage(); // Instant render
        }
    };
    
    const getOrGenerateDailyPlan = (dateStr) => {
        // Initialize plan safely
        let plan = data.dailyPlan[dateStr];
        if (!plan) {
            plan = { tasks: {}, completedSubjects: [], manualTasks: (data.dailyPlan[dateStr]?.manualTasks || []), completedTasks: [] };
        }

        const subjectsForToday = getSubjectsForDay(new Date(dateStr));
        const usedChapterIds = [];

        // --- MERGE ADVANCED ROUTINE SUBJECTS ---
        const currentDayOfWeek = new Date(dateStr).getDay();
        const advancedRoutines = data.settings.customSubjectRoutine || [];
        
        advancedRoutines.forEach(routine => {
            if (routine.active && routine.days.includes(currentDayOfWeek)) {
                const isRealSubject = getSubjectById(routine.subjectId);
                if (isRealSubject) {
                    if (!subjectsForToday.includes(routine.subjectId)) subjectsForToday.push(routine.subjectId);
                } else {
                    const alreadyExists = (data.otherTasks || []).some(t => t.date === dateStr && t.description === routine.name);
                    if (!alreadyExists) {
                         data.otherTasks.push({
                            id: `other-adv-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                            description: routine.name,
                            date: dateStr,
                            notes: 'Advanced Routine Task',
                            status: 'Pending',
                            completedDate: null, isRepeating: false, lastCompletedDate: null
                        });
                    }
                }
            }
        });

        // Loop through all required subjects
        subjectsForToday.forEach(rawSubjectId => {
            const subjectId = rawSubjectId.split(':')[0];
            if (subjectId.startsWith('custom-')) return; 

            // IMPORTANT: Check existing plan tasks validity
            if (plan.tasks[subjectId]) {
                const existingTask = plan.tasks[subjectId];
                const chap = getChapterByIds(existingTask.subjectId, existingTask.chapterId);
                // STRICT CHECK: If chapter is completed, remove it immediately
                if (!chap || chap.status === 'Completed') {
                    delete plan.tasks[subjectId]; 
                } else {
                    usedChapterIds.push(existingTask.chapterId);
                    return; // Valid pending task exists, do not overwrite
                }
            }

            // If Subject is already marked "Done" for the day, skip
            if (plan.completedSubjects.includes(subjectId)) return;

            const subject = getSubjectById(subjectId);
            if (!subject) return;

            let targetChapter = null;
            let postponementNote = null;

            // --- STRICT PRIORITY 1: POSTPONED CHAPTERS (CRITICAL FIX) ---
            // First check Global Postponed List
            const globalPostponedIndex = (data.postponedChapters || []).findIndex(p => p.subjectId === subjectId);
            
            if (globalPostponedIndex !== -1) {
                const entry = data.postponedChapters[globalPostponedIndex];
                const chapter = getChapterByIds(subjectId, entry.chapterId);
                
                if (chapter && chapter.status !== 'Completed' && !usedChapterIds.includes(chapter.id)) {
                    targetChapter = chapter;
                    // PRIORITY LOGIC FOR NOTE:
                    // 1. Use note from postponedChapters array (most recent)
                    // 2. Use note directly from chapter object
                    postponementNote = entry.note || chapter.notes || "Resuming postponed chapter.";
                    
                    // Remove from list only after assigning
                    data.postponedChapters.splice(globalPostponedIndex, 1);
                }
            }

            // --- STRICT PRIORITY 2: INTERNAL STATUS CHECK ---
            // Even if not in global list, if status is 'Postpone', it MUST come first
            if (!targetChapter) {
                const postponedInternal = subject.chapters.filter(c => c.status === 'Postpone' && !usedChapterIds.includes(c.id));
                if (postponedInternal.length > 0) {
                    targetChapter = postponedInternal[0]; // Take the first postponed one found
                    postponementNote = targetChapter.notes || "Resuming postponed chapter.";
                }
            }

            // --- PRIORITY 3: RANDOM UNCOMPLETED CHAPTER (TRUE RANDOM) ---
            // Only if NO postponed chapters exist
            if (!targetChapter) {
                const availableChapters = subject.chapters.filter(c => 
                    c.status !== 'Completed' && 
                    c.status !== 'Postpone' && 
                    !usedChapterIds.includes(c.id)
                );
                
                if (availableChapters.length > 0) {
                    // True Randomization Logic
                    const randomIndex = Math.floor(Math.random() * availableChapters.length);
                    targetChapter = availableChapters[randomIndex];
                }
            }

            // Assign Task if found
            if (targetChapter) {
                plan.tasks[subjectId] = { subjectId, chapterId: targetChapter.id, note: postponementNote };
                usedChapterIds.push(targetChapter.id);
            }
        });

        plan.planGeneratedForDay = true;
        data.dailyPlan[dateStr] = plan;
        saveData();
        return data.dailyPlan[dateStr];
    };

    const renderTodaysPlan = () => {
        const container = document.getElementById('todays-plan-container');
        const todayStr = getLocalDateString();
        const dailyPlanData = getOrGenerateDailyPlan(todayStr);
        const tasks = dailyPlanData.tasks || {};
        const manualTasks = dailyPlanData.manualTasks || [];
        const completedSubjects = dailyPlanData.completedSubjects || [];
        const dayName = new Date().toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-US', { weekday: 'long' });
        
        // BUG FIX: Strictly filter out tasks that are in 'deletedInstances' for today
        const otherTasksForToday = (data.otherTasks || []).filter(task => {
            // 1. Check if explicitly deleted for today
            if (task.deletedInstances && task.deletedInstances.includes(todayStr)) return false;

            // 2. Normal logic
            if (task.isRepeating) {
                return task.lastCompletedDate !== todayStr;
            } else {
                return task.date === todayStr && task.status === 'Pending';
            }
        });
        
        const postponedOtherTasksForToday = (data.postponedOtherTasks || [])
            .filter(task => task.date === todayStr && task.status === 'Pending');

        // --- PRIORITY TASK INJECTION (Upcoming 3 Days) ---
        const todayDateObj = new Date(todayStr);
        const upcomingPriorityTasks = (data.otherTasks || []).filter(task => {
            if (!task.priority || task.status === 'Completed') return false;
            const taskDate = new Date(task.date);
            const diffTime = taskDate - todayDateObj;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            // Show if it's tomorrow (1), day after (2), or 3 days later, AND not already in today's list
            return diffDays >= 1 && diffDays <= 3;
        }).map(task => {
            // Determine Alert Level
            const diffDays = Math.ceil((new Date(task.date) - todayDateObj) / (1000 * 60 * 60 * 24));
            let alertMsg = "";
            if(diffDays === 1) alertMsg = "Tomorrow!";
            else if(diffDays === 2) alertMsg = "In 2 Days";
            else alertMsg = "In 3 Days";
            
            return { ...task, type: 'other', isUpcomingPriority: true, alertMsg };
        });

        const chaptersToStudy = Object.entries(tasks).filter(([key]) => !completedSubjects.includes(key)).map(([, task]) => {
            if (!task) return null;
            const subject = getSubjectById(task.subjectId); const chapter = getChapterByIds(task.subjectId, task.chapterId);
            return (subject && chapter && chapter.status !== 'Completed') ? { type: 'chapter', subject, chapter, note: task.note } : null;
        }).filter(Boolean);

        const revisionsForToday = [];
        (data.subjects || []).forEach(s => {
            (s.chapters || []).forEach(c => (c.revisions || []).forEach(r => { if(r.status === 'Pending' && r.date === todayStr) revisionsForToday.push({ type: 'revision', subject: s, chapter: c, revision: r }); }));
        });
        
        const manualChapterTasks = manualTasks.filter(task => {
            const chapter = getChapterByIds(task.subjectId, task.chapterId);
            return chapter && chapter.status !== 'Completed';
        }).map(task => ({ ...task, type: 'manual_chapter' }));

        let planHtml = `<div class="flex items-center justify-between pb-3 border-b border-primary/20 mb-4">
            <div class="flex items-center gap-3"><i data-lucide="clipboard-list" class="w-6 h-6 text-primary"></i><h2 class="text-lg font-bold text-primary">${_('todays_plan')} (${dayName})</h2></div>
            <button id="add-task-choice-btn" class="p-1.5 rounded-full hover:bg-sky-200 dark:hover:bg-sky-800"><i data-lucide="plus-circle" class="w-5 h-5 text-primary"></i></button>
        </div>`;
        
        const allTasksForToday = [
            ...upcomingPriorityTasks, // Show Priority First
            ...chaptersToStudy, 
            ...revisionsForToday,
            ...manualChapterTasks,
            ...otherTasksForToday.map(t => ({...t, type: 'other'})),
            ...postponedOtherTasksForToday.map(t => ({...t, type: 'other'}))
        ];

        if (allTasksForToday.length > 0) {
            planHtml += `<ul class="space-y-3">`;
            allTasksForToday.forEach(item => {
                planHtml += renderTaskItemHTML(item);
            });
            planHtml += `</ul>`;
        } else {
            planHtml += `<div class="text-center py-8 flex flex-col items-center justify-center text-text-muted-light dark:text-text-muted-dark"><i data-lucide="party-popper" class="w-12 h-12 text-accent mx-auto mb-4"></i><h3 class="text-lg font-bold">${_('congratulations')}</h3><p>${_('all_tasks_completed')}</p></div>`;
        }
        container.innerHTML = planHtml;
        renderCompletedTasksDropdown();
        lucide.createIcons();
    };

    const renderCompletedTasksDropdown = () => {
        const todayStr = getLocalDateString();
        const completedTasks = data.dailyPlan[todayStr]?.completedTasks || [];
        const toggleContainer = document.getElementById('completed-tasks-toggle-container');
        const listContainer = document.getElementById('completed-tasks-list');

        if (completedTasks.length === 0) {
            toggleContainer.style.display = 'none';
            listContainer.classList.add('hidden');
            return;
        }

        toggleContainer.style.display = 'block';
        document.getElementById('completed-tasks-count').textContent = completedTasks.length;

        listContainer.innerHTML = completedTasks.map(task => {
            let text = '';
            if (task.type === 'chapter' || task.type === 'manual_chapter' || task.type === 'revision') {
                const subject = getSubjectById(task.subjectId);
                const chapter = getChapterByIds(task.subjectId, task.chapterId);
                if (subject && chapter) {
                    text = `${_(subject.id)} - ${chapter.name} ${task.type === 'revision' ? '(Revision)' : ''}`;
                }
            } else if (task.type === 'other') {
                text = task.description;
            }
            return `<div class="text-xs text-green-800 dark:text-green-300 flex items-center gap-2"><i data-lucide="check" class="w-3 h-3"></i><span>${text}</span></div>`;
        }).join('');
        lucide.createIcons();
    };
    
    const renderTaskItemHTML = (item) => {
        let html = '';
        const { type } = item;
        
        if (type === 'chapter' || type === 'revision' || type === 'manual_chapter') {
            const isRevision = type === 'revision';
            const isManual = type === 'manual_chapter';
            const subject = isManual ? getSubjectById(item.subjectId) : item.subject;
            const chapter = isManual ? getChapterByIds(item.subjectId, item.chapterId) : item.chapter;
            const revision = item.revision;
            
            if (!subject || !chapter) return '';

            const uniqueId = isManual ? `manual-${item.id}` : (isRevision ? `revision-${subject.id}-${chapter.id}-${revision.date}` : `task-${subject.id}-${chapter.id}`);
            
            // --- Custom Styling for 8th and 23rd Day Revisions ---
            let bgColor = 'bg-card-light dark:bg-card-dark shadow-sm';
            let revisionBadge = '';
            let checkboxClass = 'task-checkbox text-primary';
            
            if (isManual) {
                bgColor = 'bg-indigo-50 dark:bg-indigo-900/40';
            } else if (isRevision) {
                checkboxClass = 'revision-checkbox text-amber-500';
                
                // Identify revision type (8th or 23rd)
                if (revision.cycle === 8) {
                    bgColor = 'bg-purple-50 dark:bg-purple-900/30 border-l-4 border-purple-400';
                    revisionBadge = `<span class="ml-2 px-2 py-0.5 rounded text-[10px] font-bold bg-purple-200 text-purple-800 dark:bg-purple-800 dark:text-purple-200 uppercase tracking-wide">8th Day Rev.</span>`;
                } else if (revision.cycle === 23) {
                    bgColor = 'bg-pink-50 dark:bg-pink-900/30 border-l-4 border-pink-400';
                    revisionBadge = `<span class="ml-2 px-2 py-0.5 rounded text-[10px] font-bold bg-pink-200 text-pink-800 dark:bg-pink-800 dark:text-pink-200 uppercase tracking-wide">23rd Day Rev.</span>`;
                } else {
                    // Fallback for old data or other cycles
                    bgColor = 'bg-amber-50 dark:bg-amber-900/40';
                    revisionBadge = `<span class="ml-2 px-2 py-0.5 rounded text-[10px] font-bold bg-amber-200 text-amber-800 dark:bg-amber-800 dark:text-amber-200 uppercase">Rev.</span>`;
                }
            }

            const labelText = isRevision ? chapter.name : chapter.name;

            // Fill Form Tag Logic
            let extraTags = '';
            if (subject.id === 'fill-form') {
                extraTags = `<span class="ml-2 px-2 py-0.5 rounded text-[10px] font-bold bg-blue-600 text-white shadow-sm flex items-center gap-1"><i data-lucide="briefcase" class="w-3 h-3"></i> Job Application Day</span>`;
            }

            let subText = `<p class="text-sm ${isRevision ? 'text-gray-600 dark:text-gray-400' : 'text-sky-600 dark:text-sky-300'} flex items-center gap-1.5">${isRevision ? '<i data-lucide="repeat" class="w-3 h-3"></i> ' : ''}${_(subject.id)}</p>`;
            if(isManual) subText = `<p class="text-sm text-indigo-600 dark:text-indigo-300 flex items-center gap-1.5"><i data-lucide="hand" class="w-3 h-3"></i> ${_(subject.id)}</p>`;
            
            const noteHtml = item.note ? `<div class="mt-2 pl-7"><p class="text-xs text-yellow-700 dark:text-yellow-300 p-2 bg-yellow-100 dark:bg-yellow-900/50 rounded-md flex items-start gap-2"><i data-lucide="notebook-text" class="w-4 h-4 flex-shrink-0 mt-0.5"></i><span>${item.note}</span></p></div>` : '';
            
            const actionButtons = `
                <div class="flex gap-1">
                    <button class="task-action-btn postpone-btn p-1.5 rounded hover:bg-yellow-100 dark:hover:bg-yellow-900/50" title="${_('postpone_task')}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" ${isRevision ? `data-revision-date="${revision.date}"` : ''} data-task-type="${type}"><i data-lucide="skip-forward" class="w-4 h-4 text-yellow-600"></i></button>
                    ${isManual ? 
                        `<button class="task-action-btn delete-manual-task-btn p-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900/50" title="Delete" data-manual-id="${item.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button>` :
                        (isRevision ? '' : `<button class="task-action-btn skip-btn p-1.5 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50" title="${_('skip_chapter')}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}"><i data-lucide="chevrons-right" class="w-4 h-4 text-blue-600"></i></button>`)
                    }
                </div>`;

            html = `<li class="task-list-item p-3 rounded-lg flex flex-col items-start ${bgColor} animate-list-item" data-manual-id="${isManual ? item.id : ''}">
                <div class="w-full flex items-center gap-3">
                    <input type="checkbox" id="${uniqueId}" class="${checkboxClass} h-5 w-5 rounded border flex-shrink-0" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" ${isRevision ? `data-revision-date="${revision.date}"` : ''} ${isManual ? `data-is-manual="true"` : `data-subject-id-only="${subject.id}"`} data-task-type="${type}">
                    <label for="${uniqueId}" class="flex-grow cursor-pointer"><p class="font-semibold flex items-center flex-wrap gap-1">${labelText} ${revisionBadge} ${extraTags}</p>${subText}</label>
                    ${actionButtons}
                </div>
                ${noteHtml}
            </li>`;

        } else if (type === 'other') {
            const uniqueId = `other-task-${item.id}`;
            let bgColor = 'bg-gray-100 dark:bg-slate-800';
            let priorityBadge = '';
            
            if (item.priority) {
                if (item.isUpcomingPriority) {
                    if (item.alertMsg === 'Tomorrow!') bgColor = 'bg-orange-100 dark:bg-orange-900/40 border-l-4 border-orange-500';
                    else if (item.alertMsg === 'In 2 Days') bgColor = 'bg-yellow-50 dark:bg-yellow-900/30 border-l-4 border-yellow-400';
                    else bgColor = 'bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-400';
                    
                    priorityBadge = `<span class="ml-2 text-[10px] font-bold uppercase px-2 py-0.5 rounded bg-white/50 text-black shadow-sm">${item.alertMsg}</span>`;
                } else {
                    bgColor = 'bg-red-100 dark:bg-red-900/50 border-l-4 border-red-600 shadow-md animate-pulse';
                    priorityBadge = `<span class="ml-2 text-[10px] font-bold uppercase px-2 py-0.5 rounded bg-red-600 text-white shadow-sm">EXAM DAY!</span>`;
                }
            }

            const repeatIcon = item.isRepeating ? '<i data-lucide="repeat" class="w-3 h-3 text-violet-500"></i> ' : '';
            const checkboxHtml = item.isUpcomingPriority 
                ? `<i data-lucide="clock" class="w-5 h-5 text-gray-400"></i>` 
                : `<input type="checkbox" id="${uniqueId}" class="task-checkbox text-gray-500 h-5 w-5 rounded border flex-shrink-0" data-task-id="${item.id}" data-task-type="${type}">`;

            const actionButtons = item.isUpcomingPriority ? '' : `
                <div class="flex gap-1">
                    ${!item.isRepeating ? `<button class="task-action-btn postpone-btn p-1.5 rounded hover:bg-yellow-100 dark:hover:bg-yellow-900/50" title="${_('postpone_task')}" data-task-id="${item.id}" data-task-type="${type}"><i data-lucide="skip-forward" class="w-4 h-4 text-yellow-600"></i></button>` : ''}
                    <button class="task-action-btn delete-other-task-btn p-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900/50" title="Delete" data-task-id="${item.id}" data-task-type="${type}"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button>
                </div>`;

            html = `<li class="task-list-item p-3 rounded-lg flex items-center gap-3 ${bgColor} animate-list-item">
                ${checkboxHtml}
                <label for="${uniqueId}" class="flex-grow cursor-pointer"><p class="font-semibold flex items-center">${item.description} ${priorityBadge}</p><p class="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-1.5">${repeatIcon}<i data-lucide="user-check" class="w-3 h-3"></i> Other Task ${item.notes ? `- ${item.notes}` : ''}</p></label>
                ${actionButtons}</li>`;
        }
        return html;
    };

    const renderTomorrowsPlan = () => {
        const container = document.getElementById('tomorrows-plan-container');
        const tomorrowDate = new Date();
        tomorrowDate.setDate(tomorrowDate.getDate() + 1);
        const tomorrowStr = getLocalDateString(tomorrowDate);
        
        const chaptersForTomorrow = Object.values(getOrGenerateDailyPlan(tomorrowStr).tasks || {}).map(task => {
            if (!task) return null;
            const subject = getSubjectById(task.subjectId); const chapter = getChapterByIds(task.subjectId, task.chapterId);
            return (subject && chapter) ? { subject, chapter } : null;
        }).filter(Boolean);
        if (chaptersForTomorrow.length === 0) { container.innerHTML = `<p class="text-center text-sm">No topics scheduled for tomorrow.</p>`; return; }
        container.innerHTML = chaptersForTomorrow.map(({ subject, chapter }) => {
            return `<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg animate-list-item"><div><p class="font-semibold">${chapter.name}</p><p class="text-xs">${_(subject.id)}</p></div><i data-lucide="arrow-right-circle" class="w-5 h-5 text-primary"></i></div>`
        }).join('');
        lucide.createIcons();
    };

    const renderYesterdaysActivity = () => {
        const container = document.getElementById('yesterdays-completed-container');
        const yesterdayDate = new Date();
        yesterdayDate.setDate(yesterdayDate.getDate() - 1);
        const yesterdayStr = getLocalDateString(yesterdayDate);
        
        const completedYesterdayChapters = [];
        (data.subjects || []).forEach(subject => {
            (subject.chapters || []).forEach(chapter => { if (chapter.dateCompleted === yesterdayStr) completedYesterdayChapters.push({ subject, chapter }); });
        });
        
        const completedYesterdayOther = (data.otherTasks || []).filter(task => task.completedDate === yesterdayStr);

        const allCompleted = [...completedYesterdayChapters, ...completedYesterdayOther];

        if (allCompleted.length === 0) { container.innerHTML = `<p class="text-center text-sm">${_('no_chapters_yesterday')}</p>`; return; }
        container.innerHTML = allCompleted.map((item) => {
            if(item.chapter) { // It's a chapter
                 return `<div class="flex items-center gap-3 p-3 bg-green-50 dark:bg-green-900/50 rounded-lg animate-list-item"><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i><div><p class="font-semibold">${item.chapter.name}</p><p class="text-xs">${_(item.subject.id)}</p></div></div>`;
            } else { // It's an "other" task
                 return `<div class="flex items-center gap-3 p-3 bg-gray-100 dark:bg-slate-800/50 rounded-lg animate-list-item"><i data-lucide="check-square" class="w-5 h-5 text-gray-500"></i><div><p class="font-semibold">${item.description}</p><p class="text-xs">Other Task</p></div></div>`;
            }
        }).join('');
        lucide.createIcons();
    };

    const renderMissedChapters = () => {
        const container = document.getElementById('missed-chapters-list');
        const twoDaysAgo = new Date(); twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
        const twoDaysAgoStr = getLocalDateString(twoDaysAgo);
        const yesterdayDate = new Date(); yesterdayDate.setDate(yesterdayDate.getDate() - 1);
        const yesterdayStr = getLocalDateString(yesterdayDate);

        const allMissed = (data.missedChapters || [])
            .filter(item => item.date >= twoDaysAgoStr)
            .sort((a, b) => new Date(b.date) - new Date(a.date));

        const renderItem = (item) => {
            const subject = getSubjectById(item.subjectId);
            const chapter = getChapterByIds(item.subjectId, item.chapterId);
            if (!subject || !chapter) return '';
            const missedDateFormatted = new Date(item.date).toLocaleDateString((data.settings.language === 'hi' ? 'hi-IN' : 'en-GB'), { weekday: 'short', day: 'numeric' });
            const isYesterday = item.date === yesterdayStr;
            // Removed data-source-type
            const completeButton = isYesterday ? `<button class="complete-missed-chapter-btn flex items-center gap-1.5 text-xs font-semibold px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 rounded-md" data-subject-id="${item.subjectId}" data-chapter-id="${item.chapterId}"><i data-lucide="plus" class="w-3 h-3"></i><span>${_('complete_yesterdays_task')}</span></button>` : '';

            return `<div class="p-3 bg-red-50 dark:bg-red-900/50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold">${chapter.name}</p>
                        <p class="text-xs">${_(subject.id)} - <span class="font-medium text-red-700 dark:text-red-300">${missedDateFormatted}</span></p>
                    </div>
                    <i data-lucide="alert-circle" class="w-5 h-5 text-danger flex-shrink-0"></i>
                </div>
                ${completeButton ? `<div class="mt-2 text-right">${completeButton}</div>` : ''}
            </div>`;
        };
        
        initRotatingDisplay('missed-chapters-list', allMissed, renderItem, _('no_missed_chapters'));
    };

    const renderMissedOtherTasks = () => {
        const card = document.getElementById('missed-other-tasks-card');
        const container = document.getElementById('missed-other-tasks-list');
        const missed = data.missedOtherTasks || [];
        
        if(missed.length === 0) {
            card.classList.add('hidden');
            return;
        }
        card.classList.remove('hidden');

        const renderItem = (item) => {
            const missedDateFormatted = new Date(item.date).toLocaleDateString((data.settings.language === 'hi' ? 'hi-IN' : 'en-GB'), { weekday: 'short', day: 'numeric' });
            return `<div class="p-3 bg-gray-100 dark:bg-slate-800 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold">${item.description}</p>
                        <p class="text-xs">Missed on: <span class="font-medium text-gray-700 dark:text-gray-300">${missedDateFormatted}</span></p>
                    </div>
                     <button class="add-missed-other-task-btn flex items-center gap-1.5 text-xs font-semibold px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 rounded-md" data-task-id="${item.id}"><i data-lucide="plus" class="w-3 h-3"></i><span>Add to Today</span></button>
                </div>
            </div>`;
        };
        
        initRotatingDisplay('missed-other-tasks-list', missed, renderItem, 'No missed tasks.');
    };

    const renderMissedRevisions = () => {
        const container = document.getElementById('missed-revisions-list');
        const missed = data.missedRevisions || [];

        const renderItem = (item) => {
            const subject = getSubjectById(item.subjectId);
            const chapter = getChapterByIds(item.subjectId, item.chapterId);
            if (!subject || !chapter) return '';
            // Removed data-source-type
            return `<div class="p-3 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold">${chapter.name}</p>
                        <p class="text-xs">${_(subject.id)} - <span class="font-medium">Revision Missed</span></p>
                    </div>
                </div>
                <div class="mt-2 text-right">
                    <button class="complete-missed-revision-btn flex items-center gap-1.5 text-xs font-semibold px-2 py-1 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 rounded-md" data-subject-id="${item.subjectId}" data-chapter-id="${item.chapterId}" data-revision-date="${item.revisionDate}"><i data-lucide="plus" class="w-3 h-3"></i><span>Complete Now</span></button>
                </div>
            </div>`;
        };
        
        initRotatingDisplay('missed-revisions-list', missed, renderItem, 'No missed revisions. Great job!');
    };


    const renderUpcomingRevisions = () => {
        const today = new Date(); today.setHours(0,0,0,0);
        const upcoming = [];
        (data.subjects || []).forEach(s => {
            (s.chapters || []).forEach(c => (c.revisions || []).forEach(r => { if(r.status === 'Pending' && new Date(r.date) >= today) upcoming.push({ ...r, chapter: c, subject: s }); }));
        });
        upcoming.sort((a,b) => new Date(a.date) - new Date(b.date));

        const renderItem = (item) => {
             const diffDays = Math.ceil((new Date(item.date) - today) / 86400000);
             let dateText = diffDays === 0 ? `<span class="font-bold text-danger">${_('today')}</span>` : (diffDays === 1 ? `<span class="font-semibold text-warning">${_('tomorrow')}</span>` : `${new Date(item.date).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB', { month: 'short', day: 'numeric' })}`);
             return `<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><div><p class="font-semibold">${item.chapter.name}</p><p class="text-xs">${_(item.subject.id)}</p></div><div class="text-right text-sm">${dateText}</div></div>`
        };
        
        initRotatingDisplay('revisions-container', upcoming, renderItem, _('no_upcoming_revisions'));
    };
    
    const renderDashboardExamList = () => {
        const container = document.getElementById('dashboard-upcoming-exams-list');
        if (!container) return;

        if (container.dataset.scrollInterval) {
            clearInterval(parseInt(container.dataset.scrollInterval));
            delete container.dataset.scrollInterval;
        }

        const activeExams = (data.exams || []).filter(e =>
            e.status === 'Applied' || e.status === 'Admit Card Out'
        ).sort((a, b) => new Date(a.examDate || '9999-12-31') - new Date(b.examDate || '9999-12-31'));

        if (activeExams.length === 0) {
            // NEW: CTA Link for Empty State (Directly navigates to Exams Page)
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-4">
                    <p class="text-xs font-medium text-cyan-300/80 mb-2">एग्जाम ऐड करने पर यहाँ आपकी 'Applied Forms' लिस्ट दिखेगी।</p>
                    <button id="dashboard-add-exam-btn-1" class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-300 text-xs font-bold rounded-lg border border-cyan-500/30 transition-all flex items-center gap-2 group">
                        <i data-lucide="plus-circle" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                        Add Exam Now
                    </button>
                </div>`;
            
            // Add click listener to navigate to Exams page directly
            setTimeout(() => {
                document.getElementById('dashboard-add-exam-btn-1')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    navigateTo('exams'); // Jump to Exams Page
                });
            }, 0);

            lucide.createIcons();
            return;
        }

        // Generate List HTML - Performance Optimized
        const htmlContent = activeExams.map(exam => {
            const locale = data.settings.language === 'hi' ? 'hi-IN' : 'en-GB';
            const examDate = exam.examDate ? new Date(exam.examDate).toLocaleDateString(locale, { day: 'numeric', month: 'short' }) : 'TBD';
            const appDate = exam.applicationDate ? new Date(exam.applicationDate).toLocaleDateString(locale, { day: 'numeric', month: 'short' }) : 'N/A';
            
            const daysRemaining = exam.examDate ? Math.ceil((new Date(exam.examDate) - new Date()) / 86400000) : 999;
            const isNear = daysRemaining <= 10 && daysRemaining >= 0; 

            let statusStyle = "";
            let statusIcon = "";
            if (exam.status === 'Admit Card Out') {
                statusStyle = "border-green-500/50 text-green-400 bg-green-500/10 shadow-[0_0_10px_rgba(34,197,94,0.2)]";
                statusIcon = "check-circle-2";
            } else {
                statusStyle = "border-cyan-500/50 text-cyan-400 bg-cyan-500/10 shadow-[0_0_10px_rgba(6,182,212,0.2)]";
                statusIcon = "loader";
            }
            
            const cardBorderClass = isNear ? "border-red-500/60 shadow-[0_0_15px_rgba(239,68,68,0.15)]" : "border-gray-700/50 hover:border-cyan-500/50";
            const dateColorClass = isNear ? "text-red-400 font-extrabold animate-pulse" : "text-purple-300";

            return `<div class="mb-3 transform transition-all duration-300">
                <div class="relative p-3 rounded-lg bg-[#111827]/80 ${cardBorderClass} backdrop-blur-md shadow-lg group">
                    <div class="flex items-center justify-between gap-3">
                        <div class="flex items-center gap-3 overflow-hidden">
                             <div class="flex-shrink-0 w-8 h-8 rounded-lg ${statusStyle} flex items-center justify-center border">
                                <i data-lucide="${statusIcon}" class="w-4 h-4"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-bold text-sm truncate text-gray-200 group-hover:text-cyan-300 transition-colors">${exam.name}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] uppercase tracking-wider font-semibold ${exam.status === 'Admit Card Out' ? 'text-green-400' : 'text-cyan-400'}">${exam.status}</span>
                                    <span class="text-[9px] text-gray-400 border-l border-gray-600 pl-2 ml-1">Applied: ${appDate}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 text-right bg-black/20 p-1.5 rounded-md border border-white/5">
                            <span class="block text-xs font-bold ${dateColorClass}">${examDate}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');

        container.innerHTML = `<div class="pb-2">${htmlContent}</div>`;
        lucide.createIcons();
    };

    const renderOverallProgress = () => {
        const allChapters = (data.subjects || []).flatMap(s => s.chapters || []);
        const completed = allChapters.filter(c => c.status === 'Completed').length;
        const total = allChapters.length; const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        document.getElementById('chapters-completed-count').textContent = `${completed} / ${total}`;
        document.getElementById('overall-progress-text').textContent = `${percentage}%`;
        const chartId = 'overall-progress-chart';
        if (allCharts[chartId]) allCharts[chartId].destroy();
        allCharts[chartId] = new Chart(document.getElementById(chartId), { type: 'doughnut', data: { datasets: [{ data: [percentage, 100 - percentage], backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--primary'), data.settings.theme === 'dark' ? '#374151' : '#e5e7eb'], borderWidth: 0, borderRadius: 5 }] }, options: { responsive: true, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
    };

    const renderSubjectWiseProgressDashboard = () => {
        const container = document.getElementById('subject-progress-dashboard-container');
        const titleEl = document.getElementById('subject-progress-title');
        if (!container || !titleEl) return;
        titleEl.textContent = _('subject_wise_progress_dashboard');
        let content = '';
        (data.subjects || []).forEach(subject => {
            const chapters = subject.chapters || [];
            if (chapters && chapters.length > 0) {
                const completed = chapters.filter(c => c.status === 'Completed').length; const percentage = Math.round((completed / chapters.length) * 100);
                content += `<div class="animate-list-item">
                                <div class="flex justify-between items-center mb-1 text-sm">
                                    <span class="font-semibold">${_(subject.id)}</span>
                                    <span class="text-text-muted-light dark:text-text-muted-dark">${percentage}%</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-green-500 h-2.5 rounded-full animated-progress-bar" style="width: ${percentage}%;"></div>
                                </div>
                           </div>`;
            }
        });
        container.innerHTML = content || `<p class="text-center text-xs py-2">${_('add_chapters_prompt')}</p>`;
    };

    const renderBadges = () => {
        const container = document.getElementById('badges-container');
        const unlockedBadges = new Set(data.gamification.badges || []);
        const allBadgeEntries = Object.entries(BADGES);
        
        const nextBadgeEntry = allBadgeEntries.find(([id]) => !unlockedBadges.has(id));
        
        let progressHtml = '';
        if (nextBadgeEntry) {
            const [nextBadgeId, badgeInfo] = nextBadgeEntry;
            const {current, goal} = getBadgeProgress(nextBadgeId);
            const progress = Math.min(100, (current / goal) * 100);
            
            progressHtml = `<div class="mb-3">
                <p class="text-sm font-semibold text-center mb-2">Next: ${badgeInfo.name}</p>
                <div class="flex items-center gap-3">
                    <i data-lucide="${badgeInfo.icon}" class="text-gray-400 dark:text-gray-500 w-6 h-6"></i>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full animated-progress-bar" style="width: ${progress}%; background: linear-gradient(to right, #8b5cf6, #ec4899, #f59e0b);"></div>
                    </div>
                    <span class="text-xs font-bold">${current}/${goal}</span>
                </div>
            </div>`;
        }

        const allBadgesHtml = allBadgeEntries.map(([badgeId, badge]) => {
            const isUnlocked = unlockedBadges.has(badgeId);
            const iconClass = isUnlocked ? badge.color : 'text-gray-400 dark:text-gray-600 opacity-50';
            return `<div class="flex flex-col items-center text-center p-1" title="${badge.description}"><i data-lucide="${badge.icon}" class="w-8 h-8 ${iconClass} mb-1"></i><span class="text-xs font-medium ${isUnlocked ? '' : 'text-gray-400 dark:text-gray-600'}">${badge.name}</span></div>`;
        }).join('');
        
        if (!progressHtml && unlockedBadges.size === 0) { container.innerHTML = `<p class="text-center text-sm py-4">${_('keep_studying_prompt')}</p>`; return; }
        container.innerHTML = progressHtml + `<div class="grid grid-cols-4 gap-2 mt-2">${allBadgesHtml}</div>`;
        lucide.createIcons();
    };
const renderSubjectsPage = () => {
        const container = document.getElementById('subjects-list-container');
        const filter = document.getElementById('search-input').value.toLowerCase();
        
        document.querySelectorAll('#subject-view-filter .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === subjectPageViewMode));
        
        container.innerHTML = (data.subjects || []).map(subject => {
             let chapters = subject.chapters || [];
             
             // STRICT FILTERING LOGIC
             if (subjectPageViewMode === 'completed') {
                 chapters = chapters.filter(c => c.status === 'Completed');
             } else if (subjectPageViewMode === 'postponed') {
                 // Check both internal status AND global postponed list
                 const globalPostponedIds = (data.postponedChapters || []).filter(p => p.subjectId === subject.id).map(p => p.chapterId);
                 chapters = chapters.filter(c => {
                     return (c.status === 'Postpone') || globalPostponedIds.includes(c.id);
                 });
             }

             const filteredChapters = chapters.filter(c => c.name.toLowerCase().includes(filter));
             
             // If searching and no matches in this subject, skip subject (unless subject name matches)
             if (filter && filteredChapters.length === 0 && !_(subject.id).toLowerCase().includes(filter)) return '';
             
             // If not searching and no chapters for this mode, hide subject block (Cleaner UI)
             if (!filter && filteredChapters.length === 0) return '';

             const totalChaptersInView = chapters.length;
             // Calculate totals based on ALL chapters for progress bar, not just filtered view
             const allSubjectChapters = subject.chapters || [];
             const totalAll = allSubjectChapters.length;
             const completedAll = allSubjectChapters.filter(c => c.status === 'Completed').length;
             const percentage = totalAll > 0 ? Math.round((completedAll / totalAll) * 100) : 0;
             
             const renderChapterList = (chaptersToRender) => {
                 if (chaptersToRender.length === 0) {
                     return `<p class="text-center text-sm py-2 text-gray-400">No chapters found in this category.</p>`;
                 }
                 return `<ul class="space-y-2 mt-4 mb-3">${chaptersToRender.map(c => `<li data-subject-id="${subject.id}" data-chapter-id="${c.id}" class="chapter-item flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 hover:shadow-md"><span class="font-medium">${c.name}</span><div class="flex items-center gap-2"><span class="text-xs px-2 py-1 rounded-full ${getStatusClass(c.status)}">${_(c.status.toLowerCase().replace(' ','_'))}</span></div></li>`).join('')}</ul>`;
             };
             
             const restudyButton = (percentage === 100) ? `<button class="restudy-subject-btn p-1.5 rounded-full hover:bg-green-100 dark:hover:bg-green-800/50" data-subject-id="${subject.id}" title="${_('restudy_subject')}"><i data-lucide="refresh-cw" class="w-4 h-4 text-green-500"></i></button>` : '';
             const completionCycle = subject.completionCount > 0 ? `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${_('completion_cycle', {count: subject.completionCount})}</span>` : '';

             // Default Collapsed (Removed 'open' attribute)
             return `<details class="group bg-card-light dark:bg-card-dark rounded-xl shadow-sm overflow-hidden">
                <summary class="flex items-center justify-between p-4 cursor-pointer">
                    <div>
                        <div class="flex items-center gap-2">
                           <h3 class="font-bold text-lg">${_(subject.id)}</h3>
                           ${completionCycle}
                        </div>
                        <p class="text-sm text-text-muted-light">${_('chapters_done_of', {completed: completedAll, total: totalAll})}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full animated-progress-bar bg-green-500" style="width: ${percentage}%"></div>
                        </div>
                        ${restudyButton}
                        <button class="delete-subject-btn p-1.5 rounded-full hover:bg-red-100 dark:hover:bg-red-800/50" data-subject-id="${subject.id}" title="${_('delete_subject')}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        <i data-lucide="chevron-right" class="w-5 h-5 transition-transform group-open:rotate-90"></i>
                    </div>
                </summary>
                <div class="p-4 border-t">
                    <div>${renderChapterList(filteredChapters)}
                    ${subjectPageViewMode === 'all' ? `<div class="mt-2"><button class="add-chapter-btn w-full flex items-center justify-center p-2 text-sm font-semibold text-primary bg-sky-100 dark:bg-sky-900/50 rounded-lg hover:bg-sky-200 dark:hover:bg-sky-900" data-subject-id="${subject.id}"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>${_('add_chapter')}</button></div>` : ''}
                    </div>
                </div>
             </details>`;
        }).join('');
        
        if (!container.innerHTML.trim()) {
            container.innerHTML = `<div class="text-center py-10 opacity-60"><p>No subjects found for "${subjectPageViewMode}" view.</p></div>`;
        }
        lucide.createIcons();
    };

    const renderImportExportPage = () => {
        // --- 1. ROUTINE TOGGLE LOGIC (UPDATED FOR RAILWAY/FOUNDATION) ---
        // Instead of toggling classes, we inject new HTML for better control
        const routineContainer = document.querySelector('#page-import-export .md\\:col-span-2:first-child');
        
        const currentMode = data.settings.planMode; // 'foundation_cycle', 'railway_cycle', 'custom_cycle'
        
        const routineHtml = `
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-violet-100 dark:bg-violet-900/50 rounded-lg text-violet-600">
                    <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg">Routine Management</h3>
                    <p class="text-xs text-text-muted-light dark:text-text-muted-dark">Select your preferred study cycle.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3 mb-4">
                <button id="set-foundation-routine-btn" class="flex items-center justify-between p-4 rounded-xl border-2 transition-all ${currentMode === 'foundation_cycle' ? 'border-violet-500 bg-violet-50 dark:bg-violet-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-violet-300'}">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm"><i data-lucide="book-open" class="w-5 h-5 text-violet-600"></i></div>
                        <div class="text-left">
                            <h4 class="font-bold">Foundation Routine</h4>
                            <p class="text-xs opacity-70">Standard 14-day study cycle.</p>
                        </div>
                    </div>
                    ${currentMode === 'foundation_cycle' ? '<i data-lucide="check-circle-2" class="w-6 h-6 text-violet-600 fill-violet-100"></i>' : ''}
                </button>

                <button id="set-railway-routine-btn" class="flex items-center justify-between p-4 rounded-xl border-2 transition-all ${currentMode === 'railway_cycle' ? 'border-orange-500 bg-orange-50 dark:bg-orange-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-orange-300'}">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm"><i data-lucide="train" class="w-5 h-5 text-orange-600"></i></div>
                        <div class="text-left">
                            <h4 class="font-bold">Railway Routine</h4>
                            <p class="text-xs opacity-70">Specialized plan for Railway exams.</p>
                        </div>
                    </div>
                    ${currentMode === 'railway_cycle' ? '<i data-lucide="check-circle-2" class="w-6 h-6 text-orange-600 fill-orange-100"></i>' : ''}
                </button>
                
                <button id="set-custom-routine-btn" class="flex items-center justify-between p-4 rounded-xl border-2 transition-all ${currentMode === 'custom_cycle' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-blue-300'}">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm"><i data-lucide="edit" class="w-5 h-5 text-blue-600"></i></div>
                        <div class="text-left">
                            <h4 class="font-bold">Custom Routine</h4>
                            <p class="text-xs opacity-70">Your uploaded or edited plan.</p>
                        </div>
                    </div>
                    ${currentMode === 'custom_cycle' ? '<i data-lucide="check-circle-2" class="w-6 h-6 text-blue-600 fill-blue-100"></i>' : ''}
                </button>
            </div>
            
            <div id="routine-actions" class="flex gap-2 mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                <button id="import-routine-btn-new" class="flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-800 text-sm font-bold rounded-lg hover:bg-gray-200">Import JSON</button>
                <button id="export-routine-btn-new" class="flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-800 text-sm font-bold rounded-lg hover:bg-gray-200">Export PDF</button>
            </div>
        `;
        
        routineContainer.innerHTML = routineHtml;
        
        // Add Listeners with Safety Confirmation
        document.getElementById('set-foundation-routine-btn').addEventListener('click', () => {
            showConfirmationModal(
                "Switch Routine?", 
                "Are you sure you want to switch to the FOUNDATION Routine? Your current schedule will be replaced.", 
                () => {
                    data.settings.planMode = 'foundation_cycle';
                    data.settings.customCyclePlan = JSON.parse(JSON.stringify(FOUNDATION_ROUTINE));
                    
                    const todayStr = getLocalDateString();
                    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowStr = getLocalDateString(tomorrow);

                    if(data.dailyPlan[todayStr]) delete data.dailyPlan[todayStr];
                    if(data.dailyPlan[tomorrowStr]) delete data.dailyPlan[tomorrowStr];
                    
                    saveData(); 
                    renderImportExportPage(); 
                    renderHomePage();
                    showUndoToast("✅ Foundation Routine Activated!", () => {});
                }
            );
        });
        
        document.getElementById('set-railway-routine-btn').addEventListener('click', () => {
            showConfirmationModal(
                "Switch Routine?", 
                "Are you sure you want to switch to the RAILWAY Routine? Your current schedule will be replaced.", 
                () => {
                    data.settings.planMode = 'railway_cycle';
                    data.settings.customCyclePlan = JSON.parse(JSON.stringify(RAILWAY_ROUTINE));
                    
                    const todayStr = getLocalDateString();
                    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowStr = getLocalDateString(tomorrow);

                    if(data.dailyPlan[todayStr]) delete data.dailyPlan[todayStr];
                    if(data.dailyPlan[tomorrowStr]) delete data.dailyPlan[tomorrowStr];

                    saveData(); 
                    renderImportExportPage(); 
                    renderHomePage();
                    showUndoToast("🚆 Railway Routine Activated!", () => {});
                }
            );
        });
        
        document.getElementById('set-custom-routine-btn').addEventListener('click', () => {
            data.settings.planMode = 'custom_cycle';
            delete data.dailyPlan[getLocalDateString()]; // Force regenerate
            saveData(); renderImportExportPage(); renderHomePage();
        });
        
        const importFileInput = document.getElementById('import-file-input');
        
        // --- FIXED IMPORTS HANDLERS ---
        // Routine Import
        const btnImportRoutine = document.getElementById('import-routine-btn-new');
        if(btnImportRoutine) btnImportRoutine.addEventListener('click', () => { importFileInput.dataset.importType = 'routine'; importFileInput.click(); });
        
        // Export Routine PDF
        const btnExportRoutine = document.getElementById('export-routine-btn-new');
        if(btnExportRoutine) btnExportRoutine.addEventListener('click', () => exportRoutine('pdf'));

        // Chapters Import (Custom Database)
        const btnImportChapters = document.getElementById('import-all-chapters-btn');
        if(btnImportChapters) {
             const newBtn = btnImportChapters.cloneNode(true);
             btnImportChapters.parentNode.replaceChild(newBtn, btnImportChapters);
             newBtn.addEventListener('click', () => { 
                importFileInput.dataset.importType = 'chapters'; 
                importFileInput.click(); 
            });
        }


        // --- 2. CHAPTERS TOGGLE LOGIC ---
        const chapDefBtn = document.getElementById('chapter-mode-default-btn');
        const chapCustBtn = document.getElementById('chapter-mode-custom-btn');
        const chapCustContent = document.getElementById('chapter-custom-content');

        const updateChapterUI = (mode) => {
            if (mode === 'default') {
                chapDefBtn.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white', 'shadow-sm');
                chapDefBtn.classList.remove('text-gray-500');
                chapCustBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white', 'shadow-sm');
                chapCustBtn.classList.add('text-gray-500');
                chapCustContent.classList.add('hidden'); 
            } else {
                chapCustBtn.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white', 'shadow-sm');
                chapCustBtn.classList.remove('text-gray-500');
                chapDefBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white', 'shadow-sm');
                chapDefBtn.classList.add('text-gray-500');
                chapCustContent.classList.remove('hidden');
            }
        };
        
        updateChapterUI('default');

        chapDefBtn.addEventListener('click', () => updateChapterUI('default'));
        chapCustBtn.addEventListener('click', () => updateChapterUI('custom'));

        lucide.createIcons();
    };

    const renderCalendarPage = (monthOffset = 0) => {
         const container = document.getElementById('calendar-view');
         const today = new Date();
         const date = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
         const month = date.getMonth(), year = date.getFullYear();
         const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
         const daysInMonth = new Date(year, month + 1, 0).getDate();
         const locale = data.settings.language === 'hi' ? 'hi-IN' : 'en-US';
         const events = {};
         // Updated: Flatten chapters directly
         (data.subjects || []).flatMap(s => s.chapters || []).forEach(c => { if (c.dateCompleted) { events[c.dateCompleted] = events[c.dateCompleted] || []; events[c.dateCompleted].push({type: 'completed'}); } });
         let html = `<div class="flex items-center justify-between mb-4"><button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-left"></i></button><h3 class="font-bold text-lg">${date.toLocaleString(locale, { month: 'long' })} ${year}</h3><button id="next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1">`;
         for(let i=0; i < firstDay; i++) html += `<div></div>`;
         for(let day=1; day <= daysInMonth; day++) {
            const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = getLocalDateString(today) === fullDate;
            const dotHtml = events[fullDate] ? `<div class="w-1.5 h-1.5 bg-green-500 rounded-full"></div>` : '';
            html += `<div class="h-12 flex flex-col items-center justify-center rounded-lg ${isToday ? 'bg-primary text-white font-bold' : 'bg-gray-50 dark:bg-gray-800/50 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer'} relative text-sm" data-date="${fullDate}"><span>${day}</span><div class="absolute bottom-1.5 flex gap-1">${dotHtml}</div></div>`;
         }
         html += `</div>`;
         container.innerHTML = html;
         lucide.createIcons();
         container.querySelector('#prev-month')?.addEventListener('click', () => renderCalendarPage(monthOffset - 1));
         container.querySelector('#next-month')?.addEventListener('click', () => renderCalendarPage(monthOffset + 1));
         container.querySelectorAll('[data-date]').forEach(el => { if (el.dataset.date < getLocalDateString(new Date())) { el.addEventListener('click', () => openDateCompletionModal(el.dataset.date)); } });
    };
    
    const renderReportPage = () => {
        const container = document.getElementById('report-content-container');
        // Updated: Flatten chapters directly
        const allChapters = (data.subjects || []).flatMap(s => s.chapters || []);
        const total = allChapters.length; const completed = allChapters.filter(c => c.status === 'Completed').length; const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        const generateDptReportHtml = () => {
            const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed' && t.details);
            if (allCompletedDpts.length === 0) { return `<h2 class="text-xl font-bold mb-4 mt-8">${_('dpt_report_title')}</h2><p class="text-center text-sm p-4">${_('no_dpt_data_report')}</p>`; }
            let totalCorrect = 0, totalAttempted = 0, totalTimeTaken = 0, totalQuestions = 0;
            allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; totalTimeTaken += (dpt.details.timeTaken || 0) * 60; totalQuestions += dpt.details.totalQ || 0; });
            const accuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
            const avgTimePerQ = totalAttempted > 0 ? (totalTimeTaken / totalAttempted).toFixed(1) : '0.0';
            
            let subjectBreakdownDptHtml = (data.subjects || []).map(subject => {
                if (DPT_EXCLUDED_SUBJECTS.includes(subject.id)) return '';
                const subjectDpts = Object.values(data.dpts[subject.id]?.chapters || {}).flat().filter(t => t.status === 'Completed');
                if(subjectDpts.length === 0) return '';
                
                let chapterDptHtml = Object.keys(data.dpts[subject.id].chapters).map(chapterId => {
                    const chapterDpts = data.dpts[subject.id].chapters[chapterId].filter(t => t.status === 'Completed');
                    if(chapterDpts.length === 0) return '';
                    const chapter = getChapterByIds(subject.id, chapterId);
                    return `<li class="ml-4 text-sm">- ${chapter ? chapter.name : 'Unknown Chapter'}: <strong>${chapterDpts.length} times</strong></li>`;
                }).join('');

                return `<div class="mb-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><p class="font-semibold">${_(subject.id)}</p><ul class="list-disc pl-5">${chapterDptHtml}</ul></div>`;
            }).join('');

            return `<h2 class="text-xl font-bold mb-4 mt-8">${_('dpt_report_title')}</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_dpt_completed')}</p><p class="text-2xl font-bold">${allCompletedDpts.length}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('overall_accuracy')}</p><p class="text-2xl font-bold text-accent">${accuracy}%</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('avg_time_per_q')}</p><p class="text-2xl font-bold text-warning">${avgTimePerQ}s</p></div></div><h3 class="text-lg font-bold mb-3 mt-6">${_('dpt_subject_breakdown')}</h3>${subjectBreakdownDptHtml}`;
        };
        
        const generateCompletedOtherTasksHtml = () => {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const thirtyDaysAgoStr = getLocalDateString(thirtyDaysAgo);

            const completedTasks = (data.otherTasks || [])
                .filter(task => task.status === 'Completed' && task.completedDate && task.completedDate >= thirtyDaysAgoStr)
                .sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));

            if (completedTasks.length === 0) {
                return `<h2 class="text-xl font-bold mb-4 mt-8">${_('completed_other_tasks')}</h2><p class="text-center text-sm p-4">${_('no_completed_other_tasks')}</p>`;
            }
            
            let tasksHtml = completedTasks.map(task => {
                const completedDate = new Date(task.completedDate).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-GB');
                return `<div class="flex items-start gap-3 py-2 border-b">
                    <i data-lucide="check-square" class="w-4 h-4 mt-1 text-gray-500"></i>
                    <div>
                        <p class="text-sm">${task.description}</p>
                        <p class="text-xs text-text-muted-light">Completed on: ${completedDate}</p>
                    </div>
                </div>`;
            }).join('');

            return `<h2 class="text-xl font-bold mb-4 mt-8">${_('completed_other_tasks')}</h2>${tasksHtml}`;
        };

        let subjectBreakdownHtml = (data.subjects || []).map(subject => {
            const allSubChapters = subject.chapters || []; if (allSubChapters.length === 0) return '';
            const subCompleted = allSubChapters.filter(c => c.status === 'Completed').length; const subPercentage = allSubChapters.length > 0 ? Math.round((subCompleted / allSubChapters.length) * 100) : 0;
            const completionCycle = subject.completionCount > 0 ? `<span class="text-xs font-semibold ml-2">${_('completion_cycle', {count: subject.completionCount})}</span>` : '';
            return `<div class="mb-4"><div class="flex justify-between items-center mb-1"><span class="font-semibold">${_(subject.id)}${completionCycle}</span><span>${subCompleted}/${allSubChapters.length} (${subPercentage}%)</span></div><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div class="h-2.5 rounded-full animated-progress-bar bg-green-500" style="width: ${subPercentage}%"></div></div></div>`;
        }).join('');
        let activityHtml = (data.activityLog || []).slice(0, 20).map(log => `<div class="flex items-start gap-3 py-2 border-b"><i data-lucide="${log.icon}" class="w-4 h-4 mt-1 text-primary"></i><div><p class="text-sm">${log.description}</p><p class="text-xs text-text-muted-light">${new Date(log.timestamp).toLocaleString()}</p></div></div>`).join('');
        if((data.activityLog || []).length === 0) activityHtml = `<p class="text-center text-sm p-4">${_('no_activity_log_report')}</p>`;
        container.innerHTML = `<div id="report-content" class="p-6 bg-card-light dark:bg-card-dark rounded-xl shadow-sm"><div class="text-center mb-6 border-b pb-4"><h1 class="text-2xl font-bold">${_('study_report')}</h1><p>${data.settings.studentName || 'Student'} - ${new Date().toLocaleDateString()}</p></div><h2 class="text-xl font-bold mb-3">${_('overall_summary')}</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_subjects')}</p><p class="text-2xl font-bold">${(data.subjects || []).length}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('total_chapters')}</p><p class="text-2xl font-bold">${total}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('chapters_completed')}</p><p class="text-2xl font-bold">${completed}</p></div><div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-center"><p class="text-sm">${_('progress')}</p><p class="text-2xl font-bold text-primary">${percentage}%</p></div></div><h2 class="text-xl font-bold mb-4 mt-8">${_('subject_breakdown')}</h2>${subjectBreakdownHtml}${generateDptReportHtml()}${generateCompletedOtherTasksHtml()}<h2 class="text-xl font-bold mb-4 mt-8">${_('recent_activity')}</h2>${activityHtml}</div>`;
        lucide.createIcons();
    };

    const renderAnalyticsPage = () => {
        // Updated: Flatten chapters directly
        const allChapters = (data.subjects || []).flatMap(s => s.chapters || []);
        const completedChapters = allChapters.filter(c => c.status === 'Completed');
        document.getElementById('metric-total-completed').textContent = completedChapters.length;
        const daysStudying = Math.max(1, (new Date() - new Date(data.appStartDate)) / 86400000);
        document.getElementById('metric-avg-per-day').textContent = (completedChapters.length / daysStudying).toFixed(1);
        const completionByDate = completedChapters.reduce((acc, chap) => { acc[chap.dateCompleted] = (acc[chap.dateCompleted] || 0) + 1; return acc; }, {});
        const bestDayEntry = Object.entries(completionByDate).sort((a,b) => b[1] - a[1])[0];
        document.getElementById('metric-best-day').textContent = bestDayEntry ? `${bestDayEntry[1]}` : '-';
        
        const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed' && t.details);
        let totalCorrect = 0, totalAttempted = 0;
        allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; });
        const dptAccuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
        document.getElementById('metric-total-dpt').textContent = allCompletedDpts.length;
        document.getElementById('metric-dpt-accuracy').textContent = `${dptAccuracy}%`;

        const isDark = data.settings.theme === 'dark';
        const textColor = getComputedStyle(document.body).getPropertyValue('color'); 
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        
        const chart1Ctx = document.getElementById('chapter-status-chart').getContext('2d');
        const notStarted = allChapters.length - completedChapters.length;
        if(allCharts.status) allCharts.status.destroy();
        allCharts.status = new Chart(chart1Ctx, { type: 'doughnut', data: { labels: [_('completed'), _('not_started')], datasets: [{ data: [completedChapters.length, notStarted], backgroundColor: ['#0ea5e9', '#f59e0b'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } } } } });
        
        const chart2Ctx = document.getElementById('weekly-productivity-chart').getContext('2d');
        const last7Days = [...Array(7)].map((_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return getLocalDateString(d); }).reverse();
        const weeklyData = last7Days.map(day => completionByDate[day] || 0);
        if(allCharts.weekly) allCharts.weekly.destroy();
        allCharts.weekly = new Chart(chart2Ctx, { type: 'bar', data: { labels: last7Days.map(d => new Date(d).toLocaleDateString(data.settings.language === 'hi' ? 'hi-IN' : 'en-US', { weekday: 'short' })), datasets: [{ label: _('completed_chapters_chart'), data: weeklyData, backgroundColor: '#8b5cf6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } } } });
        
        const chart3Ctx = document.getElementById('subject-progress-chart').getContext('2d');
        // Updated: Use unified chapters
        const subjectProgressData = (data.subjects || []).map(s => { const chapters = s.chapters || []; return chapters.length > 0 ? (chapters.filter(c => c.status === 'Completed').length / chapters.length) * 100 : 0; });
        if(allCharts.subject) allCharts.subject.destroy();
        allCharts.subject = new Chart(chart3Ctx, { type: 'bar', data: { labels: data.subjects.map(s => _(s.id)), datasets: [{ label: _('progress')+' (%)', data: subjectProgressData, backgroundColor: '#0ea5e9', borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, ticks: { color: textColor }, grid: { color: gridColor } }, y: { ticks: { color: textColor }, grid: { display: false } } } } });

        const dptChartCtx = document.getElementById('dpt-performance-chart').getContext('2d');
        const dptPerfLabels = []; const dptPerfData = [];
        (data.subjects || []).forEach(subject => {
            if(DPT_EXCLUDED_SUBJECTS.includes(subject.id)) return;
            const subjectDpts = Object.values(data.dpts[subject.id]?.chapters || {}).flat().filter(t => t.status === 'Completed' && t.details);
            if (subjectDpts.length > 0) {
                let subCorrect = 0, subAttempted = 0;
                subjectDpts.forEach(d => { subCorrect += d.details.correct || 0; subAttempted += d.details.attempted || 0; });
                const subAccuracy = subAttempted > 0 ? ((subCorrect / subAttempted) * 100) : 0;
                dptPerfLabels.push(_(subject.id));
                dptPerfData.push(subAccuracy.toFixed(1));
            }
        });
        if(allCharts.dptPerf) allCharts.dptPerf.destroy();
        allCharts.dptPerf = new Chart(dptChartCtx, { type: 'bar', data: { labels: dptPerfLabels, datasets: [{ label: 'Accuracy (%)', data: dptPerfData, backgroundColor: '#10b981', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { color: gridColor } } } } });
        
        const dptChapterCtx = document.getElementById('dpt-chapter-chart').getContext('2d');
        const chapterDptData = {};
        (data.subjects || []).forEach(subject => {
            if(DPT_EXCLUDED_SUBJECTS.includes(subject.id)) return;
            const completedChapterDpts = Object.entries(data.dpts[subject.id]?.chapters || {}).map(([chapterId, tests]) => ({ chapterId, count: tests.filter(t => t.status === 'Completed').length })).filter(item => item.count > 0);
            if(completedChapterDpts.length > 0) {
                chapterDptData[subject.id] = completedChapterDpts;
            }
        });

        const chartLabels = [];
        const chartDatasets = (data.subjects || []).filter(s => chapterDptData[s.id]).map((subject, index) => {
            const hue = (index * 60) % 360;
            const color = `hsl(${hue}, 70%, 50%)`;
            const subjectChapterData = chapterDptData[subject.id];
            const data = [];
            subjectChapterData.forEach(item => {
                const chapter = getChapterByIds(subject.id, item.chapterId);
                const label = `${_(subject.id)} - ${chapter ? chapter.name : 'Unknown'}`;
                if(!chartLabels.includes(label)) chartLabels.push(label);
                data[chartLabels.indexOf(label)] = item.count;
            });
            return { label: _(subject.id), data, backgroundColor: color, borderRadius: 4 };
        });

        if(allCharts.dptChapter) allCharts.dptChapter.destroy();
        allCharts.dptChapter = new Chart(dptChapterCtx, {
            type: 'bar',
            data: { labels: chartLabels, datasets: chartDatasets },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'top', labels: { color: textColor } } },
                scales: {
                    x: { beginAtZero: true, stacked: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } },
                    y: { stacked: true, ticks: { color: textColor }, grid: { display: false } }
                }
            }
        });
    };

    const renderSettingsPage = () => {
        document.getElementById('student-name-input').value = data.settings.studentName || '';
        document.getElementById('language-select').value = data.settings.language || 'hi';
        document.getElementById('background-style-select').value = data.settings.backgroundStyle || 'constellation';
        document.getElementById('bg-color-start').value = data.settings.customThemeColors.start || '#cffafe';
        document.getElementById('bg-color-end').value = data.settings.customThemeColors.end || '#e0e7ff';
        
        const colors = data.settings.customThemeColors;
        document.getElementById('color-text-light').value = colors.textLight || '#020617';
        document.getElementById('color-border-light').value = colors.borderLight || '#e5e7eb';
        document.getElementById('color-text-dark').value = colors.textDark || '#f1f5f9';
        document.getElementById('color-border-dark').value = colors.borderDark || '#374151';

        const planMode = data.settings.planMode || 'auto';
        document.querySelector(`input[name="plan-mode"][value="${planMode}"]`).checked = true;
        const customCycleContainer = document.getElementById('custom-cycle-plan-container');
        if (planMode === 'custom_cycle') {
            customCycleContainer.classList.remove('hidden');
            const cycleSelector = document.getElementById('custom-cycle-subject-selector');
            const dayNames = [ _('sunday'), _('monday'), _('tuesday'), _('wednesday'), _('thursday'), _('friday'), _('saturday'), `${_('sunday')} (${_('week')} 2)`, `${_('monday')} (${_('week')} 2)`, `${_('tuesday')} (${_('week')} 2)`, `${_('wednesday')} (${_('week')} 2)`, `${_('thursday')} (${_('week')} 2)`, `${_('friday')} (${_('week')} 2)`, `${_('saturday')} (${_('week')} 2)` ];
            // Updated: Removed source type checkboxes, now just subject checkboxes
            cycleSelector.innerHTML = [...Array(14).keys()].map(i => `<div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><h4 class="font-bold text-center mb-3">${dayNames[i]}</h4><div class="space-y-2">${(data.subjects || []).map(s => `<label class="flex items-center gap-2 text-sm cursor-pointer p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50"><input type="checkbox" class="custom-cycle-subject-checkbox form-checkbox h-4 w-4 text-primary" data-day="${i}" value="${s.id}" ${((data.settings.customCyclePlan?.[i] || []).includes(s.id)) ? 'checked' : ''}><span>${_(s.id)}</span></label>`).join('')}</div></div>`).join('');
            lucide.createIcons();
        } else { customCycleContainer.classList.add('hidden'); }
        const dptPlanMode = data.settings.dptPlanMode || 'auto';
        document.querySelector(`input[name="dpt-plan-mode"][value="${dptPlanMode}"]`).checked = true;
        const customDptContainer = document.getElementById('custom-dpt-plan-container');
        if (dptPlanMode === 'custom_cycle') {
            customDptContainer.classList.remove('hidden');
            const dptCycleSelector = document.getElementById('dpt-custom-cycle-subject-selector');
            const dayNames = [ _('sunday'), _('monday'), _('tuesday'), _('wednesday'), _('thursday'), _('friday'), _('saturday'), `${_('sunday')} (${_('week')} 2)`, `${_('monday')} (${_('week')} 2)`, `${_('tuesday')} (${_('week')} 2)`, `${_('wednesday')} (${_('week')} 2)`, `${_('thursday')} (${_('week')} 2)`, `${_('friday')} (${_('week')} 2)`, `${_('saturday')} (${_('week')} 2)` ];
            dptCycleSelector.innerHTML = [...Array(14).keys()].map(i => `<div class="p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg"><h4 class="font-bold text-center mb-3">${dayNames[i]}</h4><div class="space-y-2 max-h-60 overflow-y-auto">${(data.subjects || []).filter(s => !DPT_EXCLUDED_SUBJECTS.includes(s.id)).map(s => `<label class="flex items-center gap-2 text-sm cursor-pointer p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50"><input type="checkbox" class="custom-dpt-subject-checkbox form-checkbox h-4 w-4 text-primary" data-day="${i}" value="${s.id}" ${((data.settings.dptCyclePlan?.[i] || []).includes(s.id)) ? 'checked' : ''}><span>${_(s.id)}</span></label>`).join('')}</div></div>`).join('');
        } else { customDptContainer.classList.add('hidden'); }

        // --- RENDER ADVANCED ROUTINE UI (Added by Rayen) ---
        renderAdvancedRoutineUI();
};

const renderAdvancedRoutineUI = () => {
        // FIX: Advanced Routine Dropdown Populating Logic (100% Fix)
        const select = document.getElementById('adv-routine-subject-select');
        const list = document.getElementById('adv-routine-list');
        
        if (!select || !list) return;

        // 1. Populate Dropdown forcefully
        // Using a cleaner approach to ensure options are always generated
        const subjects = data.subjects || [];
        let optionsHtml = `<option value="">-- Select Subject --</option>`;
        
        subjects.forEach(s => {
            // Using translated name if available
            const name = _(s.id); 
            optionsHtml += `<option value="${s.id}">${name}</option>`;
        });
        
        // Only update if length differs or empty (Optimization)
        if (select.children.length <= 1) {
            select.innerHTML = optionsHtml;
        }

        // 2. Render List
        if (!data.settings.customSubjectRoutine) { data.settings.customSubjectRoutine = []; }
        const routines = data.settings.customSubjectRoutine;
        
        if (routines.length === 0) {
            list.innerHTML = `<p class="text-xs text-center text-gray-400 py-2">No custom routines added yet.</p>`;
        } else {
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            list.innerHTML = routines.map((r, index) => {
                const daysStr = (r.days || []).map(d => `<span class="px-1.5 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 text-[10px] font-bold border border-indigo-200 dark:border-indigo-800">${dayNames[d] || 'Day'}</span>`).join(' ');
                const activeClass = r.active ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-200 text-gray-400 dark:bg-gray-700 dark:text-gray-500';
                
                return `<div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-lg shadow-sm mb-2 animate-fadeIn">
                    <div>
                        <p class="font-bold text-sm flex items-center gap-2">${r.name} ${r.active ? '<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>' : ''}</p>
                        <div class="flex flex-wrap gap-1 mt-1.5">${daysStr}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="toggle-adv-routine-btn p-2 rounded-lg transition-colors ${activeClass}" data-index="${index}" title="${r.active ? 'Deactivate' : 'Activate'}">
                            <i data-lucide="${r.active ? 'power' : 'power-off'}" class="w-4 h-4"></i>
                        </button>
                        <button class="delete-adv-routine-btn p-2 rounded-lg bg-red-50 text-red-500 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/40 transition-colors" data-index="${index}" title="Delete">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }
        lucide.createIcons();
    };
const getStatusClass = (status) => ({ 'Completed': 'bg-green-500/20 text-green-700 dark:text-green-300'}[status] || 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300');
    
    // ROBUST MODAL LOGIC (Fixes broken popups)
    const showModal = (id) => {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove('hidden');
            el.classList.add('flex');
            // Ensure z-index is top
            el.style.zIndex = '10000';
        }
    };
    const hideModal = (id) => {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove('flex');
            el.classList.add('hidden');
        }
    };

    // OPTIMIZED ANIMATION (Fixes Heating)
    function initConstellationEffect() {
        initCanvas();
        // Super Light Logic: Only 6-10 nodes to prevent heating
        const width = window.innerWidth;
        let numberOfNodes = width < 768 ? 6 : 10; 

        for (let i = 0; i < numberOfNodes; i++) {
            backgroundElements.push({
                x: Math.random() * particleCanvas.width,
                y: Math.random() * particleCanvas.height,
                vx: (Math.random() - 0.5) * 0.1, // Slow movement
                vy: (Math.random() - 0.5) * 0.1, 
                radius: Math.random() * 1.5 + 0.5
            });
        }
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        animateConstellation();
    }

    const renderExamsPage = () => {
        // UI Update for Filter Buttons
        document.querySelectorAll('.exam-filter-btn').forEach(btn => {
            if(btn.dataset.filter === currentExamFilter) {
                btn.classList.add('active', 'bg-primary', 'text-white');
                btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
            } else {
                btn.classList.remove('active', 'bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
            }
        });

        const container = document.getElementById('exams-list-container');
        const today = getLocalDateString();
        let examsToRender = [...(data.exams || [])];
        let emptyMessage = _('no_exams_added');
        if (currentExamFilter === 'upcoming') { examsToRender = examsToRender.filter(exam => exam.examDate && exam.examDate >= today); emptyMessage = _('no_upcoming_exams_filter'); } 
        else if (currentExamFilter === 'applied') { examsToRender = examsToRender.filter(exam => exam.status === 'Applied'); emptyMessage = _('no_applied_forms_filter'); } 
        else if (currentExamFilter === 'history') { examsToRender = examsToRender.filter(exam => exam.examDate && exam.examDate < today); emptyMessage = _('no_history_exams'); }
        
        if (examsToRender.length === 0) { container.innerHTML = `<div class="text-center p-8 bg-card-light dark:bg-card-dark rounded-xl"><i data-lucide="file-text" class="w-12 h-12 mx-auto text-text-muted-light mb-4"></i><h3 class="font-bold">${emptyMessage}</h3></div>`; lucide.createIcons(); return; }
        
        container.innerHTML = examsToRender.sort((a,b) => new Date(b.applicationDate || 0) - new Date(a.applicationDate || 0)).map(exam => {
            const locale = data.settings.language === 'hi' ? 'hi-IN' : 'en-GB';
            const appDate = exam.applicationDate ? new Date(exam.applicationDate).toLocaleDateString(locale) : 'N/A';
            const exDate = exam.examDate ? new Date(exam.examDate).toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
            const daysRemaining = exam.examDate ? Math.ceil((new Date(exam.examDate) - new Date()) / 86400000) : null;
            const statusColors = { "Applied": "bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300", "Admit Card Out": "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300", "Exam Done": "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300", "Result Out": "bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300" };
            const receiptLink = exam.receipt ? `<a href="${exam.receipt}" target="_blank" download="receipt" class="flex items-center gap-1 text-xs font-semibold text-primary hover:underline"><i data-lucide="paperclip" class="w-3 h-3"></i> ${_('receipt_attached')}</a>` : '';
            const borderColorClass = exam.examDate && exam.examDate < today ? 'border-gray-400/50' : 'border-primary/50';
            
            // Format notes to have clickable links
            let formattedNotes = exam.notes || 'No notes.';
            formattedNotes = formattedNotes.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 hover:underline break-all">$1</a>');

            return `<div class="p-4 rounded-lg bg-card-light dark:bg-card-dark shadow-sm border-l-4 ${borderColorClass} animate-list-item"><div class="flex flex-col md:flex-row justify-between items-start gap-3"><div class="flex-grow"><h3 class="font-bold text-lg">${exam.name}</h3><div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs mt-1"><span>${_('applied_on')}: <strong>${appDate}</strong></span><span>${_('exam_date')}: <strong>${exDate}</strong></span>${receiptLink ? `<span>${receiptLink}</span>` : ''}</div><p class="text-sm mt-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-md whitespace-pre-wrap font-sans">${formattedNotes}</p></div><div class="flex flex-col items-start md:items-end gap-2 w-full md:w-auto self-stretch"><div class="flex items-center gap-2"><span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColors[exam.status]}">${_(('status_'+exam.status).toLowerCase().replace(/\s/g, '_'))}</span><div class="flex gap-1"><button class="edit-exam-btn p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200" data-exam-id="${exam.id}"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button class="delete-exam-btn p-2 rounded-lg bg-red-100 dark:bg-red-900/50 hover:bg-red-200" data-exam-id="${exam.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i></button></div></div>${daysRemaining !== null && daysRemaining >= 0 ? `<div class="text-right mt-auto"><div class="text-2xl font-bold text-primary">${daysRemaining}</div><p class="text-xs -mt-1">${_('days_remaining')}</p></div>` : ''}</div></div></div>`;
        }).join('');
        lucide.createIcons();
    };

    const showAddExamModal = (examId = null) => {
        const form = document.getElementById('add-exam-form'); 
        form.reset();
        const modalTitle = document.getElementById('exam-modal-title');
        const examIdInput = document.getElementById('exam-id');
        
        if (examId) {
            const exam = data.exams.find(e => e.id === examId); 
            if (!exam) return;
            modalTitle.textContent = _('edit_exam'); 
            examIdInput.value = exam.id;
            document.getElementById('exam-name').value = exam.name; 
            document.getElementById('application-date').value = exam.applicationDate;
            document.getElementById('exam-date').value = exam.examDate; 
            document.getElementById('exam-status').value = exam.status;
            document.getElementById('exam-notes').value = exam.notes;
        } else { 
            modalTitle.textContent = _('add_new_exam'); 
            examIdInput.value = ''; 
        }
        showModal('add-exam-modal');
    };

    const saveExam = () => {
        const id = document.getElementById('exam-id').value;
        // Logic simplified: No file reading anymore
        const examData = { 
            name: document.getElementById('exam-name').value.trim(), 
            applicationDate: document.getElementById('application-date').value, 
            examDate: document.getElementById('exam-date').value, 
            status: document.getElementById('exam-status').value, 
            notes: document.getElementById('exam-notes').value.trim() 
        };
        
        if (!examData.name) return;

        if (id) {
            const index = data.exams.findIndex(e => e.id === id);
            if (index !== -1) { 
                data.exams[index] = { ...data.exams[index], ...examData }; 
                logActivity('edit-3', `Exam updated: "${examData.name}"`); 
            }
        } else { 
            examData.id = `exam-${Date.now()}`; 
            data.exams.push(examData); 
            logActivity('briefcase', `Exam added: "${examData.name}"`); 
        }
        saveData(); 
        renderExamsPage(); 
        renderHomePage(); 
        hideModal('add-exam-modal');
    };

    const deleteExam = (examId) => {
        const exam = data.exams.find(e => e.id === examId);
        if (exam) { showConfirmationModal(_('delete_exam') + '?', `Are you sure you want to delete "${exam.name}"?`, () => { logActivity('trash-2', `Exam deleted: "${exam.name}"`); data.exams = data.exams.filter(e => e.id !== examId); saveData(); renderExamsPage(); renderHomePage(); }); }
    };

    const renderUpcomingExamsOnDashboard = () => {
        const container = document.getElementById('dashboard-exams-container');
        const today = getLocalDateString();
        
        // Filter and get TOP 4 exams
        const upcomingExams = (data.exams || []).filter(exam => exam.examDate && exam.examDate >= today).sort((a,b) => new Date(a.examDate) - new Date(b.examDate)).slice(0, 4); 

        // Container Style
        container.className = "md:col-span-2 p-3 rounded-xl shadow-lg animate-fadeIn border border-white/20 relative overflow-hidden bg-gradient-to-br from-white/40 to-white/10 dark:from-white/5 dark:to-white/0 backdrop-blur-md flex flex-col";
        
        let content = `<h2 class="text-sm font-black mb-2 flex items-center gap-2 text-gray-700 dark:text-gray-200 uppercase tracking-wider relative z-10"><i data-lucide="timer" class="w-4 h-4"></i> Upcoming Exams</h2>`;

        if (upcomingExams.length === 0) { 
            content += `
                <div class="flex-grow flex flex-col items-center justify-center py-2 relative z-10">
                    <p class="text-[10px] font-bold text-gray-400 dark:text-gray-500 mb-2 uppercase tracking-wide">No exams scheduled</p>
                    <button id="dashboard-add-exam-btn-2" class="px-4 py-2 text-xs font-bold text-white bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full shadow-lg hover:shadow-cyan-500/30 transition-all transform hover:scale-105">Add New Exam</button>
                </div>`; 
        } else {
            // GRID LAYOUT: 4 Columns (1 Line) - Strict Requirement
            content += `<div class="grid grid-cols-4 gap-2 relative z-10 h-full overflow-x-auto no-scrollbar">`;
            
            const palettes = [
                "bg-cyan-500/10 border-cyan-500/30 text-cyan-600 dark:text-cyan-400",
                "bg-violet-500/10 border-violet-500/30 text-violet-600 dark:text-violet-400",
                "bg-emerald-500/10 border-emerald-500/30 text-emerald-600 dark:text-emerald-400",
                "bg-rose-500/10 border-rose-500/30 text-rose-600 dark:text-rose-400"
            ];

            upcomingExams.forEach((exam, index) => {
                const daysRemaining = Math.ceil((new Date(exam.examDate) - new Date()) / 86400000);
                
                let cardStyle = "";
                let dayDisplay = "";
                let subLabel = "Days";

                if (daysRemaining === 0) {
                    cardStyle = "bg-red-600 border-red-500 text-white animate-pulse";
                    dayDisplay = "!!";
                    subLabel = "TODAY";
                } else if (daysRemaining === 1) {
                    cardStyle = "bg-orange-500 border-orange-400 text-white";
                    dayDisplay = "01";
                    subLabel = "TMRW";
                } else if (daysRemaining === 2) {
                    cardStyle = "bg-yellow-400 border-yellow-300 text-black";
                    dayDisplay = "02";
                    subLabel = "SOON";
                } else {
                    cardStyle = `${palettes[index % 4]} border shadow-sm hover:bg-white/20`;
                    dayDisplay = String(daysRemaining).padStart(2, '0');
                }

                // Super Big Numbers
                const numSize = daysRemaining > 99 ? "text-2xl" : "text-3xl";

                content += `
                <div class="flex flex-col items-center justify-between p-1.5 rounded-xl border ${cardStyle} min-h-[85px] w-full">
                    <span class="${numSize} font-black leading-none tracking-tighter mt-1">${dayDisplay}</span>
                    <span class="text-[9px] font-bold opacity-80 uppercase tracking-wide leading-tight">${subLabel}</span>
                    <p class="text-[9px] font-medium truncate w-full text-center border-t border-current/20 pt-1 mt-1 opacity-90 leading-tight" title="${exam.name}">${exam.name}</p>
                </div>`;
            });
            content += `</div>`;
        }
        
        container.innerHTML = content;
        
        setTimeout(() => {
            document.getElementById('dashboard-add-exam-btn-2')?.addEventListener('click', (e) => {
                e.preventDefault(); e.stopPropagation();
                navigateTo('exams');
            });
        }, 0);

        lucide.createIcons();
    };

    // Updated: Removed sourceType param
    const showChapterModal = (subjectId, chapterId) => {
        const chapter = getChapterByIds(subjectId, chapterId); if (!chapter) return;
        document.getElementById('chapter-modal-title').textContent = chapter.name;
        document.querySelectorAll('#chapter-status-buttons button').forEach(btn => { btn.classList.toggle('active', btn.dataset.status === chapter.status); });
        document.getElementById('chapter-notes-textarea').value = chapter.notes || '';
        document.getElementById('chapter-priority-revision-checkbox').checked = chapter.priorityRevision || false;
        renderScheduledRevisions(chapter);
        const addRevBtn = document.getElementById('add-manual-revision-btn'); addRevBtn.dataset.chapterId = chapterId; addRevBtn.dataset.subjectId = subjectId;
        const saveBtn = document.getElementById('save-chapter-details-btn'); saveBtn.dataset.subjectId = subjectId; saveBtn.dataset.chapterId = chapterId;
        const deleteBtn = document.getElementById('delete-chapter-details-btn'); deleteBtn.dataset.subjectId = subjectId; deleteBtn.dataset.chapterId = chapterId;
        showModal('chapter-modal');
    };

    // Updated: Removed sourceType param
    const showAddChapterModal = (subjectId) => {
        document.getElementById('add-chapter-form').reset();
        document.getElementById('add-chapter-subject-id').value = subjectId;
        showModal('add-chapter-modal');
    };
    
    const showConfirmationModal = (title, message, onConfirm) => {
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-message').textContent = message;
        const confirmBtn = document.getElementById('confirm-action');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.addEventListener('click', () => { onConfirm(); hideModal('confirmation-modal'); }, { once: true });
        document.getElementById('confirm-cancel').addEventListener('click', () => hideModal('confirmation-modal'), { once: true });
        showModal('confirmation-modal');
    };

    // Updated: Removed sourceType param, pushes to unified chapters array
    const addNewChapter = (subjectId, chapterName) => {
        chapterName = chapterName.trim(); if (!subjectId || !chapterName) return;
        const subject = getSubjectById(subjectId);
        if (subject) {
            const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterName, status: 'Not Started', dateAdded: getLocalDateString(), notes: '', priorityRevision: false, revisions: [] };
            subject.chapters.push(newChapter);
            logActivity('plus-circle', `New chapter added to ${_(subject.id)}: "${chapterName}"`);
            saveData(); renderSubjectsPage(); hideModal('add-chapter-modal');
        }
    };
    
    const updateChapterStatus = (subjectId, chapterId, newStatus, isUndo = false, completionDate = null) => {
        const chapter = getChapterByIds(subjectId, chapterId); if (!chapter) return;
        const oldStatus = chapter.status; if (oldStatus === newStatus) return;
        chapter.status = newStatus;
        
        const todayStr = getLocalDateString();
        // Ensure plan exists
        if (!data.dailyPlan[todayStr]) {
             data.dailyPlan[todayStr] = { tasks: {}, completedSubjects: [], manualTasks: [], completedTasks: [] };
        }
        const dailyPlanData = data.dailyPlan[todayStr];

        if (newStatus === 'Completed') {
            chapter.dateCompleted = completionDate || todayStr;
            if (!REVISION_EXCLUDED_SUBJECTS.includes(subjectId)) { scheduleRevisions(chapter); }
            
            if (!isUndo) {
                if (!data.gamification.completedHistory.includes(chapter.dateCompleted)) { data.gamification.completedHistory.push(chapter.dateCompleted); }
                logActivity('check-circle', `Chapter completed: "${chapter.name}"`);
                checkAllGamification();
                
                lastAction = { type: 'complete', data: { subjectId, chapterId, oldStatus }, undo: () => updateChapterStatus(subjectId, chapterId, oldStatus, true) };
                showUndoToast(_('chapter_completed_msg'), lastAction.undo);
                
                // --- ULTRA SYNC LOGIC ---
                // 1. Mark the SUBJECT as done for today immediately. This hides it from "Today's Plan".
                markSubjectAsDoneForToday(subjectId);
                
                // 2. Add to "Completed Tasks" dropdown, even if it wasn't the specific task originally scheduled.
                // This ensures "Completed Task" list grows regardless of where you completed it (Subject Page or Dashboard).
                dailyPlanData.completedTasks = dailyPlanData.completedTasks || [];
                
                // Check if already added to avoid duplicates
                const alreadyLogged = dailyPlanData.completedTasks.some(t => t.chapterId === chapterId && t.subjectId === subjectId);
                
                if (!alreadyLogged) {
                    dailyPlanData.completedTasks.push({ 
                        type: 'chapter', 
                        subjectId, 
                        chapterId 
                    });
                }

                // 3. Unlock DPT if applicable
                if (!DPT_EXCLUDED_SUBJECTS.includes(subjectId)) {
                    const nextDpt = findNextPendingDptForChapter(subjectId, chapterId);
                    if (nextDpt) {
                        data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr] || [];
                        if (!data.dailyDptPlan[todayStr].some(d => d.subjectId === subjectId && d.chapterId === chapterId && d.testId === nextDpt.testId)) {
                            data.dailyDptPlan[todayStr].unshift({ ...nextDpt, isTriggered: true });
                            logActivity('target', `DPT Unlocked: ${_(subjectId)} #${nextDpt.testId}`);
                        }
                    }
                }
            }
        } else { 
            // UNDO Logic: Bring back to dashboard
            delete chapter.dateCompleted; 
            chapter.revisions = []; 
            
            if (dailyPlanData) {
                // Unmark subject completion
                dailyPlanData.completedSubjects = (dailyPlanData.completedSubjects || []).filter(id => id !== subjectId);
                // Remove from completed dropdown list
                dailyPlanData.completedTasks = (dailyPlanData.completedTasks || []).filter(t => t.chapterId !== chapterId);
                
                // Restore task slot if missing
                if (!dailyPlanData.tasks[subjectId]) {
                    dailyPlanData.tasks[subjectId] = { subjectId, chapterId, note: chapter.notes || null };
                }
            }
            if (!isUndo) { logActivity('rotate-ccw', `Status reverted: "${chapter.name}"`); } 
        }
        
        saveData(); 
        // Force refresh all UI components to reflect changes instantly
        updateAllUI(); 
    };

    // Updated: Removed sourceType param
    const updateRevisionStatus = (subjectId, chapterId, revisionDate, isComplete) => {
        const chapter = getChapterByIds(subjectId, chapterId); if (!chapter || !chapter.revisions) return;
        const revision = chapter.revisions.find(r => r.date === revisionDate);
        if (revision) {
            revision.status = isComplete ? 'Completed' : 'Pending';
            logActivity('repeat', `Revision for "${chapter.name}" marked as ${revision.status}.`);
            if(isComplete) {
                const todayStr = getLocalDateString();
                data.dailyPlan[todayStr] = data.dailyPlan[todayStr] || { tasks: {}, completedSubjects: [], manualTasks: [], completedTasks: [] };
                // Removed sourceType
                data.dailyPlan[todayStr].completedTasks.push({ type: 'revision', subjectId, chapterId, revisionDate });
            }
            saveData(); renderHomePage();
        }
    };

    const saveChapterDetails = (subjectId, chapterId) => {
        const chapter = getChapterByIds(subjectId, chapterId); if (!chapter) return;
        const newStatus = document.querySelector('#chapter-status-buttons button.active').dataset.status;

        if (newStatus === 'Postpone') {
            hideModal('chapter-modal');
            openPostponeModal(subjectId, chapterId);
            return;
        }

        // Logic sync included in updateChapterStatus now
        updateChapterStatus(subjectId, chapterId, newStatus);
        
        chapter.notes = document.getElementById('chapter-notes-textarea').value;
        chapter.priorityRevision = document.getElementById('chapter-priority-revision-checkbox').checked;
        saveData(); 
        
        // Fast UI Update
        hideModal('chapter-modal');
        updateAllUI(); 
    };

    // Updated: Removed sourceType param
    const confirmDeleteChapter = (subjectId, chapterId) => {
        const chapter = getChapterByIds(subjectId, chapterId); if (!chapter) return;
        hideModal('chapter-modal');
        showConfirmationModal(_('delete_chapter')+'?', `Are you sure you want to delete "${chapter.name}"? This action cannot be undone.`, () => {
            const subject = getSubjectById(subjectId);
            subject.chapters = subject.chapters.filter(c => c.id !== chapterId);
            logActivity('trash-2', `Chapter deleted: "${chapter.name}"`);
            saveData(); renderSubjectsPage();
        });
    };
    
    const scheduleRevisions = (chapter) => {
        // CHANGED: Only 8th Day and 23rd Day revisions as requested
        const revisionCycles = [8, 23]; 
        
        // Remove old auto revisions to avoid duplicates if re-completed
        chapter.revisions = chapter.revisions.filter(r => r.type === 'manual');
        
        revisionCycles.forEach(days => {
            const revisionDate = new Date(chapter.dateCompleted); 
            revisionDate.setDate(revisionDate.getDate() + days);
            // Added 'cycle' property to identify which revision it is (for coloring)
            chapter.revisions.push({ 
                date: getLocalDateString(revisionDate), 
                status: 'Pending', 
                type: 'auto',
                cycle: days 
            });
        });
    };
const resetApp = () => showConfirmationModal(_('reset_app')+'?', _('reset_all_data'), () => { localStorage.removeItem(DB_KEY); window.location.reload(); });
        
        const exportData = (dataType) => {
            let dataToExport, fileName;
            switch(dataType) {
                case 'full':
                    dataToExport = data;
                    fileName = `study_tracker_backup_${getLocalDateString()}.json`;
                    break;
                case 'exams':
                    dataToExport = data.exams || [];
                    fileName = `study_tracker_exams_${getLocalDateString()}.json`;
                    break;
                case 'urls':
                    dataToExport = data.urls || [];
                    fileName = `study_tracker_urls_${getLocalDateString()}.json`;
                    break;
            }
            if(!dataToExport) return;
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = fileName;
            a.click(); URL.revokeObjectURL(url);
        };
        
        const handleFileUpload = (event) => {
             // Import Type is stored in the input element itself
             const importType = event.target.dataset.importType;
             const file = event.target.files[0];
             
             if (!file) return;
             if (!importType) { alert("System Error: Import type missing."); return; }

             const reader = new FileReader();
             reader.onload = (e) => {
                 try {
                     const jsonString = e.target.result;
                     const importedData = JSON.parse(jsonString);
                     
                     // Direct Routing
                     if (importType === 'full_backup') {
                         importFullBackup(importedData, jsonString);
                     } else if (importType === 'chapters') {
                         importAllChapters(importedData);
                     } else if (importType === 'routine') {
                         importRoutine(importedData);
                     } else if (importType === 'exams') {
                         importExams(importedData);
                     } else if (importType === 'urls') {
                         importUrls(importedData);
                     }
                 } catch (error) {
                     alert("❌ Error: Invalid Backup File. Please check the file.");
                     console.error("Import Error:", error);
                 } finally {
                     // Always reset input so same file can be selected again
                     event.target.value = ''; 
                 }
             };
             reader.onerror = () => alert("❌ Failed to read file.");
             reader.readAsText(file);
        };

        const importFullBackup = (importedData, rawString) => {
            // Strong Validation
            if (!importedData || typeof importedData !== 'object' || !Array.isArray(importedData.subjects)) {
                alert("❌ Invalid Backup File: This does not look like a Study Tracker backup.");
                return;
            }

            showConfirmationModal('Restore Full Backup?', '⚠️ WARNING: This will DELETE all current data and replace it with the backup. This cannot be undone.', () => {
                try {
                    // Force Save directly to Storage
                    const stringToSave = rawString || JSON.stringify(importedData);
                    localStorage.setItem(DB_KEY, stringToSave);
                    
                    // Force Reload
                    alert('✅ Backup Restored Successfully! The app will now reload.');
                    window.location.reload();
                } catch (error) {
                     alert('❌ Import Failed: Storage might be full.');
                }
            });
        };

        // Updated: Removed sourceType param
        const importAllChapters = (importedData) => {
            let chaptersAdded = 0, subjectsAdded = 0;
            Object.keys(importedData).forEach(subjectName => {
                const subjectId = subjectName.toLowerCase().replace(/\s+/g, '-').replace(/[()]/g, '');
                let subject = data.subjects.find(s => s.id === subjectId);
                if (!subject) { subject = { id: subjectId, name: subjectName, chapters: [], completionCount: 0 }; data.subjects.push(subject); if (!translations.en[subjectId]) { translations.en[subjectId] = subjectName; translations.hi[subjectId] = subjectName; } subjectsAdded++; }
                const chaptersToImport = importedData[subjectName];
                if (Array.isArray(chaptersToImport)) { 
                    chaptersToImport.forEach(chapterData => { 
                        const chapterName = typeof chapterData === 'string' ? chapterData : chapterData.name;
                        if (chapterName && !subject.chapters.some(c => c.name === chapterName)) { 
                            const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterName.trim(), status: 'Not Started', dateAdded: getLocalDateString(), notes: '', priorityRevision: false, revisions: [] }; 
                            subject.chapters.push(newChapter); 
                            chaptersAdded++; 
                        } 
                    }); 
                }
            });
            logActivity('upload', `Imported ${chaptersAdded} chapters and ${subjectsAdded} new subjects.`);
            saveData(); alert(`Import successful!\n\nNew Subjects Added: ${subjectsAdded}\nNew Chapters Added: ${chaptersAdded}`);
            applyTranslations(); renderSubjectsPage(); 
        };

        const importRoutine = (importedData) => {
            if (!Array.isArray(importedData) || importedData.length !== 14) {
                alert('Invalid routine file. It must be an array with 14 days of data.');
                return;
            }
            data.settings.customCyclePlan = importedData;
            data.settings.planMode = 'custom_cycle';
            data.dailyPlan = {}; // Reset daily plan to use the new routine
            saveData();
            logActivity('upload', `Imported a new 14-day study routine.`);
            alert('Study routine imported successfully! The plan mode has been set to "Custom Cycle".');
            renderSettingsPage();
            renderHomePage();
        };

        const importExams = (importedData) => {
            if (!Array.isArray(importedData)) {
                alert('Invalid exams file. It must be an array of exam objects.');
                return;
            }
            const isValid = importedData.every(exam => exam.name && exam.id);
            if (!isValid) {
                 alert('Exam data is malformed. Each exam must have at least a "name" and "id".');
                 return;
            }
            data.exams = importedData;
            saveData();
            logActivity('upload', `Imported ${importedData.length} exams.`);
            alert(`${importedData.length} exams imported successfully!`);
            renderExamsPage();
            renderHomePage();
        };

        const importUrls = (importedData) => {
            if (!Array.isArray(importedData)) {
                alert('Invalid URLs file. It must be an array of folder/link objects.');
                return;
            }
            data.urls = importedData;
            saveData();
            logActivity('upload', `Imported ${importedData.length} root folders/links.`);
            alert(`URL data imported successfully!`);
            renderUrlPage();
        };
        
        const BADGES = {
            'first_step': { name: 'पहला कदम', description: 'अपना पहला अध्याय पूरा करें।', icon: 'footprints', color: 'text-green-500', goal: 1, type: 'total_completed' },
            'scholar': { name: 'विद्वान', description: 'कुल 25 अध्याय पूरे करें।', icon: 'book-marked', color: 'text-sky-500', goal: 25, type: 'total_completed' },
            'fifty_milestone': { name: 'अर्धशतक', description: 'कुल 50 अध्याय पूरे करें।', icon: 'gem', color: 'text-rose-500', goal: 50, type: 'total_completed' },
            'prodigy': { name: 'प्रतिभाशाली', description: 'कुल 75 अध्याय पूरे करें।', icon: 'brain-circuit', color: 'text-indigo-500', goal: 75, type: 'total_completed' },
            'centurion': { name: 'शतकवीर', description: 'कुल 100 अध्याय पूरे करें।', icon: 'shield-check', color: 'text-lime-500', goal: 100, type: 'total_completed' },
            'mastermind': { name: 'मास्टरमाइंड', description: 'कुल 150 अध्याय पूरे करें।', icon: 'atom', color: 'text-cyan-500', goal: 150, type: 'total_completed' },
            'marathon_learner': { name: 'मैराथन धावक', description: 'एक ही दिन में 5 अध्याय पूरे करें।', icon: 'zap', color: 'text-yellow-500', goal: 5, type: 'day_record' },
            'consistent_5': { name: 'लगातार 5 दिन', description: 'लगातार 5 दिनों तक अध्ययन करें।', icon: 'calendar-check', color: 'text-blue-500', goal: 5, type: 'streak' },
            'dedicated_scholar': { name: 'समर्पित विद्वान', description: 'लगातार 30 दिनों तक अध्ययन करें।', icon: 'crown', color: 'text-amber-400', goal: 30, type: 'streak' },
            'dpt_starter': { name: 'DPT स्टार्टर', description: 'अपना पहला DPT पूरा करें।', icon: 'file-check-2', color: 'text-teal-500', goal: 1, type: 'total_dpt' },
            'dpt_champion': { name: 'DPT चैंपियन', description: 'कुल 10 DPT पूरे करें।', icon: 'swords', color: 'text-orange-500', goal: 10, type: 'total_dpt' },
            'subject_master': { name: 'विषय मास्टर', description: 'किसी एक विषय के सभी अध्याय पूरे करें।', icon: 'graduation-cap', color: 'text-purple-500', goal: 1, type: 'subject_mastered' },
            'subject_pro': { name: 'विषय प्रो', description: '3 अलग-अलग विषयों के सभी अध्याय पूरे करें।', icon: 'library', color: 'text-fuchsia-500', goal: 3, type: 'subject_mastered' }
        };

        const getBadgeProgress = (badgeId) => {
            const badge = BADGES[badgeId];
            if (!badge) return { current: 0, goal: 1 };
        
            switch(badge.type) {
                case 'total_completed':
                    const allChapters = (data.subjects || []).flatMap(s => s.chapters || []);
                    return { current: allChapters.filter(c => c.status === 'Completed').length, goal: badge.goal };
                case 'streak':
                    const completedDates = new Set((data.gamification.completedHistory || []));
                    let streak = 0;
                    if (completedDates.size > 0) {
                        let currentDate = new Date();
                        while(completedDates.has(getLocalDateString(currentDate))) {
                            streak++;
                            currentDate.setDate(currentDate.getDate() - 1);
                        }
                    }
                    return { current: streak, goal: badge.goal };
                case 'day_record':
                    const completionByDate = (data.gamification.completedHistory || []).reduce((acc, date) => { acc[date] = (acc[date] || 0) + 1; return acc; }, {});
                    const maxInADay = Object.values(completionByDate).reduce((max, count) => Math.max(max, count), 0);
                    return { current: maxInADay, goal: badge.goal };
                case 'total_dpt':
                    const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed');
                    return { current: allCompletedDpts.length, goal: badge.goal };
                case 'subject_mastered':
                     const masteredSubjects = (data.subjects || []).filter(s => {
                         const allChapters = s.chapters || [];
                         return allChapters.length > 0 && allChapters.every(c => c.status === 'Completed');
                     }).length;
                     return { current: masteredSubjects, goal: badge.goal };
                default:
                    return { current: 0, goal: 1 };
            }
        };

        const checkAllGamification = () => {
            Object.keys(BADGES).forEach(badgeId => {
                if (data.gamification.badges.includes(badgeId)) return;
                const { current, goal } = getBadgeProgress(badgeId);
                if (current >= goal) {
                    unlockBadge(badgeId);
                }
            });
        };

        const unlockBadge = (badgeId) => {
            if (!data.gamification.badges.includes(badgeId)) {
                const badgeInfo = BADGES[badgeId];
                if (badgeInfo) {
                    data.gamification.badges.push(badgeId);
                    logActivity('award', `Achievement Unlocked: "${badgeInfo.name}"`);
                    document.getElementById('badge-name').textContent = badgeInfo.name;
                    document.getElementById('badge-description').textContent = badgeInfo.description;
                    document.getElementById('badge-icon').setAttribute('data-lucide', badgeInfo.icon);
                    lucide.createIcons();
                    showModal('badge-modal');
                    renderBadges();
                }
            }
        };

        const getDptSubjectsForDay = (date = new Date()) => {
            const dayIndex = getCycleDayIndex(date);
            if (data.settings.dptPlanMode === 'custom_cycle') { return (data.settings.dptCyclePlan || [])[dayIndex] || []; }
            // For 'auto' mode, derive from study plan subjects
            const studySubjects = getSubjectsForDay(date); // Already clean IDs
            const revisionSubjects = [];
            (data.subjects || []).forEach(s => {
                (s.chapters || []).forEach(c => (c.revisions || []).forEach(r => { if(r.status === 'Pending' && r.date === getLocalDateString(date)) revisionSubjects.push(s.id); }));
            });
            return [...new Set([...studySubjects, ...revisionSubjects])].filter(id => !DPT_EXCLUDED_SUBJECTS.includes(id));
        };

        const getOrGenerateDailyDptPlan = (dateStr) => {
            // Updated: Only Manual or Triggered DPTs are shown. No auto-schedule.
            if (!data.dailyDptPlan[dateStr]) {
                data.dailyDptPlan[dateStr] = [];
                saveData();
            }
            return data.dailyDptPlan[dateStr];
        };

        const renderTodaysDpt = () => {
            const container = document.getElementById('todays-dpt-container');
            const wrapper = document.getElementById('todays-dpt-container-wrapper');
            
            // Check Global Toggle
            if (data.settings.dptDashboardActive === false) {
                if(wrapper) wrapper.style.display = 'none';
                return;
            } else {
                if(wrapper) wrapper.style.display = 'block';
            }

            const todayStr = getLocalDateString();
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterdayStr = getLocalDateString(yesterdayDate);
            
            const scheduledTests = getOrGenerateDailyDptPlan(todayStr);

            const yesterdayDptPlan = data.dailyDptPlan[yesterdayStr] || [];
            const missedYesterdayDPTs = yesterdayDptPlan.filter(({ subjectId, chapterId, testId }) => {
                const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId);
                return test && test.status !== 'Completed';
            });
            
            const hasPending = scheduledTests.some(({ subjectId, chapterId, testId }) => { const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId); return test && test.status !== 'Completed'; });
            container.className = `dashboard-card p-4 rounded-xl shadow-sm min-h-[100px] bg-gradient-to-br ${ hasPending ? 'from-amber-100 to-orange-200 dark:from-amber-800 dark:to-orange-900' : 'from-teal-100 to-green-200 dark:from-teal-800 dark:to-green-900' }`;
            
            let html = `<div class="flex items-center justify-between pb-3 border-b mb-3">
                <div class="flex items-center gap-3"><i data-lucide="file-check" class="w-6 h-6"></i><h2 class="text-lg font-bold">${_('todays_dpt')}</h2></div>
                <button id="manual-add-dpt-btn" class="p-1.5 rounded-full hover:bg-orange-200 dark:hover:bg-orange-800"><i data-lucide="plus-circle" class="w-5 h-5 text-orange-700 dark:text-orange-300"></i></button>
            </div>`;

            const pendingTests = scheduledTests.filter(({ subjectId, chapterId, testId }) => {
                const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId);
                return test && test.status !== 'Completed';
            });

            const completedTests = scheduledTests.filter(({ subjectId, chapterId, testId }) => {
                const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId);
                return test && test.status === 'Completed';
            });

            if (pendingTests.length === 0 && missedYesterdayDPTs.length === 0 && completedTests.length === 0) { 
                html += `<div class="text-center py-4"><p>${_('no_dpt_scheduled')}</p></div>`; 
            } else {
                html += '<ul class="space-y-3">';
                
                // Render Pending Tests
                pendingTests.forEach(({ subjectId, chapterId, testId, isManual, id }) => {
                    const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId); if (!test) return;
                    const chapter = getChapterByIds(subjectId, chapterId);
                    const dptTitle = `${_(subjectId)} - ${chapter ? chapter.name : ''} #${test.id}`;
                    const deleteButton = isManual ? `<button class="manual-dpt-delete-btn p-1.5" data-manual-id="${id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>` : '';

                    html += `<li class="flex items-center justify-between gap-2 p-2 rounded-lg bg-white/30 dark:bg-black/20">
                        <p class="font-bold flex items-center gap-2">${isManual ? `<i data-lucide="hand" class="w-4 h-4 text-indigo-500"></i>`: ''}${dptTitle}</p>
                        <div class="flex items-center gap-1">
                            <button class="skip-dpt-btn p-1.5 rounded hover:bg-blue-100 dark:hover:bg-blue-900/50" title="${_('skip_chapter')}" data-subject-id="${subjectId}"><i data-lucide="chevrons-right" class="w-4 h-4 text-blue-600"></i></button>
                            <button class="mark-dpt-complete-btn w-full sm:w-auto flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-semibold text-white bg-amber-500 rounded-lg hover:bg-amber-600 shadow" data-subject-id="${subjectId}" data-chapter-id="${chapterId}" data-test-id="${test.id}"><i data-lucide="check-circle" class="w-4 h-4"></i><span>${_('mark_as_complete')}</span></button>
                            ${deleteButton}
                        </div>
                    </li>`;
                });

                // Render Missed Tests
                missedYesterdayDPTs.forEach(({ subjectId, chapterId, testId }) => {
                    const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId); if (!test) return;
                    const chapter = getChapterByIds(subjectId, chapterId);
                     html += `<li class="p-2 rounded-lg bg-red-100 dark:bg-red-900/50 flex flex-col items-start gap-2">
                        <p class="font-semibold text-sm text-red-800 dark:text-red-200">Missed Yesterday: ${_(subjectId)} - ${chapter ? chapter.name : ''} #${test.id}</p>
                        <button class="complete-missed-dpt-btn w-full text-xs font-semibold p-1.5 bg-red-500 text-white rounded-md" data-subject-id="${subjectId}" data-chapter-id="${chapterId}" data-test-id="${testId}">${_('complete_yesterdays_dpt')}</button>
                    </li>`;
                });

                html += '</ul>';
                if(!hasPending && missedYesterdayDPTs.length === 0) { html += `<div class="text-center pt-4 text-green-800 dark:text-green-200 font-semibold"><p>${_('all_dpt_completed')}</p></div>`; }
            }
            container.innerHTML = html;

            // Handle Completed DPT Dropdown
            const completedListContainer = document.getElementById('completed-dpt-list');
            const completedToggleContainer = document.getElementById('completed-dpt-toggle-container');
            const completedCountSpan = document.getElementById('completed-dpt-count');

            if (completedTests.length > 0) {
                completedToggleContainer.style.display = 'block';
                completedCountSpan.textContent = completedTests.length;
                completedListContainer.innerHTML = completedTests.map(({ subjectId, chapterId, testId }) => {
                    const test = data.dpts[subjectId]?.chapters?.[chapterId]?.find(t => t.id === testId);
                    const chapter = getChapterByIds(subjectId, chapterId);
                    const dptTitle = `${_(subjectId)} - ${chapter ? chapter.name : ''} #${test.id}`;
                    return `<div class="flex items-center justify-between gap-2 p-2 rounded-lg bg-green-500/20">
                        <p class="font-bold text-green-800 dark:text-green-200 text-xs">${dptTitle}</p>
                        <button class="view-dpt-details-btn flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-lg bg-green-500 text-white" data-subject-id="${subjectId}" data-chapter-id="${chapterId}" data-test-id="${test.id}"><i data-lucide="eye" class="w-3 h-3"></i></button>
                    </div>`;
                }).join('');
            } else {
                completedToggleContainer.style.display = 'none';
                completedListContainer.classList.add('hidden');
            }

            lucide.createIcons();
        };

        const renderDptPage = () => {
            // Update filter buttons UI
            document.querySelectorAll('#dpt-view-filter .filter-btn').forEach(btn => 
                btn.classList.toggle('active', btn.dataset.view === dptPageViewMode)
            );

            const filterDropdown = document.getElementById('dpt-subject-filter');
            const container = document.getElementById('dpt-list-container');
            const globalActionsContainer = document.getElementById('dpt-global-actions-container');
            const searchInput = document.getElementById('dpt-search-input');
            const filter = searchInput.value.toLowerCase();
            
            // Build Subject Options (Preserve selection logic)
            // Using a simple check to ensure we don't overwrite if value exists and is valid
            const currentSelection = filterDropdown.value || 'all_subjects';
            
            const subjectOptions = `<option value="all_subjects">${_('all_subjects')}</option>` + 
                (data.subjects || []).filter(s => !DPT_EXCLUDED_SUBJECTS.includes(s.id)).map(s => 
                    `<option value="${s.id}">${_(s.id)}</option>`
                ).join('');
            
            // Only update innerHTML if it has changed to prevent losing focus/state, 
            // but for simplicity in this framework, we rebuild and re-select.
            if (filterDropdown.innerHTML !== subjectOptions) {
                filterDropdown.innerHTML = subjectOptions;
                filterDropdown.value = Array.from(filterDropdown.options).some(opt => opt.value === currentSelection) ? currentSelection : 'all_subjects';
            }
            
            const selectedSubjectId = filterDropdown.value;

            let html = '';
            globalActionsContainer.innerHTML = ''; 

            // Filter Subjects based on Dropdown
            const subjectsToRender = (data.subjects || []).filter(s => {
                if (DPT_EXCLUDED_SUBJECTS.includes(s.id)) return false;
                if (selectedSubjectId !== 'all_subjects' && s.id !== selectedSubjectId) return false;
                return true;
            });

            if (subjectsToRender.length === 0) {
                 container.innerHTML = '<p class="text-center p-4">Please select a subject to view and add DPTs.</p>';
                 renderDptSummary();
                 return;
            }
            
            // Show Global Actions only if "All Subjects" is selected
            if (selectedSubjectId === 'all_subjects') {
                globalActionsContainer.innerHTML = `<div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm mb-4 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold mb-3 flex items-center gap-2"><i data-lucide="globe" class="text-primary"></i> Global Actions</h3>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="add-global-dpts-btn" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg bg-primary text-white hover:bg-primary-hover transition-colors shadow-lg shadow-primary/20">
                            <i data-lucide="layers" class="w-4 h-4"></i><span>Global Add DPTs</span>
                        </button>
                        <button id="delete-all-dpts-global-btn" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete All DPTs</span>
                        </button>
                    </div>
                </div>`;
            }

            subjectsToRender.forEach(subject => {
                const chapters = (subject.chapters || []).filter(c => filter ? c.name.toLowerCase().includes(filter) : true);
                
                // Show Header if we have chapters OR if specific subject selected
                if (chapters.length === 0 && filter) return;

                // Header HTML with Actions
                const subjectHeader = `
                    <div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm mb-4 border border-gray-100 dark:border-gray-700">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                            <h3 class="font-bold text-xl flex items-center gap-2">
                                <span class="w-1 h-6 bg-primary rounded-full"></span>
                                ${_(subject.id)}
                            </h3>
                            <div class="flex items-center gap-2">
                                <button class="add-dpt-to-all-chapters-btn flex items-center justify-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg btn-neon" data-subject-id="${subject.id}">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i><span data-translate="add_dpt_all">${_('add_dpt_all')}</span>
                                </button>
                                <button class="delete-all-dpts-subject-btn flex items-center justify-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900/50" data-subject-id="${subject.id}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i><span>Delete All</span>
                                </button>
                            </div>
                        </div>
                    </div>`;

                let chaptersHtml = chapters.map(chapter => {
                    const dptDataForChapter = data.dpts[subject.id]?.chapters?.[chapter.id] || [];
                    
                    const testsToDisplay = dptDataForChapter.filter(test => {
                        if (dptPageViewMode === 'completed') return test.status === 'Completed';
                        if (dptPageViewMode === 'pending') return test.status !== 'Completed';
                        return true;
                    });

                    // Skip chapter if no tests match filter (and we are not in search mode)
                    if(testsToDisplay.length === 0 && !filter) return '';
                    // In search mode, show chapter even if empty so we can add tests? No, logic above filters chapters.
                    // Just fallback to empty string if no tests.
                    if(testsToDisplay.length === 0) return '';

                    const completedCount = dptDataForChapter.filter(t => t.status === 'Completed').length;
                    const totalCount = dptDataForChapter.length;
                    const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

                    const testsHtml = testsToDisplay.map(test => {
                        const isCompleted = test.status === 'Completed';
                        const statusClass = isCompleted 
                            ? 'bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 text-green-800 dark:text-green-300' 
                            : 'bg-white dark:bg-gray-800 border-l-4 border-gray-300 dark:border-gray-600 hover:border-primary';
                        
                        const dptName = `#${test.id}`;
                        
                        return `<button class="dpt-list-item w-full text-left p-3 rounded-r-lg shadow-sm mb-2 transition-all hover:translate-x-1 ${statusClass}" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}" data-test-id="${test.id}">
                            <div class="flex justify-between items-center">
                                <span class="font-bold">Test ${dptName}</span>
                                ${isCompleted ? '<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>' : '<i data-lucide="circle" class="w-4 h-4 text-gray-400"></i>'}
                            </div>
                        </button>`;
                    }).join('');
                    
                    return `<details class="group bg-card-light dark:bg-card-dark rounded-xl shadow-sm overflow-hidden mb-3 border border-gray-100 dark:border-gray-700" open>
                        <summary class="flex items-center justify-between p-4 cursor-pointer list-none hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                            <div>
                                <h4 class="font-bold flex items-center gap-2">
                                    <i data-lucide="book" class="w-4 h-4 text-gray-400"></i>
                                    ${chapter.name}
                                </h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="w-20 bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full bg-primary" style="width: ${percentage}%"></div>
                                    </div>
                                    <p class="text-xs text-text-muted-light">${completedCount}/${totalCount}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button class="add-dpt-to-chapter-btn flex items-center justify-center gap-1.5 px-3 py-1.5 text-xs font-semibold rounded-lg bg-sky-50 dark:bg-sky-900/30 text-sky-700 dark:text-sky-300 border border-sky-100 dark:border-sky-800 hover:bg-sky-100 dark:hover:bg-sky-900/50" data-subject-id="${subject.id}" data-chapter-id="${chapter.id}">
                                    <i data-lucide="plus" class="w-3 h-3"></i> Add
                                </button>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform group-open:rotate-180"></i>
                            </div>
                        </summary>
                        <div class="px-4 pb-4 pt-2 bg-gray-50/50 dark:bg-gray-900/20">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">${testsHtml}</div>
                        </div>
                    </details>`;
                }).join('');

                if(chaptersHtml) {
                    html += subjectHeader + chaptersHtml;
                } else if(selectedSubjectId !== 'all_subjects' && !filter){
                     html += subjectHeader + `<div class="p-6 text-center border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl m-4"><p class="text-gray-500">No chapters found. Add chapters in Subjects tab first.</p></div>`;
                }
            });
            
            container.innerHTML = html || '<div class="flex flex-col items-center justify-center py-12 text-gray-400"><i data-lucide="filter" class="w-12 h-12 mb-2 opacity-20"></i><p>No DPTs match the current filter.</p></div>';
            renderDptSummary();
            lucide.createIcons();
        };

        const findNextPendingDptForChapter = (subjectId, chapterId) => {
            const tests = data.dpts[subjectId]?.chapters?.[chapterId];
            if (tests) {
                const pendingTest = tests.find(t => t.status !== 'Completed');
                if (pendingTest) {
                    return { subjectId, chapterId, testId: pendingTest.id };
                }
            }
            return null;
        };

        const findNextPendingDptForSubject = (subjectId) => {
            const subject = getSubjectById(subjectId);
            if (!subject || !data.dpts[subjectId]) return null;
            
            const allChapters = subject.chapters || [];
            for (const chapter of allChapters) {
                const nextDpt = findNextPendingDptForChapter(subjectId, chapter.id);
                if (nextDpt) return nextDpt;
            }
            return null;
        };

        const renderDptSummary = () => {
            const container = document.getElementById('dpt-summary-container');
            const allCompletedDpts = Object.values(data.dpts || {}).flatMap(subjectData => Object.values(subjectData.chapters || {})).flat().filter(t => t.status === 'Completed' && t.details);
            const totalCompleted = allCompletedDpts.length;
            let totalCorrect = 0, totalAttempted = 0, totalTimeTaken = 0, totalQuestions = 0;
            allCompletedDpts.forEach(dpt => { totalCorrect += dpt.details.correct || 0; totalAttempted += dpt.details.attempted || 0; totalTimeTaken += (dpt.details.timeTaken || 0) * 60; totalQuestions += dpt.details.totalQ || 0; });
            const accuracy = totalAttempted > 0 ? ((totalCorrect / totalAttempted) * 100).toFixed(1) : '0.0';
            const avgTimePerQ = totalAttempted > 0 ? (totalTimeTaken / totalAttempted).toFixed(1) : '0.0';
            container.innerHTML = `<div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="total_dpt_completed">Total DPTs Completed</h3><p class="text-3xl font-bold text-primary">${totalCompleted}</p></div><div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="overall_accuracy">Overall Accuracy</h3><p class="text-3xl font-bold text-accent">${accuracy}%</p></div><div class="p-4 bg-card-light dark:bg-card-dark rounded-xl shadow-sm text-center"><h3 class="text-sm" data-translate="avg_time_per_q">Avg. Time / Q (s)</h3><p class="text-3xl font-bold text-warning">${avgTimePerQ}</p></div>`;
        };

        const showDptDetailsModal = (subjectId, chapterId, testId) => {
            const dptChapterData = data.dpts[subjectId]?.chapters?.[chapterId]; if (!dptChapterData) return;
            const test = dptChapterData.find(t => t.id == testId); if (!test) return;
            const chapter = getChapterByIds(subjectId, chapterId);

            const modal = document.getElementById('dpt-details-popup-modal');
            const titleEl = document.getElementById('dpt-modal-title');
            const entryView = document.getElementById('dpt-entry-view');
            const displayView = document.getElementById('dpt-display-view');
            titleEl.textContent = `${_(subjectId)} - ${chapter ? chapter.name : '...'} #${test.id}`;

            if (test.status === 'Completed' && test.details) {
                entryView.classList.add('hidden');
                displayView.classList.remove('hidden');
                const details = test.details;
                document.getElementById('dpt-display-date').textContent = new Date(details.completedDate).toLocaleDateString('hi-IN');
                document.getElementById('dpt-display-total-q').textContent = details.totalQ || 'N/A';
                document.getElementById('dpt-display-attempted').textContent = details.attempted || 'N/A';
                document.getElementById('dpt-display-correct').textContent = details.correct || 'N/A';
                document.getElementById('dpt-display-wrong').textContent = details.wrong || 'N/A';
                const accuracy = details.attempted > 0 ? `${((details.correct / details.attempted) * 100).toFixed(1)}%` : 'N/A';
                document.getElementById('dpt-display-accuracy').textContent = accuracy;
                document.getElementById('dpt-display-time-taken').textContent = details.timeTaken ? `${details.timeTaken} min` : 'N/A';
                const deleteBtn = document.getElementById('delete-dpt-display-btn');
                deleteBtn.dataset.subjectId = subjectId;
                deleteBtn.dataset.chapterId = chapterId;
                deleteBtn.dataset.testId = test.id;
            } else {
                displayView.classList.add('hidden');
                entryView.classList.remove('hidden');
                const form = document.getElementById('dpt-details-form'); form.reset();
                form.querySelector('#dpt-details-subject-id').value = subjectId;
                form.querySelector('#dpt-details-chapter-id').value = chapterId;
                form.querySelector('#dpt-details-test-id').value = test.id;
                const deleteBtn = document.getElementById('delete-dpt-btn');
                deleteBtn.dataset.subjectId = subjectId;
                deleteBtn.dataset.chapterId = chapterId;
                deleteBtn.dataset.testId = test.id;
            }
            showModal('dpt-details-popup-modal');
        };

        const hideDptDetailsModal = () => { hideModal('dpt-details-popup-modal'); };

        const submitDptDetails = (e) => {
            e.preventDefault();
            const form = e.target;
            const subjectId = form.querySelector('#dpt-details-subject-id').value;
            const chapterId = form.querySelector('#dpt-details-chapter-id').value;
            const testId = parseInt(form.querySelector('#dpt-details-test-id').value);
            
            const dptChapterData = data.dpts[subjectId]?.chapters?.[chapterId];
            if (!dptChapterData) return;
            
            const testIndex = dptChapterData.findIndex(t => t.id === testId);
            if(testIndex === -1) return;

            const details = { 
                totalQ: parseInt(form.querySelector('#dpt-total-q').value) || null, 
                totalTime: parseInt(form.querySelector('#dpt-total-time').value) || null, 
                attempted: parseInt(form.querySelector('#dpt-attempted').value) || null, 
                correct: parseInt(form.querySelector('#dpt-correct').value) || null, 
                wrong: parseInt(form.querySelector('#dpt-wrong').value) || null, 
                timeTaken: parseInt(form.querySelector('#dpt-time-taken').value) || null,
                completedDate: new Date().toISOString()
            };
            dptChapterData[testIndex].status = 'Completed';
            dptChapterData[testIndex].details = details;

            const chapter = getChapterByIds(subjectId, chapterId);
            logActivity('check-square', `Completed DPT #${testId} for ${_(subjectId)} - ${chapter ? chapter.name : ''}.`);
            saveData(); 
            checkAllGamification(); 
            hideDptDetailsModal(); 
            renderHomePage();
            if(document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
        };

        const applyBackgroundStyle = () => {
            stopAllBackgroundAnimations();
            const style = data.settings.backgroundStyle || 'constellation';
            
            // Reset styles
            document.body.classList.remove('constellation-active');
            document.body.classList.remove('custom-bg-active'); 
            document.body.style.backgroundImage = '';
            particleCanvas.style.display = 'none';
            document.body.style.willChange = 'transform'; // Performance optimization

            if (data.settings.theme === 'dark' && style !== 'default') {
                document.documentElement.classList.add('pitch-black');
            } else {
                document.documentElement.classList.remove('pitch-black');
            }

            if (style === 'default') { return; }
            
            // Constellation Only (Optimized)
            if (style === 'constellation') { 
                particleCanvas.style.display = 'block';
                document.body.classList.add('constellation-active'); 
                initConstellationEffect(); 
            }
        };
        
        const hexToRgba = (hex, alpha = 1) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const stopAllBackgroundAnimations = () => { if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } };
        // --- ULTIMATE HEATING FIX ---
        // Canvas को बार-बार क्लियर नहीं करेंगे, और Nodes बहुत कम रखेंगे।
        function initCanvas() { 
            particleCanvas.width = window.innerWidth; 
            particleCanvas.height = window.innerHeight; 
            backgroundElements = []; 
        }
        
        // Animation functions removed for performance
        function initConstellationEffect() {}
        function animateConstellation() {}

        
        const postponeRevision = (subjectId, chapterId, revisionDate) => {
            const chapter = getChapterByIds(subjectId, chapterId);
            const revision = chapter?.revisions.find(r => r.date === revisionDate); if (!revision) return;
            document.querySelector(`li [data-revision-date="${revisionDate}"]`)?.closest('.task-list-item')?.classList.add('completed');
            setTimeout(() => { const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); revision.date = getLocalDateString(tomorrow); logActivity('skip-forward', `Revision for "${chapter.name}" postponed to tomorrow.`); saveData(); renderHomePage(); }, 500);
        };
        
        function openManualAddModal(type) {
            const modal = document.getElementById('manual-add-modal');
            const chapterContent = document.getElementById('manual-add-chapter-content');
            const dptContent = document.getElementById('manual-add-dpt-content');
            const subjectSelect = document.getElementById('manual-add-subject-select');

            modal.dataset.type = type;
            subjectSelect.innerHTML = `<option value="">-- Choose a Subject --</option>` + (data.subjects || []).map(s => `<option value="${s.id}">${_(s.id)}</option>`).join('');
            
           if (type === 'chapter') {
                modal.querySelector('h2').textContent = 'Add Manual Task';
                chapterContent.style.display = 'block';
                dptContent.style.display = 'none';
                document.getElementById('manual-add-date').value = getLocalDateString();
                document.getElementById('manual-add-chapter-name').value = '';
            } else { 
                modal.querySelector('h2').textContent = 'Add Manual DPT';
                chapterContent.style.display = 'none';
                dptContent.style.display = 'block';
                populateManualItemList(null, 'dpt');
            }
            showModal('manual-add-modal');
        }

        function populateManualItemList(subjectId, type) {
            if (type === 'dpt') {
                const itemList = document.getElementById('manual-add-item-list');
                if (!subjectId) { itemList.innerHTML = `<p class="text-center text-sm">Please select a subject first.</p>`; return; }
                const nextDpt = findNextPendingDptForSubject(subjectId);
                if (!nextDpt) { itemList.innerHTML = `<p class="text-center text-sm">No upcoming DPTs for this subject.</p>`; return; }
                const chapter = getChapterByIds(subjectId, nextDpt.chapterId);
                itemList.innerHTML = `<label class="flex items-center gap-2 p-2 rounded-md"><input type="radio" name="manual-add-item" value="${nextDpt.chapterId}:${nextDpt.testId}" checked class="form-radio text-primary"><span>${chapter.name} - DPT #${nextDpt.testId} (Next Available)</span></label>`;
            }
        }


        function saveManualTask() {
            const type = document.getElementById('manual-add-modal').dataset.type;
            const subjectId = document.getElementById('manual-add-subject-select').value;
             if (!subjectId) { alert('Please select a subject.'); return; }

            if (type === 'chapter') {
                const chapterName = document.getElementById('manual-add-chapter-name').value.trim();
                const selectedDate = document.getElementById('manual-add-date').value;
                if (!chapterName || !selectedDate) { alert('Please fill all fields: Chapter Name and Date.'); return; }
                
                const subject = getSubjectById(subjectId);
                if(!subject) return;

                const chapterExists = subject.chapters.some(c => c.name.toLowerCase() === chapterName.toLowerCase());
                if(chapterExists) { alert(`A chapter named "${chapterName}" already exists in ${subject.name}.`); return; }

                const newChapter = { id: `ch-${Date.now()}-${Math.random()}`, name: chapterName, status: 'Not Started', dateAdded: getLocalDateString(), notes: '', priorityRevision: false, revisions: [] };
                subject.chapters.push(newChapter);
                logActivity('plus-circle', `Manually added new chapter to ${_(subject.id)}: "${chapterName}"`);

                const dateStr = selectedDate;
                data.dailyPlan[dateStr] = data.dailyPlan[dateStr] || { tasks: {}, completedSubjects: [], manualTasks: [] };
                data.dailyPlan[dateStr].manualTasks.push({ subjectId, chapterId: newChapter.id, id: `manual-${Date.now()}` });
                logActivity('hand', `Manually scheduled task for "${chapterName}" on ${dateStr}.`);

                saveData();
                hideModal('manual-add-modal');
                if (dateStr === getLocalDateString()) { renderHomePage(); }
                if (document.getElementById('page-subjects').classList.contains('active')) { renderSubjectsPage(); }

            } else { 
                const selectedRadio = document.querySelector('input[name="manual-add-item"]');
                if (!selectedRadio) { alert('No available DPT to add for this subject.'); return; }
                const [chapterId, testIdStr] = selectedRadio.value.split(':');
                const testId = parseInt(testIdStr);

                const todayStr = getLocalDateString();
                data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr] || [];
                if (!data.dailyDptPlan[todayStr].some(d => d.subjectId === subjectId && d.chapterId === chapterId && d.testId === testId)) {
                    data.dailyDptPlan[todayStr].push({ subjectId, chapterId, testId, isManual: true, id: `manual-dpt-${Date.now()}` });
                    const chapter = getChapterByIds(subjectId, chapterId);
                    logActivity('hand', `Manually added DPT for today: ${_(subjectId)} - ${chapter ? chapter.name : ''} #${testId}`);
                }
                saveData();
                hideModal('manual-add-modal');
                renderHomePage();
            }
        }
        
        function confirmDeleteSubject(subjectId) {
            const subject = getSubjectById(subjectId);
            if (!subject) return;
            showConfirmationModal(_('delete_subject'), _('delete_subject_confirm', { subjectName: _(subject.id) }), () => {
                data.subjects = data.subjects.filter(s => s.id !== subjectId);
                delete data.dpts[subjectId];
                data.missedChapters = (data.missedChapters || []).filter(c => c.subjectId !== subjectId);
                data.postponedChapters = (data.postponedChapters || []).filter(c => c.subjectId !== subjectId);
                Object.keys(data.dailyPlan).forEach(date => {
                    const plan = data.dailyPlan[date];
                    plan.manualTasks = (plan.manualTasks || []).filter(t => t.subjectId !== subjectId);
                    Object.keys(plan.tasks).forEach(key => { if(key === subjectId) delete plan.tasks[key]; });
                });
                Object.keys(data.dailyDptPlan).forEach(date => { data.dailyDptPlan[date] = (data.dailyDptPlan[date] || []).filter(d => d.subjectId !== subjectId); });
                logActivity('trash-2', `Deleted subject: ${_(subject.id)}`);
                saveData(); renderSubjectsPage();
            });
        }
        
        function deleteDpt(subjectId, chapterId, testId) {
            const dptChapterData = data.dpts[subjectId]?.chapters?.[chapterId];
            if (!dptChapterData) return;
            const chapter = getChapterByIds(subjectId, chapterId);
            const dptName = `${_(subjectId)} - ${chapter ? chapter.name : '...'} #${testId}`;

            showConfirmationModal(_('delete_dpt'), _('delete_dpt_confirm', {dptName}), () => {
                const testIndex = dptChapterData.findIndex(t => t.id === testId);
                if (testIndex === -1) return;
                
                dptChapterData.splice(testIndex, 1);
                
                for(let i = testIndex; i < dptChapterData.length; i++) {
                    dptChapterData[i].id--;
                }

                Object.keys(data.dailyDptPlan).forEach(date => {
                    data.dailyDptPlan[date] = data.dailyDptPlan[date].filter(planItem => !(planItem.subjectId === subjectId && planItem.chapterId === chapterId && planItem.testId === testId));
                });
                logActivity('trash-2', `Deleted DPT: ${dptName}`);
                saveData();
                hideDptDetailsModal();
                if (document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
                if (document.getElementById('page-analytics').classList.contains('active')) renderAnalyticsPage();
                renderHomePage();
            });
        }

        // GLOBAL VARIABLE FOR NAVIGATION STATE
        let currentUrlFolderId = null; 

        function renderUrlPage() {
            const container = document.getElementById('url-container');
            container.innerHTML = ''; // Clear existing

            // 1. Determine Current View Data
            let currentItems = data.urls;
            let parentFolder = null;
            let folderName = "Root";

            if (currentUrlFolderId) {
                const result = findItem(data.urls, currentUrlFolderId);
                if (result && result.item) {
                    parentFolder = result.item;
                    currentItems = parentFolder.children || [];
                    folderName = parentFolder.name;
                } else {
                    // Fallback if ID invalid
                    currentUrlFolderId = null;
                }
            }

            // 2. Render Header (Navigation & Breadcrumb)
            const headerDiv = document.createElement('div');
            headerDiv.className = "flex items-center justify-between mb-4 pb-2 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-[#f8fafc] dark:bg-[#0f172a] z-10 pt-1";
            
            let backButtonHtml = '';
            if (currentUrlFolderId) {
                // Find Grandparent for "Back" Logic logic needs finding parent of current
                // Simple Back: Just reload parent finding logic or keep stack. 
                // Robust: Find parent of currentUrlFolderId
                backButtonHtml = `
                <button id="url-back-btn" class="flex items-center gap-1 pr-3 py-1 text-sm font-bold text-gray-500 hover:text-primary transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                </button>`;
            }

            // Header Title Styling
            const titleColor = currentUrlFolderId ? "text-indigo-600 dark:text-indigo-400" : "text-gray-800 dark:text-gray-200";
            headerDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    ${backButtonHtml}
                    <h2 class="text-xl font-bold ${titleColor} truncate max-w-[200px]">${folderName}</h2>
                </div>
                <!-- Dynamic Add Button based on level -->
                <div class="flex gap-2">
                     <button class="add-sub-folder-btn-top p-2 rounded-lg bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 hover:scale-105 transition-transform shadow-sm" title="New Folder">
                        <i data-lucide="folder-plus" class="w-5 h-5"></i>
                    </button>
                    <button class="add-link-btn-top p-2 rounded-lg bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300 hover:scale-105 transition-transform shadow-sm" title="New Link">
                        <i data-lucide="link" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            container.appendChild(headerDiv);

            // 3. Render List (Sortable Area)
            const listData = document.createElement('div');
            listData.id = "sortable-url-list";
            listData.className = "space-y-3 min-h-[200px] pb-20"; // Padding bottom for ease

            if (currentItems.length === 0) {
                listData.innerHTML = `<div class="text-center p-8 bg-card-light dark:bg-card-dark rounded-xl border border-dashed border-gray-300 dark:border-gray-700"><i data-lucide="folder-open" class="w-12 h-12 mx-auto text-text-muted-light mb-4 opacity-50"></i><h3 class="font-bold text-gray-400">Empty Folder</h3><p class="text-xs text-gray-500">Add content using buttons above.</p></div>`;
            } else {
                currentItems.forEach(item => {
                    const el = document.createElement('div');
                    // Data ID for Sortable
                    el.dataset.id = item.id;
                    el.className = "url-item relative group select-none"; 
                    
                    if (item.type === 'folder') {
                        // FOLDER DESIGN (Advanced)
                        // If Root: Darker Blue. If Sub: Lighter/Different.
                        const isRootLevel = (currentUrlFolderId === null);
                        const folderBg = isRootLevel 
                            ? "bg-gradient-to-r from-slate-100 to-white dark:from-slate-800 dark:to-[#1e293b] border-l-4 border-indigo-500" 
                            : "bg-gradient-to-r from-blue-50 to-white dark:from-blue-900/20 dark:to-[#1e293b] border-l-4 border-cyan-500";
                        
                        const iconColor = isRootLevel ? "text-indigo-500 dark:text-indigo-400" : "text-cyan-500 dark:text-cyan-400";
                        const itemCount = item.children ? item.children.length : 0;

                        el.innerHTML = `
                            <div class="flex items-center justify-between p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-md transition-all cursor-pointer enter-folder-trigger ${folderBg}" data-folder-id="${item.id}">
                                <div class="flex items-center gap-4 overflow-hidden">
                                    <div class="p-2 bg-white dark:bg-black/20 rounded-lg shadow-sm">
                                        <i data-lucide="folder" class="w-6 h-6 ${iconColor} fill-current opacity-80"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <h3 class="font-bold text-base text-gray-800 dark:text-gray-100 truncate">${item.name}</h3>
                                        <p class="text-[10px] font-medium text-gray-400 uppercase tracking-wider">${itemCount} Items</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                    <button class="edit-folder-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500" data-folder-id="${item.id}"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button class="delete-folder-btn p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 text-gray-500 hover:text-red-500" data-folder-id="${item.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    <i data-lucide="grip-vertical" class="w-5 h-5 text-gray-300 dark:text-gray-600 cursor-move ml-1"></i>
                                </div>
                            </div>
                        `;
                    } else {
                        // LINK DESIGN
                        el.innerHTML = `
                            <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800/50 rounded-xl shadow-sm border border-gray-100 dark:border-gray-800 hover:border-green-200 dark:hover:border-green-900/50 transition-all">
                                <a href="${item.url}" target="_blank" class="flex items-center gap-3 flex-grow min-w-0 group-hover:text-primary transition-colors">
                                    <div class="p-2 rounded-full bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400">
                                        <i data-lucide="link-2" class="w-4 h-4"></i>
                                    </div>
                                    <span class="font-medium text-sm truncate">${item.name}</span>
                                </a>
                                <div class="flex items-center gap-1">
                                    <button class="edit-link-btn p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400" data-link-id="${item.id}"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i></button>
                                    <button class="delete-link-btn p-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500" data-link-id="${item.id}"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                    <i data-lucide="grip-vertical" class="w-4 h-4 text-gray-300 dark:text-gray-600 cursor-move ml-1 handle"></i>
                                </div>
                            </div>
                        `;
                    }
                    listData.appendChild(el);
                });
            }
            container.appendChild(listData);

            // 4. Initialize SortableJS
            if (currentItems.length > 0) {
                new Sortable(listData, {
                    animation: 150,
                    delay: 200, // Touch and hold delay (200ms)
                    delayOnTouchOnly: true,
                    handle: '.url-item', // Whole item draggable, or use .handle class for specific
                    ghostClass: 'bg-blue-50/50',
                    onEnd: function (evt) {
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;
                        
                        if (oldIndex !== newIndex) {
                            // Move item in array
                            const movedItem = currentItems.splice(oldIndex, 1)[0];
                            currentItems.splice(newIndex, 0, movedItem);
                            saveData(); // Save new order
                        }
                    },
                });
            }

            lucide.createIcons();

            // 5. Attach Listeners directly here for simplicity in drill-down logic
            // Back Button
            document.getElementById('url-back-btn')?.addEventListener('click', () => {
                // Go Up Logic
                if (currentUrlFolderId) {
                    const result = findItem(data.urls, currentUrlFolderId);
                    // Find parent of this item
                    const parentRes = findParentOfItem(data.urls, currentUrlFolderId);
                    currentUrlFolderId = parentRes ? parentRes.id : null;
                    renderUrlPage();
                }
            });

            // Enter Folder Listener
            document.querySelectorAll('.enter-folder-trigger').forEach(el => {
                el.addEventListener('click', (e) => {
                    // Ignore if clicked on buttons
                    if(e.target.closest('button') || e.target.closest('.cursor-move')) return;
                    currentUrlFolderId = el.dataset.folderId;
                    renderUrlPage();
                });
            });

            // Top Add Buttons
            container.querySelector('.add-sub-folder-btn-top').addEventListener('click', () => {
                showAddFolderModal(null, currentUrlFolderId);
            });
            container.querySelector('.add-link-btn-top').addEventListener('click', () => {
                showAddLinkModal(currentUrlFolderId);
            });
        }

        // RECURSIVE FIND HELPERS (Cleaned Up)
        function findItem(items, id) {
            for (const item of items) {
                if (item.id === id) return { item, parent: items };
                if (item.type === 'folder' && item.children) {
                    const found = findItem(item.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function findParentOfItem(items, childId) {
            for (const item of items) {
                if (item.type === 'folder' && item.children) {
                    if (item.children.some(child => child.id === childId)) return item;
                    const found = findParentOfItem(item.children, childId);
                    if (found) return found;
                }
            }
            return null; // Means Root is parent
        }

        function showAddFolderModal(editFolderId = null, parentId = null) {
            const form = document.getElementById('add-folder-form');
            form.reset();
            const modalTitle = document.getElementById('folder-modal-title');
            document.getElementById('edit-folder-id').value = editFolderId || '';
            document.getElementById('parent-folder-id').value = parentId || (currentUrlFolderId || ''); // Use current view if not specified

            if (editFolderId) {
                const result = findItem(data.urls, editFolderId);
                if (result && result.item) {
                    modalTitle.textContent = `${_('edit')} ${_('folder_name')}`;
                    document.getElementById('new-folder-name').value = result.item.name;
                }
            } else {
                modalTitle.textContent = _('add_new_folder');
            }
            showModal('add-folder-modal');
        }

        function saveFolder(e) {
            e.preventDefault();
            const editId = document.getElementById('edit-folder-id').value;
            const parentId = document.getElementById('parent-folder-id').value; // Usually currentUrlFolderId
            const name = document.getElementById('new-folder-name').value.trim();
            if (!name) return;

            if (editId) {
                const result = findItem(data.urls, editId);
                if (result && result.item) {
                    result.item.name = name;
                    logActivity('folder-edit', `Folder renamed to "${name}"`);
                }
            } else {
                const newFolder = { id: `folder-${Date.now()}`, type: 'folder', name, children: [] };
                
                // Add to specific parent or root
                let targetArray = data.urls;
                if (parentId) {
                    const parentResult = findItem(data.urls, parentId);
                    if (parentResult && parentResult.item && parentResult.item.type === 'folder') {
                        targetArray = parentResult.item.children;
                    }
                }
                targetArray.push(newFolder);
                logActivity('folder-plus', `New folder created: "${name}"`);
            }
            saveData();
            renderUrlPage();
            hideModal('add-folder-modal');
        }
        
        function deleteItem(itemId) {
            const result = findItem(data.urls, itemId);
            if (!result || !result.item) return;

            const isFolder = result.item.type === 'folder';
            const confirmTitle = isFolder ? `${_('delete')} ${_('folder_name')}?` : `${_('delete')} ${_('link_name')}?`;
            const confirmMessage = isFolder ? _('delete_folder_confirm', {folderName: result.item.name}) : _('delete_link_confirm', {linkName: result.item.name});

            showConfirmationModal(confirmTitle, confirmMessage, () => {
                const index = result.parent.findIndex(i => i.id === itemId);
                if (index > -1) {
                    result.parent.splice(index, 1);
                    logActivity('trash-2', `${isFolder ? 'Folder' : 'Link'} deleted: "${result.item.name}"`);
                    saveData();
                    renderUrlPage();
                }
            });
        }
        
        function showAddLinkModal(folderId, editLinkId = null) {
            const form = document.getElementById('add-link-form');
            form.reset();
            const modalTitle = document.getElementById('link-modal-title');
            document.getElementById('link-folder-id').value = folderId;
            document.getElementById('edit-link-id').value = editLinkId || '';

            if (editLinkId) {
                 const result = findItem(data.urls, editLinkId);
                 if (result && result.item) {
                    modalTitle.textContent = `${_('edit')} ${_('link_name')}`;
                    document.getElementById('new-link-name').value = result.item.name;
                    document.getElementById('new-link-url').value = result.item.url;
                }
            } else {
                modalTitle.textContent = _('add_new_link');
            }
            showModal('add-link-modal');
        }

        function saveLink(e) {
            e.preventDefault();
            const folderId = document.getElementById('link-folder-id').value;
            const editId = document.getElementById('edit-link-id').value;
            const name = document.getElementById('new-link-name').value.trim();
            let url = document.getElementById('new-link-url').value.trim();
            if (!name || !url) return;
            
            if (!/^https?:\/\//i.test(url)) {
                url = 'https://' + url;
            }
            
            if (editId) {
                 const result = findItem(data.urls, editId);
                 if (result && result.item) {
                     result.item.name = name;
                     result.item.url = url;
                     logActivity('edit-3', `Link updated: "${name}"`);
                 }
            } else {
                const parentResult = findItem(data.urls, folderId);
                if (parentResult && parentResult.item && parentResult.item.type === 'folder') {
                    const newLink = { id: `link-${Date.now()}`, type: 'link', name, url };
                    parentResult.item.children.push(newLink);
                    logActivity('link', `New link added to "${parentResult.item.name}": "${name}"`);
                }
            }
            saveData();
            renderUrlPage();
            hideModal('add-link-modal');
        }

        function addEventListeners() {
            // --- 1. GLOBAL DELEGATION (Optimized for Delete & Edit) ---
            document.body.addEventListener('click', (e) => {
                const target = e.target;

                // GLOBAL DELETE LISTENER (Fixes Delete Button in History/Future)
                const deleteOtherBtn = target.closest('.delete-other-task-btn');
                if (deleteOtherBtn) {
                    e.stopPropagation();
                    confirmDeleteOtherTask(deleteOtherBtn.dataset.taskId);
                    return;
                }

                // GLOBAL EDIT LISTENER
                const editOtherBtn = target.closest('.edit-other-task-btn');
                if (editOtherBtn) {
                    e.stopPropagation();
                    showAddOtherTaskModal(editOtherBtn.dataset.taskId);
                    return;
                }

                // AI Coach Link
                if (target.closest('#ai-coach-guide-link') || target.closest('#dashboard-guide-btn')) {
                    if (window.openCreatorModal) window.openCreatorModal();
                    return;
                }
                
                // Chapter Status Buttons
                const statusBtn = target.closest('#chapter-status-buttons button');
                if (statusBtn) {
                    e.preventDefault();
                    document.querySelectorAll('#chapter-status-buttons button').forEach(b => b.classList.remove('active'));
                    statusBtn.classList.add('active');
                    return; 
                }

                // Close Buttons
                if (target.closest('#close-creator-bio-modal')) { hideModal('creator-bio-modal'); return; }
                if (target.classList.contains('modal-backdrop')) {
                    hideModal(target.id);
                    if (target.id === 'update-popup-modal') window.isUpdatePopupClosed = true;
                    return;
                }
                const closeBtn = target.closest('button[id^="close-"]');
                if (closeBtn) {
                    let possibleId = closeBtn.id.replace('close-', '').replace('-x', '');
                    if (possibleId === 'update-popup-modal') window.isUpdatePopupClosed = true;
                    if (document.getElementById(possibleId)) hideModal(possibleId);
                    else if (document.getElementById(possibleId + '-modal')) hideModal(possibleId + '-modal');
                    else { const parentModal = closeBtn.closest('.modal-backdrop'); if (parentModal) hideModal(parentModal.id); }
                    return;
                }

                if (target.closest('#add-task-choice-btn')) { showModal('add-task-choice-modal'); return; }
                if (target.closest('#manual-add-dpt-btn')) { openManualAddModal('dpt'); return; }
                
                // Mobile Nav
                const navBtn = target.closest('.mobile-nav-btn');
                if (navBtn && navBtn.dataset.page) { 
                    e.preventDefault(); 
                    navigateTo(navBtn.dataset.page); 
                    if (!localStorage.getItem('mobile_nav_hint_shown')) {
                        localStorage.setItem('mobile_nav_hint_shown', 'true');
                        const scroller = document.getElementById('mobile-nav-scroller');
                        if(scroller) {
                            setTimeout(() => { scroller.scroll({ left: 200, behavior: 'smooth' }); setTimeout(() => { scroller.scroll({ left: 0, behavior: 'smooth' }); }, 800); }, 500);
                        }
                    }
                    return; 
                }

                const collapsibleHeader = target.closest('.collapsible-header');
                if (collapsibleHeader) {
                    const content = collapsibleHeader.nextElementSibling;
                    const icons = collapsibleHeader.querySelectorAll('i, svg');
                    const icon = icons.length > 0 ? icons[icons.length - 1] : null;
                    if (content) {
                        content.classList.toggle('hidden');
                        content.classList.toggle('animate-fadeIn');
                        if (icon) icon.classList.toggle('rotate-180');
                    }
                    return;
                }
            });

            // --- 2. EXAM FILTER ---
            document.getElementById('exam-filter-buttons')?.addEventListener('click', (e) => {
                const btn = e.target.closest('.exam-filter-btn');
                if (btn) { currentExamFilter = btn.dataset.filter; renderExamsPage(); }
            });

            // --- 3. SETTINGS LISTENERS ---
            document.querySelectorAll('input[name="plan-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => { data.settings.planMode = e.target.value; saveData(); renderSettingsPage(); });
            });
            document.querySelectorAll('input[name="dpt-plan-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => { data.settings.dptPlanMode = e.target.value; saveData(); renderSettingsPage(); });
            });

            navBtns.forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.page)));
            themeToggleBtns.forEach(btn => btn.addEventListener('click', toggleTheme));
            sidebarToggleBtn.addEventListener('click', toggleSidebar);
            document.getElementById('view-updates-btn-sidebar').addEventListener('click', () => navigateTo('updates'));

            document.getElementById('search-input').addEventListener('input', renderSubjectsPage);
            document.getElementById('dpt-search-input').addEventListener('input', renderDptPage);
            document.getElementById('language-select').addEventListener('change', (e) => { data.settings.language = e.target.value; saveData(); applyTranslations(); });
            
            document.getElementById('bg-color-start')?.addEventListener('input', (e) => { data.settings.customThemeColors.start = e.target.value; applyTheme(data.settings.theme); saveData(); });
            document.getElementById('bg-color-end')?.addEventListener('input', (e) => { data.settings.customThemeColors.end = e.target.value; applyTheme(data.settings.theme); saveData(); });
            document.getElementById('reset-theme-btn')?.addEventListener('click', () => { data.settings.customThemeColors.start = null; data.settings.customThemeColors.end = null; applyTheme(data.settings.theme); renderSettingsPage(); saveData(); });

            document.querySelectorAll('.adv-color-picker').forEach(input => {
                input.addEventListener('input', (e) => { data.settings.customThemeColors[e.target.dataset.colorType] = e.target.value; applyManualColors(); saveData(); });
            });
            document.getElementById('reset-advanced-colors-btn')?.addEventListener('click', () => {
                data.settings.customThemeColors.textLight = null; data.settings.customThemeColors.borderLight = null;
                data.settings.customThemeColors.textDark = null; data.settings.customThemeColors.borderDark = null;
                applyManualColors(); renderSettingsPage(); saveData();
            });
            document.getElementById('student-name-input')?.addEventListener('input', (e) => { data.settings.studentName = e.target.value; saveData(); renderHomePage(); });

            const toggleTasksBtn = document.getElementById('toggle-completed-tasks-btn');
            if(toggleTasksBtn) toggleTasksBtn.addEventListener('click', () => { document.getElementById('completed-tasks-list').classList.toggle('hidden'); toggleTasksBtn.querySelector('i').classList.toggle('rotate-180'); });
            const toggleDptBtn = document.getElementById('toggle-completed-dpt-btn');
            if(toggleDptBtn) toggleDptBtn.addEventListener('click', () => { document.getElementById('completed-dpt-list').classList.toggle('hidden'); toggleDptBtn.querySelector('i').classList.toggle('rotate-180'); });

            // Date Completion
            document.getElementById('date-completion-subject-select').addEventListener('change', (e) => {
                const subjectId = e.target.value; const list = document.getElementById('date-completion-chapter-list');
                if (!subjectId) { list.innerHTML = `<p class="text-center text-sm text-text-muted-light">Please select a subject first.</p>`; return; }
                const subject = getSubjectById(subjectId);
                const availableChapters = (subject.chapters || []).filter(c => c.status !== 'Completed');
                if (availableChapters.length === 0) { list.innerHTML = `<p class="text-center text-sm text-text-muted-light">All chapters completed.</p>`; return; }
                list.innerHTML = availableChapters.map(c => `<label class="flex items-center gap-2 p-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded cursor-pointer"><input type="checkbox" class="date-comp-chapter-checkbox form-checkbox h-4 w-4 text-primary rounded" value="${c.id}"><span>${c.name}</span></label>`).join('');
            });

            document.getElementById('save-date-completion-btn').addEventListener('click', () => {
                const modal = document.getElementById('date-completion-modal'); const completionDate = modal.dataset.date;
                const subjectId = document.getElementById('date-completion-subject-select').value;
                const selectedCheckboxes = document.querySelectorAll('.date-comp-chapter-checkbox:checked');
                if (!subjectId || selectedCheckboxes.length === 0) { alert('Select subject and at least one chapter.'); return; }
                selectedCheckboxes.forEach(cb => { updateChapterStatus(subjectId, cb.value, 'Completed', false, completionDate); });
                logActivity('calendar-check-2', `Manually marked ${selectedCheckboxes.length} chapters as completed on ${completionDate}`);
                saveData(); renderCalendarPage(); hideModal('date-completion-modal');
            });

            const subjectsContainer = document.getElementById('subjects-list-container');
            subjectsContainer.addEventListener('click', e => {
                const addBtn = e.target.closest('.add-chapter-btn');
                const chapterItem = e.target.closest('.chapter-item');
                const deleteSubBtn = e.target.closest('.delete-subject-btn');
                const restudyBtn = e.target.closest('.restudy-subject-btn');
                if (addBtn) showAddChapterModal(addBtn.dataset.subjectId);
                else if (chapterItem) showChapterModal(chapterItem.dataset.subjectId, chapterItem.dataset.chapterId);
                else if (deleteSubBtn) { e.preventDefault(); e.stopPropagation(); confirmDeleteSubject(deleteSubBtn.dataset.subjectId); }
                else if (restudyBtn) { e.preventDefault(); e.stopPropagation(); confirmRestudySubject(restudyBtn.dataset.subjectId); }
            });

            // Dashboard Actions
            const dashboardTasksContainer = document.getElementById('todays-plan-container');
            dashboardTasksContainer.addEventListener('click', e => {
                const btn = e.target.closest('.task-action-btn'); if (!btn) return;
                e.stopPropagation(); e.preventDefault();
                btn.style.transform = "scale(0.9)"; setTimeout(() => btn.style.transform = "scale(1)", 100);

                if (btn.classList.contains('skip-btn')) {
                    btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin text-blue-600"></i>'; lucide.createIcons();
                    requestAnimationFrame(() => skipChapter(btn.dataset.subjectId, btn.dataset.chapterId));
                } else if (btn.classList.contains('postpone-btn')) {
                    const { taskId, taskType, subjectId, chapterId, revisionDate } = btn.dataset;
                    if (taskType === 'other') postponeOtherTask(taskId);
                    else if (taskType === 'revision') postponeRevision(subjectId, chapterId, revisionDate);
                    else openPostponeModal(subjectId, chapterId);
                } else if (btn.classList.contains('delete-manual-task-btn')) {
                    const todayStr = getLocalDateString();
                    if(data.dailyPlan[todayStr]?.manualTasks) { data.dailyPlan[todayStr].manualTasks = data.dailyPlan[todayStr].manualTasks.filter(t => t.id !== btn.dataset.manualId); saveData(); renderHomePage(); }
                }
            });

            document.querySelectorAll('.day-selector-btn').forEach(btn => {
                btn.addEventListener('click', function(e) { e.preventDefault(); this.classList.toggle('bg-indigo-600'); this.classList.toggle('text-white'); this.classList.toggle('active'); this.classList.toggle('bg-white'); this.classList.toggle('dark:bg-gray-900'); });
            });
            document.getElementById('other-task-repeat')?.addEventListener('change', (e) => {
                const container = document.getElementById('day-selection-container');
                if(e.target.checked) { container.classList.remove('hidden'); container.classList.add('block', 'animate-fadeIn'); } else { container.classList.add('hidden'); container.classList.remove('block', 'animate-fadeIn'); }
            });

            const dptWrapper = document.getElementById('todays-dpt-container-wrapper');
            if (dptWrapper) {
                dptWrapper.addEventListener('click', e => {
                    const skipBtn = e.target.closest('.skip-dpt-btn'); const completeBtn = e.target.closest('.mark-dpt-complete-btn'); const deleteManualBtn = e.target.closest('.manual-dpt-delete-btn'); const viewBtn = e.target.closest('.view-dpt-details-btn');
                    if (skipBtn) { e.stopPropagation(); skipBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin text-blue-600"></i>'; lucide.createIcons(); setTimeout(() => skipDpt(skipBtn.dataset.subjectId), 100); } 
                    else if (completeBtn) { e.stopPropagation(); showDptDetailsModal(completeBtn.dataset.subjectId, completeBtn.dataset.chapterId, parseInt(completeBtn.dataset.testId)); } 
                    else if (deleteManualBtn) { e.stopPropagation(); const todayStr = getLocalDateString(); if(data.dailyDptPlan[todayStr]) { data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr].filter(t => t.id !== deleteManualBtn.dataset.manualId); saveData(); renderHomePage(); } } 
                    else if (viewBtn) { e.stopPropagation(); showDptDetailsModal(viewBtn.dataset.subjectId, viewBtn.dataset.chapterId, parseInt(viewBtn.dataset.testId)); }
                });
            }

            const dptContainer = document.getElementById('dpt-list-container');
            dptContainer.addEventListener('click', e => {
                const target = e.target; const dptItem = target.closest('.dpt-list-item'); const addBtn = target.closest('.add-dpt-to-chapter-btn'); const addAllBtn = target.closest('.add-dpt-to-all-chapters-btn'); const deleteAllSubBtn = target.closest('.delete-all-dpts-subject-btn');
                if (dptItem) showDptDetailsModal(dptItem.dataset.subjectId, dptItem.dataset.chapterId, dptItem.dataset.testId);
                else if (addBtn) showAddChapterDptModal(addBtn.dataset.subjectId, addBtn.dataset.chapterId);
                else if (addAllBtn) showAddAllChaptersDptModal(addAllBtn.dataset.subjectId);
                else if (deleteAllSubBtn) confirmDeleteAllDptsForSubject(deleteAllSubBtn.dataset.subjectId);
            });
            document.getElementById('dpt-global-actions-container').addEventListener('click', e => { if (e.target.closest('#delete-all-dpts-global-btn')) confirmDeleteAllDptsGlobally(); if (e.target.closest('#add-global-dpts-btn')) showAddGlobalDptModal(); });
            document.getElementById('save-global-dpt-btn').addEventListener('click', saveGlobalDpt);

            document.getElementById('exams-list-container').addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-exam-btn'); const deleteBtn = e.target.closest('.delete-exam-btn');
                if (editBtn) showAddExamModal(editBtn.dataset.examId); else if (deleteBtn) deleteExam(deleteBtn.dataset.examId);
            });

            document.getElementById('url-container').addEventListener('click', e => {
                // Only Global Edit/Delete actions needed here
                // Navigation logic is inside renderUrlPage now for cleaner scope access
                const editFolder = e.target.closest('.edit-folder-btn'); 
                const delFolder = e.target.closest('.delete-folder-btn'); 
                const editLink = e.target.closest('.edit-link-btn'); 
                const delLink = e.target.closest('.delete-link-btn');
                
                if (editFolder) { e.stopPropagation(); showAddFolderModal(editFolder.dataset.folderId); }
                else if (delFolder) { e.stopPropagation(); deleteItem(delFolder.dataset.folderId); }
                else if (editLink) { e.stopPropagation(); showAddLinkModal(null, editLink.dataset.linkId); }
                else if (delLink) { e.stopPropagation(); deleteItem(delLink.dataset.linkId); }
            });

            const handleForm = (id, handler) => {
                const form = document.getElementById(id);
                if (form) {
                    const newForm = form.cloneNode(true);
                    form.parentNode.replaceChild(newForm, form);
                    newForm.addEventListener('submit', (e) => { e.preventDefault(); handler(e); });
                }
            };

            handleForm('add-chapter-form', () => { addNewChapter(document.getElementById('add-chapter-subject-id').value, document.getElementById('new-chapter-name').value); });
            handleForm('add-subject-form', createSubject);
            handleForm('postpone-chapter-form', savePostponement);
            handleForm('add-exam-form', saveExam);
            handleForm('dpt-details-form', submitDptDetails);
            handleForm('add-chapter-dpt-form', handleAddDptToChapter);
            handleForm('add-all-chapters-dpt-form', handleAddDptToAllChapters);
            handleForm('add-folder-form', saveFolder);
            handleForm('add-link-form', saveLink);
            
            // --- FIX FOR OTHER TASK SAVE ---
            handleForm('add-other-task-form', saveOtherTask);

            document.getElementById('add-new-subject-btn').addEventListener('click', showAddSubjectModal);
            document.getElementById('add-exam-btn').addEventListener('click', () => showAddExamModal());
            document.getElementById('add-new-root-folder-btn').addEventListener('click', () => showAddFolderModal());
            document.getElementById('save-manual-add-btn').addEventListener('click', saveManualTask);
            document.getElementById('save-chapter-details-btn').addEventListener('click', (e) => saveChapterDetails(e.currentTarget.dataset.subjectId, e.currentTarget.dataset.chapterId));
            document.getElementById('delete-chapter-details-btn').addEventListener('click', (e) => confirmDeleteChapter(e.currentTarget.dataset.subjectId, e.currentTarget.dataset.chapterId));

            document.getElementById('missed-other-tasks-list')?.addEventListener('click', e => {
                const btn = e.target.closest('.add-missed-other-task-btn');
                if (btn) {
                    const taskId = btn.dataset.taskId; const task = data.missedOtherTasks.find(t => t.id === taskId);
                    if (task) {
                        const todayStr = getLocalDateString();
                        const newTask = { ...task, id: `other-${Date.now()}`, date: todayStr, status: 'Pending' };
                        data.otherTasks.push(newTask);
                        data.missedOtherTasks = data.missedOtherTasks.filter(t => t.id !== taskId);
                        logActivity('plus', `Moved missed task to today: "${task.description}"`);
                        saveData(); renderHomePage();
                    }
                }
            });
            
            document.getElementById('choice-manual-chapter-btn').addEventListener('click', () => { hideModal('add-task-choice-modal'); openManualAddModal('chapter'); });
            document.getElementById('choice-other-task-btn').addEventListener('click', () => { hideModal('add-task-choice-modal'); showAddOtherTaskModal(); });

            document.getElementById('subject-view-filter').addEventListener('click', (e) => { const btn = e.target.closest('.filter-btn'); if (btn) { subjectPageViewMode = btn.dataset.view; renderSubjectsPage(); } });
            document.getElementById('dpt-view-filter').addEventListener('click', (e) => { const btn = e.target.closest('.filter-btn'); if (btn) { dptPageViewMode = btn.dataset.view; renderDptPage(); } });
            document.getElementById('dpt-subject-filter').addEventListener('change', renderDptPage);

            // Import/Export
            const mainFileInput = document.getElementById('import-file-input');
            const newFileInput = mainFileInput.cloneNode(true);
            mainFileInput.parentNode.replaceChild(newFileInput, mainFileInput);
            newFileInput.addEventListener('change', handleFileUpload);

            document.getElementById('export-full-data-btn').addEventListener('click', () => exportData('full'));
            document.getElementById('import-full-backup-btn').addEventListener('click', () => { const input = document.getElementById('import-file-input'); input.dataset.importType = 'full_backup'; input.click(); });
            document.getElementById('export-exams-btn').addEventListener('click', () => exportData('exams'));
            document.getElementById('import-exams-btn').addEventListener('click', () => { const input = document.getElementById('import-file-input'); input.dataset.importType = 'exams'; input.click(); });
            document.getElementById('export-urls-btn').addEventListener('click', () => exportData('urls'));
            document.getElementById('import-urls-btn').addEventListener('click', () => { const input = document.getElementById('import-file-input'); input.dataset.importType = 'urls'; input.click(); });
            
            const btnImportRoutine = document.getElementById('import-routine-btn-new');
            if(btnImportRoutine) { const newBtn = btnImportRoutine.cloneNode(true); btnImportRoutine.parentNode.replaceChild(newBtn, btnImportRoutine); newBtn.addEventListener('click', () => { const input = document.getElementById('import-file-input'); input.dataset.importType = 'routine'; input.click(); }); }
            const btnImportChapters = document.getElementById('import-all-chapters-btn');
            if(btnImportChapters) { const newBtn = btnImportChapters.cloneNode(true); btnImportChapters.parentNode.replaceChild(newBtn, btnImportChapters); newBtn.addEventListener('click', () => { const input = document.getElementById('import-file-input'); input.dataset.importType = 'chapters'; input.click(); }); }

            document.getElementById('reset-app-btn').addEventListener('click', resetApp);
            document.getElementById('reset-study-date-btn').addEventListener('click', resetStudyDate);
            document.getElementById('delete-all-chapters-btn').addEventListener('click', deleteAllChaptersForSubject);
            
            document.body.addEventListener('click', (e) => {
                if (e.target.id === 'add-personal-note-btn') showAddNotePopup();
                const delNoteBtn = e.target.closest('.delete-personal-note-btn');
                if (delNoteBtn) { data.personalNotes.splice(parseInt(delNoteBtn.dataset.index), 1); saveData(); renderNoticesPage(); }
            });

            const dptToggle = document.getElementById('global-dpt-toggle');
            if (dptToggle) { dptToggle.checked = data.settings.dptDashboardActive !== false; document.getElementById('dpt-toggle-text').innerText = dptToggle.checked ? "Active" : "Hidden"; dptToggle.addEventListener('change', (e) => { data.settings.dptDashboardActive = e.target.checked; document.getElementById('dpt-toggle-text').innerText = e.target.checked ? "Active" : "Hidden"; saveData(); renderHomePage(); }); }
            
            document.querySelectorAll('.adv-day-btn').forEach(btn => {
                btn.addEventListener('click', function(e) { e.preventDefault(); this.classList.toggle('bg-indigo-600'); this.classList.toggle('text-white'); this.classList.toggle('border-indigo-600'); this.classList.toggle('shadow-md'); this.classList.toggle('bg-white'); this.classList.toggle('dark:bg-gray-900'); this.dataset.selected = this.classList.contains('bg-indigo-600') ? "true" : "false"; });
            });

            document.getElementById('toggle-custom-name-btn')?.addEventListener('click', () => {
                const select = document.getElementById('adv-routine-subject-select'); const input = document.getElementById('adv-routine-custom-name'); const btn = document.getElementById('toggle-custom-name-btn');
                if (input.classList.contains('hidden')) { input.classList.remove('hidden'); select.classList.add('hidden'); btn.textContent = 'Select Subject'; select.value = ""; } else { input.classList.add('hidden'); select.classList.remove('hidden'); btn.textContent = 'Type Custom'; input.value = ""; }
            });

            document.getElementById('save-adv-routine-btn')?.addEventListener('click', () => {
                const select = document.getElementById('adv-routine-subject-select'); const input = document.getElementById('adv-routine-custom-name');
                const days = []; document.querySelectorAll('.adv-day-btn').forEach(btn => { if (btn.dataset.selected === "true" || btn.classList.contains('bg-indigo-600')) { days.push(parseInt(btn.dataset.day)); } });
                if (days.length === 0) { alert('Please select at least one day (Mon-Sun).'); return; }
                let subjectId, name;
                if (!input.classList.contains('hidden') && input.value.trim()) { name = input.value.trim(); subjectId = `custom-${Date.now()}`; } else if (select.value) { subjectId = select.value; name = select.options[select.selectedIndex].text; } else { alert('Please select a subject from the list or type a custom name.'); return; }
                data.settings.customSubjectRoutine = data.settings.customSubjectRoutine || []; data.settings.customSubjectRoutine.push({ subjectId, name, days, active: true });
                delete data.dailyPlan[getLocalDateString()];
                document.querySelectorAll('.adv-day-btn').forEach(btn => { btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600', 'shadow-md'); btn.classList.add('bg-white', 'dark:bg-gray-900'); btn.dataset.selected = "false"; }); select.value = ""; input.value = "";
                saveData(); renderAdvancedRoutineUI(); renderHomePage(); alert("Routine added successfully! Check Today's Plan.");
            });

            document.getElementById('adv-routine-list')?.addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('.toggle-adv-routine-btn'); const deleteBtn = e.target.closest('.delete-adv-routine-btn');
                if (toggleBtn) { const index = parseInt(toggleBtn.dataset.index); if (data.settings.customSubjectRoutine[index]) { data.settings.customSubjectRoutine[index].active = !data.settings.customSubjectRoutine[index].active; delete data.dailyPlan[getLocalDateString()]; saveData(); renderAdvancedRoutineUI(); renderHomePage(); } }
                if (deleteBtn) { const index = parseInt(deleteBtn.dataset.index); data.settings.customSubjectRoutine.splice(index, 1); delete data.dailyPlan[getLocalDateString()]; saveData(); renderAdvancedRoutineUI(); renderHomePage(); }
            });

            document.getElementById('missed-chapters-list').addEventListener('click', e => {
                const btn = e.target.closest('.complete-missed-chapter-btn');
                if (btn) { const { subjectId, chapterId } = btn.dataset; const todayStr = getLocalDateString(); data.dailyPlan[todayStr] = data.dailyPlan[todayStr] || { tasks: {}, completedSubjects: [], manualTasks: [] }; data.dailyPlan[todayStr].manualTasks.push({ subjectId, chapterId, id: `manual-${Date.now()}` }); data.missedChapters = data.missedChapters.filter(c => c.chapterId !== chapterId); saveData(); renderHomePage(); }
            });
            document.getElementById('missed-revisions-list').addEventListener('click', e => {
                const btn = e.target.closest('.complete-missed-revision-btn');
                if (btn) { updateRevisionStatus(btn.dataset.subjectId, btn.dataset.chapterId, btn.dataset.revisionDate, true); data.missedRevisions = data.missedRevisions.filter(r => !(r.chapterId === btn.dataset.chapterId && r.revisionDate === btn.dataset.revisionDate)); saveData(); renderHomePage(); }
            });
            
            document.getElementById('manual-add-subject-select').addEventListener('change', (e) => { const modal = document.getElementById('manual-add-modal'); if(modal.dataset.type === 'dpt') { populateManualItemList(e.target.value, 'dpt'); } });

            document.getElementById('todays-plan-container').addEventListener('change', (e) => { 
                const checkbox = e.target; if (!checkbox.classList.contains('task-checkbox') && !checkbox.classList.contains('revision-checkbox')) return;
                const listItem = checkbox.closest('.task-list-item'); const taskType = checkbox.dataset.taskType;
                if (checkbox.checked) {
                    listItem?.classList.add('completed');
                    setTimeout(() => {
                        if (taskType === 'revision') updateRevisionStatus(checkbox.dataset.subjectId, checkbox.dataset.chapterId, checkbox.dataset.revisionDate, true);
                        else if (taskType === 'other') updateOtherTaskStatus(checkbox.dataset.taskId, 'Completed');
                        else { 
                            updateChapterStatus(checkbox.dataset.subjectId, checkbox.dataset.chapterId, 'Completed'); 
                            if (taskType === 'chapter' && checkbox.dataset.subjectIdOnly) markSubjectAsDoneForToday(checkbox.dataset.subjectIdOnly);
                            else if (taskType === 'manual_chapter') { const todayStr = getLocalDateString(); const taskId = listItem.dataset.manualId; data.dailyPlan[todayStr].manualTasks = data.dailyPlan[todayStr].manualTasks.filter(t => t.id !== taskId); saveData(); renderHomePage(); }
                        }
                    }, 500);
                }
            });
            
            window.addEventListener('resize', () => { if (data.settings.backgroundStyle !== 'default') { stopAllBackgroundAnimations(); applyBackgroundStyle(); } });
        }
        
        function openDateCompletionModal(dateStr) {
            const modal = document.getElementById('date-completion-modal'); 
            modal.dataset.date = dateStr;
            document.getElementById('date-completion-modal-title').textContent = `Mark Completion for ${new Date(dateStr).toLocaleDateString()}`;
            
            const subjectSelect = document.getElementById('date-completion-subject-select');
            // Reset select
            subjectSelect.value = "";
            subjectSelect.innerHTML = `<option value="">-- Choose a Subject --</option>` + (data.subjects || []).map(s => `<option value="${s.id}">${_(s.id)}</option>`).join('');
            
            document.getElementById('date-completion-chapter-list').innerHTML = `<p class="text-center text-sm text-text-muted-light">Please select a subject first.</p>`;
            showModal('date-completion-modal');
        }
        
        function showAddSubjectModal() { document.getElementById('add-subject-form').reset(); showModal('add-subject-modal'); }
        
        function createSubject(e) {
            e.preventDefault();
            const subjectName = document.getElementById('new-subject-name').value.trim();
            if (subjectName) {
                const subjectId = subjectName.toLowerCase().replace(/\s+/g, '-');
                if ((data.subjects || []).some(s => s.id === subjectId)) { alert(_('subject_exists')); return; }
                const newSubject = { id: subjectId, name: subjectName, chapters: [], completionCount: 0 };
                data.subjects.push(newSubject);
                if (!translations.en[subjectId]) { translations.en[subjectId] = subjectName; translations.hi[subjectId] = subjectName; }
                logActivity('plus-circle', `New subject added: "${subjectName}"`);
                saveData(); renderSubjectsPage();
                if(document.getElementById('page-settings').classList.contains('active')) renderSettingsPage();
                if(document.getElementById('page-dpt').classList.contains('active')) renderDptPage();
                hideModal('add-subject-modal');
                showAddChapterModal(subjectId);
            }
        }

        function deleteAllChaptersForSubject() {
            showConfirmationModal( _('delete_all') + '?', 'Are you sure you want to delete ALL chapters for ALL subjects? This cannot be undone.', () => {
                    (data.subjects || []).forEach(subject => { subject.chapters = []; });
                    logActivity('trash-2', `Deleted all chapters.`);
                    saveData(); alert(`All chapters have been deleted.`);
                   if (document.getElementById('page-subjects').classList.contains('active')) { renderSubjectsPage(); }
                }
            );
        }

        function renderScheduledRevisions(chapter) {
            const container = document.getElementById('scheduled-revisions-list');
            if (!chapter.revisions || chapter.revisions.length === 0) { container.innerHTML = '<p class="text-xs text-center text-gray-400">No revisions scheduled.</p>'; return; }
            container.innerHTML = chapter.revisions.sort((a,b) => new Date(a.date) - new Date(b.date)).map(rev => {
                const isManual = rev.type === 'manual'; const isPast = new Date(rev.date) < new Date(getLocalDateString());
                return `<div class="flex items-center justify-between p-2 text-sm rounded-md ${rev.status === 'Completed' ? 'bg-green-100 dark:bg-green-900/40' : 'bg-gray-100 dark:bg-gray-800'}">
                    <span class="font-semibold ${isPast && rev.status !== 'Completed' ? 'text-red-500' : ''}">${new Date(rev.date).toLocaleDateString()}</span>
                    <div><span class="text-xs font-bold px-1.5 py-0.5 rounded ${isManual ? 'bg-violet-200 text-violet-800' : 'bg-blue-200 text-blue-800'}">${isManual ? 'Manual' : 'Auto'}</span>
                    ${isManual ? `<button class="delete-revision-btn p-1 ml-1 text-red-500 hover:bg-red-100 rounded-full" data-revision-date="${rev.date}" data-subject-id="${document.getElementById('add-manual-revision-btn').dataset.subjectId}" data-chapter-id="${chapter.id}"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}</div></div>`;
            }).join('');
            lucide.createIcons();
        }

        function addManualRevision(subjectId, chapterId, sourceType, date) {
            if (!date) { alert('Please select a date for the revision.'); return; }
            const chapter = getChapterByIds(subjectId, chapterId);
            if (chapter) {
                chapter.revisions.push({ date, status: 'Pending', type: 'manual' });
                logActivity('calendar-plus', `Manual revision scheduled for "${chapter.name}" on ${date}`);
                saveData(); renderScheduledRevisions(chapter);
                document.getElementById('manual-revision-date').value = '';
            }
        }

        function deleteRevision(subjectId, chapterId, sourceType, revisionDate) {
            const chapter = getChapterByIds(subjectId, chapterId);
            if (chapter) {
                const initialLength = chapter.revisions.length;
                chapter.revisions = chapter.revisions.filter(r => r.date !== revisionDate);
                if (chapter.revisions.length < initialLength) {
                    logActivity('calendar-minus', `Revision for "${chapter.name}" on ${revisionDate} deleted.`);
                    saveData(); renderScheduledRevisions(chapter);
                }
            }
        }

        function exportRoutine(format) {
            const plan = data.settings.planMode === 'custom_cycle' ? data.settings.customCyclePlan : dailyPattern;
            const dayNames = [ _('sunday'), _('monday'), _('tuesday'), _('wednesday'), _('thursday'), _('friday'), _('saturday')];
            const routineData = {};
            plan.forEach((subjects, index) => {
                const week = index < 7 ? 1 : 2;
                const dayName = `${dayNames[index % 7]} (${_('week')} ${week})`;
                routineData[dayName] = subjects.map(s => {
                    // Clean ID if it has :notes suffix
                    const id = s.split(':')[0];
                    return _(id);
                });
            });

            if (format === 'json') {
                const dataStr = JSON.stringify(plan, null, 2); 
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `study_routine_${getLocalDateString()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                pdf.setFont('helvetica', 'bold');
                pdf.text("14-Day Study Routine", 105, 15, null, null, 'center');
                pdf.setFont('helvetica', 'normal');
                let y = 30;
                Object.entries(routineData).forEach(([day, subjects]) => {
                    if (y > 280) {
                        pdf.addPage();
                        y = 15;
                    }
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(day, 14, y);
                    y += 7;
                    pdf.setFont('helvetica', 'normal');
                    if(subjects.length > 0) {
                        subjects.forEach(subject => {
                            pdf.text(`- ${subject}`, 20, y);
                            y += 6;
                        });
                    } else {
                        pdf.text("- Rest Day -", 20, y);
                        y+=6;
                    }
                    y += 4;
                });
                pdf.save(`study_routine_${getLocalDateString()}.pdf`);
            }
        }

        function confirmDeleteAllDptsForSubject(subjectId) {
            const subject = getSubjectById(subjectId);
            if (!subject) return;
            showConfirmationModal(
                _('delete_all_dpts'),
                _('delete_all_dpts_confirm', { subjectName: _(subject.id) }),
                () => {
                    if (data.dpts[subjectId]) {
                        delete data.dpts[subjectId];
                        logActivity('trash-2', `Deleted all DPTs for ${_(subject.id)}`);
                        saveData();
                        renderDptPage();
                        renderHomePage();
                    }
                }
            );
        }
        
        function confirmDeleteAllDptsGlobally() {
            showConfirmationModal(
                'Delete All DPTs?',
                'Are you sure you want to delete ALL DPTs for ALL subjects? This action is permanent and cannot be undone.',
                () => {
                    data.dpts = {};
                    data.dailyDptPlan = {};
                    logActivity('trash-2', 'Deleted all DPTs for all subjects.');
                    saveData();
                    renderDptPage();
                    renderHomePage();
                }
            );
        }

        function showAddGlobalDptModal() {
            const modal = document.getElementById('add-global-dpt-modal');
            const list = document.getElementById('global-dpt-subject-list');
            const selectAllCb = document.getElementById('global-dpt-select-all');
            
            // Populate Subject List
            list.innerHTML = (data.subjects || []).filter(s => !DPT_EXCLUDED_SUBJECTS.includes(s.id)).map(s => `
                <label class="flex items-center gap-3 p-2 hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded cursor-pointer">
                    <input type="checkbox" class="global-dpt-subject-cb form-checkbox h-4 w-4 text-primary rounded" value="${s.id}">
                    <span class="text-sm font-medium">${_(s.id)}</span>
                </label>
            `).join('');

            // Reset inputs
            selectAllCb.checked = false;
            document.getElementById('global-dpt-quantity').value = 1;

            // Handle Select All
            selectAllCb.onclick = (e) => {
                const checked = e.target.checked;
                document.querySelectorAll('.global-dpt-subject-cb').forEach(cb => cb.checked = checked);
            };

            showModal('add-global-dpt-modal');
        }

        function saveGlobalDpt() {
            const quantity = parseInt(document.getElementById('global-dpt-quantity').value);
            const checkboxes = document.querySelectorAll('.global-dpt-subject-cb:checked');
            const selectedSubjectIds = Array.from(checkboxes).map(cb => cb.value);

            if (isNaN(quantity) || quantity < 1) { alert("Please enter a valid quantity."); return; }
            if (selectedSubjectIds.length === 0) { alert("Please select at least one subject."); return; }

            let totalAdded = 0;
            let subjectsAffected = 0;

            selectedSubjectIds.forEach(subjectId => {
                const subject = getSubjectById(subjectId);
                if (subject && subject.chapters) {
                    let addedForSubject = 0;
                    subject.chapters.forEach(chapter => {
                        data.dpts[subjectId] = data.dpts[subjectId] || { chapters: {} };
                        data.dpts[subjectId].chapters[chapter.id] = data.dpts[subjectId].chapters[chapter.id] || [];
                        
                        const startId = data.dpts[subjectId].chapters[chapter.id].length + 1;
                        for (let i = 0; i < quantity; i++) {
                            data.dpts[subjectId].chapters[chapter.id].push({ id: startId + i, status: 'Pending', details: null });
                        }
                        addedForSubject += quantity;
                    });
                    if (addedForSubject > 0) {
                        totalAdded += addedForSubject;
                        subjectsAffected++;
                    }
                }
            });

            logActivity('layers', `Global Add: ${totalAdded} DPTs added across ${subjectsAffected} subjects.`);
            saveData();
            hideModal('add-global-dpt-modal');
            renderDptPage();
            alert(`Success! Added ${totalAdded} new DPTs.`);
        }

        function confirmRestudySubject(subjectId) {
            const subject = getSubjectById(subjectId);
            if (!subject) return;
            showConfirmationModal(
                _('restudy_subject'),
                _('restudy_subject_confirm', { subjectName: _(subject.id) }),
                () => {
                    subject.completionCount = (subject.completionCount || 0) + 1;
                    const resetChapters = (chapters) => {
                        (chapters || []).forEach(c => {
                            c.status = 'Not Started';
                            delete c.dateCompleted;
                            c.revisions = [];
                        });
                    };
                    resetChapters(subject.chapters);
                    logActivity('refresh-cw', `Started re-study cycle #${subject.completionCount + 1} for ${_(subject.id)}`);
                    saveData();
                    renderSubjectsPage();
                    renderHomePage();
                }
            );
        }

        function printElement(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            const page = element.closest('.page');
            
            document.body.classList.add('is-printing');
            if(page) page.classList.add('printable');

            setTimeout(() => {
                window.print();
                document.body.classList.remove('is-printing');
                if(page) page.classList.remove('printable');
            }, 100);
        }

        function showAddOtherTaskModal(editTaskId = null) {
            const form = document.getElementById('add-other-task-form');
            
            // --- CRITICAL FIX: REMOVE OLD LISTENERS & ATTACH NEW ONE ---
            // We clone the form to strip old event listeners that might be broken
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            // Attach the ONE robust save listener
            newForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveOtherTask(e);
            });

            // Re-grab references from the NEW form (since we replaced the node)
            const modalTitle = document.getElementById('add-other-task-title');
            const editIdInput = document.getElementById('edit-other-task-id');
            const descInput = document.getElementById('other-task-description');
            const suggestionsContainer = document.getElementById('task-suggestions-container');
            const repeatCheckbox = document.getElementById('other-task-repeat');
            const dayContainer = document.getElementById('day-selection-container');

            newForm.reset(); 
            editIdInput.value = editTaskId || '';
            document.getElementById('other-task-date').value = getLocalDateString();
            
            // --- SMART SUGGESTIONS LOGIC (GOOGLE STYLE) ---
            // Re-attach input listener since node was replaced
            descInput.addEventListener('input', function() {
                const val = this.value.toLowerCase();
                if (!val) { suggestionsContainer.classList.add('hidden'); return; }
                
                const pastTasks = new Set([
                    ...(data.otherTasks || []).map(t => t.description),
                    ...(data.otherTaskHistory || []).map(t => t.description)
                ]);
                
                const matches = [...pastTasks].filter(d => d.toLowerCase().includes(val)).slice(0, 5);
                
                if (matches.length > 0) {
                    suggestionsContainer.innerHTML = matches.map(m => `
                        <div class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-sm flex items-center gap-2 suggestion-item">
                            <i data-lucide="history" class="w-3 h-3 text-gray-400"></i> ${m}
                        </div>
                    `).join('');
                    suggestionsContainer.classList.remove('hidden');
                    lucide.createIcons();
                    
                    document.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', () => {
                            descInput.value = item.innerText.trim();
                            suggestionsContainer.classList.add('hidden');
                        });
                    });
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#other-task-description')) {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            // Day Selector Logic - Re-attach
            document.querySelectorAll('.day-selector-btn').forEach(btn => {
                btn.className = "day-selector-btn h-10 rounded-lg text-xs font-bold flex flex-col items-center justify-center bg-white dark:bg-gray-900 border shadow-sm hover:border-indigo-500 transition-all";
                if(btn.dataset.day === "0") btn.classList.add('hover:border-red-500', 'text-red-500');
                
                btn.onclick = function(e) {
                    e.preventDefault();
                    this.classList.toggle('bg-indigo-600');
                    this.classList.toggle('text-white');
                    this.classList.toggle('active');
                    this.classList.toggle('bg-white');
                    this.classList.toggle('dark:bg-gray-900');
                }
            });

            if (repeatCheckbox) {
                repeatCheckbox.checked = false;
                dayContainer.style.display = 'none';
                repeatCheckbox.onclick = function() {
                    dayContainer.style.display = this.checked ? 'block' : 'none';
                };
            }

            // Edit Mode Pre-fill
            if (editTaskId) {
                const task = (data.otherTasks || []).find(t => t.id === editTaskId) || (data.postponedOtherTasks || []).find(t => t.id === editTaskId);
                if (task) {
                    modalTitle.textContent = "Edit Task";
                    descInput.value = task.description;
                    document.getElementById('other-task-date').value = task.date;
                    document.getElementById('other-task-notes').value = task.notes || '';
                    document.getElementById('other-task-tag').value = task.tag || '';
                    document.getElementById('other-task-priority').checked = task.priority || false;
                    
                    if (task.isRepeating) {
                        repeatCheckbox.checked = true;
                        dayContainer.style.display = 'block';
                        if (task.repeatDays) {
                            task.repeatDays.forEach(dayIndex => {
                                const btn = document.querySelector(`.day-selector-btn[data-day="${dayIndex}"]`);
                                if (btn) {
                                    btn.classList.add('bg-indigo-600', 'text-white', 'active');
                                    btn.classList.remove('bg-white', 'dark:bg-gray-900');
                                }
                            });
                        }
                    }
                }
            } else {
                modalTitle.textContent = "Add Other Task";
            }

            showModal('add-other-task-modal');
        }

        function saveOtherTask(e) {
            // Safety check for event
            if(e) e.preventDefault();
            
            const editId = document.getElementById('edit-other-task-id').value;
            const description = document.getElementById('other-task-description').value.trim();
            const date = document.getElementById('other-task-date').value;
            const notes = document.getElementById('other-task-notes').value.trim();
            const tag = document.getElementById('other-task-tag').value.trim();
            const isRepeating = document.getElementById('other-task-repeat').checked;
            const isPriority = document.getElementById('other-task-priority').checked;
            
            if (!description || !date) {
                alert('Please enter Task Description and Date.');
                return;
            }

            let repeatDays = [];
            if (isRepeating) {
                document.querySelectorAll('.day-selector-btn.active').forEach(btn => {
                    repeatDays.push(parseInt(btn.dataset.day));
                });
                if (repeatDays.length === 0) {
                    alert('Please select at least one day for repetition.');
                    return;
                }
            }

            if (editId) {
                // Edit Logic
                // Check both Main List and Postponed List
                let task = data.otherTasks.find(t => t.id === editId);
                if (!task) task = data.postponedOtherTasks.find(t => t.id === editId);

                if (task) {
                    task.description = description;
                    task.date = date;
                    task.notes = notes;
                    task.tag = tag;
                    task.isRepeating = isRepeating;
                    task.repeatDays = repeatDays;
                    task.priority = isPriority;
                    logActivity('edit-3', `Task updated: "${description}"`);
                }
            } else {
                // New Task Logic
                const newTask = {
                    id: `other-${Date.now()}-${Math.floor(Math.random()*1000)}`,
                    description, date, notes, tag,
                    status: 'Pending', completedDate: null,
                    isRepeating, repeatDays, lastCompletedDate: null, deletedInstances: [], priority
                };
                data.otherTasks.push(newTask);
                logActivity('clipboard-list', `New task added: "${description}"`);
            }

            saveData();
            hideModal('add-other-task-modal');
            
            // Immediate Refresh
            renderHomePage();
            // Force refresh Notices Page if it's active or even if in background to keep sync
            renderNoticesPage();
        }

        function updateOtherTaskStatus(taskId, newStatus) {
            const task = (data.otherTasks || []).find(t => t.id === taskId) || (data.postponedOtherTasks || []).find(t => t.id === taskId);
            if (task) {
                const todayStr = getLocalDateString();
                task.status = newStatus;
                
                if (newStatus === 'Completed') {
                    task.completedDate = todayStr;
                    if(task.isRepeating) {
                        task.lastCompletedDate = todayStr;
                    }
                    logActivity('check-square', `Other task completed: "${task.description}"`);
                    
                    // --- HISTORY FIX (GUARANTEED) ---
                    // Explicitly push to history array
                    if(!data.otherTaskHistory) data.otherTaskHistory = [];
                    data.otherTaskHistory.unshift({ 
                        description: task.description,
                        status: 'Completed',
                        timestamp: new Date().toISOString()
                    });
                    
                    // Limit to last 100 to prevent lag
                    if(data.otherTaskHistory.length > 100) data.otherTaskHistory = data.otherTaskHistory.slice(0, 100);
                    
                    // Add to dashboard completed list dropdown
                    data.dailyPlan[todayStr] = data.dailyPlan[todayStr] || { tasks: {}, completedSubjects: [], manualTasks: [], completedTasks: [] };
                    if(!data.dailyPlan[todayStr].completedTasks) data.dailyPlan[todayStr].completedTasks = [];
                    data.dailyPlan[todayStr].completedTasks.push({ type: 'other', description: task.description, id: task.id });
                } else {
                    task.completedDate = null;
                }

                data.postponedOtherTasks = (data.postponedOtherTasks || []).filter(t => t.id !== taskId);

                saveData();
                renderHomePage();
                // If on notes page, refresh it to show history immediately
                if(document.getElementById('page-notices').classList.contains('active')) renderNoticesPage();
            }
        }

        function postponeOtherTask(taskId) {
            const task = (data.otherTasks || []).find(t => t.id === taskId) || (data.postponedOtherTasks || []).find(t => t.id === taskId);
            if (task) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                if (task.isRepeating) {
                     // For repeating task, just postpone this instance by marking today as deleted/completed efficiently
                     // But user wants postpone. Best way: Just change date to tomorrow if it's a one-time thing,
                     // If repeating, we typically don't postpone repeating tasks easily without complex logic.
                     // Simple fix: Add today to excluded, add a temp manual task for tomorrow.
                     task.deletedInstances = task.deletedInstances || [];
                     task.deletedInstances.push(getLocalDateString());
                     
                     data.otherTasks.push({
                         id: `other-temp-${Date.now()}`,
                         description: task.description,
                         date: getLocalDateString(tomorrow),
                         notes: task.notes + " (Postponed)",
                         status: 'Pending',
                         isRepeating: false
                     });
                } else {
                    task.date = getLocalDateString(tomorrow);
                    if(!data.postponedOtherTasks.some(t => t.id === taskId)) {
                        data.postponedOtherTasks.push(task);
                        data.otherTasks = data.otherTasks.filter(t => t.id !== taskId);
                    }
                }

                logActivity('skip-forward', `Other task postponed: "${task.description}"`);
                saveData();
                renderHomePage();
            }
        }

        function confirmDeleteOtherTask(taskId) {
            const task = (data.otherTasks || []).find(t => t.id === taskId) || (data.postponedOtherTasks || []).find(t => t.id === taskId);
            
            // If task not found (maybe deleting from history view or filtered list), stop
            if (!task) { 
                renderHomePage(); 
                if(document.getElementById('page-notices').classList.contains('active')) renderNoticesPage();
                return; 
            }

            const checkboxContainer = document.getElementById('confirmation-checkbox-container');
            const checkbox = document.getElementById('confirmation-checkbox');
            
            if (task.isRepeating) {
                checkboxContainer.classList.remove('hidden');
                checkbox.checked = false; 
            } else {
                checkboxContainer.classList.add('hidden');
            }

            showConfirmationModal(
                'Delete Task?', 
                `Are you sure you want to delete "${task.description}"?`, 
                () => {
                    const isPermanent = task.isRepeating ? checkbox.checked : true; 
                    
                    // --- HISTORY FIX: Add to History when deleted ---
                    if(!data.otherTaskHistory) data.otherTaskHistory = [];
                    data.otherTaskHistory.unshift({
                        description: task.description,
                        status: 'Deleted',
                        timestamp: new Date().toISOString()
                    });
                    
                    // Limit History
                    if(data.otherTaskHistory.length > 100) data.otherTaskHistory = data.otherTaskHistory.slice(0, 100);

                    if (isPermanent) {
                        data.otherTasks = (data.otherTasks || []).filter(t => t.id !== taskId);
                        data.postponedOtherTasks = (data.postponedOtherTasks || []).filter(t => t.id !== taskId);
                        logActivity('trash-2', `Permanently deleted task: "${task.description}"`);
                    } else {
                        const todayStr = getLocalDateString();
                        if (!task.deletedInstances) task.deletedInstances = [];
                        if (!task.deletedInstances.includes(todayStr)) {
                            task.deletedInstances.push(todayStr);
                        }
                        // Non-repeating tasks are usually permanent delete, but this handles today-only removal logic
                        if (!task.isRepeating) {
                             data.otherTasks = data.otherTasks.filter(t => t.id !== taskId);
                        }
                        logActivity('minus-circle', `Removed task for today: "${task.description}"`);
                    }
                    
                    saveData();
                    // Update both Dashboard and Notes Page immediately
                    setTimeout(() => {
                        renderHomePage();
                        if(document.getElementById('page-notices').classList.contains('active')) renderNoticesPage();
                    }, 50);
                }
            );
        }

        function showAddChapterDptModal(subjectId, chapterId) {
            const modal = document.getElementById('add-chapter-dpt-modal');
            const form = document.getElementById('add-chapter-dpt-form');
            form.reset();
            document.getElementById('dpt-add-subject-id').value = subjectId;
            
            const chapterSelect = document.getElementById('dpt-add-chapter-select');
            const subject = getSubjectById(subjectId);
            const chapters = subject.chapters || [];
            chapterSelect.innerHTML = chapters.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if (chapterId) {
                chapterSelect.value = chapterId; // Pre-select the chapter
            }
            
            showModal('add-chapter-dpt-modal');
        }
        
        function showAddAllChaptersDptModal(subjectId) {
            const modal = document.getElementById('add-all-chapters-dpt-modal');
            const form = document.getElementById('add-all-chapters-dpt-form');
            form.reset();
            document.getElementById('dpt-add-all-subject-id').value = subjectId;
            document.getElementById('add-all-dpt-modal-title').textContent = `Add DPTs to all chapters in ${_(subjectId)}`;
            showModal('add-all-chapters-dpt-modal');
        }

        function handleAddDptToChapter(e) {
            e.preventDefault();
            const subjectId = document.getElementById('dpt-add-subject-id').value;
            const chapterId = document.getElementById('dpt-add-chapter-select').value;
            const quantity = parseInt(document.getElementById('dpt-add-quantity').value);

            if (!subjectId || !chapterId || isNaN(quantity) || quantity < 1) {
                alert('Please ensure all fields are correct.');
                return;
            }

            data.dpts[subjectId] = data.dpts[subjectId] || { chapters: {} };
            data.dpts[subjectId].chapters[chapterId] = data.dpts[subjectId].chapters[chapterId] || [];
            
            const startId = data.dpts[subjectId].chapters[chapterId].length + 1;
            for (let i = 0; i < quantity; i++) {
                data.dpts[subjectId].chapters[chapterId].push({ id: startId + i, status: 'Pending', details: null });
            }
            
            const chapter = getChapterByIds(subjectId, chapterId);
            logActivity('plus-square', `Added ${quantity} DPTs for ${_(subjectId)} - ${chapter ? chapter.name : ''}`);
            saveData();
            hideModal('add-chapter-dpt-modal');
            renderDptPage();
        }
        
        function handleAddDptToAllChapters(e) {
            e.preventDefault();
            const subjectId = document.getElementById('dpt-add-all-subject-id').value;
            const quantity = parseInt(document.getElementById('dpt-add-all-quantity').value);
            
            if (!subjectId || isNaN(quantity) || quantity < 1) {
                alert('Please ensure all fields are correct.');
                return;
            }
            
            const subject = getSubjectById(subjectId);
            const chapters = subject.chapters || [];
            let totalAdded = 0;

            chapters.forEach(chapter => {
                data.dpts[subjectId] = data.dpts[subjectId] || { chapters: {} };
                data.dpts[subjectId].chapters[chapter.id] = data.dpts[subjectId].chapters[chapter.id] || [];
                
                const startId = data.dpts[subjectId].chapters[chapter.id].length + 1;
                for (let i = 0; i < quantity; i++) {
                    data.dpts[subjectId].chapters[chapter.id].push({ id: startId + i, status: 'Pending', details: null });
                }
                totalAdded += quantity;
            });

            logActivity('plus-square', `Added ${quantity} DPT(s) to ${chapters.length} chapters in ${_(subjectId)}.`);
            saveData();
            hideModal('add-all-chapters-dpt-modal');
            renderDptPage();
        }

        function skipDpt(subjectId) {
            const todayStr = getLocalDateString();
            if (!data.dailyDptPlan[todayStr]) return;
            
            // Store old plan for Undo
            const oldDptPlan = [...data.dailyDptPlan[todayStr]];
            
            // Filter out DPTs for this subject
            data.dailyDptPlan[todayStr] = data.dailyDptPlan[todayStr].filter(dpt => dpt.subjectId !== subjectId);
            
            lastAction = {
                type: 'skip_dpt',
                message: `Skipped DPTs for ${_(subjectId)}`,
                undo: () => {
                    data.dailyDptPlan[todayStr] = oldDptPlan;
                    saveData();
                    renderHomePage();
                }
            };
            showUndoToast(`Skipped DPTs for ${_(subjectId)}`, lastAction.undo);

            logActivity('chevrons-right', `Skipped all DPTs for ${_(subjectId)} for today.`);
            saveData();
            renderHomePage();
        }

        function resetStudyDate() {
            showConfirmationModal('Reset Study Start Date?', 'This will reset your study day counter to Day 1, starting from today. Are you sure?', () => {
                data.appStartDate = getLocalDateString();
                logActivity('calendar-x', 'Study start date was reset to today.');
                saveData();
                renderHomePage();
                alert('Study start date has been reset!');
            });
        }

        function initFeatureTour() {
            // Version Key changed to show tour again
            const TOUR_KEY = 'app_tour_v9.6';
            
            // Page Specific Tour Steps (Always in Hindi)
            const tourSteps = {
                'home': [
                    { selector: '#sidebar', title: 'मुख्य मेनू (Menu)', text: 'यहाँ से आप होम, विषय, परीक्षा और सेटिंग्स जैसे सभी पेजों पर जा सकते हैं।', position: 'right' },
                    { selector: '#study-day-counter', title: 'डे काउंटर (Day Counter)', text: 'यह बताता है कि आप कितने दिनों से लगातार पढ़ाई कर रहे हैं। अनुशासन बनाए रखें!', position: 'bottom' },
                    { selector: '[data-lucide="bot"]', title: 'AI कोच (AI Coach)', text: 'यह आपका पर्सनल AI कोच है जो आपको रियल-टाइम टिप्स और एग्जाम अलर्ट देता है।', position: 'bottom' },
                    { selector: '#todays-plan-container', title: 'आज का प्लान (Today Plan)', text: 'यह आपका आज का ऑटोमैटिक शेड्यूल है। इसे पूरा करें और टिक मार्क करें।', position: 'bottom' },
                    { selector: '#add-task-choice-btn', title: 'क्विक ऐड (Quick Add)', text: 'कोई एक्स्ट्रा चैप्टर या टास्क (जैसे पैन खरीदना) जोड़ने के लिए यहाँ क्लिक करें।', position: 'bottom-left' },
                    { selector: '#todays-dpt-container', title: 'डेली टेस्ट (DPT)', text: 'रोज़ाना टेस्ट के नंबर यहाँ डालें। इससे आपकी सटीकता (Accuracy) ट्रैक होगी।', position: 'top' },
                    { selector: '#overall-progress-chart', title: 'प्रोग्रेस (Progress)', text: 'यह गोलाकार चार्ट दिखाता है कि आपने कुल सिलेबस का कितना प्रतिशत पूरा कर लिया है।', position: 'left' }
                ],
                'import-export': [
                    { selector: '#set-railway-routine-btn', title: 'रेलवे रूटीन', text: 'रेलवे परीक्षाओं के लिए खास तैयार किया गया 14 दिनों का स्टडी प्लान यहाँ से चुनें।', position: 'bottom' },
                    { selector: '#set-foundation-routine-btn', title: 'फाउंडेशन रूटीन', text: 'अगर आप बेसिक से शुरू कर रहे हैं, तो यह प्लान आपके लिए बेस्ट है।', position: 'bottom' },
                    { selector: '#export-full-data-btn', title: 'बैकअप (Backup)', text: 'अपना डेटा सुरक्षित रखने के लिए यहाँ से बैकअप फाइल डाउनलोड करें।', position: 'top' }
                ],
                'exams': [
                    { selector: '#add-exam-btn', title: 'नई परीक्षा', text: 'जिस भी परीक्षा का फॉर्म भरें, उसे यहाँ जोड़ें।', position: 'bottom-left' },
                    { selector: '#exam-filter-buttons', title: 'फिल्टर (Filters)', text: 'यहाँ से आप केवल आने वाली (Upcoming) या अप्लाई की हुई (Applied) परीक्षाएं देख सकते हैं।', position: 'bottom' }
                ],
                'url': [
                    { selector: '#add-new-root-folder-btn', title: 'फोल्डर बनाएं', text: 'अपने यूट्यूब लिंक या नोट्स को व्यवस्थित रखने के लिए फोल्डर बनाएं।', position: 'bottom' }
                ],
                'calendar': [
                    { selector: '.grid-cols-7', title: 'इतिहास (History)', text: 'पुरानी तारीखों पर क्लिक करके आप देख सकते हैं कि आपने उस दिन क्या पढ़ा था या पिछला काम पूरा कर सकते हैं।', position: 'top' }
                ]
            };

            let overlay = document.querySelector('.feature-tour-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'feature-tour-overlay';
                document.body.appendChild(overlay);
            }

            let currentSteps = [];
            let currentStepIndex = 0;
            let isTourActive = false;

            function endTour() {
                isTourActive = false;
                overlay.classList.remove('active');
                document.querySelectorAll('.tour-bubble').forEach(el => el.remove());
                // Mark ONLY Home tour as globally done, others can show once per page visit if needed logic added later
                if(document.getElementById('page-home').classList.contains('active')) {
                    localStorage.setItem(TOUR_KEY, 'true');
                }
            }

            function showStep(index) {
                document.querySelectorAll('.tour-bubble').forEach(el => el.remove());
                
                if (index >= currentSteps.length) {
                    endTour();
                    return;
                }

                const step = currentSteps[index];
                let target = document.querySelector(step.selector);
                
                // Specific adjustments for AI icon wrapper
                if (step.selector === '[data-lucide="bot"]') {
                    const icon = document.querySelector('[data-lucide="bot"]');
                    if(icon) target = icon.closest('.flex.items-center.gap-2');
                }

                if (!target || target.offsetParent === null || target.style.display === 'none') {
                    showStep(index + 1);
                    return;
                }

                overlay.classList.add('active');
                currentStepIndex = index;

                const bubble = document.createElement('div');
                bubble.className = 'tour-bubble';
                
                let arrowClass = '';
                // Logic inverted: 'right' means show bubble on right, so arrow points left
                if (step.position === 'right') arrowClass = 'arrow-left';
                else if (step.position === 'left') arrowClass = 'arrow-right';
                else if (step.position === 'top') arrowClass = 'arrow-bottom';
                else if (step.position === 'bottom' || step.position === 'bottom-left') arrowClass = 'arrow-top';
                
                bubble.classList.add(arrowClass);

                bubble.innerHTML = `
                    <h4>${step.title}</h4>
                    <p>${step.text}</p>
                    <div class="tour-progress">
                        <span>टिप ${index + 1} / ${currentSteps.length}</span>
                        <div class="flex gap-1">
                            <span class="w-1.5 h-1.5 rounded-full ${index >= 0 ? 'bg-sky-500' : 'bg-gray-300'}"></span>
                            <span class="w-1.5 h-1.5 rounded-full ${index >= 1 ? 'bg-sky-500' : 'bg-gray-300'}"></span>
                            <span class="w-1.5 h-1.5 rounded-full ${index >= 2 ? 'bg-sky-500' : 'bg-gray-300'}"></span>
                        </div>
                    </div>
                    <div class="tour-buttons">
                        <button class="tour-btn-skip">छोड़ें (Skip)</button>
                        <button class="tour-btn-next">${index === currentSteps.length - 1 ? 'समाप्त (Finish)' : 'अगला (Next)'}</button>
                    </div>
                `;
                document.body.appendChild(bubble);

                const rect = target.getBoundingClientRect();
                const bubbleRect = bubble.getBoundingClientRect();
                
                let top, left;
                const gap = 14; // Matches arrow size in CSS

                // Precise Positioning Logic with Arrow Center Alignment
                if (step.position === 'right') {
                    top = rect.top + (rect.height / 2) - (bubbleRect.height / 2);
                    left = rect.right + gap;
                } else if (step.position === 'left') {
                    top = rect.top + (rect.height / 2) - (bubbleRect.height / 2);
                    left = rect.left - bubbleRect.width - gap;
                } else if (step.position === 'top') {
                    top = rect.top - bubbleRect.height - gap;
                    left = rect.left + (rect.width / 2) - (bubbleRect.width / 2);
                } else if (step.position === 'bottom') {
                    top = rect.bottom + gap;
                    left = rect.left + (rect.width / 2) - (bubbleRect.width / 2);
                } else if (step.position === 'bottom-left') {
                    top = rect.bottom + gap;
                    // For bottom-left, align bubble right edge near element right edge, but keep arrow visually correct
                    // Simple logic: treat as bottom for now to keep arrow centered
                    left = rect.left + (rect.width / 2) - (bubbleRect.width / 2);
                } else {
                    top = rect.bottom + gap;
                    left = rect.left + (rect.width / 2) - (bubbleRect.width / 2);
                }

                // Hard Boundary Checks
                if (left < 10) left = 10;
                if (left + bubbleRect.width > window.innerWidth) left = window.innerWidth - bubbleRect.width - 10;
                if (top < 10) top = 10;
                
                // For 'home' mobile menu items specifically, adjust if too low
                if (top + bubbleRect.height > window.innerHeight) {
                    // Flip to top if bottom overflows
                    if (step.position.includes('bottom')) {
                        top = rect.top - bubbleRect.height - gap;
                        bubble.classList.remove('arrow-top');
                        bubble.classList.add('arrow-bottom');
                    } else {
                        top = window.innerHeight - bubbleRect.height - 10;
                    }
                }

                bubble.style.top = `${top}px`;
                bubble.style.left = `${left}px`;

                // Scroll element into view smoothly
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });

                bubble.querySelector('.tour-btn-next').addEventListener('click', (e) => {
                    e.stopPropagation(); showStep(index + 1);
                });
                bubble.querySelector('.tour-btn-skip').addEventListener('click', (e) => {
                    e.stopPropagation(); endTour();
                });
            }

            // Trigger for Home Page (First Time Only)
            const startHomeTour = () => {
                if (window.isUpdatePopupClosed && !isTourActive && !localStorage.getItem(TOUR_KEY) && document.getElementById('page-home').classList.contains('active')) {
                    isTourActive = true;
                    currentSteps = tourSteps['home'];
                    showStep(0);
                    document.removeEventListener('click', startHomeTour);
                }
            };
            document.addEventListener('click', startHomeTour);

            // Trigger for Other Pages (On Navigation)
            const originalNavigate = window.navigateTo; // Hook into navigation if possible or check interval
            // Simple approach: Check active page on click
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const pageId = btn.dataset.page;
                    const pageKey = `tour_shown_${pageId}`;
                    if (tourSteps[pageId] && !localStorage.getItem(pageKey)) {
                        setTimeout(() => {
                            isTourActive = true;
                            currentSteps = tourSteps[pageId];
                            showStep(0);
                            localStorage.setItem(pageKey, 'true');
                        }, 500); // Wait for page transition
                    }
                });
            });

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) showStep(currentStepIndex + 1);
            });
        }

        init();
        // Call tour after init
        initFeatureTour();
    });
    </script>
</body>
</html>